<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>长沙飞狐数据管理平台</title>
    <script id="chartjs-cdn" src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" onerror="this.onerror=null; this.src='https://cdn.staticfile.org/Chart.js/4.4.1/chart.umd.min.js'; this.onerror=function(){ this.onerror=null; this.src='https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js'; };"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 Supabase SDK（内嵌） -->
    <script>
/**
 * Skipped minification because the original files appears to be already minified.
 * Original file: /npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.supabase=t():e.supabase=t()}(self,(()=>(()=>{"use strict";var e,t,s,r,i={982:(e,t,s)=>{s.r(t),s.d(t,{FunctionsClient:()=>a,FunctionsError:()=>r,FunctionsFetchError:()=>i,FunctionsHttpError:()=>o,FunctionsRelayError:()=>n});class r extends Error{constructor(e,t="FunctionsError",s){super(e),this.name=t,this.context=s}}class i extends r{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class n extends r{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class o extends r{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}class a{constructor(e,{headers:t={},customFetch:r}={}){this.url=e,this.headers=t,this.fetch=(e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>Promise.resolve().then(s.t.bind(s,743,23)).then((({default:t})=>t(...e))):fetch),(...e)=>t(...e)})(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var s,r,a,c,l;return r=this,a=void 0,l=function*(){try{const{headers:r,method:a,body:c}=t;let l,h={};c&&(r&&!Object.prototype.hasOwnProperty.call(r,"Content-Type")||!r)&&("undefined"!=typeof Blob&&c instanceof Blob||c instanceof ArrayBuffer?(h["Content-Type"]="application/octet-stream",l=c):"string"==typeof c?(h["Content-Type"]="text/plain",l=c):"undefined"!=typeof FormData&&c instanceof FormData?l=c:(h["Content-Type"]="application/json",l=JSON.stringify(c)));const u=yield this.fetch(`${this.url}/${e}`,{method:a||"POST",headers:Object.assign(Object.assign(Object.assign({},h),this.headers),r),body:l}).catch((e=>{throw new i(e)})),d=u.headers.get("x-relay-error");if(d&&"true"===d)throw new n(u);if(!u.ok)throw new o(u);let f,p=(null!==(s=u.headers.get("Content-Type"))&&void 0!==s?s:"text/plain").split(";")[0].trim();return f="application/json"===p?yield u.json():"application/octet-stream"===p?yield u.blob():"multipart/form-data"===p?yield u.formData():yield u.text(),{data:f,error:null}}catch(e){return{data:null,error:e}}},new((c=void 0)||(c=Promise))((function(e,t){function s(e){try{n(l.next(e))}catch(e){t(e)}}function i(e){try{n(l.throw(e))}catch(e){t(e)}}function n(t){var r;t.done?e(t.value):(r=t.value,r instanceof c?r:new c((function(e){e(r)}))).then(s,i)}n((l=l.apply(r,a||[])).next())}))}}},765:(e,t,s)=>{s.r(t),s.d(t,{AuthApiError:()=>_,AuthError:()=>v,AuthImplicitGrantRedirectError:()=>j,AuthInvalidCredentialsError:()=>E,AuthInvalidTokenResponseError:()=>T,AuthPKCEGrantCodeExchangeError:()=>O,AuthRetryableFetchError:()=>P,AuthSessionMissingError:()=>S,AuthUnknownError:()=>w,AuthWeakPasswordError:()=>x,CustomAuthError:()=>k,GoTrueAdminApi:()=>q,GoTrueClient:()=>Z,NavigatorLockAcquireTimeoutError:()=>V,isAuthApiError:()=>b,isAuthError:()=>m,isAuthRetryableFetchError:()=>$,isAuthWeakPasswordError:()=>A,lockInternals:()=>G,navigatorLock:()=>W});const r=()=>"undefined"!=typeof document,i={tested:!1,writable:!1},n=()=>{if(!r())return!1;try{if("object"!=typeof globalThis.localStorage)return!1}catch(e){return!1}if(i.tested)return i.writable;const e=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(e,e),globalThis.localStorage.removeItem(e),i.tested=!0,i.writable=!0}catch(e){i.tested=!0,i.writable=!1}return i.writable};function o(e){const t={},s=new URL(e);if(s.hash&&"#"===s.hash[0])try{new URLSearchParams(s.hash.substring(1)).forEach(((e,s)=>{t[s]=e}))}catch(e){}return s.searchParams.forEach(((e,s)=>{t[s]=e})),t}const a=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>Promise.resolve().then(s.t.bind(s,743,23)).then((({default:t})=>t(...e))):fetch),(...e)=>t(...e)},c=e=>"object"==typeof e&&null!==e&&"status"in e&&"ok"in e&&"json"in e&&"function"==typeof e.json,l=async(e,t,s)=>{await e.setItem(t,JSON.stringify(s))},h=async(e,t)=>{const s=await e.getItem(t);if(!s)return null;try{return JSON.parse(s)}catch(e){return s}},u=async(e,t)=>{await e.removeItem(t)};class d{constructor(){this.promise=new d.promiseConstructor(((e,t)=>{this.resolve=e,this.reject=t}))}}function f(e){const t=e.split(".");if(3!==t.length)throw new Error("JWT is not valid: not a JWT structure");if(!/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}=?$|[a-z0-9_-]{2}(==)?$)$/i.test(t[1]))throw new Error("JWT is not valid: payload is not in base64url format");const s=t[1];return JSON.parse(function(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let s,r,i,n,o,a,c,l="",h=0;for(e=e.replace("-","+").replace("_","/");h<e.length;)n=t.indexOf(e.charAt(h++)),o=t.indexOf(e.charAt(h++)),a=t.indexOf(e.charAt(h++)),c=t.indexOf(e.charAt(h++)),s=n<<2|o>>4,r=(15&o)<<4|a>>2,i=(3&a)<<6|c,l+=String.fromCharCode(s),64!=a&&0!=r&&(l+=String.fromCharCode(r)),64!=c&&0!=i&&(l+=String.fromCharCode(i));return l}(s))}function p(e){return("0"+e.toString(16)).substr(-2)}function g(){const e=new Uint32Array(56);if("undefined"==typeof crypto){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",t=e.length;let s="";for(let r=0;r<56;r++)s+=e.charAt(Math.floor(Math.random()*t));return s}return crypto.getRandomValues(e),Array.from(e,p).join("")}async function y(e){if("undefined"==typeof crypto||void 0===crypto.subtle||"undefined"==typeof TextEncoder)return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),e;const t=await async function(e){const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t),r=new Uint8Array(s);return Array.from(r).map((e=>String.fromCharCode(e))).join("")}(e);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}d.promiseConstructor=Promise;class v extends Error{constructor(e,t){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t}}function m(e){return"object"==typeof e&&null!==e&&"__isAuthError"in e}class _ extends v{constructor(e,t){super(e,t),this.name="AuthApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}function b(e){return m(e)&&"AuthApiError"===e.name}class w extends v{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class k extends v{constructor(e,t,s){super(e),this.name=t,this.status=s}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class S extends k{constructor(){super("Auth session missing!","AuthSessionMissingError",400)}}class T extends k{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500)}}class E extends k{constructor(e){super(e,"AuthInvalidCredentialsError",400)}}class j extends k{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class O extends k{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class P extends k{constructor(e,t){super(e,"AuthRetryableFetchError",t)}}function $(e){return m(e)&&"AuthRetryableFetchError"===e.name}class x extends k{constructor(e,t,s){super(e,"AuthWeakPasswordError",t),this.reasons=s}}function A(e){return m(e)&&"AuthWeakPasswordError"===e.name}const C=e=>e.msg||e.message||e.error_description||e.error||JSON.stringify(e),R=[502,503,504];async function I(e){if(!c(e))throw new P(C(e),0);if(R.includes(e.status))throw new P(C(e),e.status);let t;try{t=await e.json()}catch(e){throw new w(C(e),e)}if("object"==typeof t&&t&&"object"==typeof t.weak_password&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce(((e,t)=>e&&"string"==typeof t),!0))throw new x(C(t),e.status,t.weak_password.reasons);throw new _(C(t),e.status||500)}async function L(e,t,s,r){var i;const n=Object.assign({},null==r?void 0:r.headers);(null==r?void 0:r.jwt)&&(n.Authorization=`Bearer ${r.jwt}`);const o=null!==(i=null==r?void 0:r.query)&&void 0!==i?i:{};(null==r?void 0:r.redirectTo)&&(o.redirect_to=r.redirectTo);const a=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",c=await async function(e,t,s,r,i,n){const o=((e,t,s,r)=>{const i={method:e,headers:(null==t?void 0:t.headers)||{}};return"GET"===e?i:(i.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},null==t?void 0:t.headers),i.body=JSON.stringify(r),Object.assign(Object.assign({},i),s))})(t,r,{},n);let a;try{a=await e(s,o)}catch(e){throw console.error(e),new P(C(e),0)}if(a.ok||await I(a),null==r?void 0:r.noResolveJson)return a;try{return await a.json()}catch(e){await I(e)}}(e,t,s+a,{headers:n,noResolveJson:null==r?void 0:r.noResolveJson},0,null==r?void 0:r.body);return(null==r?void 0:r.xform)?null==r?void 0:r.xform(c):{data:Object.assign({},c),error:null}}function U(e){var t;let s=null;var r;return function(e){return e.access_token&&e.refresh_token&&e.expires_in}(e)&&(s=Object.assign({},e),e.expires_at||(s.expires_at=(r=e.expires_in,Math.round(Date.now()/1e3)+r))),{data:{session:s,user:null!==(t=e.user)&&void 0!==t?t:e},error:null}}function N(e){var t;return{data:{user:null!==(t=e.user)&&void 0!==t?t:e},error:null}}function D(e){return{data:e,error:null}}function F(e){const{action_link:t,email_otp:s,hashed_token:r,redirect_to:i,verification_type:n}=e,o=function(e,t){var s={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(s[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(s[r[i]]=e[r[i]])}return s}(e,["action_link","email_otp","hashed_token","redirect_to","verification_type"]);return{data:{properties:{action_link:t,email_otp:s,hashed_token:r,redirect_to:i,verification_type:n},user:Object.assign({},o)},error:null}}function M(e){return e}class q{constructor({url:e="",headers:t={},fetch:s}){this.url=e,this.headers=t,this.fetch=a(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t="global"){try{return await L(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(e){if(m(e))return{data:null,error:e};throw e}}async inviteUserByEmail(e,t={}){try{return await L(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:N})}catch(e){if(m(e))return{data:{user:null},error:e};throw e}}async generateLink(e){try{const{options:t}=e,s=function(e,t){var s={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(s[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(s[r[i]]=e[r[i]])}return s}(e,["options"]),r=Object.assign(Object.assign({},s),t);return"newEmail"in s&&(r.new_email=null==s?void 0:s.newEmail,delete r.newEmail),await L(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:r,headers:this.headers,xform:F,redirectTo:null==t?void 0:t.redirectTo})}catch(e){if(m(e))return{data:{properties:null,user:null},error:e};throw e}}async createUser(e){try{return await L(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:N})}catch(e){if(m(e))return{data:{user:null},error:e};throw e}}async listUsers(e){var t,s,r,i,n,o,a;try{const c={nextPage:null,lastPage:0,total:0},l=await L(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:null!==(s=null===(t=null==e?void 0:e.page)||void 0===t?void 0:t.toString())&&void 0!==s?s:"",per_page:null!==(i=null===(r=null==e?void 0:e.perPage)||void 0===r?void 0:r.toString())&&void 0!==i?i:""},xform:M});if(l.error)throw l.error;const h=await l.json(),u=null!==(n=l.headers.get("x-total-count"))&&void 0!==n?n:0,d=null!==(a=null===(o=l.headers.get("link"))||void 0===o?void 0:o.split(","))&&void 0!==a?a:[];return d.length>0&&(d.forEach((e=>{const t=parseInt(e.split(";")[0].split("=")[1].substring(0,1)),s=JSON.parse(e.split(";")[1].split("=")[1]);c[`${s}Page`]=t})),c.total=parseInt(u)),{data:Object.assign(Object.assign({},h),c),error:null}}catch(e){if(m(e))return{data:{users:[]},error:e};throw e}}async getUserById(e){try{return await L(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:N})}catch(e){if(m(e))return{data:{user:null},error:e};throw e}}async updateUserById(e,t){try{return await L(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:N})}catch(e){if(m(e))return{data:{user:null},error:e};throw e}}async deleteUser(e,t=!1){try{return await L(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:N})}catch(e){if(m(e))return{data:{user:null},error:e};throw e}}async _listFactors(e){try{const{data:t,error:s}=await L(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:e=>({data:{factors:e},error:null})});return{data:t,error:s}}catch(e){if(m(e))return{data:null,error:e};throw e}}async _deleteFactor(e){try{return{data:await L(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(e){if(m(e))return{data:null,error:e};throw e}}}const B="2.60.1",J={"X-Client-Info":`gotrue-js/${B}`},z={getItem:e=>n()?globalThis.localStorage.getItem(e):null,setItem:(e,t)=>{n()&&globalThis.localStorage.setItem(e,t)},removeItem:e=>{n()&&globalThis.localStorage.removeItem(e)}};function K(e={}){return{getItem:t=>e[t]||null,setItem:(t,s)=>{e[t]=s},removeItem:t=>{delete e[t]}}}const G={debug:!!(globalThis&&n()&&globalThis.localStorage&&"true"===globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug"))};class H extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class V extends H{}async function W(e,t,s){G.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",e,t);const r=new globalThis.AbortController;return t>0&&setTimeout((()=>{r.abort(),G.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",e)}),t),await globalThis.navigator.locks.request(e,0===t?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},(async r=>{if(!r){if(0===t)throw G.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",e),new V(`Acquiring an exclusive Navigator LockManager lock "${e}" immediately failed`);if(G.debug)try{const e=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(e,null,"  "))}catch(e){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",e)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await s()}G.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",e,r.name);try{return await s()}finally{G.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",e,r.name)}}))}!function(){if("object"!=typeof globalThis)try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch(e){"undefined"!=typeof self&&(self.globalThis=self)}}();const Y={url:"http://localhost:9999",storageKey:"supabase.auth.token",autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:J,flowType:"implicit",debug:!1},X=3e4;async function Q(e,t,s){return await s()}class Z{constructor(e){var t;this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=Z.nextInstanceID,Z.nextInstanceID+=1,this.instanceID>0&&r()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const s=Object.assign(Object.assign({},Y),e);if(this.logDebugMessages=!!s.debug,"function"==typeof s.debug&&(this.logger=s.debug),this.persistSession=s.persistSession,this.storageKey=s.storageKey,this.autoRefreshToken=s.autoRefreshToken,this.admin=new q({url:s.url,headers:s.headers,fetch:s.fetch}),this.url=s.url,this.headers=s.headers,this.fetch=a(s.fetch),this.lock=s.lock||Q,this.detectSessionInUrl=s.detectSessionInUrl,this.flowType=s.flowType,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?s.storage?this.storage=s.storage:n()?this.storage=z:(this.memoryStorage={},this.storage=K(this.memoryStorage)):(this.memoryStorage={},this.storage=K(this.memoryStorage)),r()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(e){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",e)}null===(t=this.broadcastChannel)||void 0===t||t.addEventListener("message",(async e=>{this._debug("received broadcast notification from other tab or client",e),await this._notifyAllSubscribers(e.data.event,e.data.session,!1)}))}this.initialize()}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${B}) ${(new Date).toISOString()}`,...e),this}async initialize(){return this.initializePromise||(this.initializePromise=(async()=>await this._acquireLock(-1,(async()=>await this._initialize())))()),await this.initializePromise}async _initialize(){try{const e=!!r()&&await this._isPKCEFlow();if(this._debug("#_initialize()","begin","is PKCE flow",e),e||this.detectSessionInUrl&&this._isImplicitGrantFlow()){const{data:t,error:s}=await this._getSessionFromURL(e);if(s)return this._debug("#_initialize()","error detecting session from URL",s),"Identity is already linked"===(null==s?void 0:s.message)||"Identity is already linked to another user"===(null==s?void 0:s.message)||await this._removeSession(),{error:s};const{session:r,redirectType:i}=t;return this._debug("#_initialize()","detected session in URL",r,"redirect type",i),await this._saveSession(r),setTimeout((async()=>{"recovery"===i?await this._notifyAllSubscribers("PASSWORD_RECOVERY",r):await this._notifyAllSubscribers("SIGNED_IN",r)}),0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(e){return m(e)?{error:e}:{error:new w("Unexpected error during initialization",e)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signUp(e){var t,s,r;try{let i;if(await this._removeSession(),"email"in e){const{email:s,password:r,options:n}=e;let o=null,a=null;if("pkce"===this.flowType){const e=g();await l(this.storage,`${this.storageKey}-code-verifier`,e),o=await y(e),a=e===o?"plain":"s256"}i=await L(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:null==n?void 0:n.emailRedirectTo,body:{email:s,password:r,data:null!==(t=null==n?void 0:n.data)&&void 0!==t?t:{},gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken},code_challenge:o,code_challenge_method:a},xform:U})}else{if(!("phone"in e))throw new E("You must provide either an email or phone number and a password");{const{phone:t,password:n,options:o}=e;i=await L(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:t,password:n,data:null!==(s=null==o?void 0:o.data)&&void 0!==s?s:{},channel:null!==(r=null==o?void 0:o.channel)&&void 0!==r?r:"sms",gotrue_meta_security:{captcha_token:null==o?void 0:o.captchaToken}},xform:U})}}const{data:n,error:o}=i;if(o||!n)return{data:{user:null,session:null},error:o};const a=n.session,c=n.user;return n.session&&(await this._saveSession(n.session),await this._notifyAllSubscribers("SIGNED_IN",a)),{data:{user:c,session:a},error:null}}catch(e){if(m(e))return{data:{user:null,session:null},error:e};throw e}}async signInWithPassword(e){try{let t;if(await this._removeSession(),"email"in e){const{email:s,password:r,options:i}=e;t=await L(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:s,password:r,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken}},xform:U})}else{if(!("phone"in e))throw new E("You must provide either an email or phone number and a password");{const{phone:s,password:r,options:i}=e;t=await L(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:s,password:r,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken}},xform:U})}}const{data:s,error:r}=t;return r?{data:{user:null,session:null},error:r}:s&&s.session&&s.user?(s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),{data:{user:s.user,session:s.session},error:r}):{data:{user:null,session:null},error:new T}}catch(e){if(m(e))return{data:{user:null,session:null},error:e};throw e}}async signInWithOAuth(e){var t,s,r,i;return await this._removeSession(),await this._handleProviderSignIn(e.provider,{redirectTo:null===(t=e.options)||void 0===t?void 0:t.redirectTo,scopes:null===(s=e.options)||void 0===s?void 0:s.scopes,queryParams:null===(r=e.options)||void 0===r?void 0:r.queryParams,skipBrowserRedirect:null===(i=e.options)||void 0===i?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,(async()=>this._exchangeCodeForSession(e)))}async _exchangeCodeForSession(e){const[t,s]=(await h(this.storage,`${this.storageKey}-code-verifier`)).split("/"),{data:r,error:i}=await L(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:t},xform:U});return await u(this.storage,`${this.storageKey}-code-verifier`),i?{data:{user:null,session:null,redirectType:null},error:i}:r&&r.session&&r.user?(r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),{data:Object.assign(Object.assign({},r),{redirectType:null!=s?s:null}),error:i}):{data:{user:null,session:null,redirectType:null},error:new T}}async signInWithIdToken(e){await this._removeSession();try{const{options:t,provider:s,token:r,access_token:i,nonce:n}=e,o=await L(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:r,access_token:i,nonce:n,gotrue_meta_security:{captcha_token:null==t?void 0:t.captchaToken}},xform:U}),{data:a,error:c}=o;return c?{data:{user:null,session:null},error:c}:a&&a.session&&a.user?(a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",a.session)),{data:a,error:c}):{data:{user:null,session:null},error:new T}}catch(e){if(m(e))return{data:{user:null,session:null},error:e};throw e}}async signInWithOtp(e){var t,s,r,i,n;try{if(await this._removeSession(),"email"in e){const{email:r,options:i}=e;let n=null,o=null;if("pkce"===this.flowType){const e=g();await l(this.storage,`${this.storageKey}-code-verifier`,e),n=await y(e),o=e===n?"plain":"s256"}const{error:a}=await L(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:r,data:null!==(t=null==i?void 0:i.data)&&void 0!==t?t:{},create_user:null===(s=null==i?void 0:i.shouldCreateUser)||void 0===s||s,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken},code_challenge:n,code_challenge_method:o},redirectTo:null==i?void 0:i.emailRedirectTo});return{data:{user:null,session:null},error:a}}if("phone"in e){const{phone:t,options:s}=e,{data:o,error:a}=await L(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:t,data:null!==(r=null==s?void 0:s.data)&&void 0!==r?r:{},create_user:null===(i=null==s?void 0:s.shouldCreateUser)||void 0===i||i,gotrue_meta_security:{captcha_token:null==s?void 0:s.captchaToken},channel:null!==(n=null==s?void 0:s.channel)&&void 0!==n?n:"sms"}});return{data:{user:null,session:null,messageId:null==o?void 0:o.message_id},error:a}}throw new E("You must provide either an email or phone number.")}catch(e){if(m(e))return{data:{user:null,session:null},error:e};throw e}}async verifyOtp(e){var t,s;try{let r,i;"email_change"!==e.type&&"phone_change"!==e.type&&await this._removeSession(),"options"in e&&(r=null===(t=e.options)||void 0===t?void 0:t.redirectTo,i=null===(s=e.options)||void 0===s?void 0:s.captchaToken);const{data:n,error:o}=await L(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:r,xform:U});if(o)throw o;if(!n)throw new Error("An error occurred on token verification.");const a=n.session,c=n.user;return(null==a?void 0:a.access_token)&&(await this._saveSession(a),await this._notifyAllSubscribers("SIGNED_IN",a)),{data:{user:c,session:a},error:null}}catch(e){if(m(e))return{data:{user:null,session:null},error:e};throw e}}async signInWithSSO(e){var t,s,r;try{await this._removeSession();let i=null,n=null;if("pkce"===this.flowType){const e=g();await l(this.storage,`${this.storageKey}-code-verifier`,e),i=await y(e),n=e===i?"plain":"s256"}return await L(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:null!==(s=null===(t=e.options)||void 0===t?void 0:t.redirectTo)&&void 0!==s?s:void 0}),(null===(r=null==e?void 0:e.options)||void 0===r?void 0:r.captchaToken)?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:i,code_challenge_method:n}),headers:this.headers,xform:D})}catch(e){if(m(e))return{data:null,error:e};throw e}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,(async()=>await this._reauthenticate()))}async _reauthenticate(){try{return await this._useSession((async e=>{const{data:{session:t},error:s}=e;if(s)throw s;if(!t)throw new S;const{error:r}=await L(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:r}}))}catch(e){if(m(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{"email_change"!=e.type&&"phone_change"!=e.type&&await this._removeSession();const t=`${this.url}/resend`;if("email"in e){const{email:s,type:r,options:i}=e,{error:n}=await L(this.fetch,"POST",t,{headers:this.headers,body:{email:s,type:r,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken}},redirectTo:null==i?void 0:i.emailRedirectTo});return{data:{user:null,session:null},error:n}}if("phone"in e){const{phone:s,type:r,options:i}=e,{data:n,error:o}=await L(this.fetch,"POST",t,{headers:this.headers,body:{phone:s,type:r,gotrue_meta_security:{captcha_token:null==i?void 0:i.captchaToken}}});return{data:{user:null,session:null,messageId:null==n?void 0:n.message_id},error:o}}throw new E("You must provide either an email or phone number and a type")}catch(e){if(m(e))return{data:{user:null,session:null},error:e};throw e}}async getSession(){return await this.initializePromise,this._acquireLock(-1,(async()=>this._useSession((async e=>e))))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const e=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await e,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch(e){}})()),s}return await this.lock(`lock:${this.storageKey}`,e,(async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const e=t();for(this.pendingInLock.push((async()=>{try{await e}catch(e){}})()),await e;this.pendingInLock.length;){const e=[...this.pendingInLock];await Promise.all(e),this.pendingInLock.splice(0,e.length)}return await e}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}}))}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",(new Error).stack);try{let e=null;const t=await h(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),null!==t&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const s=!!e.expires_at&&e.expires_at<=Date.now()/1e3;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s)return{data:{session:e},error:null};const{session:r,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{session:null},error:i}:{data:{session:r},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,this._acquireLock(-1,(async()=>await this._getUser())))}async _getUser(e){try{return e?await L(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:N}):await this._useSession((async e=>{var t,s;const{data:r,error:i}=e;if(i)throw i;return await L(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:null!==(s=null===(t=r.session)||void 0===t?void 0:t.access_token)&&void 0!==s?s:void 0,xform:N})}))}catch(e){if(m(e))return{data:{user:null},error:e};throw e}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,(async()=>await this._updateUser(e,t)))}async _updateUser(e,t={}){try{return await this._useSession((async s=>{const{data:r,error:i}=s;if(i)throw i;if(!r.session)throw new S;const n=r.session;let o=null,a=null;if("pkce"===this.flowType&&null!=e.email){const e=g();await l(this.storage,`${this.storageKey}-code-verifier`,e),o=await y(e),a=e===o?"plain":"s256"}const{data:c,error:h}=await L(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:null==t?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:o,code_challenge_method:a}),jwt:n.access_token,xform:N});if(h)throw h;return n.user=c.user,await this._saveSession(n),await this._notifyAllSubscribers("USER_UPDATED",n),{data:{user:n.user},error:null}}))}catch(e){if(m(e))return{data:{user:null},error:e};throw e}}_decodeJWT(e){return f(e)}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,(async()=>await this._setSession(e)))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new S;const t=Date.now()/1e3;let s=t,r=!0,i=null;const n=f(e.access_token);if(n.exp&&(s=n.exp,r=s<=t),r){const{session:t,error:s}=await this._callRefreshToken(e.refresh_token);if(s)return{data:{user:null,session:null},error:s};if(!t)return{data:{user:null,session:null},error:null};i=t}else{const{data:r,error:n}=await this._getUser(e.access_token);if(n)throw n;i={access_token:e.access_token,refresh_token:e.refresh_token,user:r.user,token_type:"bearer",expires_in:s-t,expires_at:s},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return{data:{user:i.user,session:i},error:null}}catch(e){if(m(e))return{data:{session:null,user:null},error:e};throw e}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,(async()=>await this._refreshSession(e)))}async _refreshSession(e){try{return await this._useSession((async t=>{var s;if(!e){const{data:r,error:i}=t;if(i)throw i;e=null!==(s=r.session)&&void 0!==s?s:void 0}if(!(null==e?void 0:e.refresh_token))throw new S;const{session:r,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{user:null,session:null},error:i}:r?{data:{user:r.user,session:r},error:null}:{data:{user:null,session:null},error:null}}))}catch(e){if(m(e))return{data:{user:null,session:null},error:e};throw e}}async _getSessionFromURL(e){try{if(!r())throw new j("No browser detected.");if("implicit"===this.flowType&&!this._isImplicitGrantFlow())throw new j("Not a valid implicit grant flow url.");if("pkce"==this.flowType&&!e)throw new O("Not a valid PKCE flow url.");const t=o(window.location.href);if(e){if(!t.code)throw new O("No code detected.");const{data:e,error:s}=await this._exchangeCodeForSession(t.code);if(s)throw s;const r=new URL(window.location.href);return r.searchParams.delete("code"),window.history.replaceState(window.history.state,"",r.toString()),{data:{session:e.session,redirectType:null},error:null}}if(t.error||t.error_description||t.error_code)throw new j(t.error_description||"Error in URL with unspecified error_description",{error:t.error||"unspecified_error",code:t.error_code||"unspecified_code"});const{provider_token:s,provider_refresh_token:i,access_token:n,refresh_token:a,expires_in:c,expires_at:l,token_type:h}=t;if(!(n&&c&&a&&h))throw new j("No session defined in URL");const u=Math.round(Date.now()/1e3),d=parseInt(c);let f=u+d;l&&(f=parseInt(l));const p=f-u;1e3*p<=X&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${p}s, should have been closer to ${d}s`);const g=f-d;u-g>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",g,f,u):u-g<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clok for skew",g,f,u);const{data:y,error:v}=await this._getUser(n);if(v)throw v;const m={provider_token:s,provider_refresh_token:i,access_token:n,expires_in:d,expires_at:f,refresh_token:a,token_type:h,user:y.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:m,redirectType:t.type},error:null}}catch(e){if(m(e))return{data:{session:null,redirectType:null},error:e};throw e}}_isImplicitGrantFlow(){const e=o(window.location.href);return!(!r()||!e.access_token&&!e.error_description)}async _isPKCEFlow(){const e=o(window.location.href),t=await h(this.storage,`${this.storageKey}-code-verifier`);return!(!e.code||!t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,(async()=>await this._signOut(e)))}async _signOut({scope:e}={scope:"global"}){return await this._useSession((async t=>{var s;const{data:r,error:i}=t;if(i)return{error:i};const n=null===(s=r.session)||void 0===s?void 0:s.access_token;if(n){const{error:t}=await this.admin.signOut(n,e);if(t&&(!b(t)||404!==t.status&&401!==t.status))return{error:t}}return"others"!==e&&(await this._removeSession(),await u(this.storage,`${this.storageKey}-code-verifier`),await this._notifyAllSubscribers("SIGNED_OUT",null)),{error:null}}))}onAuthStateChange(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})),s={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,s),(async()=>{await this.initializePromise,await this._acquireLock(-1,(async()=>{this._emitInitialSession(t)}))})(),{data:{subscription:s}}}async _emitInitialSession(e){return await this._useSession((async t=>{var s,r;try{const{data:{session:r},error:i}=t;if(i)throw i;await(null===(s=this.stateChangeEmitters.get(e))||void 0===s?void 0:s.callback("INITIAL_SESSION",r)),this._debug("INITIAL_SESSION","callback id",e,"session",r)}catch(t){await(null===(r=this.stateChangeEmitters.get(e))||void 0===r?void 0:r.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",t),console.error(t)}}))}async resetPasswordForEmail(e,t={}){let s=null,r=null;if("pkce"===this.flowType){const e=g();await l(this.storage,`${this.storageKey}-code-verifier`,`${e}/PASSWORD_RECOVERY`),s=await y(e),r=e===s?"plain":"s256"}try{return await L(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:s,code_challenge_method:r,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(e){if(m(e))return{data:null,error:e};throw e}}async getUserIdentities(){var e;try{const{data:t,error:s}=await this.getUser();if(s)throw s;return{data:{identities:null!==(e=t.user.identities)&&void 0!==e?e:[]},error:null}}catch(e){if(m(e))return{data:null,error:e};throw e}}async linkIdentity(e){var t;try{const{data:s,error:i}=await this._useSession((async t=>{var s,r,i,n,o;const{data:a,error:c}=t;if(c)throw c;const l=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:null===(s=e.options)||void 0===s?void 0:s.redirectTo,scopes:null===(r=e.options)||void 0===r?void 0:r.scopes,queryParams:null===(i=e.options)||void 0===i?void 0:i.queryParams,skipBrowserRedirect:!0});return await L(this.fetch,"GET",l,{headers:this.headers,jwt:null!==(o=null===(n=a.session)||void 0===n?void 0:n.access_token)&&void 0!==o?o:void 0})}));if(i)throw i;return r()&&!(null===(t=e.options)||void 0===t?void 0:t.skipBrowserRedirect)&&window.location.assign(null==s?void 0:s.url),{data:{provider:e.provider,url:null==s?void 0:s.url},error:null}}catch(t){if(m(t))return{data:{provider:e.provider,url:null},error:t};throw t}}async unlinkIdentity(e){try{return await this._useSession((async t=>{var s,r;const{data:i,error:n}=t;if(n)throw n;return await L(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:null!==(r=null===(s=i.session)||void 0===s?void 0:s.access_token)&&void 0!==r?r:void 0})}))}catch(e){if(m(e))return{data:null,error:e};throw e}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const i=Date.now();return await(s=async s=>(await async function(e){return await new Promise((t=>{setTimeout((()=>t(null)),e)}))}(200*s),this._debug(t,"refreshing attempt",s),await L(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:U})),r=(e,t,s)=>s&&s.error&&$(s.error)&&Date.now()+200*(e+1)-i<X,new Promise(((e,t)=>{(async()=>{for(let i=0;i<1/0;i++)try{const t=await s(i);if(!r(i,0,t))return void e(t)}catch(e){if(!r(i))return void t(e)}})()})))}catch(e){if(this._debug(t,"error",e),m(e))return{data:{session:null,user:null},error:e};throw e}finally{this._debug(t,"end")}var s,r}_isValidSession(e){return"object"==typeof e&&null!==e&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const s=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",s),r()&&!t.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}}async _recoverAndRefresh(){var e;const t="#_recoverAndRefresh()";this._debug(t,"begin");try{const s=await h(this.storage,this.storageKey);if(this._debug(t,"session from storage",s),!this._isValidSession(s))return this._debug(t,"session is not valid"),void(null!==s&&await this._removeSession());const r=Math.round(Date.now()/1e3),i=(null!==(e=s.expires_at)&&void 0!==e?e:1/0)<r+10;if(this._debug(t,`session has${i?"":" not"} expired with margin of 10s`),i){if(this.autoRefreshToken&&s.refresh_token){const{error:e}=await this._callRefreshToken(s.refresh_token);e&&(console.error(e),$(e)||(this._debug(t,"refresh failed with a non-retryable error, removing the session",e),await this._removeSession()))}}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(e){return this._debug(t,"error",e),void console.error(e)}finally{this._debug(t,"end")}}async _callRefreshToken(e){var t,s;if(!e)throw new S;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const r=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(r,"begin");try{this.refreshingDeferred=new d;const{data:t,error:s}=await this._refreshAccessToken(e);if(s)throw s;if(!t.session)throw new S;await this._saveSession(t.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",t.session);const r={session:t.session,error:null};return this.refreshingDeferred.resolve(r),r}catch(e){if(this._debug(r,"error",e),m(e)){const s={session:null,error:e};return $(e)||(await this._removeSession(),await this._notifyAllSubscribers("SIGNED_OUT",null)),null===(t=this.refreshingDeferred)||void 0===t||t.resolve(s),s}throw null===(s=this.refreshingDeferred)||void 0===s||s.reject(e),e}finally{this.refreshingDeferred=null,this._debug(r,"end")}}async _notifyAllSubscribers(e,t,s=!0){const r=`#_notifyAllSubscribers(${e})`;this._debug(r,"begin",t,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:t});const r=[],i=Array.from(this.stateChangeEmitters.values()).map((async s=>{try{await s.callback(e,t)}catch(e){r.push(e)}}));if(await Promise.all(i),r.length>0){for(let e=0;e<r.length;e+=1)console.error(r[e]);throw r[0]}}finally{this._debug(r,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),await l(this.storage,this.storageKey,e)}async _removeSession(){this._debug("#_removeSession()"),await u(this.storage,this.storageKey)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&r()&&(null===window||void 0===window?void 0:window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(e){console.error("removing visibilitychange callback failed",e)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval((()=>this._autoRefreshTokenTick()),X);this.autoRefreshTicker=e,e&&"object"==typeof e&&"function"==typeof e.unref?e.unref():"undefined"!=typeof Deno&&"function"==typeof Deno.unrefTimer&&Deno.unrefTimer(e),setTimeout((async()=>{await this.initializePromise,await this._autoRefreshTokenTick()}),0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,(async()=>{try{const e=Date.now();try{return await this._useSession((async t=>{const{data:{session:s}}=t;if(!s||!s.refresh_token||!s.expires_at)return void this._debug("#_autoRefreshTokenTick()","no session");const r=Math.floor((1e3*s.expires_at-e)/X);this._debug("#_autoRefreshTokenTick()",`access token expires in ${r} ticks, a tick lasts 30000ms, refresh threshold is 3 ticks`),r<=3&&await this._callRefreshToken(s.refresh_token)}))}catch(e){console.error("Auto refresh tick failed with error. This is likely a transient error.",e)}}finally{this._debug("#_autoRefreshTokenTick()","end")}}))}catch(e){if(!(e.isAcquireTimeout||e instanceof H))throw e;this._debug("auto refresh token tick lock not available")}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!r()||!(null===window||void 0===window?void 0:window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),null===window||void 0===window||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),"visible"===document.visibilityState?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,(async()=>{"visible"===document.visibilityState?await this._recoverAndRefresh():this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting")})))):"hidden"===document.visibilityState&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,s){const r=[`provider=${encodeURIComponent(t)}`];if((null==s?void 0:s.redirectTo)&&r.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),(null==s?void 0:s.scopes)&&r.push(`scopes=${encodeURIComponent(s.scopes)}`),"pkce"===this.flowType){const e=g();await l(this.storage,`${this.storageKey}-code-verifier`,e);const t=await y(e),s=e===t?"plain":"s256";this._debug("PKCE","code verifier",`${e.substring(0,5)}...`,"code challenge",t,"method",s);const i=new URLSearchParams({code_challenge:`${encodeURIComponent(t)}`,code_challenge_method:`${encodeURIComponent(s)}`});r.push(i.toString())}if(null==s?void 0:s.queryParams){const e=new URLSearchParams(s.queryParams);r.push(e.toString())}return(null==s?void 0:s.skipBrowserRedirect)&&r.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${e}?${r.join("&")}`}async _unenroll(e){try{return await this._useSession((async t=>{var s;const{data:r,error:i}=t;return i?{data:null,error:i}:await L(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:null===(s=null==r?void 0:r.session)||void 0===s?void 0:s.access_token})}))}catch(e){if(m(e))return{data:null,error:e};throw e}}async _enroll(e){try{return await this._useSession((async t=>{var s,r;const{data:i,error:n}=t;if(n)return{data:null,error:n};const{data:o,error:a}=await L(this.fetch,"POST",`${this.url}/factors`,{body:{friendly_name:e.friendlyName,factor_type:e.factorType,issuer:e.issuer},headers:this.headers,jwt:null===(s=null==i?void 0:i.session)||void 0===s?void 0:s.access_token});return a?{data:null,error:a}:((null===(r=null==o?void 0:o.totp)||void 0===r?void 0:r.qr_code)&&(o.totp.qr_code=`data:image/svg+xml;utf-8,${o.totp.qr_code}`),{data:o,error:null})}))}catch(e){if(m(e))return{data:null,error:e};throw e}}async _verify(e){return this._acquireLock(-1,(async()=>{try{return await this._useSession((async t=>{var s;const{data:r,error:i}=t;if(i)return{data:null,error:i};const{data:n,error:o}=await L(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:null===(s=null==r?void 0:r.session)||void 0===s?void 0:s.access_token});return o?{data:null,error:o}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+n.expires_in},n)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",n),{data:n,error:o})}))}catch(e){if(m(e))return{data:null,error:e};throw e}}))}async _challenge(e){return this._acquireLock(-1,(async()=>{try{return await this._useSession((async t=>{var s;const{data:r,error:i}=t;return i?{data:null,error:i}:await L(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{headers:this.headers,jwt:null===(s=null==r?void 0:r.session)||void 0===s?void 0:s.access_token})}))}catch(e){if(m(e))return{data:null,error:e};throw e}}))}async _challengeAndVerify(e){const{data:t,error:s}=await this._challenge({factorId:e.factorId});return s?{data:null,error:s}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const s=(null==e?void 0:e.factors)||[],r=s.filter((e=>"totp"===e.factor_type&&"verified"===e.status));return{data:{all:s,totp:r},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,(async()=>await this._useSession((async e=>{var t,s;const{data:{session:r},error:i}=e;if(i)return{data:null,error:i};if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const n=this._decodeJWT(r.access_token);let o=null;n.aal&&(o=n.aal);let a=o;return(null!==(s=null===(t=r.user.factors)||void 0===t?void 0:t.filter((e=>"verified"===e.status)))&&void 0!==s?s:[]).length>0&&(a="aal2"),{data:{currentLevel:o,nextLevel:a,currentAuthenticationMethods:n.amr||[]},error:null}}))))}}Z.nextInstanceID=0},743:(e,t,s)=>{var r=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==s.g)return s.g;throw new Error("unable to locate global object")}();e.exports=t=r.fetch,r.fetch&&(t.default=r.fetch.bind(r)),t.Headers=r.Headers,t.Request=r.Request,t.Response=r.Response},189:(e,t,s)=>{s.r(t),s.d(t,{PostgrestBuilder:()=>n,PostgrestClient:()=>h,PostgrestFilterBuilder:()=>a,PostgrestQueryBuilder:()=>c,PostgrestTransformBuilder:()=>o});var r=s(743),i=s.n(r);class n{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:"undefined"==typeof fetch?this.fetch=i():this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}then(e,t){void 0===this.schema||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),"GET"!==this.method&&"HEAD"!==this.method&&(this.headers["Content-Type"]="application/json");let s=(0,this.fetch)(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then((async e=>{var t,s,r;let i=null,n=null,o=null,a=e.status,c=e.statusText;if(e.ok){if("HEAD"!==this.method){const t=await e.text();""===t||(n="text/csv"===this.headers.Accept||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?t:JSON.parse(t))}const r=null===(t=this.headers.Prefer)||void 0===t?void 0:t.match(/count=(exact|planned|estimated)/),l=null===(s=e.headers.get("content-range"))||void 0===s?void 0:s.split("/");r&&l&&l.length>1&&(o=parseInt(l[1])),this.isMaybeSingle&&"GET"===this.method&&Array.isArray(n)&&(n.length>1?(i={code:"PGRST116",details:`Results contain ${n.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},n=null,o=null,a=406,c="Not Acceptable"):n=1===n.length?n[0]:null)}else{const t=await e.text();try{i=JSON.parse(t),Array.isArray(i)&&404===e.status&&(n=[],i=null,a=200,c="OK")}catch(s){404===e.status&&""===t?(a=204,c="No Content"):i={message:t}}if(i&&this.isMaybeSingle&&(null===(r=null==i?void 0:i.details)||void 0===r?void 0:r.includes("0 rows"))&&(i=null,a=200,c="OK"),i&&this.shouldThrowOnError)throw i}return{error:i,data:n,count:o,status:a,statusText:c}}));return this.shouldThrowOnError||(s=s.catch((e=>{var t,s,r;return{error:{message:`${null!==(t=null==e?void 0:e.name)&&void 0!==t?t:"FetchError"}: ${null==e?void 0:e.message}`,details:`${null!==(s=null==e?void 0:e.stack)&&void 0!==s?s:""}`,hint:"",code:`${null!==(r=null==e?void 0:e.code)&&void 0!==r?r:""}`},data:null,count:null,status:0,statusText:""}}))),s.then(e,t)}}class o extends n{select(e){let t=!1;const s=(null!=e?e:"*").split("").map((e=>/\s/.test(e)&&!t?"":('"'===e&&(t=!t),e))).join("");return this.url.searchParams.set("select",s),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:t=!0,nullsFirst:s,foreignTable:r,referencedTable:i=r}={}){const n=i?`${i}.order`:"order",o=this.url.searchParams.get(n);return this.url.searchParams.set(n,`${o?`${o},`:""}${e}.${t?"asc":"desc"}${void 0===s?"":s?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:s=t}={}){const r=void 0===s?"limit":`${s}.limit`;return this.url.searchParams.set(r,`${e}`),this}range(e,t,{foreignTable:s,referencedTable:r=s}={}){const i=void 0===r?"offset":`${r}.offset`,n=void 0===r?"limit":`${r}.limit`;return this.url.searchParams.set(i,`${e}`),this.url.searchParams.set(n,""+(t-e+1)),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return"GET"===this.method?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:t=!1,settings:s=!1,buffers:r=!1,wal:i=!1,format:n="text"}={}){var o;const a=[e?"analyze":null,t?"verbose":null,s?"settings":null,r?"buffers":null,i?"wal":null].filter(Boolean).join("|"),c=null!==(o=this.headers.Accept)&&void 0!==o?o:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${n}; for="${c}"; options=${a};`,this}rollback(){var e;return(null!==(e=this.headers.Prefer)&&void 0!==e?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}}class a extends o{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const s=t.map((e=>"string"==typeof e&&new RegExp("[,()]").test(e)?`"${e}"`:`${e}`)).join(",");return this.url.searchParams.append(e,`in.(${s})`),this}contains(e,t){return"string"==typeof t?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return"string"==typeof t?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return"string"==typeof t?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:s,type:r}={}){let i="";"plain"===r?i="pl":"phrase"===r?i="ph":"websearch"===r&&(i="w");const n=void 0===s?"":`(${s})`;return this.url.searchParams.append(e,`${i}fts${n}.${t}`),this}match(e){return Object.entries(e).forEach((([e,t])=>{this.url.searchParams.append(e,`eq.${t}`)})),this}not(e,t,s){return this.url.searchParams.append(e,`not.${t}.${s}`),this}or(e,{foreignTable:t,referencedTable:s=t}={}){const r=s?`${s}.or`:"or";return this.url.searchParams.append(r,`(${e})`),this}filter(e,t,s){return this.url.searchParams.append(e,`${t}.${s}`),this}}class c{constructor(e,{headers:t={},schema:s,fetch:r}){this.url=e,this.headers=t,this.schema=s,this.fetch=r}select(e,{head:t=!1,count:s}={}){const r=t?"HEAD":"GET";let i=!1;const n=(null!=e?e:"*").split("").map((e=>/\s/.test(e)&&!i?"":('"'===e&&(i=!i),e))).join("");return this.url.searchParams.set("select",n),s&&(this.headers.Prefer=`count=${s}`),new a({method:r,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:t,defaultToNull:s=!0}={}){const r=[];if(this.headers.Prefer&&r.push(this.headers.Prefer),t&&r.push(`count=${t}`),s||r.push("missing=default"),this.headers.Prefer=r.join(","),Array.isArray(e)){const t=e.reduce(((e,t)=>e.concat(Object.keys(t))),[]);if(t.length>0){const e=[...new Set(t)].map((e=>`"${e}"`));this.url.searchParams.set("columns",e.join(","))}}return new a({method:"POST",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:t,ignoreDuplicates:s=!1,count:r,defaultToNull:i=!0}={}){const n=[`resolution=${s?"ignore":"merge"}-duplicates`];if(void 0!==t&&this.url.searchParams.set("on_conflict",t),this.headers.Prefer&&n.push(this.headers.Prefer),r&&n.push(`count=${r}`),i||n.push("missing=default"),this.headers.Prefer=n.join(","),Array.isArray(e)){const t=e.reduce(((e,t)=>e.concat(Object.keys(t))),[]);if(t.length>0){const e=[...new Set(t)].map((e=>`"${e}"`));this.url.searchParams.set("columns",e.join(","))}}return new a({method:"POST",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:t}={}){const s=[];return this.headers.Prefer&&s.push(this.headers.Prefer),t&&s.push(`count=${t}`),this.headers.Prefer=s.join(","),new a({method:"PATCH",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const t=[];return e&&t.push(`count=${e}`),this.headers.Prefer&&t.unshift(this.headers.Prefer),this.headers.Prefer=t.join(","),new a({method:"DELETE",url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}}const l={"X-Client-Info":"postgrest-js/1.9.0"};class h{constructor(e,{headers:t={},schema:s,fetch:r}={}){this.url=e,this.headers=Object.assign(Object.assign({},l),t),this.schemaName=s,this.fetch=r}from(e){const t=new URL(`${this.url}/${e}`);return new c(t,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new h(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:s=!1,count:r}={}){let i;const n=new URL(`${this.url}/rpc/${e}`);let o;s?(i="HEAD",Object.entries(t).forEach((([e,t])=>{n.searchParams.append(e,`${t}`)}))):(i="POST",o=t);const c=Object.assign({},this.headers);return r&&(c.Prefer=`count=${r}`),new a({method:i,url:n,headers:c,schema:this.schemaName,body:o,fetch:this.fetch,allowEmpty:!1})}}},73:(e,t,s)=>{s.r(t),s.d(t,{REALTIME_CHANNEL_STATES:()=>O,REALTIME_LISTEN_TYPES:()=>E,REALTIME_POSTGRES_CHANGES_LISTEN_EVENT:()=>T,REALTIME_PRESENCE_LISTEN_EVENTS:()=>l,REALTIME_SUBSCRIBE_STATES:()=>j,RealtimeChannel:()=>P,RealtimeClient:()=>A,RealtimePresence:()=>p});const r={"X-Client-Info":"realtime-js/2.9.3"};var i,n,o,a,c,l,h;!function(e){e[e.connecting=0]="connecting",e[e.open=1]="open",e[e.closing=2]="closing",e[e.closed=3]="closed"}(i||(i={})),function(e){e.closed="closed",e.errored="errored",e.joined="joined",e.joining="joining",e.leaving="leaving"}(n||(n={})),function(e){e.close="phx_close",e.error="phx_error",e.join="phx_join",e.reply="phx_reply",e.leave="phx_leave",e.access_token="access_token"}(o||(o={})),function(e){e.websocket="websocket"}(a||(a={})),function(e){e.Connecting="connecting",e.Open="open",e.Closing="closing",e.Closed="closed"}(c||(c={}));class u{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout((()=>{this.tries=this.tries+1,this.callback()}),this.timerCalc(this.tries+1))}}class d{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t("string"==typeof e?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),s=new TextDecoder;return this._decodeBroadcast(e,t,s)}_decodeBroadcast(e,t,s){const r=t.getUint8(1),i=t.getUint8(2);let n=this.HEADER_LENGTH+2;const o=s.decode(e.slice(n,n+r));n+=r;const a=s.decode(e.slice(n,n+i));return n+=i,{ref:null,topic:o,event:a,payload:JSON.parse(s.decode(e.slice(n,e.byteLength)))}}}class f{constructor(e,t,s={},r=1e4){this.channel=e,this.event=t,this.payload=s,this.timeout=r,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var s;return this._hasReceived(e)&&t(null===(s=this.receivedResp)||void 0===s?void 0:s.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){this.timeoutTimer||(this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref),this.channel._on(this.refEvent,{},(e=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=e,this._matchReceive(e)})),this.timeoutTimer=setTimeout((()=>{this.trigger("timeout",{})}),this.timeout))}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter((t=>t.status===e)).forEach((e=>e.callback(t)))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}!function(e){e.SYNC="sync",e.JOIN="join",e.LEAVE="leave"}(l||(l={}));class p{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(null==t?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},(e=>{const{onJoin:t,onLeave:s,onSync:r}=this.caller;this.joinRef=this.channel._joinRef(),this.state=p.syncState(this.state,e,t,s),this.pendingDiffs.forEach((e=>{this.state=p.syncDiff(this.state,e,t,s)})),this.pendingDiffs=[],r()})),this.channel._on(s.diff,{},(e=>{const{onJoin:t,onLeave:s,onSync:r}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(e):(this.state=p.syncDiff(this.state,e,t,s),r())})),this.onJoin(((e,t,s)=>{this.channel._trigger("presence",{event:"join",key:e,currentPresences:t,newPresences:s})})),this.onLeave(((e,t,s)=>{this.channel._trigger("presence",{event:"leave",key:e,currentPresences:t,leftPresences:s})})),this.onSync((()=>{this.channel._trigger("presence",{event:"sync"})}))}static syncState(e,t,s,r){const i=this.cloneDeep(e),n=this.transformState(t),o={},a={};return this.map(i,((e,t)=>{n[e]||(a[e]=t)})),this.map(n,((e,t)=>{const s=i[e];if(s){const r=t.map((e=>e.presence_ref)),i=s.map((e=>e.presence_ref)),n=t.filter((e=>i.indexOf(e.presence_ref)<0)),c=s.filter((e=>r.indexOf(e.presence_ref)<0));n.length>0&&(o[e]=n),c.length>0&&(a[e]=c)}else o[e]=t})),this.syncDiff(i,{joins:o,leaves:a},s,r)}static syncDiff(e,t,s,r){const{joins:i,leaves:n}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return s||(s=()=>{}),r||(r=()=>{}),this.map(i,((t,r)=>{var i;const n=null!==(i=e[t])&&void 0!==i?i:[];if(e[t]=this.cloneDeep(r),n.length>0){const s=e[t].map((e=>e.presence_ref)),r=n.filter((e=>s.indexOf(e.presence_ref)<0));e[t].unshift(...r)}s(t,n,r)})),this.map(n,((t,s)=>{let i=e[t];if(!i)return;const n=s.map((e=>e.presence_ref));i=i.filter((e=>n.indexOf(e.presence_ref)<0)),e[t]=i,r(t,i,s),0===i.length&&delete e[t]})),e}static map(e,t){return Object.getOwnPropertyNames(e).map((s=>t(s,e[s])))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce(((t,s)=>{const r=e[s];return t[s]="metas"in r?r.metas.map((e=>(e.presence_ref=e.phx_ref,delete e.phx_ref,delete e.phx_ref_prev,e))):r,t}),{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}!function(e){e.abstime="abstime",e.bool="bool",e.date="date",e.daterange="daterange",e.float4="float4",e.float8="float8",e.int2="int2",e.int4="int4",e.int4range="int4range",e.int8="int8",e.int8range="int8range",e.json="json",e.jsonb="jsonb",e.money="money",e.numeric="numeric",e.oid="oid",e.reltime="reltime",e.text="text",e.time="time",e.timestamp="timestamp",e.timestamptz="timestamptz",e.timetz="timetz",e.tsrange="tsrange",e.tstzrange="tstzrange"}(h||(h={}));const g=(e,t,s={})=>{var r;const i=null!==(r=s.skipTypes)&&void 0!==r?r:[];return Object.keys(t).reduce(((s,r)=>(s[r]=y(r,e,t,i),s)),{})},y=(e,t,s,r)=>{const i=t.find((t=>t.name===e)),n=null==i?void 0:i.type,o=s[e];return n&&!r.includes(n)?v(n,o):m(o)},v=(e,t)=>{if("_"===e.charAt(0)){const s=e.slice(1,e.length);return k(t,s)}switch(e){case h.bool:return _(t);case h.float4:case h.float8:case h.int2:case h.int4:case h.int8:case h.numeric:case h.oid:return b(t);case h.json:case h.jsonb:return w(t);case h.timestamp:return S(t);case h.abstime:case h.date:case h.daterange:case h.int4range:case h.int8range:case h.money:case h.reltime:case h.text:case h.time:case h.timestamptz:case h.timetz:case h.tsrange:case h.tstzrange:default:return m(t)}},m=e=>e,_=e=>{switch(e){case"t":return!0;case"f":return!1;default:return e}},b=e=>{if("string"==typeof e){const t=parseFloat(e);if(!Number.isNaN(t))return t}return e},w=e=>{if("string"==typeof e)try{return JSON.parse(e)}catch(t){return console.log(`JSON parse error: ${t}`),e}return e},k=(e,t)=>{if("string"!=typeof e)return e;const s=e.length-1,r=e[s];if("{"===e[0]&&"}"===r){let r;const i=e.slice(1,s);try{r=JSON.parse("["+i+"]")}catch(e){r=i?i.split(","):[]}return r.map((e=>v(t,e)))}return e},S=e=>"string"==typeof e?e.replace(" ","T"):e;var T,E,j;!function(e){e.ALL="*",e.INSERT="INSERT",e.UPDATE="UPDATE",e.DELETE="DELETE"}(T||(T={})),function(e){e.BROADCAST="broadcast",e.PRESENCE="presence",e.POSTGRES_CHANGES="postgres_changes"}(E||(E={})),function(e){e.SUBSCRIBED="SUBSCRIBED",e.TIMED_OUT="TIMED_OUT",e.CLOSED="CLOSED",e.CHANNEL_ERROR="CHANNEL_ERROR"}(j||(j={}));const O=n;class P{constructor(e,t={config:{}},s){this.topic=e,this.params=t,this.socket=s,this.bindings={},this.state=n.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""}},t.config),this.timeout=this.socket.timeout,this.joinPush=new f(this,o.join,this.params,this.timeout),this.rejoinTimer=new u((()=>this._rejoinUntilConnected()),this.socket.reconnectAfterMs),this.joinPush.receive("ok",(()=>{this.state=n.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach((e=>e.send())),this.pushBuffer=[]})),this._onClose((()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=n.closed,this.socket._remove(this)})),this._onError((e=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,e),this.state=n.errored,this.rejoinTimer.scheduleTimeout())})),this.joinPush.receive("timeout",(()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=n.errored,this.rejoinTimer.scheduleTimeout())})),this._on(o.reply,{},((e,t)=>{this._trigger(this._replyEventName(t),e)})),this.presence=new p(this),this.broadcastEndpointURL=this._broadcastEndpointURL()}subscribe(e,t=this.timeout){var s,r;if(this.socket.isConnected()||this.socket.connect(),this.joinedOnce)throw"tried to subscribe multiple times. 'subscribe' can only be called a single time per channel instance";{const{config:{broadcast:i,presence:n}}=this.params;this._onError((t=>e&&e("CHANNEL_ERROR",t))),this._onClose((()=>e&&e("CLOSED")));const o={},a={broadcast:i,presence:n,postgres_changes:null!==(r=null===(s=this.bindings.postgres_changes)||void 0===s?void 0:s.map((e=>e.filter)))&&void 0!==r?r:[]};this.socket.accessToken&&(o.access_token=this.socket.accessToken),this.updateJoinPayload(Object.assign({config:a},o)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",(({postgres_changes:t})=>{var s;if(this.socket.accessToken&&this.socket.setAuth(this.socket.accessToken),void 0!==t){const r=this.bindings.postgres_changes,i=null!==(s=null==r?void 0:r.length)&&void 0!==s?s:0,n=[];for(let s=0;s<i;s++){const i=r[s],{filter:{event:o,schema:a,table:c,filter:l}}=i,h=t&&t[s];if(!h||h.event!==o||h.schema!==a||h.table!==c||h.filter!==l)return this.unsubscribe(),void(e&&e("CHANNEL_ERROR",new Error("mismatch between server and client bindings for postgres changes")));n.push(Object.assign(Object.assign({},i),{id:h.id}))}return this.bindings.postgres_changes=n,void(e&&e("SUBSCRIBED"))}e&&e("SUBSCRIBED")})).receive("error",(t=>{e&&e("CHANNEL_ERROR",new Error(JSON.stringify(Object.values(t).join(", ")||"error")))})).receive("timeout",(()=>{e&&e("TIMED_OUT")}))}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,s){return this._on(e,t,s)}async send(e,t={}){var s,r;if(this._canPush()||"broadcast"!==e.type)return new Promise((s=>{var r,i,n;const o=this._push(e.type,e,t.timeout||this.timeout);"broadcast"!==e.type||(null===(n=null===(i=null===(r=this.params)||void 0===r?void 0:r.config)||void 0===i?void 0:i.broadcast)||void 0===n?void 0:n.ack)||s("ok"),o.receive("ok",(()=>s("ok"))),o.receive("timeout",(()=>s("timed out")))}));{const{event:i,payload:n}=e,o={method:"POST",headers:{apikey:null!==(s=this.socket.apiKey)&&void 0!==s?s:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:n}]})};try{return(await this._fetchWithTimeout(this.broadcastEndpointURL,o,null!==(r=t.timeout)&&void 0!==r?r:this.timeout)).ok?"ok":"error"}catch(e){return"AbortError"===e.name?"timed out":"error"}}}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=n.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(o.close,"leave",this._joinRef())};return this.rejoinTimer.reset(),this.joinPush.destroy(),new Promise((s=>{const r=new f(this,o.leave,{},e);r.receive("ok",(()=>{t(),s("ok")})).receive("timeout",(()=>{t(),s("timed out")})).receive("error",(()=>{s("error")})),r.send(),this._canPush()||r.trigger("ok",{})}))}_broadcastEndpointURL(){let e=this.socket.endPoint;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")+"/api/broadcast"}async _fetchWithTimeout(e,t,s){const r=new AbortController,i=setTimeout((()=>r.abort()),s),n=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:r.signal}));return clearTimeout(i),n}_push(e,t,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let r=new f(this,e,t,s);return this._canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}_onMessage(e,t,s){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,s){var r,i;const n=e.toLocaleLowerCase(),{close:a,error:c,leave:l,join:h}=o;if(s&&[a,c,l,h].indexOf(n)>=0&&s!==this._joinRef())return;let u=this._onMessage(n,t,s);if(t&&!u)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(n)?null===(r=this.bindings.postgres_changes)||void 0===r||r.filter((e=>{var t,s,r;return"*"===(null===(t=e.filter)||void 0===t?void 0:t.event)||(null===(r=null===(s=e.filter)||void 0===s?void 0:s.event)||void 0===r?void 0:r.toLocaleLowerCase())===n})).map((e=>e.callback(u,s))):null===(i=this.bindings[n])||void 0===i||i.filter((e=>{var s,r,i,o,a,c;if(["broadcast","presence","postgres_changes"].includes(n)){if("id"in e){const n=e.id,o=null===(s=e.filter)||void 0===s?void 0:s.event;return n&&(null===(r=t.ids)||void 0===r?void 0:r.includes(n))&&("*"===o||(null==o?void 0:o.toLocaleLowerCase())===(null===(i=t.data)||void 0===i?void 0:i.type.toLocaleLowerCase()))}{const s=null===(a=null===(o=null==e?void 0:e.filter)||void 0===o?void 0:o.event)||void 0===a?void 0:a.toLocaleLowerCase();return"*"===s||s===(null===(c=null==t?void 0:t.event)||void 0===c?void 0:c.toLocaleLowerCase())}}return e.type.toLocaleLowerCase()===n})).map((e=>{if("object"==typeof u&&"ids"in u){const e=u.data,{schema:t,table:s,commit_timestamp:r,type:i,errors:n}=e,o={schema:t,table:s,commit_timestamp:r,eventType:i,new:{},old:{},errors:n};u=Object.assign(Object.assign({},o),this._getPayloadRecords(e))}e.callback(u,s)}))}_isClosed(){return this.state===n.closed}_isJoined(){return this.state===n.joined}_isJoining(){return this.state===n.joining}_isLeaving(){return this.state===n.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,s){const r=e.toLocaleLowerCase(),i={type:r,filter:t,callback:s};return this.bindings[r]?this.bindings[r].push(i):this.bindings[r]=[i],this}_off(e,t){const s=e.toLocaleLowerCase();return this.bindings[s]=this.bindings[s].filter((e=>{var r;return!((null===(r=e.type)||void 0===r?void 0:r.toLocaleLowerCase())===s&&P.isEqual(e.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(o.close,{},e)}_onError(e){this._on(o.error,{},(t=>e(t)))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=n.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return"INSERT"!==e.type&&"UPDATE"!==e.type||(t.new=g(e.columns,e.record)),"UPDATE"!==e.type&&"DELETE"!==e.type||(t.old=g(e.columns,e.old_record)),t}}const $=()=>{},x="undefined"!=typeof WebSocket;class A{constructor(e,t){var i;this.accessToken=null,this.apiKey=null,this.channels=[],this.endPoint="",this.headers=r,this.params={},this.timeout=1e4,this.heartbeatIntervalMs=3e4,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.ref=0,this.logger=$,this.conn=null,this.sendBuffer=[],this.serializer=new d,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this._resolveFetch=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>Promise.resolve().then(s.t.bind(s,743,23)).then((({default:t})=>t(...e))):fetch),(...e)=>t(...e)},this.endPoint=`${e}/${a.websocket}`,(null==t?void 0:t.transport)?this.transport=t.transport:this.transport=null,(null==t?void 0:t.params)&&(this.params=t.params),(null==t?void 0:t.headers)&&(this.headers=Object.assign(Object.assign({},this.headers),t.headers)),(null==t?void 0:t.timeout)&&(this.timeout=t.timeout),(null==t?void 0:t.logger)&&(this.logger=t.logger),(null==t?void 0:t.heartbeatIntervalMs)&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const n=null===(i=null==t?void 0:t.params)||void 0===i?void 0:i.apikey;n&&(this.accessToken=n,this.apiKey=n),this.reconnectAfterMs=(null==t?void 0:t.reconnectAfterMs)?t.reconnectAfterMs:e=>[1e3,2e3,5e3,1e4][e-1]||1e4,this.encode=(null==t?void 0:t.encode)?t.encode:(e,t)=>t(JSON.stringify(e)),this.decode=(null==t?void 0:t.decode)?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new u((async()=>{this.disconnect(),this.connect()}),this.reconnectAfterMs),this.fetch=this._resolveFetch(null==t?void 0:t.fetch)}connect(){if(!this.conn)if(this.transport)this.conn=new this.transport(this._endPointURL(),void 0,{headers:this.headers});else{if(x)return this.conn=new WebSocket(this._endPointURL()),void this.setupConnection();this.conn=new C(this._endPointURL(),void 0,{close:()=>{this.conn=null}}),s.e(26).then(s.t.bind(s,26,23)).then((({default:e})=>{this.conn=new e(this._endPointURL(),void 0,{headers:this.headers}),this.setupConnection()}))}}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,null!=t?t:""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return 0===this.channels.length&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map((e=>e.unsubscribe())));return this.disconnect(),e}log(e,t,s){this.logger(e,t,s)}connectionState(){switch(this.conn&&this.conn.readyState){case i.connecting:return c.Connecting;case i.open:return c.Open;case i.closing:return c.Closing;default:return c.Closed}}isConnected(){return this.connectionState()===c.Open}channel(e,t={config:{}}){const s=new P(`realtime:${e}`,t,this);return this.channels.push(s),s}push(e){const{topic:t,event:s,payload:r,ref:i}=e,n=()=>{this.encode(e,(e=>{var t;null===(t=this.conn)||void 0===t||t.send(e)}))};this.log("push",`${t} ${s} (${i})`,r),this.isConnected()?n():this.sendBuffer.push(n)}setAuth(e){this.accessToken=e,this.channels.forEach((t=>{e&&t.updateJoinPayload({access_token:e}),t.joinedOnce&&t._isJoined()&&t._push(o.access_token,{access_token:e})}))}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find((t=>t.topic===e&&(t._isJoined()||t._isJoining())));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter((t=>t._joinRef()!==e._joinRef()))}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_endPointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:"1.0.0"}))}_onConnMessage(e){this.decode(e.data,(e=>{let{topic:t,event:s,payload:r,ref:i}=e;(i&&i===this.pendingHeartbeatRef||s===(null==r?void 0:r.type))&&(this.pendingHeartbeatRef=null),this.log("receive",`${r.status||""} ${t} ${s} ${i&&"("+i+")"||""}`,r),this.channels.filter((e=>e._isMember(t))).forEach((e=>e._trigger(s,r,i))),this.stateChangeCallbacks.message.forEach((t=>t(e)))}))}_onConnOpen(){this.log("transport",`connected to ${this._endPointURL()}`),this._flushSendBuffer(),this.reconnectTimer.reset(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval((()=>this._sendHeartbeat()),this.heartbeatIntervalMs),this.stateChangeCallbacks.open.forEach((e=>e()))}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach((t=>t(e)))}_onConnError(e){this.log("transport",e.message),this._triggerChanError(),this.stateChangeCallbacks.error.forEach((t=>t(e)))}_triggerChanError(){this.channels.forEach((e=>e._trigger(o.error)))}_appendParams(e,t){if(0===Object.keys(t).length)return e;const s=e.match(/\?/)?"&":"?";return`${e}${s}${new URLSearchParams(t)}`}_flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach((e=>e())),this.sendBuffer=[])}_sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef)return this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),void(null===(e=this.conn)||void 0===e||e.close(1e3,"hearbeat timeout"));this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth(this.accessToken)}}}class C{constructor(e,t,s){this.binaryType="arraybuffer",this.onclose=()=>{},this.onerror=()=>{},this.onmessage=()=>{},this.onopen=()=>{},this.readyState=i.connecting,this.send=()=>{},this.url=null,this.url=e,this.close=s.close}}},752:(e,t,s)=>{s.r(t),s.d(t,{StorageApiError:()=>n,StorageClient:()=>S,StorageError:()=>r,StorageUnknownError:()=>o,isStorageError:()=>i});class r extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function i(e){return"object"==typeof e&&null!==e&&"__isStorageError"in e}class n extends r{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class o extends r{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}const a=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>Promise.resolve().then(s.t.bind(s,743,23)).then((({default:t})=>t(...e))):fetch),(...e)=>t(...e)};var c=function(e,t,s,r){return new(s||(s=Promise))((function(i,n){function o(e){try{c(r.next(e))}catch(e){n(e)}}function a(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};const l=e=>e.msg||e.message||e.error_description||e.error||JSON.stringify(e),h=(e,t)=>c(void 0,void 0,void 0,(function*(){const r=yield(i=void 0,a=void 0,c=void 0,h=function*(){return"undefined"==typeof Response?(yield Promise.resolve().then(s.t.bind(s,743,23))).Response:Response},new(c||(c=Promise))((function(e,t){function s(e){try{n(h.next(e))}catch(e){t(e)}}function r(e){try{n(h.throw(e))}catch(e){t(e)}}function n(t){var i;t.done?e(t.value):(i=t.value,i instanceof c?i:new c((function(e){e(i)}))).then(s,r)}n((h=h.apply(i,a||[])).next())})));var i,a,c,h;e instanceof r?e.json().then((s=>{t(new n(l(s),e.status||500))})).catch((e=>{t(new o(l(e),e))})):t(new o(l(e),e))})),u=(e,t,s,r)=>{const i={method:e,headers:(null==t?void 0:t.headers)||{}};return"GET"===e?i:(i.headers=Object.assign({"Content-Type":"application/json"},null==t?void 0:t.headers),i.body=JSON.stringify(r),Object.assign(Object.assign({},i),s))};function d(e,t,s,r,i,n){return c(this,void 0,void 0,(function*(){return new Promise(((o,a)=>{e(s,u(t,r,i,n)).then((e=>{if(!e.ok)throw e;return(null==r?void 0:r.noResolveJson)?e:e.json()})).then((e=>o(e))).catch((e=>h(e,a)))}))}))}function f(e,t,s,r){return c(this,void 0,void 0,(function*(){return d(e,"GET",t,s,r)}))}function p(e,t,s,r,i){return c(this,void 0,void 0,(function*(){return d(e,"POST",t,r,i,s)}))}function g(e,t,s,r,i){return c(this,void 0,void 0,(function*(){return d(e,"DELETE",t,r,i,s)}))}var y=function(e,t,s,r){return new(s||(s=Promise))((function(i,n){function o(e){try{c(r.next(e))}catch(e){n(e)}}function a(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};const v={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},m={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class _{constructor(e,t={},s,r){this.url=e,this.headers=t,this.bucketId=s,this.fetch=a(r)}uploadOrUpdate(e,t,s,r){return y(this,void 0,void 0,(function*(){try{let i;const n=Object.assign(Object.assign({},m),r),o=Object.assign(Object.assign({},this.headers),"POST"===e&&{"x-upsert":String(n.upsert)});"undefined"!=typeof Blob&&s instanceof Blob?(i=new FormData,i.append("cacheControl",n.cacheControl),i.append("",s)):"undefined"!=typeof FormData&&s instanceof FormData?(i=s,i.append("cacheControl",n.cacheControl)):(i=s,o["cache-control"]=`max-age=${n.cacheControl}`,o["content-type"]=n.contentType);const a=this._removeEmptyFolders(t),c=this._getFinalPath(a),l=yield this.fetch(`${this.url}/object/${c}`,Object.assign({method:e,body:i,headers:o},(null==n?void 0:n.duplex)?{duplex:n.duplex}:{}));return l.ok?{data:{path:a},error:null}:{data:null,error:yield l.json()}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}upload(e,t,s){return y(this,void 0,void 0,(function*(){return this.uploadOrUpdate("POST",e,t,s)}))}uploadToSignedUrl(e,t,s,r){return y(this,void 0,void 0,(function*(){const n=this._removeEmptyFolders(e),o=this._getFinalPath(n),a=new URL(this.url+`/object/upload/sign/${o}`);a.searchParams.set("token",t);try{let e;const t=Object.assign({upsert:m.upsert},r),i=Object.assign(Object.assign({},this.headers),{"x-upsert":String(t.upsert)});"undefined"!=typeof Blob&&s instanceof Blob?(e=new FormData,e.append("cacheControl",t.cacheControl),e.append("",s)):"undefined"!=typeof FormData&&s instanceof FormData?(e=s,e.append("cacheControl",t.cacheControl)):(e=s,i["cache-control"]=`max-age=${t.cacheControl}`,i["content-type"]=t.contentType);const o=yield this.fetch(a.toString(),{method:"PUT",body:e,headers:i});return o.ok?{data:{path:n},error:null}:{data:null,error:yield o.json()}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}createSignedUploadUrl(e){return y(this,void 0,void 0,(function*(){try{let t=this._getFinalPath(e);const s=yield p(this.fetch,`${this.url}/object/upload/sign/${t}`,{},{headers:this.headers}),i=new URL(this.url+s.url),n=i.searchParams.get("token");if(!n)throw new r("No token returned by API");return{data:{signedUrl:i.toString(),path:e,token:n},error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}update(e,t,s){return y(this,void 0,void 0,(function*(){return this.uploadOrUpdate("PUT",e,t,s)}))}move(e,t){return y(this,void 0,void 0,(function*(){try{return{data:yield p(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t},{headers:this.headers}),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}copy(e,t){return y(this,void 0,void 0,(function*(){try{return{data:{path:(yield p(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t},{headers:this.headers})).Key},error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}createSignedUrl(e,t,s){return y(this,void 0,void 0,(function*(){try{let r=this._getFinalPath(e),i=yield p(this.fetch,`${this.url}/object/sign/${r}`,Object.assign({expiresIn:t},(null==s?void 0:s.transform)?{transform:s.transform}:{}),{headers:this.headers});const n=(null==s?void 0:s.download)?`&download=${!0===s.download?"":s.download}`:"";return i={signedUrl:encodeURI(`${this.url}${i.signedURL}${n}`)},{data:i,error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}createSignedUrls(e,t,s){return y(this,void 0,void 0,(function*(){try{const r=yield p(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),i=(null==s?void 0:s.download)?`&download=${!0===s.download?"":s.download}`:"";return{data:r.map((e=>Object.assign(Object.assign({},e),{signedUrl:e.signedURL?encodeURI(`${this.url}${e.signedURL}${i}`):null}))),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}download(e,t){return y(this,void 0,void 0,(function*(){const s=void 0!==(null==t?void 0:t.transform)?"render/image/authenticated":"object",r=this.transformOptsToQueryString((null==t?void 0:t.transform)||{}),n=r?`?${r}`:"";try{const t=this._getFinalPath(e),r=yield f(this.fetch,`${this.url}/${s}/${t}${n}`,{headers:this.headers,noResolveJson:!0});return{data:yield r.blob(),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}getPublicUrl(e,t){const s=this._getFinalPath(e),r=[],i=(null==t?void 0:t.download)?`download=${!0===t.download?"":t.download}`:"";""!==i&&r.push(i);const n=void 0!==(null==t?void 0:t.transform)?"render/image":"object",o=this.transformOptsToQueryString((null==t?void 0:t.transform)||{});""!==o&&r.push(o);let a=r.join("&");return""!==a&&(a=`?${a}`),{data:{publicUrl:encodeURI(`${this.url}/${n}/public/${s}${a}`)}}}remove(e){return y(this,void 0,void 0,(function*(){try{return{data:yield g(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}list(e,t,s){return y(this,void 0,void 0,(function*(){try{const r=Object.assign(Object.assign(Object.assign({},v),t),{prefix:e||""});return{data:yield p(this.fetch,`${this.url}/object/list/${this.bucketId}`,r,{headers:this.headers},s),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const b={"X-Client-Info":"storage-js/2.5.4"};var w=function(e,t,s,r){return new(s||(s=Promise))((function(i,n){function o(e){try{c(r.next(e))}catch(e){n(e)}}function a(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};class k{constructor(e,t={},s){this.url=e,this.headers=Object.assign(Object.assign({},b),t),this.fetch=a(s)}listBuckets(){return w(this,void 0,void 0,(function*(){try{return{data:yield f(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}getBucket(e){return w(this,void 0,void 0,(function*(){try{return{data:yield f(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}createBucket(e,t={public:!1}){return w(this,void 0,void 0,(function*(){try{return{data:yield p(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}updateBucket(e,t){return w(this,void 0,void 0,(function*(){try{const s=yield function(e,t,s,r,i){return c(this,void 0,void 0,(function*(){return d(e,"PUT",t,r,undefined,s)}))}(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers});return{data:s,error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}emptyBucket(e){return w(this,void 0,void 0,(function*(){try{return{data:yield p(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}deleteBucket(e){return w(this,void 0,void 0,(function*(){try{return{data:yield g(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(e){if(i(e))return{data:null,error:e};throw e}}))}}class S extends k{constructor(e,t={},s){super(e,t,s)}from(e){return new _(this.url,this.headers,e,this.fetch)}}},296:function(e,t,s){var r=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,n){function o(e){try{c(r.next(e))}catch(e){n(e)}}function a(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=s(982),n=s(189),o=s(73),a=s(752),c=s(678),l=s(716),h=s(610),u=s(283),d={headers:c.DEFAULT_HEADERS},f={schema:"public"},p={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},g={};t.default=class{constructor(e,t,s){var r,i,o,a,c,u,y,v;if(this.supabaseUrl=e,this.supabaseKey=t,this.from=e=>this.rest.from(e),this.schema=e=>this.rest.schema(e),this.rpc=(e,t={},s)=>this.rest.rpc(e,t,s),!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const m=(0,h.stripTrailingSlash)(e);this.realtimeUrl=`${m}/realtime/v1`.replace(/^http/i,"ws"),this.authUrl=`${m}/auth/v1`,this.storageUrl=`${m}/storage/v1`,this.functionsUrl=`${m}/functions/v1`;const _=`sb-${new URL(this.authUrl).hostname.split(".")[0]}-auth-token`,b={db:f,realtime:g,auth:Object.assign(Object.assign({},p),{storageKey:_}),global:d},w=(0,h.applySettingDefaults)(null!=s?s:{},b);this.storageKey=null!==(i=null===(r=w.auth)||void 0===r?void 0:r.storageKey)&&void 0!==i?i:"",this.headers=null!==(a=null===(o=w.global)||void 0===o?void 0:o.headers)&&void 0!==a?a:{},this.auth=this._initSupabaseAuthClient(null!==(c=w.auth)&&void 0!==c?c:{},this.headers,null===(u=w.global)||void 0===u?void 0:u.fetch),this.fetch=(0,l.fetchWithAuth)(t,this._getAccessToken.bind(this),null===(y=w.global)||void 0===y?void 0:y.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers},w.realtime)),this.rest=new n.PostgrestClient(`${m}/rest/v1`,{headers:this.headers,schema:null===(v=w.db)||void 0===v?void 0:v.schema,fetch:this.fetch}),this._listenForAuthEvents()}get functions(){return new i.FunctionsClient(this.functionsUrl,{headers:this.headers,customFetch:this.fetch})}get storage(){return new a.StorageClient(this.storageUrl,this.headers,this.fetch)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return r(this,void 0,void 0,(function*(){const{data:s}=yield this.auth.getSession();return null!==(t=null===(e=s.session)||void 0===e?void 0:e.access_token)&&void 0!==t?t:null}))}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:r,storageKey:i,flowType:n,debug:o},a,c){const l={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new u.SupabaseAuthClient({url:this.authUrl,headers:Object.assign(Object.assign({},l),a),storageKey:i,autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:r,flowType:n,debug:o,fetch:c})}_initRealtimeClient(e){return new o.RealtimeClient(this.realtimeUrl,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},null==e?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange(((e,t)=>{this._handleTokenChanged(e,"CLIENT",null==t?void 0:t.access_token)}))}_handleTokenChanged(e,t,s){"TOKEN_REFRESHED"!==e&&"SIGNED_IN"!==e||this.changedAccessToken===s?"SIGNED_OUT"===e&&(this.realtime.setAuth(this.supabaseKey),"STORAGE"==t&&this.auth.signOut(),this.changedAccessToken=void 0):(this.realtime.setAuth(null!=s?s:null),this.changedAccessToken=s)}}},341:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||r(t,e,s)},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createClient=t.SupabaseClient=t.FunctionsError=t.FunctionsRelayError=t.FunctionsFetchError=t.FunctionsHttpError=void 0;const o=n(s(296));i(s(765),t);var a=s(982);Object.defineProperty(t,"FunctionsHttpError",{enumerable:!0,get:function(){return a.FunctionsHttpError}}),Object.defineProperty(t,"FunctionsFetchError",{enumerable:!0,get:function(){return a.FunctionsFetchError}}),Object.defineProperty(t,"FunctionsRelayError",{enumerable:!0,get:function(){return a.FunctionsRelayError}}),Object.defineProperty(t,"FunctionsError",{enumerable:!0,get:function(){return a.FunctionsError}}),i(s(73),t);var c=s(296);Object.defineProperty(t,"SupabaseClient",{enumerable:!0,get:function(){return n(c).default}}),t.createClient=(e,t,s)=>new o.default(e,t,s)},283:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SupabaseAuthClient=void 0;const r=s(765);class i extends r.GoTrueClient{constructor(e){super(e)}}t.SupabaseAuthClient=i},678:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_HEADERS=void 0;const r=s(506);let i="";i="undefined"!=typeof Deno?"deno":"undefined"!=typeof document?"web":"undefined"!=typeof navigator&&"ReactNative"===navigator.product?"react-native":"node",t.DEFAULT_HEADERS={"X-Client-Info":`supabase-js-${i}/${r.version}`}},716:function(e,t,s){var r=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&r(t,e,s);return i(t,e),t},o=this&&this.__awaiter||function(e,t,s,r){return new(s||(s=Promise))((function(i,n){function o(e){try{c(r.next(e))}catch(e){n(e)}}function a(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.fetchWithAuth=t.resolveHeadersConstructor=t.resolveFetch=void 0;const a=n(s(743));t.resolveFetch=e=>{let t;return t=e||("undefined"==typeof fetch?a.default:fetch),(...e)=>t(...e)},t.resolveHeadersConstructor=()=>"undefined"==typeof Headers?a.Headers:Headers,t.fetchWithAuth=(e,s,r)=>{const i=(0,t.resolveFetch)(r),n=(0,t.resolveHeadersConstructor)();return(t,r)=>o(void 0,void 0,void 0,(function*(){var o;const a=null!==(o=yield s())&&void 0!==o?o:e;let c=new n(null==r?void 0:r.headers);return c.has("apikey")||c.set("apikey",e),c.has("Authorization")||c.set("Authorization",`Bearer ${a}`),i(t,Object.assign(Object.assign({},r),{headers:c}))}))}},610:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.applySettingDefaults=t.isBrowser=t.stripTrailingSlash=t.uuid=void 0,t.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},t.stripTrailingSlash=function(e){return e.replace(/\/$/,"")},t.isBrowser=()=>"undefined"!=typeof window,t.applySettingDefaults=function(e,t){const{db:s,auth:r,realtime:i,global:n}=e,{db:o,auth:a,realtime:c,global:l}=t;return{db:Object.assign(Object.assign({},o),s),auth:Object.assign(Object.assign({},a),r),realtime:Object.assign(Object.assign({},c),i),global:Object.assign(Object.assign({},l),n)}}},506:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.version=void 0,t.version="2.39.3"}},n={};function o(e){var t=n[e];if(void 0!==t)return t.exports;var s=n[e]={exports:{}};return i[e].call(s.exports,s,s.exports,o),s.exports}return o.m=i,o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,o.t=function(s,r){if(1&r&&(s=this(s)),8&r)return s;if("object"==typeof s&&s){if(4&r&&s.__esModule)return s;if(16&r&&"function"==typeof s.then)return s}var i=Object.create(null);o.r(i);var n={};e=e||[null,t({}),t([]),t(t)];for(var a=2&r&&s;"object"==typeof a&&!~e.indexOf(a);a=t(a))Object.getOwnPropertyNames(a).forEach((e=>n[e]=()=>s[e]));return n.default=()=>s,o.d(i,n),i},o.d=(e,t)=>{for(var s in t)o.o(t,s)&&!o.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce(((t,s)=>(o.f[s](e,t),t)),[])),o.u=e=>e+".supabase.js",o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s={},r="supabase:",o.l=(e,t,i,n)=>{if(s[e])s[e].push(t);else{var a,c;if(void 0!==i)for(var l=document.getElementsByTagName("script"),h=0;h<l.length;h++){var u=l[h];if(u.getAttribute("src")==e||u.getAttribute("data-webpack")==r+i){a=u;break}}a||(c=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,o.nc&&a.setAttribute("nonce",o.nc),a.setAttribute("data-webpack",r+i),a.src=e),s[e]=[t];var d=(t,r)=>{a.onerror=a.onload=null,clearTimeout(f);var i=s[e];if(delete s[e],a.parentNode&&a.parentNode.removeChild(a),i&&i.forEach((e=>e(r))),t)return t(r)},f=setTimeout(d.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=d.bind(null,a.onerror),a.onload=d.bind(null,a.onload),c&&document.head.appendChild(a)}},o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var t=o.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var s=t.getElementsByTagName("script");if(s.length)for(var r=s.length-1;r>-1&&!e;)e=s[r--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e})(),(()=>{var e={179:0};o.f.j=(t,s)=>{var r=o.o(e,t)?e[t]:void 0;if(0!==r)if(r)s.push(r[2]);else{var i=new Promise(((s,i)=>r=e[t]=[s,i]));s.push(r[2]=i);var n=o.p+o.u(t),a=new Error;o.l(n,(s=>{if(o.o(e,t)&&(0!==(r=e[t])&&(e[t]=void 0),r)){var i=s&&("load"===s.type?"missing":s.type),n=s&&s.target&&s.target.src;a.message="Loading chunk "+t+" failed.\n("+i+": "+n+")",a.name="ChunkLoadError",a.type=i,a.request=n,r[1](a)}}),"chunk-"+t,t)}};var t=(t,s)=>{var r,i,[n,a,c]=s,l=0;if(n.some((t=>0!==e[t]))){for(r in a)o.o(a,r)&&(o.m[r]=a[r]);c&&c(o)}for(t&&t(s);l<n.length;l++)i=n[l],o.o(e,i)&&e[i]&&e[i][0](),e[i]=0},s=self.webpackChunksupabase=self.webpackChunksupabase||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})(),o(341)})()));
    console.log("[Supabase SDK] 内嵌加载成功"); window.supabaseSDKLoaded = true;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary: #1a73e8;
            --secondary: #0d47a1;
            --accent: #00c853;
            --dark: #0a1929;
            --light: #f5f9ff;
            --gray: #e0e0e0;
            --card-bg: rgba(255, 255, 255, 0.85);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        body {
            background: #ffffff;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        /* 星空背景样式 - 只在登录页面显示 */
        #nebula {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at center, #1B2735 0%, #090A0F 100%);
        }
        
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        /* 确保主页面有白色背景 */
        #main-container {
            background: #ffffff;
        }
        
        /* 添加头部标题样式 */
        .header-title {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        
        .header-logo {
            height: 35px; /* 调整图片大小与文字一致 */
            vertical-align: middle;
             margin-top: 40px; /* 添加与文字相同的上边距 */
        }
        
       .header-text {
    color: white;
    font-size: 35px; /* 增大字体 */
    font-weight: bold; /* 这里修改字体粗细 */
    font-family: "SimSun", serif; /* 宋体 */
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    margin: 0;
    vertical-align: middle;
    letter-spacing: 2px; /* 添加字符间距 */
    margin-top: 40px;   /* 或者: margin-bottom: 10px; 会使文字向上移动 */
}
        
        /* 修改底部版权信息样式 */
        .footer-copyright {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 15px 0;
            color: white;
            font-size: 14px;
            z-index: 1001;
            background: transparent; /* 移除背景 */
        }
        
        /* 智能小模型思考动画 */
        @keyframes thinkingDots {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        #thinking-dots {
            animation: thinkingDots 1s ease-in-out infinite;
        }
        
        /* 智能小模型输入框placeholder样式 */
        #ai-query-input::placeholder {
            color: #999;
            opacity: 1;
        }
        
        #ai-query-input::-webkit-input-placeholder {
            color: #999;
        }
        
        #ai-query-input::-moz-placeholder {
            color: #999;
            opacity: 1;
        }
        
        #ai-query-input:-ms-input-placeholder {
            color: #999;
        }
        
        /* 调整登录容器的z-index以确保它在标题上方 */
        #login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            z-index: 1000;
        }
        
        .login-container {
            width: 100%;
            max-width: 330px;  /* 调整登录窗体宽度 */
            background: transparent;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
            margin-right: 160px; /* 调整这个值来控制向左移动的距离 */
            margin-bottom:180px;  /* 这里控制垂直位置 */
        }
        
        .form-container {
            padding: 8px;
            transition: transform 0.6s ease-in-out;
        }
        
        #login-container .logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        #login-container .logo i {
            font-size: 42px;
            color: #764ba2;
            margin-bottom: 10px;
        }
        
        #login-container .logo h2 {
            color: white;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 7px;
            position: relative;
        }
        
        .form-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #764ba2;
            z-index: 2;
            font-size: 16px;
            width: 20px;
            text-align: center;
            display: block;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px 12px 45px; /* 保持左侧内边距 */
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
            outline: none;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd5;
        }
        
        .links {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .links a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
            cursor: pointer;
        }
        
        .links a:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        .divider {
            text-align: center;
            margin: 25px 0;
            position: relative;
        }
        
        .divider:before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
            background: #ddd;
        }
        
        .divider span {
            background: rgba(255, 255, 255, 0.9);
            padding: 0 15px;
            color: #777;
            position: relative;
        }
        
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 7px;
            text-align: center;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: white; /* 将字体颜色设置为白色 */
            border: 1px solid #bee5eb;
        }
        
        #registerForm, #resetForm {
            display: none;
        }
        
        .back-to-login {
            text-align: center;
            margin-top: 20px;
            color: white;
        }
        
        .back-to-login a {
            color: white !important;
            text-decoration: none;
        }
        
        .back-to-login a:hover {
            color: white !important;
            text-decoration: underline;
        }
        
        .info-text {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin-top: 15px;
        }
        
        @media (max-width: 480px) {
            .login-container {
                border-radius: 12px;
            }
            
            .form-container {
                padding: 20px;
            }
        }
        
        /* 主页面布局 */
        #main-container {
            display: none;
            min-height: 100vh;
            flex: 1;
            flex-direction: column;
            padding-top: 70px; /* 添加这行，为固定的header腾出空间 */
        }
        
        /* 移动端菜单按钮 */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            margin-right: 15px;
        }
        
        header {
            position: fixed; /* 修改为fixed */
            top: 0; 
            left: 0;
            width: 100%; /* 确保宽度为100% */
            z-index: 1000;
            background: linear-gradient(90deg, var(--dark), var(--secondary));
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            height: 70px;
            box-sizing: border-box;
        }
        
        header .logo {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logo img {
            height: 40px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .time-display {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            background: var(--glass-bg);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        /* 用户信息区域 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--glass-bg);
            padding: 5px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .username {
            font-size: 14px;
            font-weight: 500;
        }
        
        .layout {
            display: flex;
            flex: 1;
            min-height: calc(100vh - 70px);
            margin-left: 250px; /* 添加这行，为固定的sidebar腾出空间 */
        }
        
        /* 左侧菜单 */
        .sidebar {
            position: fixed; /* 修改为fixed */
            top: 70px; /* 与header高度一致 */
            left: 0;
            height: calc(100vh - 70px); /* 减去header高度 */
            background: linear-gradient(180deg, var(--dark), #0c1e32);
            padding: 25px 0;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto; /* 确保菜单内容可滚动 */
            width: 250px;
            z-index: 999; /* 确保在内容之上，但在header之下 */
        }
        
        .menu-item {
            padding: 15px 30px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            font-size: 16px;
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .menu-item.active {
            background: rgba(26, 115, 232, 0.2);
            color: white;
            border-left: 4px solid var(--primary);
        }
        
        .menu-item i {
            width: 24px;
            text-align: center;
        }
        
        /* 子菜单样式 */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .submenu.expanded {
            max-height: 500px;
        }
        
        .submenu-item {
            padding: 12px 20px 12px 60px;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 14px;
            text-decoration: none; /* 添加这行移除下划线 */
        }
        
        .submenu-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            text-decoration: none; /* 添加这行确保hover时也没有下划线 */
        }
        
        .submenu-item i {
            font-size: 12px;
        }
        
        .submenu .submenu {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .submenu .submenu .submenu-item {
            padding-left: 80px;
        }
        .menu-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s;
        }
        
        .menu-item.expanded .menu-toggle {
            transform: translateY(-50%) rotate(90deg);
        }
        
        /* 主内容区 */
        .main-content {
            flex: 1;
            padding: 20px;
            background: transparent;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 22px;
            margin-top: 7px;
            margin-bottom: 5px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }
        
        /* 第一个section-title不需要上边距 */
        .main-content > .section-title:first-child {
            margin-top: 0;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        /* 数据查询区域 - 修改部分 */
        .query-section {
            background: transparent;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 7px;
            box-shadow: none;
            border: none;
            width: 100%;
            height: auto;
        }
        
        .query-form {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            align-items: center;
        }

        #data-query-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .form-group {
    width: 100%; /* 确保宽度100% */
    margin-bottom: 20px;
    position: relative;
}
        .form-group label {
            font-weight: 500;
            color: #555;
            font-size: 14px; /* 减小字体 */
        }
        
        #data-query-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        #data-query-container .form-group {
            flex: 0 0 22%; /* 固定宽度约为原来的1/3 */
            margin: 0;
        }

        #data-query-container .form-group input,
        #data-query-container .form-group select {
            width: 100%;
            padding: 8px 10px;
            height: 36px;
            box-sizing: border-box;
        }

        #data-query-container .btn-group {
            flex: 0 0 auto;
            display: flex;
            gap: 8px;
            align-items: center;
            height: 36px;
        }

        .form-group input, .form-group select {
            padding: 8px 10px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.3s;
            height: 36px;
            width: 100%;
        }
        
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            outline: none;
        }
        
        #data-query-container .btn-group {
            display: flex;
            gap: 8px;
            margin-left: 0;
            padding-bottom: 0;
        }
        
        .query-btn, .export-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px; /* 减小内边距 */
            border-radius: 8px;
            font-size: 14px; /* 减小字体 */
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px; /* 减小间距 */
            height: 36px; /* 固定高度 */
            white-space: nowrap; /* 防止文本换行 */
        }
        
        .export-btn {
            background: var(--success);
        }
        
        .query-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }
        
        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .query-btn:disabled, .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .query-btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .query-btn.loading .spinner {
            display: inline-block;
        }
        
        .query-btn.loading span {
            vertical-align: middle;
        }
        
        .query-info {
            margin-top: 10px; /* 减小上边距 */
            color: #666;
            font-size: 13px; /* 减小字体 */
            padding: 6px; /* 减小内边距 */
            border-radius: 8px;
            background-color: transparent;
            border-left: none;
        }
        
        .query-info.error {
            background-color: transparent;
            border-left-color: none;
            color: var(--danger);
        }
        
        .query-info.error i {
            color: var(--danger);
        }
        
        .query-info.success {
            background-color: transparent;
            border-left-color: none;
            color: var(--success);
        }
        
        .query-info.success i {
            color: var(--success);
        }
        
        /* Excel 表格区域 */
        .excel-section {
            background: transparent;
            border-radius: 12px;
            padding: 8px;
            box-shadow: none;
            border: none;
            margin-bottom: 7px;
        }
        
        .excel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 7px;
        }
        
        .table-container {
            /* 报表在桌面和移动端均支持双向滚动 */
            overflow-x: auto; /* 只允许横向滚动 */
            overflow-y: hidden; /* 禁止纵向滚动以移除右侧滚动条 */
            max-height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px; /* 确保表格不会过窄 */
            /* 移除固定布局，让列宽自适应 */
            table-layout: auto; 
        }
        
        .table-container th {
            background-color: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            padding: 12px 15px;
        }
        
        .table-container th, .table-container td {
            padding: 6px 10px; /* 减小行距 */
            text-align: center;
            border: 1px solid #ddd;
            /* 移除最小宽度限制 */
            min-width: 0;
            /* 确保内容完整显示 */
            white-space: normal;
            word-break: break-word;
            line-height: 1.2; /* 减小行高 */
            vertical-align: middle;
            /* 添加最大宽度限制防止内容过长 */
            max-width: 300px;
        }
        
        /* 确保数字列也居中对齐 */
        .table-container .num-cell,
        .table-container .num-col {
            text-align: center !important;
        }
        
        /* 综合数据报表数字列居中对齐 */
        #comprehensive-table-container .num-cell,
        #comprehensive-table-container .num-col {
            text-align: center !important;
        }
        
        /* 综合数据报表表格样式 */
        #comprehensive-table-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: auto;
            max-height: 600px;
            position: relative;
        }
        
        #comprehensive-table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
            table-layout: auto;
        }
        
        #comprehensive-table-container th, #comprehensive-table-container td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
            min-width: 0;
            white-space: normal;
            word-break: break-word;
            line-height: 1.5;
            vertical-align: middle;
            max-width: 300px;
        }
        
        #comprehensive-table-container th {
            background-color: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        
        /* 单位信息左对齐 */
        .unit-info-cell {
            text-align: left !important;
        }
        
        /* 充电数据看板表格数字列居中对齐 */
        #charging-board-table-container .num-cell,
        #charging-board-table-container .num-col {
            text-align: center !important;
        }
        
        /* 充电数据看板表格容器样式 */
        #charging-board-table-container {
            overflow-x: auto; /* 允许横向滚动 */
            overflow-y: hidden; /* 禁止纵向滚动以移除右侧滚动条 */
            max-height: 600px;
        }
        
        /* 实时数据表格数字列居中对齐 */
        #realtime-table .num-cell,
        #realtime-table .num-col {
            text-align: center !important;
        }
        
        /* 站点数据统计板块样式 */
        .site-stats-section {
            margin-bottom: 7px;
            background: transparent;
            border-radius: 12px;
            box-shadow: none;
            border: none;
            padding: 8px;
        }
        
        .site-stats-container {
            width: 100%;
        }
        
        .stats-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: transparent;
            border-radius: 8px;
        }
        
        .data-mode-buttons {
            display: flex;
            gap: 10px;
        }
        
        .mode-btn {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            background: #fff;
            color: #6c757d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .mode-btn:hover {
            border-color: #007bff;
            color: #007bff;
        }
        
        .mode-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: #fff;
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .page-btn {
            width: 35px;
            height: 35px;
            border: 2px solid #e9ecef;
            background: #fff;
            color: #6c757d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .page-btn:hover:not(:disabled) {
            border-color: #007bff;
            color: #007bff;
        }
        
        .page-btn:disabled {
            background: #f8f9fa;
            border-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
        }
        
        .page-info {
            font-weight: 600;
            color: #495057;
            min-width: 80px;
            text-align: center;
        }
        
        .stats-data-container {
            display: flex;
            flex-direction: column;
            gap: 0px;
        }
        
        .site-data-section {
            background: transparent;
            border-radius: 0;
            padding: 8px;
            border: none;
            margin-bottom: 0;
        }
        
        .site-name-header {
            font-size: 18px;
            font-weight: 700;
            color: #495057;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px solid #007bff;
            text-align: center;
        }
        
        .data-item {
            margin-bottom: 4px;
            padding: 5px;
            background: transparent;
            border-radius: 0;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .site-name {
            font-size: 14px;
            color: #007bff;
            font-weight: 700;
            min-width: 80px;
            flex-shrink: 0;
            text-align: center;
            background: transparent;
            padding: 2px 6px;
            border-radius: 4px;
            border: none;
        }
        
        .site-name-spacer {
            min-width: 80px;
            flex-shrink: 0;
        }
        .data-label {
            font-size: 14px;
            color: #495057;
            font-weight: 600;
            min-width: 120px;
            flex-shrink: 0;
        }
        .data-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .progress-bar {
            flex: 1;
            height: 12px;
            background: #e9ecef;
            border-radius: 0px;  /* 改为方形：从6px改为0px */
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: #4b6bc4;  /* 改为纯绿色：删除渐变效果 */
            border-radius: 0px;  /* 改为方形：从6px改为0px */
            transition: width 0.8s ease;
            position: relative;
        }
        
        /* 移除渐变效果 */
        .progress-fill::after {
            display: none;
        }
        
        /* 删除shimmer动画，因为不再需要渐变效果 */
        
        .progress-value {
            min-width: 60px;
            text-align: right;
            font-weight: bold;
            color: #495057;
            font-size: 12px;
        }
        
        /* 百分比颜色样式 */
        .percentage-increase {
            color: #28a745;
            font-weight: bold;
        }
        
        .percentage-decrease {
            color: #dc3545;
            font-weight: bold;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .stats-controls {
                flex-direction: column;
                gap: 5px;
            }
            
            .stats-data-container {
                flex-direction: column;
            }
            
            .site-data-section {
                width: 100%;
            }
            
            .data-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .progress-bar {
                width: 100%;
            }
        }
        
        /* 未充电时长统计表格数字列居中对齐 */
        #uncharged-table .num-cell,
        #uncharged-table .num-col {
            text-align: center !important;
        }
        
        .table-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .table-container tr:hover {
            background-color: #f1f7ff;
        }
        
        .table-container td:first-child {
            font-weight: bold;
            background-color: #f0f5ff;
        }
        
        .data-info {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        /* 综合数据报表样式 */
        .comprehensive-section {
            background: transparent;
            border-radius: 12px;
            padding: 8px;
            box-shadow: none;
            border: none;
            margin-bottom: 7px;
        }
        
        .comprehensive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 7px;
        }
        
        /* 页脚 */
        footer {
            background: linear-gradient(90deg, var(--dark), var(--secondary));
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 14px;
            margin-top: auto;
            width: 100%;
        }
        
        /* ==================== 常用样式类（替代内联样式）==================== */
        
        /* 表格样式 */
        .table-cell {
            padding: 12px;
            border: 1px solid #dee2e6;
        }
        
        .table-cell-left {
            padding: 12px;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        
        .table-cell-right {
            padding: 12px;
            border: 1px solid #dee2e6;
            text-align: right;
        }
        
        .table-header {
            padding: 12px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .table-header-left {
            padding: 12px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
        }
        
        .table-header-right {
            padding: 12px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
            font-weight: 600;
            text-align: right;
        }
        
        .table-row-even {
            background: #fff;
        }
        
        .table-row-odd {
            background: #f8f9fa;
        }
        
        /* 按钮样式 */
        .btn-primary {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-primary:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: #28a745;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-info {
            background: #17a2b8;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        /* 容器样式 */
        .container-flex {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        
        .container-bg {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
        }
        
        .container-bg-lg {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }
        
        /* 文本样式 */
        .text-muted {
            color: #6c757d;
        }
        
        .text-primary {
            color: #495057;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-left {
            text-align: left;
        }
        
        /* 间距样式 */
        .mb-12 {
            margin-bottom: 12px;
        }
        
        .mb-16 {
            margin-bottom: 16px;
        }
        
        .mt-16 {
            margin-top: 16px;
        }
        
        .p-10 {
            padding: 10px;
        }
        
        .p-12 {
            padding: 12px;
        }
        
        .p-20 {
            padding: 20px;
        }
        
        /* 输入框样式 */
        .input-field {
            width: 220px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .input-field-datetime {
            width: 220px;
            padding: 8px 30px 8px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        /* 选择框样式 */
        .select-field {
            width: 220px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        /* 加载提示 */
        .loading-spinner {
            padding: 20px;
            text-align: center;
            color: #666;
        }
        
        .loading-spinner i {
            font-size: 32px;
            color: #007bff;
        }
        
        /* 错误提示 */
        .error-message {
            color: #c00;
            padding: 12px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
        }
        
        /* 成功提示 */
        .success-message {
            color: #155724;
            padding: 12px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
        }
        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .income-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 900px) {
            .layout {
                margin-left: 0;
                flex-direction: column;
            }
            
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                top: 0;
                order: 2;
                display: none; /* 默认隐藏 */
            }
            
            .sidebar.mobile-open {
                display: block;
            }
            
            /* 移动端空白页调整 */
            #page-cd-data, #page-zh-data, #page-bill-data, #page-user-data, #page-other-data, #page-report-charging, #page-report-comprehensive, #page-report-user, #page-report-efficiency, #page-report-bi, #page-ai-model {
                left: 0 !important;
                top: 60px !important;
            }
            
            .main-content {
                order: 1;
                width: 100%;
            }
            
            #main-container {
                padding-top: 60px;
            }
            
            header {
                height: 60px;
                padding: 10px 15px;
                position: relative;
            }
            
            .logo h1 {
                font-size: 18px;
            }
            
            .mobile-menu-toggle {
                display: block;
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 5px;
            }
            
            .query-form {
                flex-direction: column;
                gap: 5px;
            }
            
            #data-query-container {
                flex-direction: column;
                gap: 5px;
            }
            
            #data-query-container .form-group {
                flex: 1;
                width: 100%;
            }
            
            #data-query-container .btn-group {
                flex: none;
                width: 100%;
                justify-content: center;
            }
            
            .form-group {
                width: 100% !important;
                min-width: unset !important;
            }
            
            .btn-group {
                width: 100% !important;
                justify-content: center !important;
                flex-wrap: wrap;
            }
            
            .query-btn, .export-btn {
                min-width: 120px;
                flex: 1;
            }
        }
        
        @media (max-width: 768px) {
            .metric-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .income-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .metric-card {
                min-width: unset;
                width: 100%;
            }
            
            .user-info .username {
                display: none;
            }
            
            .time-display {
                font-size: 12px;
                padding: 5px 8px;
            }
            
            .logo h1 {
                font-size: 16px;
            }
            
            .chart-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .chart-title > div {
                display: flex;
                gap: 10px;
                align-items: center;
                width: 100%;
                justify-content: flex-start;
            }
            
            .table-container {
                font-size: 12px;
            }
            
            .table-container th, .table-container td {
                padding: 8px 5px;
                min-width: 80px;
            }
            
            .metric-value {
                font-size: 18px;
            }
            
            .metric-label {
                font-size: 12px;
            }
        }
        @media (max-width: 480px) {
            .login-container {
                width: 95%;
                margin: 10px;
            }
            
            .form-container {
                padding: 20px 15px;
            }
            
            header {
                padding: 8px 10px;
                height: 50px;
            }
            
            #main-container {
                padding-top: 50px;
            }
            
            .main-content {
                padding: 10px;
            }
            
            .query-section {
                padding: 10px;
            }
            
            .metric-card {
                padding: 15px;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .logo h1 {
                font-size: 14px;
            }
            
            .time-display {
                font-size: 10px;
                padding: 4px 6px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .metric-value {
                font-size: 16px;
            }
            
            .metric-label {
                font-size: 11px;
            }
            
            .query-btn, .export-btn {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .table-container th, .table-container td {
                padding: 6px 4px;
                font-size: 11px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
        /* 移动端日期选择器优化 */
        @media (max-width: 768px) {
            .custom-picker {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 300px;
                z-index: 2000;
            }
            
            .date-picker-container {
                position: relative;
            }
            
            .table-container {
                border-radius: 4px;
            }
            
            .realtime-table-container {
                height: 300px;
            }
            
            .uncharged-table-container {
                max-height: 300px;
            }
            
            /* 表格左右滚动提示 */
            .table-container::before {
                content: "← 左右滚动查看更多";
                position: absolute;
                top: 5px;
                right: 10px;
                font-size: 10px;
                color: #999;
                z-index: 5;
                background: rgba(255, 255, 255, 0.9);
                padding: 2px 5px;
                border-radius: 3px;
            }
        }

        /* 登录表单图标显示样式 */
#login-container .form-group i {
    display: block;
}
#login-container .form-control {
    padding: 12px 15px 12px 45px !important; /* 保持左侧内边距 */
}

/* 其他表单隐藏图标样式 */
.main-content .form-group i {
    display: none;
}
.main-content .form-control {
    padding: 12px 15px !important; /* 移除左侧内边距 */
}

/* 短信验证码登录样式 */
#smsLoginForm {
    display: none;
}

#smsLoginForm .form-group {
    position: relative;
}

#smsLoginForm .form-group:has(#smsCode) {
    display: flex;
    gap: 10px;
    align-items: center;
}

#smsLoginForm #smsCode {
    flex: 1;
    padding: 12px 15px 12px 45px !important;
}

.btn-sms {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    white-space: nowrap;
    min-width: 100px;
}

.btn-sms:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.btn-sms:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-sms.countdown {
    background: #999;
    cursor: not-allowed;
}

/* 手机号输入框样式 */
#smsPhone {
    padding: 12px 15px 12px 45px !important;
}

/* 验证码输入框样式 */
#smsCode {
    padding: 12px 15px 12px 45px !important;
}
        /* 图表加载指示器 */
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }
        
        .chart-loading i {
            font-size: 36px;
            margin-bottom: 10px;
            color: var(--primary);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.5; transform: scale(0.9); }
        }
        
        /* 数据加载指示器 */
        .data-loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--primary);
            font-size: 16px;
        }
        
        .data-loading i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        .data-type-select {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* 日期选择器改进 */
        .form-group input[type="month"] {
            cursor: pointer;
            position: relative;
        }
        
        .form-group input[type="month"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
        }
        
        /* 自定义日期选择器容器 */
        .custom-date-picker {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .year-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .year-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px; /* 提升可见度 */
            padding: 0 8px;
            color: #555;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
        }
        
        .year-btn:hover {
            color: var(--primary);
        }
        
        .year-display {
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .month-btn {
            padding: 8px 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .month-btn:hover {
            background: #f0f5ff;
            border-color: var(--primary);
        }
        
        .month-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* 日期选择器容器 */
        .date-picker-container {
            position: relative;
        }
        
        .custom-picker {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            min-width: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }
        
        /* 功能提示弹窗 */
        .feature-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            text-align: center;
            max-width: 90%;
            width: 400px;
            display: none;
        }
        
        .feature-popup h3 {
            margin-bottom: 7px;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .feature-popup .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: #777;
            background: none;
            border: none;
        }
        
        .feature-popup .popup-content {
            margin-bottom: 7px;
            font-size: 18px;
            color: #555;
        }
        
        .feature-popup .confirm-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .feature-popup .confirm-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }

        #metrics-container {
            padding: 20px;
            background: #f0f5ff;
        }

        .metrics-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .metrics-section {
            margin-bottom: 25px;
        }
        
        .metrics-section > .metrics-row {
            width: 100%;
            margin-bottom: 10px;
        }

/* 调整指标卡片宽度 */
.metrics-section > .metrics-row:nth-child(1) .metric-item {
    background: linear-gradient(135deg, rgba(26, 115, 232, 0.15), rgba(26, 115, 232, 0.05));
    border-left: 4px solid var(--primary);
}

.metrics-section > .metrics-row:nth-child(2) .metric-item {
    background: linear-gradient(135deg, rgba(0, 200, 83, 0.15), rgba(0, 200, 83, 0.05));
    border-left: 4px solid var(--accent);
}

.metrics-section > .metrics-row:nth-child(3) .metric-item {
    background: linear-gradient(135deg, rgba(156, 39, 176, 0.15), rgba(156, 39, 176, 0.05));
    border-left: 4px solid #9c27b0;
}

.metrics-section > .metrics-row:nth-child(4) .metric-item {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 193, 7, 0.05));
    border-left: 4px solid #ffc107;
}
/* 悬停效果增强 */
.metric-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

/* 调整指标值的颜色与卡片主题匹配 */
.metrics-section > .metrics-row:nth-child(1) .metric-value {
    color: var(--primary) !important;
}

.metrics-section > .metrics-row:nth-child(2) .metric-value {
    color: var(--accent) !important;
}

.metrics-section > .metrics-row:nth-child(3) .metric-value {
    color: #9c27b0 !important;
}

.metrics-section > .metrics-row:nth-child(4) .metric-value {
    color: #ff9800 !important;
}
        .metrics-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .metric-card {
            background: transparent;
            border-radius: 12px;
            padding: 12px;
            box-shadow: none;
            border: none;
            flex: 1;
            min-width: 300px;
        }

        .metric-card-title {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 5px;
            /* 移除了下面的横线 */
    /* border-bottom: 2px solid var(--primary); */
        }

        .metric-card-title i {
            color: var(--primary);
        }

       /* 修改网格布局为一行的四个项目 */
.metric-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 改为4列 */
    gap: 8px; /* 可以根据需要调整间距 */
}

/* 修改指标项背景为透明 */
.metric-item {
    padding: 8px;
    border-radius: 8px;
    background: transparent; /* 改为透明背景 */
    text-align: center;
    transition: all 0.3s;
}

        
        /* 综合收入数据显示在一行 */
        .income-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .metric-item {
            padding: 8px;
            border-radius: 8px;
            background: transparent;
            text-align: center;
            transition: all 0.3s;
        }

        .metric-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin: 5px 0;
            white-space: nowrap;
        }
/* 在这里添加您的自定义颜色代码 */
/* 本月充电数据数字颜色 */
#month-charge, #month-electricity, #month-service, #month-orders {
    color: #000000; /* 红色系 */
}

/* 本年度充电数据数字颜色 */
#year-charge, #year-electricity, #year-service, #year-orders {
    color: #0c0c0c; /* 青色系 */
}

/* 累计充电数据数字颜色 */
#total-charge, #total-electricity, #total-service, #total-orders {
    color: #0c0c0c; /* 蓝色系 */
}
/* 累计综合业务收入数字颜色 */
#month-income, #year-income, #total-income {
    color: #0c0c0c; /* 蓝色系 */
}
        .metric-label {
            font-size: 14px;
            color: #666;
        }

        .chart-container {
            background: transparent;
            border-radius: 12px;
            padding: 20px;
            box-shadow: none;
            border: none;
            margin-bottom: 7px;
        }

        .chart-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title i {
            color: var(--primary);
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        .chart-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .chart-action-btn {
            padding: 8px 15px;
            background: #f0f5ff;
            border: 1px solid var(--primary);
            border-radius: 6px;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        /* 综合收入看板特定样式 */
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 7px;
            gap: 5px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
        }

        .form-select {
            padding: 8px 12px;
            border: 1px solid var(--gray);
            border-radius: 6px;
            background: white;
            min-width: 100px;
        }

        .table-wrapper {
            margin-bottom: 7px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .chart-action-btn:hover {
            background: var(--primary);
            color: white;
        }

        #report-section {
            padding-top: 50px;
        }
        
        /* 数据加载动画 */
        .data-loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            color: var(--primary);
        }
        
        .data-loading-indicator i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

/* 实时数据表格样式 */
.realtime-table-container {
    height: 400px; /* 将max-height改为固定高度 */
    overflow: auto; /* 改为auto以便内容超出时可以滚动 */
    position: relative;
    border: 1px solid #ddd;
    border-radius: 8px;
}

#realtime-loading {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    padding: 20px;
    color: var(--primary);
    font-size: 16px;
    width: 100%;
    z-index: 5;
}

#realtime-loading i {
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

#realtime-table {
    width: 100%;
    border-collapse: collapse;
}

#realtime-table th {
    background-color: var(--primary);
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    padding: 12px 15px;
    text-align: center;
}

#realtime-table td {
    padding: 10px 15px;
    text-align: center;
    border-bottom: 1px solid #eee;
}

#realtime-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

#realtime-table tr.highlight {
    background-color:   #e0d0ff!important;
    transition: background-color 0.5s ease;
}

#realtime-table tr:hover {
    background-color: #f1f7ff;
    cursor: pointer;
}
 /* 未充电时长统计表格表头样式 */
        #uncharged-table th {
            background-color: #1a73e8 !important; /* 深蓝色背景 */
            color: #ffffff !important; /* 白色文字 */
            border: 1px solid #0d47a1 !important; /* 深蓝色边框 */
            font-weight: 600;
            padding: 12px 8px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* 表格行样式 */
        #uncharged-table tr:nth-child(even) {
            background-color: #f8fbff;
        }
        
        #uncharged-table tr:hover {
            background-color: #e8f0fe;
        }

        /* 桌面端：报表容器显示底部横向滚动条并禁止单元格换行 */
        @media (min-width: 901px) {
            #table-container,
            #comprehensive-table-container,
            .table-wrapper {
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }

            #table-container th, #table-container td,
            #comprehensive-table-container th, #comprehensive-table-container td {
                white-space: nowrap;
                word-break: keep-all;
                max-width: none;
            }

            /* 让表格在内容较多时能触发横向滚动 */
            #table-container table,
            #comprehensive-table-container table {
                table-layout: auto;
                min-width: 1000px;
            }
        }

        /* 整体情况概要 */
        .overview-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        
        .overview-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .overview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }
        
        .overview-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        .overview-value-large {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .overview-name-large {
            font-size: 16px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .overview-subtext {
            font-size: 14px;
            color: #888;
            line-height: 1.4;
        }

        /* 响应式调整 */
        @media (max-width: 1200px) {
            .overview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .overview-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 按钮禁用状态样式 */
        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        button:disabled:hover {
            background-color: #ccc !important;
            cursor: not-allowed !important;
        }

    </style>
</head>
<body>
    <!-- 星空背景 -->
    <div id="nebula"></div>
    <canvas id="starfield" width="1379" height="932"></canvas>
    
    <!-- 在body开始处添加头部标题区域 -->
    <div class="header-title" id="login-header-title">
        <img src="https://jiangnanwaw.github.io/my-page/photo/fhlogo.png" alt="Logo" class="header-logo">
        <h1 class="header-text">长沙飞狐数据管理平台</h1>
    </div>
    
    <!-- LeanCloud 登录系统 -->
    <div id="login-container">
        <div class="login-container">
            <div class="form-container">
                <div class="logo">
                    <i class="fas fa-user-lock"></i>
                    <h2 id="form-title">用户登录</h2>
                </div>
                
                <div id="loginMessage" class="message"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="loginUsername" class="form-control" placeholder="用户名" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="loginPassword" class="form-control" placeholder="密码" required>
                    </div>
                    
                    <button type="submit" class="btn">登录</button>
                    
                    <div class="links">
                        <a href="#" id="showReset">忘记密码?</a>
                        <a href="#" id="showRegister">注册新账号</a>
                        <a href="#" id="showSmsLogin">短信验证码登录</a>
                    </div>
                </form>
                
                <form id="registerForm">
                    <div class="form-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="registerUsername" class="form-control" placeholder="设置用户名" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="registerPassword" class="form-control" placeholder="设置密码" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="registerEmail" class="form-control" placeholder="电子邮箱" required>
                    </div>
                    

                    
                    <button type="submit" class="btn">注册</button>
                    
                                    
                                      
                    <div class="back-to-login">
                        <a href="#" id="backToLoginFromRegister">返回登录</a>
                    </div>
                </form>
                
                <form id="resetForm">
                    <div class="form-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="resetEmail" class="form-control" placeholder="输入注册邮箱" required>
                    </div>
                    
                    <button type="submit" class="btn">发送重置邮件</button>
                    
                    <div class="back-to-login">
                        <a href="#" id="backToLoginFromReset">返回登录</a>
                    </div>
                </form>
                
                <form id="smsLoginForm">
                    <div class="form-group">
                        <i class="fas fa-mobile-alt"></i>
                        <input type="tel" id="smsPhone" class="form-control" placeholder="请输入手机号码" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-key"></i>
                        <input type="text" id="smsCode" class="form-control" placeholder="请输入验证码" required>
                        <button type="button" id="sendSmsCode" class="btn-sms">发送验证码</button>
                    </div>
                    
                    <button type="submit" class="btn">验证码登录</button>
                    
                    <div class="back-to-login">
                        <a href="#" id="backToLoginFromSms">返回登录</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    
    <!-- 功能提示弹窗 -->
    <div class="feature-popup" id="feature-popup">
        <button class="close-btn" id="close-popup"><i class="fas fa-times"></i></button>
        <h3><i class="fas fa-exclamation-triangle"></i> 功能提示</h3>
        <div class="popup-content" id="popup-content">
            此功能暂未开放
        </div>
        <button class="confirm-btn" id="confirm-popup">确定</button>
    </div>

    <!-- 主页面容器 -->
    <div id="main-container">
        <header>
            <button class="mobile-menu-toggle" id="mobile-menu-toggle" style="display: none;">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <i class="fas fa-bolt"></i>
                <h1>长沙飞狐数据管理平台</h1>
            </div>
            <div class="user-info">
                <img src="https://jiangnanwaw.github.io/my-page/photo/fhlogo.png" alt="用户头像" class="user-avatar">
                <span class="username" id="user-display">admin</span>
            </div>
            <div class="time-display" id="time-display">
                2025年08月05日 星期二 10:30:45
            </div>
        </header>
        
        <div class="layout">
            <!-- 左侧菜单 -->
            <div class="sidebar">
                <div class="menu-item active" id="menu-home">
                    <i class="fas fa-home"></i>
                    <span>平台首页</span>
                </div>
                
                <!-- BI数据分析（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    <span>数据看板</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="https://www.csfhcdz.cn/bi/cdbi.html" target="_blank" class="submenu-item">
                        <i class="fas fa-bolt"></i>
                        <span>充电数据可视化</span>
                    </a>
                    <a href="https://www.csfhcdz.cn/bi/zhbi.html" target="_blank" class="submenu-item">
                        <i class="fas fa-chart-bar"></i>
                        <span>综合数据可视化</span>
                    </a>
                </div>
                
                <!-- 场站基本情况（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>场站情况</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <!-- 四方坪站（带子菜单） -->
                    <div class="menu-item">
                        <i class="fas fa-building"></i>
                        <span>四方坪站</span>
                        <i class="fas fa-chevron-right menu-toggle"></i>
                    </div>
                    <div class="submenu">
                        <!-- 监控（带子菜单） -->
                        <div class="menu-item">
                            <i class="fas fa-video"></i>
                            <span>监控</span>
                            <i class="fas fa-chevron-right menu-toggle"></i>
                        </div>
                        <div class="submenu">
                            <a href="http://csfhcdz.f3322.net:50000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>东区</span>
                            </a>
                            <a href="http://csfhcdz.f3322.net:7000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>南区</span>
                            </a>
                            <a href="http://csfhcdz.f3322.net:9000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>西区</span>
                            </a>
                        </div>
                        <a href="https://cloud.wlyk.com/" target="_blank" class="submenu-item">
                            <i class="fas fa-road"></i>
                            <span>道闸</span>
                        </a>
                    </div>
                    
                    <!-- 高岭站（带子菜单） -->
                    <div class="menu-item">
                        <i class="fas fa-building"></i>
                        <span>高岭站</span>
                        <i class="fas fa-chevron-right menu-toggle"></i>
                    </div>
                    <div class="submenu">
                        <a href="http://wawwt.eicp.net:1428" target="_blank" class="submenu-item">
                            <i class="fas fa-video"></i>
                            <span>监控</span>
                        </a>
                        <a href="https://psp.hikparking.com/#/login" target="_blank" class="submenu-item">
                            <i class="fas fa-road"></i>
                            <span>道闸</span>
                        </a>
                    </div>
                </div>
                
                <!-- 充电桩管理（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-car-battery"></i>
                    <span>电桩管理</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="https://cloud.teld.cn/web/login?locale=zh-CN" target="_blank" class="submenu-item">
                        <i class="fas fa-plug"></i>
                        <span>特来电</span>
                    </a>
                    <a href="https://auth.digipowercloud.huawei.com/dpcloud/index.html#/login" target="_blank" class="submenu-item">
                        <i class="fas fa-plug"></i>
                        <span>华为</span>
                    </a>
                </div>
                
                <!--  资料文件（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-building"></i>
                    <span>资料文件</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="http://csfhcdz.f3322.net:7515/" target="_blank" class="submenu-item">
                        <i class="fas fa-building"></i>
                        <span>相关合同</span>
                    </a>
                   <a href="https://www.csfhcdz.cn/bi/qt.html" target="_blank" class="submenu-item">
                        <i class="fas fa-building"></i>
                        <span>其它资料</span>
                    </a>
                </div>

                <!-- 数据查询（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-search"></i>
                    <span>数据查询</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="#" class="submenu-item" id="menu-cd-data">
                        <i class="fas fa-bolt"></i>
                        <span>充电数据</span>
                    </a>
                    <a href="#" class="submenu-item" id="menu-zh-data">
                        <i class="fas fa-chart-bar"></i>
                        <span>综合数据</span>
                    </a>
                    <a href="#" class="submenu-item" id="menu-bill-data">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>电费账单</span>
                    </a>
                    <a href="#" class="submenu-item" id="menu-user-data">
                        <i class="fas fa-user"></i>
                        <span>用户数据</span>
                    </a>
                    <a href="#" class="submenu-item" id="menu-other-data">
                        <i class="fas fa-database"></i>
                        <span>其它数据</span>
                    </a>
                </div>

                <!-- 报表查询（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-file-alt"></i>
                    <span>报表查询</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="#" class="submenu-item" id="menu-report-charging">
                        <i class="fas fa-bolt"></i>
                        <span>充电数据报表</span>
                    </a>
                    <a href="#" class="submenu-item" id="menu-report-comprehensive">
                        <i class="fas fa-chart-line"></i>
                        <span>综合数据报表</span>
                    </a>
                    <a href="#" class="submenu-item" id="menu-report-efficiency">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>充电效率分析</span>
                    </a>
                    <a href="#" class="submenu-item" id="menu-report-user">
                        <i class="fas fa-mobile-alt"></i>
                        <span>用户号码查询</span>
                    </a>
                    <a href="#" class="submenu-item" id="menu-report-bi">
                        <i class="fas fa-chart-bar"></i>
                        <span>数据统计查询</span>
                    </a>
                </div>

                <!-- 其他菜单项 -->
                
                <div class="menu-item" id="ai-model">
                    <i class="fas fa-robot"></i>
                    <span>简易会话</span>
                </div>

                <a href="https://www.csfhcdz.cn/bi/AI.html" target="_blank" class="menu-item">
                    <i class="fas fa-brain"></i>
                    <span>AI模型</span>
                </a>
                <div class="menu-item" id="history-menu">
                    <i class="fas fa-history"></i>
                    <span>历史记录</span>
                </div>
            </div>
            
            <!-- 主内容区 -->
            <div class="main-content" style="position: relative;">
                <!-- 覆盖式空白页面：充电数据（正式查询页） -->
                <div id="page-cd-data" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span id="breadcrumb-section">数据查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong id="breadcrumb-leaf" style="color:#333;">充电数据</strong>
                    </div>

                        
                    <!-- 查询条件栏 -->
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
                        <!-- 电站选择（移到最前面） -->
                        <div id="station-box" style="width:220px; border:1px solid #e5e5e5; border-radius:8px; padding:8px; position:relative; height:36px; display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:600; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:170px; font-size:14px;" id="station-display">电站</div>
                            <button id="station-menu-btn" onclick="toggleStationMenu()" title="选择电站" style="background:transparent; border:none; cursor:pointer; font-size:18px; line-height:1; color:#666;">⋯</button>
                            <div id="station-menu" style="position:absolute; top:44px; right:10px; background:#fff; border:1px solid #ddd; border-radius:6px; box-shadow:0 4px 16px rgba(0,0,0,0.08); padding:10px; width:200px; z-index:1100; display:none;">
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" id="station-all" checked onchange="onToggleAllStations()"> 全选
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="station-group" data-group="east" checked onchange="onStationChange()"> 长沙飞狐四方坪东区站
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="station-group" data-group="west" checked onchange="onStationChange()"> 长沙飞狐四方坪西区站
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="station-group" data-group="south" checked onchange="onStationChange()"> 长沙飞狐四方坪南区站
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; font-size:14px;">
                                    <input type="checkbox" class="station-group" data-group="gaoling" checked onchange="onStationChange()"> 长沙飞狐高岭站
                                </label>
                                <div style="text-align:right; margin-top:8px;">
                                    <button onclick="applyStationSelection()" style="background:#007bff; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">确定</button>
                                </div>
                            </div>
                        </div>
                        <!-- 充电平台选择（改为多选checkbox，移到第二位） -->
                        <div id="device-box" style="width:220px; border:1px solid #e5e5e5; border-radius:8px; padding:8px; position:relative; height:36px; display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:600; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:170px; font-size:14px;" id="device-display">充电平台</div>
                            <button id="device-menu-btn" onclick="toggleDeviceMenu()" title="选择充电平台" style="background:transparent; border:none; cursor:pointer; font-size:18px; line-height:1; color:#666;">⋯</button>
                            <div id="device-menu" style="position:absolute; top:44px; left:0; background:#fff; border:1px solid #ddd; border-radius:6px; box-shadow:0 4px 16px rgba(0,0,0,0.08); padding:10px; width:200px; z-index:1100; display:none;">
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="device-option" value="特来电" checked> 特来电
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="device-option" value="能科"> 能科
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; font-size:14px;">
                                    <input type="checkbox" class="device-option" value="滴滴"> 滴滴
                                </label>
                                <div style="text-align:right; margin-top:8px;">
                                    <button onclick="applyDeviceSelection()" style="background:#007bff; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">确定</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 时间字段选择 -->
                        <select id="time-field-select" style="width:220px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                            <option value="充电结束时间" selected>充电结束时间</option>
                            <option value="充电开始时间">充电开始时间</option>
                        </select>

                        <!-- 开始时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="start-datetime" type="text" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="start-datetime-btn" title="选择日期" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 结束时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="end-datetime" type="text" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="end-datetime-btn" title="选择日期" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 操作按钮 -->
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <button onclick="runStationQuery()" style="background:#28a745; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;">查询</button>
                            <div style="position:relative;">
                                <button id="export-btn" onclick="showExportOptions('charging')" disabled style="background:#adb5bd; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:not-allowed;">导出 Excel ▼</button>
                            </div>
                        </div>
                            </div>
                            
                    <!-- 查询结果 -->
                    <div id="query-result" style="margin-top: 16px; height: calc(100vh - 200px); display: flex; flex-direction: column;">
                        <div id="current-conditions" style="margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                            <strong style="color: #495057;">当前条件：</strong><span id="current-conditions-text" style="color: #6c757d;">请选择查询条件后点击查询</span>
                        </div>
                        <div id="stats-container" style="margin-bottom: 12px;"></div>
                        <div id="query-result-content" style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 6px;">
                     </div>
                    </div>
                </div>
                
                <!-- 覆盖式空白页面：智能小模型 -->
                <div id="page-ai-model" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong style="color:#333;">简易会话</strong>
                    </div>
                    
                    <!-- 智能小模型主界面 -->
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:calc(100vh - 150px); padding:40px 20px;">
                        <!-- 提示文字 -->
                        <div style="font-size:22px; color:#333; margin-bottom:30px; font-weight:bold; font-family:'Microsoft YaHei', '微软雅黑', Arial, sans-serif;">
                            请输入想要咨询的充电数据
                        </div>
                        
                        <!-- 输入框容器 -->
                        <div style="position:relative; width:100%; max-width:800px; margin-bottom:20px;">
                            <textarea 
                                id="ai-query-input" 
                                placeholder="" 
                                style="width:100%; min-height:120px; padding:15px 100px 15px 15px; border:1px solid #ddd; border-radius:8px; font-size:16px; resize:none; outline:none; color:#333; background-color:#fafafa;"
                                onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendAIQuery();}"
                            ></textarea>
                            <!-- 发送按钮 -->
                            <button 
                                id="ai-send-btn" 
                                onclick="sendAIQuery()" 
                                style="position:absolute; right:15px; bottom:15px; background:#007bff; color:#fff; border:none; padding:10px; width:40px; height:40px; border-radius:50%; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center; transition:background 0.3s;"
                                onmouseover="this.style.background='#0056b3'"
                                onmouseout="this.style.background='#007bff'"
                            >
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                        
                        <!-- 结果显示区域 -->
                        <div id="ai-result-container" style="width:100%; max-width:800px; margin-top:30px; display:none;">
                            <!-- 思考动画 -->
                            <div id="ai-thinking" style="display:none; padding:20px; background:#f8f9fa; border-radius:8px; margin-bottom:20px;">
                                <div style="display:flex; align-items:center; gap:10px; color:#666;">
                                    <span id="thinking-dots" style="font-size:20px;">正在思考</span>
                                    <span id="thinking-time" style="font-size:14px; color:#999; margin-left:auto;"></span>
                                </div>
                            </div>
                            
                            <!-- 回答结果 -->
                            <div id="ai-answer" style="padding:20px; background:#f8f9fa; border-radius:8px; border-left:4px solid #007bff; line-height:1.8; color:#333; font-size:16px; white-space:pre-wrap; word-wrap:break-word;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 覆盖式空白页面：电费账单 -->
                <div id="page-bill-data" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span id="breadcrumb-section-bill">数据查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong id="breadcrumb-leaf-bill" style="color:#333;">电费账单</strong>
                    </div>

                    <!-- 查询条件栏 -->
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
                        <!-- 客户号选择 -->
                        <div id="customer-box" style="width:220px; border:1px solid #e5e5e5; border-radius:8px; padding:8px; position:relative; height:36px; display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:600; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:170px; font-size:14px;" id="customer-display">客户号</div>
                            <button id="customer-menu-btn" onclick="toggleCustomerMenu()" title="选择客户号" style="background:transparent; border:none; cursor:pointer; font-size:18px; line-height:1; color:#666;">⋯</button>
                            <div id="customer-menu" style="position:absolute; top:44px; right:10px; background:#fff; border:1px solid #ddd; border-radius:6px; box-shadow:0 4px 16px rgba(0,0,0,0.08); padding:10px; width:200px; z-index:1100; display:none;">
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" id="customer-all" checked onchange="onToggleAllCustomers()"> 全选
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="customer-group" data-customer="3111439077" checked> 3111439077
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="customer-group" data-customer="3118481453" checked> 3118481453
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; font-size:14px;">
                                    <input type="checkbox" class="customer-group" data-customer="4350001671599" checked> 4350001671599
                                </label>
                                <div style="text-align:right; margin-top:8px;">
                                    <button onclick="applyCustomerSelection()" style="background:#007bff; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">确定</button>
                                </div>
                            </div>
                        </div>

                        <!-- 开始时间（年月格式） -->
                        <div style="position:relative; width:220px;">
                            <input id="bill-start-month" type="text" placeholder="开始年月" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" onclick="showBillMonthPicker('bill-start-month', this)" />
                            <button id="bill-start-month-btn" title="选择年月" onclick="showBillMonthPicker('bill-start-month', document.getElementById('bill-start-month'))" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                            <div id="bill-start-month-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                        </div>

                        <!-- 结束时间（年月格式） -->
                        <div style="position:relative; width:220px;">
                            <input id="bill-end-month" type="text" placeholder="结束年月" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" onclick="showBillMonthPicker('bill-end-month', this)" />
                            <button id="bill-end-month-btn" title="选择年月" onclick="showBillMonthPicker('bill-end-month', document.getElementById('bill-end-month'))" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                            <div id="bill-end-month-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                        </div>

                        <!-- 操作按钮 -->
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <button onclick="runBillQuery()" style="background:#28a745; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;">查询</button>
                            <button id="bill-export-btn" onclick="exportBillToExcel()" disabled style="background:#adb5bd; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:not-allowed;">导出 Excel</button>
                        </div>
                    </div>
                    
                    <!-- 查询结果 -->
                    <div id="bill-query-result" style="margin-top: 16px; height: calc(100vh - 200px); display: flex; flex-direction: column;">
                        <div id="bill-current-conditions" style="margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                            <strong style="color: #495057;">当前条件：</strong><span id="bill-current-conditions-text" style="color: #6c757d;">请选择查询条件后点击查询</span>
                        </div>
                        <div id="bill-query-result-content" style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                </div>

                <!-- 覆盖式空白页面：用户数据 -->
                <div id="page-user-data" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span id="breadcrumb-section-user">数据查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong id="breadcrumb-leaf-user" style="color:#333;">用户数据</strong>
                    </div>

                    <!-- 查询条件栏 -->
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
                        <!-- 车牌号/手机号输入框 -->
                        <div style="position:relative; width:220px;">
                            <input id="user-input" type="text" placeholder="车牌号/手机号" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                        </div>

                        <!-- 时间字段选择 -->
                        <select id="user-time-field-select" style="width:220px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                            <option value="充电结束时间" selected>充电结束时间</option>
                            <option value="充电开始时间">充电开始时间</option>
                        </select>

                        <!-- 开始时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="user-start-datetime" type="text" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="user-start-date-btn" title="选择日期" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 结束时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="user-end-datetime" type="text" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="user-end-date-btn" title="选择日期" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 操作按钮 -->
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <button onclick="runUserDataQuery()" style="background:#28a745; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;">查询</button>
                            <div style="position:relative;">
                                <button id="user-export-btn" onclick="exportUserDataToExcel()" disabled style="background:#adb5bd; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:not-allowed;">导出 Excel</button>
                            </div>
                        </div>
                    </div>

                    <!-- 查询结果 -->
                    <div id="user-query-result" style="margin-top: 16px; height: calc(100vh - 200px); display: flex; flex-direction: column;">
                        <div id="user-current-conditions" style="margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                            <strong style="color: #495057;">当前条件：</strong><span id="user-current-conditions-text" style="color: #6c757d;">请输入车牌号或手机号后点击查询</span>
                        </div>
                        <div id="user-stats-container" style="margin-bottom: 12px;"></div>
                        <div id="user-query-result-content" style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                </div>

                <!-- 覆盖式空白页面：其它数据 -->
                <div id="page-other-data" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span id="breadcrumb-section-other">数据查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong id="breadcrumb-leaf-other" style="color:#333;">其它数据</strong>
                    </div>

                    <!-- 查询条件栏 -->
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
                        <!-- 电站选择 -->
                        <div id="other-station-box" style="width:220px; border:1px solid #e5e5e5; border-radius:8px; padding:8px; position:relative; height:36px; display:flex; align-items:center; justify-content:space-between;">
                            <div style="font-weight:600; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:170px; font-size:14px;" id="other-station-display">电站</div>
                            <button id="other-station-menu-btn" onclick="toggleOtherStationMenu()" title="选择电站" style="background:transparent; border:none; cursor:pointer; font-size:18px; line-height:1; color:#666;">⋯</button>
                            <div id="other-station-menu" style="position:absolute; top:44px; right:10px; background:#fff; border:1px solid #ddd; border-radius:6px; box-shadow:0 4px 16px rgba(0,0,0,0.08); padding:10px; width:200px; z-index:1100; display:none;">
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" id="other-station-all" checked onchange="onToggleAllOtherStations()"> 全选
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px; font-size:14px;">
                                    <input type="checkbox" class="other-station-option" value="四方坪站" checked onchange="onOtherStationChange()"> 四方坪站
                                </label>
                                <label style="display:flex; align-items:center; gap:8px; font-size:14px;">
                                    <input type="checkbox" class="other-station-option" value="高岭站" checked onchange="onOtherStationChange()"> 高岭站
                                </label>
                                <div style="text-align:right; margin-top:8px;">
                                    <button onclick="applyOtherStationSelection()" style="background:#007bff; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;">确定</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 数据类别选择（单选） -->
                        <select id="other-data-category" style="width:220px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" onchange="onOtherDataCategoryChange()">
                            <option value="" disabled selected hidden>数据类别</option>
                            <option value="判定车牌号">判定车牌号</option>
                            <option value="终端名称">终端名称</option>
                            <option value="扣费企业名称">扣费企业名称</option>
                            <option value="充电启动方式">充电启动方式</option>
                            <option value="二级来源">二级来源</option>
                            <option value="扣费账户类型">扣费账户类型</option>
                            <option value="用户分类">用户分类</option>
                            <option value="会员等级">会员等级</option>
                            <option value="判定结束原因">判定结束原因</option>
                            <option value="充电枪ID" class="didi-only" style="display:none;">充电枪ID</option>
                            <option value="停充原因" class="didi-only" style="display:none;">停充原因</option>
                            <option value="用户类型" class="didi-only" style="display:none;">用户类型</option>
                            <option value="手机号" class="didi-only" style="display:none;">手机号</option>
                            <option value="车牌号" class="didi-only" style="display:none;">车牌号</option>
                            <option value="滴滴营销费用" class="didi-only" style="display:none;">滴滴营销费用</option>
                            <option value="滴滴未结算订单" class="didi-only" style="display:none;">滴滴订单汇总</option>
                        </select>

                        <!-- 排序方式选择（单选） -->
                        <select id="other-sort-order" style="width:220px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                            <option value="升序" selected>升序</option>
                            <option value="降序">降序</option>
                        </select>
                        
                        <!-- 时间字段选择 -->
                        <select id="other-time-field-select" style="width:220px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                            <option value="充电结束时间" selected>充电结束时间</option>
                            <option value="充电开始时间">充电开始时间</option>
                        </select>

                        <!-- 开始时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="other-start-datetime" type="text" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="other-start-datetime-btn" title="选择日期" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 结束时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="other-end-datetime" type="text" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px;" />
                            <button id="other-end-datetime-btn" title="选择日期" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                        </div>

                        <!-- 操作按钮 -->
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <button onclick="runOtherDataQuery()" style="background:#28a745; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;">查询</button>
                        </div>
                    </div>
                            
                    <!-- 查询结果 -->
                    <div id="other-query-result" style="margin-top: 16px; height: calc(100vh - 200px); display: flex; flex-direction: column;">
                        <div id="other-current-conditions" style="margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                            <strong style="color: #495057;">当前条件：</strong><span id="other-current-conditions-text" style="color: #6c757d;">请选择查询条件后点击查询</span>
                        </div>
                        <!-- 汇总统计显示区域 -->
                        <div id="other-summary-stats" style="margin-bottom: 12px; padding: 10px; background-color: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 6px; font-size: 14px; display: none;">
                            <strong style="color: #495057;">查询汇总统计：</strong>
                            <div id="other-summary-stats-content" style="color: #333; margin-top: 8px;"></div>
                        </div>
                        <!-- 分页和导出按钮 -->
                        <div id="other-pagination-controls" style="margin-bottom: 12px; display: none; justify-content: space-between; align-items: center; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;">
                            <div id="other-pagination-buttons" style="display: flex; gap: 8px; align-items: center;"></div>
                            <div style="display: flex; gap: 8px;">
                                <button id="other-export-current-btn" onclick="exportOtherDataCurrentPage()" style="background:#17a2b8; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:14px;">导出当前页</button>
                                <button id="other-export-all-btn" onclick="exportOtherDataAll()" style="background:#17a2b8; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:14px;">导出全部</button>
                            </div>
                        </div>
                        <div id="other-query-result-content" style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                </div>

                <!-- 覆盖式空白页面：综合数据 -->
                <div id="page-zh-data" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span id="breadcrumb-section-zh">数据查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong id="breadcrumb-leaf-zh" style="color:#333;">综合数据</strong>
                    </div>

                    <!-- 查询条件栏 -->
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
                        <!-- 项目类别选择 -->
                        <select id="zh-project-select" onchange="onZhProjectChange()" style="width:220px; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:14px; color:#333;">
                            <option value="" disabled selected hidden>项目类别</option>
                            <option value="红门缴费">红门缴费</option>
                            <option value="月租车充值">月租车充值</option>
                            <option value="兴元售货机">兴元售货机</option>
                            <option value="赛菲姆道闸">赛菲姆道闸</option>
                            <option value="快易洁洗车">快易洁洗车</option>
                            <option value="收钱吧">收钱吧</option>
                            <option value="车颜知己洗车">车颜知己洗车</option>
                            <option value="车海洋洗车">车海洋洗车</option>
                            <option value="微信">微信</option>
                            <option value="智小盟">智小盟</option>
                            <option value="超时占位费">超时占位费</option>
                        </select>

                        <!-- 开始时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="zh-start-datetime" type="text" placeholder="开始时间" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" />
                            <button id="zh-start-date-btn" title="选择日期" onclick="showZhMonthPicker('zh-start-datetime', document.getElementById('zh-start-datetime'))" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                            <div id="zh-start-datetime-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                        </div>

                        <!-- 结束时间 -->
                        <div style="position:relative; width:220px;">
                            <input id="zh-end-datetime" type="text" placeholder="结束时间" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" />
                            <button id="zh-end-date-btn" title="选择日期" onclick="showZhMonthPicker('zh-end-datetime', document.getElementById('zh-end-datetime'))" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                            <div id="zh-end-datetime-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                        </div>

                        <!-- 操作按钮 -->
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <button onclick="runZhQuery()" style="background:#28a745; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer;">查询</button>
                            <div style="position:relative;">
                                <button id="zh-export-btn" onclick="showExportOptions('zh')" disabled style="background:#adb5bd; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:not-allowed;">导出 Excel ▼</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 查询结果 -->
                    <div id="zh-query-result" style="margin-top: 16px; height: calc(100vh - 200px); display: flex; flex-direction: column;">
                        <div id="zh-current-conditions" style="margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                            <strong style="color: #495057;">当前条件：</strong><span id="zh-current-conditions-text" style="color: #6c757d;">请选择查询条件后点击查询</span>
                        </div>
                        <div id="zh-query-result-content" style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                    </div>
                </div>
                
                <!-- 覆盖式空白页面：充电数据报表 -->
                <div id="page-report-charging" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span>报表查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong style="color:#333;">充电数据报表</strong>
                    </div>

                    <!-- 查询表单 -->
                    <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                            <!-- 站点选择 -->
                            <div style="position:relative;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">站点</label>
                                <div id="station-selector" class="multi-select-box" style="min-width:200px; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; position:relative; display:flex; align-items:center; box-sizing:border-box; min-height:38px;">
                                    <span id="station-display" style="font-size:12px;">请选择站点</span>
                                    <i class="fas fa-chevron-down" style="position:absolute; right:10px; top:50%; transform:translateY(-50%);"></i>
                                </div>
                                <div id="station-dropdown" style="display:none; position:absolute; top:100%; left:0; z-index:1001; background:#fff; border:1px solid #ddd; border-radius:4px; margin-top:2px; min-width:200px; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
                                    <div style="padding:8px;">
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" id="station-all" value="全部" onchange="toggleStationAll()" style="margin-right:8px;">
                                            全选
                                        </label>
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="station-option" value="四方坪站" onchange="updateStationSelection()" style="margin-right:8px;">
                                            四方坪站
                                        </label>
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="station-option" value="高岭站" onchange="updateStationSelection()" style="margin-right:8px;">
                                            高岭站
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 开始日期 -->
                            <div style="position:relative; width:220px;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">开始日期</label>
                                <input type="text" id="report-start-date" placeholder="开始日期" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" onclick="showMonthPicker('report-start-date', this)">
                                <button id="report-start-date-btn" title="选择日期" onclick="event.stopPropagation(); showMonthPicker('report-start-date', document.getElementById('report-start-date'))" style="position:absolute; right:6px; top:calc(50% + 10px); transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                                <div id="report-start-date-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                            </div>

                            <!-- 结束日期 -->
                            <div style="position:relative; width:220px;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">结束日期</label>
                                <input type="text" id="report-end-date" placeholder="结束日期" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" onclick="showMonthPicker('report-end-date', this)">
                                <button id="report-end-date-btn" title="选择日期" onclick="event.stopPropagation(); showMonthPicker('report-end-date', document.getElementById('report-end-date'))" style="position:absolute; right:6px; top:calc(50% + 10px); transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                                <div id="report-end-date-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                            </div>

                            <!-- 查询按钮 -->
                            <div style="margin-top:23px; display:flex; gap:10px;">
                                <button onclick="queryChargingReport()" style="padding:8px 20px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:8px; transition:background 0.3s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                    <i class="fas fa-search"></i>
                                    <span>查询</span>
                                </button>
                                <button id="charging-report-export-btn" onclick="exportChargingReport()" disabled style="padding:8px 20px; background:#adb5bd; color:#fff; border:none; border-radius:4px; cursor:not-allowed; font-size:14px; display:flex; align-items:center; gap:8px; transition:background 0.3s;">
                                    <i class="fas fa-download"></i>
                                    <span>导出数据</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 报表显示区域 -->
                    <div id="report-result" style="display:none;">
                        <!-- 报表内容将动态生成 -->
                    </div>
                </div>

                <!-- 覆盖式空白页面：充电效率分析 -->
                <div id="page-report-efficiency" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span>报表查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong style="color:#333;">充电效率分析</strong>
                    </div>

                    <!-- 查询表单 -->
                    <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                            <!-- 站点选择 -->
                            <div style="position:relative;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">站点</label>
                                <div id="eff-station-selector" class="multi-select-box" style="min-width:200px; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; position:relative; display:flex; align-items:center; box-sizing:border-box; min-height:38px;" onclick="toggleEffStationDropdown(event)">
                                    <span id="eff-station-display" style="font-size:12px;">全选</span>
                                    <i class="fas fa-chevron-down" style="position:absolute; right:10px; top:50%; transform:translateY(-50%);"></i>
                                </div>
                                <div id="eff-station-dropdown" style="display:none; position:absolute; top:100%; left:0; z-index:1001; background:#fff; border:1px solid #ddd; border-radius:4px; margin-top:2px; min-width:200px; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
                                    <div style="padding:8px;">
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" id="eff-station-all" value="全部" onchange="toggleEffStationAll()" style="margin-right:8px;" checked>
                                            全选
                                        </label>
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="eff-station-option" value="四方坪站" onchange="updateEffStationSelection()" style="margin-right:8px;" checked>
                                            四方坪站
                                        </label>
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="eff-station-option" value="高岭站" onchange="updateEffStationSelection()" style="margin-right:8px;" checked>
                                            高岭站
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 开始日期 -->
                            <div style="position:relative; width:220px;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">开始日期</label>
                                <input type="text" id="eff-start-date" placeholder="开始日期" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" onclick="showMonthPicker('eff-start-date', this)">
                                <button id="eff-start-date-btn" title="选择日期" onclick="event.stopPropagation(); showMonthPicker('eff-start-date', document.getElementById('eff-start-date'))" style="position:absolute; right:6px; top:calc(50% + 10px); transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                                <div id="eff-start-date-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                            </div>

                            <!-- 结束日期 -->
                            <div style="position:relative; width:220px;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">结束日期</label>
                                <input type="text" id="eff-end-date" placeholder="结束日期" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" onclick="showMonthPicker('eff-end-date', this)">
                                <button id="eff-end-date-btn" title="选择日期" onclick="event.stopPropagation(); showMonthPicker('eff-end-date', document.getElementById('eff-end-date'))" style="position:absolute; right:6px; top:calc(50% + 10px); transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                                <div id="eff-end-date-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                            </div>

                            <!-- 查询按钮 -->
                            <div style="margin-top:23px; display:flex; gap:10px;">
                                <button onclick="queryEfficiencyReport()" style="padding:8px 20px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:8px; transition:background 0.3s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                    <i class="fas fa-search"></i>
                                    <span>查询</span>
                                </button>
                                <button id="efficiency-report-export-btn" onclick="exportEfficiencyReport()" disabled style="padding:8px 20px; background:#adb5bd; color:#fff; border:none; border-radius:4px; cursor:not-allowed; font-size:14px; display:flex; align-items:center; gap:8px; transition:background 0.3s;">
                                    <i class="fas fa-download"></i>
                                    <span>导出数据</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 报表显示区域 -->
                    <div id="efficiency-report-result" style="display:none;">
                        <!-- 报表内容将动态生成 -->
                    </div>
                </div>

                <!-- 月份选择器弹窗（保留用于兼容，但不再使用） -->
                <div id="month-picker-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
                    <div style="background:#fff; border-radius:8px; padding:20px; min-width:300px; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <button onclick="changeYear(-1)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer;">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="picker-year" style="font-size:18px; font-weight:bold;"></span>
                            <button onclick="changeYear(1)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer;">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:15px;">
                            <button onclick="selectMonth(1)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">1月</button>
                            <button onclick="selectMonth(2)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">2月</button>
                            <button onclick="selectMonth(3)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">3月</button>
                            <button onclick="selectMonth(4)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">4月</button>
                            <button onclick="selectMonth(5)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">5月</button>
                            <button onclick="selectMonth(6)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">6月</button>
                            <button onclick="selectMonth(7)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">7月</button>
                            <button onclick="selectMonth(8)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">8月</button>
                            <button onclick="selectMonth(9)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">9月</button>
                            <button onclick="selectMonth(10)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">10月</button>
                            <button onclick="selectMonth(11)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">11月</button>
                            <button onclick="selectMonth(12)" class="month-btn" style="padding:10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">12月</button>
                        </div>
                        <button onclick="closeMonthPicker()" style="width:100%; padding:8px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer;">取消</button>
                    </div>
                </div>
                
                <!-- 覆盖式空白页面：综合数据报表 -->
                <div id="page-report-comprehensive" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span>报表查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong style="color:#333;">综合数据报表</strong>
                    </div>

                    <!-- 查询表单 -->
                    <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                            <!-- 站点选择 -->
                            <div style="position:relative;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">站点</label>
                                <div id="comp-station-selector" class="multi-select-box" style="min-width:200px; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; position:relative; display:flex; align-items:center; box-sizing:border-box; min-height:38px;">
                                    <span id="comp-station-display" style="font-size:12px;">请选择站点</span>
                                    <i class="fas fa-chevron-down" style="position:absolute; right:10px; top:50%; transform:translateY(-50%);"></i>
                                </div>
                                <div id="comp-station-dropdown" style="display:none; position:absolute; top:100%; left:0; z-index:1001; background:#fff; border:1px solid #ddd; border-radius:4px; margin-top:2px; min-width:200px; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
                                    <div style="padding:8px;">
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" id="comp-station-all" value="全部" onchange="toggleCompStationAll()" style="margin-right:8px;">
                                            全选
                                        </label>
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="comp-station-option" value="四方坪站" onchange="updateCompStationSelection()" style="margin-right:8px;">
                                            四方坪站
                                        </label>
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="comp-station-option" value="高岭站" onchange="updateCompStationSelection()" style="margin-right:8px;">
                                            高岭站
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 开始日期 -->
                            <div style="position:relative; width:220px;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">开始日期</label>
                                <input type="text" id="comp-start-date" placeholder="开始日期" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" onclick="showCompMonthPicker('comp-start-date', this)">
                                <button id="comp-start-date-btn" title="选择日期" onclick="showCompMonthPicker('comp-start-date', document.getElementById('comp-start-date'))" style="position:absolute; right:6px; top:calc(50% + 10px); transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                                <div id="comp-start-date-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                            </div>

                            <!-- 结束日期 -->
                            <div style="position:relative; width:220px;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">结束日期</label>
                                <input type="text" id="comp-end-date" placeholder="结束日期" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" onclick="showCompMonthPicker('comp-end-date', this)">
                                <button id="comp-end-date-btn" title="选择日期" onclick="showCompMonthPicker('comp-end-date', document.getElementById('comp-end-date'))" style="position:absolute; right:6px; top:calc(50% + 10px); transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                                <div id="comp-end-date-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                            </div>

                            <!-- 查询按钮 -->
                            <div style="margin-top:23px; display:flex; gap:10px;">
                                <button onclick="queryComprehensiveReport()" style="padding:8px 20px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:8px; transition:background 0.3s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                    <i class="fas fa-search"></i>
                                    <span>查询</span>
                                </button>
                                <button id="comp-report-export-btn" onclick="exportComprehensiveReport()" disabled style="padding:8px 20px; background:#adb5bd; color:#fff; border:none; border-radius:4px; cursor:not-allowed; font-size:14px; display:flex; align-items:center; gap:8px; transition:background 0.3s;">
                                    <i class="fas fa-download"></i>
                                    <span>导出数据</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 报表显示区域 -->
                    <div id="comp-report-result" style="display:none;">
                        <!-- 报表内容将动态生成 -->
                    </div>
                </div>
                
                <!-- 覆盖式空白页面：用户查询 -->
                <div id="page-report-user" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span>报表查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong style="color:#333;">用户号码查询</strong>
                    </div>
                    
                    <!-- 查询条件栏 -->
                    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-bottom:20px;">
                        <!-- 车牌号输入框 -->
                        <div style="position:relative; width:300px;">
                            <label style="display:block; margin-bottom:6px; font-size:14px; color:#333; font-weight:500;">车牌号</label>
                            <input id="user-query-plate" type="text" placeholder="请输入车牌号" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;" onkeypress="if(event.key==='Enter') runUserQuery();" />
                        </div>

                        <!-- 查询按钮 -->
                        <div style="display:flex; align-items:flex-end;">
                            <button onclick="runUserQuery()" style="background:#28a745; color:#fff; border:none; padding:10px 24px; border-radius:6px; cursor:pointer; font-size:14px; height:42px;">查询</button>
                        </div>
                    </div>
                    
                    <!-- 查询结果 -->
                    <div id="user-query-result" style="margin-top: 16px; height: calc(100vh - 200px); display: flex; flex-direction: column;">
                        <div id="user-report-query-result-content" style="flex: 1; overflow: auto; border: 1px solid #ddd; border-radius: 6px; padding: 20px; background: #f9f9f9;">
                            <div style="text-align: center; color: #999; padding: 40px;">
                                <p>请输入车牌号进行查询</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 覆盖式空白页面：BI数据看板 -->
                <div id="page-report-bi" style="display:none; position:fixed; top:70px; left:250px; right:0; bottom:0; background:#ffffff; overflow:auto; padding:20px; z-index:1000;">
                    <!-- 面包屑导航 -->
                    <div style="font-size:14px; color:#666; margin-bottom:12px;">
                        <a href="#" onclick="navigateHome()" style="color:#007bff; text-decoration:none;">首页</a>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <span>报表查询</span>
                        <span style="margin: 0 6px; color:#aaa;">&gt;</span>
                        <strong style="color:#333;">数据统计查询</strong>
                    </div>
                    
                    <!-- 查询条件栏 -->
                    <div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-bottom:20px;">
                        <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                            <!-- 站点选择 -->
                            <div style="position:relative;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">站点</label>
                                <div id="bi-station-selector" class="multi-select-box" style="min-width:200px; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; position:relative; display:flex; align-items:center; box-sizing:border-box; min-height:38px;">
                                    <span id="bi-station-display" style="font-size:12px;">请选择站点</span>
                                    <i class="fas fa-chevron-down" style="position:absolute; right:10px; top:50%; transform:translateY(-50%);"></i>
                                </div>
                                <div id="bi-station-dropdown" style="display:none; position:absolute; top:100%; left:0; z-index:1001; background:#fff; border:1px solid #ddd; border-radius:4px; margin-top:2px; min-width:200px; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
                                    <div style="padding:8px;">
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" id="bi-station-all" value="全部" onchange="toggleBIStationAll()" style="margin-right:8px;">
                                            全选
                                        </label>
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="bi-station-option" value="四方坪站" onchange="updateBIStationSelection()" style="margin-right:8px;">
                                            四方坪站
                                        </label>
                                        <label style="display:block; padding:5px 8px; cursor:pointer; border-radius:3px; transition:background 0.2s; font-size:12px;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="bi-station-option" value="高岭站" onchange="updateBIStationSelection()" style="margin-right:8px;">
                                            高岭站
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- 开始日期 -->
                            <div style="position:relative; width:220px;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">开始日期</label>
                                <input type="text" id="bi-start-datetime" placeholder="开始日期" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" onclick="showBIMonthPicker('bi-start-datetime', this)">
                                <button id="bi-start-datetime-btn" title="选择日期" onclick="showBIMonthPicker('bi-start-datetime', document.getElementById('bi-start-datetime'))" style="position:absolute; right:6px; top:calc(50% + 10px); transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                                <div id="bi-start-datetime-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                            </div>

                            <!-- 结束日期 -->
                            <div style="position:relative; width:220px;">
                                <label style="display:block; margin-bottom:5px; font-size:14px; color:#333; font-weight:500;">结束日期</label>
                                <input type="text" id="bi-end-datetime" placeholder="结束日期" style="width:100%; padding:8px 30px 8px 8px; border:1px solid #ddd; border-radius:6px; font-size:14px; cursor:pointer;" onclick="showBIMonthPicker('bi-end-datetime', this)">
                                <button id="bi-end-datetime-btn" title="选择日期" onclick="showBIMonthPicker('bi-end-datetime', document.getElementById('bi-end-datetime'))" style="position:absolute; right:6px; top:calc(50% + 10px); transform:translateY(-50%); border:none; background:transparent; cursor:pointer; line-height:1;">📅</button>
                                <div id="bi-end-datetime-picker" style="display:none; position:absolute; top:100%; left:0; z-index:2001; margin-top:2px; background:#fff; border:1px solid #ddd; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:150px;"></div>
                            </div>

                            <!-- 查询按钮 -->
                            <div style="margin-top:23px; display:flex; gap:10px;">
                                <button onclick="runBIQuery()" style="padding:8px 20px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:8px; transition:background 0.3s;" onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                                    <i class="fas fa-search"></i>
                                    <span>查询</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 查询条件显示 -->
                    <div id="bi-query-conditions" style="display:none; margin-bottom:20px; padding:12px; background:#e7f3ff; border-left:4px solid #007bff; border-radius:4px;">
                        <div style="font-size:14px; color:#333;">
                            <strong>当前查询条件：</strong>
                            <span id="bi-conditions-text"></span>
                        </div>
                    </div>
                    
                    <!-- 图表展示区域 -->
                    <div id="bi-charts-container" style="display:none;">
                        <!-- 充电电量图表 -->
                        <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                            <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                                <i class="fas fa-bolt"></i> 充电电量分析
                            </h3>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                                <div>
                                    <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最大10天数据</h4>
                                    <canvas id="bi-charge-max-chart"></canvas>
                                </div>
                                <div>
                                    <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最小10天数据</h4>
                                    <canvas id="bi-charge-min-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- 充电服务费图表 -->
                        <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                            <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                                <i class="fas fa-coins"></i> 充电服务费分析
                            </h3>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                                <div>
                                    <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最大10天数据</h4>
                                    <canvas id="bi-service-max-chart"></canvas>
                                </div>
                                <div>
                                    <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最小10天数据</h4>
                                    <canvas id="bi-service-min-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- 充电费用图表 -->
                        <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                            <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                                <i class="fas fa-money-bill-wave"></i> 充电费用分析
                            </h3>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                                <div>
                                    <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最大10天数据</h4>
                                    <canvas id="bi-cost-max-chart"></canvas>
                                </div>
                                <div>
                                    <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最小10天数据</h4>
                                    <canvas id="bi-cost-min-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- 充电时长图表 -->
                        <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                            <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                                <i class="fas fa-clock"></i> 充电时长分析
                            </h3>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                                <div>
                                    <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最大10天数据</h4>
                                    <canvas id="bi-duration-max-chart"></canvas>
                                </div>
                                <div>
                                    <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最小10天数据</h4>
                                    <canvas id="bi-duration-min-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- 充电订单数图表 -->
                        <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                            <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                                <i class="fas fa-list-alt"></i> 充电订单数分析
                            </h3>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                                <div>
                                    <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最大10天数据</h4>
                                    <canvas id="bi-orders-max-chart"></canvas>
                                </div>
                                <div>
                                    <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最小10天数据</h4>
                                    <canvas id="bi-orders-min-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- 月数据和年数据展示区域（当跨月或跨年时显示） -->
                        <div id="bi-month-year-data" style="display:none;">
                            <!-- 月数据图表 -->
                            <div id="bi-month-charts" style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                                <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                                    <i class="fas fa-calendar-alt"></i> 月度数据分析
                                </h3>
                                <div>
                                    <h4 style="margin-bottom:15px; color:#666; font-size:14px;">月度数据对比</h4>
                                    <canvas id="bi-monthly-comparison-chart" style="max-height:500px;"></canvas>
                                </div>
                            </div>

                            <!-- 年数据图表 -->
                            <div id="bi-year-charts" style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                                <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                                    <i class="fas fa-calendar-check"></i> 年度数据分析
                                </h3>
                                <div>
                                    <canvas id="bi-yearly-combined-chart" style="max-height:500px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 初始提示 -->
                    <div id="bi-initial-tip" style="text-align:center; color:#999; padding:60px 20px;">
                        <i class="fas fa-chart-bar" style="font-size:48px; margin-bottom:15px; opacity:0.3;"></i>
                        <p style="font-size:16px;">请选择站点和时间范围进行查询</p>
                    </div>
                </div>
            
            <!-- 整体情况概要 -->
            <div class="overview-section">
                <h3 class="metric-section-title"><i class="fas fa-tachometer-alt"></i> 整体情况概要</h3>
                <div class="overview-grid" id="overview-grid">
                    <!-- 数据将由JavaScript动态填充 -->
                </div>
            </div>

                <h2 class="section-title"><i class="fas fa-charging-station"></i> 充电数据</h2>
                <!-- 充电数据指标板块 -->
                <div class="metrics-section" style="gap: 8px;">
    <!-- 本月充电数据 - 单独一行 -->
    <div class="metrics-row" style="margin-bottom: 5px;">
        <div class="metric-card" style="width: 100%; margin-bottom: 0;">
            <div class="metric-card-title">
                <i class="fas fa-calendar-check"></i>
                本月充电数据
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value" id="month-charge">205,673.95 kwh</div>
                    <div class="metric-label">总充电量</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="month-electricity">¥177,408.03</div>
                    <div class="metric-label">总充电收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="month-service">¥64,784.97</div>
                    <div class="metric-label">总服务费收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="month-orders">8,222</div>
                    <div class="metric-label">总订单数量</div>
                </div>
            </div>
        </div>
    </div>
                        
                       
                               <!-- 本年度充电数据 - 单独一行 -->
    <div class="metrics-row" style="margin-bottom: 5px;">
        <div class="metric-card" style="width: 100%; margin-bottom: 0;">
            <div class="metric-card-title">
                <i class="fas fa-calendar-alt"></i>
                本年度充电数据
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value" id="year-charge">3,395,628.58 kwh</div>
                    <div class="metric-label">总充电量</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="year-electricity">¥2,878,714.66</div>
                    <div class="metric-label">总充电收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="year-service">¥963,642.56</div>
                    <div class="metric-label">总服务费收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="year-orders">130,688</div>
                    <div class="metric-label">总订单数量</div>
                </div>
            </div>
        </div>
    </div>
                        
                                                      <!-- 累计充电数据 - 单独一行 -->
    <div class="metrics-row" style="margin-bottom: 5px;">
        <div class="metric-card" style="width: 100%; margin-bottom: 0;">
            <div class="metric-card-title">
                <i class="fas fa-chart-line"></i>
                累计充电数据
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value" id="total-charge">32,051,447.86 kwh</div>
                    <div class="metric-label">总充电量</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="total-electricity">¥30,318,139.69</div>
                    <div class="metric-label">总充电收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="total-service">¥11,305,282.54</div>
                    <div class="metric-label">总服务费收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="total-orders">1,235,906</div>
                    <div class="metric-label">总订单数量</div>
                </div>
            </div>
        </div>
    </div>
                    
               <!-- 站点数据统计板块 -->
<!-- 本月实时数据板块 -->
<h2 class="section-title"><i class="fas fa-chart-line"></i> 本月实时数据</h2>
<div class="metrics-section">
    <!-- 实时数据轮播表格 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-table"></i>
            本月日充电数据
        </div>
        <div class="realtime-table-container" id="realtime-table-container">
            <div class="data-loading" id="realtime-loading">
                <i class="fas fa-spinner fa-spin"></i> 正在加载实时数据，请稍候...
            </div>
            <table id="realtime-table">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>站点</th>
                        <th>充电量(kwh)</th>
                        <th>充电总收入(元)</th>   <!-- 新增这一列 -->
                        <th>充电服务费收入(元)</th>
                        <th>总订单数量</th>
                    </tr>
                </thead>
                <tbody id="realtime-table-body">
                    <!-- 数据将由JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 实时数据图表 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-line"></i>
            本月充电数据趋势
        </div>
        <div class="chart-wrapper">
            <canvas id="realtime-chart"></canvas>
        </div>
    </div>

    <!-- 未充电时长统计 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-clock"></i>
            未充电时长统计
            <div style="display: flex; align-items: center; margin-left: auto; gap: 10px;">
                <select id="uncharged-duration-filter" style="padding: 5px;">
                    <option value="all">全部时长</option>
                    <option value="lt30">&lt;30小时</option>
                    <option value="ge30lt60">&gt;=30&lt;60小时</option>
                    <option value="ge60lt90">&gt;=60&lt;90小时</option>
                    <option value="ge90">&gt;=90小时</option>
                </select>
            </div>
        </div>
        <div class="uncharged-table-container" style="max-height: 400px; overflow-y: auto; border: none; border-radius: 8px;">
            <table id="uncharged-table" class="data-table" style="width: 100%; border-collapse: collapse; border: none;">
                <thead>
                    <tr>
                        <th style="text-align: center; padding: 12px 8px; background-color: transparent; border: none;">电站名称</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: transparent; border: none;">终端名称</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: transparent; border: none;">上一次充电结束时间</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: transparent; border: none;">截止一直未充电时间</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: transparent; border: none;">未充电时长(小时)</th>
                    </tr>
                </thead>
                <tbody id="uncharged-table-body">
                    <!-- 数据将由JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
        <div class="data-info" style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0 10px;">
            <div id="uncharged-data-info">共加载 0 条数据</div>
            <div id="uncharged-pagination">
                当前第 <span id="current-page">1</span> 页，共 <span id="total-pages">1</span> 页
                <select id="page-select" style="margin-left: 10px;">
                    <option value="1">1</option>
                </select>
            </div>
        </div>
    </div>

    <!-- 数据可视化分析 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-line"></i>
            数据可视化分析
        </div>
        
        <!-- 翻页控制 -->
        <div class="visualization-controls" style="margin-bottom: 20px; text-align: center;">
            <button id="prev-visualization-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px;">&lt;</button>
            <span id="visualization-date-display" style="padding: 8px 16px; background: transparent; color: #333; border: none; border-radius: 4px; font-size: 14px; min-width: 120px; text-align: center; display: inline-block;">加载中...</span>
            <button id="next-visualization-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;">&gt;</button>
        </div>
        
        <!-- 四个可视化图表 -->
        <div class="visualization-charts" style="display: flex; gap: 15px; flex-wrap: wrap;">
            <!-- 柱状图 - 站点充电数据 -->
            <div class="chart-item" style="flex: 1; min-width: 300px; max-width: 400px; background: transparent; border-radius: 8px; padding: 15px; box-shadow: none;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333; text-align: center;">站点充电数据分析</div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="station-chart" style="max-width: 100%; max-height: 100%;"></canvas>
                </div>
            </div>
            
            <!-- 折线图 - 电站终端数据 -->
            <div class="chart-item" style="flex: 1; min-width: 300px; max-width: 400px; background: transparent; border-radius: 8px; padding: 15px; box-shadow: none;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333; text-align: center;">电站终端数据分析</div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="terminal-chart" style="max-width: 100%; max-height: 100%;"></canvas>
                </div>
            </div>
            
            <!-- 饼图 - 车辆分类数据 -->
            <div class="chart-item" style="flex: 1; min-width: 300px; max-width: 400px; background: transparent; border-radius: 8px; padding: 15px; box-shadow: none;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333; text-align: center;">车辆分类数据分析</div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="vehicle-chart" style="max-width: 100%; max-height: 100%;"></canvas>
                </div>
            </div>
            
            <!-- 散点图 - 用户分类数据 -->
            <div class="chart-item" style="flex: 1; min-width: 300px; max-width: 400px; background: transparent; border-radius: 8px; padding: 15px; box-shadow: none;">
                <div style="font-weight: bold; margin-bottom: 10px; color: #333; text-align: center;">用户分类数据分析</div>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="user-chart" style="max-width: 100%; max-height: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户充电行为分析 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-users"></i>
            用户充电行为分析
        </div>
        <div class="user-behavior-controls" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <!-- 数据模式选择按钮 -->
                <button id="day-data-btn" class="data-mode-btn active" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px;">日数据</button>
                <button id="month-data-btn" class="data-mode-btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">月数据</button>
            </div>
        </div>
        
        
        <!-- 可视化图表 -->
        <div class="chart-wrapper" style="position: relative;">
            <div style="position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; align-items: center; gap: 10px;">
                <button id="prev-data-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">&lt;</button>
                <span id="current-data-display" style="padding: 8px 12px; background: transparent; color: #333; border: none; border-radius: 4px; font-size: 12px; min-width: 80px; text-align: center;">加载中...</span>
                <button id="next-data-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">&gt;</button>
            </div>
            <canvas id="behavior-chart"></canvas>
        </div>
        
        <!-- 尖峰平谷充电记录表格和饼图 -->
        <div class="electricity-analysis-container" style="margin-top: 20px; display: flex; gap: 20px;">
            <!-- 表格部分 - 缩小到一半 -->
            <div class="electricity-analysis-table" style="flex: 1;">
                <div style="margin-bottom: 10px; font-weight: bold; color: #333;">尖峰平谷充电记录</div>
                <table id="electricity-table" style="width: 100%; border-collapse: collapse; border: none;">
                    <thead>
                        <tr>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">站点</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">尖</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">峰</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">平</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">谷</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: transparent; color: #333; border: none;">小计</th>
                        </tr>
                    </thead>
                    <tbody id="electricity-table-body">
                        <!-- 数据将由JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 饼图部分 - 分为两个独立的饼图 -->
            <div class="electricity-pie-charts" style="flex: 1; display: flex; gap: 20px;">
                <!-- 四方坪站饼图 -->
                <div class="electricity-pie-chart-sfp" style="flex: 1;">
                    <div style="position: relative; height: 200px; width: 200px; margin: 0 auto;">
                        <canvas id="electricity-pie-chart-sfp"></canvas>
                    </div>
                    <!-- 四方坪站数字显示 -->
                    <div class="electricity-numbers-sfp" style="margin-top: 10px; text-align: center;">
                        <div style="display: flex; justify-content: space-around; flex-wrap: nowrap; gap: 5px; font-size: 12px;">
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #ff6b6b; font-weight: bold; font-size: 14px;">尖:</span>
                                <span id="sfp-jian-number" style="font-weight: bold; font-size: 13px;">0</span>
                                <span id="sfp-jian-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #ffa726; font-weight: bold; font-size: 14px;">峰:</span>
                                <span id="sfp-feng-number" style="font-weight: bold; font-size: 13px;">0</span>
                                <span id="sfp-feng-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #66bb6a; font-weight: bold; font-size: 14px;">平:</span>
                                <span id="sfp-ping-number" style="font-weight: bold; font-size: 13px;">0</span>
                                <span id="sfp-ping-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #42a5f5; font-weight: bold; font-size: 14px;">谷:</span>
                                <span id="sfp-gu-number" style="font-weight: bold; font-size: 13px;">0</span>
                                <span id="sfp-gu-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 高岭站饼图 -->
                <div class="electricity-pie-chart-gl" style="flex: 1;">
                    <div style="position: relative; height: 200px; width: 200px; margin: 0 auto;">
                        <canvas id="electricity-pie-chart-gl"></canvas>
                    </div>
                    <!-- 高岭站数字显示 -->
                    <div class="electricity-numbers-gl" style="margin-top: 10px; text-align: center;">
                        <div style="display: flex; justify-content: space-around; flex-wrap: nowrap; gap: 5px; font-size: 12px;">
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #e57373; font-weight: bold; font-size: 14px;">尖:</span>
                                <span id="gl-jian-number" style="font-weight: bold; font-size: 14px;">0</span>
                                <span id="gl-jian-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #ffb74d; font-weight: bold; font-size: 14px;">峰:</span>
                                <span id="gl-feng-number" style="font-weight: bold; font-size: 14px;">0</span>
                                <span id="gl-feng-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #81c784; font-weight: bold; font-size: 14px;">平:</span>
                                <span id="gl-ping-number" style="font-weight: bold; font-size: 14px;">0</span>
                                <span id="gl-ping-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                            <div class="number-item" style="display: flex; align-items: center; gap: 3px;">
                                <span style="color: #64b5f6; font-weight: bold; font-size: 14px;">谷:</span>
                                <span id="gl-gu-number" style="font-weight: bold; font-size: 14px;">0</span>
                                <span id="gl-gu-percent" style="font-size: 13px; color: #666;">(0%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 经营效率分析 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-bar"></i>
            经营效率分析
        </div>
        <div class="efficiency-controls" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <!-- 数据模式选择按钮 -->
                <button id="efficiency-day-data-btn" class="efficiency-data-mode-btn active" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px;">日数据</button>
                <button id="efficiency-month-data-btn" class="efficiency-data-mode-btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">月数据</button>
            </div>
        </div>
        
        <!-- 经营效率分析内容 -->
        <div style="display: flex; gap: 20px; margin-top: 0px;">
            <!-- 经营效率分析表格 -->
            <div class="efficiency-table-container" style="flex: 1; position: relative;">
                <!-- 翻页控件 -->
                <div style="position: absolute; top: -40px; right: 0; z-index: 10; display: flex; align-items: center; gap: 10px;">
                    <button id="efficiency-prev-data-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">&lt;</button>
                    <span id="efficiency-current-data-display" style="padding: 8px 12px; background: #f8f9fa; color: #333; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; min-width: 80px; text-align: center;">加载中...</span>
                    <button id="efficiency-next-data-btn" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">&gt;</button>
                </div>
                <table id="efficiency-table" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                    <thead>
                        <tr>
                            <th style="text-align: center; padding: 12px 8px; background-color: #007bff; color: white; border: 1px solid #e0e0e0; width: 30%;">指标</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: #007bff; color: white; border: 1px solid #e0e0e0; width: 35%;">四方坪站</th>
                            <th style="text-align: center; padding: 12px 8px; background-color: #007bff; color: white; border: 1px solid #e0e0e0; width: 35%;">高岭站</th>
                        </tr>
                    </thead>
                    <tbody id="efficiency-table-body">
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">终端日均充电时长(分钟)</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-duration">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-duration">-</td>
                        </tr>
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">终端日均利用率</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-utilization">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-utilization">-</td>
                        </tr>
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">终端日均充电电量(kwh)</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-energy">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-energy">-</td>
                        </tr>
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">终端日均充电收益(元)</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-revenue">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-revenue">-</td>
                        </tr>
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">平均每小时充电功率(kw)</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-power">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-power">-</td>
                        </tr>
                        <tr>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0; background-color: #f8f9fa;">单枪日均充电次数</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="sifang-times">-</td>
                            <td style="text-align: center; padding: 12px 8px; border: 1px solid #e0e0e0;" id="gaoling-times">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 雷达图容器 -->
            <div class="efficiency-chart-container" style="flex: 1;">
                <div style="height: 400px; position: relative; margin-top: -90px;">
                    <canvas id="efficiency-radar-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
 
               <!-- 站点数据统计板块 -->
<div class="site-stats-section">
    <h2 class="section-title"><i class="fas fa-chart-bar"></i> 站点数据统计</h2>
    <div class="site-stats-container">
        <!-- 控制按钮区域 -->
        <div class="stats-controls">
            <div class="data-mode-buttons">
                <button class="mode-btn active" data-mode="month">月份数据</button>
                <button class="mode-btn" data-mode="year">年份数据</button>
                <button class="mode-btn" data-mode="total">总数据</button>
            </div>
            <div class="pagination-controls">
                <button class="page-btn" id="prev-btn" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="page-info" id="page-info">2024-01</span>
                <button class="page-btn" id="next-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <!-- 数据展示区域 -->
        <div class="stats-data-container">
            <!-- 四方坪站数据 -->
            <div class="site-data-section">
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电电量(kwh)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="sifang-charge-progress">
                            <div class="progress-fill" id="sifang-charge-fill"></div>
                        </div>
                        <span class="progress-value" id="sifang-charge-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name">四方坪站</div>
                    <div class="data-label">充电服务费(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="sifang-service-progress">
                            <div class="progress-fill" id="sifang-service-fill"></div>
                        </div>
                        <span class="progress-value" id="sifang-service-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电总收入(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="sifang-total-progress">
                            <div class="progress-fill" id="sifang-total-fill"></div>
                        </div>
                        <span class="progress-value" id="sifang-total-value">0</span>
                    </div>
                </div>
            </div>
            
            <!-- 高岭站数据 -->
            <div class="site-data-section">
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电电量(kwh)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="gaoling-charge-progress">
                            <div class="progress-fill" id="gaoling-charge-fill"></div>
                        </div>
                        <span class="progress-value" id="gaoling-charge-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name">高岭站</div>
                    <div class="data-label">充电服务费(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="gaoling-service-progress">
                            <div class="progress-fill" id="gaoling-service-fill"></div>
                        </div>
                        <span class="progress-value" id="gaoling-service-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电总收入(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="gaoling-total-progress">
                            <div class="progress-fill" id="gaoling-total-fill"></div>
                        </div>
                        <span class="progress-value" id="gaoling-total-value">0</span>
                    </div>
                </div>
            </div>
            
            <!-- 两站共计数据 -->
            <div class="site-data-section">
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电电量(kwh)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="total-charge-progress">
                            <div class="progress-fill" id="total-charge-fill"></div>
                        </div>
                        <span class="progress-value" id="total-charge-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name">两站共计</div>
                    <div class="data-label">充电服务费(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="total-service-progress">
                            <div class="progress-fill" id="total-service-fill"></div>
                        </div>
                        <span class="progress-value" id="total-service-value">0</span>
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="site-name-spacer"></div>
                    <div class="data-label">充电总收入(元)</div>
                    <div class="data-content">
                        <div class="progress-bar" id="total-total-progress">
                            <div class="progress-fill" id="total-total-fill"></div>
                        </div>
                        <span class="progress-value" id="total-total-value">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

               <!-- 充电数据看板 -->
<h2 class="section-title"><i class="fas fa-charging-station"></i> 充电数据看板</h2>
<div class="metrics-section">
    <!-- 第一部分：数据表格 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-table"></i>
            充电数据表格
            <div style="display: flex; align-items: center; margin-left: auto; gap: 10px;">
                <div style="display: flex; align-items: center; gap: 5px; border: 1px solid #ddd; border-radius: 6px; padding: 2px;">
                    <button id="year-prev-btn" style="border: none; background: transparent; cursor: pointer; padding: 5px 8px; font-size: 16px; color: #666;" title="上一年">‹</button>
                    <input type="text" id="year-select" readonly style="padding: 5px 10px; border: none; text-align: center; width: 80px; font-size: 14px; background: transparent; cursor: default;">
                    <button id="year-next-btn" style="border: none; background: transparent; cursor: pointer; padding: 5px 8px; font-size: 16px; color: #666;" title="下一年">›</button>
                </div>
                <button class="export-btn" id="export-board-btn">
                    <i class="fas fa-file-excel"></i>
                    <span>导出数据</span>
                </button>
            </div>
        </div>
        <div class="table-container" id="charging-board-table-container">
            <table id="charging-board-table">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>充电量(kwh)</th>
                        <th>充电电费(元)</th>
                        <th>充电服务费(元)</th>
                        <th>充电总收入(元)</th>
                        <th>总订单数量</th>
                    </tr>
                </thead>
                <tbody id="charging-board-table-body">
                    <!-- 数据将由JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 第二部分：可视化图表 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-line"></i>
            充电数据趋势
        </div>
        <div class="chart-wrapper">
            <canvas id="charging-board-chart"></canvas>
        </div>
    </div>
</div>
                    
                    <!-- 充电数据总趋势图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            充电数据总趋势 (2018-2026年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="charging-trend-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                </div>
                <h2 class="section-title"><i class="fas fa-chart-line"></i> 综合业务数据</h2>
                <!-- 综合数据板块 -->
                <div class="metrics-section">
                    <div class="metrics-row">
                        <div class="metric-card">
                            <div class="metric-card-title">
                                <i class="fas fa-money-bill-wave"></i>
                                综合收入数据
                            </div>
                            <!-- 修改为三列布局 -->
                            <div class="income-grid">
                                <div class="metric-item">
                                    <div class="metric-value" id="month-income">¥43,435.85</div>
                                    <div class="metric-label">上期总收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="year-income">¥375,153.84</div>
                                    <div class="metric-label">本年度总收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="total-income">¥2,564,822.21</div>
                                    <div class="metric-label">累计总收入</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                  <!-- 综合收入看板 -->
<div class="chart-container">
    <div class="chart-title">
        <i class="fas fa-chart-bar"></i>
        综合收入看板
        <div style="display: flex; align-items: center; margin-left: auto; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 5px; border: 1px solid #ddd; border-radius: 6px; padding: 2px;">
                <button id="income-year-prev-btn" style="border: none; background: transparent; cursor: pointer; padding: 5px 8px; font-size: 16px; color: #666;" title="上一年">‹</button>
                <input type="text" id="income-year-select" readonly style="padding: 5px 10px; border: none; text-align: center; width: 80px; font-size: 14px; background: transparent; cursor: default;">
                <button id="income-year-next-btn" style="border: none; background: transparent; cursor: pointer; padding: 5px 8px; font-size: 16px; color: #666;" title="下一年">›</button>
            </div>
            <button id="income-export-btn" class="chart-action-btn">
                <i class="fas fa-download"></i> 导出数据
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table id="income-table" class="data-table">
            <thead>
                <tr>
                    <!-- 表头将由JavaScript动态生成 -->
                </tr>
            </thead>
            <tbody>
                <!-- 表格数据将通过JavaScript动态加载 -->
            </tbody>
        </table>
    </div>
    <div class="chart-wrapper" style="margin-top: 20px;">
        <canvas id="income-dashboard-chart"></canvas>
    </div>
</div>  
                                     
                    <!-- 各版块收入汇总图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            各版块收入汇总 (2023-2026年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="revenue-by-sector-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                    
                    <!-- 年度总收入趋势图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            年度总收入趋势 (2018-2026年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="annual-revenue-trend-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                </div>
                <!-- 查询板块 -->
                <div class="query-section">
                    <h2 class="section-title"><i class="fas fa-search"></i> 数据查询</h2>
                    <div class="query-form" id="data-query-form">
                        <div class="form-group date-picker-container" style="flex: 0 0 18%;">
                           <label for="start-date">开始日期</label>
        <input type="text" id="start-date" placeholder="选择开始日期" style="width: 100%; height: 36px; box-sizing: border-box; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
        <div class="custom-picker" id="start-date-picker" style="width: 100%;">
                                <div class="custom-date-picker">
                                    <div class="date-header">
                                        <div class="year-control">
                                            <button type="button" class="year-btn prev-year" aria-label="上一年">‹</button>
                                            <div class="year-display" id="start-year-display">2025</div>
                                            <button type="button" class="year-btn next-year" aria-label="下一年">›</button>
                                        </div>
                                    </div>
                                    <div class="month-grid" id="start-month-grid">
                                        <!-- 月份按钮由JS生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group date-picker-container" style="flex: 0 0 18%;">
                             <label for="end-date">结束日期</label>
        <input type="text" id="end-date" placeholder="选择结束日期" style="width: 100%; height: 36px; box-sizing: border-box; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
        <div class="custom-picker" id="end-date-picker" style="width: 100%;">
                                <div class="custom-date-picker">
                                    <div class="date-header">
                                        <div class="year-control">
                                            <button type="button" class="year-btn prev-year" aria-label="上一年">‹</button>
                                            <div class="year-display" id="end-year-display">2025</div>
                                            <button type="button" class="year-btn next-year" aria-label="下一年">›</button>
                                        </div>
                                    </div>
                                    <div class="month-grid" id="end-month-grid">
                                        <!-- 月份按钮由JS生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="flex: 0 0 18%;">
                            <label for="data-type">数据类型</label>
        <select id="data-type" style="width: 100%; height: 36px; box-sizing: border-box; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
            <option value="charging">充电数据</option>
            <option value="comprehensive">综合数据</option>
        </select>
    </div>
                        
                        <div class="btn-group" style="flex: 0 0 auto; display: flex; gap: 8px; align-items: center;">
                           <button class="query-btn" id="query-btn" style="margin-bottom: 0;">
            <span class="spinner"></span>
            <i class="fas fa-search"></i>
            <span>查询数据</span>
        </button>
        <button class="export-btn" id="report-export-btn" disabled style="margin-bottom: 0;">
            <i class="fas fa-file-excel"></i>
            <span>导出Excel</span>
        </button>
    </div>
</div>
                    <div class="query-info" id="query-info" style="margin-top: 2px; padding: 4px;">
                        <i class="fas fa-info-circle"></i> 
                        请选择日期和数据类型来查询数据
                    </div>
                </div>
                
                <h2 class="section-title"><i class="fas fa-table"></i> 数据报表</h2>
                <!-- Excel 表格区域 -->
                <div class="excel-section" id="report-section">
                    <div class="excel-header">
                        <h3 class="metric-section-title"><i class="fas fa-table"></i> 充电数据报表</h3>
                        <div id="file-info">当前显示: 2025年07月数据</div>
                    </div>
                    
                    <div class="data-loading" id="data-loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载数据，请稍候...
                    </div>
                    
                    <div class="table-container" id="table-container">
                        <!-- Excel表格将在这里渲染 -->
                        <table>
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>场站名称</th>
                                    <th>充电量(kwh)</th>
                                    <th>服务车辆(辆)</th>
                                    <th>收入(元)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="data-info">
                        <div id="row-count">共加载 0 行数据</div>
                        <div id="last-update">最后更新时间: 2025-08-10 14:30:25</div>
                    </div>
                </div>
                
                <!-- 综合数据报表 -->
                <div class="comprehensive-section">
                    <div class="comprehensive-header">
                        <h3 class="metric-section-title"><i class="fas fa-chart-pie"></i> 综合数据报表</h3>
                        <div id="comprehensive-info">当前显示: 2025年07月数据</div>
                    </div>
                    
                    <div class="data-loading" id="comprehensive-loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载综合数据，请稍候...
                    </div>
                    
                    <div class="table-container" id="comprehensive-table-container">
                        <!-- 综合数据报表将在这里渲染 -->
                        <table>
                            <thead>
                                <tr>
                                    <th>指标</th>
                                    <th>四方坪站</th>
                                    <th>高岭站</th>
                                    <th>合计</th>
                                    <th>同比增长</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="data-info">
                        <div id="comprehensive-row-count">共加载 0 行数据</div>
                        <div id="comprehensive-last-update">最后更新时间: 2025-08-10 14:30:25</div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- 页脚 -->
        <footer>
            © 2026 长沙飞狐电动汽车充电服务有限公司 | 新能源充电站数据管理平台
        </footer>
    </div>

    <!-- 在body结束前添加版权信息 -->
    <div class="footer-copyright" id="login-footer-copyright">
        <p>© 2018-2026 长沙飞狐电动汽车充电服务有限公司</p>
    </div>

    <script>
        // Supabase 配置
        // ⚠️ 重要：必须使用 publishable key（公开密钥），不要使用 secret key（密钥）
        // publishable key 可以在 Supabase 项目的 Settings > API 页面找到
        const SUPABASE_URL = 'https://vqrsbezdgiqmfqyxkvyj.supabase.co'; // 您的项目URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxcnNiZXpkZ2lxbWZxeXhrdnlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyOTE2NDIsImV4cCI6MjA4Mzg2NzY0Mn0.vBS46LFUQjOEgD-GQapac4h219sqJPMgA1nbjUDcLM8'; // Supabase anon public key

        // 初始化 Supabase 客户端
        let supabase;
        let supabaseInitialized = false;
        let supabaseInitAttempts = 0;
        const MAX_INIT_ATTEMPTS = 5;

        function initSupabase() {
            try {
                // 检查必要的配置
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    console.error('[Supabase] 配置缺失:', {
                        hasUrl: !!SUPABASE_URL,
                        hasKey: !!SUPABASE_ANON_KEY
                    });
                    return null;
                }

                // 尝试多种方式初始化Supabase客户端
                // CDN加载后，Supabase会挂载到window.supabase对象上
                let createClientFunc = null;

                // 方式1: window.supabase.createClient (CDN加载方式)
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    createClientFunc = window.supabase.createClient;
                    console.log('[Supabase] 检测到 window.supabase.createClient');
                }
                // 方式2: 直接的 createClient 函数
                else if (typeof window.createClient === 'function') {
                    createClientFunc = window.createClient;
                    console.log('[Supabase] 检测到 window.createClient');
                }
                // 方式3: supabaseClient 对象 (UMD格式)
                else if (typeof supabaseClient !== 'undefined' && supabaseClient.createClient) {
                    createClientFunc = supabaseClient.createClient.bind(supabaseClient);
                    console.log('[Supabase] 检测到 supabaseClient.createClient');
                }
                else {
                    console.warn('[Supabase] SDK未加载，尝试等待...', {
                        windowSupabase: typeof window.supabase,
                        windowCreateClient: typeof window.createClient,
                        supabaseClient: typeof supabaseClient,
                        supabaseSDKLoaded: window.supabaseSDKLoaded
                    });
                    return null;
                }

                // 使用找到的createClient函数初始化
                supabase = createClientFunc(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: true, // 启用session持久化，保持登录状态
                        autoRefreshToken: true, // 自动刷新token
                        detectSessionInUrl: true // 检测URL中的session（用于OAuth回调）
                    },
                    db: {
                        schema: 'public'
                    },
                    global: {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY
                        }
                    }
                });

                // 验证客户端是否有效
                if (!supabase || typeof supabase.auth !== 'object') {
                    console.error('[Supabase] 客户端初始化失败：客户端对象无效');
                    return null;
                }

                console.log('[Supabase] 客户端初始化成功，URL:', SUPABASE_URL);
                supabaseInitialized = true;
                return supabase;
            } catch (error) {
                console.error('[Supabase] 初始化异常:', error);
                return null;
            }
        }

        // 等待SDK加载后初始化（带重试机制）
        function ensureSupabase() {
            // 如果已经初始化成功，直接返回
            if (supabaseInitialized && supabase) {
                return supabase;
            }

            // 如果尝试次数过多，返回 null
            if (supabaseInitAttempts >= MAX_INIT_ATTEMPTS) {
                console.error('[Supabase] 初始化失败：已达到最大尝试次数');
                return null;
            }

            supabaseInitAttempts++;
            supabase = initSupabase();

            // 如果初始化失败，尝试等待 SDK 加载
            if (!supabase && supabaseInitAttempts < MAX_INIT_ATTEMPTS) {
                console.log(`[Supabase] 初始化失败，等待 SDK 加载... (尝试 ${supabaseInitAttempts}/${MAX_INIT_ATTEMPTS})`);
                // 不在这里等待，让调用者决定是否重试
            }

            return supabase;
        }

        // 延迟初始化：等待页面和 SDK 完全加载
        function initSupabaseWhenReady() {
            // 如果 SDK 已加载，立即初始化
            if ((window.supabase && typeof window.supabase.createClient === 'function') ||
                (typeof window.createClient === 'function') ||
                (typeof supabaseClient !== 'undefined' && supabaseClient.createClient)) {
                console.log('[Supabase] SDK已检测到，开始初始化');
                ensureSupabase();
                return;
            }

            // 检查SDK加载状态标志
            if (window.supabaseSDKLoaded) {
                // SDK已加载，但可能还没挂载到全局对象，稍等片刻
                console.log('[Supabase] SDK加载标志已设置，等待挂载...');
                setTimeout(() => {
                    ensureSupabase();
                }, 200);
                return;
            }

            // 否则等待一段时间后重试
            let attempts = 0;
            const maxAttempts = 30; // 增加重试次数
            console.log('[Supabase] 开始等待SDK加载...');
            const checkInterval = setInterval(() => {
                attempts++;
                // 检查多种可能的SDK加载方式
                if ((window.supabase && typeof window.supabase.createClient === 'function') ||
                    (typeof window.createClient === 'function') ||
                    (typeof supabaseClient !== 'undefined' && supabaseClient.createClient) ||
                    window.supabaseSDKLoaded) {
                    clearInterval(checkInterval);
                    console.log(`[Supabase] SDK检测成功 (尝试 ${attempts}/${maxAttempts})`);
                    // 再等待一小段时间确保SDK完全初始化
                    setTimeout(() => {
                        ensureSupabase();
                    }, 200);
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.error('[Supabase] SDK 加载超时，请检查网络连接和CDN是否可访问');
                    console.error('[Supabase] 配置信息:', {
                        url: SUPABASE_URL,
                        keyPrefix: SUPABASE_ANON_KEY?.substring(0, 20) + '...'
                    });
                    console.error('[Supabase] 调试信息:', {
                        windowSupabase: typeof window.supabase,
                        windowCreateClient: typeof window.createClient,
                        supabaseSDKLoaded: window.supabaseSDKLoaded
                    });
                } else if (attempts % 5 === 0) {
                    console.log(`[Supabase] 等待SDK加载... (${attempts}/${maxAttempts})`);
                }
            }, 300); // 增加检查间隔
        }

        // 兼容性：创建AV对象以支持旧代码的平滑迁移
        const AV = {
            User: {
                current: () => {
                    const client = ensureSupabase();
                    if (!client) return null;

                    // 从localStorage获取session（Supabase会自动管理）
                    try {
                        const sessionKey = Object.keys(localStorage).find(key => key.includes('supabase.auth.token'));
                        if (sessionKey) {
                            const sessionStr = localStorage.getItem(sessionKey);
                            if (sessionStr) {
                                const session = JSON.parse(sessionStr);
                                if (session?.user) {
                                    return {
                                        getUsername: () => session.user.email || session.user.phone || session.user.id,
                                        get: (key) => session.user[key] || session.user.user_metadata?.[key]
                                    };
                                }
                            }
                        }
                    } catch (e) {
                        console.error('获取session失败:', e);
                    }

                    // 如果localStorage中没有，返回null（异步获取需要修改调用代码）
                    return null;
                },
                logIn: async (username, password) => {
                    const client = ensureSupabase();
                    if (!client) throw new Error('Supabase未初始化');

                    const { data, error } = await client.auth.signInWithPassword({
                        email: username,
                        password: password
                    });
                    if (error) {
                        const err = new Error(error.message);
                        err.code = error.status || 500;
                        throw err;
                    }
                    return {
                        getUsername: () => data.user.email || data.user.phone || data.user.id,
                        get: (key) => data.user[key] || data.user.user_metadata?.[key]
                    };
                },
                logOut: async () => {
                    const client = ensureSupabase();
                    if (client) {
                        await client.auth.signOut();
                    }
                },
                requestPasswordReset: async (email) => {
                    const client = ensureSupabase();
                    if (!client) throw new Error('Supabase未初始化');

                    const { error } = await client.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin + '/reset-password'
                    });
                    if (error) {
                        const err = new Error(error.message);
                        err.code = error.status || 500;
                        throw err;
                    }
                }
            },
            Object: {
                extend: (className) => {
                    return class {
                        constructor() {
                            this.className = className;
                            this.data = {};
                            this.id = null;
                        }
                        set(key, value) {
                            this.data[key] = value;
                        }
                        setACL(acl) {
                            // Supabase使用RLS策略，不需要ACL
                        }
                        async save() {
                            const client = ensureSupabase();
                            if (!client) throw new Error('Supabase未初始化');

                            if (this.id) {
                                // 更新操作
                                const { data, error } = await client
                                    .from(this.className)
                                    .update(this.data)
                                    .eq('id', this.id)
                                    .select()
                                    .single();
                                if (error) throw error;
                                return {
                                    id: data.id,
                                    get: (key) => data[key]
                                };
                            } else {
                                // 插入操作
                                const { data, error } = await client
                                    .from(this.className)
                                    .insert(this.data)
                                    .select()
                                    .single();
                                if (error) throw error;
                                this.id = data.id;
                                return {
                                    id: data.id,
                                    get: (key) => data[key]
                                };
                            }
                        }
                        static createWithoutData(className, id) {
                            const obj = new this();
                            obj.className = className;
                            obj.id = id;
                            return obj;
                        }
                    };
                }
            },
            Query: class {
                constructor(className) {
                    this.className = className;
                    this.filters = [];
                    this.orderBy = null;
                    this.limitCount = null;
                }
                equalTo(key, value) {
                    this.filters.push({ key, value, op: 'eq' });
                    return this;
                }
                descending(key) {
                    this.orderBy = { key, ascending: false };
                    return this;
                }
                limit(count) {
                    this.limitCount = count;
                    return this;
                }
                async find() {
                    const client = ensureSupabase();
                    if (!client) throw new Error('Supabase未初始化');

                    let query = client.from(this.className).select('*');

                    this.filters.forEach(filter => {
                        query = query.eq(filter.key, filter.value);
                    });

                    if (this.orderBy) {
                        query = query.order(this.orderBy.key, { ascending: this.orderBy.ascending });
                    }

                    if (this.limitCount) {
                        query = query.limit(this.limitCount);
                    }

                    const { data, error } = await query;
                    if (error) throw error;

                    return data.map(item => ({
                        id: item.id,
                        get: (key) => item[key]
                    }));
                }
                async get(id) {
                    const client = ensureSupabase();
                    if (!client) throw new Error('Supabase未初始化');

                    const { data, error } = await client
                        .from(this.className)
                        .select('*')
                        .eq('id', id)
                        .single();
                    if (error) throw error;
                    return {
                        id: data.id,
                        get: (key) => data[key]
                    };
                }
            },
            Cloud: {
                run: async (functionName, params) => {
                    const client = ensureSupabase();
                    if (!client) throw new Error('Supabase未初始化');

                    // 确保传递正确的认证头
                    const { data, error } = await client.functions.invoke(functionName, {
                        body: params,
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'apikey': SUPABASE_ANON_KEY
                        }
                    });
                    if (error) throw error;
                    return data;
                }
            }
        };

        // 页面加载完成后初始化Supabase
        // 页面加载完成后初始化 Supabase
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initSupabaseWhenReady();
            });
        } else {
            initSupabaseWhenReady();
        }

        // 也监听 window.load 事件，确保所有资源都已加载
        window.addEventListener('load', () => {
            if (!supabaseInitialized) {
                console.log('[Supabase] 窗口加载完成，再次尝试初始化');
                initSupabaseWhenReady();
            }
        });
        
                // 登录记录相关函数
        // 记录用户登录
        async function recordUserLogin(username, additionalData = {}) {
            try {
                const client = ensureSupabase();
                if (!client) {
                    console.error('Supabase未初始化，无法记录登录信息');
                    return {
                        success: false,
                        error: 'Supabase未初始化'
                    };
                }

                // 获取真实IP地址
                const clientIP = await getClientIP();

                // 准备插入到Supabase login_records表的数据
                // 注意：字段名使用下划线命名（与数据库表结构一致）
                const loginData = {
                    user_name: username,
                    username: username,
                    login_time: new Date().toISOString(),
                    user_agent: navigator.userAgent,
                    device_info: getDeviceInfo(),
                    page: window.location.href,
                    ip_address: clientIP,
                    session_id: 'web_session_' + Date.now(),
                    login_method: additionalData.loginMethod || 'web_form',
                    phone: additionalData.phone || null
                };

                // 添加额外数据（如果有）
                if (additionalData.timestamp) {
                    // timestamp字段不需要，因为login_time已经包含了
                }

                // 插入到Supabase
                const { data: savedRecord, error: insertError } = await client
                    .from('login_records')
                    .insert(loginData)
                    .select()
                    .single();

                if (insertError) {
                    console.error('保存登录记录失败:', insertError);
                    throw insertError;
                }

                // 记录最近一次登录记录ID，便于快速更新logout_time
                try {
                    window.__lastLoginRecordId = savedRecord.id;
                    localStorage.setItem('lastLoginRecordId', savedRecord.id);
                } catch (e) {
                    console.warn('保存登录记录ID到本地存储失败:', e);
                }

                console.log('登录记录已保存:', {
                    id: savedRecord.id,
                    username: savedRecord.username,
                    login_time: savedRecord.login_time
                });

                return {
                    success: true,
                    recordId: savedRecord.id,
                    loginTime: savedRecord.login_time,
                    ipAddress: clientIP,
                    message: '登录记录已保存'
                };

            } catch (error) {
                // 记录详细错误信息，但不抛出错误，避免影响正常登录流程
                console.error('记录登录信息时发生错误:', {
                    error: error,
                    message: error.message,
                    username: username
                });
                return {
                    success: false,
                    error: error.message || '未知错误'
                };
            }
        }

        // 获取用户登录历史
        async function getUserLoginHistory(username, limit = 10) {
            try {
                const client = ensureSupabase();
                if (!client) {
                    console.error('Supabase未初始化，无法获取登录历史');
                    return {
                        success: false,
                        error: 'Supabase未初始化',
                        records: []
                    };
                }

                // 从Supabase查询登录历史
                const { data: records, error: queryError } = await client
                    .from('login_records')
                    .select('*')
                    .eq('username', username)
                    .order('login_time', { ascending: false })
                    .limit(limit);

                if (queryError) {
                    console.error('查询登录历史失败:', queryError);
                    throw queryError;
                }

                // 转换数据格式（保持向后兼容）
                const loginHistory = (records || []).map(record => ({
                    id: record.id,
                    username: record.username,
                    loginTime: record.login_time,
                    userAgent: record.user_agent,
                    ipAddress: record.ip_address,
                    deviceInfo: record.device_info,
                    page: record.page,
                    logoutTime: record.logout_time,
                    loginMethod: record.login_method
                }));

                return {
                    success: true,
                    records: loginHistory,
                    total: loginHistory.length
                };

            } catch (error) {
                console.error('获取登录历史时发生错误:', error);
                return {
                    success: false,
                    error: error.message || '未知错误',
                    records: []
                };
            }
        }
        
        // 获取客户端IP地址
        async function getClientIP() {
            try {
                // 方法1: 使用免费的IP查询服务
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                try {
                    // 方法2: 使用备用服务
                    const response = await fetch('https://httpbin.org/ip');
                    const data = await response.json();
                    return data.origin.split(',')[0].trim();
                } catch (error2) {
                    // 方法3: 使用WebRTC获取本地IP（可能被阻止）
                    return await getLocalIP();
                }
            }
        }
		// 添加记录用户登出信息的函数
		async function recordUserLogout(username) {
            try {
                const client = ensureSupabase();
                if (!client) {
                    console.error('Supabase未初始化，无法记录登出信息');
                    return {
                        success: false,
                        error: 'Supabase未初始化'
                    };
                }

				// 优先使用本地缓存的最近一次登录记录ID，避免查询耗时导致未能及时保存
				let cachedRecordId = null;
				try {
					cachedRecordId = window.__lastLoginRecordId || localStorage.getItem('lastLoginRecordId');
				} catch (e) {
					console.warn('获取缓存的登录记录ID失败:', e);
				}

				if (cachedRecordId) {
					try {
						// 直接更新Supabase中的记录
						const { data: updatedRecord, error: updateError } = await client
							.from('login_records')
							.update({
								logout_time: new Date().toISOString(),
								updated_at: new Date().toISOString()
							})
							.eq('id', cachedRecordId)
							.select()
							.single();

						if (updateError) {
							console.warn('快速更新登出时间失败，将尝试查询:', updateError);
						} else {
							// 清除本地缓存的记录ID
							try {
								if (window.__lastLoginRecordId === cachedRecordId) {
									window.__lastLoginRecordId = null;
								}
								localStorage.removeItem('lastLoginRecordId');
							} catch (e) {
							}
							clearLoginStatus();

							console.log('登出信息已记录:', updatedRecord.id);
							return {
								success: true,
								recordId: cachedRecordId,
								message: '登出信息已记录'
							};
						}
					} catch (fastUpdateError) {
						console.warn('快速更新失败，将尝试查询:', fastUpdateError);
					}
				}

                // 查询当前用户的最新登录记录（如果没有缓存ID或快速更新失败）
                const { data: records, error: queryError } = await client
                    .from('login_records')
                    .select('*')
                    .eq('username', username)
                    .is('logout_time', null)  // 只查找未登出的记录
                    .order('login_time', { ascending: false })
                    .limit(1);

                if (queryError) {
                    console.error('查询登录记录失败:', queryError);
                    throw queryError;
                }

                if (records && records.length > 0) {
                    const loginRecord = records[0];

					// 更新登出时间
					const { data: updatedRecord, error: updateError } = await client
						.from('login_records')
						.update({
							logout_time: new Date().toISOString(),
							updated_at: new Date().toISOString()
						})
						.eq('id', loginRecord.id)
						.select()
						.single();

					if (updateError) {
						console.error('更新登出时间失败:', updateError);
						throw updateError;
					}

					// 清除本地缓存的记录ID，避免重复更新
					try {
						if (window.__lastLoginRecordId === loginRecord.id) {
							window.__lastLoginRecordId = null;
						}
						localStorage.removeItem('lastLoginRecordId');
					} catch (e) {
					}
					// 清除登录状态
					clearLoginStatus();

					console.log('登出信息已记录:', updatedRecord.id);
                    return {
                        success: true,
                        recordId: loginRecord.id,
                        message: '登出信息已记录'
                    };
                } else {
                    console.warn('未找到未登出的登录记录');
                    return {
                        success: false,
                        error: '未找到登录记录'
                    };
                }
            } catch (error) {
                console.error('记录登出信息时发生错误:', error);
                return {
                    success: false,
                    error: error.message || '未知错误'
                };
            }
        }
        
        // 通过WebRTC获取本地IP地址
        async function getLocalIP() {
            return new Promise((resolve) => {
                try {
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    });
                    
                    pc.createDataChannel('');
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));
                    
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            const candidate = event.candidate.candidate;
                            const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/);
                            if (ipMatch) {
                                pc.close();
                                resolve(ipMatch[1]);
                            }
                        }
                    };
                    
                    // 超时处理
                    setTimeout(() => {
                        pc.close();
                        resolve('未知IP');
                    }, 3000);
                } catch (error) {
                    resolve('未知IP');
                }
            });
        }

        // 检查用户是否被授权的函数（迁移到Supabase）
        async function checkUserAuthorization(usernameOrEmail) {
            try {
                const client = ensureSupabase();
                if (!client) {
                    console.error('Supabase未初始化');
                    return false;
                }

                // 从Supabase的authorized_users表查询
                // 目前只支持通过username检查
                const { data, error } = await client
                    .from('authorized_users')
                    .select('username')
                    .eq('username', usernameOrEmail)
                    .maybeSingle();

                if (error) {
                    // 如果查询出错（如用户不存在），返回false
                    if (error.code === 'PGRST116') {
                        // 这是"未找到记录"的错误，不是真正的错误
                        console.log('授权检查: 用户未在授权列表中', usernameOrEmail);
                        return false;
                    }
                    console.error('授权检查失败:', error);
                    return false;
                }

                // 如果找到记录，说明用户已授权
                const isAuthorized = data !== null;
                console.log('授权检查结果:', usernameOrEmail, isAuthorized ? '已授权' : '未授权');
                return isAuthorized;

            } catch (error) {
                // 查询失败时拒绝授权，确保安全
                console.error('授权检查异常:', error);
                return false;
            }
        }
        
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            
            let device = 'Desktop';
            if (/Mobile|Android|iPhone|iPod|BlackBerry|IEMobile/.test(ua)) {
                device = 'Mobile';
            } else if (/Tablet|iPad/.test(ua)) {
                device = 'Tablet';
            }
        
            let browser = 'Unknown';
            if (ua.includes('Chrome')) browser = 'Chrome';
            else if (ua.includes('Firefox')) browser = 'Firefox';
            else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
            else if (ua.includes('Edge')) browser = 'Edge';
        
            return `${device} - ${browser}`;
        }

        
        // 初始化登录系统（确保DOM加载完成后再执行）
        function initLoginSystem() {
            // 获取DOM元素
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const resetForm = document.getElementById('resetForm');
            const loginMessage = document.getElementById('loginMessage');
            
            if (!loginForm || !registerForm || !resetForm || !loginMessage) {
                console.error('登录表单元素未找到，请检查DOM结构');
                return;
            }
            
            const showReset = document.getElementById('showReset');
            const showRegister = document.getElementById('showRegister');
            const showSmsLogin = document.getElementById('showSmsLogin');
            const backToLoginFromRegister = document.getElementById('backToLoginFromRegister');
            const backToLoginFromReset = document.getElementById('backToLoginFromReset');
            const backToLoginFromSms = document.getElementById('backToLoginFromSms');
            
            // 显示消息
            function showMessage(message, type) {
                loginMessage.textContent = message;
                loginMessage.className = 'message ' + type;
                loginMessage.style.display = 'block';
            }
            
            // 隐藏消息
            function hideMessage() {
                loginMessage.style.display = 'none';
            }
            
            // 表单切换
            if (showReset) {
                showReset.addEventListener('click', (e) => {
                    e.preventDefault();
                    loginForm.style.display = 'none';
                    resetForm.style.display = 'block';
                    registerForm.style.display = 'none';
                    document.getElementById('smsLoginForm').style.display = 'none';
                    hideMessage();
                    // 修改标题为"密码重置"
                    document.getElementById('form-title').textContent = '密码重置';
                    // 修改图标为钥匙图标
                    document.querySelector('#login-container .logo i').className = 'fas fa-key';
                });
            }
            
            if (showRegister) {
                showRegister.addEventListener('click', (e) => {
                    e.preventDefault();
                    loginForm.style.display = 'none';
                    resetForm.style.display = 'none';
                    registerForm.style.display = 'block';
                    document.getElementById('smsLoginForm').style.display = 'none';
                    hideMessage();
                    // 修改标题为"新用户注册"
                    document.getElementById('form-title').textContent = '新用户注册';
                    // 修改图标为用户添加图标
                    document.querySelector('#login-container .logo i').className = 'fas fa-user-plus';
                });
            }
            
            if (showSmsLogin) {
                showSmsLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    loginForm.style.display = 'none';
                    resetForm.style.display = 'none';
                    registerForm.style.display = 'none';
                    document.getElementById('smsLoginForm').style.display = 'block';
                    hideMessage();
                    // 修改标题为"短信验证码登录"
                    document.getElementById('form-title').textContent = '短信验证码登录';
                    // 修改图标为手机图标
                    document.querySelector('#login-container .logo i').className = 'fas fa-mobile-alt';
                });
            }
            
            if (backToLoginFromRegister) {
                backToLoginFromRegister.addEventListener('click', (e) => {
                    e.preventDefault();
                    loginForm.style.display = 'block';
                    resetForm.style.display = 'none';
                    registerForm.style.display = 'none';
                    document.getElementById('smsLoginForm').style.display = 'none';
                    hideMessage();
                    // 修改标题为"用户登录"
                    document.getElementById('form-title').textContent = '用户登录';
                    // 重置图标为登录图标
                    document.querySelector('#login-container .logo i').className = 'fas fa-user-lock';
                });
            }
            
            if (backToLoginFromReset) {
                backToLoginFromReset.addEventListener('click', (e) => {
                    e.preventDefault();
                    loginForm.style.display = 'block';
                    resetForm.style.display = 'none';
                    registerForm.style.display = 'none';
                    document.getElementById('smsLoginForm').style.display = 'none';
                    hideMessage();
                    // 修改标题为"用户登录"
                    document.getElementById('form-title').textContent = '用户登录';
                    // 重置图标为登录图标
                    document.querySelector('#login-container .logo i').className = 'fas fa-user-lock';
                });
            }
            
            if (backToLoginFromSms) {
                backToLoginFromSms.addEventListener('click', (e) => {
                    e.preventDefault();
                    loginForm.style.display = 'block';
                    resetForm.style.display = 'none';
                    registerForm.style.display = 'none';
                    document.getElementById('smsLoginForm').style.display = 'none';
                    hideMessage();
                    // 修改标题为"用户登录"
                    document.getElementById('form-title').textContent = '用户登录';
                    // 重置图标为登录图标
                    document.querySelector('#login-container .logo i').className = 'fas fa-user-lock';
                });
            }
            
            // 登录处理
            loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const loginInput = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                let client = ensureSupabase();

                // 如果初始化失败，尝试再次初始化
                if (!client) {
                    console.warn('[登录] Supabase 未初始化，尝试重新初始化...');
                    supabaseInitialized = false;
                    supabaseInitAttempts = 0;
                    client = ensureSupabase();
                }

                if (!client) {
                    console.error('[登录] Supabase 初始化失败');
                    showMessage('系统初始化失败：Supabase SDK 未正确加载。请检查网络连接并刷新页面重试', 'error');
                    return;
                }

                // 判断输入的是邮箱还是用户名
                const isEmail = loginInput.includes('@');
                let email = loginInput;
                let username = loginInput;

                // 如果输入的是用户名（不包含@），提示用户使用邮箱登录
                if (!isEmail) {
                    showMessage('登录失败: 请使用注册时的邮箱地址登录', 'error');
                    return;
                }

                // 使用邮箱登录Supabase
                console.log('尝试登录:', { email: email, hasPassword: !!password });
                const { data: authData, error: authError } = await client.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (authError) {
                    console.error('Supabase登录错误:', {
                        message: authError.message,
                        status: authError.status,
                        code: authError.code
                    });
                    throw authError;
                }

                console.log('登录成功:', { userId: authData.user?.id, email: authData.user?.email });

                // 获取用户名（从user metadata或email）
                const actualUsername = authData.user.user_metadata?.username ||
                                      authData.user.email?.split('@')[0] ||
                                      email.split('@')[0];

                // 检查用户是否被授权（通过username或email）
                const isAuthorized = await checkUserAuthorization(actualUsername) ||
                                    await checkUserAuthorization(email);

                if (!isAuthorized) {
                    // 登出用户
                    await client.auth.signOut();
                    showMessage('登录失败: 该用户未获得访问授权！', 'error');
                    return;
                }

                showMessage(`登录成功！欢迎回来，${actualUsername}`, 'success');

                // 保存登录状态
                saveLoginStatus(actualUsername, 'web_form');

                // 立即隐藏登录框并显示主页面
                showMainPage(actualUsername);

                // 在后台记录登录信息，不影响用户界面响应
                try {
                    const loginResult = await recordUserLogin(actualUsername, {
                        loginMethod: 'web_form',
                        timestamp: new Date().toISOString()
                    });
                    if (loginResult && loginResult.success) {
                        console.log('登录记录保存成功:', loginResult.recordId);
                    } else {
                        console.error('登录记录保存失败:', loginResult?.error);
                    }
                } catch (recordError) {
                    console.error('记录登录信息时发生异常:', recordError);
                }

            } catch (error) {
                // 详细的错误日志用于调试
                console.error('登录错误详情:', {
                    message: error.message,
                    status: error.status,
                    code: error.code,
                    error: error
                });

                // 根据错误类型提供更友好的提示（Supabase错误处理）
                if (error.message?.includes('Invalid login credentials') ||
                    error.message?.includes('invalid') ||
                    error.status === 400) {
                    showMessage('登录失败: 用户名或密码错误。如果这是首次登录，请先注册账户。', 'error');
                } else if (error.message?.includes('Email not confirmed')) {
                    showMessage('登录失败: 请先验证您的邮箱。请检查注册邮箱中的确认链接，或联系管理员在Supabase Dashboard中手动确认您的账户。', 'error');
                } else if (error.message?.includes('User not found')) {
                    showMessage('登录失败: 用户不存在。请先注册账户或检查邮箱地址是否正确。', 'error');
                } else if (error.message?.includes('network') || error.message?.includes('fetch')) {
                    showMessage('登录失败: 网络连接错误。请检查网络连接和Supabase配置。', 'error');
                } else {
                    showMessage(`登录失败: ${error.message || '未知错误'}。请检查控制台获取详细信息。`, 'error');
                }
            }
        });
        
        // 注册处理
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const email = document.getElementById('registerEmail').value;

            try {
                // 首先检查用户是否被授权
                const isAuthorized = await checkUserAuthorization(username);
                if (!isAuthorized) {
                    showMessage('注册失败: 该用户未获得授权！', 'error');
                    return;
                }

                // 如果用户被授权，则尝试创建账户
                const client = ensureSupabase();
                if (!client) {
                    showMessage('系统初始化失败，请刷新页面重试', 'error');
                    return;
                }

                console.log('开始注册用户:', { email, username });

                const { data, error } = await client.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            username: username
                        }
                    }
                });

                if (error) {
                    console.error('Supabase注册错误:', error);
                    throw error;
                }

                console.log('注册响应:', {
                    user: data.user ? { id: data.user.id, email: data.user.email } : null,
                    session: data.session ? '已创建会话' : '无会话（需要邮箱确认）'
                });

                // 如果注册成功，确保authorized_users表中有记录
                if (data.user) {
                    try {
                        // 确保authorized_users表中有该用户的记录（使用upsert，如果存在则更新，不存在则插入）
                        const { data: authUserData, error: authUserError } = await client
                            .from('authorized_users')
                            .upsert({
                                username: username,
                                updated_at: new Date().toISOString()
                            }, {
                                onConflict: 'username'
                            })
                            .select();

                        if (authUserError) {
                            console.warn('无法在authorized_users表中创建/更新记录:', authUserError.message);
                        } else {
                            console.log('已在authorized_users表中创建/更新记录:', authUserData);
                        }
                    } catch (authError) {
                        console.warn('同步到authorized_users表时出错:', authError.message);
                    }
                }

                // 如果注册成功，尝试在自定义users表中创建记录（如果表存在）
                if (data.user) {
                    try {
                        // 先尝试查询表结构，确定id字段类型
                        // 尝试向自定义users表插入数据
                        // 注意：如果表的id是bigint类型，我们不插入id，让数据库自动生成
                        const insertData = {
                            email: email,
                            username: username,
                            created_at: new Date().toISOString()
                        };

                        // 先尝试包含id（如果表使用UUID）
                        const { data: userData, error: userError } = await client
                            .from('users')
                            .insert({
                                id: data.user.id,
                                ...insertData
                            })
                            .select();

                        if (userError) {
                            // 如果是因为id类型不匹配，尝试不插入id
                            if (userError.message?.includes('bigint') || userError.message?.includes('invalid input syntax')) {
                                console.warn('users表的id字段类型不匹配（可能是bigint而不是UUID），尝试不插入id字段');

                                // 尝试不插入id，或者使用auth_user_id字段
                                const { data: userData2, error: userError2 } = await client
                                    .from('users')
                                    .insert({
                                        ...insertData,
                                        auth_user_id: data.user.id  // 使用单独的字段存储auth.users的id
                                    })
                                    .select();

                                if (userError2) {
                                    // 如果还是失败，尝试完全不包含id相关字段
                                    const { data: userData3, error: userError3 } = await client
                                        .from('users')
                                        .insert(insertData)
                                        .select();

                                    if (userError3) {
                                        console.warn('无法在users表中创建记录。请检查表结构是否正确。错误:', userError3.message);
                                        console.warn('提示：users表的id字段应该是UUID类型，或者需要创建auth_user_id字段来关联auth.users表');
                                    } else {
                                        console.log('已在users表中创建记录（未包含id）:', userData3);
                                    }
                                } else {
                                    console.log('已在users表中创建记录（使用auth_user_id）:', userData2);
                                }
                            } else {
                                // 其他错误
                                console.warn('无法在users表中创建记录:', userError.message);
                                console.warn('提示：请检查users表是否存在，以及RLS策略是否正确设置');
                            }
                        } else {
                            console.log('已在users表中创建记录:', userData);
                        }
                    } catch (syncError) {
                        // 忽略同步错误，不影响注册流程
                        console.warn('同步到users表时出错:', syncError.message);
                    }
                }

                // 检查是否需要邮箱确认
                if (data.user && !data.session) {
                    // 需要邮箱确认 - 使用弹窗提示
                    alert('请查看邮箱，点击链接确认，方可正常登录！');
                    showMessage('账户创建成功！请查看邮箱（' + email + '），点击确认链接后方可正常登录。', 'success');
                } else {
                    // 已自动确认，可以直接登录
                    showMessage('账户创建成功！请使用新账户登录。', 'success');
                }

                // 自动切换回登录表单
                setTimeout(() => {
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';
                    document.getElementById('loginUsername').value = email;
                    document.getElementById('loginPassword').value = '';
                }, 2000);

            } catch (error) {
                console.error('注册过程出错:', error);
                // Supabase错误代码映射
                if (error.message?.includes('already registered') || error.message?.includes('already exists')) {
                    showMessage('注册失败: 该邮箱已经被使用，请直接使用登录功能', 'error');
                } else if (error.message?.includes('email')) {
                    showMessage('注册失败: 邮箱格式不正确', 'error');
                } else if (error.message?.includes('password')) {
                    showMessage('注册失败: 密码不符合要求', 'error');
                } else {
                    const errorMsg = error.message || error.toString() || '未知错误';
                    console.error('注册失败详情:', {
                        message: errorMsg,
                        status: error.status,
                        code: error.code
                    });
                    showMessage(`注册失败: ${errorMsg}`, 'error');
                }
            }
        });
        
        // 重置密码处理
        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            
            try {
                await AV.User.requestPasswordReset(email);
                showMessage('密码重置邮件已发送，请检查您的邮箱。', 'success');
                
                // 自动切换回登录表单
                setTimeout(() => {
                    loginForm.style.display = 'block';
                    resetForm.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                showMessage(`密码重置失败: ${error.message}`, 'error');
            }
        });
        
            // 短信验证码登录处理
            const smsLoginForm = document.getElementById('smsLoginForm');
            const sendSmsCodeBtn = document.getElementById('sendSmsCode');
            const smsPhoneInput = document.getElementById('smsPhone');
            const smsCodeInput = document.getElementById('smsCode');
            
            if (!smsLoginForm || !sendSmsCodeBtn || !smsPhoneInput || !smsCodeInput) {
                console.warn('短信登录表单元素未找到，短信登录功能可能不可用');
            } else {
                // 发送验证码
                sendSmsCodeBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            const phone = smsPhoneInput.value.trim();

            // 验证手机号格式
            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(phone)) {
                showMessage('请输入正确的手机号码', 'error');
                return;
            }

            try {
                showMessage('正在发送验证码...', 'info');
                sendSmsCodeBtn.disabled = true;
                sendSmsCodeBtn.textContent = '发送中...';

                // 直接使用 fetch 调用 Supabase Edge Function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/sendSmsCode`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({ phone: phone })
                });

                console.log('Send SMS response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Send SMS error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('Send SMS result:', result);

                if (result.success) {
                    showMessage('验证码已发送，请查收短信', 'success');
                    startCountdown();
                } else {
                    showMessage(result.message || '发送失败，请重试', 'error');
                    sendSmsCodeBtn.disabled = false;
                    sendSmsCodeBtn.textContent = '发送验证码';
                }

                    } catch (error) {
                        console.error('Send SMS code error:', error);
                        showMessage(`发送失败: ${error.message}`, 'error');
                        sendSmsCodeBtn.disabled = false;
                        sendSmsCodeBtn.textContent = '发送验证码';
                    }
                });
                
                // 短信验证码登录提交
                smsLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const phone = smsPhoneInput.value.trim();
            const code = smsCodeInput.value.trim();

            if (!phone || !code) {
                showMessage('请填写手机号和验证码', 'error');
                return;
            }

            try {
                showMessage('正在验证...', 'info');

                // 直接使用 fetch 调用 Supabase Edge Function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/verifySmsCode`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({ phone: phone, code: code })
                });

                console.log('Verify SMS response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Verify SMS error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('Verify SMS result:', result);

                if (result.success) {
                    showMessage('登录成功！欢迎回来', 'success');

                    // 保存登录状态
                    saveLoginStatus(phone, 'sms', phone);

                    // 记录登录（异步后台执行，不阻塞页面跳转）
                    recordUserLogin(phone, {
                        loginMethod: 'sms',
                        phone: phone
                    }).catch(error => {
                        console.error('登录记录保存失败:', error);
                        // 不影响登录流程，静默失败
                    });

                    // 立即显示主页面，不等待登录记录保存
                    showMainPage(phone);

                } else {
                    showMessage(result.message || '验证失败，请检查验证码', 'error');
                }

            } catch (error) {
                console.error('Verify SMS code error:', error);
                showMessage(`登录失败: ${error.message}`, 'error');
            }
                });
                
                // 倒计时功能
                function startCountdown() {
                    let countdown = 60;
                    sendSmsCodeBtn.textContent = `${countdown}秒后重发`;
                    sendSmsCodeBtn.classList.add('countdown');
                    
                    const timer = setInterval(() => {
                        countdown--;
                        sendSmsCodeBtn.textContent = `${countdown}秒后重发`;
                        
                        if (countdown <= 0) {
                            clearInterval(timer);
                            sendSmsCodeBtn.disabled = false;
                            sendSmsCodeBtn.textContent = '发送验证码';
                            sendSmsCodeBtn.classList.remove('countdown');
                        }
                    }, 1000);
                }
            }
        }
        
        // 初始化主页面系统函数（优化版：延迟加载）
        function initMainSystem() {
            // 立即执行的初始化（不涉及网络请求）
            initMobileMenu();
            initMenuEvents();
            initDatePickers();
            initCustomDatePickers();
            initCharts();
            startClock();
            initChargingBoardExport();
            
            // 加载默认数据（静默加载，不阻塞）
            loadDefaultData();

            // 优先级1：立即加载主页可见的关键数据（延迟100ms，让页面先渲染）
            setTimeout(() => {
                loadMetricsData(); // 主页指标数据
                loadIncomeDashboardData(); // 主页收入看板
            }, 100);
            
            // 优先级2：延迟加载主页其他数据（延迟500ms）
            setTimeout(() => {
                loadChargingBoardData(); // 充电数据看板
                loadRealtimeData(); // 实时数据
            }, 500);
            
            // 优先级3：延迟加载非关键数据（延迟1000ms，或在用户访问时加载）
            setTimeout(() => {
                loadSiteStatsData(); // 站点数据统计（在站点统计页面才需要）
                loadUnchargedData(); // 未充电时长统计（在相应页面才需要）
            }, 1000);
            
			// 添加页面关闭相关事件监听器，尽量在卸载前完成登出记录
			window.addEventListener('beforeunload', handlePageUnload);
			// 当页面变为隐藏状态时（切到后台或关闭前），优先尝试记录登出，并销毁Canvas
			document.addEventListener('visibilitychange', async () => {
				try {
					// 当页面不可见时，彻底销毁Canvas实例和requestAnimationFrame循环
					if (document.hidden) {
						stopStarfield();
					}
					
					const currentUser = AV.User.current();
					if (document.hidden && currentUser && !window.__logoutRecordingInProgress) {
						window.__logoutRecordingInProgress = true;
						await recordUserLogout(currentUser.getUsername());
					}
				} finally {
					window.__logoutRecordingInProgress = false;
				}
			});
			// Safari等浏览器更可靠的卸载事件
			window.addEventListener('pagehide', async () => {
				try {
					const currentUser = AV.User.current();
					if (currentUser && !window.__logoutRecordingInProgress) {
						window.__logoutRecordingInProgress = true;
						await recordUserLogout(currentUser.getUsername());
					}
				} finally {
					window.__logoutRecordingInProgress = false;
				}
			});
        }
        
        // 处理页面关闭事件
        async function handlePageUnload(event) {
            // 清理会话超时计时器
            if (sessionTimeoutTimer) {
                clearTimeout(sessionTimeoutTimer);
                sessionTimeoutTimer = null;
            }
            
            // 获取当前登录用户
            const currentUser = AV.User.current();
            if (currentUser) {
                
                // 记录登出信息
                try {
                    const logoutResult = await recordUserLogout(currentUser.getUsername());
                    if (logoutResult.success) {
                    } else {
                    }
                } catch (error) {
                }
            }
        }
        
        // 初始化菜单事件
        function initMenuEvents() {
            // 可以在这里添加其他菜单事件
        }


        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('mobile-open');
                });
                
                // 点击主内容区域时关闭菜单
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.addEventListener('click', function() {
                        sidebar.classList.remove('mobile-open');
                    });
                }
                
                // 监听窗口尺寸变化，自动显示/隐藏移动端菜单按钮
                function checkMobileView() {
                    if (window.innerWidth <= 900) {
                        mobileMenuToggle.style.display = 'block';
                    } else {
                        mobileMenuToggle.style.display = 'none';
                        sidebar.classList.remove('mobile-open');
                    }
                }
                
                // 初始检查
                checkMobileView();
                
                // 监听窗口尺寸变化
                window.addEventListener('resize', checkMobileView);
            }
        }
        
        // 主页面相关变量
        const mainContainer = document.getElementById('main-container');
        const userDisplay = document.getElementById('user-display');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const dataTypeSelect = document.getElementById('data-type');
        const queryBtn = document.getElementById('query-btn');
        const exportBtn = document.getElementById('report-export-btn');
        const queryInfo = document.getElementById('query-info');
        const tableContainer = document.getElementById('table-container');
        const dataLoading = document.getElementById('data-loading');
        const fileInfo = document.getElementById('file-info');
        const rowCount = document.getElementById('row-count');
        const lastUpdate = document.getElementById('last-update');
        
        // 综合数据报表元素
        const comprehensiveTableContainer = document.getElementById('comprehensive-table-container');
        const comprehensiveLoading = document.getElementById('comprehensive-loading');
        const comprehensiveInfo = document.getElementById('comprehensive-info');
        const comprehensiveRowCount = document.getElementById('comprehensive-row-count');
        const comprehensiveLastUpdate = document.getElementById('comprehensive-last-update');
        
        // 功能提示弹窗元素
        const featurePopup = document.getElementById('feature-popup');
        const closePopup = document.getElementById('close-popup');
        const confirmPopup = document.getElementById('confirm-popup');
        const popupContent = document.getElementById('popup-content');
        
        // 当前加载的Excel数据
        let currentExcelData = null;
        let currentFileName = '';
        let currentDataType = 'charging';
        let defaultChargingData = null;
        let defaultComprehensiveData = null;
        let defaultChargingFileName = '';
        let defaultComprehensiveFileName = '';
        
        // 导出相关变量
        let currentExportData = null;
        let currentExportFileName = '';
        let currentExportDataType = '';
        
        // 自定义日期选择器变量
        let startYear = 2025;
        let startMonth = null;
        let endYear = 2025;
        let endMonth = null;

        
        // 图表实例
        let chargingChart = null;
        let incomeChart = null;
        let chargingTrendChart = null;
        let revenueBySectorChart = null;
        let annualRevenueTrendChart = null;
        let electricityPieChart = null; // 尖峰平谷饼图（已废弃）
        let electricityPieChartSFP = null; // 四方坪站尖峰平谷饼图
        let electricityPieChartGL = null; // 高岭站尖峰平谷饼图
        
        // GitHub数据文件URL
        const metricsDataUrl = 'https://www.csfhcdz.cn/data/homepage.xlsx';
        
        // ========== 性能优化：资源缓存管理器 ==========
        const resourceCache = {
            cache: new Map(),
            loading: new Map(),
            cacheTimestamps: new Map(), // 记录缓存时间
            cacheDuration: 5 * 60 * 1000, // 默认缓存5分钟
            
            // 获取基础URL（去除查询参数）
            getBaseUrl(url) {
                try {
                    const urlObj = new URL(url);
                    return urlObj.origin + urlObj.pathname;
                } catch {
                    return url.split('?')[0];
                }
            },
            
            // 检查缓存是否过期
            isCacheValid(baseUrl) {
                if (!this.cache.has(baseUrl) || !this.cacheTimestamps.has(baseUrl)) {
                    return false;
                }
                const timestamp = this.cacheTimestamps.get(baseUrl);
                const now = Date.now();
                return (now - timestamp) < this.cacheDuration;
            },
            
            // 获取资源（带缓存）
            async get(url, options = {}) {
                // 对于带时间戳的URL，使用基础URL进行缓存
                const baseUrl = this.getBaseUrl(url);
                // 如果明确设置了forceCache: false，则不使用缓存
                const useCache = options.forceCache !== false;
                const hasTimestamp = url.includes('?t=');
                
                // 对于实时数据（带时间戳），默认不使用缓存，除非明确指定
                if (hasTimestamp && !options.forceCache) {
                    // 实时数据：仍然检查是否有正在进行的加载，避免重复请求
                    if (this.loading.has(baseUrl)) {
                        return this.loading.get(baseUrl);
                    }
                } else {
                    // 静态数据：如果使用缓存且缓存有效，直接返回
                    if (useCache && this.isCacheValid(baseUrl)) {
                        return Promise.resolve(this.cache.get(baseUrl));
                    }
                    
                    // 如果正在加载中，等待加载完成
                    if (this.loading.has(baseUrl)) {
                        return this.loading.get(baseUrl);
                    }
                }
                
                // 开始加载
                const loadPromise = fetch(url, options)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to load ${url}: ${response.statusText}`);
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        const data = new Uint8Array(arrayBuffer);
                        const workbook = XLSX.read(data, { type: 'array' });
                        // 缓存结果（使用基础URL作为key）
                        // 只有明确允许缓存或不是实时数据时才缓存
                        if (useCache && (!hasTimestamp || options.forceCache === true)) {
                            this.cache.set(baseUrl, workbook);
                            this.cacheTimestamps.set(baseUrl, Date.now());
                        }
                        this.loading.delete(baseUrl);
                        return workbook;
                    })
                    .catch(error => {
                        this.loading.delete(baseUrl);
                        throw error;
                    });
                
                this.loading.set(baseUrl, loadPromise);
                return loadPromise;
            },
            
            // 清除缓存
            clear(url) {
                if (url) {
                    const baseUrl = this.getBaseUrl(url);
                    this.cache.delete(baseUrl);
                    this.cacheTimestamps.delete(baseUrl);
                } else {
                    this.cache.clear();
                    this.cacheTimestamps.clear();
                }
                this.loading.clear();
            },
            
            // 预加载资源
            async preload(urls) {
                return Promise.all(urls.map(url => this.get(url).catch(() => null)));
            }
        };
        
        // ========== 性能优化：延迟加载管理器 ==========
        const lazyLoadManager = {
            loaded: new Set(),
            loading: new Set(),
            
            // 延迟加载函数
            async load(id, loader, priority = 0) {
                if (this.loaded.has(id)) {
                    return Promise.resolve();
                }
                
                if (this.loading.has(id)) {
                    return new Promise((resolve) => {
                        const checkInterval = setInterval(() => {
                            if (this.loaded.has(id)) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                    });
                }
                
                this.loading.add(id);
                try {
                    await loader();
                    this.loaded.add(id);
                } catch (error) {
                    console.error(`Failed to load ${id}:`, error);
                } finally {
                    this.loading.delete(id);
                }
            },
            
            // 批量延迟加载
            async loadBatch(loaders, delay = 100) {
                for (const { id, loader, priority } of loaders.sort((a, b) => b.priority - a.priority)) {
                    await this.load(id, loader);
                    if (delay > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
        };
        
        // 显示功能提示弹窗
        function showFeaturePopup(message) {
            popupContent.textContent = message;
            featurePopup.style.display = 'block';
        }
        
        // 关闭功能提示弹窗
        function closeFeaturePopup() {
            featurePopup.style.display = 'none';
        }
        
        // 显示智能小模型页面
        function showAIModelPage() {
            // 隐藏其他所有页面
            const allPages = document.querySelectorAll('[id^="page-"]');
            allPages.forEach(page => {
                if (page.id !== 'page-ai-model') {
                    page.style.display = 'none';
                }
            });
            
            // 显示智能小模型页面
            const aiModelPage = document.getElementById('page-ai-model');
            if (aiModelPage) {
                aiModelPage.style.display = 'block';
                // 清空之前的结果
                document.getElementById('ai-result-container').style.display = 'none';
                const aiQueryInput = document.getElementById('ai-query-input');
                if (aiQueryInput) {
                    aiQueryInput.value = '';
                    // 设置placeholder为当前年份
                    var currentYear = new Date().getFullYear();
                    aiQueryInput.placeholder = '如：' + currentYear + '年充电电量有多少';
                    aiQueryInput.focus();
                }
            }
        }
        
        // 智能查询函数
        let thinkingStartTime = null;
        let thinkingInterval = null;
        
        function sendAIQuery() {
            const queryInput = document.getElementById('ai-query-input');
            const query = queryInput.value.trim();
            
            if (!query) {
                alert('请输入您的问题');
                return;
            }
            
            // 显示结果容器和思考动画
            const resultContainer = document.getElementById('ai-result-container');
            const thinkingDiv = document.getElementById('ai-thinking');
            const answerDiv = document.getElementById('ai-answer');
            
            resultContainer.style.display = 'block';
            thinkingDiv.style.display = 'block';
            answerDiv.innerHTML = '';
            
            // 开始思考动画
            thinkingStartTime = Date.now();
            let dotCount = 0;
            thinkingInterval = setInterval(() => {
                dotCount = (dotCount % 3) + 1;
                const dots = '…'.repeat(dotCount);
                document.getElementById('thinking-dots').textContent = dots;
                
                // 更新用时
                const elapsed = ((Date.now() - thinkingStartTime) / 1000).toFixed(1);
                document.getElementById('thinking-time').textContent = `已用时 ${elapsed} 秒`;
            }, 500);
            
            // 解析问题并构建SQL查询
            const queryResult = parseAIQuery(query);
            
            // 模拟思考延迟后执行查询
            setTimeout(() => {
                executeAIQuery(queryResult, query);
            }, 1000);
        }
        
        // 发送第二个查询（当第一个查询结果为空时）
        function sendSecondQuery() {
            const secondInput = document.getElementById('second-query-input');
            if (!secondInput) {
                // 如果没有第二个输入框，使用主输入框
                sendAIQuery();
                return;
            }
            
            const query = secondInput.value.trim();
            if (!query) {
                alert('请输入您的问题');
                return;
            }
            
            // 将第二个查询的值设置到主输入框
            document.getElementById('ai-query-input').value = query;
            
            // 清空第二个输入框
            secondInput.value = '';
            
            // 显示思考动画
            const resultContainer = document.getElementById('ai-result-container');
            const thinkingDiv = document.getElementById('ai-thinking');
            const answerDiv = document.getElementById('ai-answer');
            
            resultContainer.style.display = 'block';
            thinkingDiv.style.display = 'block';
            answerDiv.innerHTML = '';
            
            // 开始思考动画
            thinkingStartTime = Date.now();
            let dotCount = 0;
            thinkingInterval = setInterval(() => {
                dotCount = (dotCount % 3) + 1;
                const dots = '…'.repeat(dotCount);
                document.getElementById('thinking-dots').textContent = dots;
                
                // 更新用时
                const elapsed = ((Date.now() - thinkingStartTime) / 1000).toFixed(1);
                document.getElementById('thinking-time').textContent = `已用时 ${elapsed} 秒`;
            }, 500);
            
            // 解析问题并构建SQL查询
            const queryResult = parseAIQuery(query);
            
            // 模拟思考延迟后执行查询
            setTimeout(() => {
                executeAIQuery(queryResult, query);
            }, 1000);
        }
        
        // 格式化日期为SQL Server格式 yyyy-mm-dd hh:mm:ss
        function formatDateForSQL(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // 解析AI查询问题
        function parseAIQuery(question) {
            const q = question.toLowerCase();
            const result = {
                fields: [],
                timeFilter: null,
                groupBy: null,
                aggregate: 'SUM', // 默认求和
                orderBy: null,
                limit: null,
                hasData: false,
                isCount: false, // 是否为计数查询（订单编号）
                groupByMonth: false, // 是否按月分组
                avgType: null, // 平均类型：'month'（平均每月）或'day'（平均每天）
                timeRange: null // 时间段信息，用于计算月份数或天数
            };
            
            // 检测字段关键词 - 按照用户要求的规则
            // 只要用户提问的问题中含有['电量']二字，就默认为在'充电电量(度)'字段下去查询数据
            if (q.includes('电量')) {
                result.fields.push('充电电量(度)');
                result.hasData = true;
            }
            // 只要用户提问的问题中含有['服务费']三字或['利润']二字，就默认为在'充电服务费(元)'字段下去查询数据
            if (q.includes('服务费') || q.includes('利润')) {
                result.fields.push('充电服务费(元)');
                result.hasData = true;
            }
            // 只要用户提问的问题中含有['收入']二字或['营收']二字，就默认为在'充电收入(元)'字段下去查询数据
            if (q.includes('收入') || q.includes('营收')) {
                result.fields.push('充电收入(元)');
                result.hasData = true;
            }
            // 只要用户提问的问题中含有['订单']二字或['笔数']二字，就默认为在'订单编号'字段下去查询计数的数据
            if (q.includes('订单') || q.includes('笔数')) {
                result.fields.push('订单编号');
                result.isCount = true;
                result.hasData = true;
            }
            
            // 如果没有明确指定字段，但提到了"车"、"枪"、"电站"等，默认使用充电电量
            if (result.fields.length === 0 && (q.includes('车') || q.includes('枪') || q.includes('电站') || q.includes('站'))) {
                result.fields.push('充电电量(度)');
                result.hasData = true;
            }
            
            // 只要用户提问的问题中含有['车']字，就默认为在'判定车牌号'字段下去查询数据
            if (q.includes('车')) {
                result.groupBy = '判定车牌号';
                result.hasData = true;
            }
            // 只要用户提问的问题中含有['终端']二字或['枪']字，就默认为在'终端名称'字段下去查询数据
            if (q.includes('终端') || q.includes('枪')) {
                result.groupBy = '终端名称';
                result.hasData = true;
            }
            // 只要用户提问的问题中含有['四方坪']三字，就默认为在'电站名称'字段下去查询不包含'华为飞狐特来电高岭超充站'和'长沙市开福区高岭香江国际城充电站建设项目'的数据
            if (q.includes('四方坪')) {
                result.stationFilter = 'exclude_gaoling'; // 排除高岭站
                // 只有在明确要求按电站分组时才设置groupBy（如"每个电站"、"各电站"等）
                if (q.includes('每个电站') || q.includes('各电站') || q.includes('哪个站') || q.includes('哪个电站')) {
                    result.groupBy = '电站名称';
                }
                result.hasData = true;
            }
            // 只要用户提问的问题中含有['高岭']二字，就默认为在'电站名称'字段下去查询包含'华为飞狐特来电高岭超充站'和'长沙市开福区高岭香江国际城充电站建设项目'的数据
            else if (q.includes('高岭')) {
                result.stationFilter = 'include_gaoling'; // 只包含高岭站
                // 只有在明确要求按电站分组时才设置groupBy（如"每个电站"、"各电站"等）
                if (q.includes('每个电站') || q.includes('各电站') || q.includes('哪个站') || q.includes('哪个电站')) {
                    result.groupBy = '电站名称';
                }
                result.hasData = true;
            }
            // 只要用户提问的问题中含有['站']字（且不包含'四方坪'和'高岭'），就默认为在'电站名称'字段下去查询数据
            else if (q.includes('站')) {
                result.groupBy = '电站名称';
                result.hasData = true;
            }
            
            // 检测平均类型
            if (q.includes('平均每月') || q.includes('平均每个月')) {
                result.avgType = 'month';
            } else if (q.includes('平均每天') || q.includes('平均每日')) {
                result.avgType = 'day';
            } else if (q.includes('平均')) {
                // 默认平均类型，根据上下文判断
                if (q.includes('每月') || q.includes('每个月')) {
                    result.avgType = 'month';
                } else if (q.includes('每天') || q.includes('每日')) {
                    result.avgType = 'day';
                }
            }
            
            // 检测聚合方式
            // 注意：对于"最多/最大"查询，应该使用SUM聚合然后ORDER BY，而不是MAX
            // 因为数据是按天分组的，如果一天有多条记录，需要求和
            if (q.includes('最多') || q.includes('最大') || q.includes('最高')) {
                result.aggregate = 'SUM'; // 使用SUM而不是MAX
                result.orderBy = 'DESC';
            } else if (q.includes('最少') || q.includes('最小') || q.includes('最低')) {
                result.aggregate = 'SUM'; // 使用SUM而不是MIN
                result.orderBy = 'ASC';
            } else if (q.includes('平均')) {
                result.aggregate = 'SUM'; // 平均查询先求和，然后在generateNaturalAnswer中除以月份数或天数
            } else if (q.includes('汇总') || q.includes('总计') || q.includes('合计')) {
                result.aggregate = 'SUM';
            }
            
            // 检测时间段（从X年X月至Y年Y月）
            const timeRangeMatch = q.match(/(\d{4})年(\d{1,2})月[至到](\d{4})年(\d{1,2})月/);
            if (timeRangeMatch) {
                const startYear = parseInt(timeRangeMatch[1]);
                const startMonth = parseInt(timeRangeMatch[2]);
                const endYear = parseInt(timeRangeMatch[3]);
                const endMonth = parseInt(timeRangeMatch[4]);
                
                const startDate = new Date(startYear, startMonth - 1, 1, 0, 0, 0);
                const endDate = new Date(endYear, endMonth, 0, 23, 59, 59); // 获取该月最后一天
                
                result.timeFilter = {
                    start: formatDateForSQL(startDate),
                    end: formatDateForSQL(endDate)
                };
                
                // 保存时间段信息用于计算月份数或天数
                result.timeRange = {
                    startYear: startYear,
                    startMonth: startMonth,
                    endYear: endYear,
                    endMonth: endMonth,
                    startDate: startDate,
                    endDate: endDate
                };
            } else {
                // 检测时间范围
                // 只要用户提问的问题中含有['时间']信息，就默认为在'充电结束时间'字段下去匹配该时间
                const hasTimeInfo = q.includes('时间') || q.match(/\d{4}年/) || q.match(/\d{1,2}月/) || q.match(/\d{1,2}日/) || q.match(/\d{1,2}号/);
                
                // 检测年份关键词（今年、去年、前年）
                const currentYear = new Date().getFullYear();
                let year1 = null; // 第一个年份（用于对比）
                let year2 = null; // 第二个年份（用于对比）
                let isCompare = false; // 是否包含对比/比较关键词
                
                // 检测是否包含"对比"或"比较"
                if (q.includes('对比') || q.includes('比较')) {
                    isCompare = true;
                    result.isCompare = true; // 标记为对比查询
                    
                    // 使用正则表达式更准确地匹配年份关键词
                    // 匹配"今年"、"去年"、"前年"等关键词
                    const yearKeywords = [
                        { keyword: '今年', year: currentYear },
                        { keyword: '去年', year: currentYear - 1 },
                        { keyword: '前年', year: currentYear - 2 }
                    ];
                    
                    // 查找所有年份关键词的位置
                    const foundYears = [];
                    yearKeywords.forEach(({ keyword, year }) => {
                        const index = q.indexOf(keyword);
                        if (index !== -1) {
                            foundYears.push({ keyword, year, index });
                        }
                    });
                    
                    // 按位置排序，找到第一个和第二个年份
                    foundYears.sort((a, b) => a.index - b.index);
                    
                    if (foundYears.length >= 2) {
                        // 如果找到两个或更多年份，使用前两个
                        year1 = foundYears[0].year;
                        year2 = foundYears[1].year;
                    } else if (foundYears.length === 1) {
                        // 如果只找到一个年份，检查"与"或"和"后面的年份
                        year1 = foundYears[0].year;
                        
                        // 查找"与"或"和"后面的年份
                        const afterConnector = q.split(/与|和/);
                        if (afterConnector.length > 1) {
                            const afterText = afterConnector[afterConnector.length - 1];
                            yearKeywords.forEach(({ keyword, year }) => {
                                if (afterText.includes(keyword) && !year2) {
                                    year2 = year;
                                }
                            });
                        }
                    }
                    
                    // 如果检测到两个年份，保存对比信息
                    if (year1 && year2) {
                        result.compareYears = {
                            year1: year1,
                            year2: year2,
                            year1Label: year1 === currentYear ? '今年' : (year1 === currentYear - 1 ? '去年' : '前年'),
                            year2Label: year2 === currentYear ? '今年' : (year2 === currentYear - 1 ? '去年' : '前年')
                        };
                    }
                } else {
                    // 非对比查询，检测单个年份
                    if (q.includes('今年')) {
                        year1 = currentYear;
                    } else if (q.includes('去年')) {
                        year1 = currentYear - 1;
                    } else if (q.includes('前年')) {
                        year1 = currentYear - 2;
                    }
                }
                
                const yearMatch = q.match(/(\d{4})年/);
                const monthMatch = q.match(/(\d{1,2})月/);
                const dayMatch = q.match(/(\d{1,2})日|(\d{1,2})号/);
                
                // 如果检测到年份关键词，使用关键词对应的年份；否则使用数字年份
                let detectedYear = year1 || (yearMatch ? parseInt(yearMatch[1]) : null);
                
                if (hasTimeInfo && (detectedYear || yearMatch || monthMatch || dayMatch)) {
                    let year = detectedYear || (yearMatch ? parseInt(yearMatch[1]) : new Date().getFullYear());
                    let month = monthMatch ? parseInt(monthMatch[1]) : null;
                    let day = dayMatch ? parseInt(dayMatch[1] || dayMatch[2]) : null;
                    
                    if (year && month && day) {
                        // 具体日期
                        const startDate = new Date(year, month - 1, day, 0, 0, 0);
                        const endDate = new Date(year, month - 1, day, 23, 59, 59);
                        result.timeFilter = {
                            start: formatDateForSQL(startDate),
                            end: formatDateForSQL(endDate)
                        };
                        result.timeRange = {
                            startDate: startDate,
                            endDate: endDate
                        };
                    } else if (year && month) {
                        // 某年某月
                        const startDate = new Date(year, month - 1, 1, 0, 0, 0);
                        const endDate = new Date(year, month, 0, 23, 59, 59);
                        result.timeFilter = {
                            start: formatDateForSQL(startDate),
                            end: formatDateForSQL(endDate)
                        };
                        result.timeRange = {
                            startYear: year,
                            startMonth: month,
                            endYear: year,
                            endMonth: month,
                            startDate: startDate,
                            endDate: endDate
                        };
                    } else if (year) {
                        // 某年
                        const startDate = new Date(year, 0, 1, 0, 0, 0);
                        const endDate = new Date(year, 11, 31, 23, 59, 59);
                        result.timeFilter = {
                            start: formatDateForSQL(startDate),
                            end: formatDateForSQL(endDate)
                        };
                        result.timeRange = {
                            startYear: year,
                            endYear: year,
                            startDate: startDate,
                            endDate: endDate
                        };
                    }
                }
            }
            
            // 检测是否按天分组（优先级最高，因为"哪一天"明确指定了分组方式）
            if (q.includes('哪一天') || q.includes('哪天') || q.includes('哪日')) {
                result.groupBy = 'CAST(充电结束时间 AS DATE)';
            }
            // 检测是否按月分组（"哪个月"）
            else if (q.includes('哪个月') || q.includes('哪月')) {
                result.groupBy = 'CAST(YEAR([充电结束时间]) AS VARCHAR(4)) + \'-\' + RIGHT(\'0\' + CAST(MONTH([充电结束时间]) AS VARCHAR(2)), 2)';
                result.groupByMonth = true;
            }
            // 如果问题中包含"每个月"或"每月"，也按月分组
            else if (q.includes('每个月') || q.includes('每月')) {
                result.groupBy = 'CAST(YEAR([充电结束时间]) AS VARCHAR(4)) + \'-\' + RIGHT(\'0\' + CAST(MONTH([充电结束时间]) AS VARCHAR(2)), 2)';
                result.groupByMonth = true;
            }
            
            return result;
        }
        
        // 执行对比查询
        function executeCompareQuery(queryResult, originalQuestion) {
            const compareYears = queryResult.compareYears;
            const year1 = compareYears.year1;
            const year2 = compareYears.year2;
            
            // 创建两个查询结果对象，分别查询两个年份
            const queryResult1 = JSON.parse(JSON.stringify(queryResult));
            const queryResult2 = JSON.parse(JSON.stringify(queryResult));
            
            // 设置第一个年份的时间过滤
            const startDate1 = new Date(year1, 0, 1, 0, 0, 0);
            const endDate1 = new Date(year1, 11, 31, 23, 59, 59);
            queryResult1.timeFilter = {
                start: formatDateForSQL(startDate1),
                end: formatDateForSQL(endDate1)
            };
            queryResult1.isCompare = false; // 清除对比标记，避免递归
            
            // 设置第二个年份的时间过滤
            const startDate2 = new Date(year2, 0, 1, 0, 0, 0);
            const endDate2 = new Date(year2, 11, 31, 23, 59, 59);
            queryResult2.timeFilter = {
                start: formatDateForSQL(startDate2),
                end: formatDateForSQL(endDate2)
            };
            queryResult2.isCompare = false; // 清除对比标记，避免递归
            
            // 执行第一个查询
            executeSingleQuery(queryResult1, originalQuestion, function(data1) {
                // 执行第二个查询
                executeSingleQuery(queryResult2, originalQuestion, function(data2) {
                    // 计算两个年份的总值
                    let total1 = 0;
                    let total2 = 0;
                    
                    if (data1 && data1.length > 0) {
                        data1.forEach(row => {
                            const rowValue = row.value !== undefined ? row.value : (row.Value !== undefined ? row.Value : 0);
                            total1 += parseFloat(rowValue) || 0;
                        });
                    }
                    
                    if (data2 && data2.length > 0) {
                        data2.forEach(row => {
                            const rowValue = row.value !== undefined ? row.value : (row.Value !== undefined ? row.Value : 0);
                            total2 += parseFloat(rowValue) || 0;
                        });
                    }
                    
                    // 计算差值x（year1 - year2）
                    const x = total1 - total2;
                    
                    // 计算百分比y（x / year2 * 100）
                    const y = total2 !== 0 ? (x / total2 * 100) : 0;
                    
                    // 格式化数值
                    const formattedX = Math.abs(x) % 1 === 0 ? Math.abs(x).toString() : Math.abs(x).toFixed(2);
                    const formattedY = Math.abs(y) % 1 === 0 ? Math.abs(y).toString() : Math.abs(y).toFixed(2);
                    
                    // 获取字段名称和单位
                    const fieldName = queryResult.fields[0] || '充电电量(度)';
                    let unit = '';
                    let fieldDisplayName = '';
                    if (fieldName.includes('电量')) {
                        unit = '度';
                        fieldDisplayName = '充电电量';
                    } else if (fieldName.includes('服务费') || fieldName.includes('利润')) {
                        unit = '元';
                        fieldDisplayName = fieldName.includes('服务费') ? '充电服务费' : '充电利润';
                    } else if (fieldName.includes('收入') || fieldName.includes('营收')) {
                        unit = '元';
                        fieldDisplayName = '充电收入';
                    } else if (fieldName.includes('订单编号') || queryResult.isCount) {
                        unit = '';
                        fieldDisplayName = '订单数量';
                    }
                    
                    // 生成对比回答
                    const trend = x >= 0 ? '增加' : '下滑';
                    const year1Label = compareYears.year1Label;
                    const year2Label = compareYears.year2Label;
                    
                    clearInterval(thinkingInterval);
                    const elapsed = ((Date.now() - thinkingStartTime) / 1000).toFixed(1);
                    
                    let answer = `${year1Label}与${year2Label}对比${fieldDisplayName}${trend}${formattedX}${unit}，同比${trend}${formattedY}%。`;
                    
                    document.getElementById('ai-thinking').style.display = 'none';
                    document.getElementById('ai-answer').innerHTML = 
                        answer + `\n\n<small style="color:#999;">思考用时：${elapsed}秒</small>`;
                });
            });
        }
        
        // 执行单个查询（用于对比查询）
        function executeSingleQuery(queryResult, originalQuestion, callback) {
            // 构建SQL查询
            let sql = '';
            
            // 确定要查询的字段
            let targetField = '[充电电量(度)]';
            if (queryResult.fields.length > 0) {
                if (queryResult.isCount && queryResult.fields[0] === '订单编号') {
                    targetField = '[订单编号]';
                } else {
                    targetField = '[' + queryResult.fields[0] + ']';
                }
            }
            
            // 对于平均查询，不分组，直接汇总所有数据
            const isAvgQuery = queryResult.avgType !== null;
            
            // 当有stationFilter但没有groupBy时，也不分组，直接汇总
            const isStationFilterOnly = queryResult.stationFilter && !queryResult.groupBy;
            
            // 确定分组字段
            let groupByField = 'CAST([充电结束时间] AS DATE)';
            if (!isAvgQuery && !isStationFilterOnly && queryResult.groupBy) {
                if (queryResult.groupBy.includes('CAST') || queryResult.groupBy.includes('YEAR')) {
                    groupByField = queryResult.groupBy;
                } else {
                    groupByField = '[' + queryResult.groupBy + ']';
                }
            }
            
            // 构建聚合表达式
            let aggregateExpr = '';
            if (queryResult.isCount && queryResult.fields[0] === '订单编号') {
                aggregateExpr = 'COUNT(DISTINCT [订单编号])';
            } else {
                aggregateExpr = queryResult.aggregate + '(' + targetField + ')';
            }
            
            // 构建WHERE条件（过滤空值和0值）
            let whereConditions = [];
            
            // 过滤目标字段的空值和0值
            if (queryResult.isCount && queryResult.fields[0] === '订单编号') {
                whereConditions.push('[订单编号] IS NOT NULL');
                whereConditions.push('[订单编号] <> \'\'');
            } else if (targetField) {
                whereConditions.push(targetField + ' IS NOT NULL');
                whereConditions.push(targetField + ' <> 0');
            }
            
            // 过滤分组字段的空值
            if (!isAvgQuery && queryResult.groupBy && !queryResult.groupBy.includes('CAST') && !queryResult.groupBy.includes('YEAR')) {
                whereConditions.push('[' + queryResult.groupBy + '] IS NOT NULL');
                whereConditions.push('[' + queryResult.groupBy + '] <> \'\'');
            }
            
            // 过滤充电结束时间的空值
            whereConditions.push('[充电结束时间] IS NOT NULL');
            
            // 添加时间过滤
            if (queryResult.timeFilter) {
                whereConditions.push("[充电结束时间] >= '" + queryResult.timeFilter.start + "'");
                whereConditions.push("[充电结束时间] <= '" + queryResult.timeFilter.end + "'");
            }
            
            // 添加电站名称过滤条件
            if (queryResult.stationFilter === 'exclude_gaoling') {
                whereConditions.push("[电站名称] NOT LIKE N'%华为飞狐特来电高岭超充站%'");
                whereConditions.push("[电站名称] NOT LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%'");
            } else if (queryResult.stationFilter === 'include_gaoling') {
                whereConditions.push("([电站名称] LIKE N'%华为飞狐特来电高岭超充站%' OR [电站名称] LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%')");
            }
            
            // 构建SQL（对比查询统一使用总计查询，不分组）
            sql = `SELECT 
                '总计' AS groupField,
                ${aggregateExpr} AS value
            FROM [特来电]`;
            
            // 添加WHERE条件
            if (whereConditions.length > 0) {
                sql += ' WHERE ' + whereConditions.join(' AND ');
            }
            
            // 执行SQL查询
            const queryOptions = {
                method: 'POST',
                headers: {
                    'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                    'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: sql })
            };
            
            fetch('https://1257663610-833b483ie5.ap-guangzhou.tencentscf.com', queryOptions)
                .then(async response => {
                    if (!response.ok) {
                        let errorText = '';
                        let errorData = null;
                        try {
                            errorText = await response.text();
                            if (errorText) {
                                try {
                                    errorData = JSON.parse(errorText);
                                } catch (e) {}
                            }
                        } catch (e) {
                            console.error('读取错误响应失败:', e);
                        }
                        let errorMessage = '';
                        if (errorData) {
                            errorMessage = errorData.error || errorData.message || errorData.msg || errorData.code || errorData.detail || JSON.stringify(errorData);
                        } else if (errorText) {
                            errorMessage = errorText;
                        } else {
                            errorMessage = response.statusText || '请求失败';
                        }
                        throw new Error(`服务器错误 (${response.status}): ${errorMessage}`);
                    }
                    return response.json();
                })
                .then(function(result) {
                    // 处理查询结果
                    let queryData = null;
                    
                    if (result.result && typeof result.result === 'object') {
                        if (result.result.success && result.result.results) {
                            queryData = result.result.results;
                        } else if (result.result.success && result.result.data) {
                            queryData = result.result.data;
                        } else if (result.result.error) {
                            throw new Error(result.result.error);
                        }
                    } else if (result.result && typeof result.result === 'string') {
                        try {
                            const parsed = JSON.parse(result.result);
                            if (parsed.success) {
                                queryData = parsed.results || parsed.data;
                            } else if (parsed.error) {
                                throw new Error(parsed.error);
                            }
                        } catch (e) {
                            if (e instanceof Error && e.message.includes('error')) {
                                throw e;
                            }
                            console.error('解析result.result失败:', e);
                        }
                    } else if (result.success) {
                        queryData = result.results || result.data;
                    } else if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    // 调用回调函数返回数据
                    callback(queryData || []);
                })
                .catch(function(error) {
                    console.error('查询错误:', error);
                    callback([]);
                });
        }
        
        // 执行AI查询
        function executeAIQuery(queryResult, originalQuestion) {
            // 如果没有匹配到任何字段，返回提示
            if (!queryResult.hasData) {
                clearInterval(thinkingInterval);
                document.getElementById('ai-thinking').style.display = 'none';
                const elapsed = ((Date.now() - thinkingStartTime) / 1000).toFixed(1);
                document.getElementById('ai-answer').innerHTML = 
                    `这个问题我还不会哦！我还需要进一步学习。请先换个我会的问题吧！\n\n<small style="color:#999;">思考用时：${elapsed}秒</small>`;
                return;
            }
            
            // 如果是对比查询，执行两次查询并计算对比结果
            if (queryResult.isCompare && queryResult.compareYears) {
                executeCompareQuery(queryResult, originalQuestion);
                return;
            }
            
            // 构建SQL查询
            let sql = '';
            
            // 确定要查询的字段
            let targetField = '[充电电量(度)]';
            if (queryResult.fields.length > 0) {
                if (queryResult.isCount && queryResult.fields[0] === '订单编号') {
                    // 订单编号计数查询
                    targetField = '[订单编号]';
                } else {
                    targetField = '[' + queryResult.fields[0] + ']';
                }
            }
            
            // 对于平均查询，不分组，直接汇总所有数据
            const isAvgQuery = queryResult.avgType !== null;
            
            // 当有stationFilter但没有groupBy时，也不分组，直接汇总（用于查询四方坪或高岭的总数据）
            const isStationFilterOnly = queryResult.stationFilter && !queryResult.groupBy;
            
            // 确定分组字段
            let groupByField = 'CAST([充电结束时间] AS DATE)';
            if (!isAvgQuery && !isStationFilterOnly && queryResult.groupBy) {
                if (queryResult.groupBy.includes('CAST') || queryResult.groupBy.includes('YEAR')) {
                    // 处理包含CAST或YEAR的复杂表达式（已经包含字段名，直接使用）
                    groupByField = queryResult.groupBy;
                } else {
                    groupByField = '[' + queryResult.groupBy + ']';
                }
            }
            
            // 构建聚合表达式
            let aggregateExpr = '';
            if (queryResult.isCount && queryResult.fields[0] === '订单编号') {
                // 订单编号计数：使用COUNT(DISTINCT [订单编号])
                aggregateExpr = 'COUNT(DISTINCT [订单编号])';
            } else {
                aggregateExpr = queryResult.aggregate + '(' + targetField + ')';
            }
            
            // 构建WHERE条件（过滤空值）
            let whereConditions = [];
            
            // 过滤目标字段的空值和0值
            if (queryResult.isCount && queryResult.fields[0] === '订单编号') {
                whereConditions.push('[订单编号] IS NOT NULL');
                whereConditions.push('[订单编号] <> \'\'');
            } else if (targetField) {
                whereConditions.push(targetField + ' IS NOT NULL');
                // 对于数值字段，过滤0值
                whereConditions.push(targetField + ' <> 0');
            }
            
            // 过滤分组字段的空值（平均查询不需要）
            if (!isAvgQuery && queryResult.groupBy && !queryResult.groupBy.includes('CAST') && !queryResult.groupBy.includes('YEAR')) {
                whereConditions.push('[' + queryResult.groupBy + '] IS NOT NULL');
                whereConditions.push('[' + queryResult.groupBy + '] <> \'\'');
            }
            
            // 过滤充电结束时间的空值
            whereConditions.push('[充电结束时间] IS NOT NULL');
            
            // 添加时间过滤
            if (queryResult.timeFilter) {
                whereConditions.push("[充电结束时间] >= '" + queryResult.timeFilter.start + "'");
                whereConditions.push("[充电结束时间] <= '" + queryResult.timeFilter.end + "'");
            }
            
            // 添加电站名称过滤条件
            if (queryResult.stationFilter === 'exclude_gaoling') {
                // 排除高岭站：不包含'华为飞狐特来电高岭超充站'和'长沙市开福区高岭香江国际城充电站建设项目'
                whereConditions.push("[电站名称] NOT LIKE N'%华为飞狐特来电高岭超充站%'");
                whereConditions.push("[电站名称] NOT LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%'");
            } else if (queryResult.stationFilter === 'include_gaoling') {
                // 只包含高岭站：包含'华为飞狐特来电高岭超充站'或'长沙市开福区高岭香江国际城充电站建设项目'
                whereConditions.push("([电站名称] LIKE N'%华为飞狐特来电高岭超充站%' OR [电站名称] LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%')");
            }
            
            // 平均查询或仅电站过滤查询：不分组，直接汇总
            if (isAvgQuery || isStationFilterOnly) {
                sql = `SELECT 
                    '总计' AS groupField,
                    ${aggregateExpr} AS value
                FROM [特来电]`;
                
                // 添加WHERE条件
                if (whereConditions.length > 0) {
                    sql += ' WHERE ' + whereConditions.join(' AND ');
                }
            }
            // 如果需要排序和限制（取最大值/最小值），使用子查询
            else if (queryResult.orderBy) {
                sql = `SELECT TOP 1 groupField, value FROM (
                    SELECT 
                        ${groupByField} AS groupField,
                        ${aggregateExpr} AS value
                    FROM [特来电]`;
                
                // 添加WHERE条件
                if (whereConditions.length > 0) {
                    sql += ' WHERE ' + whereConditions.join(' AND ');
                }
                
                sql += ' GROUP BY ' + groupByField;
                sql += ') AS subquery';
                // ORDER BY必须在外层查询中，不能在子查询中
                sql += ' ORDER BY value ' + queryResult.orderBy;
            } else {
                // 普通查询
                sql = `SELECT 
                    ${groupByField} AS groupField,
                    ${aggregateExpr} AS value
                FROM [特来电]`;
                
                // 添加WHERE条件
                if (whereConditions.length > 0) {
                    sql += ' WHERE ' + whereConditions.join(' AND ');
                }
                
                sql += ' GROUP BY ' + groupByField;
            }
            
            // 输出SQL语句用于调试
            console.log('生成的SQL查询:', sql);
            console.log('查询参数:', queryResult);
            
            // 执行SQL查询
            const queryOptions = {
                method: 'POST',
                headers: {
                    'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                    'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: sql })
            };
            
            fetch('https://1257663610-833b483ie5.ap-guangzhou.tencentscf.com', queryOptions)
                .then(async response => {
                    // 检查响应状态
                    if (!response.ok) {
                        // 先尝试读取响应文本
                        let errorText = '';
                        let errorData = null;
                        
                        try {
                            errorText = await response.text();
                            // 尝试解析为JSON
                            if (errorText) {
                                try {
                                    errorData = JSON.parse(errorText);
                                } catch (e) {
                                    // 不是JSON格式，使用原始文本
                                }
                            }
                        } catch (e) {
                            console.error('读取错误响应失败:', e);
                        }
                        
                        // 提取错误信息
                        let errorMessage = '';
                        if (errorData) {
                            // 尝试多种可能的错误字段
                            errorMessage = errorData.error || 
                                         errorData.message || 
                                         errorData.msg || 
                                         errorData.code ||
                                         errorData.detail ||
                                         (errorData.result && (errorData.result.error || errorData.result.message)) ||
                                         JSON.stringify(errorData);
                        } else if (errorText) {
                            errorMessage = errorText;
                        } else {
                            errorMessage = response.statusText || '请求失败';
                        }
                        
                        throw new Error(`服务器错误 (${response.status}): ${errorMessage}`);
                    }
                    return response.json();
                })
                .then(function(result) {
                    clearInterval(thinkingInterval);
                    const elapsed = ((Date.now() - thinkingStartTime) / 1000).toFixed(1);
                    
                    // 处理查询结果 - 支持多种返回格式
                    let queryData = null;
                    
                    // 优先检查result.result字段（LeanCloud云函数的标准返回格式）
                    if (result.result && typeof result.result === 'object') {
                        if (result.result.success && result.result.results) {
                            queryData = result.result.results; // 使用results字段
                        } else if (result.result.success && result.result.data) {
                            queryData = result.result.data; // 使用data字段
                        } else if (result.result.error) {
                            // 如果result.result中有error字段，说明查询失败
                            throw new Error(result.result.error);
                        }
                    } 
                    // 如果result.result是字符串，尝试解析
                    else if (result.result && typeof result.result === 'string') {
                        try {
                            const parsed = JSON.parse(result.result);
                            if (parsed.success) {
                                queryData = parsed.results || parsed.data;
                            } else if (parsed.error) {
                                throw new Error(parsed.error);
                            }
                        } catch (e) {
                            if (e instanceof Error && e.message.includes('error')) {
                                throw e;
                            }
                            console.error('解析result.result失败:', e);
                        }
                    } 
                    // 检查直接返回的success字段
                    else if (result.success) {
                        queryData = result.results || result.data;
                    }
                    // 检查是否有错误信息
                    else if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    // 隐藏思考动画
                    document.getElementById('ai-thinking').style.display = 'none';
                    
                    // 生成回答
                    if (!queryData || queryData.length === 0) {
                        // 添加调试信息（开发时使用，生产环境可移除）
                        console.log('查询结果:', result);
                        console.log('生成的SQL:', sql);
                        
                        // 显示结果为空的信息，并提供输入第二个查询的选项
                        let noDataHtml = `没有找到数据哦\n\n<small style="color:#999;">思考用时：${elapsed}秒</small>`;
                        noDataHtml += `\n\n<div style="margin-top:20px; padding:15px; background:#fff3cd; border:1px solid #ffc107; border-radius:6px;">`;
                        noDataHtml += `<div style="margin-bottom:10px; color:#856404; font-weight:500;">您可以尝试输入另一个查询：</div>`;
                        noDataHtml += `<div style="display:flex; gap:8px; align-items:center;">`;
                        noDataHtml += `<input type="text" id="second-query-input" placeholder="请输入新的查询问题..." style="flex:1; padding:8px 12px; border:1px solid #ddd; border-radius:4px; font-size:14px;" onkeydown="if(event.key==='Enter'){sendSecondQuery();}">`;
                        noDataHtml += `<button onclick="sendSecondQuery()" style="background:#007bff; color:#fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:14px; white-space:nowrap;">查询</button>`;
                        noDataHtml += `</div></div>`;
                        
                        document.getElementById('ai-answer').innerHTML = noDataHtml;
                        
                        // 自动聚焦到输入框
                        setTimeout(() => {
                            const secondInput = document.getElementById('second-query-input');
                            if (secondInput) {
                                secondInput.focus();
                            }
                        }, 100);
                        return;
                    }
                    
                    // 根据查询结果生成自然语言回答
                    const answer = generateNaturalAnswer(queryData, originalQuestion, queryResult);
                    document.getElementById('ai-answer').innerHTML = 
                        answer + `\n\n<small style="color:#999;">思考用时：${elapsed}秒</small>`;
                })
                .catch(function(error) {
                    clearInterval(thinkingInterval);
                    document.getElementById('ai-thinking').style.display = 'none';
                    const elapsed = ((Date.now() - thinkingStartTime) / 1000).toFixed(1);
                    console.error('查询错误:', error);
                    console.log('生成的SQL:', sql);
                    console.log('查询参数:', queryResult);
                    
                    // 构建详细的错误信息
                    let errorMsg = error.message || '未知错误';
                    let errorHtml = `查询出错：${errorMsg}`;
                    
                    // 如果是400错误，可能是SQL语法或参数问题，提供更多提示
                    if (errorMsg.includes('400')) {
                        errorHtml += `\n\n<small style="color:#999;">提示：可能是SQL查询语法错误或参数问题，请检查生成的SQL语句。</small>`;
                    }
                    
                    errorHtml += `\n\n<small style="color:#999;">思考用时：${elapsed}秒</small>`;
                    errorHtml += `\n\n<details style="margin-top:10px;"><summary style="cursor:pointer; color:#666;">查看SQL语句</summary><pre style="background:#f5f5f5; padding:10px; border-radius:4px; overflow:auto; font-size:12px; margin-top:5px;">${sql}</pre></details>`;
                    
                    document.getElementById('ai-answer').innerHTML = errorHtml;
                });
        }
        
        // 生成自然语言回答
        function generateNaturalAnswer(data, question, queryResult) {
            const q = question.toLowerCase();
            let answer = '';
            
            if (data.length === 0) {
                return '没有找到数据哦';
            }
            
            const firstRow = data[0];
            // 尝试多种可能的字段名（SQL Server可能返回不同的大小写格式）
            const groupValue = firstRow.groupField || firstRow.GroupField || firstRow.groupfield || firstRow.GROUPFIELD || 
                              firstRow['groupField'] || firstRow['GroupField'] || '';
            const value = firstRow.value !== undefined ? firstRow.value : 
                         (firstRow.Value !== undefined ? firstRow.Value : 
                         (firstRow.VALUE !== undefined ? firstRow.VALUE : 
                         (firstRow['value'] !== undefined ? firstRow['value'] : 0)));
            
            // 调试信息
            console.log('解析的第一行数据:', firstRow);
            console.log('提取的groupValue:', groupValue);
            console.log('提取的value:', value);
            console.log('queryResult.avgType:', queryResult.avgType);
            console.log('q.includes("平均"):', q.includes('平均'));
            
            // 格式化数值
            const formattedValue = typeof value === 'number' ? 
                (value % 1 === 0 ? value.toString() : value.toFixed(2)) : value;
            
            // 获取字段名称和单位
            const fieldName = queryResult.fields[0] || '充电电量(度)';
            let unit = '';
            let fieldDisplayName = '';
            if (fieldName.includes('电量')) {
                unit = '度';
                fieldDisplayName = '充电量';
            } else if (fieldName.includes('服务费') || fieldName.includes('利润')) {
                unit = '元';
                fieldDisplayName = fieldName.includes('服务费') ? '充电服务费' : '充电利润';
            } else if (fieldName.includes('收入') || fieldName.includes('营收')) {
                unit = '元';
                fieldDisplayName = '充电收入';
            } else if (fieldName.includes('订单编号') || queryResult.isCount) {
                unit = '';
                fieldDisplayName = '订单数量';
            } else if (fieldName.includes('费用')) {
                unit = '元';
                fieldDisplayName = '充电费用';
            }
            
            // 处理平均查询的情况（优先判断，即使groupValue是"总计"也要进入此分支）
            // 必须在其他条件之前判断，确保平均查询优先处理
            if (queryResult.avgType || q.includes('平均')) {
                console.log('进入平均查询分支');
                console.log('queryResult.avgType:', queryResult.avgType);
                console.log('queryResult.timeRange:', queryResult.timeRange);
                console.log('queryResult.timeFilter:', queryResult.timeFilter);
                
                // 汇总所有数据
                let totalValue = 0;
                data.forEach(row => {
                    const rowValue = row.value !== undefined ? row.value : (row.Value !== undefined ? row.Value : 0);
                    totalValue += parseFloat(rowValue) || 0;
                });
                console.log('总充电电量:', totalValue);
                
                let avgValue = 0;
                let divisor = 1;
                
                // 根据平均类型计算除数
                if (queryResult.avgType === 'month') {
                    console.log('计算平均每月，开始计算月份数...');
                    // 平均每月：计算月份数
                    if (queryResult.timeRange) {
                        if (queryResult.timeRange.startYear && queryResult.timeRange.startMonth && 
                            queryResult.timeRange.endYear && queryResult.timeRange.endMonth) {
                            // 时间段：从X年X月至Y年Y月
                            const startYear = queryResult.timeRange.startYear;
                            const startMonth = queryResult.timeRange.startMonth;
                            const endYear = queryResult.timeRange.endYear;
                            const endMonth = queryResult.timeRange.endMonth;
                            
                            // 计算月份数
                            divisor = (endYear - startYear) * 12 + (endMonth - startMonth) + 1;
                            console.log(`时间段计算：${startYear}年${startMonth}月至${endYear}年${endMonth}月，月份数：${divisor}`);
                        } else if (queryResult.timeRange.startYear && queryResult.timeRange.endYear) {
                            // 某年：12个月
                            divisor = 12;
                            console.log('某年计算，月份数：12');
                        } else if (queryResult.timeRange.startDate && queryResult.timeRange.endDate) {
                            // 根据日期范围计算月份数
                            const startDate = new Date(queryResult.timeRange.startDate);
                            const endDate = new Date(queryResult.timeRange.endDate);
                            const months = (endDate.getFullYear() - startDate.getFullYear()) * 12 + 
                                         (endDate.getMonth() - startDate.getMonth()) + 1;
                            divisor = months;
                            console.log('根据日期范围计算月份数：', months);
                        }
                    } else if (queryResult.timeFilter) {
                        // 根据时间过滤条件计算月份数
                        const startDate = new Date(queryResult.timeFilter.start);
                        const endDate = new Date(queryResult.timeFilter.end);
                        const months = (endDate.getFullYear() - startDate.getFullYear()) * 12 + 
                                     (endDate.getMonth() - startDate.getMonth()) + 1;
                        divisor = months;
                        console.log('根据timeFilter计算月份数：', months, '开始日期：', startDate, '结束日期：', endDate);
                    } else {
                        // 默认12个月
                        divisor = 12;
                    }
                } else if (queryResult.avgType === 'day') {
                    // 平均每天：计算天数
                    if (queryResult.timeRange && queryResult.timeRange.startDate && queryResult.timeRange.endDate) {
                        const startDate = new Date(queryResult.timeRange.startDate);
                        const endDate = new Date(queryResult.timeRange.endDate);
                        // 计算天数（包含起始和结束日期）
                        const diffTime = endDate.getTime() - startDate.getTime();
                        divisor = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    } else if (queryResult.timeFilter) {
                        const startDate = new Date(queryResult.timeFilter.start);
                        const endDate = new Date(queryResult.timeFilter.end);
                        const diffTime = endDate.getTime() - startDate.getTime();
                        divisor = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    } else {
                        // 默认365天
                        divisor = 365;
                    }
                } else {
                    // 默认平均：使用数据行数
                    divisor = data.length;
                }
                
                avgValue = divisor > 0 ? totalValue / divisor : 0;
                const formattedAvg = avgValue % 1 === 0 ? avgValue.toString() : avgValue.toFixed(2);
                console.log('计算平均值：总充电电量 =', totalValue, '，月份数 =', divisor, '，平均值 =', avgValue, '，格式化后 =', formattedAvg);
                
                // 根据用户提问生成回答，替换"是多少"为具体数值
                // 只替换"是多少"或"多少"，不添加额外文字
                console.log('原始问题：', question);
                if (question.includes('是多少')) {
                    // 替换"是多少"为"是x度"，确保只替换一次，不添加额外内容
                    answer = question.replace(/是多少/g, `是${formattedAvg}${unit}`);
                    // 移除可能存在的问号，因为已经替换为答案
                    answer = answer.replace(/\？/g, '');
                    answer = answer.replace(/\?/g, '');
                } else if (question.includes('多少')) {
                    answer = question.replace(/多少/g, `${formattedAvg}${unit}`);
                    // 移除可能存在的问号
                    answer = answer.replace(/\？/g, '');
                    answer = answer.replace(/\?/g, '');
                } else {
                    // 如果没有"是多少"或"多少"，直接添加结果
                    answer = question + `是${formattedAvg}${unit}`;
                }
                
                // 确保以句号结尾
                if (!answer.endsWith('。') && !answer.endsWith('！') && !answer.endsWith('？')) {
                    answer += '。';
                }
                console.log('最终生成的回答：', answer);
            }
            // 处理按天查询的情况（哪一天）
            else if (queryResult.groupBy && queryResult.groupBy.includes('CAST') && queryResult.groupBy.includes('DATE')) {
                let dateStr = '';
                if (groupValue) {
                    // 处理日期格式
                    if (typeof groupValue === 'string') {
                        dateStr = groupValue.split('T')[0];
                    } else {
                        dateStr = groupValue;
                    }
                    // 转换为yyyy-mm-dd格式
                    const date = new Date(dateStr);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    dateStr = `${year}-${month}-${day}`;
                }
                
                // 根据用户提问生成回答，保持原问题格式
                answer = question.replace(/哪一天|哪天|哪日/g, dateStr);
                if (unit) {
                    answer += `，${fieldDisplayName}为${formattedValue}${unit}！`;
                } else {
                    answer += `！`;
                }
            }
            // 处理按月查询的情况（哪个月）
            else if (queryResult.groupByMonth) {
                let monthStr = '';
                if (groupValue) {
                    // groupValue格式应该是 "2025-10"
                    if (typeof groupValue === 'string') {
                        const parts = groupValue.split('-');
                        if (parts.length >= 2) {
                            const month = parseInt(parts[1]);
                            monthStr = `${month}月`;
                        } else {
                            monthStr = groupValue;
                        }
                    } else {
                        monthStr = groupValue;
                    }
                }
                
                // 根据用户提问生成回答
                answer = question.replace(/哪个月|哪月/g, monthStr);
                if (unit) {
                    answer += `，${fieldDisplayName}为${formattedValue}${unit}。`;
                } else {
                    answer += `。`;
                }
            }
            // 处理按车牌号查询的情况
            else if (queryResult.groupBy === '判定车牌号') {
                const carNumber = groupValue || '';
                
                // 根据用户提问生成回答，替换"哪个车"为具体车牌号
                answer = question.replace(/哪个车|哪辆车|哪台车/g, carNumber + '车');
                if (unit) {
                    answer += `，${fieldDisplayName}为${formattedValue}${unit}。`;
                } else {
                    answer += `。`;
                }
            }
            // 处理按电站查询的情况（只有当明确按电站分组时才进入此分支）
            else if (queryResult.groupBy === '电站名称') {
                const stationName = groupValue || '';
                
                // 根据用户提问生成回答，替换"哪个站"为具体站名
                answer = question.replace(/哪个站|哪个电站/g, stationName);
                if (unit) {
                    answer += `，${fieldDisplayName}为${formattedValue}${unit}。`;
                } else {
                    answer += `。`;
                }
            }
            // 处理有stationFilter但没有groupBy的情况（汇总查询，如"四方坪充电量是多少"）
            else if (queryResult.stationFilter && !queryResult.groupBy) {
                // 汇总所有数据
                let totalValue = 0;
                data.forEach(row => {
                    const rowValue = row.value !== undefined ? row.value : (row.Value !== undefined ? row.Value : 0);
                    totalValue += parseFloat(rowValue) || 0;
                });
                
                const formattedTotal = totalValue % 1 === 0 ? totalValue.toString() : totalValue.toFixed(2);
                
                // 根据用户提问生成回答，替换"是多少"或"多少"为具体数值
                if (question.includes('是多少')) {
                    answer = question.replace(/是多少/g, `是${formattedTotal}${unit}`);
                    // 移除可能存在的问号
                    answer = answer.replace(/\？/g, '');
                    answer = answer.replace(/\?/g, '');
                } else if (question.includes('多少')) {
                    answer = question.replace(/多少/g, `${formattedTotal}${unit}`);
                    // 移除可能存在的问号
                    answer = answer.replace(/\？/g, '');
                    answer = answer.replace(/\?/g, '');
                } else {
                    // 如果没有"是多少"或"多少"，直接添加结果
                    answer = question + `是${formattedTotal}${unit}`;
                }
                
                // 确保以句号结尾
                if (!answer.endsWith('。') && !answer.endsWith('！') && !answer.endsWith('？')) {
                    answer += '。';
                }
            }
            // 处理按终端查询的情况
            else if (queryResult.groupBy === '终端名称') {
                const terminalName = groupValue || '';
                
                // 根据用户提问生成回答
                answer = question.replace(/哪个终端|哪把枪|哪个枪/g, terminalName);
                if (unit) {
                    answer += `，${fieldDisplayName}为${formattedValue}${unit}。`;
                } else {
                    answer += `。`;
                }
            }
            // 处理其他情况（汇总查询）
            // 注意：如果queryResult.avgType存在，应该已经在上面的平均查询分支处理了
            // 这里只处理非平均查询的情况
            else {
                // 汇总所有数据
                let totalValue = 0;
                data.forEach(row => {
                    const rowValue = row.value !== undefined ? row.value : (row.Value !== undefined ? row.Value : 0);
                    totalValue += parseFloat(rowValue) || 0;
                });
                
                const formattedTotal = totalValue % 1 === 0 ? totalValue.toString() : totalValue.toFixed(2);
                
                // 根据用户提问生成回答
                if (q.includes('是多少') || q.includes('多少')) {
                    // 替换"是多少"或"多少"为具体数值
                    answer = question.replace(/是多少|多少/g, `是${formattedTotal}${unit}`);
                    // 移除可能存在的问号
                    answer = answer.replace(/\？/g, '');
                    answer = answer.replace(/\?/g, '');
                    // 确保以句号结尾
                    if (!answer.endsWith('。') && !answer.endsWith('！')) {
                        answer += '。';
                    }
                } else {
                    // 如果没有明确的问题格式，使用默认格式
                    let timeInfo = '';
                    if (queryResult.timeFilter) {
                        const startDate = new Date(queryResult.timeFilter.start);
                        const endDate = new Date(queryResult.timeFilter.end);
                        if (startDate.getFullYear() === endDate.getFullYear() && 
                            startDate.getMonth() === endDate.getMonth() && 
                            startDate.getDate() === endDate.getDate()) {
                            timeInfo = `${startDate.getFullYear()}年${startDate.getMonth() + 1}月${startDate.getDate()}日`;
                        } else if (startDate.getFullYear() === endDate.getFullYear() && 
                                   startDate.getMonth() === endDate.getMonth()) {
                            timeInfo = `${startDate.getFullYear()}年${startDate.getMonth() + 1}月`;
                        } else if (startDate.getFullYear() === endDate.getFullYear()) {
                            timeInfo = `${startDate.getFullYear()}年`;
                        }
                    }
                    
                    answer = timeInfo ? 
                        `${timeInfo}的${fieldDisplayName}为${formattedTotal}${unit}。` :
                        `${fieldDisplayName}为${formattedTotal}${unit}。`;
                }
            }
            
            return answer;
        }
        
        // 调整工作表范围以仅包含有数据的部分
        function adjustSheetRange(worksheet) {
            if (!worksheet['!ref']) return;
            
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            let minRow = range.s.r;
            let maxRow = range.e.r;
            let minCol = range.s.c;
            let maxCol = range.e.c;
            
            let firstRow = maxRow;
            let lastRow = minRow;
            let firstCol = maxCol;
            let lastCol = minCol;
            
            // 遍历工作表中所有的单元格地址
            Object.keys(worksheet).forEach(address => {
                if (address[0] !== '!') { // 跳过特殊属性
                    const cellAddress = XLSX.utils.decode_cell(address);
                    // 更新实际有数据的行和列范围
                    if (cellAddress.r < firstRow) firstRow = cellAddress.r;
                    if (cellAddress.r > lastRow) lastRow = cellAddress.r;
                    if (cellAddress.c < firstCol) firstCol = cellAddress.c;
                    if (cellAddress.c > lastCol) lastCol = cellAddress.c;
                }
            });
            
            // 如果找到了有效的数据范围，则更新worksheet的!ref
            if (firstRow <= lastRow && firstCol <= lastCol) {
                const newRange = { s: { r: firstRow, c: firstCol }, e: { r: lastRow, c: lastCol } };
                worksheet['!ref'] = XLSX.utils.encode_range(newRange);
            }
        }
        
        // 初始化自定义日期选择器
        function initCustomDatePickers() {
            const now = new Date();
            startYear = now.getFullYear();
            endYear = now.getFullYear();
            
            // 生成月份网格
            const months = ['一月', '二月', '三月', '四月', '五月', '六月', 
                            '七月', '八月', '九月', '十月', '十一月', '十二月'];
            
            const startMonthGrid = document.getElementById('start-month-grid');
            const endMonthGrid = document.getElementById('end-month-grid');
            
            months.forEach((month, index) => {
                const startBtn = document.createElement('button');
                startBtn.className = 'month-btn';
                startBtn.textContent = month;
                startBtn.dataset.month = index + 1;
                startBtn.addEventListener('click', function() {
                    selectDataQueryMonth('start', index + 1);
                });
                startMonthGrid.appendChild(startBtn);
                
                const endBtn = document.createElement('button');
                endBtn.className = 'month-btn';
                endBtn.textContent = month;
                endBtn.dataset.month = index + 1;
                endBtn.addEventListener('click', function() {
                    selectDataQueryMonth('end', index + 1);
                });
                endMonthGrid.appendChild(endBtn);
            });
            
            // 设置年份显示
            document.getElementById('start-year-display').textContent = startYear;
            document.getElementById('end-year-display').textContent = endYear;
            
            // 年份控制按钮事件
            document.querySelectorAll('#start-date-picker .prev-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    startYear--;
                    document.getElementById('start-year-display').textContent = startYear;
                });
            });
            
            document.querySelectorAll('#start-date-picker .next-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    startYear++;
                    document.getElementById('start-year-display').textContent = startYear;
                });
            });
            
            document.querySelectorAll('#end-date-picker .prev-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    endYear--;
                    document.getElementById('end-year-display').textContent = endYear;
                });
            });
            
            document.querySelectorAll('#end-date-picker .next-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    endYear++;
                    document.getElementById('end-year-display').textContent = endYear;
                });
            });
            
            // 点击外部关闭日期选择器
            document.addEventListener('click', function(e) {
                const startPicker = document.getElementById('start-date-picker');
                const endPicker = document.getElementById('end-date-picker');
                
                if (!e.target.closest('.date-picker-container')) {
                    startPicker.style.display = 'none';
                    endPicker.style.display = 'none';
                }
            });
            
            // 日期输入框点击事件
            startDateInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const picker = document.getElementById('start-date-picker');
                picker.style.display = 'block';
                document.getElementById('end-date-picker').style.display = 'none';
            });
            
            endDateInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const picker = document.getElementById('end-date-picker');
                picker.style.display = 'block';
                document.getElementById('start-date-picker').style.display = 'none';
            });
        }
        
        // 选择月份
        function selectDataQueryMonth(type, month) {
            const year = type === 'start' ? startYear : endYear;
            const formattedMonth = month.toString().padStart(2, '0');
            const dateString = `${year}-${formattedMonth}`;
            
            if (type === 'start') {
                startMonth = month;
                startDateInput.value = dateString;
                document.getElementById('start-date-picker').style.display = 'none';
                
                // 清除结束日期选择状态
                document.querySelectorAll('#end-date-picker .month-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            } else {
                endMonth = month;
                endDateInput.value = dateString;
                document.getElementById('end-date-picker').style.display = 'none';
                
                // 清除开始日期选择状态
                document.querySelectorAll('#start-date-picker .month-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            }
            
            // 设置选中状态
            document.querySelectorAll(`#${type}-month-grid .month-btn`).forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.month) === month) {
                    btn.classList.add('selected');
                }
            });
        }
        
        // 初始化日期选择器
        function initDatePickers() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); // 0-11
            
            // 设置默认值为上个月
            if (month === 0) {
                year--;
                month = 11;
            } else {
                month--;
            }
            
            const defaultDate = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            
            startDateInput.value = defaultDate;
            endDateInput.value = defaultDate;
            
            // 设置自定义选择器状态
            startYear = year;
            endYear = year;
            startMonth = month + 1;
            endMonth = month + 1;
            
            document.getElementById('start-year-display').textContent = startYear;
            document.getElementById('end-year-display').textContent = endYear;
            
            document.querySelectorAll(`#start-month-grid .month-btn`).forEach(btn => {
                if (parseInt(btn.dataset.month) === startMonth) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            document.querySelectorAll(`#end-month-grid .month-btn`).forEach(btn => {
                if (parseInt(btn.dataset.month) === endMonth) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            defaultChargingFileName = generateFileName(defaultDate, defaultDate);
            defaultComprehensiveFileName = generateFileName(defaultDate, defaultDate);
        }
        
        // 格式化月份显示
        function formatMonthDisplay(dateStr) {
            const [year, month] = dateStr.split('-');
            return `${year}年${parseInt(month)}月`;
        }
        
        // 生成文件名
        function generateFileName(startDate, endDate) {
            const start = startDate.replace('-', '');
            const end = endDate.replace('-', '');
            return `${start}-${end}.xlsx`;
        }
        
        // 生成文件路径
        function generateFilePath(fileName, dataType) {
            const basePath = dataType === 'charging' 
                ? 'https://www.csfhcdz.cn/chargingdata/' 
                : 'https://www.csfhcdz.cn/comprehensivedata/';
            return `${basePath}${fileName}`;
        }
        // 加载并显示Excel数据
        function loadExcelData(filePath, fileName, dataType, isUserQuery = false) {
            // 返回 Promise 以便调用者可以处理错误
            return new Promise((resolve, reject) => {
            const isCharging = dataType === 'charging';
            const loadingElement = isCharging ? dataLoading : comprehensiveLoading;
            const tableElement = isCharging ? tableContainer : comprehensiveTableContainer;
            const infoElement = isCharging ? fileInfo : comprehensiveInfo;
            const rowCountElement = isCharging ? rowCount : comprehensiveRowCount;
            const lastUpdateElement = isCharging ? lastUpdate : comprehensiveLastUpdate;
            
            loadingElement.style.display = 'block';
            
            fetch(filePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: 文件未找到或无法访问`);
                    }
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 调整工作表范围以仅包含有数据的部分
                    adjustSheetRange(worksheet);
                    
                    const tableId = isCharging ? 'excel-table-charging' : 'excel-table-comprehensive';
                    const html = XLSX.utils.sheet_to_html(worksheet, {
                        id: tableId,
                        header: '',
                        footer: ''
                    });
                    
                    tableElement.innerHTML = html;
                    
                    // 添加表格样式
                    const tableEl = tableElement.querySelector('table');
                    if (tableEl) {
                        tableEl.classList.add('excel-table');
                        // 确保表格宽度适应内容
                        tableEl.style.width = 'auto';
                        // 修复列宽问题
                        tableEl.style.tableLayout = 'auto';
                        
                        // 确保单元格内容正确显示
                        const cells = tableEl.querySelectorAll('td, th');
                        cells.forEach(cell => {
                            cell.style.lineHeight = '1.5';
                            cell.style.verticalAlign = 'middle';
                        });
                        // 标记数字为不换行
                        markNumericCells(tableEl);
                        // 处理单位信息左对齐
                        handleUnitInfoAlignment(tableEl);
                    }
                    
                    // 如果是用户查询，设置导出数据
                    if (isUserQuery) {
                        currentExportData = data;
                        currentExportFileName = fileName;
                        currentExportDataType = dataType;
                        exportBtn.disabled = false;
                    }
                    
                    // 更新文件信息
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    infoElement.textContent = `当前显示: ${formatMonthDisplay(startDate)}至${formatMonthDisplay(endDate)}数据`;
                    
                    // 更新行数
                    const table = tableElement.querySelector('table');
                    const rowCountValue = table.rows.length - 1; // 减去表头
                    rowCountElement.textContent = `共加载 ${rowCountValue} 行数据`;
                    
                    // 更新最后更新时间
                    const now = new Date();
                    lastUpdateElement.textContent = `最后更新时间: ${now.toLocaleString()}`;
                    
                    // 显示成功信息
                    queryInfo.innerHTML = `<i class="fas fa-check-circle"></i> 成功加载 ${fileName} 数据`;
                    queryInfo.className = 'query-info success';
                    
                    // 保存为默认数据
                    if (isCharging) {
                        defaultChargingData = data;
                    } else {
                        defaultComprehensiveData = data;
                    }

                    // 只有在用户查询时才滚动到报表区域
                    if (isUserQuery) {
                        document.getElementById('report-section').scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                    
                    resolve({ success: true, fileName, dataType });
                })
                .catch(error => {
                    // 静默处理错误，避免在控制台显示详细的错误堆栈
                    // 只在非默认加载时显示详细错误信息
                    const isDefaultLoad = !isUserQuery;
                    
                    if (!isDefaultLoad) {
                    }
                    
                    loadingElement.style.display = 'none';
                    
                    // 从文件名中提取年月信息
                    const fileNameWithoutExt = fileName.replace('.xlsx', '');
                    // 处理格式如 "202412-202412" 的文件名
                    const dateMatch = fileNameWithoutExt.match(/(\d{4})(\d{2})-\d{4}\d{2}/);
                    let year = '未知';
                    let month = '未知';
                    
                    if (dateMatch) {
                        year = dateMatch[1];
                        month = dateMatch[2];
                    }
                    
                    // 显示具体年月错误信息（无论是默认加载还是用户查询都要显示）
                    if (isUserQuery) {
                        // 用户查询失败时显示详细错误提示
                        const errorMessage = `无法加载文件: ${fileName}\n错误: ${error.message}\n这可能是由于文件不存在或网络连接问题引起的。`;
                        infoElement.textContent = errorMessage;
                        infoElement.style.color = '#dc3545';
                        
                        const startDate = startDateInput.value;
                        const endDate = endDateInput.value;
                        queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 没有找到${startDate}至${endDate}之间的数据`;
                        queryInfo.className = 'query-info error';
                        
                        // 更新"当前显示"信息
                        const errorMessage2 = `没有找到${year}年${month}月的数据`;
                        infoElement.textContent = errorMessage2;
                        infoElement.style.color = '#e74c3c';
                        
                        // 更新行数和更新时间信息
                        rowCountElement.textContent = '共加载 0 行数据';
                        lastUpdateElement.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
                        
                        // 15秒后恢复默认提示
                        setTimeout(() => {
                            queryInfo.innerHTML = '<i class="fas fa-info-circle"></i> 请选择日期和数据类型来查询数据';
                            queryInfo.className = 'query-info';
                        }, 15000);
                    } else {
                        // 默认加载失败时也显示年月信息（但不在控制台输出详细错误）
                        const errorMessage = `没有找到${year}年${month}月的数据`;
                        if (isCharging) {
                            fileInfo.textContent = errorMessage;
                            fileInfo.style.color = '#e74c3c';
                            // 更新行数和更新时间信息
                            rowCount.textContent = '共加载 0 行数据';
                            lastUpdate.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
                        } else {
                            comprehensiveInfo.textContent = errorMessage;
                            comprehensiveInfo.style.color = '#e74c3c';
                            // 更新行数和更新时间信息
                            comprehensiveRowCount.textContent = '共加载 0 行数据';
                            comprehensiveLastUpdate.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
                        }
                    }
                    
                    // 清空表格内容
                    tableElement.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><i class="fas fa-exclamation-triangle"></i> 暂无数据</div>';
                    
                    // 如果是用户查询，重置导出数据
                    if (isUserQuery) {
                        currentExportData = null;
                        exportBtn.disabled = true;
                    }
                    
                    reject(error);
                })
                .finally(() => {
                    loadingElement.style.display = 'none';
                    queryBtn.classList.remove('loading');
                });
                });
        }
        
        // 从数据渲染Excel表格
        function renderExcelFromData(data, container) {
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 调整工作表范围以仅包含有数据的部分
            adjustSheetRange(worksheet);
            
            const containerId = container === tableContainer ? 'excel-table-charging' : 'excel-table-comprehensive';
            const html = XLSX.utils.sheet_to_html(worksheet, {
                id: containerId,
                header: '',
                footer: ''
            });
            
            container.innerHTML = html;
            
            const tableEl = container.querySelector('table');
            if (tableEl) {
                tableEl.classList.add('excel-table');
                tableEl.style.width = 'auto';
                tableEl.style.tableLayout = 'auto';
                
                // 确保单元格内容正确显示
                const cells = tableEl.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.style.lineHeight = '1.5';
                    cell.style.verticalAlign = 'middle';
                });
                // 标记数字为不换行
                markNumericCells(tableEl);
                // 处理单位信息左对齐
                handleUnitInfoAlignment(tableEl);
            }
        }
        
        // 加载默认数据
        function loadDefaultData() {
            try {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); // 0-11
            
            // 设置默认值为上个月
            if (month === 0) {
                year--;
                month = 11;
            } else {
                month--;
            }
            
            const defaultDate = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            const chargingFileName = generateFileName(defaultDate, defaultDate);
            const chargingFilePath = generateFilePath(chargingFileName, 'charging');
            
                // 加载默认充电数据（捕获错误但不阻塞，完全静默处理）
                loadExcelData(chargingFilePath, chargingFileName, 'charging').catch(() => {
                    // 完全静默处理，不输出任何信息（默认文件可能不存在是正常情况）
                });
                
                // 加载默认综合数据（捕获错误但不阻塞，完全静默处理）
            const comprehensiveFileName = generateFileName(defaultDate, defaultDate);
            const comprehensiveFilePath = generateFilePath(comprehensiveFileName, 'comprehensive');
                loadExcelData(comprehensiveFilePath, comprehensiveFileName, 'comprehensive').catch(() => {
                    // 完全静默处理，不输出任何信息（默认文件可能不存在是正常情况）
                });
            } catch (err) {
                // 不抛出错误，避免阻塞页面初始化
            }
        }
        
        // 导出Excel文件
        function exportExcel() {
            if (!currentExportData) {
                alert('没有查询数据导出');
                return;
            }
            
            const blob = new Blob([currentExportData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = currentExportFileName;
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        // 查询按钮点击事件
        queryBtn.addEventListener('click', function() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const dataType = dataTypeSelect.value;
            
            if (!startDate || !endDate) {
                queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 请选择开始日期和结束日期`;
                queryInfo.className = 'query-info error';
                return;
            }
            
            // 检查结束日期是否小于开始日期
            if (endDate < startDate) {
                queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 结束日期不能早于开始日期`;
                queryInfo.className = 'query-info error';
                return;
            }
            
            // 显示加载状态
            this.classList.add('loading');
            
            const fileName = generateFileName(startDate, endDate);
            const filePath = generateFilePath(fileName, dataType);
            
            // 设置当前数据类型
            currentDataType = dataType;
            
            // 加载Excel数据 (标记为用户查询)
            loadExcelData(filePath, fileName, dataType, true);
        });
        
        // 导出按钮点击事件
        exportBtn && exportBtn.addEventListener('click', exportExcel);
        
        // 菜单项点击事件
        document.querySelectorAll('.menu-item').forEach(item => {
            const submenu = item.nextElementSibling;
            if (!submenu || !submenu.classList.contains('submenu')) {
                item.addEventListener('click', function() {
                    if (this !== document.querySelector('.menu-item.active')) {
                        document.querySelector('.menu-item.active').classList.remove('active');
                        this.classList.add('active');
                    }
                });
            }
            
            const toggle = item.querySelector('.menu-toggle');
            if (toggle) {
                item.addEventListener('click', function(e) {
                    if (e.target !== toggle && !toggle.contains(e.target)) {
                        const submenu = this.nextElementSibling;
                        if (submenu && submenu.classList.contains('submenu')) {
                            this.classList.toggle('expanded');
                            submenu.classList.toggle('expanded');
                        }
                    }
                });
            }
        });
        
        // 为特定菜单项添加点击事件
       
        document.getElementById('ai-model').addEventListener('click', function(e) {
            e.stopPropagation();
            showAIModelPage();
        });
        
        
        document.getElementById('history-menu').addEventListener('click', function(e) {
            e.stopPropagation();
            showFeaturePopup('历史记录功能暂未开放');
        });
        
        // 关闭弹窗事件
        closePopup.addEventListener('click', closeFeaturePopup);
        confirmPopup.addEventListener('click', closeFeaturePopup);




        
        // 检查登录状态
        function checkLoginStatus() {
            try {
                // 检查localStorage中是否有登录信息
                const savedUserInfo = sessionStorage.getItem('userLoginInfo');
                if (savedUserInfo) {
                    const userInfo = JSON.parse(savedUserInfo);
                    const currentTime = new Date().getTime();
                    const SESSION_TIMEOUT = 15 * 60 * 1000; // 15分钟会话超时
                    const LOGIN_EXPIRY = 24 * 60 * 60 * 1000; // 24小时登录有效期
                    const timeSinceLogin = currentTime - userInfo.loginTime;
                    
                    // 首先检查会话是否超时（15分钟）
                    if (timeSinceLogin >= SESSION_TIMEOUT) {
                        // 会话已超时，清除登录状态
                        sessionStorage.removeItem('userLoginInfo');
                        return false;
                    }
                    
                    // 检查登录是否过期（24小时）
                    if (timeSinceLogin < LOGIN_EXPIRY) {
                        
                        // 恢复用户状态
                        const user = new AV.User();
                        user.set('username', userInfo.username);
                        user.set('mobilePhoneNumber', userInfo.mobilePhoneNumber);
                        user.set('loginMethod', userInfo.loginMethod);
                        AV.User.current = () => user;
                        
                        // 显示主页面
                        showMainPage(userInfo.username);
                        return true;
                    } else {
                        sessionStorage.removeItem('userLoginInfo');
                    }
                }
            } catch (error) {
                sessionStorage.removeItem('userLoginInfo');
            }
            return false;
        }
        
        // 显示主页面
        function showMainPage(username) {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('login-header-title').style.display = 'none';
            document.getElementById('login-footer-copyright').style.display = 'none';
            // 隐藏星空背景并彻底销毁Canvas实例和requestAnimationFrame循环
            document.getElementById('nebula').style.display = 'none';
            document.getElementById('starfield').style.display = 'none';
            stopStarfield(); // 彻底销毁星空动画，释放资源
            document.getElementById('user-display').textContent = username;
            initMainSystem();
            
            // 登录成功后再初始化较耗时的数据和图表，避免阻塞登录页面加载
            try {
                loadOverviewData();
                initVisualizationAnalysis();
                initUserBehaviorAnalysis();
                initEfficiencyAnalysis();
            } catch (e) {
                // 忽略单个初始化失败，不影响主界面其它功能
                console.error('初始化数据分析模块失败', e);
            }
            
            // 启动用户活动跟踪
            initActivityTracking();
        }
        
        // 保存登录状态
        function saveLoginStatus(username, loginMethod, mobilePhoneNumber = null) {
            try {
                const userInfo = {
                    username: username,
                    loginMethod: loginMethod,
                    mobilePhoneNumber: mobilePhoneNumber,
                    loginTime: new Date().getTime()
                };
                sessionStorage.setItem('userLoginInfo', JSON.stringify(userInfo));
            } catch (error) {
            }
        }
        
        // 清除登录状态
        function clearLoginStatus() {
            try {
                sessionStorage.removeItem('userLoginInfo');
                localStorage.removeItem('lastLoginRecordId');
            } catch (error) {
            }
        }
        // 会话超时管理
        let sessionTimeoutTimer = null;
        let lastActivityTime = Date.now();
        const SESSION_TIMEOUT = 15 * 60 * 1000; // 15分钟
        // 重置会话超时计时器
        function resetSessionTimeout() {
            lastActivityTime = Date.now();
            if (sessionTimeoutTimer) {
                clearTimeout(sessionTimeoutTimer);
            }
            
            sessionTimeoutTimer = setTimeout(() => {
                handleSessionTimeout();
            }, SESSION_TIMEOUT);
            
        }
        
        // 处理会话超时
        async function handleSessionTimeout() {
            
            // 记录登出信息
            try {
                const currentUser = AV.User.current();
                if (currentUser) {
                    await recordUserLogout(currentUser.getUsername());
                }
            } catch (error) {
            }
            
            // 清除登录状态（必须先清除，避免其他逻辑误判）
            clearLoginStatus();
            
            // 清除AV.User的当前用户状态，防止误显示登录成功消息
            try {
                AV.User.current = () => null;
                await AV.User.logOut();
            } catch (error) {
                // 忽略登出错误
            }
            
            // 显示会话超时提示
            showSessionTimeoutMessage();
        }
        
        // 显示会话超时提示
        function showSessionTimeoutMessage() {
            // 清理会话超时计时器
            if (sessionTimeoutTimer) {
                clearTimeout(sessionTimeoutTimer);
                sessionTimeoutTimer = null;
            }
            
            // 重置活动跟踪状态
            activityTrackingInitialized = false;
            
            // 隐藏主页面，显示登录页面
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('login-header-title').style.display = 'block';
            document.getElementById('login-footer-copyright').style.display = 'block';
            // 显示星空背景
            document.getElementById('nebula').style.display = 'block';
            document.getElementById('starfield').style.display = 'block';
            
            // 重新初始化星空背景动画
            setTimeout(function() {
                initStarfield();
            }, 100);
            
            // 确保显示登录表单而不是其他表单
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('resetForm').style.display = 'none';
            document.getElementById('smsLoginForm').style.display = 'none';
            document.getElementById('form-title').textContent = '用户登录';
            document.querySelector('#login-container .logo i').className = 'fas fa-user-lock';
            
            // 清空登录表单
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('smsPhone').value = '';
            document.getElementById('smsCode').value = '';
            
            // 显示会话超时消息（直接操作loginMessage元素）
            const loginMessage = document.getElementById('loginMessage');
            if (loginMessage) {
                loginMessage.textContent = '登录超时，请重新登录';
                loginMessage.className = 'message error';
                loginMessage.style.display = 'block';
            }
        }
        // 初始化用户活动监听
        let activityTrackingInitialized = false;
        function initActivityTracking() {
            if (activityTrackingInitialized) {
                // 如果已经初始化，只重置计时器
                resetSessionTimeout();
                return;
            }
            
            // 监听各种用户活动
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            
            activityEvents.forEach(event => {
                document.addEventListener(event, () => {
                    resetSessionTimeout();
                }, true);
            });
            
            // 初始启动计时器
            resetSessionTimeout();
            activityTrackingInitialized = true;
        }

        // 初始化系统
        window.addEventListener('DOMContentLoaded', function() {
            // 优先初始化登录系统，确保登录功能立即可用
            initLoginSystem();
            
            // 首先检查登录状态
            if (!checkLoginStatus()) {
                // 如果没有有效登录状态，显示登录界面
                document.getElementById('login-container').style.display = 'flex';
                document.getElementById('main-container').style.display = 'none';
                // 显示星空背景
                document.getElementById('nebula').style.display = 'block';
                document.getElementById('starfield').style.display = 'block';
            }
            
            // 设置AI查询输入框的placeholder为当前年份
            var aiQueryInput = document.getElementById('ai-query-input');
            if (aiQueryInput) {
                var currentYear = new Date().getFullYear();
                aiQueryInput.placeholder = '如：' + currentYear + '年充电电量有多少';
            }
            
            // 延迟初始化星空动画，避免阻塞登录功能
            // 使用setTimeout确保登录系统先初始化完成
            setTimeout(function() {
                initStarfield();
            }, 100);
        });
        
        // 时间显示更新
        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekday = weekdays[now.getDay()];
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            document.getElementById('time-display').textContent = 
                `${year}年${month}月${day}日 ${weekday} ${hours}:${minutes}:${seconds}`;
        }
        
        setInterval(updateTime, 1000);
        updateTime();

        // 格式化数字显示（解决科学计数法问题）
        // 修改后的格式化函数
function formatNumber(value) {
    // 检查是否为整数（包括浮点数表示的整数）
    if (Number.isInteger(value) || Math.abs(value - Math.round(value)) < 1e-6) {
        // 整数：直接格式化为整数
        return Math.round(value).toLocaleString();
    } else {
        // 非整数：使用原来的处理方式
        if (typeof value === 'number' && (Math.abs(value) > 1e6 || Math.abs(value) < 1e-6)) {
            return value.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        return value.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
}

        // 初始化图表
        function initCharts() {
           


            // 充电数据总趋势图表
            const chargingTrendCtx = document.getElementById('charging-trend-chart').getContext('2d');
           chargingTrendChart = new Chart(chargingTrendCtx, {
    type: 'line',
    data: {
        labels: [], // 改为空数组
        datasets: [
            {
                label: '充电量 (kwh)',
                data: [], // 改为空数组
                            borderColor: 'rgba(26, 115, 232, 1)',
                            backgroundColor: 'rgba(26, 115, 232, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: '充电服务费收入 (元)',
                data: [], // 改为空数组
                            borderColor: 'rgba(0, 200, 83, 1)',
                            backgroundColor: 'rgba(0, 200, 83, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '充电量 (kwh)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '服务费收入 (元)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            // 强制同步刻度范围
                            min: 0,
                            max: 7000000,
                            ticks: {
                                // 设置固定的刻度步长
                                stepSize: 1000000,
                                // 格式化刻度值
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // 各版块收入汇总图表
            const revenueBySectorCtx = document.getElementById('revenue-by-sector-chart').getContext('2d');
revenueBySectorChart = new Chart(revenueBySectorCtx, {
    type: 'bar',
    data: {
        labels: [], // 清空硬编码的标签
        datasets: [
            {
                label: '2023年收入 (元)',
                data: [], // 清空硬编码数据
                backgroundColor: 'rgba(26, 115, 232, 0.7)',
                borderColor: 'rgba(26, 115, 232, 1)',
                borderWidth: 1
            },
            {
                label: '2024年收入 (元)',
                data: [], // 清空硬编码数据
                backgroundColor: 'rgba(0, 200, 83, 0.7)',
                borderColor: 'rgba(0, 200, 83, 1)',
                borderWidth: 1
            },
            {
                label: '2025年收入 (元)',
                data: [], // 清空硬编码数据
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 1
            },
            {
                label: '2026年收入 (元)',
                data: [],
                backgroundColor: 'rgba(156, 39, 176, 0.7)',
                borderColor: 'rgba(156, 39, 176, 1)',
                borderWidth: 1
            }
                ]
    },
              options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: '收入 (元)'
                }
            }
        }
    }
});

            // 年度总收入趋势图表
            const annualRevenueTrendCtx = document.getElementById('annual-revenue-trend-chart').getContext('2d');
            annualRevenueTrendChart = new Chart(annualRevenueTrendCtx, {
    type: 'line',
    data: {
        labels: [], // 改为空数组
        datasets: [
            {
                label: '年度总收入 (元)',
                data: [], // 改为空数组
                            borderColor: 'rgba(156, 39, 176, 1)',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '总收入 (元)'
                            }
                        }
                    }
                }
            });

               
            // 图表按钮事件
            document.querySelectorAll('.chart-action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.textContent.includes('导出')) {
                        const canvas = this.closest('.chart-container').querySelector('canvas');
                        const link = document.createElement('a');
                        link.download = '图表导出.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    } else {
                        // 刷新数据
                        loadMetricsData();
                        alert('数据已刷新！');
                    }
                });
            });
        }

        // 站点数据统计相关函数
let siteStatsData = [];
let currentMode = 'month';
let currentPage = 0;
let availablePages = [];

// 加载站点统计数据（优化版：使用缓存）
function loadSiteStatsData() {
    // 使用缓存管理器加载数据
    resourceCache.get('https://www.csfhcdz.cn/data/hzsj.xlsx')
        .then(workbook => {
            
            // 获取Sheet1工作表
            const sheet = workbook.Sheets['Sheet1'];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            // 处理数据
            siteStatsData = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row.length >= 7) {
                    const record = {
                        '充电时间': row[0],
                        '站点': row[1],
                        '充电量(kwh)': row[2] || 0,
                        '充电电费(元)': row[3] || 0,
                        '充电服务费(元)': row[4] || 0,
                        '充电总收入(元)': row[5] || 0,
                        '总订单数量': row[6] || 0
                    };
                    siteStatsData.push(record);
                }
            }
            
            
            // 初始化页面
            initSiteStatsPage();
            updateAvailablePages();
            loadCurrentPageData();
        })
        .catch(error => {
        });
}

// 初始化站点统计页面
function initSiteStatsPage() {
    // 绑定模式切换按钮事件
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // 移除所有active类
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            // 添加active类到当前按钮
            this.classList.add('active');
            
            currentMode = this.getAttribute('data-mode');
            currentPage = 0;
            
            updateAvailablePages();
            loadCurrentPageData();
        });
    });
    
    // 绑定翻页按钮事件
    document.getElementById('prev-btn').addEventListener('click', function() {
        if (currentPage > 0) {
            currentPage--;
            loadCurrentPageData();
        }
    });
    
    document.getElementById('next-btn').addEventListener('click', function() {
        if (currentPage < availablePages.length - 1) {
            currentPage++;
            loadCurrentPageData();
        }
    });
}

// 更新可用页面列表
function updateAvailablePages() {
    availablePages = [];
    
    if (currentMode === 'total') {
        availablePages = ['总数据'];
    } else {
        // 获取所有唯一的年月组合
        const dateMap = new Map();
        
        siteStatsData.forEach(item => {
            if (item['充电时间']) {
                let dateStr = item['充电时间'];
                if (typeof dateStr === 'string') {
                    // 处理yyyy-mm格式
                    const match = dateStr.match(/^(\d{4})-(\d{1,2})$/);
                    if (match) {
                        const year = parseInt(match[1]);
                        const month = parseInt(match[2]);
                        const key = `${year}-${month.toString().padStart(2, '0')}`;
                        
                        if (currentMode === 'year') {
                            const yearKey = year.toString();
                            if (!dateMap.has(yearKey)) {
                                dateMap.set(yearKey, []);
                            }
                            dateMap.get(yearKey).push(item);
                        } else if (currentMode === 'month') {
                            if (!dateMap.has(key)) {
                                dateMap.set(key, []);
                            }
                            dateMap.get(key).push(item);
                        }
                    }
                }
            }
        });
        
        // 排序并生成页面列表
        const sortedKeys = Array.from(dateMap.keys()).sort();
        availablePages = sortedKeys;
    }
    
    // 更新翻页按钮状态
    updatePaginationButtons();
}

// 更新翻页按钮状态
function updatePaginationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageInfo = document.getElementById('page-info');
    
    prevBtn.disabled = currentPage <= 0;
    nextBtn.disabled = currentPage >= availablePages.length - 1;
    
    if (availablePages.length > 0) {
        pageInfo.textContent = availablePages[currentPage] || '无数据';
    } else {
        pageInfo.textContent = '无数据';
    }
}
// 加载当前页面数据
function loadCurrentPageData() {
    if (availablePages.length === 0) {
        // 显示空数据
        displayEmptyData();
        return;
    }
    
    const currentPageKey = availablePages[currentPage];
    let filteredData = [];
    
    if (currentMode === 'total') {
        filteredData = siteStatsData;
    } else {
        filteredData = siteStatsData.filter(item => {
            if (!item['充电时间']) return false;
            
            let dateStr = item['充电时间'];
            if (typeof dateStr === 'string') {
                const match = dateStr.match(/^(\d{4})-(\d{1,2})$/);
                if (match) {
                    const year = parseInt(match[1]);
                    const month = parseInt(match[2]);
                    
                    if (currentMode === 'year') {
                        return year.toString() === currentPageKey;
                    } else if (currentMode === 'month') {
                        return `${year}-${month.toString().padStart(2, '0')}` === currentPageKey;
                    }
                }
            }
            return false;
        });
    }
    
    // 计算统计数据
    const stats = calculateSiteStats(filteredData);
    
    // 显示数据
    displaySiteStats(stats);
    updatePaginationButtons();
}

// 计算站点统计数据
function calculateSiteStats(data) {
    const sifangData = data.filter(item => item['站点'] === '四方坪站');
    const gaolingData = data.filter(item => item['站点'] === '高岭站');
    
    const sifangStats = calculateSingleSiteStats(sifangData);
    const gaolingStats = calculateSingleSiteStats(gaolingData);
    
    const totalStats = {
        charge: sifangStats.charge + gaolingStats.charge,
        service: sifangStats.service + gaolingStats.service,
        total: sifangStats.total + gaolingStats.total
    };
    
    return {
        sifang: sifangStats,
        gaoling: gaolingStats,
        total: totalStats
    };
}

// 计算单个站点的统计数据
function calculateSingleSiteStats(data) {
    return {
        charge: data.reduce((sum, item) => sum + (parseFloat(item['充电量(kwh)']) || 0), 0),
        service: data.reduce((sum, item) => sum + (parseFloat(item['充电服务费(元)']) || 0), 0),
        total: data.reduce((sum, item) => sum + (parseFloat(item['充电总收入(元)']) || 0), 0)
    };
}

// 显示站点统计数据
function displaySiteStats(stats) {
    // 更新四方坪站数据
    updateSiteData('sifang', stats.sifang);
    
    // 更新高岭站数据
    updateSiteData('gaoling', stats.gaoling);
    
    // 更新两站共计数据
    updateSiteData('total', stats.total);
}
// 更新单个站点数据
function updateSiteData(site, stats) {
    const prefix = site === 'sifang' ? 'sifang' : site === 'gaoling' ? 'gaoling' : 'total';
    
    // 更新数值显示
    let chargeText = stats.charge.toFixed(2);
    let serviceText = stats.service.toFixed(2);
    let totalText = stats.total.toFixed(2);
    
    // 如果是年份数据模式，计算百分比
    if (currentMode === 'year') {
        const currentYear = parseInt(availablePages[currentPage]);
        const prevYear = currentYear - 1;
        
        // 获取上一年的数据
        const prevYearData = siteStatsData.filter(item => {
            if (!item['充电时间']) return false;
            const itemYear = parseInt(item['充电时间'].substring(0, 4));
            return itemYear === prevYear;
        });
        
        if (prevYearData && prevYearData.length > 0) {
            // 根据站点类型过滤数据
            let filteredPrevData;
            if (site === 'sifang') {
                filteredPrevData = prevYearData.filter(item => item['站点'] === '四方坪站');
            } else if (site === 'gaoling') {
                filteredPrevData = prevYearData.filter(item => item['站点'] === '高岭站');
            } else {
                filteredPrevData = prevYearData; // 总数据
            }
            
            const prevStats = calculateSingleSiteStats(filteredPrevData);
            
            // 计算百分比
            const chargePercent = prevStats.charge > 0 ? ((stats.charge - prevStats.charge) / prevStats.charge * 100) : 0;
            const servicePercent = prevStats.service > 0 ? ((stats.service - prevStats.service) / prevStats.service * 100) : 0;
            const totalPercent = prevStats.total > 0 ? ((stats.total - prevStats.total) / prevStats.total * 100) : 0;
            
            // 添加百分比显示（带颜色）
            const chargePercentClass = chargePercent >= 0 ? 'percentage-increase' : 'percentage-decrease';
            const servicePercentClass = servicePercent >= 0 ? 'percentage-increase' : 'percentage-decrease';
            const totalPercentClass = totalPercent >= 0 ? 'percentage-increase' : 'percentage-decrease';
            
            chargeText += ` (<span class="${chargePercentClass}">${chargePercent >= 0 ? '+' : ''}${chargePercent.toFixed(1)}%</span>)`;
            serviceText += ` (<span class="${servicePercentClass}">${servicePercent >= 0 ? '+' : ''}${servicePercent.toFixed(1)}%</span>)`;
            totalText += ` (<span class="${totalPercentClass}">${totalPercent >= 0 ? '+' : ''}${totalPercent.toFixed(1)}%</span>)`;
        }
    }
    
    document.getElementById(`${prefix}-charge-value`).innerHTML = chargeText;
    document.getElementById(`${prefix}-service-value`).innerHTML = serviceText;
    document.getElementById(`${prefix}-total-value`).innerHTML = totalText;
    
    // 根据当前数据模式设置不同的最大值
    let maxValues;
    if (currentMode === 'month') {
        // 月份数据：最大值800000
        maxValues = {
            charge: 600000,
            service: 600000,
            total: 600000
        };
    } else if (currentMode === 'year') {
        // 年份数据：最大值10000000
        maxValues = {
            charge: 7800000,
            service: 7800000,
            total: 7800000
        };
    } else if (currentMode === 'total') {
        // 总数据：最大值150000000
        maxValues = {
            charge: 50000000,
            service: 50000000,
            total: 50000000
        };
    } else {
        // 默认值
        maxValues = {
            charge: 35000000,
            service: 35000000,
            total: 35000000
        };
    }
    
    // 更新进度条
    updateProgressBar(`${prefix}-charge-fill`, stats.charge, maxValues.charge);
    updateProgressBar(`${prefix}-service-fill`, stats.service, maxValues.service);
    updateProgressBar(`${prefix}-total-fill`, stats.total, maxValues.total);
}

// 更新进度条
function updateProgressBar(elementId, value, maxValue) {
    const fillElement = document.getElementById(elementId);
    if (fillElement) {
        const percentage = Math.min((value / maxValue) * 100, 100);
        fillElement.style.width = `${percentage}%`;
    }
}

// 显示空数据
function displayEmptyData() {
    const sites = ['sifang', 'gaoling', 'total'];
    
    // 根据当前数据模式设置不同的最大值
    let maxValues;
    if (currentMode === 'month') {
        // 月份数据：最大值800000
        maxValues = {
            charge: 800000,
            service: 800000,
            total: 800000
        };
    } else if (currentMode === 'year') {
        // 年份数据：最大值10000000
        maxValues = {
            charge: 10000000,
            service: 10000000,
            total: 10000000
        };
    } else if (currentMode === 'total') {
        // 总数据：最大值150000000
        maxValues = {
            charge: 150000000,
            service: 150000000,
            total: 150000000
        };
    } else {
        // 默认值
        maxValues = {
            charge: 35000000,
            service: 35000000,
            total: 35000000
        };
    }
    
    sites.forEach(site => {
        document.getElementById(`${site}-charge-value`).textContent = '0.00';
        document.getElementById(`${site}-service-value`).textContent = '0.00';
        document.getElementById(`${site}-total-value`).textContent = '0.00';
        
        updateProgressBar(`${site}-charge-fill`, 0, maxValues.charge);
        updateProgressBar(`${site}-service-fill`, 0, maxValues.service);
        updateProgressBar(`${site}-total-fill`, 0, maxValues.total);
    });
}

// 刷新站点统计数据
function refreshSiteStatsData() {
    loadSiteStatsData();
}

// 设置定时刷新（每5分钟刷新一次数据）
// setInterval(refreshSiteStatsData, 5 * 60 * 1000); // 已禁用自动刷新功能

        // 充电数据看板相关函数
let chargingBoardData = [];

// 加载充电数据看板数据
function loadChargingBoardData() {
    // 使用缓存管理器加载数据（与loadMetricsData共享缓存）
    resourceCache.get('https://www.csfhcdz.cn/data/homepage.xlsx')
        .then(workbook => {
            
            // 获取Chargingdata工作表
            const chargingSheet = workbook.Sheets['Chargingdata'];
            const jsonData = XLSX.utils.sheet_to_json(chargingSheet, { header: 1 });
            
            // 保存表头和数据
            const headers = jsonData[0];
            chargingBoardData = jsonData.slice(1).map(row => {
                let obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index];
                });
                return obj;
            });
            
            // 初始化年份选择器（包含初始渲染）
            initYearSelect();
        })
        .catch(error => {
        });
}

// 将时间值转换为Date对象的辅助函数
function parseTimeToDate(dateValue) {
    if (!dateValue) return null;
    
    // 如果是Date对象
    if (dateValue instanceof Date) {
        return dateValue;
    }
    
    // 如果是数字
    if (typeof dateValue === 'number') {
        // Excel日期序列号转换
        if (dateValue > 25569) {
            const date = new Date((dateValue - 25569) * 86400 * 1000);
            if (!isNaN(date.getTime())) {
                return date;
            }
        }
        // 如果数字本身就是年份（如2026、2027），转换为该年1月1日
        if (dateValue >= 1900 && dateValue <= 2100) {
            return new Date(Math.floor(dateValue), 0, 1);
        }
    }
    
    // 如果是字符串
    if (typeof dateValue === 'string') {
        const date = new Date(dateValue);
        if (!isNaN(date.getTime())) {
            return date;
        }
    }
    
    return null;
}

// 提取年份的辅助函数
function extractYear(dateValue) {
    if (!dateValue) return null;
    
    // 如果是Date对象
    if (dateValue instanceof Date) {
        return dateValue.getFullYear();
    }
    
    // 如果是数字（可能是Excel日期序列号）
    if (typeof dateValue === 'number') {
        // Excel日期序列号转换
        if (dateValue > 25569) { // 可能是Excel日期序列号
            const date = new Date((dateValue - 25569) * 86400 * 1000);
            if (!isNaN(date.getTime())) {
                return date.getFullYear();
            }
        }
        // 如果数字本身就是年份（如2026）
        if (dateValue >= 1900 && dateValue <= 2100) {
            return Math.floor(dateValue);
        }
    }
    
    // 如果是字符串
    if (typeof dateValue === 'string') {
        // 尝试直接解析为日期
        const date = new Date(dateValue);
        if (!isNaN(date.getTime())) {
            return date.getFullYear();
        }
        
        // 使用正则表达式提取4位数字年份
        const match = dateValue.match(/(\d{4})/);
        if (match) {
            const year = parseInt(match[1]);
            if (year >= 1900 && year <= 2100) {
                return year;
            }
        }
    }
    
    return null;
}

// 初始化年份选择器（翻页按钮）
function initYearSelect() {
    const yearSelect = document.getElementById('year-select');
    const prevBtn = document.getElementById('year-prev-btn');
    const nextBtn = document.getElementById('year-next-btn');
    
    // 获取数据中存在的年份
    const years = new Set();
    chargingBoardData.forEach(item => {
        if (item['时间']) {
            const year = extractYear(item['时间']);
            if (year) {
                years.add(year);
            }
        }
    });
    
    // 排序年份
    const sortedYears = Array.from(years).sort((a, b) => a - b);
    
    // 调试信息：输出提取到的年份
    console.log('充电数据表格 - 提取到的年份:', sortedYears);
    
    // 将可用年份列表存储到元素上
    yearSelect.dataset.availableYears = JSON.stringify(sortedYears);
    
    // 设置默认选中当前年份
    const currentYear = new Date().getFullYear();
    let initialYear = currentYear;
    if (!sortedYears.includes(currentYear) && sortedYears.length > 0) {
        initialYear = sortedYears[sortedYears.length - 1]; // 如果没有当前年份，选择最后一个
    }
    
    yearSelect.value = initialYear + '年';
    yearSelect.dataset.currentYear = initialYear;
    
    // 更新按钮状态
    updateYearButtons(yearSelect, prevBtn, nextBtn, sortedYears);
    
    // 初始渲染
    renderChargingBoardTable(initialYear);
    
    // 添加翻页按钮事件监听
    prevBtn.addEventListener('click', function() {
        const availableYears = JSON.parse(yearSelect.dataset.availableYears);
        const currentYear = parseInt(yearSelect.dataset.currentYear);
        const currentIndex = availableYears.indexOf(currentYear);
        
        if (currentIndex > 0) {
            const prevYear = availableYears[currentIndex - 1];
            yearSelect.value = prevYear + '年';
            yearSelect.dataset.currentYear = prevYear;
            updateYearButtons(yearSelect, prevBtn, nextBtn, availableYears);
            renderChargingBoardTable(prevYear);
        }
    });
    
    nextBtn.addEventListener('click', function() {
        const availableYears = JSON.parse(yearSelect.dataset.availableYears);
        const currentYear = parseInt(yearSelect.dataset.currentYear);
        const currentIndex = availableYears.indexOf(currentYear);
        
        if (currentIndex < availableYears.length - 1) {
            const nextYear = availableYears[currentIndex + 1];
            yearSelect.value = nextYear + '年';
            yearSelect.dataset.currentYear = nextYear;
            updateYearButtons(yearSelect, prevBtn, nextBtn, availableYears);
            renderChargingBoardTable(nextYear);
        }
    });
}

// 更新年份翻页按钮状态
function updateYearButtons(yearSelect, prevBtn, nextBtn, availableYears) {
    const currentYear = parseInt(yearSelect.dataset.currentYear);
    const currentIndex = availableYears.indexOf(currentYear);
    
    // 更新按钮样式（禁用状态）
    if (currentIndex <= 0) {
        prevBtn.style.opacity = '0.4';
        prevBtn.style.cursor = 'not-allowed';
    } else {
        prevBtn.style.opacity = '1';
        prevBtn.style.cursor = 'pointer';
    }
    
    if (currentIndex >= availableYears.length - 1) {
        nextBtn.style.opacity = '0.4';
        nextBtn.style.cursor = 'not-allowed';
    } else {
        nextBtn.style.opacity = '1';
        nextBtn.style.cursor = 'pointer';
    }
}
// 渲染充电数据看板表格
function renderChargingBoardTable(year) {
    const tableBody = document.getElementById('charging-board-table-body');
    tableBody.innerHTML = '';
    
    // 过滤出指定年份的数据
    const yearData = chargingBoardData.filter(item => {
        if (item['时间']) {
            const itemYear = extractYear(item['时间']);
            return itemYear === year;
        }
        return false;
    });
    
    // 按时间排序
    yearData.sort((a, b) => {
        const dateA = parseTimeToDate(a['时间']);
        const dateB = parseTimeToDate(b['时间']);
        if (!dateA && !dateB) return 0;
        if (!dateA) return 1;
        if (!dateB) return -1;
        return dateA.getTime() - dateB.getTime();
    });
    
    // 填充数据
    let totalCharge = 0;
    let totalElectricity = 0;
    let totalService = 0;
    let totalIncome = 0;
    let totalOrders = 0;
    
    yearData.forEach(item => {
        const row = document.createElement('tr');
        
        // 格式化时间显示为yyyy-mm
        let timeDisplay = '';
        if (item['时间'] instanceof Date) {
            const date = item['时间'];
            timeDisplay = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        } else if (typeof item['时间'] === 'string') {
            const date = new Date(item['时间']);
            if (!isNaN(date.getTime())) {
                timeDisplay = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            } else {
                timeDisplay = item['时间'];
            }
        } else if (typeof item['时间'] === 'number') {
            // 处理数字类型：可能是Excel日期序列号或年份
            if (item['时间'] > 25569) {
                // 可能是Excel日期序列号
                const date = new Date((item['时间'] - 25569) * 86400 * 1000);
                if (!isNaN(date.getTime())) {
                    timeDisplay = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                } else {
                    timeDisplay = item['时间'].toString();
                }
            } else if (item['时间'] >= 1900 && item['时间'] <= 2100) {
                // 如果数字本身就是年份（如2026、2027），显示为年份-01
                timeDisplay = `${Math.floor(item['时间'])}-01`;
            } else {
                timeDisplay = item['时间'].toString();
            }
        }
        
        row.innerHTML = `
            <td>${timeDisplay}</td>
            <td>${formatNumber(item['充电量(kwh)'])}</td>
            <td>${formatNumber(item['充电电费(元)'])}</td>
            <td>${formatNumber(item['充电服务费(元)'])}</td>
            <td>${formatNumber(item['充电总收入(元)'])}</td>
            <td>${formatNumber(item['总订单数量'])}</td>
        `;
        
        tableBody.appendChild(row);
        
        // 计算合计
        totalCharge += Number(item['充电量(kwh)']) || 0;
        totalElectricity += Number(item['充电电费(元)']) || 0;
        totalService += Number(item['充电服务费(元)']) || 0;
        totalIncome += Number(item['充电总收入(元)']) || 0;
        totalOrders += Number(item['总订单数量']) || 0;
    });
    
    // 添加合计行
    const totalRow = document.createElement('tr');
    // 为合计行添加样式：背景色和加粗字体
    totalRow.style.backgroundColor = '#f0f8ff'; // 浅蓝色背景
    totalRow.style.fontWeight = 'bold'; // 加粗字体
    totalRow.style.color = '#0066cc'; // 蓝色文字
    
    totalRow.innerHTML = `
        <td>合计</td>
        <td>${formatNumber(totalCharge)}</td>
        <td>${formatNumber(totalElectricity)}</td>
        <td>${formatNumber(totalService)}</td>
        <td>${formatNumber(totalIncome)}</td>
        <td>${formatNumber(totalOrders)}</td>
    `;
    tableBody.appendChild(totalRow);
    
    // 渲染图表
    renderChargingBoardChart(yearData);
}

// 渲染充电数据看板图表
function renderChargingBoardChart(data) {
    const ctx = document.getElementById('charging-board-chart').getContext('2d');
    
    // 如果已存在图表实例，先销毁它
    if (window.chargingBoardChartInstance) {
        window.chargingBoardChartInstance.destroy();
    }
    
    // 按时间排序
    data.sort((a, b) => {
        const dateA = parseTimeToDate(a['时间']);
        const dateB = parseTimeToDate(b['时间']);
        if (!dateA && !dateB) return 0;
        if (!dateA) return 1;
        if (!dateB) return -1;
        return dateA.getTime() - dateB.getTime();
    });
    
    // 准备图表数据
    const labels = data.map(item => {
        if (item['时间'] instanceof Date) {
            const date = item['时间'];
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        } else if (typeof item['时间'] === 'string') {
            const date = new Date(item['时间']);
            if (!isNaN(date.getTime())) {
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            } else {
                return item['时间'];
            }
        } else if (typeof item['时间'] === 'number') {
            // 处理数字类型：可能是Excel日期序列号或年份
            if (item['时间'] > 25569) {
                // 可能是Excel日期序列号
                const date = new Date((item['时间'] - 25569) * 86400 * 1000);
                if (!isNaN(date.getTime())) {
                    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                } else {
                    return item['时间'].toString();
                }
            } else if (item['时间'] >= 1900 && item['时间'] <= 2100) {
                // 如果数字本身就是年份（如2026、2027），显示为年份-01
                return `${Math.floor(item['时间'])}-01`;
            } else {
                return item['时间'].toString();
            }
        }
        return '';
    });
    
    const chargeData = data.map(item => Number(item['充电量(kwh)']) || 0);
    const serviceData = data.map(item => Number(item['充电服务费(元)']) || 0);
    
    // 创建图表
    window.chargingBoardChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '充电量 (kwh)',
                    data: chargeData,
                    backgroundColor: 'rgba(26, 115, 232, 0.7)',
                    borderColor: 'rgba(26, 115, 232, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    label: '充电服务费 (元)',
                    data: serviceData,
                    type: 'line',
                    borderColor: 'rgba(0, 200, 83, 1)',
                    backgroundColor: 'rgba(0, 200, 83, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '充电量 (kwh)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '充电服务费 (元)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

// 导出充电数据看板数据
function exportChargingBoardData() {
    // 获取当前显示的年份
    const yearSelect = document.getElementById('year-select');
    const year = parseInt(yearSelect.dataset.currentYear || yearSelect.value.replace('年', ''));
    
    // 过滤出指定年份的数据
    const yearData = chargingBoardData.filter(item => {
        if (item['时间']) {
            const itemYear = extractYear(item['时间']);
            return itemYear === year;
        }
        return false;
    });
    
    // 创建一个新的工作簿
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(yearData);
    XLSX.utils.book_append_sheet(wb, ws, '充电数据');
    
    // 导出文件
    XLSX.writeFile(wb, `充电数据_${year}年.xlsx`);
}

// 初始化充电数据看板导出按钮事件
function initChargingBoardExport() {
    document.getElementById('export-board-btn').addEventListener('click', exportChargingBoardData);
}
        // 从GitHub加载指标数据
        function loadMetricsData() {
            // 显示加载状态
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'data-loading-indicator';
            loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载指标数据...';
            const metricsSection = document.querySelector('.metrics-section');
            if (metricsSection) {
                metricsSection.prepend(loadingIndicator);
            }
            
            // 使用缓存管理器加载数据
            resourceCache.get(metricsDataUrl)
                .then(workbook => {
                    // 处理指标数据（Metrics工作表）
                    const metricsSheet = workbook.Sheets['Metrics'];
                    const metricsJson = XLSX.utils.sheet_to_json(metricsSheet, { header: 1 });
                    
                    // 更新指标数据 - 修正索引位置
                    document.getElementById('month-charge').textContent = formatNumber(metricsJson[1][1]) + ' kwh';
                    document.getElementById('month-electricity').textContent = '¥' + formatNumber(metricsJson[2][1]);
                    document.getElementById('month-service').textContent = '¥' + formatNumber(metricsJson[3][1]);
                    document.getElementById('month-orders').textContent = formatNumber(metricsJson[4][1]);
                    
                    document.getElementById('year-charge').textContent = formatNumber(metricsJson[5][1]) + ' kwh';
                    document.getElementById('year-electricity').textContent = '¥' + formatNumber(metricsJson[6][1]);
                    document.getElementById('year-service').textContent = '¥' + formatNumber(metricsJson[7][1]);
                    document.getElementById('year-orders').textContent = formatNumber(metricsJson[8][1]);
                    
                    document.getElementById('total-charge').textContent = formatNumber(metricsJson[9][1]) + ' kwh';
                    document.getElementById('total-electricity').textContent = '¥' + formatNumber(metricsJson[10][1]);
                    document.getElementById('total-service').textContent = '¥' + formatNumber(metricsJson[11][1]);
                    document.getElementById('total-orders').textContent = formatNumber(metricsJson[12][1]);
                    
                    document.getElementById('month-income').textContent = '¥' + formatNumber(metricsJson[13][1]);
                    document.getElementById('year-income').textContent = '¥' + formatNumber(metricsJson[14][1]);
                    document.getElementById('total-income').textContent = '¥' + formatNumber(metricsJson[15][1]);
                    
                    // 处理充电图表数据（ChargingChart工作表）
                    const chargingChartSheet = workbook.Sheets['ChargingChart'];
                    const chargingChartJson = XLSX.utils.sheet_to_json(chargingChartSheet, { header: 1 });
                    
                    // 提取数据
                    const labels = [];
                    const chargingData = [];
                    const serviceIncomeData = [];
                    
                    for (let i = 1; i < chargingChartJson.length; i++) {
                        const row = chargingChartJson[i];
                        if (row && row.length >= 3) {
                            labels.push(row[0]);
                            chargingData.push(row[1]);
                            serviceIncomeData.push(row[2]);
                        }
                    }
                    
                    // 更新充电图表
                    if (chargingChart) {
                        chargingChart.data.labels = labels;
                        chargingChart.data.datasets[0].data = chargingData;
                        chargingChart.data.datasets[1].data = serviceIncomeData;
                        chargingChart.update();
                    }
                    
                    // 处理综合收入图表数据（IncomeChart工作表）
                    const incomeChartSheet = workbook.Sheets['IncomeChart'];
                    const incomeChartJson = XLSX.utils.sheet_to_json(incomeChartSheet, { header: 1 });
                    
                    // 提取数据
                    const incomeLabels = [];
                    const incomeDataArray = [];
                    
                    for (let i = 1; i < incomeChartJson.length; i++) {
                        const row = incomeChartJson[i];
                        if (row && row.length >= 2) {
                            incomeLabels.push(row[0]);
                            incomeDataArray.push(row[1]);
                        }
                    }
                    
                    // 更新收入图表
                    if (incomeChart) {
                        incomeChart.data.labels = incomeLabels;
                        incomeChart.data.datasets[0].data = incomeDataArray;
                        incomeChart.update();
                    }
                    
                    // 处理充电数据总趋势图表数据（csdjzqs工作表）
if (workbook.SheetNames.includes('csdjzqs')) {
    const csdjzqsSheet = workbook.Sheets['csdjzqs'];
    const csdjzqsJson = XLSX.utils.sheet_to_json(csdjzqsSheet, { header: 1 });
    
    // 提取数据
    const labels = [];
    const chargingData = [];
    const serviceIncomeData = [];
    
    for (let i = 1; i < csdjzqsJson.length; i++) {
        const row = csdjzqsJson[i];
        if (row && row.length >= 3) {
            labels.push(row[0]); // 年份
            chargingData.push(row[1]); // 充电量
            serviceIncomeData.push(row[2]); // 服务费收入
        }
    }
    
    // 更新充电数据总趋势图表
    if (chargingTrendChart) {
        chargingTrendChart.data.labels = labels;
        chargingTrendChart.data.datasets[0].data = chargingData;
        chargingTrendChart.data.datasets[1].data = serviceIncomeData;
        chargingTrendChart.update();
    }
}

                // 处理年度总收入趋势图表数据（ndzsrqs工作表）
if (workbook.SheetNames.includes('ndzsrqs')) {
    const ndzsrqsSheet = workbook.Sheets['ndzsrqs'];
    const ndzsrqsJson = XLSX.utils.sheet_to_json(ndzsrqsSheet, { header: 1 });
    
    // 提取数据
    const labels = [];
    const incomeData = [];
    
    for (let i = 1; i < ndzsrqsJson.length; i++) {
        const row = ndzsrqsJson[i];
        if (row && row.length >= 2) {
            labels.push(row[0]); // 年份
            incomeData.push(row[1]); // 收入
        }
    }
    
    // 更新年度总收入趋势图表
    if (annualRevenueTrendChart) {
        annualRevenueTrendChart.data.labels = labels;
        annualRevenueTrendChart.data.datasets[0].data = incomeData;
        annualRevenueTrendChart.update();
    }
}

// 处理各版块收入汇总数据（bksr工作表）
if (workbook.SheetNames.includes('bksr')) {
    const bksrSheet = workbook.Sheets['bksr'];
    const bksrJson = XLSX.utils.sheet_to_json(bksrSheet, { header: 1 });
    
    // 提取表头
    const headers = bksrJson[0];
    
    // 构建一个对象，按年份存储各版块收入
    const sectorDataByYear = {};
    
    // 遍历数据行（从第二行开始）
    for (let i = 1; i < bksrJson.length; i++) {
        const row = bksrJson[i];
        if (row && row.length >= 3) {
            const sectorName = row[0];
            const year = row[1];
            const income = row[2];
            
            if (!sectorDataByYear[year]) {
                sectorDataByYear[year] = {};
            }
            sectorDataByYear[year][sectorName] = income;
        }
    }

// 更新各版块收入汇总图表
    if (revenueBySectorChart) {
        // 获取所有唯一的版块名称
        const sectors = [...new Set(bksrJson.slice(1).map(row => row[0]))];

        // 为每个年份创建数据数组
        const year2023Data = sectors.map(sector => sectorDataByYear[2023]?.[sector] || 0);
        const year2024Data = sectors.map(sector => sectorDataByYear[2024]?.[sector] || 0);
        const year2025Data = sectors.map(sector => sectorDataByYear[2025]?.[sector] || 0);
        const year2026Data = sectors.map(sector => sectorDataByYear[2026]?.[sector] || 0);

        // 更新图表数据
        revenueBySectorChart.data.labels = sectors;
        revenueBySectorChart.data.datasets[0].data = year2023Data;
        revenueBySectorChart.data.datasets[1].data = year2024Data;
        revenueBySectorChart.data.datasets[2].data = year2025Data;
        revenueBySectorChart.data.datasets[3].data = year2026Data;
        revenueBySectorChart.update();
    }
}

                    // 移除加载状态
                    loadingIndicator.remove();
                })
                .catch(error => {
                    loadingIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 加载指标数据失败';
                    
                    // 5秒后移除提示
                    setTimeout(() => {
                        loadingIndicator.remove();
                    }, 5000);
                });
        }

        // 实时数据轮播变量
let realtimeData = [];
let currentRealtimeIndex = 0;
let realtimeInterval = null;
let isRealtimePaused = false;
let realtimeChart = null;

// 加载实时数据
function loadRealtimeData() {
    const loadingElement = document.getElementById('realtime-loading');
    if (loadingElement) {
        loadingElement.style.display = 'block';
    }
    
    // 使用缓存管理器加载数据（实时数据，但使用短缓存）
    const url = 'https://www.csfhcdz.cn/data/daydata.xlsx?t=' + new Date().getTime();
    resourceCache.get(url, { forceCache: false })
        .then(workbook => {
            
            // 获取第一个工作表
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 转换为JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // 处理表头
            const headers = jsonData[0];

            // 处理数据行
            realtimeData = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                // 只要有数据就显示，不检查特定列
if (row && row.some(cell => cell !== null && cell !== undefined && cell !== '')) {
                    // 处理日期格式
                    let dateStr = row[0];
                    let formattedDate = '';
                    // 更健壮的日期处理
if (dateStr instanceof Date) {
    const month = (dateStr.getMonth() + 1).toString().padStart(2, '0');
    const day = dateStr.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else if (typeof dateStr === 'string' && dateStr.includes('-')) {
    // 处理字符串日期格式
    const datePart = dateStr.split(' ')[0];
    const parts = datePart.split('-');
    if (parts.length >= 3) {
        const month = parts[1].padStart(2, '0');
        const day = parts[2].padStart(2, '0');
        formattedDate = `${month}-${day}`;
    } else {
        formattedDate = datePart;
    }
} else if (typeof dateStr === 'number') {
    // 处理Excel日期序列号
    const jsDate = excelDateToJSDate(dateStr);
    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
    const day = jsDate.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else {
    // 其他情况直接显示原始值
    formattedDate = String(dateStr || '');
}

                    // Excel日期序列号转换函数
                    function excelDateToJSDate(serial) {
                        const utc_days = Math.floor(serial - 25569);
                        const utc_value = utc_days * 86400;
                        const date_info = new Date(utc_value * 1000);
                        return date_info;
                    }

                    if (typeof dateStr === 'number') {
                        // 处理Excel日期序列号
                        const jsDate = excelDateToJSDate(dateStr);
                        const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
                        const day = jsDate.getDate().toString().padStart(2, '0');
                        formattedDate = `${month}-${day}`;
                    } else if (typeof dateStr === 'string') {
                        // 提取日期部分（可能包含时间）
                        const datePart = dateStr.split(' ')[0];
                        const parts = datePart.split('-');
                        if (parts.length >= 3) {
                            // 直接从字符串中提取月份和日期
                            const month = parts[1].padStart(2, '0');
                            const day = parts[2].padStart(2, '0');
                            formattedDate = `${month}-${day}`;
                        } else {
                            formattedDate = datePart;
                        }
                    } else if (dateStr instanceof Date) {
                        // 如果是Date对象，直接格式化
                        formattedDate = `${(dateStr.getMonth() + 1).toString().padStart(2, '0')}-${dateStr.getDate().toString().padStart(2, '0')}`;
                    } else {
                        // 其他情况，转换为字符串
                        formattedDate = String(dateStr);
                    }
                    
// 获取当前年月
const currentDate = new Date();
const currentYear = currentDate.getFullYear();
const currentMonth = currentDate.getMonth() +1; // 月份从0开始，所以+1，+1是获取当前年月，不+1则是获取上个月

// 处理日期格式
if (dateStr instanceof Date) {
    jsDate = dateStr;
    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
    const day = jsDate.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else if (typeof dateStr === 'string' && dateStr.includes('-')) {
    // 处理字符串日期格式
    const datePart = dateStr.split(' ')[0];
    const parts = datePart.split('-');
    if (parts.length >= 3) {
        // 直接从字符串中提取月份和日期
        const month = parts[1].padStart(2, '0');
        const day = parts[2].padStart(2, '0');
        formattedDate = `${month}-${day}`;
        
        // 创建Date对象用于比较
        const year = parseInt(parts[0]);
        jsDate = new Date(year, parseInt(month) - 1, parseInt(day));
    } else {
        formattedDate = datePart;
    }
} else if (typeof dateStr === 'number') {
    // 处理Excel日期序列号
    jsDate = excelDateToJSDate(dateStr);
    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
    const day = jsDate.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else {
    // 其他情况，转换为字符串
    formattedDate = String(dateStr);
}

// 检查日期是否在当前年月
if (jsDate && jsDate.getFullYear() === currentYear && (jsDate.getMonth() + 1) === currentMonth) {
    // 确保所有字段都有值
    realtimeData.push({
        date: formattedDate,
        station: row[1] || '',
        charge: row[2] !== undefined && row[2] !== null && row[2] !== '' ? row[2] : 0,
        totalIncome: row[3] !== undefined && row[3] !== null && row[3] !== '' ? row[3] : 0,
        income: row[4] !== undefined && row[4] !== null && row[4] !== '' ? row[4] : 0,
        orders: row[5] !== undefined && row[5] !== null && row[5] !== '' ? row[5] : 0
    });
}
                }
            }
                    
            // 更新表格
            updateRealtimeTable();
            
            // 绘制图表
            drawRealtimeChart();

            // 只有当数据超过表格显示范围时才开始轮播
            if (realtimeData.length > 8) {
                startRealtimeCarousel();
            }
            
            // 添加容器级别的鼠标事件处理
            const tableContainer = document.getElementById('realtime-table-container');
            if (tableContainer) {
                tableContainer.addEventListener('mouseenter', () => {
                    isRealtimePaused = true;
                    clearInterval(realtimeInterval);
                });
                
                tableContainer.addEventListener('mouseleave', () => {
                    isRealtimePaused = false;
                    // 只有当数据超过表格显示范围时才重新开始轮播
                    if (realtimeData.length > 8) {
                        startRealtimeCarousel();
                    }
                });
            }
        })
        .catch(error => {
            loadingElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 加载实时数据失败';
        })
        .finally(() => {
            loadingElement.style.display = 'none';
        });
}

// 更新实时数据表格
function updateRealtimeTable() {
    const tableBody = document.getElementById('realtime-table-body');
    tableBody.innerHTML = '';
    
    // 显示当前页的数据
    const startIndex = currentRealtimeIndex;
    // 修改这里，确保能显示到最后一行
    const endIndex = Math.min(startIndex + 10, realtimeData.length);;
    
    for (let i = startIndex; i < endIndex; i++) {
        const item = realtimeData[i];
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>${item.date}</td>
            <td>${item.station}</td>
            <td>${formatNumber(item.charge)}</td>
            <td>${formatNumber(item.totalIncome)}</td>   <!-- 新增列 -->
            <td>${formatNumber(item.income)}</td>
            <td>${formatNumber(item.orders)}</td>
        `;
        
        // 添加鼠标事件
        row.addEventListener('mouseenter', () => {
            isRealtimePaused = true;
            clearInterval(realtimeInterval);
        });
        
        row.addEventListener('mouseleave', () => {
            isRealtimePaused = false;
            // 只有当数据超过表格显示范围时才重新开始轮播
            if (realtimeData.length > 8) {
                startRealtimeCarousel();
            }
        });
        
        tableBody.appendChild(row);
    }

    // 高亮当前行
    if (tableBody.children.length > 0) {
        const firstRow = tableBody.children[0];
        firstRow.classList.add('highlight');
        
        // 移除之前的高亮
        setTimeout(() => {
            firstRow.classList.remove('highlight');
        }, 1000);
    }
}

// 开始实时数据轮播
function startRealtimeCarousel() {
    clearInterval(realtimeInterval);
    
    realtimeInterval = setInterval(() => {
        if (isRealtimePaused) return;
        
        currentRealtimeIndex++;
        // 修改重置条件
        if (currentRealtimeIndex >= realtimeData.length) {
            currentRealtimeIndex = 0;
        }
          
        updateRealtimeTable();
    }, 1000); // 每2秒轮播一次
}
// 绘制实时数据图表
function drawRealtimeChart() {
    const ctx = document.getElementById('realtime-chart').getContext('2d');
    
    // 如果已存在图表实例，先销毁它
    if (realtimeChart) {
        realtimeChart.destroy();
    }
    
    // 按站点和日期分组数据
    const stations = {};
    const dates = [...new Set(realtimeData.map(item => item.date))].sort();
    
    realtimeData.forEach(item => {
        if (!stations[item.station]) {
            stations[item.station] = {
                chargeData: new Array(dates.length).fill(0),
                incomeData: new Array(dates.length).fill(0)
            };
        }
        
        const dateIndex = dates.indexOf(item.date);
        if (dateIndex !== -1) {
            stations[item.station].chargeData[dateIndex] = item.charge;
            stations[item.station].incomeData[dateIndex] = item.income;
        }
    });

    // 创建数据集
    const datasets = [];
    const colors = [
        'rgba(26, 115, 232, 0.7)',      // 蓝色 - 充电量
        'rgba(26, 115, 232, 0.3)',      // 浅蓝色 - 充电量(辅助)
        'rgba(0, 200, 83, 0.7)',        // 绿色 - 服务费收入
        'rgba(0, 200, 83, 0.3)',        // 浅绿色 - 服务费收入(辅助)
        'rgba(220, 53, 69, 0.7)',       // 红色
        'rgba(156, 39, 176, 0.7)',      // 紫色
        'rgba(255, 152, 0, 0.7)'        // 橙色
    ];
    
    let colorIndex = 0;
    for (const station in stations) {
    
        // 为四方坪站特别设置样式
        const isSifangping = station.includes('四方坪');
        
        datasets.push({
            label: `${station} - 充电量`,
            data: stations[station].chargeData,
            borderColor: isSifangping ? colors[0] : colors[colorIndex % colors.length],
            backgroundColor: 'transparent',
            yAxisID: 'y',
            tension: 0.4,
            borderWidth: isSifangping ? 3 : 2,
            pointRadius: isSifangping ? 4 : 3,
            pointHoverRadius: isSifangping ? 6 : 4
        });
        
        datasets.push({
            label: `${station} - 服务费收入`,
            data: stations[station].incomeData,
            borderColor: isSifangping ? colors[2] : colors[(colorIndex + 2) % colors.length],
            backgroundColor: 'transparent',
            yAxisID: 'y1',
            tension: 0.4,
            borderWidth: isSifangping ? 3 : 2,
            borderDash: isSifangping ? [0] : [5, 5], // 四方坪站用实线，其他用虚线
            pointRadius: isSifangping ? 4 : 3,
            pointHoverRadius: isSifangping ? 6 : 4
        });

        colorIndex++;
    }
    
    // 创建图表
    realtimeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '充电量 (kwh)'
                    },
                    // 移除任何固定的min/max设置，让图表自动调整
                    beginAtZero: true // 从0开始，但会自动扩展
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '服务费收入 (元)'
                    },
                    grid: {
                        drawOnChartArea: false
                    },
                    // 移除任何固定的min/max设置，让图表自动调整
                    beginAtZero: true // 从0开始，但会自动扩展
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                const value = context.parsed.y;
                                if (context.dataset.yAxisID === 'y1') {
                                    label += '¥' + formatNumber(value);
                                } else {
                                    label += formatNumber(value) + ' kwh';
                                }
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}
// setTimeout(loadRealtimeData, 5 * 60 * 1000); // 每5分钟刷新一次 - 已禁用自动刷新功能
// 在页面加载完成后调用
// 综合收入看板功能
let incomeDashboardData = [];
let incomeDashboardChart = null;
// 加载综合收入数据
async function loadIncomeDashboardData() {
    try {
        // 使用缓存管理器加载数据（与loadMetricsData和loadChargingBoardData共享缓存）
        const workbook = await resourceCache.get('https://www.csfhcdz.cn/data/homepage.xlsx');
        
        // 查找zgmysj工作表
        const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('zgmysj'));
        if (!sheetName) {
            throw new Error('未找到zgmysj工作表');
        }
        
        const worksheet = workbook.Sheets[sheetName];
        
        // 转换Excel数据为JSON
        const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        if (data.length < 2) {
            throw new Error('工作表数据为空');
        }
        
        // 处理表头和数据
        const headers = data[0];
        incomeDashboardData = data.slice(1).map(row => {
            const obj = {};
            headers.forEach((header, index) => {
                if (header === '时间') {
                    // 处理日期字段
                    if (row[index] instanceof Date) {
                        obj[header] = row[index];
                    } else if (typeof row[index] === 'number') {
                        // Excel日期序列号转换为Date对象
                        const date = new Date((row[index] - 25569) * 86400 * 1000);
                        obj[header] = date;
                    } else if (typeof row[index] === 'string') {
                        // 尝试解析字符串日期
                        const date = new Date(row[index]);
                        if (!isNaN(date.getTime())) {
                            obj[header] = date;
                        } else {
                            obj[header] = row[index];
                        }
                    } else {
                        obj[header] = row[index];
                    }
                } else {
                    obj[header] = row[index];
                }
            });
            return obj;
        }).filter(item => item['时间'] && !isNaN(new Date(item['时间']).getTime())); // 过滤掉无效日期数据
        
        // 更新年份选择器
        updateYearSelector();
        
        // 加载当前年份数据
        const currentYear = new Date().getFullYear();
        loadYearData(currentYear.toString());
        
    } catch (error) {
        alert('加载综合收入数据失败，请检查网络连接或数据文件');
    }
}

// 更新年份选择器（翻页按钮）
function updateYearSelector() {
    const yearSelect = document.getElementById('income-year-select');
    const prevBtn = document.getElementById('income-year-prev-btn');
    const nextBtn = document.getElementById('income-year-next-btn');
    
    const years = [...new Set(incomeDashboardData
        .filter(item => item['时间'])
        .map(item => {
            const date = new Date(item['时间']);
            return date.getFullYear();
        })
        .filter(year => !isNaN(year))
    )].sort((a, b) => a - b); // 改为升序排列，便于翻页
    
    // 将可用年份列表存储到元素上
    yearSelect.dataset.availableYears = JSON.stringify(years);
    
    // 设置默认选中当前年份
    const currentYear = new Date().getFullYear();
    let initialYear = currentYear;
    if (!years.includes(currentYear) && years.length > 0) {
        initialYear = years[years.length - 1]; // 如果没有当前年份，选择最后一个
    }
    
    yearSelect.value = initialYear;
    yearSelect.dataset.currentYear = initialYear;
    
    // 更新按钮状态
    updateIncomeYearButtons(yearSelect, prevBtn, nextBtn, years);
    
    // 初始加载数据
    loadYearData(initialYear.toString());
    
    // 添加翻页按钮事件监听
    prevBtn.addEventListener('click', function() {
        const availableYears = JSON.parse(yearSelect.dataset.availableYears);
        const currentYear = parseInt(yearSelect.dataset.currentYear);
        const currentIndex = availableYears.indexOf(currentYear);
        
        if (currentIndex > 0) {
            const prevYear = availableYears[currentIndex - 1];
            yearSelect.value = prevYear;
            yearSelect.dataset.currentYear = prevYear;
            updateIncomeYearButtons(yearSelect, prevBtn, nextBtn, availableYears);
            loadYearData(prevYear.toString());
        }
    });
    
    nextBtn.addEventListener('click', function() {
        const availableYears = JSON.parse(yearSelect.dataset.availableYears);
        const currentYear = parseInt(yearSelect.dataset.currentYear);
        const currentIndex = availableYears.indexOf(currentYear);
        
        if (currentIndex < availableYears.length - 1) {
            const nextYear = availableYears[currentIndex + 1];
            yearSelect.value = nextYear;
            yearSelect.dataset.currentYear = nextYear;
            updateIncomeYearButtons(yearSelect, prevBtn, nextBtn, availableYears);
            loadYearData(nextYear.toString());
        }
    });
    
    // 添加导出按钮事件监听
    document.getElementById('income-export-btn').addEventListener('click', exportIncomeData);
}

// 更新综合收入看板年份翻页按钮状态
function updateIncomeYearButtons(yearSelect, prevBtn, nextBtn, availableYears) {
    const currentYear = parseInt(yearSelect.dataset.currentYear);
    const currentIndex = availableYears.indexOf(currentYear);
    
    // 更新按钮样式（禁用状态）
    if (currentIndex <= 0) {
        prevBtn.style.opacity = '0.4';
        prevBtn.style.cursor = 'not-allowed';
    } else {
        prevBtn.style.opacity = '1';
        prevBtn.style.cursor = 'pointer';
    }
    
    if (currentIndex >= availableYears.length - 1) {
        nextBtn.style.opacity = '0.4';
        nextBtn.style.cursor = 'not-allowed';
    } else {
        nextBtn.style.opacity = '1';
        nextBtn.style.cursor = 'pointer';
    }
}

// 加载指定年份数据
function loadYearData(year) {
    const yearData = incomeDashboardData.filter(item => {
        if (!item['时间']) return false;
        const date = new Date(item['时间']);
        return date.getFullYear() === parseInt(year);
    });
    
    // 更新表格
    updateIncomeTable(yearData, year);
    
    // 更新图表
    updateIncomeChart(yearData);
}

// 更新收入表格
function updateIncomeTable(data, year) {
    const tableBody = document.querySelector('#income-table tbody');
    const tableHead = document.querySelector('#income-table thead tr');
    
    // 清空表格
    tableBody.innerHTML = '';
    tableHead.innerHTML = '';
    
    // 如果没有数据，显示提示
    if (data.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="12" style="text-align: center;">没有找到${year}年的数据</td>`;
        tableBody.appendChild(row);
        return;
    }
    
    // 获取所有表头（排除时间列）
    const allHeaders = Object.keys(data[0]).filter(key => key !== '时间');
    
    // 检查每个字段是否在所有数据中都为0
    const nonZeroHeaders = allHeaders.filter(header => {
        // 检查该字段是否至少有一个非零值
        return data.some(item => {
            const value = item[header];
            return typeof value === 'number' && value !== 0;
        });
    });
    
    // 使用非零字段作为表头
    const headers = nonZeroHeaders;
    
    // 添加表头
    const timeHeader = document.createElement('th');
    timeHeader.textContent = '时间';
    tableHead.appendChild(timeHeader);
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        tableHead.appendChild(th);
    });
    
    // 添加小计列
    const totalHeader = document.createElement('th');
    totalHeader.textContent = '小计';
    tableHead.appendChild(totalHeader);
    
    // 初始化列总计数组
    const columnTotals = new Array(headers.length).fill(0);
    let grandTotal = 0;
    
    // 添加数据行
    data.forEach(item => {
        const row = document.createElement('tr');
        
        // 时间列
        const timeCell = document.createElement('td');
        const date = new Date(item['时间']);
        timeCell.textContent = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        row.appendChild(timeCell);
        
        // 数据列
        let rowTotal = 0;
        headers.forEach((header, index) => {
            const cell = document.createElement('td');
            const value = item[header] || 0;
            cell.textContent = typeof value === 'number' ? value.toFixed(2) : value;
            rowTotal += typeof value === 'number' ? value : 0;
            
            // 累加列总计
            if (typeof value === 'number') {
                columnTotals[index] += value;
            }
            
            row.appendChild(cell);
        });
        
        // 小计列
        const totalCell = document.createElement('td');
        totalCell.textContent = rowTotal.toFixed(2);
        totalCell.style.fontWeight = 'bold';
        row.appendChild(totalCell);
        
        // 累加总计
        grandTotal += rowTotal;
        
        tableBody.appendChild(row);
    });
    
    // 添加"共计"行
    if (data.length > 0) {
        const totalRow = document.createElement('tr');
        totalRow.style.fontWeight = 'bold';
        totalRow.style.backgroundColor = '#f5f5f5';
        
        // 时间列
        const timeCell = document.createElement('td');
        timeCell.textContent = '共计';
        totalRow.appendChild(timeCell);
        
        // 各列总计
        columnTotals.forEach(total => {
            const cell = document.createElement('td');
            cell.textContent = total.toFixed(2);
            totalRow.appendChild(cell);
        });
        
        // 总计列
        const grandTotalCell = document.createElement('td');
        grandTotalCell.textContent = grandTotal.toFixed(2);
        grandTotalCell.style.backgroundColor = '#e8f5e9';
        totalRow.appendChild(grandTotalCell);
        
        tableBody.appendChild(totalRow);
    }
}

// 更新收入图表
function updateIncomeChart(data) {
    const ctx = document.getElementById('income-dashboard-chart').getContext('2d');
    
    // 销毁现有图表
    if (incomeDashboardChart) {
        incomeDashboardChart.destroy();
    }
    
    // 获取所有非零字段（排除时间列）
    const allHeaders = Object.keys(data[0] || {}).filter(key => key !== '时间');
    const nonZeroHeaders = allHeaders.filter(header => {
        return data.some(item => {
            const value = item[header];
            return typeof value === 'number' && value !== 0;
        });
    });
    
    // 按月分组数据
    const monthlyData = {};
    data.forEach(item => {
        if (!item['时间']) return;
        const date = new Date(item['时间']);
        const month = date.getMonth() + 1;
        if (!monthlyData[month]) {
            monthlyData[month] = [];
        }
        monthlyData[month].push(item);
    });
    
    // 准备图表数据
    const labels = [];
    const monthlyTotals = [];
    
    // 计算每月小计
    for (let month = 1; month <= 12; month++) {
        if (monthlyData[month]) {
            labels.push(`${month}月`);
            
            let monthTotal = 0;
            monthlyData[month].forEach(item => {
                // 只计算非零字段的小计
                nonZeroHeaders.forEach(key => {
                    if (typeof item[key] === 'number') {
                        monthTotal += item[key];
                    }
                });
            });
            
            monthlyTotals.push(monthTotal);
        } else {
            labels.push(`${month}月`);
            monthlyTotals.push(0);
        }
    }
    
    // 创建图表
    incomeDashboardChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '月收入趋势',
                data: monthlyTotals,
                borderColor: 'rgba(220, 53, 69, 1)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '收入 (元)'
                    }
                }
            }
        }
    });
}
// 导出数据功能
function exportIncomeData() {
    // 获取当前选择的年份
    const yearSelect = document.getElementById('income-year-select');
    const year = yearSelect.dataset.currentYear || yearSelect.value;
    
    // 获取当前显示的表格数据（已经过滤掉全为0的字段）
    const table = document.getElementById('income-table');
    const headers = [];
    const data = [];
    
    // 获取表头
    const headerRow = table.querySelector('thead tr');
    headerRow.querySelectorAll('th').forEach(th => {
        headers.push(th.textContent);
    });
    
    // 获取数据行（排除总计行）
    const dataRows = table.querySelectorAll('tbody tr:not(:last-child)');
    dataRows.forEach(row => {
        const rowData = [];
        row.querySelectorAll('td').forEach(cell => {
            rowData.push(cell.textContent);
        });
        data.push(rowData);
    });
    
    // 创建工作簿
    const wb = XLSX.utils.book_new();
    
    // 准备Excel数据
    const excelData = [headers];
    data.forEach(row => excelData.push(row));
    
    // 创建工作表
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // 将工作表添加到工作簿
    XLSX.utils.book_append_sheet(wb, ws, `${year}年收入数据`);
    
    // 导出文件
    XLSX.writeFile(wb, `综合收入数据_${year}年.xlsx`);
}



// 未充电时长统计相关变量
let unchargedData = [];
let currentUnchargedPage = 1;
const rowsPerPage = 10;
let filteredUnchargedData = [];
let currentDurationFilter = 'all';
let unchargedUpdateInterval = null; // 动态更新定时器

// 加载未充电时长统计数据
function loadUnchargedData() {
    const loadingElement = document.createElement('div');
    loadingElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载未充电时长统计数据，请稍候...';
    loadingElement.style.textAlign = 'center';
    loadingElement.style.padding = '20px';
    
    const tableContainer = document.querySelector('.uncharged-table-container');
    if (tableContainer) {
        tableContainer.prepend(loadingElement);
    }
    
    // 使用缓存管理器加载数据（实时数据，但使用短缓存）
    const url = 'https://www.csfhcdz.cn/data/wcdsc.xlsx?t=' + new Date().getTime();
    resourceCache.get(url, { forceCache: false })
        .then(workbook => {
            
            // 获取第一个工作表
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 转换为JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // 处理表头
            const headers = jsonData[0];
            
            // 处理数据行
            unchargedData = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                // 检查是否有有效数据（A、B、C列至少有一个不为空）
                if (row && row.length >= 3 && (row[0] || row[1] || row[2])) {
                    // 确保日期格式正确
                    const lastEndTime = formatDateString(row[2]);
                    // 从Excel第四列加载截止一直未充电时间数据
                    const stillUnchargedTime = row[3] ? formatDateString(row[3]) : '';
                    
                    unchargedData.push({
                        stationName: row[0] || '',
                        terminalName: row[1] || '',
                        lastEndTime: lastEndTime,
                        stillUnchargedTime: stillUnchargedTime, // 从Excel D列加载数据
                        duration: 0 // E列将动态计算
                    });
                }
            }
            
            // 初始化筛选器
            initDurationFilter();
            
            // 启动动态时间更新
            startUnchargedDynamicUpdate();
            
            // 更新表格
            updateUnchargedTable();
        })
        .catch(error => {
            const tableContainer = document.querySelector('.uncharged-table-container');
            tableContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-exclamation-triangle"></i> 加载未充电时长统计数据失败</div>';
        })
        .finally(() => {
            loadingElement.remove();
        });
}

// 格式化日期字符串，确保正确显示
function formatDateString(dateStr) {
    if (!dateStr) return '';
    
    // 如果已经是字符串格式，直接返回
    if (typeof dateStr === 'string') {
        return dateStr;
    }
    
    // 如果是日期对象
    if (dateStr instanceof Date) {
        const year = dateStr.getFullYear();
        const month = (dateStr.getMonth() + 1).toString().padStart(2, '0');
        const day = dateStr.getDate().toString().padStart(2, '0');
        const hours = dateStr.getHours().toString().padStart(2, '0');
        const minutes = dateStr.getMinutes().toString().padStart(2, '0');
        const seconds = dateStr.getSeconds().toString().padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
    
    // 如果是Excel日期序列号
    if (typeof dateStr === 'number') {
        const jsDate = excelDateToJSDate(dateStr);
        const year = jsDate.getFullYear();
        const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
        const day = jsDate.getDate().toString().padStart(2, '0');
        const hours = jsDate.getHours().toString().padStart(2, '0');
        const minutes = jsDate.getMinutes().toString().padStart(2, '0');
        const seconds = jsDate.getSeconds().toString().padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
    
    return '';
}

// Excel日期序列号转换为JS日期对象
function excelDateToJSDate(serial) {
    const utc_days = Math.floor(serial - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    
    const fractional_day = serial - Math.floor(serial) + 0.0000001;
    let total_seconds = Math.floor(86400 * fractional_day);
    
    const seconds = total_seconds % 60;
    total_seconds -= seconds;
    
    const hours = Math.floor(total_seconds / (60 * 60));
    const minutes = Math.floor(total_seconds / 60) % 60;
    
    return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate(), hours, minutes, seconds);
}

// 获取当前时间字符串（yyyy-mm-dd hh:mm:ss格式）
function getCurrentTimeString() {
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// 计算时间差（小时数）
function calculateTimeDifference(startTimeStr, endTimeStr) {
    if (!startTimeStr || !endTimeStr) return 0;
    
    try {
        const startTime = new Date(startTimeStr);
        const endTime = new Date(endTimeStr);
        
        if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
            return 0;
        }
        
        const diffMs = endTime.getTime() - startTime.getTime();
        const diffHours = diffMs / (1000 * 60 * 60); // 转换为小时
        
        return Math.max(0, diffHours); // 确保不为负数
    } catch (error) {
        return 0;
    }
}

// 更新未充电数据的动态时间
function updateUnchargedDynamicData() {
    const currentTime = getCurrentTimeString();
    
    unchargedData.forEach(item => {
        if (item.lastEndTime && item.stillUnchargedTime) {
            // item.stillUnchargedTime = currentTime; // 已删除动态时间赋值
            item.duration = calculateTimeDifference(item.lastEndTime, item.stillUnchargedTime);
        }
    });
    
    // 更新筛选后的数据
    if (filteredUnchargedData.length > 0) {
        filterUnchargedData();
    }
}

// 启动未充电数据的动态更新
function startUnchargedDynamicUpdate() {
    // 清除之前的定时器
    if (unchargedUpdateInterval) {
        clearInterval(unchargedUpdateInterval);
    }
    
    // 立即更新一次
    updateUnchargedDynamicData();
    
    // 每秒更新一次 - 已禁用：动态时间更新已删除
    // unchargedUpdateInterval = setInterval(() => {
    //     updateUnchargedDynamicData();
    //     updateUnchargedTable();
    // }, 1000);
}

// 停止未充电数据的动态更新
function stopUnchargedDynamicUpdate() {
    if (unchargedUpdateInterval) {
        clearInterval(unchargedUpdateInterval);
        unchargedUpdateInterval = null;
    }
}

// 初始化时长筛选器
function initDurationFilter() {
    const durationFilter = document.getElementById('uncharged-duration-filter');
    durationFilter.addEventListener('change', function() {
        currentDurationFilter = this.value;
        currentUnchargedPage = 1; // 重置到第一页
        filterUnchargedData();
        updateUnchargedTable();
    });
    
    // 初始化页面选择器
    document.getElementById('page-select').addEventListener('change', function() {
        currentUnchargedPage = parseInt(this.value);
        // 立即更新当前页码显示
        document.getElementById('current-page').textContent = currentUnchargedPage;
        updateUnchargedTable();
    });
}

// 根据时长筛选数据
function filterUnchargedData() {
    if (currentDurationFilter === 'all') {
        filteredUnchargedData = [...unchargedData];
    } else {
        filteredUnchargedData = unchargedData.filter(item => {
            const duration = parseFloat(item.duration);
            switch (currentDurationFilter) {
                case 'lt30':
                    return duration < 30;
                case 'ge30lt60':
                    return duration >= 30 && duration < 60;
                case 'ge60lt90':
                    return duration >= 60 && duration < 90;
                case 'ge90':
                    return duration >= 90;
                default:
                    return true;
            }
        });
    }
    
    // 更新分页信息
    updatePagination();
}

// 更新分页信息
function updatePagination() {
    const totalPages = Math.ceil(filteredUnchargedData.length / rowsPerPage) || 1;
    document.getElementById('total-pages').textContent = totalPages;
    document.getElementById('current-page').textContent = Math.min(currentUnchargedPage, totalPages);
    
    // 更新页面选择器
    const pageSelect = document.getElementById('page-select');
    pageSelect.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        if (i === currentUnchargedPage) {
            option.selected = true;
        }
        pageSelect.appendChild(option);
    }
    
    // 如果当前页超出范围，重置为最后一页
    if (currentUnchargedPage > totalPages) {
        currentUnchargedPage = totalPages;
    }
}
// 更新未充电时长统计表格
function updateUnchargedTable() {
    // 先筛选数据
    if (filteredUnchargedData.length === 0) {
        filterUnchargedData();
    }
    
    const tableBody = document.getElementById('uncharged-table-body');
    tableBody.innerHTML = '';
    
    // 计算当前页的数据范围
    const startIndex = (currentUnchargedPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, filteredUnchargedData.length);
    
    // 显示当前页的数据
    for (let i = startIndex; i < endIndex; i++) {
        const item = filteredUnchargedData[i];
        const row = document.createElement('tr');
        
        // 格式化时长数据，保留2位小数
        const formattedDuration = parseFloat(item.duration || 0).toFixed(2);
        
        row.innerHTML = `
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0; color: black;">${item.stationName}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0; color: black;">${item.terminalName}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0; color: black;">${item.lastEndTime}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0; color: black;">${item.stillUnchargedTime}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0; color: black;">${formattedDuration}</td>
        `;
        
        tableBody.appendChild(row);
    }
    
    // 更新数据信息
    document.getElementById('uncharged-data-info').textContent = `共加载 ${filteredUnchargedData.length} 条数据`;
}
        function startClock() {
            const el = document.getElementById('time-display');
            if (!el) return;
            function pad(n){return n.toString().padStart(2,'0');}
            function format(dt){
                const y = dt.getFullYear();
                const m = pad(dt.getMonth()+1);
                const d = pad(dt.getDate());
                const week = ['日','一','二','三','四','五','六'][dt.getDay()];
                const hh = pad(dt.getHours());
                const mm = pad(dt.getMinutes());
                const ss = pad(dt.getSeconds());
                return `${y}年${m}月${d}日 星期${week} ${hh}:${mm}:${ss}`;
            }
            el.textContent = format(new Date());
            setInterval(()=>{ el.textContent = format(new Date()); }, 1000);
        }

        // 将数字单元格打上不换行标记，避免金额/数值换行
        function isNumericString(text) {
            const s = String(text).trim();
            // 支持：货币符号、千分位、小数、单位(kwh/元)、百分比
            return /^¥?-?\d{1,3}(,\d{3})*(\.\d+)?(\s*(kwh|元))?$/.test(s)
                || /^-?\d+(\.\d+)?%$/.test(s);
        }

        function markNumericCells(tableEl) {
            const cells = tableEl.querySelectorAll('td, th');
            cells.forEach(cell => {
                const txt = (cell.textContent || '').trim();
                if (isNumericString(txt)) {
                    cell.classList.add('num-cell');
                    // 以内联样式加一道保险，确保不换行
                    cell.style.whiteSpace = 'nowrap';
                    cell.style.wordBreak = 'normal';
                    cell.style.overflowWrap = 'normal';
                    cell.style.textAlign = 'center';
                }
            });
        }

        // 处理单位信息左对齐
        function handleUnitInfoAlignment(tableEl) {
            const cells = tableEl.querySelectorAll('td, th');
            cells.forEach(cell => {
                const txt = (cell.textContent || '').trim();
                if (txt.includes('单位：长沙飞狐电动汽车充电服务有限公司')) {
                    cell.classList.add('unit-info-cell');
                    cell.style.textAlign = 'left';
                }
            });
        }

        // 按列识别数字列并整体加不换行样式，适配多种格式
        function markNumericColumns(tableEl) {
          const rows = tableEl.rows;
          if (!rows.length) return;
          const cols = rows[0].cells.length;
          const headerTexts = Array.from(rows[0].cells).map(c => (c.textContent || '').trim());
          const numericHeaderKeywords = /(kwh|电费|服务费|收入|金额|元|订单|数量|合计|同比|环比|率|百分比|%|数|量|次|时长|小时|利用率|金额)/i;

          const isNumericCol = new Array(cols).fill(false);

          // 规则1：表头关键字判定
          for (let c = 0; c < cols; c++) {
            if (numericHeaderKeywords.test(headerTexts[c])) isNumericCol[c] = true;
          }

          // 规则2：采样内容判定（忽略表头，>=60% 数字即视为数字列）
          for (let c = 0; c < cols; c++) {
            let numericCount = 0, total = 0;
            for (let r = 1; r < rows.length; r++) {
              const cell = rows[r].cells[c];
              if (!cell) continue;
              const txt = (cell.textContent || '').trim();
              if (txt) {
                total++;
                if (isNumericString(txt)) numericCount++;
              }
            }
            if (total > 0 && numericCount / total >= 0.6) isNumericCol[c] = true;
          }

          // 应用列样式
          for (let c = 0; c < cols; c++) {
            if (isNumericCol[c]) {
              for (let r = 0; r < rows.length; r++) {
                const cell = rows[r].cells[c];
                if (cell) cell.classList.add('num-col');
              }
            }
          }
        }

        // 整体情况概要数据存储对象
        const overviewData = {
            summary: {},
            overallMetrics: {},
            sfpMetrics: {},
            glMetrics: {},
            deviceMetrics: [],
            annualMetrics: [],
            coreMetrics: [],
            timeDistribution: { sfp: [], gl: [] },
            revenueCost: [],
            annualTrend: []
        };

        // 从Excel文件加载整体情况概要数据
        async function loadOverviewData() {
            try {
                // 使用缓存管理器加载数据
                const workbook = await resourceCache.get('https://www.csfhcdz.cn/data/cddata.xlsx');
                
                // 解析每个工作表的数据
                parseOverviewSheetData(workbook);
                
                // 更新整体情况概要
                updateOverviewData();
                
            } catch (error) {
            }
        }

        // 解析整体情况概要工作表数据
        function parseOverviewSheetData(workbook) {
            // 解析整体情况概要 (Sheet1)
            const summarySheet = workbook.Sheets[workbook.SheetNames[0]];
            const summaryData = XLSX.utils.sheet_to_json(summarySheet, { header: 1 });
            
            // 跳过标题行
            for (let i = 1; i < summaryData.length; i++) {
                if (summaryData[i][0]) {
                    overviewData.summary[summaryData[i][0]] = summaryData[i][1];
                }
            }
            
            // 解析总体运营指标 (Sheet2)
            const overallSheet = workbook.Sheets[workbook.SheetNames[1]];
            const overallData = XLSX.utils.sheet_to_json(overallSheet, { header: 1 });
            
            for (let i = 1; i < overallData.length; i++) {
                if (overallData[i][0]) {
                    overviewData.overallMetrics[overallData[i][0]] = overallData[i][1];
                }
            }
            
            // 解析四方坪站运营指标 (Sheet3)
            const sfpSheet = workbook.Sheets[workbook.SheetNames[2]];
            const sfpData = XLSX.utils.sheet_to_json(sfpSheet, { header: 1 });
            
            for (let i = 1; i < sfpData.length; i++) {
                if (sfpData[i][0]) {
                    overviewData.sfpMetrics[sfpData[i][0]] = sfpData[i][1];
                }
            }
            
            // 解析高岭站运营指标 (Sheet4)
            const glSheet = workbook.Sheets[workbook.SheetNames[3]];
            const glData = XLSX.utils.sheet_to_json(glSheet, { header: 1 });
            
            for (let i = 1; i < glData.length; i++) {
                if (glData[i][0]) {
                    overviewData.glMetrics[glData[i][0]] = glData[i][1];
                }
            }
            
            // 解析设备充电总数据 (Sheet5)
            const deviceSheet = workbook.Sheets[workbook.SheetNames[4]];
            const deviceData = XLSX.utils.sheet_to_json(deviceSheet, { header: 1 });
            
            for (let i = 1; i < deviceData.length; i++) {
                if (deviceData[i][0]) {
                    overviewData.deviceMetrics.push({
                        name: deviceData[i][0],
                        charge: deviceData[i][1],
                        revenue: deviceData[i][2]
                    });
                }
            }
            
            // 解析年度运营数据 (Sheet6)
            const annualSheet = workbook.Sheets[workbook.SheetNames[5]];
            const annualData = XLSX.utils.sheet_to_json(annualSheet, { header: 1 });
            
            for (let i = 1; i < annualData.length; i++) {
                if (annualData[i][0]) {
                    overviewData.annualMetrics.push({
                        year: annualData[i][0],
                        charge: annualData[i][1],
                        revenue: annualData[i][2]
                    });
                }
            }
            
            // 解析充电站核心指标对比 (Sheet7)
            const coreSheet = workbook.Sheets[workbook.SheetNames[6]];
            const coreData = XLSX.utils.sheet_to_json(coreSheet, { header: 1 });
            
            for (let i = 2; i < coreData.length; i++) {
                if (coreData[i][0]) {
                    overviewData.coreMetrics.push({
                        station: coreData[i][0],
                        charge: coreData[i][1],
                        revenue: coreData[i][2],
                        orders: coreData[i][3]
                    });
                }
            }
            
            // 解析充电时段分布 (Sheet8)
            const timeSheet = workbook.Sheets[workbook.SheetNames[7]];
            const timeData = XLSX.utils.sheet_to_json(timeSheet, { header: 1 });
            
            // 分组数据
            for (let i = 2; i < timeData.length; i += 2) {
                if (timeData[i][0] && timeData[i][0].includes('sfp')) {
                    overviewData.timeDistribution.sfp.push(timeData[i][2]);
                    if (timeData[i+1] && timeData[i+1][0].includes('gl')) {
                        overviewData.timeDistribution.gl.push(timeData[i+1][2]);
                    }
                }
            }
            
            // 解析收入与成本构成 (Sheet9)
            const revenueSheet = workbook.Sheets[workbook.SheetNames[8]];
            const revenueData = XLSX.utils.sheet_to_json(revenueSheet, { header: 1 });
            
            for (let i = 2; i < revenueData.length; i++) {
                if (revenueData[i][0]) {
                    overviewData.revenueCost.push({
                        station: revenueData[i][0],
                        income: revenueData[i][1],
                        cost: revenueData[i][2],
                        profit: revenueData[i][3]
                    });
                }
            }
            
            // 解析年度充电量趋势 (Sheet10)
            const trendSheet = workbook.Sheets[workbook.SheetNames[9]];
            const trendData = XLSX.utils.sheet_to_json(trendSheet, { header: 1 });
            
            // 修正：确保正确获取年度充电量数据
            overviewData.annualTrend = [];
            for (let i = 1; i < trendData.length; i++) {
                if (trendData[i][0]) {
                    // 确保只获取充电量数据（第二列）
                    overviewData.annualTrend.push(trendData[i][1]);
                }
            }
        }

        // 更新整体情况概要数据
        function updateOverviewData() {
            const overviewGrid = document.getElementById('overview-grid');
            if (overviewGrid) {
                overviewGrid.innerHTML = `
                    <div class="overview-card">
                        <div class="overview-value-large">${overviewData.summary.cdz || '2座'}</div>
                        <div class="overview-name-large">运营中充电站数量</div>
                        <div class="overview-subtext">四方坪站、高岭站</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value-large">${overviewData.summary.gl || '11150kw'}</div>
                        <div class="overview-name-large">设备总功率</div>
                        <div class="overview-subtext">四方坪站${overviewData.summary.sfpgl || '8990kw'}<br>高岭站${overviewData.summary.glgl || '2160kw'}</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value-large">${overviewData.summary.qs || '178支'}</div>
                        <div class="overview-name-large">总充电枪数量</div>
                        <div class="overview-subtext">四方坪站${overviewData.summary.sfpcdq || '142支'}<br>高岭站${overviewData.summary.glcdq || '36支'}</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-value-large">${overviewData.summary.zy || '15支'}</div>
                        <div class="overview-name-large">占用充电枪数量</div>
                        <div class="overview-subtext">四方坪站${overviewData.summary.sfpz || '15支'}</div>
                    </div>
                `;
            }
        }

        // 注意：星空背景动画的初始化已移至主DOMContentLoaded事件中，延迟执行
        // 这样可以确保登录功能优先初始化，不受动画加载影响

        // 数据可视化分析相关变量
        let visualizationData = {
            stationData: [], // sheet2数据
            terminalData: [], // sheet3数据
            vehicleData: [], // sheet4数据
            userData: [] // sheet5数据
        };
        let currentVisualizationDate = null;
        let visualizationCharts = {
            station: null,
            terminal: null,
            vehicle: null,
            user: null
        };

        // 用户充电行为分析相关变量
        let behaviorData = [];
        let currentDateIndex = 0;
        let behaviorChart = null;
        let refreshInterval = null; // 自动刷新定时器
        let currentDataMode = 'day'; // 'day' 或 'month'
        let currentDayIndex = 0; // 日数据模式下的当前日期索引
        let currentMonthIndex = 0; // 月数据模式下的当前月份索引
        let dayDataList = []; // 日数据列表
        let monthDataList = []; // 月数据列表

        // 从sheet1获取最大日期（优化版：使用缓存）
        async function getMaxDateFromSheet1() {
            try {
                // 使用缓存管理器加载数据（与loadSiteStatsData和loadVisualizationData共享缓存）
                const workbook = await resourceCache.get('https://www.csfhcdz.cn/data/hzsj.xlsx');
                
                // 获取Sheet1工作表
                if (!workbook.Sheets['Sheet1']) {
                    return null;
                }
                
                const sheet1Data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet1'], { header: 1 });
                
                if (sheet1Data.length < 2) {
                    return null;
                }
                
                // 第一列是日期，从第二行开始（索引1）
                let maxDate = null;
                let maxDateStr = null;
                
                for (let i = 1; i < sheet1Data.length; i++) {
                    const row = sheet1Data[i];
                    if (!row || row.length === 0) continue;
                    
                    const dateValue = row[0];
                    if (!dateValue) continue;
                    
                    let dateStr = convertExcelDate(dateValue);
                    if (!dateStr) continue;
                    
                    // 比较日期，找到最大值
                    if (!maxDateStr || dateStr > maxDateStr) {
                        maxDateStr = dateStr;
                        maxDate = dateStr;
                    }
                }
                
                return maxDate;
            } catch (error) {
                console.error('获取最大日期失败:', error);
                return null;
            }
        }

        // 初始化数据可视化分析
        async function initVisualizationAnalysis() {
            try {
                // 从sheet1获取最大日期作为默认日期
                const maxDate = await getMaxDateFromSheet1();
                if (maxDate) {
                    currentVisualizationDate = maxDate;
                } else {
                    // 如果获取失败，使用当前年份的9月作为备用
                    const now = new Date();
                    const year = now.getFullYear();
                    currentVisualizationDate = `${year}-09`;
                }
                
                // 更新日期显示
                document.getElementById('visualization-date-display').textContent = currentVisualizationDate;
                
                // 加载数据
                await loadVisualizationData();
                
                // 设置翻页按钮事件
                setupVisualizationControls();
                
                // 渲染所有图表
                renderAllVisualizationCharts();
                
                // 更新按钮状态
                updateVisualizationButtonStates();
                
            } catch (error) {
            }
        }

        // Excel日期转换函数
        function convertExcelDate(excelDate) {
            if (!excelDate) return null;
            
            // 如果是数字（Excel日期序列号）
            if (typeof excelDate === 'number') {
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                return date.toISOString().slice(0, 7); // 返回yyyy-mm格式
            }
            
            // 如果已经是字符串格式
            if (typeof excelDate === 'string') {
                // 检查是否是yyyy-mm格式
                if (/^\d{4}-\d{2}$/.test(excelDate)) {
                    return excelDate;
                }
                // 尝试解析其他日期格式
                const date = new Date(excelDate);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().slice(0, 7);
                }
            }
            
            return null;
        }

        // 加载可视化数据（优化版：使用缓存，与loadSiteStatsData共享）
        async function loadVisualizationData() {
            try {
                // 使用缓存管理器加载数据（与loadSiteStatsData共享缓存）
                const workbook = await resourceCache.get('https://www.csfhcdz.cn/data/hzsj.xlsx');
                
                // 加载sheet2数据（站点数据）
                if (workbook.Sheets['Sheet2']) {
                    const sheet2Data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet2'], { header: 1 });
                    visualizationData.stationData = processSheet2Data(sheet2Data);
                }
                
                // 加载sheet3数据（电站终端数据）
                if (workbook.Sheets['Sheet3']) {
                    const sheet3Data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet3'], { header: 1 });
                    visualizationData.terminalData = processSheet3Data(sheet3Data);
                }
                
                // 加载sheet4数据（车辆分类数据）
                if (workbook.Sheets['Sheet4']) {
                    const sheet4Data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet4'], { header: 1 });
                    visualizationData.vehicleData = processSheet4Data(sheet4Data);
                }
                
                // 加载sheet5数据（用户分类数据）
                if (workbook.Sheets['Sheet5']) {
                    const sheet5Data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet5'], { header: 1 });
                    visualizationData.userData = processSheet5Data(sheet5Data);
                }
                
            } catch (error) {
            }
        }

        // 处理sheet2数据（站点数据）
        function processSheet2Data(data) {
            if (data.length < 2) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => ({
                time: convertExcelDate(row[0]),
                station: row[1],
                chargingPower: parseFloat(row[2]) || 0,
                serviceFee: parseFloat(row[3]) || 0,
                chargingFee: parseFloat(row[4]) || 0,
                orderCount: parseInt(row[5]) || 0
            })).filter(item => item.time && item.station);
        }

        // 处理sheet3数据（电站终端数据）
        function processSheet3Data(data) {
            if (data.length < 2) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => ({
                time: convertExcelDate(row[0]),
                stationName: row[1],
                terminalName: row[2],
                chargingPower: parseFloat(row[3]) || 0,
                orderCount: parseInt(row[4]) || 0,
                avgDailyPower: parseFloat(row[5]) || 0
            })).filter(item => item.time && item.stationName && item.terminalName);
        }

        // 处理sheet4数据（车辆分类数据）
        function processSheet4Data(data) {
            if (data.length < 2) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => ({
                time: convertExcelDate(row[0]),
                vehicleType: row[1],
                chargingPower: parseFloat(row[2]) || 0
            })).filter(item => item.time && item.vehicleType);
        }

        // 处理sheet5数据（用户分类数据）
        function processSheet5Data(data) {
            if (data.length < 2) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => ({
                time: convertExcelDate(row[0]),
                userType: row[1],
                chargingPower: parseFloat(row[2]) || 0,
                serviceFee: parseFloat(row[3]) || 0,
                chargingFee: parseFloat(row[4]) || 0,
                orderCount: parseInt(row[5]) || 0
            })).filter(item => item.time && item.userType);
        }
        // 设置可视化控制按钮
        function setupVisualizationControls() {
            document.getElementById('prev-visualization-btn').addEventListener('click', () => {
                if (!document.getElementById('prev-visualization-btn').disabled) {
                    changeVisualizationDate(-1);
                }
            });
            
            document.getElementById('next-visualization-btn').addEventListener('click', () => {
                if (!document.getElementById('next-visualization-btn').disabled) {
                    changeVisualizationDate(1);
                }
            });
        }

        // 更新可视化按钮状态
        function updateVisualizationButtonStates() {
            const prevBtn = document.getElementById('prev-visualization-btn');
            const nextBtn = document.getElementById('next-visualization-btn');
            
            // 获取所有可用日期
            const allDates = new Set();
            [...visualizationData.stationData, ...visualizationData.terminalData, 
             ...visualizationData.vehicleData, ...visualizationData.userData]
                .forEach(item => {
                    if (item.time) allDates.add(item.time);
                });
            
            const sortedDates = Array.from(allDates).sort();
            const currentIndex = sortedDates.indexOf(currentVisualizationDate);
            
            // 更新按钮状态
            if (currentIndex <= 0) {
                prevBtn.disabled = true;
                prevBtn.style.background = '#6c757d';
                prevBtn.style.cursor = 'not-allowed';
            } else {
                prevBtn.disabled = false;
                prevBtn.style.background = '#007bff';
                prevBtn.style.cursor = 'pointer';
            }
            
            if (currentIndex >= sortedDates.length - 1) {
                nextBtn.disabled = true;
                nextBtn.style.background = '#6c757d';
                nextBtn.style.cursor = 'not-allowed';
            } else {
                nextBtn.disabled = false;
                nextBtn.style.background = '#007bff';
                nextBtn.style.cursor = 'pointer';
            }
        }

        // 改变可视化日期
        function changeVisualizationDate(direction) {
            // 获取所有可用日期
            const allDates = new Set();
            [...visualizationData.stationData, ...visualizationData.terminalData, 
             ...visualizationData.vehicleData, ...visualizationData.userData]
                .forEach(item => {
                    if (item.time) allDates.add(item.time);
                });
            
            const sortedDates = Array.from(allDates).sort();
            const currentIndex = sortedDates.indexOf(currentVisualizationDate);
            
            let newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < sortedDates.length) {
                currentVisualizationDate = sortedDates[newIndex];
                document.getElementById('visualization-date-display').textContent = currentVisualizationDate;
                renderAllVisualizationCharts();
                updateVisualizationButtonStates();
            }
        }

        // 渲染所有可视化图表
        function renderAllVisualizationCharts() {
            renderStationChart();
            renderTerminalChart();
            renderVehicleChart();
            renderUserChart();
        }
        // 渲染站点柱状图
        function renderStationChart() {
            const ctx = document.getElementById('station-chart').getContext('2d');
            
            // 过滤当前日期的数据
            const currentData = visualizationData.stationData.filter(item => item.time === currentVisualizationDate);
            
            // 按站点分组数据
            const stationGroups = {};
            currentData.forEach(item => {
                if (!stationGroups[item.station]) {
                    stationGroups[item.station] = {
                        chargingPower: 0,
                        serviceFee: 0,
                        chargingFee: 0,
                        orderCount: 0
                    };
                }
                stationGroups[item.station].chargingPower += item.chargingPower;
                stationGroups[item.station].serviceFee += item.serviceFee;
                stationGroups[item.station].chargingFee += item.chargingFee;
                stationGroups[item.station].orderCount += item.orderCount;
            });
            
            const stations = Object.keys(stationGroups);
            const chargingPowerData = stations.map(station => stationGroups[station].chargingPower);
            const serviceFeeData = stations.map(station => stationGroups[station].serviceFee);
            const chargingFeeData = stations.map(station => stationGroups[station].chargingFee);
            const orderCountData = stations.map(station => stationGroups[station].orderCount);
            
            if (visualizationCharts.station) {
                visualizationCharts.station.destroy();
            }
            
            visualizationCharts.station = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stations,
                    datasets: [
                        {
                            label: '充电电量(kwh)',
                            data: chargingPowerData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '充电服务费(元)',
                            data: serviceFeeData,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '充电费用(元)',
                            data: chargingFeeData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '订单数量',
                            data: orderCountData,
                            backgroundColor: 'rgba(255, 205, 86, 0.6)',
                            borderColor: 'rgba(255, 205, 86, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1.5,
                    devicePixelRatio: 1,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const station = context.label;
                                    const currentData = visualizationData.stationData.filter(item => 
                                        item.time === currentVisualizationDate && item.station === station
                                    );
                                    
                                    if (currentData.length === 0) return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                                    
                                    const total = currentData.reduce((sum, item) => sum + item.chargingPower, 0);
                                    const serviceFee = currentData.reduce((sum, item) => sum + item.serviceFee, 0);
                                    const chargingFee = currentData.reduce((sum, item) => sum + item.chargingFee, 0);
                                    const orderCount = currentData.reduce((sum, item) => sum + item.orderCount, 0);
                                    
                                    return [
                                        '充电电量(kwh): ' + total.toFixed(2),
                                        '充电服务费(元): ' + serviceFee.toFixed(2),
                                        '充电费用(元): ' + chargingFee.toFixed(2),
                                        '订单数量: ' + orderCount.toFixed(2)
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        // 渲染电站终端折线图
        function renderTerminalChart() {
            const ctx = document.getElementById('terminal-chart').getContext('2d');
            
            // 过滤当前日期的数据
            const currentData = visualizationData.terminalData.filter(item => item.time === currentVisualizationDate);
            
            // 按电站和终端分组
            const terminalGroups = {};
            currentData.forEach(item => {
                const key = `${item.stationName}-${item.terminalName}`;
                if (!terminalGroups[key]) {
                    terminalGroups[key] = {
                        chargingPower: 0,
                        orderCount: 0,
                        avgDailyPower: 0
                    };
                }
                terminalGroups[key].chargingPower += item.chargingPower;
                terminalGroups[key].orderCount += item.orderCount;
                terminalGroups[key].avgDailyPower += item.avgDailyPower;
            });
            
            const terminals = Object.keys(terminalGroups);
            const chargingPowerData = terminals.map(terminal => terminalGroups[terminal].chargingPower);
            const orderCountData = terminals.map(terminal => terminalGroups[terminal].orderCount);
            const avgDailyPowerData = terminals.map(terminal => terminalGroups[terminal].avgDailyPower);
            
            if (visualizationCharts.terminal) {
                visualizationCharts.terminal.destroy();
            }
            
            visualizationCharts.terminal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: terminals,
                    datasets: [
                        {
                            label: '充电电量(kwh)',
                            data: chargingPowerData,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: '订单数量',
                            data: orderCountData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: '平均日充电电量(kwh)',
                            data: avgDailyPowerData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1.5,
                    devicePixelRatio: 1,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const terminal = context.label;
                                    const currentData = visualizationData.terminalData.filter(item => 
                                        item.time === currentVisualizationDate && `${item.stationName}-${item.terminalName}` === terminal
                                    );
                                    
                                    if (currentData.length === 0) return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                                    
                                    const chargingPower = currentData.reduce((sum, item) => sum + item.chargingPower, 0);
                                    const orderCount = currentData.reduce((sum, item) => sum + item.orderCount, 0);
                                    const avgDailyPower = currentData.reduce((sum, item) => sum + item.avgDailyPower, 0);
                                    
                                    return [
                                        '充电电量(kwh): ' + chargingPower.toFixed(2),
                                        '订单数量: ' + orderCount.toFixed(2),
                                        '平均日充电电量(kwh): ' + avgDailyPower.toFixed(2)
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // 渲染车辆分类饼图
        function renderVehicleChart() {
            const ctx = document.getElementById('vehicle-chart').getContext('2d');
            
            // 过滤当前日期的数据
            const currentData = visualizationData.vehicleData.filter(item => item.time === currentVisualizationDate);
            
            // 按车辆分类分组
            const vehicleGroups = {};
            currentData.forEach(item => {
                if (!vehicleGroups[item.vehicleType]) {
                    vehicleGroups[item.vehicleType] = 0;
                }
                vehicleGroups[item.vehicleType] += item.chargingPower;
            });
            
            const vehicleTypes = Object.keys(vehicleGroups);
            const chargingPowerData = Object.values(vehicleGroups);
            const total = chargingPowerData.reduce((sum, value) => sum + value, 0);
            
            // 计算百分比
            const percentages = chargingPowerData.map(value => ((value / total) * 100).toFixed(1));
            
            if (visualizationCharts.vehicle) {
                visualizationCharts.vehicle.destroy();
            }
            
            visualizationCharts.vehicle = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: vehicleTypes.map((type, index) => `${type} (${percentages[index]}%)`),
                    datasets: [{
                        data: chargingPowerData,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1,
                    devicePixelRatio: 1,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const vehicleType = vehicleTypes[context.dataIndex];
                                    const currentData = visualizationData.vehicleData.filter(item => 
                                        item.time === currentVisualizationDate && item.vehicleType === vehicleType
                                    );
                                    
                                    if (currentData.length === 0) return context.label + ': ' + context.parsed.toFixed(2);
                                    
                                    const chargingPower = currentData.reduce((sum, item) => sum + item.chargingPower, 0);
                                    const total = chargingPowerData.reduce((sum, value) => sum + value, 0);
                                    const percentage = ((chargingPower / total) * 100).toFixed(2);
                                    
                                    return [
                                        '车辆分类: ' + vehicleType,
                                        '充电电量(kwh): ' + chargingPower.toFixed(2),
                                        '占比: ' + percentage + '%'
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        // 渲染用户分类散点图
        function renderUserChart() {
            const ctx = document.getElementById('user-chart').getContext('2d');
            
            // 过滤当前日期的数据
            const currentData = visualizationData.userData.filter(item => item.time === currentVisualizationDate);
            
            // 按用户分类分组
            const userGroups = {};
            currentData.forEach(item => {
                if (!userGroups[item.userType]) {
                    userGroups[item.userType] = {
                        chargingPower: 0,
                        serviceFee: 0,
                        chargingFee: 0,
                        orderCount: 0
                    };
                }
                userGroups[item.userType].chargingPower += item.chargingPower;
                userGroups[item.userType].serviceFee += item.serviceFee;
                userGroups[item.userType].chargingFee += item.chargingFee;
                userGroups[item.userType].orderCount += item.orderCount;
            });
            
            const userTypes = Object.keys(userGroups);
            const totalChargingPower = Object.values(userGroups).reduce((sum, group) => sum + group.chargingPower, 0);
            const totalServiceFee = Object.values(userGroups).reduce((sum, group) => sum + group.serviceFee, 0);
            const totalChargingFee = Object.values(userGroups).reduce((sum, group) => sum + group.chargingFee, 0);
            const totalOrderCount = Object.values(userGroups).reduce((sum, group) => sum + group.orderCount, 0);
            
            const datasets = [
                {
                    label: '充电电量(kwh)',
                    data: userTypes.map(userType => ({
                        x: userGroups[userType].chargingPower,
                        y: userGroups[userType].orderCount
                    })),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)'
                },
                {
                    label: '充电服务费(元)',
                    data: userTypes.map(userType => ({
                        x: userGroups[userType].serviceFee,
                        y: userGroups[userType].orderCount
                    })),
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)'
                },
                {
                    label: '充电费用(元)',
                    data: userTypes.map(userType => ({
                        x: userGroups[userType].chargingFee,
                        y: userGroups[userType].orderCount
                    })),
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)'
                }
            ];
            
            if (visualizationCharts.user) {
                visualizationCharts.user.destroy();
            }
            
            visualizationCharts.user = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1.5,
                    devicePixelRatio: 1,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '数值'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '订单数量'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const userType = userTypes[context.dataIndex];
                                    const currentData = visualizationData.userData.filter(item => 
                                        item.time === currentVisualizationDate && item.userType === userType
                                    );
                                    
                                    if (currentData.length === 0) return context.dataset.label + ': ' + context.parsed.x.toFixed(2);
                                    
                                    const chargingPower = currentData.reduce((sum, item) => sum + item.chargingPower, 0);
                                    const serviceFee = currentData.reduce((sum, item) => sum + item.serviceFee, 0);
                                    const chargingFee = currentData.reduce((sum, item) => sum + item.chargingFee, 0);
                                    const orderCount = currentData.reduce((sum, item) => sum + item.orderCount, 0);
                                    const totalChargingPower = Object.values(userGroups).reduce((sum, group) => sum + group.chargingPower, 0);
                                    const percentage = ((chargingPower / totalChargingPower) * 100).toFixed(2);
                                    
                                    return [
                                        '用户分类: ' + userType,
                                        '充电电量(kwh): ' + chargingPower.toFixed(2),
                                        '充电服务费(元): ' + serviceFee.toFixed(2),
                                        '充电费用(元): ' + chargingFee.toFixed(2),
                                        '订单数量: ' + orderCount.toFixed(2),
                                        '占比: ' + percentage + '%'
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // 初始化用户充电行为分析
        async function initUserBehaviorAnalysis() {
            try {
                await loadBehaviorData();
                setupBehaviorControls();
                // 更新图表和电费分析表格
                if (behaviorData.length > 0) {
                    const currentData = behaviorData[currentDateIndex];
                    updateBehaviorChart(currentData);
                    updateElectricityTable(currentData);
                }
                
                // 启动自动刷新功能（每5分钟检查一次数据更新）
                startAutoRefresh();
            } catch (error) {
            }
        }

        // 启动自动刷新功能
        function startAutoRefresh() {
            // 清除之前的定时器
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // 每5分钟自动刷新数据
            refreshInterval = setInterval(async () => {
                try {
                    await loadBehaviorData();
                    
                    // 如果当前日期索引超出范围，重置为最大日期
                    if (currentDateIndex >= behaviorData.length) {
                        currentDateIndex = behaviorData.length - 1;
                    }
                    
                    // 更新图表和电费分析表格
                    if (behaviorData.length > 0) {
                        const currentData = behaviorData[currentDateIndex];
                        updateBehaviorChart(currentData);
                        updateElectricityTable(currentData);
                        
                        // 更新当前日期显示
                        const currentDateDisplay = document.getElementById('current-date-display');
                        if (currentDateDisplay) {
                            currentDateDisplay.textContent = `当前日期：${currentData.displayDate}`;
                        }
                    }
                } catch (error) {
                }
            }, 5 * 60 * 1000); // 5分钟
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // 加载行为数据
        async function loadBehaviorData() {
            try {
                const response = await fetch('https://www.csfhcdz.cn/data/yhxw.xlsx?t=' + new Date().getTime());
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // 调试用

                // 处理数据 - 按照Excel文件的实际格式加载
                behaviorData = [];

                // 按照Excel文件格式：A列日期，B列站点，C-Z列24小时数据
                // 每天占两行：第一行四方坪站，第二行高岭站
                for (let i = 1; i < jsonData.length; i += 2) {
                    const dateRow = jsonData[i];      // 四方坪站行
                    const stationRow = jsonData[i + 1]; // 高岭站行
                    
                    if (dateRow && dateRow[0]) {
                        const dateStr = dateRow[0];
                        let date;
                        
                        // 处理不同的日期格式
                        if (typeof dateStr === 'number') {
                            // Excel日期数字格式
                            date = new Date((dateStr - 25569) * 86400 * 1000);
                        } else if (typeof dateStr === 'string') {
                            // 字符串格式
                            date = new Date(dateStr);
                        } else {
                            continue;
                        }

                        const dateKey = date.toISOString().split('T')[0];
                        
                        // 从C列开始获取24小时数据（索引2-25）
                        const sfpData = dateRow.slice(2, 26) || new Array(24).fill(0);
                        const glData = stationRow ? stationRow.slice(2, 26) : new Array(24).fill(0);
                        
                        // 添加到图表数据（用于翻页和图表显示）
                        if (!behaviorData.find(d => d.date === dateKey)) {
                            behaviorData.push({
                                date: dateKey,
                                displayDate: formatDate(date),
                                sfpData: sfpData,
                                glData: glData
                            });
                        }
                    }
                }

                // 按日期排序
                behaviorData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // 设置当前日期为最大日期
                if (behaviorData.length > 0) {
                    currentDateIndex = behaviorData.length - 1;
                }

                // 更新按钮状态
                updateBehaviorButtonStates();

            } catch (error) {
                // 数据加载失败时也要更新按钮状态
                updateBehaviorButtonStates();
            }
        }

        // 格式化日期为MM-DD格式
        function formatDate(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
        }
        // 设置行为分析控件
        function setupBehaviorControls() {
            const prevBtn = document.getElementById('prev-data-btn');
            const nextBtn = document.getElementById('next-data-btn');
            const currentDataDisplay = document.getElementById('current-data-display');
            const dayDataBtn = document.getElementById('day-data-btn');
            const monthDataBtn = document.getElementById('month-data-btn');

            // 初始化数据列表
            initializeDataLists();
            
            // 设置默认显示最新数据
            if (dayDataList.length > 0) {
                currentDayIndex = dayDataList.length - 1;
            }
            if (monthDataList.length > 0) {
                currentMonthIndex = monthDataList.length - 1;
            }

            // 数据模式切换事件
            dayDataBtn.addEventListener('click', function() {
                currentDataMode = 'day';
                updateDataModeButtons();
                updateDataDisplay();
                updateBehaviorButtonStates();
            });

            monthDataBtn.addEventListener('click', function() {
                currentDataMode = 'month';
                updateDataModeButtons();
                updateDataDisplay();
                updateBehaviorButtonStates();
            });

            // 翻页按钮事件
            prevBtn.addEventListener('click', function() {
                if (currentDataMode === 'day') {
                    if (currentDayIndex > 0) {
                        currentDayIndex--;
                        updateDataDisplay();
                        updateBehaviorDisplay();
                    }
                } else {
                    if (currentMonthIndex > 0) {
                        currentMonthIndex--;
                        updateDataDisplay();
                        updateBehaviorDisplay();
                    }
                }
                updateBehaviorButtonStates();
            });

            nextBtn.addEventListener('click', function() {
                if (currentDataMode === 'day') {
                    if (currentDayIndex < dayDataList.length - 1) {
                        currentDayIndex++;
                        updateDataDisplay();
                        updateBehaviorDisplay();
                    }
                } else {
                    if (currentMonthIndex < monthDataList.length - 1) {
                        currentMonthIndex++;
                        updateDataDisplay();
                        updateBehaviorDisplay();
                    }
                }
                updateBehaviorButtonStates();
            });

            // 初始化显示
            updateDataModeButtons();
            updateDataDisplay();
            updateBehaviorButtonStates();
        }

        // 初始化数据列表
        function initializeDataLists() {
            if (behaviorData.length === 0) return;

            // 初始化日数据列表
            dayDataList = behaviorData.map(item => {
                const date = new Date(item.date);
                return {
                    date: item.date,
                    displayDate: formatDate(date),
                    data: item
                };
            });

            // 初始化月数据列表
            const monthMap = new Map();
            behaviorData.forEach(item => {
                const date = new Date(item.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (!monthMap.has(monthKey)) {
                    monthMap.set(monthKey, {
                        monthKey: monthKey,
                        displayMonth: monthKey,
                        data: []
                    });
                }
                monthMap.get(monthKey).data.push(item);
            });

            monthDataList = Array.from(monthMap.values()).sort((a, b) => a.monthKey.localeCompare(b.monthKey));
        }

        // 更新数据模式按钮状态
        function updateDataModeButtons() {
            const dayDataBtn = document.getElementById('day-data-btn');
            const monthDataBtn = document.getElementById('month-data-btn');

            if (currentDataMode === 'day') {
                dayDataBtn.style.background = '#007bff';
                monthDataBtn.style.background = '#6c757d';
            } else {
                dayDataBtn.style.background = '#6c757d';
                monthDataBtn.style.background = '#007bff';
            }
        }

        // 更新数据显示
        function updateDataDisplay() {
            const currentDataDisplay = document.getElementById('current-data-display');
            
            if (currentDataMode === 'day') {
                if (dayDataList.length > 0 && currentDayIndex < dayDataList.length) {
                    currentDataDisplay.textContent = dayDataList[currentDayIndex].displayDate;
                } else {
                    currentDataDisplay.textContent = '无数据';
                }
            } else {
                if (monthDataList.length > 0 && currentMonthIndex < monthDataList.length) {
                    // 月数据模式下，直接显示YYYY-MM格式
                    currentDataDisplay.textContent = monthDataList[currentMonthIndex].displayMonth;
                } else {
                    currentDataDisplay.textContent = '无数据';
                }
            }
        }

        // 更新行为分析按钮状态
        function updateBehaviorButtonStates() {
            const prevBtn = document.getElementById('prev-data-btn');
            const nextBtn = document.getElementById('next-data-btn');
            
            if (!prevBtn || !nextBtn) return;

            let canGoPrev = false;
            let canGoNext = false;

            if (currentDataMode === 'day') {
                canGoPrev = currentDayIndex > 0;
                canGoNext = currentDayIndex < dayDataList.length - 1;
            } else {
                canGoPrev = currentMonthIndex > 0;
                canGoNext = currentMonthIndex < monthDataList.length - 1;
            }

            // 更新上一页按钮状态
            if (canGoPrev) {
                prevBtn.style.background = '#007bff';
                prevBtn.style.cursor = 'pointer';
                prevBtn.disabled = false;
            } else {
                prevBtn.style.background = '#ccc';
                prevBtn.style.cursor = 'not-allowed';
                prevBtn.disabled = true;
            }
            
            // 更新下一页按钮状态
            if (canGoNext) {
                nextBtn.style.background = '#007bff';
                nextBtn.style.cursor = 'pointer';
                nextBtn.disabled = false;
            } else {
                nextBtn.style.background = '#ccc';
                nextBtn.style.cursor = 'not-allowed';
                nextBtn.disabled = true;
            }
        }

        // 更新行为分析显示
        function updateBehaviorDisplay() {
            if (behaviorData.length === 0) return;

            let currentData = null;

            if (currentDataMode === 'day') {
                if (dayDataList.length > 0 && currentDayIndex < dayDataList.length) {
                    currentData = dayDataList[currentDayIndex].data;
                }
            } else {
                if (monthDataList.length > 0 && currentMonthIndex < monthDataList.length) {
                    // 月数据模式：合并该月所有日期的数据
                    const monthData = monthDataList[currentMonthIndex];
                    currentData = aggregateMonthData(monthData.data);
                }
            }

            if (currentData) {
                // 更新图表和电费分析表格
                updateBehaviorChart(currentData);
                updateElectricityTable(currentData);
            }
        }
        // 聚合月数据
        function aggregateMonthData(monthDataArray) {
            if (monthDataArray.length === 0) return null;

            // 如果只有一天的数据，直接返回
            if (monthDataArray.length === 1) {
                return monthDataArray[0];
            }

            // 聚合多天数据
            const aggregatedData = {
                date: monthDataArray[0].date, // 使用第一天的日期作为代表
                displayDate: monthDataArray[0].displayDate,
                sfpData: new Array(24).fill(0),
                glData: new Array(24).fill(0)
            };

            // 累加24小时数据
            monthDataArray.forEach(dayData => {
                for (let i = 0; i < 24; i++) {
                    aggregatedData.sfpData[i] += (dayData.sfpData[i] || 0);
                    aggregatedData.glData[i] += (dayData.glData[i] || 0);
                }
            });

            return aggregatedData;
        }
        // 计算电费分析数据
        function calculateElectricityData(data) {
            const currentDate = new Date(data.date);
            const month = currentDate.getMonth() + 1; // 1-12
            
            let sfpJian = 0, sfpFeng = 0, sfpPing = 0, sfpGu = 0;
            let glJian = 0, glFeng = 0, glPing = 0, glGu = 0;
            
            // 根据月份确定时段划分
            if (month === 7 || month === 8) {
                // 夏季（7、8月）：尖20:00-23:59，峰16:00-19:59，平06:00-11:59+14:00-15:59，谷00:00-05:59+12:00-13:59
                for (let hour = 0; hour < 24; hour++) {
                    const sfpValue = parseFloat(data.sfpData[hour]) || 0;
                    const glValue = parseFloat(data.glData[hour]) || 0;
                    
                    if (hour >= 20 && hour <= 23) {
                        // 尖时段
                        sfpJian += sfpValue;
                        glJian += glValue;
                    } else if (hour >= 16 && hour <= 19) {
                        // 峰时段
                        sfpFeng += sfpValue;
                        glFeng += glValue;
                    } else if ((hour >= 6 && hour <= 11) || (hour >= 14 && hour <= 15)) {
                        // 平时段
                        sfpPing += sfpValue;
                        glPing += glValue;
                    } else {
                        // 谷时段
                        sfpGu += sfpValue;
                        glGu += glValue;
                    }
                }
            } else if (month === 1 || month === 12) {
                // 冬季（1、12月）：尖18:00-21:59，峰16:00-17:59+22:00-23:59，平06:00-11:59+14:00-15:59，谷00:00-05:59+12:00-13:59
                for (let hour = 0; hour < 24; hour++) {
                    const sfpValue = parseFloat(data.sfpData[hour]) || 0;
                    const glValue = parseFloat(data.glData[hour]) || 0;
                    
                    if (hour >= 18 && hour <= 21) {
                        // 尖时段
                        sfpJian += sfpValue;
                        glJian += glValue;
                    } else if ((hour >= 16 && hour <= 17) || (hour >= 22 && hour <= 23)) {
                        // 峰时段
                        sfpFeng += sfpValue;
                        glFeng += glValue;
                    } else if ((hour >= 6 && hour <= 11) || (hour >= 14 && hour <= 15)) {
                        // 平时段
                        sfpPing += sfpValue;
                        glPing += glValue;
                    } else {
                        // 谷时段
                        sfpGu += sfpValue;
                        glGu += glValue;
                    }
                }
            } else {
                // 其他月份（2、3、4、5、6、9、10、11）：无尖时段，峰16:00-23:59，平06:00-11:59+14:00-15:59，谷00:00-05:59+12:00-13:59
                for (let hour = 0; hour < 24; hour++) {
                    const sfpValue = parseFloat(data.sfpData[hour]) || 0;
                    const glValue = parseFloat(data.glData[hour]) || 0;
                    
                    if (hour >= 16 && hour <= 23) {
                        // 峰时段
                        sfpFeng += sfpValue;
                        glFeng += glValue;
                    } else if ((hour >= 6 && hour <= 11) || (hour >= 14 && hour <= 15)) {
                        // 平时段
                        sfpPing += sfpValue;
                        glPing += glValue;
                    } else {
                        // 谷时段
                        sfpGu += sfpValue;
                        glGu += glValue;
                    }
                }
            }
            
            return {
                sfp: {
                    jian: sfpJian,
                    feng: sfpFeng,
                    ping: sfpPing,
                    gu: sfpGu,
                    total: sfpJian + sfpFeng + sfpPing + sfpGu
                },
                gl: {
                    jian: glJian,
                    feng: glFeng,
                    ping: glPing,
                    gu: glGu,
                    total: glJian + glFeng + glPing + glGu
                }
            };
        }

        // 更新尖峰平谷充电记录表格
        function updateElectricityTable(data) {
            const tbody = document.getElementById('electricity-table-body');
            if (!tbody) return;
            
            const electricityData = calculateElectricityData(data);
            
            // 计算总计
            const totalJian = electricityData.sfp.jian + electricityData.gl.jian;
            const totalFeng = electricityData.sfp.feng + electricityData.gl.feng;
            const totalPing = electricityData.sfp.ping + electricityData.gl.ping;
            const totalGu = electricityData.sfp.gu + electricityData.gl.gu;
            const totalAll = totalJian + totalFeng + totalPing + totalGu;
            
            tbody.innerHTML = `
                <tr>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">四方坪站</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.sfp.jian.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.sfp.feng.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.sfp.ping.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.sfp.gu.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0; font-weight: bold;">${electricityData.sfp.total.toFixed(2)}</td>
                </tr>
                <tr>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">高岭站</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.gl.jian.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.gl.feng.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.gl.ping.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${electricityData.gl.gu.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0; font-weight: bold;">${electricityData.gl.total.toFixed(2)}</td>
                </tr>
                <tr style="background-color: #f8f9fa; font-weight: bold;">
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">共计</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${totalJian.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${totalFeng.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${totalPing.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${totalGu.toFixed(2)}</td>
                    <td style="text-align: center; padding: 8px; border: 1px solid #e0e0e0;">${totalAll.toFixed(2)}</td>
                </tr>
            `;
            
            // 同时更新两个饼图
            updateElectricityPieChartSFP(electricityData);
            updateElectricityPieChartGL(electricityData);
            
            // 更新数字显示和箭头
            updateElectricityNumbers(electricityData, data);
        }

        // 更新数字显示和箭头
        function updateElectricityNumbers(electricityData, currentData) {
            // 获取上个月的数据进行比较
            const currentDate = new Date(currentData.date);
            const previousMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            const previousMonthKey = previousMonth.toISOString().split('T')[0];
            
            // 查找上个月的数据
            const previousData = behaviorData.find(d => d.date === previousMonthKey);
            
            // 更新四方坪站数字显示
            updateStationNumbers('sfp', electricityData.sfp, previousData);
            
            // 更新高岭站数字显示
            updateStationNumbers('gl', electricityData.gl, previousData);
        }
        
        // 更新单个站点的数字显示
        function updateStationNumbers(stationPrefix, currentData, previousData) {
            const fields = ['jian', 'feng', 'ping', 'gu'];
            
            // 计算总数用于百分比计算
            const total = currentData.jian + currentData.feng + currentData.ping + currentData.gu;
            
            fields.forEach(field => {
                const numberElement = document.getElementById(`${stationPrefix}-${field}-number`);
                const percentElement = document.getElementById(`${stationPrefix}-${field}-percent`);
                const numberItemElement = numberElement ? numberElement.closest('.number-item') : null;
                
                if (numberElement && percentElement && numberItemElement) {
                    const value = currentData[field];
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    
                    // 如果数据为0，隐藏整个数字项
                    if (value === 0) {
                        numberItemElement.style.display = 'none';
                    } else {
                        numberItemElement.style.display = 'flex';
                        numberElement.textContent = value.toFixed(2);
                        percentElement.textContent = `(${percentage}%)`;
                    }
                }
            });
        }

        // 更新四方坪站尖峰平谷饼图
        function updateElectricityPieChartSFP(electricityData) {
            const ctx = document.getElementById('electricity-pie-chart-sfp');
            if (!ctx) return;

            // 销毁现有图表
            if (electricityPieChartSFP) {
                electricityPieChartSFP.destroy();
            }

            // 准备四方坪站饼图数据
            const labels = ['尖', '峰', '平', '谷'];
            const data = [
                electricityData.sfp.jian,
                electricityData.sfp.feng,
                electricityData.sfp.ping,
                electricityData.sfp.gu
            ];

            const total = data.reduce((sum, value) => sum + value, 0);

            electricityPieChartSFP = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#ff6b6b', '#ffa726', '#66bb6a', '#42a5f5' // 四方坪站：尖峰平谷
                        ],
                        borderColor: [
                            '#d32f2f', '#f57c00', '#388e3c', '#1976d2' // 四方坪站：尖峰平谷
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '四方坪站 - 尖峰平谷分布图',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 10,
                                boxWidth: 6,
                                boxHeight: 6
                            }
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    cutout: '50%' // 空心饼图
                }
            });
        }

        // 更新高岭站尖峰平谷饼图
        function updateElectricityPieChartGL(electricityData) {
            const ctx = document.getElementById('electricity-pie-chart-gl');
            if (!ctx) return;

            // 销毁现有图表
            if (electricityPieChartGL) {
                electricityPieChartGL.destroy();
            }

            // 准备高岭站饼图数据
            const labels = ['尖', '峰', '平', '谷'];
            const data = [
                electricityData.gl.jian,
                electricityData.gl.feng,
                electricityData.gl.ping,
                electricityData.gl.gu
            ];

            const total = data.reduce((sum, value) => sum + value, 0);

            electricityPieChartGL = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#e57373', '#ffb74d', '#81c784', '#64b5f6' // 高岭站：尖峰平谷
                        ],
                        borderColor: [
                            '#c62828', '#ef6c00', '#2e7d32', '#1565c0' // 高岭站：尖峰平谷
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '高岭站 - 尖峰平谷分布图',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 10,
                                boxWidth: 6,
                                boxHeight: 6
                            }
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    cutout: '50%' // 空心饼图
                }
            });
        }


        // 更新行为分析图表
        function updateBehaviorChart(data) {
            const ctx = document.getElementById('behavior-chart');
            if (!ctx) return;

            // 销毁现有图表
            if (behaviorChart) {
                behaviorChart.destroy();
            }

            const hours = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00-${i.toString().padStart(2, '0')}:59`);

            // 根据数据模式确定图表标题的日期格式
            let chartTitleDate;
            if (currentDataMode === 'day') {
                chartTitleDate = data.displayDate; // 日数据模式：MM-DD格式
            } else {
                // 月数据模式：从monthDataList获取YYYY-MM格式
                if (monthDataList.length > 0 && currentMonthIndex < monthDataList.length) {
                    chartTitleDate = monthDataList[currentMonthIndex].displayMonth;
                } else {
                    chartTitleDate = data.displayDate; // 备用显示
                }
            }

            behaviorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: '四方坪站充电量(kwh)',
                            data: data.sfpData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: '高岭站充电量(kwh)',
                            data: data.glData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${chartTitleDate} 充电量趋势分析`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '充电量 (kwh)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        // 经营效率分析相关变量
        let efficiencyData = [];
        let currentEfficiencyDateIndex = 0;
        let efficiencyRefreshInterval = null; // 经营效率自动刷新定时器
        let efficiencyRadarChart = null; // 经营效率雷达图
        let currentEfficiencyDataMode = 'day'; // 'day' 或 'month'
        let currentEfficiencyDayIndex = 0; // 日数据模式下的当前日期索引
        let currentEfficiencyMonthIndex = 0; // 月数据模式下的当前月份索引
        let efficiencyDayDataList = []; // 日数据列表
        let efficiencyMonthDataList = []; // 月数据列表

        // 初始化经营效率分析
        async function initEfficiencyAnalysis() {
            try {
                await loadEfficiencyData();
                setupEfficiencyControls();
                // 更新表格数据和雷达图
                if (efficiencyData.length > 0) {
                    const currentData = efficiencyData[currentEfficiencyDateIndex];
                    updateEfficiencyTable(currentData);
                    updateEfficiencyRadarChart(currentData);
                }
                
                // 启动自动刷新功能（每5分钟检查一次数据更新）
                startEfficiencyAutoRefresh();
            } catch (error) {
            }
        }
        // 加载经营效率数据
        async function loadEfficiencyData() {
            try {
                const response = await fetch('https://www.csfhcdz.cn/data/yyxl.xlsx?t=' + new Date().getTime());
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // 调试用

                // 处理数据 - 按照Excel文件的实际格式加载
                efficiencyData = [];

                // 按照Excel文件格式：A列日期，B列站点，C-H列数据
                // 每天占两行：第一行四方坪站，第二行高岭站
                for (let i = 1; i < jsonData.length; i += 2) {
                    const dateRow = jsonData[i];      // 四方坪站行
                    const stationRow = jsonData[i + 1]; // 高岭站行
                    
                    if (dateRow && dateRow[0]) {
                        const dateStr = dateRow[0];
                        let date;
                        
                        // 处理不同的日期格式
                        if (typeof dateStr === 'number') {
                            // Excel日期数字格式
                            date = new Date((dateStr - 25569) * 86400 * 1000);
                        } else if (typeof dateStr === 'string') {
                            // 字符串格式
                            date = new Date(dateStr);
                        } else {
                            continue;
                        }

                        const dateKey = date.toISOString().split('T')[0];
                        
                        // 从C列开始获取数据（索引2-7对应C-H列）
                        const sfpData = {
                            duration: parseFloat(dateRow[2]) || 0,      // 终端日均充电时长(分钟)
                            utilization: parseFloat(dateRow[3]) || 0,    // 终端日均利用率
                            energy: parseFloat(dateRow[4]) || 0,        // 终端日均充电电量(kwh)
                            revenue: parseFloat(dateRow[5]) || 0,        // 终端日均充电收益(元)
                            power: parseFloat(dateRow[6]) || 0,         // 平均每小时充电功率(kw)
                            times: parseFloat(dateRow[7]) || 0          // 单枪日均充电次数
                        };
                        
                        const glData = {
                            duration: parseFloat(stationRow[2]) || 0,
                            utilization: parseFloat(stationRow[3]) || 0,
                            energy: parseFloat(stationRow[4]) || 0,
                            revenue: parseFloat(stationRow[5]) || 0,
                            power: parseFloat(stationRow[6]) || 0,
                            times: parseFloat(stationRow[7]) || 0
                        };
                        
                        // 添加到数据数组
                        if (!efficiencyData.find(d => d.date === dateKey)) {
                            efficiencyData.push({
                                date: dateKey,
                                displayDate: formatEfficiencyDate(date),
                                sfpData: sfpData,
                                glData: glData
                            });
                        }
                    }
                }

                // 按日期排序
                efficiencyData.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // 设置当前日期为最大日期
                if (efficiencyData.length > 0) {
                    currentEfficiencyDateIndex = efficiencyData.length - 1;
                }

                // 更新按钮状态
                updateEfficiencyButtonStates();

            } catch (error) {
                // 数据加载失败时也要更新按钮状态
                updateEfficiencyButtonStates();
            }
        }

        // 格式化日期为YYYY-MM-DD格式
        function formatEfficiencyDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 设置经营效率分析控件
        function setupEfficiencyControls() {
            const prevBtn = document.getElementById('efficiency-prev-data-btn');
            const nextBtn = document.getElementById('efficiency-next-data-btn');
            const currentDataDisplay = document.getElementById('efficiency-current-data-display');
            const dayDataBtn = document.getElementById('efficiency-day-data-btn');
            const monthDataBtn = document.getElementById('efficiency-month-data-btn');

            // 初始化数据列表
            initializeEfficiencyDataLists();
            
            // 设置默认显示最新数据
            if (efficiencyDayDataList.length > 0) {
                currentEfficiencyDayIndex = efficiencyDayDataList.length - 1;
            }
            if (efficiencyMonthDataList.length > 0) {
                currentEfficiencyMonthIndex = efficiencyMonthDataList.length - 1;
            }

            // 数据模式切换事件
            dayDataBtn.addEventListener('click', function() {
                currentEfficiencyDataMode = 'day';
                updateEfficiencyDataModeButtons();
                updateEfficiencyDataDisplay();
                updateEfficiencyButtonStates();
            });

            monthDataBtn.addEventListener('click', function() {
                currentEfficiencyDataMode = 'month';
                updateEfficiencyDataModeButtons();
                updateEfficiencyDataDisplay();
                updateEfficiencyButtonStates();
            });

            // 翻页按钮事件
            prevBtn.addEventListener('click', function() {
                if (currentEfficiencyDataMode === 'day') {
                    if (currentEfficiencyDayIndex > 0) {
                        currentEfficiencyDayIndex--;
                        updateEfficiencyDataDisplay();
                        updateEfficiencyDisplay();
                    }
                } else {
                    if (currentEfficiencyMonthIndex > 0) {
                        currentEfficiencyMonthIndex--;
                        updateEfficiencyDataDisplay();
                        updateEfficiencyDisplay();
                    }
                }
                updateEfficiencyButtonStates();
            });

            nextBtn.addEventListener('click', function() {
                if (currentEfficiencyDataMode === 'day') {
                    if (currentEfficiencyDayIndex < efficiencyDayDataList.length - 1) {
                        currentEfficiencyDayIndex++;
                        updateEfficiencyDataDisplay();
                        updateEfficiencyDisplay();
                    }
                } else {
                    if (currentEfficiencyMonthIndex < efficiencyMonthDataList.length - 1) {
                        currentEfficiencyMonthIndex++;
                        updateEfficiencyDataDisplay();
                        updateEfficiencyDisplay();
                    }
                }
                updateEfficiencyButtonStates();
            });

            // 初始化显示
            updateEfficiencyDataModeButtons();
            updateEfficiencyDataDisplay();
            updateEfficiencyButtonStates();
        }

        // 初始化经营效率数据列表
        function initializeEfficiencyDataLists() {
            if (efficiencyData.length === 0) return;

            // 初始化日数据列表
            efficiencyDayDataList = efficiencyData.map(item => {
                const date = new Date(item.date);
                return {
                    date: item.date,
                    displayDate: formatEfficiencyDate(date).substring(5), // 只显示MM-DD
                    data: item
                };
            });

            // 初始化月数据列表
            const monthMap = new Map();
            efficiencyData.forEach(item => {
                const date = new Date(item.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (!monthMap.has(monthKey)) {
                    monthMap.set(monthKey, {
                        monthKey: monthKey,
                        displayMonth: monthKey,
                        data: []
                    });
                }
                monthMap.get(monthKey).data.push(item);
            });

            efficiencyMonthDataList = Array.from(monthMap.values()).sort((a, b) => a.monthKey.localeCompare(b.monthKey));
        }

        // 更新经营效率数据模式按钮状态
        function updateEfficiencyDataModeButtons() {
            const dayDataBtn = document.getElementById('efficiency-day-data-btn');
            const monthDataBtn = document.getElementById('efficiency-month-data-btn');

            if (currentEfficiencyDataMode === 'day') {
                dayDataBtn.style.background = '#007bff';
                monthDataBtn.style.background = '#6c757d';
            } else {
                dayDataBtn.style.background = '#6c757d';
                monthDataBtn.style.background = '#007bff';
            }
        }

        // 更新经营效率数据显示
        function updateEfficiencyDataDisplay() {
            const currentDataDisplay = document.getElementById('efficiency-current-data-display');
            
            if (currentEfficiencyDataMode === 'day') {
                if (efficiencyDayDataList.length > 0 && currentEfficiencyDayIndex < efficiencyDayDataList.length) {
                    currentDataDisplay.textContent = efficiencyDayDataList[currentEfficiencyDayIndex].displayDate;
                } else {
                    currentDataDisplay.textContent = '无数据';
                }
            } else {
                if (efficiencyMonthDataList.length > 0 && currentEfficiencyMonthIndex < efficiencyMonthDataList.length) {
                    // 月数据模式下，直接显示YYYY-MM格式
                    currentDataDisplay.textContent = efficiencyMonthDataList[currentEfficiencyMonthIndex].displayMonth;
                } else {
                    currentDataDisplay.textContent = '无数据';
                }
            }
        }

        // 更新经营效率分析按钮状态
        function updateEfficiencyButtonStates() {
            const prevBtn = document.getElementById('efficiency-prev-data-btn');
            const nextBtn = document.getElementById('efficiency-next-data-btn');
            
            if (!prevBtn || !nextBtn) return;

            let canGoPrev = false;
            let canGoNext = false;

            if (currentEfficiencyDataMode === 'day') {
                canGoPrev = currentEfficiencyDayIndex > 0;
                canGoNext = currentEfficiencyDayIndex < efficiencyDayDataList.length - 1;
            } else {
                canGoPrev = currentEfficiencyMonthIndex > 0;
                canGoNext = currentEfficiencyMonthIndex < efficiencyMonthDataList.length - 1;
            }

            // 更新上一页按钮状态
            if (canGoPrev) {
                prevBtn.style.background = '#007bff';
                prevBtn.style.cursor = 'pointer';
                prevBtn.disabled = false;
            } else {
                prevBtn.style.background = '#ccc';
                prevBtn.style.cursor = 'not-allowed';
                prevBtn.disabled = true;
            }
            
            // 更新下一页按钮状态
            if (canGoNext) {
                nextBtn.style.background = '#007bff';
                nextBtn.style.cursor = 'pointer';
                nextBtn.disabled = false;
            } else {
                nextBtn.style.background = '#ccc';
                nextBtn.style.cursor = 'not-allowed';
                nextBtn.disabled = true;
            }
        }

        // 更新日期显示
        function updateEfficiencyDateDisplay(data) {
            const currentDateDisplay = document.getElementById('efficiency-date-display');
            if (currentDateDisplay && data) {
                currentDateDisplay.textContent = `当前日期：${data.displayDate}`;
            }
        }

        // 更新经营效率分析显示
        function updateEfficiencyDisplay() {
            if (efficiencyData.length === 0) return;

            let currentData = null;

            if (currentEfficiencyDataMode === 'day') {
                if (efficiencyDayDataList.length > 0 && currentEfficiencyDayIndex < efficiencyDayDataList.length) {
                    currentData = efficiencyDayDataList[currentEfficiencyDayIndex].data;
                }
            } else {
                if (efficiencyMonthDataList.length > 0 && currentEfficiencyMonthIndex < efficiencyMonthDataList.length) {
                    // 月数据模式：计算该月所有日期的平均值
                    const monthData = efficiencyMonthDataList[currentEfficiencyMonthIndex];
                    currentData = calculateEfficiencyMonthAverage(monthData.data);
                }
            }

            if (currentData) {
                // 更新表格数据和雷达图
                updateEfficiencyTable(currentData);
                updateEfficiencyRadarChart(currentData);
            }
        }
        // 计算经营效率月数据平均值
        function calculateEfficiencyMonthAverage(monthDataArray) {
            if (monthDataArray.length === 0) return null;

            // 如果只有一天的数据，直接返回
            if (monthDataArray.length === 1) {
                return monthDataArray[0];
            }

            // 计算平均值
            const averageData = {
                date: monthDataArray[0].date, // 使用第一天的日期作为代表
                displayDate: monthDataArray[0].displayDate,
                sfpData: {
                    duration: 0,
                    utilization: 0,
                    energy: 0,
                    revenue: 0,
                    power: 0,
                    times: 0
                },
                glData: {
                    duration: 0,
                    utilization: 0,
                    energy: 0,
                    revenue: 0,
                    power: 0,
                    times: 0
                }
            };

            // 累加所有数据
            monthDataArray.forEach(dayData => {
                // 四方坪站数据累加
                averageData.sfpData.duration += dayData.sfpData.duration || 0;
                averageData.sfpData.utilization += dayData.sfpData.utilization || 0;
                averageData.sfpData.energy += dayData.sfpData.energy || 0;
                averageData.sfpData.revenue += dayData.sfpData.revenue || 0;
                averageData.sfpData.power += dayData.sfpData.power || 0;
                averageData.sfpData.times += dayData.sfpData.times || 0;

                // 高岭站数据累加
                averageData.glData.duration += dayData.glData.duration || 0;
                averageData.glData.utilization += dayData.glData.utilization || 0;
                averageData.glData.energy += dayData.glData.energy || 0;
                averageData.glData.revenue += dayData.glData.revenue || 0;
                averageData.glData.power += dayData.glData.power || 0;
                averageData.glData.times += dayData.glData.times || 0;
            });

            // 计算平均值（除以天数）
            const dayCount = monthDataArray.length;
            averageData.sfpData.duration /= dayCount;
            averageData.sfpData.utilization /= dayCount;
            averageData.sfpData.energy /= dayCount;
            averageData.sfpData.revenue /= dayCount;
            averageData.sfpData.power /= dayCount;
            averageData.sfpData.times /= dayCount;

            averageData.glData.duration /= dayCount;
            averageData.glData.utilization /= dayCount;
            averageData.glData.energy /= dayCount;
            averageData.glData.revenue /= dayCount;
            averageData.glData.power /= dayCount;
            averageData.glData.times /= dayCount;

            return averageData;
        }

        // 更新经营效率分析表格
        function updateEfficiencyTable(data) {
            if (!data) return;

            // 更新四方坪站数据
            document.getElementById('sifang-duration').textContent = data.sfpData.duration.toFixed(2);
            document.getElementById('sifang-utilization').textContent = (data.sfpData.utilization * 100).toFixed(2) + '%';
            document.getElementById('sifang-energy').textContent = data.sfpData.energy.toFixed(2);
            document.getElementById('sifang-revenue').textContent = data.sfpData.revenue.toFixed(2);
            document.getElementById('sifang-power').textContent = data.sfpData.power.toFixed(2);
            document.getElementById('sifang-times').textContent = data.sfpData.times.toFixed(2);

            // 更新高岭站数据
            document.getElementById('gaoling-duration').textContent = data.glData.duration.toFixed(2);
            document.getElementById('gaoling-utilization').textContent = (data.glData.utilization * 100).toFixed(2) + '%';
            document.getElementById('gaoling-energy').textContent = data.glData.energy.toFixed(2);
            document.getElementById('gaoling-revenue').textContent = data.glData.revenue.toFixed(2);
            document.getElementById('gaoling-power').textContent = data.glData.power.toFixed(2);
            document.getElementById('gaoling-times').textContent = data.glData.times.toFixed(2);
        }
        // 更新经营效率雷达图
        function updateEfficiencyRadarChart(data) {
            const ctx = document.getElementById('efficiency-radar-chart');
            if (!ctx) return;

            // 销毁现有图表
            if (efficiencyRadarChart) {
                efficiencyRadarChart.destroy();
            }

            // 准备雷达图数据
            const labels = [
                '终端日均充电时长',
                '终端日均利用率',
                '终端日均充电电量',
                '终端日均充电收益',
                '平均每小时充电功率',
                '单枪日均充电次数'
            ];

            // 标准化数据用于雷达图显示
            const sfpData = [
                data.sfpData.duration,
                data.sfpData.utilization * 100,
                data.sfpData.energy,
                data.sfpData.revenue,
                data.sfpData.power,
                data.sfpData.times
            ];

            const glData = [
                data.glData.duration,
                data.glData.utilization * 100,
                data.glData.energy,
                data.glData.revenue,
                data.glData.power,
                data.glData.times
            ];

            efficiencyRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '四方坪站',
                            data: sfpData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            borderWidth: 2,
                            pointBackgroundColor: '#007bff',
                            pointBorderColor: '#007bff',
                            pointHoverBackgroundColor: '#007bff',
                            pointHoverBorderColor: '#007bff'
                        },
                        {
                            label: '高岭站',
                            data: glData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            borderWidth: 2,
                            pointBackgroundColor: '#28a745',
                            pointBorderColor: '#28a745',
                            pointHoverBackgroundColor: '#28a745',
                            pointHoverBorderColor: '#28a745'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${currentEfficiencyDataMode === 'day' ? data.displayDate : (efficiencyMonthDataList.length > 0 && currentEfficiencyMonthIndex < efficiencyMonthDataList.length ? efficiencyMonthDataList[currentEfficiencyMonthIndex].displayMonth : data.displayDate)} 经营效率对比分析`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    
                                    // 获取两个站点的原始数据
                                    let sfpValue, glValue;
                                    switch(index) {
                                        case 0: 
                                            sfpValue = data.sfpData.duration.toFixed(2);
                                            glValue = data.glData.duration.toFixed(2);
                                            break;
                                        case 1: 
                                            sfpValue = (data.sfpData.utilization * 100).toFixed(2) + '%';
                                            glValue = (data.glData.utilization * 100).toFixed(2) + '%';
                                            break;
                                        case 2: 
                                            sfpValue = data.sfpData.energy.toFixed(2);
                                            glValue = data.glData.energy.toFixed(2);
                                            break;
                                        case 3: 
                                            sfpValue = data.sfpData.revenue.toFixed(2);
                                            glValue = data.glData.revenue.toFixed(2);
                                            break;
                                        case 4: 
                                            sfpValue = data.sfpData.power.toFixed(2);
                                            glValue = data.glData.power.toFixed(2);
                                            break;
                                        case 5: 
                                            sfpValue = data.sfpData.times.toFixed(2);
                                            glValue = data.glData.times.toFixed(2);
                                            break;
                                    }
                                    
                                    return [
                                        `四方坪站: ${sfpValue}`,
                                        `高岭站: ${glValue}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: {
                                    size: 12
                                }
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    elements: {
                        line: {
                            tension: 0.1
                        }
                    }
                }
            });
        }

        // 启动经营效率自动刷新功能
        function startEfficiencyAutoRefresh() {
            // 清除之前的定时器
            if (efficiencyRefreshInterval) {
                clearInterval(efficiencyRefreshInterval);
            }
            
            // 每5分钟自动刷新数据
            efficiencyRefreshInterval = setInterval(async () => {
                try {
                    await loadEfficiencyData();
                    
                    // 如果当前日期索引超出范围，重置为最大日期
                    if (currentEfficiencyDateIndex >= efficiencyData.length) {
                        currentEfficiencyDateIndex = efficiencyData.length - 1;
                    }
                    
                    // 更新表格数据和雷达图
                    if (efficiencyData.length > 0) {
                        const currentData = efficiencyData[currentEfficiencyDateIndex];
                        updateEfficiencyTable(currentData);
                        updateEfficiencyRadarChart(currentData);
                        updateEfficiencyDateDisplay(currentData);
                    }
                } catch (error) {
                }
            }, 5 * 60 * 1000); // 5分钟
        }

        // 停止经营效率自动刷新
        function stopEfficiencyAutoRefresh() {
            if (efficiencyRefreshInterval) {
                clearInterval(efficiencyRefreshInterval);
                efficiencyRefreshInterval = null;
            }
        }
        // 星空背景动画相关变量
        let starfieldAnimationId = null;
        let starfieldMouseMoveHandler = null;
        let starfieldTouchMoveHandler = null;
        let starfieldResizeHandler = null;

        // 星空背景动画
        function initStarfield() {
            const canvas = document.getElementById('starfield');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let stars = [];
            let mouse = {x: null, y: null, radius: 50};

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            starfieldResizeHandler = resize;
            window.addEventListener('resize', starfieldResizeHandler);
            resize();

            class Star {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.baseSize = Math.random() * 1.5 + 0.3;
                    this.size = this.baseSize;
                    this.vx = (Math.random() - 0.5) * 0.5;
                    this.vy = (Math.random() - 0.5) * 0.5;
                    this.flickerSpeed = Math.random() * 0.05 + 0.01;
                    this.angle = Math.random() * Math.PI * 2;
                    // 随机冷暖色调（微蓝/微黄）
                    const colors = ['rgba(200,220,255,', 'rgba(255,245,200,'];
                    this.baseColor = colors[Math.floor(Math.random() * colors.length)];
                }

                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = this.baseColor + (0.7 + 0.3 * Math.sin(this.angle)) + ')';
                    ctx.fill();
                }

                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.vy *= -1;

                    const dx = mouse.x - this.x;
                    const dy = mouse.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < mouse.radius) {
                        this.x -= dx / 15;
                        this.y -= dy / 15;
                    }

                    // 星星闪烁效果
                    this.angle += this.flickerSpeed;
                    this.size = this.baseSize + Math.sin(this.angle) * 0.3;

                    this.draw();
                }
            }

            function init() {
                stars = [];
                // 在原有基础上将星星数量减少一半，降低首屏渲染压力
                var starCount = 100; // 原为 200
                if (window.innerWidth < 600) {
                    starCount = 25; // 原为 50
                }
                for (let i = 0; i < starCount; i++) {
                    stars.push(new Star());
                }
            }

            function connect() {
                // 为每颗星限制最多连线数量，将整体连线数量减少到原来的约 1/3
                const maxConnectionsPerStar = 3;
                const maxDistance = 100;
                for (let a = 0; a < stars.length; a++) {
                    let connections = 0;
                    for (let b = a + 1; b < stars.length && connections < maxConnectionsPerStar; b++) {
                        const dx = stars[a].x - stars[b].x;
                        const dy = stars[a].y - stars[b].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < maxDistance) {
                            ctx.strokeStyle = 'rgba(255,255,255,0.15)';
                            ctx.lineWidth = 0.5;
                            ctx.beginPath();
                            ctx.moveTo(stars[a].x, stars[a].y);
                            ctx.lineTo(stars[b].x, stars[b].y);
                            ctx.stroke();
                            connections++;
                        }
                    }
                }
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let star of stars) {
                    star.update();
                }
                connect();
                starfieldAnimationId = requestAnimationFrame(animate);
            }

            starfieldMouseMoveHandler = (e) => {
                mouse.x = e.x;
                mouse.y = e.y;
            };
            window.addEventListener('mousemove', starfieldMouseMoveHandler);
            
            // 移动端触控支持
            starfieldTouchMoveHandler = (e) => {
                const touch = e.touches[0];
                mouse.x = touch.clientX;
                mouse.y = touch.clientY;
            };
            window.addEventListener('touchmove', starfieldTouchMoveHandler);
            
            init();
            animate();
        }

        // 停止星空背景动画（彻底销毁Canvas实例和requestAnimationFrame循环）
        function stopStarfield() {
            // 取消动画循环
            if (starfieldAnimationId !== null) {
                cancelAnimationFrame(starfieldAnimationId);
                starfieldAnimationId = null;
            }
            
            // 移除事件监听器
            if (starfieldMouseMoveHandler) {
                window.removeEventListener('mousemove', starfieldMouseMoveHandler);
                starfieldMouseMoveHandler = null;
            }
            
            if (starfieldTouchMoveHandler) {
                window.removeEventListener('touchmove', starfieldTouchMoveHandler);
                starfieldTouchMoveHandler = null;
            }
            
            if (starfieldResizeHandler) {
                window.removeEventListener('resize', starfieldResizeHandler);
                starfieldResizeHandler = null;
            }
            
            // 彻底清空画布并销毁Canvas实例
            const canvas = document.getElementById('starfield');
            if (canvas) {
                try {
                const ctx = canvas.getContext('2d');
                    if (ctx) {
                        // 清空画布内容
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                        // 尝试释放Canvas上下文（如果浏览器支持）
                        if (ctx.canvas) {
                            ctx.canvas.width = 0;
                            ctx.canvas.height = 0;
                        }
                    }
                    // 清空Canvas的HTML内容（如果有）
                    canvas.innerHTML = '';
                } catch (e) {
                    // 忽略错误，确保继续执行
                }
            }
        }

        // 左侧"数据查询"二级菜单与"平台首页"点击逻辑：显示/隐藏空白覆盖页
        (function() {
            function setupDataQueryPages() {
                var btnCd = document.getElementById('menu-cd-data');
                var btnZh = document.getElementById('menu-zh-data');
                var btnBill = document.getElementById('menu-bill-data');
                var btnUserData = document.getElementById('menu-user-data');
                var btnOtherData = document.getElementById('menu-other-data');
                var btnHome = document.getElementById('menu-home');
                var pageCd = document.getElementById('page-cd-data');
                var pageZh = document.getElementById('page-zh-data');
                var pageBill = document.getElementById('page-bill-data');
                var pageUserData = document.getElementById('page-user-data');
                var pageOtherData = document.getElementById('page-other-data');
                var breadcrumbLeaf = document.getElementById('breadcrumb-leaf');

                // 报表查询菜单按钮
                var btnReportCharging = document.getElementById('menu-report-charging');
                var btnReportComprehensive = document.getElementById('menu-report-comprehensive');
                var btnReportUser = document.getElementById('menu-report-user');
                var btnReportEfficiency = document.getElementById('menu-report-efficiency');
                var btnReportBI = document.getElementById('menu-report-bi');
                var pageReportCharging = document.getElementById('page-report-charging');
                var pageReportComprehensive = document.getElementById('page-report-comprehensive');
                var pageReportUser = document.getElementById('page-report-user');
                var pageReportEfficiency = document.getElementById('page-report-efficiency');
                var pageReportBI = document.getElementById('page-report-bi');
                var pageAIModel = document.getElementById('page-ai-model');

                if (!btnCd || !btnZh || !btnHome || !pageCd || !pageZh) return;

                function hideAllPages() {
                    pageCd.style.display = 'none';
                    pageZh.style.display = 'none';
                    if (pageBill) pageBill.style.display = 'none';
                    if (pageUserData) pageUserData.style.display = 'none';
                    if (pageOtherData) pageOtherData.style.display = 'none';
                    if (pageReportCharging) pageReportCharging.style.display = 'none';
                    if (pageReportComprehensive) pageReportComprehensive.style.display = 'none';
                    if (pageReportUser) pageReportUser.style.display = 'none';
                    if (pageReportEfficiency) pageReportEfficiency.style.display = 'none';
                    if (pageReportBI) pageReportBI.style.display = 'none';
                    if (pageAIModel) pageAIModel.style.display = 'none';
                }

                function showCd() {
                    hideAllPages();
                    pageCd.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                    // 初始化充电平台选项显示
                    if (typeof onStationChange === 'function') {
                        onStationChange();
                    }
                }

                function showZh() {
                    hideAllPages();
                    pageZh.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                    // 初始化综合数据页面的日期选择器
                    if (typeof initZhDatetimePickers === 'function') {
                        initZhDatetimePickers();
                    }
                }

                function showBill() {
                    hideAllPages();
                    if (pageBill) pageBill.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                }

                function showUserData() {
                    hideAllPages();
                    if (pageUserData) pageUserData.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                    // 初始化用户数据页面的日期选择器
                    if (typeof initUserDatetimePickers === 'function') {
                        initUserDatetimePickers();
                    }
                }

                function showOtherData() {
                    hideAllPages();
                    if (pageOtherData) pageOtherData.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                    // 初始化其它数据页面的日期选择器
                    if (typeof initOtherDatetimePickers === 'function') {
                        initOtherDatetimePickers();
                    }
                    // 初始化电站选择显示
                    if (typeof onOtherStationChange === 'function') {
                        onOtherStationChange();
                    }
                }

                function showReportCharging() {
                    hideAllPages();
                    if (pageReportCharging) {
                        pageReportCharging.style.display = 'block';
                        // 初始化站点选择器显示
                        setTimeout(() => {
                            if (typeof updateStationSelection === 'function') {
                                updateStationSelection();
                            }
                        }, 100);
                    }
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                }

                function showReportComprehensive() {
                    hideAllPages();
                    if (pageReportComprehensive) pageReportComprehensive.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                }

                function showReportUser() {
                    hideAllPages();
                    if (pageReportUser) pageReportUser.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                }

                function showReportEfficiency() {
                    hideAllPages();
                    if (pageReportEfficiency) pageReportEfficiency.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                }

                function showReportBI() {
                    hideAllPages();
                    if (pageReportBI) {
                        pageReportBI.style.display = 'block';
                        // 初始化BI页面的日期选择器
                        if (typeof initBIDatetimePickers === 'function') {
                            initBIDatetimePickers();
                        }
                    }
                    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
                }

                function showHome() {
                    hideAllPages();
                }

                btnCd.addEventListener('click', function(e) { e.preventDefault(); if (breadcrumbLeaf) breadcrumbLeaf.textContent = '充电数据'; showCd(); });
                btnZh.addEventListener('click', function(e) { 
                    e.preventDefault(); 
                    const breadcrumbLeafZh = document.getElementById('breadcrumb-leaf-zh');
                    if (breadcrumbLeafZh) breadcrumbLeafZh.textContent = '综合数据';
                    showZh(); 
                });
                if (btnBill) {
                    btnBill.addEventListener('click', function(e) { e.preventDefault(); showBill(); });
                }
                if (btnUserData) {
                    btnUserData.addEventListener('click', function(e) { e.preventDefault(); showUserData(); });
                }
                if (btnOtherData) {
                    btnOtherData.addEventListener('click', function(e) { e.preventDefault(); showOtherData(); });
                }
                if (btnReportCharging) {
                    btnReportCharging.addEventListener('click', function(e) { e.preventDefault(); showReportCharging(); });
                }
                if (btnReportComprehensive) {
                    btnReportComprehensive.addEventListener('click', function(e) { e.preventDefault(); showReportComprehensive(); });
                }
                if (btnReportUser) {
                    btnReportUser.addEventListener('click', function(e) { e.preventDefault(); showReportUser(); });
                }
                if (btnReportEfficiency) {
                    btnReportEfficiency.addEventListener('click', function(e) { e.preventDefault(); showReportEfficiency(); });
                }
                if (btnReportBI) {
                    btnReportBI.addEventListener('click', function(e) { e.preventDefault(); showReportBI(); });
                }
                btnHome.addEventListener('click', function() { showHome(); });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupDataQueryPages);
            } else {
                setupDataQueryPages();
            }
        })();

        // SQL Server数据库连接和查询功能
        // 数据库连接配置（从LeanCloud环境变量获取）
        const DB_CONFIG = {
            server: 'csfhcdz.f3322.net',
            port: 1433,
            user: 'csfh',
            password: 'fh123456',
            database: 'chargingdata',
            options: {
                encrypt: false, // 根据服务器配置调整
                trustServerCertificate: true // 仅用于开发环境
            }
        };

        // 更新连接状态显示
        function updateConnectionStatus(status, message) {
            const statusText = document.getElementById('status-text');
            if (status === 'connected') {
                statusText.textContent = '已连接 - ' + message;
                statusText.style.color = 'green';
            } else if (status === 'connecting') {
                statusText.textContent = '连接中...';
                statusText.style.color = 'orange';
            } else {
                statusText.textContent = '连接失败 - ' + message;
                statusText.style.color = 'red';
            }
        }
        // 执行SQL查询
        function executeSQLQuery() {
            const queryInput = document.getElementById('sql-query-input');
            const query = queryInput.value.trim();
            
            if (!query) {
                alert('请输入SQL查询语句');
                return;
            }
            

            
            const resultContent = document.getElementById('query-result-content');
            resultContent.innerHTML = '<p>正在执行查询...</p>';
            
            // 使用fetch直接调用SQL Server应用的云函数
            const queryOptions = {
                method: 'POST',
                headers: {
                    'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                    'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            };
            
            fetch('https://1257663610-833b483ie5.ap-guangzhou.tencentscf.com', queryOptions)
                .then(response => {
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response.json();
                })
                .then(function(result) {
                    
                    // 优先检查result.result字段（LeanCloud云函数的标准返回格式）
                    if (result.result && typeof result.result === 'object' && result.result.success !== undefined) {
                        
                        if (result.result.success) {
                            displayQueryResult(result.result);
                        } else {
                            resultContent.innerHTML = `
                                <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                                    <h4>查询失败</h4>
                                    <p>${result.result.message || '未知错误'}</p>
                                </div>
                            `;
                        }
                        return;
                    }
                    
                    // 如果result.result是字符串，尝试解析
                    if (result.result && typeof result.result === 'string') {
                        try {
                            const parsedResult = JSON.parse(result.result);
                            if (parsedResult.success !== undefined) {
                                if (parsedResult.success) {
                                    displayQueryResult(parsedResult);
                                } else {
                                    resultContent.innerHTML = `
                                        <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                                            <h4>查询失败</h4>
                                            <p>${parsedResult.message || '未知错误'}</p>
                                        </div>
                                    `;
                                }
                                return;
                            }
                        } catch (e) {
                        }
                    }
                    
                    // 检查直接返回的success字段
                    if (result.success !== undefined) {
                    if (result.success) {
                        displayQueryResult(result);
                    } else {
                        resultContent.innerHTML = `
                            <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                                <h4>查询失败</h4>
                                <p>${result.message || '未知错误'}</p>
                            </div>
                        `;
                        }
                    } else {
                        resultContent.innerHTML = `
                            <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                                <h4>查询失败</h4>
                                <p>云函数没有返回success字段</p>
                            </div>
                        `;
                    }
                })
                .catch(function(error) {
                    
                    resultContent.innerHTML = `
                        <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                            <h4>查询失败</h4>
                            <p>错误代码: ${error.code || 'N/A'}</p>
                            <p>错误信息: ${error.message || '未知错误'}</p>
                        </div>
                    `;
                });
        }

        // 用户查询功能：根据车牌号查询手机号
        function runUserQuery() {
            const plateInput = document.getElementById('user-query-plate');
            const plateNumber = plateInput ? plateInput.value.trim() : '';
            const resultContent = document.getElementById('user-report-query-result-content');

            if (!plateNumber) {
                alert('请输入车牌号');
                return;
            }

            if (!resultContent) {
                alert('查询结果容器不存在');
                return;
            }

            resultContent.innerHTML = '<div style="text-align: center; padding: 40px;"><p>正在查询...</p></div>';

            // 构建SQL查询
            // 修改后的查询逻辑：
            // 1. 先根据车牌号在"判定车牌号"列中匹配
            // 2. 然后在匹配的记录中，同时在"车辆所属客户"列和"手机号"列中查询，获取所有唯一的手机号码
            // 3. 将查询结果按唯一的手机号码分组，根据"充电结束时间"最大的记录来显示
            // 支持模糊匹配，去除空格后进行匹配
            // 注意：使用REPLACE来转义单引号，防止SQL注入
            const escapedPlateNumber = plateNumber.replace(/'/g, "''").replace(/\s/g, '');
            const sqlQuery = `
                SELECT TOP 100
                    t.[判定车牌号] AS [车牌号],
                    t.[手机号码],
                    t.[充电结束时间] AS [最近一次活跃时间]
                FROM (
                    SELECT 
                        [判定车牌号],
                        [手机号码],
                        [充电结束时间],
                        ROW_NUMBER() OVER (
                            PARTITION BY [手机号码]
                            ORDER BY [充电结束时间] DESC
                        ) AS rn
                    FROM (
                        SELECT 
                            [判定车牌号],
                            LTRIM(RTRIM([车辆所属客户])) AS [手机号码],
                            [充电结束时间]
                        FROM [特来电]
                        WHERE REPLACE([判定车牌号], ' ', '') COLLATE Chinese_PRC_CI_AS LIKE '%${escapedPlateNumber}%'
                            AND [车辆所属客户] IS NOT NULL 
                            AND LTRIM(RTRIM([车辆所属客户])) != ''
                        UNION ALL
                        SELECT 
                            [判定车牌号],
                            LTRIM(RTRIM([手机号])) AS [手机号码],
                            [充电结束时间]
                        FROM [特来电]
                        WHERE REPLACE([判定车牌号], ' ', '') COLLATE Chinese_PRC_CI_AS LIKE '%${escapedPlateNumber}%'
                            AND [手机号] IS NOT NULL 
                            AND LTRIM(RTRIM([手机号])) != ''
                    ) combined
                ) t
                WHERE t.rn = 1
                ORDER BY t.[充电结束时间] DESC
            `;
            
            // 使用带重试的查询函数来处理偶发的503错误
            // 注意：云函数应该已经配置为连接到XTZJ-20220408GR\SQLEXPRESS服务器的chargingdata数据库
            callSqlWithRetry(sqlQuery)
                .then(function(result) {
                    // 处理返回结果
                    console.log('用户查询原始返回结果:', result);
                    let queryResult = null;

                    // callSqlWithRetry 已经处理了 result.result 的提取
                    if (result && typeof result === 'object' && result.success !== undefined) {
                        queryResult = result;
                    } else if (result && result.result && typeof result.result === 'object' && result.result.success !== undefined) {
                        queryResult = result.result;
                    } else if (result && result.result && typeof result.result === 'string') {
                        try {
                            queryResult = JSON.parse(result.result);
                        } catch (e) {
                            queryResult = result;
                        }
                    } else {
                        queryResult = result;
                    }

                    console.log('用户查询解析后结果:', queryResult);

                    if (queryResult && queryResult.success) {
                        const data = queryResult.data || queryResult.rows || queryResult.results || [];
                        console.log('用户查询数据行数:', data.length);
                        console.log('用户查询数据:', data);

                        if (!data || data.length === 0) {
                            resultContent.innerHTML = `
                                <div style="background-color: #fff3cd; border: 1px solid #ffc107; padding: 20px; border-radius: 6px; text-align: center; color: #856404;">
                                    <h4 style="margin: 0 0 10px 0;">无此车牌号记录</h4>
                                    <p style="margin: 0;">未找到匹配的车牌号：${plateNumber}</p>
                                    <p style="margin-top: 10px; font-size: 12px;">调试信息：查询成功但返回0条记录</p>
                                </div>
                            `;
                            return;
                        }
                        
                        // 显示查询结果表格
                        let tableHTML = `
                            <div style="background: white; border-radius: 6px; overflow: hidden;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">车牌号</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">手机号码</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600; color: #495057;">最近一次活跃时间</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        data.forEach((row, index) => {
                            const bgColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                            const plateNumber = row['车牌号'] || row['PlateNumber'] || '';
                            const phoneNumber = row['手机号码'] || row['PhoneNumber'] || '';
                            const lastActiveTime = row['最近一次活跃时间'] || row['LastActiveTime'] || '';
                            
                            tableHTML += `
                                <tr style="background: ${bgColor};">
                                    <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">${escapeHtml(plateNumber)}</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">${escapeHtml(phoneNumber)}</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">${escapeHtml(formatDateTime(lastActiveTime))}</td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += `
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top: 15px; padding: 10px; background: #e7f3ff; border-radius: 6px; color: #004085; font-size: 14px;">
                                <strong>查询结果：</strong>共找到 ${data.length} 条记录
                            </div>
                        `;
                        
                        resultContent.innerHTML = tableHTML;
                    } else {
                        resultContent.innerHTML = `
                            <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                                <h4>查询失败</h4>
                                <p>${queryResult ? (queryResult.message || '未知错误') : '查询返回了意外的结果格式'}</p>
                            </div>
                        `;
                    }
                })
                .catch(function(error) {
                    console.error('用户查询错误:', error);
                    let errorMsg = error.message || '未知错误';
                    if (error.httpStatus) {
                        errorMsg = `HTTP ${error.httpStatus}: ${errorMsg}`;
                    }
                    resultContent.innerHTML = `
                        <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 4px; color: #721c24;">
                            <h4>查询失败</h4>
                            <p>错误信息: ${errorMsg}</p>
                            <p style="margin-top: 10px; font-size: 12px; color: #856404;">提示：如果遇到503错误，系统已自动重试，请稍后再试或检查网络连接。</p>
                        </div>
                    `;
                });
        }
        
        // 辅助函数：转义HTML
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 辅助函数：格式化日期时间
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            try {
                const date = new Date(dateTimeStr);
                if (isNaN(date.getTime())) return dateTimeStr;
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (e) {
                return dateTimeStr;
            }
        }

        // 更新当前条件显示
        function updateCurrentConditions() {
            const conditionsText = document.getElementById('current-conditions-text');
            if (!conditionsText) return;
            
            try {
                // 获取充电平台（多选）
                const devices = getSelectedDevices();
                if (devices.length === 0) {
                    conditionsText.textContent = '请选择充电平台';
                    return;
                }
                const deviceText = devices.join('、');
                
                // 获取站点信息
                const allBox = document.getElementById('station-all');
                const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
                const stationMapToLabel = { 
                    east: '长沙飞狐四方坪东区站', 
                    west: '长沙飞狐四方坪西区站', 
                    south: '长沙飞狐四方坪南区站', 
                    gaoling: '长沙飞狐高岭站' 
                };
                
                let stationText = '';
                if (allBox && allBox.checked) {
                    // 全选：显示所有站点名称
                    stationText = '长沙飞狐四方坪东区站、长沙飞狐四方坪西区站、长沙飞狐四方坪南区站、长沙飞狐高岭站';
                } else {
                    // 显示选中的站点
                    const checked = items.filter(i => i.checked).map(i => i.getAttribute('data-group'));
                    if (checked.length === 0) {
                        stationText = '未选择';
                    } else {
                        stationText = checked.map(k => stationMapToLabel[k] || k).join('、');
                    }
                }
                
                // 获取查询充电时间（充电开始时间或充电结束时间）
                const timeField = (document.getElementById('time-field-select') || {}).value || '充电结束时间';
                
                // 获取时间范围
                const startEl = document.getElementById('start-datetime');
                const endEl = document.getElementById('end-datetime');
                const startTime = (startEl && startEl.value) ? startEl.value.trim() : '';
                const endTime = (endEl && endEl.value) ? endEl.value.trim() : '';
                
                // 构建条件文本（站点在前，充电平台在后，与页面布局顺序一致）
                const conditions = [
                    `站点：${stationText}`,
                    `充电平台：${deviceText}`,
                    `查询充电时间：${timeField}`,
                    startTime ? `充电开始时间：${startTime}` : '',
                    endTime ? `充电结束时间：${endTime}` : ''
                ].filter(c => c).join('；');
                
                conditionsText.textContent = conditions;
            } catch (err) {
                conditionsText.textContent = '获取查询条件失败';
            }
        }

        // 仅更新统计区域（不重新渲染表格数据）
        function updateStatsOnly() {
            const statsContainer = document.getElementById('stats-container');
            if (!statsContainer) return;

            const hasFullStats = (__statsTotals !== null && __statsTotals !== undefined);
            const isNK = (__currentDevice === '能科');
            const isDiDi = (__currentDevice === '滴滴');
            
            let total, totalElectricityFee, totalServiceFee, totalChargingFee, totalElectricity, totalDuration;
            
            if (hasFullStats) {
                total = __statsTotals.total || 0;
                totalElectricityFee = __statsTotals.electricityFee || 0;
                totalServiceFee = __statsTotals.serviceFee || 0;
                totalChargingFee = __statsTotals.chargingFee || 0;
                totalElectricity = __statsTotals.electricity || 0;
                totalDuration = __statsTotals.duration || 0;
            } else {
                total = null;
                totalElectricityFee = null;
                totalServiceFee = null;
                totalChargingFee = null;
                totalElectricity = null;
                totalDuration = null;
            }
            
            const statsLoadingMsg = '<span style="color:#ff9800;"><i class="fas fa-spinner fa-spin"></i> 统计计算中...</span>';
            
            statsContainer.innerHTML = `
                <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 12px 0; color: #495057;">查询统计 ${!hasFullStats ? '<span style="font-size:14px; color:#ff9800; font-weight:normal;">(全量数据统计中，请稍候...)</span>' : '<span style="font-size:14px; color:#28a745; font-weight:normal;">✓</span>'}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">总计</div>
                            <div style="font-size: 18px; font-weight: 600; color: #495057;">${total !== null ? total + ' 条' : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isDiDi ? '充电电费' : (isNK ? '电费' : '充电电费')}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #28a745;">${totalElectricityFee !== null ? '¥' + Number(totalElectricityFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isDiDi ? '充电服务费' : (isNK ? '服务费' : '充电服务费')}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #17a2b8;">${totalServiceFee !== null ? '¥' + Number(totalServiceFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isDiDi ? '订单总额' : (isNK ? '消费金额' : '充电收入')}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #dc3545;">${totalChargingFee !== null ? '¥' + Number(totalChargingFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isDiDi ? '充电量' : (isNK ? '充电量' : '充电电量')}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #6f42c1;">${totalElectricity !== null ? Number(totalElectricity).toFixed(2) + (isDiDi ? ' 度' : (isNK ? '' : ' 度')) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '充电时长' : '充电时长'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #fd7e14;">${totalDuration !== null ? Number(totalDuration).toFixed(0) + ' 分钟' : statsLoadingMsg}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 显示查询结果（4.jpg样式 + 统计信息）
        function displayQueryResult(result) {
            const resultContent = document.getElementById('query-result-content');
            
            // 如果是多设备查询（合并查询），不执行此函数（由多设备查询函数处理）
            if (__currentDevice === '合并' || (__pagination && __pagination.queries && __pagination.queries.length > 1)) {
                return;
            }
            
            if (!result.results || result.results.length === 0) {
                resultContent.innerHTML = `
                    <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 4px; color: #0c5460;">
                        <h4>查询成功</h4>
                        <p>查询语句: ${result.query}</p>
                        <p>结果: 无任何数据可查询</p>
                    </div>
                `;
                return;
            }
            
            const data = result.results;
            
            // 判断是否有全量统计数据
            const hasFullStats = (__statsTotals !== null && __statsTotals !== undefined);
            const isNK = (__currentDevice === '能科');
            const isDiDi = (__currentDevice === '滴滴');
            
            // 统计数据：优先使用全量统计，如果正在计算中则不显示fallback数据
            let total, totalElectricityFee, totalServiceFee, totalChargingFee, totalElectricity, totalDuration;
            
            if (hasFullStats) {
                // 使用全量统计数据
                total = __statsTotals.total || 0;
                totalElectricityFee = __statsTotals.electricityFee || 0;
                totalServiceFee = __statsTotals.serviceFee || 0;
                totalChargingFee = __statsTotals.chargingFee || 0;
                totalElectricity = __statsTotals.electricity || 0;
                totalDuration = __statsTotals.duration || 0;
                } else {
                // 统计数据正在计算中，设置为null表示"计算中"
                total = null;
                totalElectricityFee = null;
                totalServiceFee = null;
                totalChargingFee = null;
                totalElectricity = null;
                totalDuration = null;
            }
            
            // 构建统计信息显示（使用独立容器）
            const statsLoadingMsg = '<span style="color:#ff9800;"><i class="fas fa-spinner fa-spin"></i> 统计计算中...</span>';
            
            const statsHTML = `
                <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 12px 0; color: #495057;">查询统计 ${!hasFullStats ? '<span style="font-size:14px; color:#ff9800; font-weight:normal;">(全量数据统计中，请稍候...)</span>' : '<span style="font-size:14px; color:#28a745; font-weight:normal;">✓</span>'}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">总计</div>
                            <div style="font-size: 18px; font-weight: 600; color: #495057;">${total !== null ? total + ' 条' : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isDiDi ? '充电电费' : (isNK ? '电费' : '充电电费')}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #28a745;">${totalElectricityFee !== null ? '¥' + Number(totalElectricityFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isDiDi ? '充电服务费' : (isNK ? '服务费' : '充电服务费')}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #17a2b8;">${totalServiceFee !== null ? '¥' + Number(totalServiceFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isDiDi ? '订单总额' : (isNK ? '消费金额' : '充电收入')}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #dc3545;">${totalChargingFee !== null ? '¥' + Number(totalChargingFee).toFixed(2) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isDiDi ? '充电量' : (isNK ? '充电量' : '充电电量')}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #6f42c1;">${totalElectricity !== null ? Number(totalElectricity).toFixed(2) + (isDiDi ? ' 度' : (isNK ? '' : ' 度')) : statsLoadingMsg}</div>
                        </div>
                        <div style="background: #fff; padding: 12px; border-radius: 4px; border: 1px solid #e9ecef;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 4px;">${isNK ? '充电时长' : '充电时长'}</div>
                            <div style="font-size: 18px; font-weight: 600; color: #fd7e14;">${totalDuration !== null ? Number(totalDuration).toFixed(0) + ' 分钟' : statsLoadingMsg}</div>
                        </div>
                    </div>
                </div>
            `;
            
            let tableHTML = `
                <div id="stats-container">${statsHTML}</div>
                <div style="overflow-x: auto; height: 100%;">
                    <table style="width: 100%; border-collapse: collapse; margin: 0; min-width: 1200px;">
                        <thead>
                            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
            `;
            
            // 仅显示固定的13列
            const __cols = (__currentDisplayColumns && __currentDisplayColumns.length) ? __currentDisplayColumns : DISPLAY_COLUMNS;
            __cols.forEach(col => {
                tableHTML += `<th style="border: 1px solid #dee2e6; padding: 12px 8px; text-align: left; font-weight: 600; color: #495057; white-space: nowrap; min-width: 120px;">${col}</th>`;
            });
            tableHTML += `</tr></thead><tbody>`;
            
            // 数据行（只渲染13列，字段名容错映射）
            data.forEach((row, index) => {
                const rowClass = index % 2 === 0 ? 'background-color: #fff;' : 'background-color: #f8f9fa;';
                tableHTML += `<tr style="${rowClass}">`;
                __cols.forEach(col => {
                    let value = '';
                    if (__currentDevice === '能科') {
                        const map = {
                            '卡号': ['卡号','卡号：'],
                            '充电桩名称': ['充电桩名称','终端名称'],
                            '开始日期时间': ['开始日期时间','充电开始时间'],
                            '结束日期时间': ['结束日期时间','充电结束时间'],
                            '充电量': ['充电量','充电电量(度)'],
                            '电费': ['电费','充电电费(元)'],
                            '服务费': ['服务费','充电服务费(元)'],
                            '消费金额': ['消费金额','充电费用(元)'],
                            '充电时长': ['充电时长','充电时长(分钟)'],
                            '开始SOC': ['开始SOC','充电前soc','充电前SOC','起始SOC'],
                            '结束SOC': ['结束SOC','充电后soc','充电后SOC','终止SOC'],
                            '车牌号': ['车牌号','判定车牌号'],
                            '持卡人': ['持卡人','车辆所属客户']
                        };
                        const candidates = map[col] || [col];
                        value = getFirstDefined(row, candidates);

                        // 如果是充电时长列，需要格式化显示
                        if (col === '充电时长' && value) {
                            value = formatDuration(value);
                        }
                    } else if (__currentDevice === '滴滴') {
                        // 滴滴平台字段直接映射（SQL查询已返回正确的列名）
                        value = (row[col] !== null && row[col] !== undefined && row[col] !== 'NULL') ? row[col] : '';
                    } else {
                    if (col === '充电前soc') {
                        value = getFirstDefined(row, ['充电前soc', '充电前SOC', '充电前Soc', '开始SOC', '起始SOC']);
                    } else if (col === '充电后soc') {
                        value = getFirstDefined(row, ['充电后soc', '充电后SOC', '充电后Soc', '结束SOC', '终止SOC']);
                    } else {
                        value = (row[col] !== null && row[col] !== undefined && row[col] !== 'NULL') ? row[col] : '';
                        }
                    }
                    tableHTML += `<td style="border: 1px solid #dee2e6; padding: 12px 8px; color: #495057; white-space: nowrap; min-width: 120px;">${value}</td>`;
                });
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            resultContent.innerHTML = tableHTML;
        }

        // 清空查询结果
        function clearQueryResult() {
            document.getElementById('sql-query-input').value = '';
            const resultContent = $('query-result-content');
            if (resultContent) resultContent.innerHTML = '<p>执行查询后结果将显示在这里</p>';
        }

        // 显示列（仅用于页面展示用的13列，不影响导出）
        const DISPLAY_COLUMNS = [
            '电站名称', '终端名称', '充电开始时间', '充电结束时间', '充电电量(度)',
            '充电电费(元)', '充电服务费(元)', '充电费用(元)', '充电时长(分钟)',
            '充电前soc', '充电后soc', '判定车牌号', '车辆所属客户'
        ];
        // 滴滴平台显示列（13列）
        const DIDI_DISPLAY_COLUMNS = [
            '订单ID', '用户类型', '场站名称', '充电桩ID', '充电枪ID', '开始充电时间',
            '充电完成时间', '充电时长（分钟）', '充电量（度）', '订单总额（元）',
            '充电电费（元）', '充电服务费（元）', '车牌号'
        ];
        let __currentDisplayColumns = DISPLAY_COLUMNS.slice();
        // 统计总计（跨全量数据，而非当前页）
        let __statsTotals = {
            total: 0,
            electricityFee: 0,
            serviceFee: 0,
            chargingFee: 0,
            electricity: 0,
            duration: 0
        };
        let __currentDevice = '特来电';

        function getFirstDefined(row, keys) {
            for (let i = 0; i < keys.length; i++) {
                const k = keys[i];
                if (row.hasOwnProperty(k) && row[k] !== null && row[k] !== undefined && row[k] !== 'NULL') {
                    return row[k];
                }
            }
            return '';
        }

        // 格式化充电时长（能科数据需要从ISO格式或hh;mm;ss转为hh:mm:ss）
        function formatDuration(t) {
            if (!t) return '';
            const str = String(t).trim();
            
            // 如果是ISO日期格式（如 1970-01-01T00:11:16.000Z），提取时间部分并格式化为hh:mm:ss
            if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(str)) {
                const timeMatch = str.match(/T(\d{2}):(\d{2}):(\d{2})/);
                if (timeMatch) {
                    return `${timeMatch[1]}:${timeMatch[2]}:${timeMatch[3]}`;
                }
            }
            
            // 如果已经是hh:mm:ss或hh;mm;ss格式，统一转为hh:mm:ss
            const parts = str.split(/[:;]/);
            if (parts.length === 3) {
                return `${parts[0]}:${parts[1]}:${parts[2]}`;
            }
            
            // 如果都不匹配，返回原值
            return str;
        }

        // 特来电全选 + 时间跨度大：使用时间段分段 + 逐个站点查询统计
        async function aggregateTeldByStationsWithTimeSegments() {
            try {
                const tableName = __pagination.tableName || '[特来电]';
                const timeField = __pagination.timeField || '充电结束时间';
                const startEl = document.getElementById('start-datetime');
                const endEl = document.getElementById('end-datetime');
                
                if (!startEl || !endEl || !startEl.value || !endEl.value) {
                    throw new Error('时间范围未设置');
                }
                
                const startDate = new Date(startEl.value);
                const endDate = new Date(endEl.value);
                
                // 每30天为一个时间段
                const segmentDays = 30;
                const segments = [];
                let currentStart = new Date(startDate);
                
                while (currentStart <= endDate) {
                    let currentEnd = new Date(currentStart);
                    currentEnd.setDate(currentEnd.getDate() + segmentDays - 1);
                    if (currentEnd > endDate) {
                        currentEnd = new Date(endDate);
                    }
                    segments.push({
                        start: new Date(currentStart),
                        end: new Date(currentEnd)
                    });
                    currentStart.setDate(currentStart.getDate() + segmentDays);
                }
                
                
                // 获取需要查询的站点组（全选：所有4个站点组）
                const stationGroups = ['east', 'west', 'south', 'gaoling'];
                
                let totalCount = 0;
                let sumFeeElec = 0, sumServiceFee = 0, sumTotalFee = 0, sumKwh = 0, sumMinutes = 0;
                
                // 按时间段串行查询，每个时间段内按站点串行查询
                for (let segIdx = 0; segIdx < segments.length; segIdx++) {
                    const seg = segments[segIdx];
                    const segStart = toSqlDateTime(seg.start.toISOString().slice(0, 19).replace('T', ' '), false);
                    const segEnd = toSqlDateTime(seg.end.toISOString().slice(0, 19).replace('T', ' '), true);
                    
                    
                    // 在该时间段内，逐个站点组查询
                    for (const group of stationGroups) {
                        // 构建该站点组在该时间段的WHERE条件（使用新的逻辑）
                        const stationCondition = buildTeldStationCondition([group]);
                        if (!stationCondition) continue;
                        
                        const whereClause = `WHERE ${stationCondition} AND [${timeField}] BETWEEN '${segStart}' AND '${segEnd}'`;
                        
                        // 查询该站点组在该时间段的统计数据
                        const statsSql = `SELECT 
                            COUNT(1) AS total,
                            SUM(CAST([充电电费(元)] AS DECIMAL(18,4))) AS fee_elec,
                            SUM(CAST([充电服务费(元)] AS DECIMAL(18,4))) AS fee_service,
                            SUM(CAST([充电费用(元)] AS DECIMAL(18,4))) AS fee_total,
                            SUM(CAST([充电电量(度)] AS DECIMAL(18,4))) AS kwh_total,
                            SUM(CAST([充电时长(分钟)] AS DECIMAL(18,4))) AS minutes_total
                            FROM ${tableName} ${whereClause}`;
                        
                        try {
                            const res = await callSqlWithRetry(statsSql, 3, 800);
                            const row = (res && res.results && res.results[0]) || {};
                            
                            // 累加统计结果
                            totalCount += Number(row.total) || 0;
                            sumFeeElec += Number(row.fee_elec) || 0;
                            sumServiceFee += Number(row.fee_service) || 0;
                            sumTotalFee += Number(row.fee_total) || 0;
                            sumKwh += Number(row.kwh_total) || 0;
                            sumMinutes += Number(row.minutes_total) || 0;
                            
                                                    } catch (err) {
                            // 某个站点查询失败时继续查询其他站点
                        }
                    }
                }
                
                // 更新分页总数
                if (__pagination.total === 0 && totalCount > 0) {
                    __pagination.total = totalCount;
                    renderPagination();
                }
                
                // 更新统计汇总
                __statsTotals = {
                    total: totalCount || __pagination.total || 0,
                    electricityFee: sumFeeElec,
                    serviceFee: sumServiceFee,
                    chargingFee: sumTotalFee,
                    electricity: sumKwh,
                    duration: sumMinutes
                };
                
                // 只更新统计区域，不重新渲染整个表格
                updateStatsOnly();
            } catch (e) {
            }
        }

        // 特来电多选/全选：逐个站点查询统计，然后汇总（避免大数据量查询超时）
        async function aggregateTeldByStations() {
            try {
                const tableName = __pagination.tableName || '[特来电]';
                const timeField = __pagination.timeField || '充电结束时间';
                const start = toSqlDateTime((document.getElementById('start-datetime') || {}).value, false);
                const end = toSqlDateTime((document.getElementById('end-datetime') || {}).value, true);
                
                // 获取需要查询的站点组
                const allBox = document.getElementById('station-all');
                const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
                let stationGroups = [];
                
                if (allBox && allBox.checked) {
                    // 全选：查询所有4个站点组
                    stationGroups = ['east', 'west', 'south', 'gaoling'];
                } else {
                    // 多选：查询选中的站点组
                    stationGroups = items.filter(i => i.checked).map(i => i.getAttribute('data-group'));
                }
                
                if (stationGroups.length === 0) {
                    return;
                }

                let totalCount = 0;
                let sumFeeElec = 0, sumServiceFee = 0, sumTotalFee = 0, sumKwh = 0, sumMinutes = 0;

                // 逐个站点组查询统计
                for (const group of stationGroups) {
                    // 构建该站点组的WHERE条件（使用新的逻辑）
                    const stationCondition = buildTeldStationCondition([group]);
                    if (!stationCondition) continue;
                    
                    const whereClause = `WHERE ${stationCondition} AND [${timeField}] BETWEEN '${start}' AND '${end}'`;
                    
                    // 查询该站点组的统计数据
                    const statsSql = `SELECT 
                        COUNT(1) AS total,
                        SUM(CAST([充电电费(元)] AS DECIMAL(18,4))) AS fee_elec,
                        SUM(CAST([充电服务费(元)] AS DECIMAL(18,4))) AS fee_service,
                        SUM(CAST([充电费用(元)] AS DECIMAL(18,4))) AS fee_total,
                        SUM(CAST([充电电量(度)] AS DECIMAL(18,4))) AS kwh_total,
                        SUM(CAST([充电时长(分钟)] AS DECIMAL(18,4))) AS minutes_total
                        FROM ${tableName} ${whereClause}`;
                    
                    try {
                        const res = await callSqlWithRetry(statsSql, 3, 800);
                        const row = (res && res.results && res.results[0]) || {};
                        
                        // 累加统计结果
                        totalCount += Number(row.total) || 0;
                        sumFeeElec += Number(row.fee_elec) || 0;
                        sumServiceFee += Number(row.fee_service) || 0;
                        sumTotalFee += Number(row.fee_total) || 0;
                        sumKwh += Number(row.kwh_total) || 0;
                        sumMinutes += Number(row.minutes_total) || 0;
                        
                                            } catch (err) {
                        // 某个站点查询失败时继续查询其他站点
                    }
                }

                // 更新分页总数（如果还没有设置）
                if (__pagination.total === 0 && totalCount > 0) {
                    __pagination.total = totalCount;
                    renderPagination();
                }

                // 更新统计汇总
                __statsTotals = {
                    total: totalCount || __pagination.total || 0,
                    electricityFee: sumFeeElec,
                    serviceFee: sumServiceFee,
                    chargingFee: sumTotalFee,
                    electricity: sumKwh,
                    duration: sumMinutes
                };
                
                // 只更新统计区域，不重新渲染整个表格
                updateStatsOnly();
            } catch (e) {
                // 统计失败时保持__statsTotals为null，不做任何操作
            }
        }

        // 能科：计算充电时长（分批查询，因为充电时长可能是ISO格式）
        async function calculateNkDuration(whereClause, tableName, timeField) {
            try {
                // 需要重新查询能科表的总数来计算时长
                const countSql = `SELECT COUNT(1) AS total FROM ${tableName} ${whereClause}`;
                const countRes = await callSqlWithRetry(countSql, 3, 600).catch(() => ({ results: [{ total: 0 }] }));
                const total = Number((countRes && countRes.results && countRes.results[0] && countRes.results[0].total) || 0);
                if (!total) return 0;
                
                const batchSize = 5000;
                let offset = 0;
                let sumMinutes = 0;
                
                // 格式化充电时长：支持ISO日期格式和hh:mm:ss格式
                const parseDuration = (t) => {
                    if (!t) return 0;
                    const str = String(t).trim();
                    
                    // 如果是ISO日期格式（如 1970-01-01T00:11:16.000Z），提取时间部分
                    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(str)) {
                        const timeMatch = str.match(/T(\d{2}):(\d{2}):(\d{2})/);
                        if (timeMatch) {
                            const h = parseFloat(timeMatch[1]) || 0;
                            const m = parseFloat(timeMatch[2]) || 0;
                            const s = parseFloat(timeMatch[3]) || 0;
                            return h * 60 + m + s / 60;
                        }
                    }
                    
                    // 如果是hh:mm:ss或hh;mm;ss格式
                    const parts = str.split(/[:;]/);
                    if (parts.length === 3) {
                        const h = parseFloat(parts[0]) || 0;
                        const m = parseFloat(parts[1]) || 0;
                        const s = parseFloat(parts[2]) || 0;
                        return h * 60 + m + s / 60;
                    }
                    
                    // 如果都不是，尝试直接解析为数字（假设是分钟数）
                    const num = parseFloat(str);
                    return isNaN(num) ? 0 : num;
                };
                
                const loops = Math.ceil(total / batchSize);
                for (let i = 0; i < loops; i++) {
                    const startRn = offset + 1;
                    const endRn = Math.min(total, offset + batchSize);
                    const innerFrom = `FROM ${tableName} ${whereClause}`;
                    const overOrder = `ORDER BY [${timeField}] ASC`;
                    const sql = `SELECT [充电时长] FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                    
                    const res = await callSqlWithRetry(sql, 3, 600).catch(() => null);
                    const rows = (res && res.results) ? res.results : [];
                    for (const r of rows) {
                        sumMinutes += parseDuration(r['充电时长']);
                    }
                    offset += batchSize;
                }
                
                // 返回计算出的时长（供调用者使用）
                return sumMinutes;
            } catch (e) {
                return 0;
            }
        }

        // 能科：客户端分批聚合全量统计（后备方案，当服务器端聚合失败时使用）
        async function aggregateNkTotalsInBatches() {
            try {
                const tableName = __pagination.tableName || '[能科]';
                const whereClause = __pagination.whereClause || '';
                const timeField = __pagination.timeField || '结束日期时间';
                const total = Number(__pagination.total) || 0;
                if (!total) return;

                // 每批次抓取行数（仅取5列）
                const batchSize = 5000;
                let offset = 0;
                let sumFee = 0, sumService = 0, sumAmount = 0, sumKwh = 0, sumMinutes = 0;

                // 复用前端清洗方法
                const clean = (v, kind) => {
                    if (v === null || v === undefined) return 0;
                    let s = String(v).trim();
                    let neg = false;
                    if (/^\(.*\)$/.test(s)) { neg = true; s = s.slice(1, -1); }
                    s = s.replace(/[¥￥,，\s]/g, '');
                    if (kind === 'kwh') {
                        s = s.replace(/(度|kWh|KWh|kW·h|kW·H)/gi, '');
                    }
                    s = s.replace(/元/g, '').replace(/．/g, '.');
                    const num = parseFloat(s);
                    const val = isNaN(num) ? 0 : num;
                    return neg ? -val : val;
                };

                const buildPageSql = (startRn, endRn) => {
                    const innerFrom = `FROM ${tableName} ${whereClause}`;
                    const overOrder = `ORDER BY [${timeField}] ASC`;
                    // 仅选择聚合需要的5列，减少传输量
                    return `SELECT [电费],[服务费],[消费金额],[充电量],[充电时长] FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, [电费],[服务费],[消费金额],[充电量],[充电时长] ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                };

                // 格式化充电时长：支持ISO日期格式和hh:mm:ss格式
                const parseDuration = (t) => {
                    if (!t) return 0;
                    const str = String(t).trim();
                    
                    // 如果是ISO日期格式（如 1970-01-01T00:11:16.000Z），提取时间部分
                    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(str)) {
                        // 提取时间部分：从T后面到.或Z之前
                        const timeMatch = str.match(/T(\d{2}):(\d{2}):(\d{2})/);
                        if (timeMatch) {
                            const h = parseFloat(timeMatch[1]) || 0;
                            const m = parseFloat(timeMatch[2]) || 0;
                            const s = parseFloat(timeMatch[3]) || 0;
                            return h * 60 + m + s / 60;
                        }
                    }
                    
                    // 如果是hh:mm:ss或hh;mm;ss格式
                    const parts = str.split(/[:;]/);
                    if (parts.length === 3) {
                        const h = parseFloat(parts[0]) || 0;
                        const m = parseFloat(parts[1]) || 0;
                        const s = parseFloat(parts[2]) || 0;
                        return h * 60 + m + s / 60;
                    }
                    
                    // 如果都不是，尝试直接解析为数字（假设是分钟数）
                    const num = parseFloat(str);
                    return isNaN(num) ? 0 : num;
                };

                const loops = Math.ceil(total / batchSize);
                for (let i = 0; i < loops; i++) {
                    const startRn = offset + 1;
                    const endRn = Math.min(total, offset + batchSize);
                    const sql = buildPageSql(startRn, endRn);
                    const res = await callSqlWithRetry(sql, 3, 600).catch(() => null);
                    const rows = (res && res.results) ? res.results : [];
                    for (const r of rows) {
                        sumFee += clean(r['电费'], 'money');
                        sumService += clean(r['服务费'], 'money');
                        sumAmount += clean(r['消费金额'], 'money');
                        sumKwh += clean(r['充电量'], 'kwh');
                        sumMinutes += parseDuration(r['充电时长']);
                    }
                    offset += batchSize;
                }

                __statsTotals = {
                    total: __pagination.total,
                    electricityFee: sumFee,
                    serviceFee: sumService,
                    chargingFee: sumAmount,
                    electricity: sumKwh,
                    duration: sumMinutes
                };
                // 只更新统计区域，不重新渲染整个表格
                updateStatsOnly();
            } catch (e) {
                // 统计失败时保持__statsTotals为null，不做任何操作
            }
        }


        // 分页状态（页面展示每页20条）
        let __pagination = {
            enabled: false,
            sqlNoOrder: '',
            orderByFinal: '',
            pageSize: 20,
            total: 0,
            currentPage: 1,
            // 新增：用于OFFSET/FETCH的参数
            whereClause: '',
            timeField: '充电结束时间',
            selectCols: '[电站名称], [终端名称], [充电开始时间], [充电结束时间], [充电电费(元)], [充电服务费(元)], [充电费用(元)], [充电时长(分钟)], [充电前soc], [充电后soc], [判定车牌号], [车辆所属客户]',
            tableName: '[特来电]'
        };
        function ensureTopPaginationBar() {
            const container = $('query-result');
            if (!container) return null;
            const resultContent = $('query-result-content');
            if (!resultContent) return null;
            let bar = $('query-pagination-top');
            if (!bar) {
                bar = document.createElement('div');
                bar.id = 'query-pagination-top';
                bar.style.margin = '8px 0';
                container.insertBefore(bar, resultContent);
                // 缓存新创建的元素
                ElementCache.cache.set('query-pagination-top', bar);
            }
            return bar;
        }

        function renderPagination() {
            const bar = ensureTopPaginationBar();
            if (!bar) return;
            if (!__pagination.enabled || __pagination.total === 0) {
                bar.innerHTML = '';
                return;
            }
            const totalPages = Math.max(1, Math.ceil(__pagination.total / __pagination.pageSize));
            bar.innerHTML = `
                <div style="padding:6px 8px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px; display:flex; align-items:center; gap:8px;">
                    <button id="pg-first" style="padding:4px 8px;">首页</button>
                    <button id="pg-prev" style="padding:4px 8px;">上一页</button>
                    <span>第 <strong>${__pagination.currentPage}</strong> / ${totalPages} 页</span>
                    <span>共 <strong>${__pagination.total}</strong> 条</span>
                    <button id="pg-next" style="padding:4px 8px;">下一页</button>
                    <button id="pg-last" style="padding:4px 8px;">末页</button>
                </div>`;
            $('pg-first').onclick = () => goToPage(1);
            $('pg-prev').onclick = () => goToPage(Math.max(1, __pagination.currentPage - 1));
            $('pg-next').onclick = () => {
                const tp = Math.max(1, Math.ceil(__pagination.total / __pagination.pageSize));
                goToPage(Math.min(tp, __pagination.currentPage + 1));
            };
            $('pg-last').onclick = () => {
                const tp = Math.max(1, Math.ceil(__pagination.total / __pagination.pageSize));
                goToPage(tp);
            };
        }

        // ==================== 统一工具函数 ====================
        
        // DOM元素缓存管理器（增强版）
        const ElementCache = {
            cache: new Map(),
            // 获取元素（优先从缓存）
            get(id) {
                if (!this.cache.has(id)) {
                    const el = document.getElementById(id);
                    if (el) this.cache.set(id, el);
                    return el;
                }
                const cached = this.cache.get(id);
                // 检查元素是否仍然在DOM中
                if (cached && document.contains(cached)) {
                    return cached;
                } else {
                    // 元素已不在DOM中，重新查询
                    this.cache.delete(id);
                    const el = document.getElementById(id);
                    if (el) this.cache.set(id, el);
                    return el;
                }
            },
            // 查询选择器（单个元素）
            query(selector) {
                const key = 'query:' + selector;
                if (!this.cache.has(key)) {
                    const el = document.querySelector(selector);
                    if (el) this.cache.set(key, el);
                    return el;
                }
                const cached = this.cache.get(key);
                if (cached && document.contains(cached)) {
                    return cached;
                } else {
                    this.cache.delete(key);
                    const el = document.querySelector(selector);
                    if (el) this.cache.set(key, el);
                    return el;
                }
            },
            // 查询选择器（多个元素，不缓存）
            queryAll(selector) {
                return document.querySelectorAll(selector);
            },
            // 清除所有缓存
            clear() {
                this.cache.clear();
            },
            // 清除特定元素缓存（当元素可能被删除时）
            invalidate(id) {
                this.cache.delete(id);
            },
            // 批量清除缓存（支持前缀匹配）
            invalidateByPrefix(prefix) {
                for (const key of this.cache.keys()) {
                    if (key.startsWith(prefix)) {
                        this.cache.delete(key);
                    }
                }
            }
        };

        // 便捷函数：替代document.getElementById，自动使用缓存
        function $(id) {
            return ElementCache.get(id);
        }

        // 便捷函数：替代document.querySelector，自动使用缓存
        function $$(selector) {
            return ElementCache.query(selector);
        }

        // ==================== 统一日期选择器函数 ====================
        /**
         * 统一的日期选择器初始化函数
         * @param {HTMLElement} input - 日期输入框元素
         * @param {boolean} isEnd - 是否为结束时间（true: 23:59:59, false: 00:00:00）
         * @param {string} triggerBtnId - 触发按钮的ID（可选，如果不提供则自动推断）
         */
        function attachDatePickerBehavior(input, isEnd, triggerBtnId = null) {
            if (!input) return;

            // 自动推断按钮ID（如果未提供）
            if (!triggerBtnId) {
                // 根据输入框ID推断按钮ID
                const inputId = input.id || '';
                if (inputId.includes('start')) {
                    triggerBtnId = inputId.replace('start', 'start').replace('datetime', 'datetime-btn').replace('date', 'date-btn');
                    if (!triggerBtnId.includes('-btn')) {
                        triggerBtnId = inputId + '-btn';
                    }
                } else if (inputId.includes('end')) {
                    triggerBtnId = inputId.replace('end', 'end').replace('datetime', 'datetime-btn').replace('date', 'date-btn');
                    if (!triggerBtnId.includes('-btn')) {
                        triggerBtnId = inputId + '-btn';
                    }
                } else {
                    triggerBtnId = isEnd ? 'end-datetime-btn' : 'start-datetime-btn';
                }
            }

            const btn = $(triggerBtnId);
            if (!btn) return;

            // 创建隐藏的原生日期选择器
            const hiddenPicker = document.createElement('input');
            hiddenPicker.type = 'date';
            hiddenPicker.style.position = 'fixed';
            hiddenPicker.style.opacity = '0';
            hiddenPicker.style.pointerEvents = 'none';
            hiddenPicker.style.width = '0';
            hiddenPicker.style.height = '0';
            document.body.appendChild(hiddenPicker);

            // 打开日期选择器
            function openPicker() {
                const rect = input.getBoundingClientRect();
                hiddenPicker.style.left = `${Math.max(0, rect.left)}px`;
                hiddenPicker.style.top = `${Math.max(0, rect.bottom)}px`;

                // 从输入框获取当前日期
                const currentValue = input.value;
                if (currentValue && /^\d{4}-\d{2}-\d{2}/.test(currentValue)) {
                    hiddenPicker.value = currentValue.slice(0, 10);
                }

                hiddenPicker.focus();
                try {
                    if (hiddenPicker.showPicker) {
                        hiddenPicker.showPicker();
                    }
                } catch (e) {
                    // 如果showPicker不支持，尝试点击
                }
                hiddenPicker.click();
            }

            // 绑定按钮点击事件
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                openPicker();
            });

            // 日期选择变化事件
            hiddenPicker.addEventListener('change', function() {
                const v = hiddenPicker.value;
                if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
                    input.value = isEnd ? `${v} 23:59:59` : `${v} 00:00:00`;
                }
                input.focus();
            });
        }

        /**
         * 初始化日期选择器（支持开始和结束时间）
         * @param {string} startInputId - 开始时间输入框ID
         * @param {string} endInputId - 结束时间输入框ID
         * @param {string} startBtnId - 开始时间按钮ID（可选）
         * @param {string} endBtnId - 结束时间按钮ID（可选）
         * @param {Object} defaultValues - 默认值 {start: 'yyyy-mm-dd 00:00:00', end: 'yyyy-mm-dd 23:59:59'}
         */
        function initDatetimePickers(startInputId, endInputId, startBtnId = null, endBtnId = null, defaultValues = null) {
            try {
                const startEl = $(startInputId);
                const endEl = $(endInputId);
                if (!startEl || !endEl) return;

                // 设置默认值
                if (defaultValues) {
                    if (defaultValues.start && !startEl.value) {
                        startEl.value = defaultValues.start;
                    }
                    if (defaultValues.end && !endEl.value) {
                        endEl.value = defaultValues.end;
                    }
                }

                // 初始化日期选择器行为
                attachDatePickerBehavior(startEl, false, startBtnId);
                attachDatePickerBehavior(endEl, true, endBtnId);
            } catch (e) {
                console.error('初始化日期选择器失败:', e);
            }
        }

        // 查询结果缓存管理器
        const QueryCache = {
            cache: new Map(),
            defaultTTL: 5 * 60 * 1000, // 默认5分钟过期
            
            // 生成缓存键
            getKey(sql, params = {}) {
                return JSON.stringify({ sql, params });
            },
            
            // 获取缓存
            get(sql, params = {}) {
                const key = this.getKey(sql, params);
                const cached = this.cache.get(key);
                if (!cached) return null;
                
                // 检查是否过期
                if (Date.now() > cached.expiresAt) {
                    this.cache.delete(key);
                    return null;
                }
                
                return cached.data;
            },
            
            // 设置缓存
            set(sql, data, params = {}, ttl = this.defaultTTL) {
                const key = this.getKey(sql, params);
                this.cache.set(key, {
                    data: data,
                    expiresAt: Date.now() + ttl
                });
            },
            
            // 清除缓存
            clear() {
                this.cache.clear();
            },
            
            // 清除过期缓存
            cleanExpired() {
                const now = Date.now();
                for (const [key, value] of this.cache.entries()) {
                    if (now > value.expiresAt) {
                        this.cache.delete(key);
                    }
                }
            }
        };

        // 定期清理过期缓存（每10分钟）
        setInterval(() => QueryCache.cleanExpired(), 10 * 60 * 1000);

        // 统一SQL查询函数（支持重试、缓存、结果解析）
        async function executeSQL(query, options = {}) {
            const {
                retry = true,           // 是否重试
                attempts = 3,          // 重试次数
                delayMs = 600,         // 重试延迟（毫秒）
                useCache = true,        // 是否使用缓存（默认启用）
                cacheTTL = 5 * 60 * 1000, // 缓存过期时间（默认5分钟）
                parseResults = true,    // 是否解析结果
                params = {}              // 查询参数（用于缓存键）
            } = options;

            // 对于写操作（INSERT/UPDATE/DELETE），禁用缓存
            const queryUpper = query.trim().toUpperCase();
            if (queryUpper.startsWith('INSERT') || 
                queryUpper.startsWith('UPDATE') || 
                queryUpper.startsWith('DELETE') || 
                queryUpper.startsWith('DROP') || 
                queryUpper.startsWith('CREATE') || 
                queryUpper.startsWith('ALTER')) {
                options.useCache = false;
            }

            // 检查缓存（如果启用）
            if (options.useCache !== false && useCache) {
                const cached = QueryCache.get(query, params);
                if (cached !== null) {
                    console.log('[缓存命中]', query.substring(0, 50) + '...');
                    return cached;
                }
            }

            let tries = 0;
            const API_URL = 'https://1257663610-833b483ie5.ap-guangzhou.tencentscf.com';
            const API_HEADERS = {
                'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };

            async function run() {
                tries++;
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: API_HEADERS,
                        body: JSON.stringify({ query: query })
                    });

                    if (!response.ok) {
                        let errorMsg = 'HTTP ' + response.status + ': ' + response.statusText;
                        try {
                            const errorBody = await response.text();
                            if (errorBody) {
                                errorMsg += ' - ' + errorBody;
                            }
                        } catch (e) {
                            // 忽略解析错误体的错误
                        }
                        const error = new Error(errorMsg);
                        error.httpStatus = response.status;
                        throw error;
                    }

                    const result = await response.json();
                    
                    // 解析结果
                    let data;
                    if (parseResults) {
                        data = (result && result.result) ? result.result : result;
                        
                        // 处理LeanCloud返回的数据格式
                        if (typeof data === 'string') {
                            try {
                                const parsed = JSON.parse(data);
                                data = parsed.results || parsed;
                            } catch (e) {
                                // 如果解析失败，使用原始数据
                            }
                        } else if (data && data.results) {
                            data = data.results;
                        } else if (data && data.success && data.results) {
                            data = data.results;
                        }
                    } else {
                        data = (result && result.result) ? result.result : result;
                    }

                    // 保存到缓存（如果启用且不是写操作）
                    if (options.useCache !== false && useCache) {
                        QueryCache.set(query, data, params, cacheTTL);
                        console.log('[缓存已保存]', query.substring(0, 50) + '...');
                    }

                    return data;

                } catch (err) {
                    // 重试逻辑
                    if (retry && tries < attempts) {
                        const wait = delayMs * Math.pow(2, tries - 1);
                        await new Promise(resolve => setTimeout(resolve, wait));
                        return run();
                    }
                    throw err;
                }
            }

            return run();
        }

        // 向后兼容的包装函数
        function callSqlGeneric(sql) {
            return executeSQL(sql, { retry: false, parseResults: false, useCache: true });
        }

        function callSqlWithRetry(sql, attempts = 3, delayMs = 600) {
            return executeSQL(sql, { retry: true, attempts, delayMs, parseResults: false, useCache: true });
        }

        async function executeLeanCloudSQL(query) {
            return executeSQL(query, { retry: true, attempts: 3, delayMs: 600, parseResults: true, useCache: true });
        }

        // 清除查询缓存的便捷函数
        function clearQueryCache() {
            QueryCache.clear();
            console.log('[查询缓存已清除]');
        }

        // 清除特定查询的缓存
        function invalidateQueryCache(query, params = {}) {
            const key = QueryCache.getKey(query, params);
            QueryCache.cache.delete(key);
            console.log('[查询缓存已失效]', query.substring(0, 50) + '...');
        }

        // 特来电全选时，使用时间段分段查询（避免大数据量查询超时）
        async function goToPageWithTimeSegments(targetPage) {
            if (!__pagination.enabled) return;
            
            const resultContent = $('query-result-content');
            const statsContainer = $('stats-container');
            const tableContainer = statsContainer ? statsContainer.nextElementSibling : null;
            
            const totalPages = Math.max(1, Math.ceil(__pagination.total / __pagination.pageSize));
            const page = Math.min(totalPages, Math.max(1, targetPage));
            __pagination.currentPage = page;
            const offset = (page - 1) * __pagination.pageSize;
            const needCount = __pagination.pageSize;
            
            // 显示加载提示
            if (tableContainer) {
                tableContainer.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> 正在分段查询数据... 第 ' + page + ' 页（大数据量优化查询）</div>';
            } else {
                resultContent.innerHTML = `<p>正在分段查询数据... 第 ${page} 页（大数据量优化查询）</p>`;
            }
            
            try {
                const startEl = $('start-datetime');
                const endEl = $('end-datetime');
                if (!startEl || !endEl || !startEl.value || !endEl.value) {
                    throw new Error('时间范围未设置');
                }
                
                const startDate = new Date(startEl.value);
                const endDate = new Date(endEl.value);
                const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                
                // 每30天为一个时间段
                const segmentDays = 30;
                const segments = [];
                let currentStart = new Date(startDate);
                
                while (currentStart <= endDate) {
                    let currentEnd = new Date(currentStart);
                    currentEnd.setDate(currentEnd.getDate() + segmentDays - 1);
                    if (currentEnd > endDate) {
                        currentEnd = new Date(endDate);
                    }
                    segments.push({
                        start: new Date(currentStart),
                        end: new Date(currentEnd)
                    });
                    currentStart.setDate(currentStart.getDate() + segmentDays);
                }
                
                
                const selectCols = __pagination.selectCols || '*';
                const timeField = __pagination.timeField || '充电结束时间';
                const tableName = __pagination.tableName || '[特来电]';
                const overOrder = `ORDER BY [${timeField}] ASC`;
                
                // 存储所有时间段查询的结果
                let allRows = [];
                let collectedCount = 0;
                let targetStartIndex = offset;
                let targetEndIndex = offset + needCount;
                
                // 按时间段串行查询（避免并发过多）
                for (let i = 0; i < segments.length; i++) {
                    const seg = segments[i];
                    const segStart = toSqlDateTime(seg.start.toISOString().slice(0, 19).replace('T', ' '), false);
                    const segEnd = toSqlDateTime(seg.end.toISOString().slice(0, 19).replace('T', ' '), true);
                    
                    // 更新加载提示
                    if (tableContainer) {
                        tableContainer.innerHTML = `<div style="padding:20px; text-align:center;">
                            <i class="fas fa-spinner fa-spin"></i> 正在查询时间段 ${i + 1}/${segments.length}...<br>
                            <small style="color:#666;">${segStart} 至 ${segEnd}</small>
                        </div>`;
                    }
                    
                    const whereClause = `WHERE [${timeField}] BETWEEN '${segStart}' AND '${segEnd}'`;
                    const innerFrom = `FROM ${tableName} ${whereClause}`;
                    
                    // 查询该时间段的所有数据（按时间段分段后，每个时间段的数据量应该较小）
                    const segSql = `SELECT ${selectCols} FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t`;
                    
                    try {
                        const segRes = await callSqlWithRetry(segSql, 3, 800);
                        const segRows = (segRes && segRes.results) ? segRes.results : [];
                        
                        // 移除rn列
                        const cleanedRows = segRows.map(row => {
                            const cleaned = { ...row };
                            delete cleaned.rn;
                            return cleaned;
                        });
                        
                        // 检查是否需要这个时间段的数据
                        const segRowCount = cleanedRows.length;
                        if (collectedCount + segRowCount < targetStartIndex) {
                            // 这个时间段的数据都在目标范围之前，跳过
                            collectedCount += segRowCount;
                            continue;
                        }
                        
                        if (collectedCount >= targetEndIndex) {
                            // 已经收集够了，可以停止
                            break;
                        }
                        
                        // 添加需要的数据行
                        const segStartIndex = Math.max(0, targetStartIndex - collectedCount);
                        const segEndIndex = Math.min(segRowCount, targetEndIndex - collectedCount);
                        allRows = allRows.concat(cleanedRows.slice(segStartIndex, segEndIndex));
                        collectedCount += segRowCount;
                        
                        // 如果已经收集够了，可以提前停止
                        if (allRows.length >= needCount) {
                            break;
                        }
                    } catch (err) {
                        // 某个时间段查询失败时继续查询其他时间段
                        continue;
                    }
                }
                
                // 只取需要的数量
                const finalRows = allRows.slice(0, needCount);
                const payload = { success: true, results: finalRows, rowCount: finalRows.length };
                __lastQueryResults = payload;
                
                // 只更新表格部分
                updateTableOnly(payload);
                setExportEnabled(finalRows.length > 0);
                renderPagination();
                
            } catch (err) {
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div style="background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;">
                            <h4 style="margin:0 0 6px 0;">查询失败</h4>
                            <div>${err.message || '未知错误'}</div>
                        </div>`;
                } else {
                    resultContent.innerHTML = `
                        <div style="background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;">
                            <h4 style="margin:0 0 6px 0;">查询失败</h4>
                            <div>${err.message || '未知错误'}</div>
                        </div>`;
                }
                setExportEnabled(false);
            }
        }

        function goToPage(targetPage) {
            if (!__pagination.enabled) return;
            
            // 如果是多设备查询，使用合并分页函数
            if (__pagination.queries && __pagination.queries.length > 0) {
                // 检查是否使用了简化的多设备查询（有nkTotal和teldTotal）
                if (__pagination.nkTotal !== undefined && __pagination.teldTotal !== undefined) {
                    loadSimpleMergedPage(targetPage);
                } else {
                    loadMergedPage(targetPage);
                }
                return;
            }
            
            // 原有的单设备分页逻辑
            const resultContent = $('query-result-content');
            const totalPages = Math.max(1, Math.ceil(__pagination.total / __pagination.pageSize));
            const page = Math.min(totalPages, Math.max(1, targetPage));
            __pagination.currentPage = page;
            const offset = (page - 1) * __pagination.pageSize;
            
            // 翻页时只显示加载提示，不影响统计区域
            const statsContainer = $('stats-container');
            const tableContainer = statsContainer ? statsContainer.nextElementSibling : null;
            if (tableContainer) {
                tableContainer.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> 正在加载数据... 第 ' + page + ' 页</div>';
            } else {
            resultContent.innerHTML = `<p>正在加载数据... 第 ${page} 页</p>`;
            }
            
            // 使用 ROW_NUMBER 分页（兼容后端），并精确列清单
            const selectCols = __pagination.selectCols || '*';
            const whereClause = __pagination.whereClause || '';
            const timeField = __pagination.timeField || '充电结束时间';
            const startRn = offset + 1;
            const endRn = offset + __pagination.pageSize;
            const tableName = __pagination.tableName || '[特来电]';
            const innerFrom = `FROM ${tableName} ${whereClause}`;
            const overOrder = `ORDER BY [${timeField}] ASC`;

            // 根据设备类型构建不同的分页SQL
            let pageSql;
            if (__currentDevice === '滴滴') {
                // 滴滴表需要特殊处理，因为selectCols包含CAST
                pageSql = `SELECT ${selectCols} FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, [订单ID], [用户类型], [场站名称], [充电桩ID], [充电枪ID], [开始充电时间], [充电完成时间], [充电时长（分钟）], [充电量（度）], [订单总额（元）], [充电电费（元）], [充电服务费（元）], [车牌号] ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
            } else {
                pageSql = `SELECT ${selectCols} FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
            }

            callSqlWithRetry(pageSql, 3, 600).then(pageRes => {
                const rows = (pageRes && pageRes.results) ? pageRes.results : [];
                const payload = { success: true, results: rows, rowCount: rows.length, query: pageSql };
                __lastQueryResults = payload; // 保留当前页的完整列数据用于导出当前页
                
                // 翻页时只更新表格部分，不更新统计区域（统计只在第一次查询时计算）
                updateTableOnly(payload);
                
                setExportEnabled(rows.length > 0);
                renderPagination();
            }).catch(err => {
                const statsContainer = document.getElementById('stats-container');
                const tableContainer = statsContainer ? statsContainer.nextElementSibling : null;
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div style="background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;">
                            <h4 style="margin:0 0 6px 0;">查询失败</h4>
                            <div>${err.message || '未知错误'}</div>
                        </div>`;
                } else {
                resultContent.innerHTML = `
                    <div style="background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;">
                        <h4 style="margin:0 0 6px 0;">查询失败</h4>
                        <div>${err.message || '未知错误'}</div>
                    </div>`;
                }
                setExportEnabled(false);
            });
        }
        
        // 仅更新表格部分（翻页时使用，不更新统计区域）
        function updateTableOnly(result) {
            // 如果是多设备查询（合并查询），不执行此函数（由多设备查询函数处理）
            if (__currentDevice === '合并' || (__pagination && __pagination.queries && __pagination.queries.length > 1)) {
                return;
            }
            
            if (!result.results || result.results.length === 0) {
                const statsContainer = document.getElementById('stats-container');
                const tableContainer = statsContainer ? statsContainer.nextElementSibling : null;
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 4px; color: #0c5460;">
                            <h4>查询成功</h4>
                            <p>结果: 无任何数据可查询</p>
                        </div>`;
                }
                return;
            }
            
            const data = result.results;
            const isNK = (__currentDevice === '能科');
            const isDiDi = (__currentDevice === '滴滴');

            let tableHTML = `
                <div style="overflow-x: auto; height: 100%;">
                    <table style="width: 100%; border-collapse: collapse; margin: 0; min-width: 1200px;">
                        <thead>
                            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
            `;

            // 仅显示固定的13列
            const __cols = (__currentDisplayColumns && __currentDisplayColumns.length) ? __currentDisplayColumns : DISPLAY_COLUMNS;
            __cols.forEach(col => {
                tableHTML += `<th style="border: 1px solid #dee2e6; padding: 12px 8px; text-align: left; font-weight: 600; color: #495057; white-space: nowrap; min-width: 120px;">${col}</th>`;
            });
            tableHTML += `</tr></thead><tbody>`;

            // 数据行（只渲染13列，字段名容错映射）
            data.forEach((row, index) => {
                const rowClass = index % 2 === 0 ? 'background-color: #fff;' : 'background-color: #f8f9fa;';
                tableHTML += `<tr style="${rowClass}">`;
                __cols.forEach(col => {
                    let value = '';
                    if (__currentDevice === '能科') {
                        const map = {
                            '卡号': row['卡号'] || '',
                            '充电桩名称': row['充电桩名称'] || '',
                            '开始日期时间': row['开始日期时间'] || '',
                            '结束日期时间': row['结束日期时间'] || '',
                            '充电量': row['充电量'] || '',
                            '电费': row['电费'] || '',
                            '服务费': row['服务费'] || '',
                            '消费金额': row['消费金额'] || '',
                            '充电时长': formatDuration(row['充电时长'] || ''),
                            '开始SOC': row['开始SOC'] || '',
                            '结束SOC': row['结束SOC'] || '',
                            '车牌号': row['车牌号'] || '',
                            '持卡人': row['持卡人'] || ''
                        };
                        value = map[col] !== undefined ? map[col] : '';
                    } else if (__currentDevice === '滴滴') {
                        // 滴滴平台字段直接映射（SQL查询已返回正确的列名）
                        value = (row[col] !== null && row[col] !== undefined && row[col] !== 'NULL') ? row[col] : '';
                    } else {
                        const map = {
                            '电站名称': row['电站名称'] || '',
                            '终端名称': row['终端名称'] || '',
                            '充电开始时间': row['充电开始时间'] || '',
                            '充电结束时间': row['充电结束时间'] || '',
                            '充电电量(度)': row['充电电量(度)'] || '',
                            '充电电费(元)': row['充电电费(元)'] || '',
                            '充电服务费(元)': row['充电服务费(元)'] || '',
                            '充电费用(元)': row['充电费用(元)'] || '',
                            '充电时长(分钟)': row['充电时长(分钟)'] || '',
                            '充电前soc': row['充电前soc'] || '',
                            '充电后soc': row['充电后soc'] || '',
                            '判定车牌号': row['判定车牌号'] || '',
                            '车辆所属客户': row['车辆所属客户'] || ''
                        };
                        value = map[col] !== undefined ? map[col] : '';
                    }
                    tableHTML += `<td style="border: 1px solid #dee2e6; padding: 10px 8px; text-align: left; color: #495057;">${value}</td>`;
                });
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            
            // 只更新表格容器，保持统计区域不变
            const statsContainer = document.getElementById('stats-container');
            if (statsContainer && statsContainer.nextElementSibling) {
                statsContainer.nextElementSibling.outerHTML = tableHTML;
            } else if (statsContainer) {
                statsContainer.insertAdjacentHTML('afterend', tableHTML);
            } else {
                // 如果没有统计容器，说明是第一次加载或统计区域未渲染，使用完整渲染
                displayQueryResult(result);
            }
        }

        // 设置时间框体默认值：当天日期带时分秒（显示在文本框内），选择时用原生日历不带时分秒
        (function setDefaultDateTimes() {
            try {
                // 设置默认值（当天）
                const pad = n => (n < 10 ? '0' + n : '' + n);
                const now = new Date();
                const y = now.getFullYear();
                const m = pad(now.getMonth() + 1);
                const d = pad(now.getDate());
                const defaultValues = {
                    start: `${y}-${m}-${d} 00:00:00`,
                    end: `${y}-${m}-${d} 23:59:59`
                };

                // 使用统一的日期选择器初始化函数
                initDatetimePickers('start-datetime', 'end-datetime', 'start-datetime-btn', 'end-datetime-btn', defaultValues);
            } catch (e) {
                console.error('初始化日期选择器失败:', e);
            }
        })();

        // ========= 充电数据 正式查询：交互与查询逻辑 =========
        function setExportEnabled(enabled) {
            const btn = $('export-btn');
            if (!btn) return;
            btn.disabled = !enabled;
            if (enabled) {
                btn.style.background = '#28a745';
                btn.style.cursor = 'pointer';
            } else {
                btn.style.background = '#adb5bd';
                btn.style.cursor = 'not-allowed';
            }
        }

        // 初始化导出按钮禁用，并初始化设备框体为灰色占位
        setTimeout(() => {
            setExportEnabled(false);
            const deviceSelect = document.getElementById('device-select');
            if (deviceSelect) deviceSelect.style.color = deviceSelect.value ? '#333' : '#999';
        }, 0);

        const STATION_GROUP_TO_NAMES = {
            east: [
                '长沙飞狐充电站',
                '长沙飞狐四方坪桥下充电站',
                '长沙飞狐四方坪桥下二期充电站',
                '长沙特来电飞狐东区充电站',
                '长沙特来电飞狐四方坪东区充电站'
            ],
            west: [
                '长沙特来电飞狐四方坪西区充电站',
                '长沙特来电飞狐西区充电站',
                '长沙飞狐四方坪桥下三期充电站'
            ],
            south: [
                '长沙特来电飞狐四方坪南区充电站',
                '长沙特来电飞狐南区充电站',
                '长沙飞狐四方坪桥下三期充电站',
                '长沙特来电飞狐西区充电站'
            ],
            gaoling: [
                '长沙市开福区高岭香江国际城充电站建设项目',
                '华为飞狐特来电高岭超充站'
            ]
        };

        function navigateHome() {
            // 简单处理：关闭覆盖页，回到首页内容
            const overlay = document.getElementById('page-cd-data');
            if (overlay) overlay.style.display = 'none';
            const overlayBill = document.getElementById('page-bill-data');
            if (overlayBill) overlayBill.style.display = 'none';
            const overlayUserData = document.getElementById('page-user-data');
            if (overlayUserData) overlayUserData.style.display = 'none';
            const overlayOtherData = document.getElementById('page-other-data');
            if (overlayOtherData) overlayOtherData.style.display = 'none';
            const overlayZh = document.getElementById('page-zh-data');
            if (overlayZh) overlayZh.style.display = 'none';
            const overlayReportCharging = document.getElementById('page-report-charging');
            if (overlayReportCharging) overlayReportCharging.style.display = 'none';
            const overlayReportComprehensive = document.getElementById('page-report-comprehensive');
            if (overlayReportComprehensive) overlayReportComprehensive.style.display = 'none';
            const overlayReportUser = document.getElementById('page-report-user');
            if (overlayReportUser) overlayReportUser.style.display = 'none';
            const overlayReportEfficiency = document.getElementById('page-report-efficiency');
            if (overlayReportEfficiency) overlayReportEfficiency.style.display = 'none';
            const overlayAIModel = document.getElementById('page-ai-model');
            if (overlayAIModel) overlayAIModel.style.display = 'none';
            window.scrollTo(0, 0);
        }

        function toggleStationMenu() {
            const menu = document.getElementById('station-menu');
            if (!menu) return;
            menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
        }

        // 点击页面空白处隐藏电站下拉
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('station-menu');
            const box = document.getElementById('station-box');
            if (!menu || !box) return;
            if (menu.style.display === 'none' || menu.style.display === '') return;
            const target = e.target;
            if (!box.contains(target) && !menu.contains(target)) {
                menu.style.display = 'none';
            }
        });
        // 鼠标离开菜单区域后隐藏（稍作延迟避免抖动）
        (function() {
            const menu = document.getElementById('station-menu');
            if (!menu) return;
            let hideTimer = null;
            function scheduleHide() {
                clearTimeout(hideTimer);
                hideTimer = setTimeout(() => { menu.style.display = 'none'; }, 200);
            }
            function cancelHide() { clearTimeout(hideTimer); }
            menu.addEventListener('mouseleave', scheduleHide);
            menu.addEventListener('mouseenter', cancelHide);
            const box = document.getElementById('station-box');
            if (box) {
                box.addEventListener('mouseleave', scheduleHide);
                box.addEventListener('mouseenter', cancelHide);
            }
        })();

        function onToggleAllStations() {
            const all = document.getElementById('station-all');
            const items = document.querySelectorAll('#station-menu .station-group');
            items.forEach(i => { i.checked = all.checked; });
            onStationChange(); // 电站选择变化时更新充电平台选项
        }

        function applyStationSelection() {
            const all = document.getElementById('station-all');
            const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
            const checked = items.filter(i => i.checked).map(i => i.getAttribute('data-group'));
            if (checked.length === items.length) {
                all.checked = true;
            } else {
                all.checked = false;
            }
            // 显示已选择的电站名称
            const display = document.getElementById('station-display');
            const mapToLabel = { east: '长沙飞狐四方坪东区站', west: '长沙飞狐四方坪西区站', south: '长沙飞狐四方坪南区站', gaoling: '长沙飞狐高岭站' };
            if (display) {
                if (all.checked) {
                    display.textContent = '电站：全选';
                } else if (checked.length > 0) {
                    display.textContent = '电站：' + checked.map(k => mapToLabel[k]).join('、');
                } else {
                    display.textContent = '电站：未选择';
                }
            }
            onStationChange(); // 电站选择变化时更新充电平台选项
            toggleStationMenu();
        }

        // 电站选择变化时，动态更新充电平台选项
        function onStationChange() {
            const all = document.getElementById('station-all');
            const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
            const checked = items.filter(i => i.checked).map(i => i.getAttribute('data-group'));
            const hasEast = all && all.checked ? true : checked.includes('east');
            
            // 获取充电平台选项
            const teldOption = document.querySelector('#device-menu .device-option[value="特来电"]');
            const nkOption = document.querySelector('#device-menu .device-option[value="能科"]');
            const teldLabel = teldOption ? teldOption.closest('label') : null;
            const nkLabel = nkOption ? nkOption.closest('label') : null;
            
            if (hasEast) {
                // 包含"长沙飞狐四方坪东区站"：显示特来电和能科
                if (teldLabel) teldLabel.style.display = 'flex';
                if (nkLabel) nkLabel.style.display = 'flex';
                // 确保至少有一个被选中
                if (teldOption && !teldOption.checked && (!nkOption || !nkOption.checked)) {
                    teldOption.checked = true;
                }
            } else {
                // 不包含"长沙飞狐四方坪东区站"：只显示特来电
                if (teldLabel) teldLabel.style.display = 'flex';
                if (nkLabel) nkLabel.style.display = 'none';
                if (nkOption) nkOption.checked = false;
                // 确保特来电被选中
                if (teldOption && !teldOption.checked) {
                    teldOption.checked = true;
                }
            }
            // 只更新显示文本，不弹出菜单
            updateDeviceDisplay();
        }

        // 更新充电平台显示文本（不弹出菜单）
        function updateDeviceDisplay() {
            const items = Array.from(document.querySelectorAll('#device-menu .device-option'));
            const checked = items.filter(i => i.checked).map(i => i.value);
            
            const display = document.getElementById('device-display');
            if (display) {
                if (checked.length === 0) {
                    display.textContent = '充电平台：未选择';
                } else if (checked.length === 1) {
                    display.textContent = '充电平台：' + checked[0];
                } else {
                    display.textContent = '充电平台：' + checked.join('、');
                }
            }
        }

        // 充电平台菜单切换
        function toggleDeviceMenu() {
            const menu = document.getElementById('device-menu');
            if (!menu) return;
            const isVisible = menu.style.display === 'block';
            menu.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // 鼠标离开时隐藏菜单
                let hideTimer;
                function scheduleHide() {
                    clearTimeout(hideTimer);
                    hideTimer = setTimeout(() => { menu.style.display = 'none'; }, 200);
                }
                function cancelHide() { clearTimeout(hideTimer); }
                menu.addEventListener('mouseleave', scheduleHide);
                menu.addEventListener('mouseenter', cancelHide);
                const box = document.getElementById('device-box');
                if (box) {
                    box.addEventListener('mouseleave', scheduleHide);
                    box.addEventListener('mouseenter', cancelHide);
                }
            }
        }

        // 应用充电平台选择
        function applyDeviceSelection() {
            // 更新显示文本
            updateDeviceDisplay();
            // 关闭菜单
            toggleDeviceMenu();
        }

        // 获取选中的充电平台
        function getSelectedDevices() {
            const items = Array.from(document.querySelectorAll('#device-menu .device-option'));
            return items.filter(i => i.checked).map(i => i.value);
        }

        function getSelectedStationNames() {
            const all = document.getElementById('station-all');
            const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
            if (all && all.checked) {
                // 全选：返回所有分组名称合并
                return Object.values(STATION_GROUP_TO_NAMES).flat();
            }
            const groups = items.filter(i => i.checked).map(i => i.getAttribute('data-group'));
            if (groups.length === 0) return [];
            let list = [];
            groups.forEach(g => { list = list.concat(STATION_GROUP_TO_NAMES[g] || []); });
            return Array.from(new Set(list));
        }

        function toSqlDateTime(value, isEnd = false) {
            if (!value) return '';
            // value could be 'YYYY-MM-DD hh:mm:ss' or 'YYYY-MM-DD'
            if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                return isEnd ? `${value} 23:59:59` : `${value} 00:00:00`;
            }
            return value.replace('T', ' ');
        }
        // 将能科的字段映射到特来电字段名（用于数据合并）
        function mapNkRowToTeld(row) {
            const clean = (v, kind) => {
                if (v === null || v === undefined) return '';
                let s = String(v).trim();
                let neg = false;
                if (/^\(.*\)$/.test(s)) { neg = true; s = s.slice(1, -1); }
                s = s.replace(/[¥￥,，\s]/g, '');
                if (kind === 'kwh') {
                    s = s.replace(/(度|kWh|KWh|kW·h|kW·H)/gi, '');
                }
                s = s.replace(/元/g, '').replace(/．/g, '.');
                const num = parseFloat(s);
                const val = isNaN(num) ? 0 : num;
                return neg ? -val : val;
            };
            
            return {
                '电站名称': '长沙飞狐四方坪东区站',
                '终端名称': row['充电桩名称'] || row['终端名称'] || '',
                '充电开始时间': row['开始日期时间'] || row['充电开始时间'] || '',
                '充电结束时间': row['结束日期时间'] || row['充电结束时间'] || '',
                '充电电量(度)': clean(row['充电量'], 'kwh'),
                '充电电费(元)': clean(row['电费'], 'money'),
                '充电服务费(元)': clean(row['服务费'], 'money'),
                '充电费用(元)': clean(row['消费金额'], 'money'),
                '充电时长(分钟)': row['充电时长'] || row['充电时长(分钟)'] || '',
                '充电前soc': row['开始SOC'] || row['充电前soc'] || row['充电前SOC'] || '',
                '充电后soc': row['结束SOC'] || row['充电后soc'] || row['充电后SOC'] || '',
                '判定车牌号': row['车牌号'] || '',
                '车辆所属客户': row['持卡人'] || ''
            };
        }

        // 清空内容的辅助函数
        function clearElementContent(element, showLoading = true) {
            if (!element) return;

            // 一次性清空所有内容
            element.replaceChildren();
            element.innerHTML = '';
            element.textContent = '';

            // 强制浏览器重新渲染
            void element.offsetHeight;

            // 显示加载提示
            if (showLoading) {
                element.innerHTML = '<div style="padding:20px; text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> 正在加载数据，请稍候...</div>';
            }
        }

        // 构建特来电查询的站点条件（根据选中的站点组，不包含时间条件）
        function buildTeldStationCondition(checkedGroups) {
            const terminalExcludeList = ['F01号直流', 'F02号直流', 'F03号直流', 'F04号直流', 'F05号直流', 'F06号直流', 
                                         'G01号直流', 'G02号直流', 'G03号直流', 'G04号直流', 'G05号直流', 'G06号直流', 
                                         'H01号直流', 'H02号直流', 'H03号直流', 'H04号直流', 'H05号直流', 'H06号直流', 
                                         'I01号直流', 'I02号直流', 'I03号直流', 'I04号直流', 'I05号直流', 'I06号直流'];
            
            const stationConditions = [];
            
            checkedGroups.forEach(group => {
                if (group === 'east') {
                    // 长沙飞狐四方坪东区站：包含以下电站名称的所有数据
                    const eastStations = [
                        '长沙飞狐充电站',
                        '长沙飞狐四方坪桥下充电站',
                        '长沙飞狐四方坪桥下二期充电站',
                        '长沙特来电飞狐东区充电站',
                        '长沙特来电飞狐四方坪东区充电站'
                    ];
                    const esc = eastStations.map(n => `N'${n.replace(/'/g, "''")}'`).join(', ');
                    stationConditions.push(`[电站名称] IN (${esc})`);
                } else if (group === 'west') {
                    // 长沙飞狐四方坪西区站：
                    // 1. "长沙飞狐四方坪桥下三期充电站" 且 "终端名称"不包含指定列表
                    // 2. "长沙特来电飞狐四方坪西区充电站"
                    // 3. "长沙特来电飞狐西区充电站" 且 "终端名称"不包含指定列表
                    const westConditions = [];
                    
                    // 条件1：长沙飞狐四方坪桥下三期充电站 且 终端名称不包含指定列表
                    let terminalExclude = terminalExcludeList.map(t => `[终端名称] NOT LIKE N'%${t.replace(/'/g, "''")}%'`).join(' AND ');
                    westConditions.push(`([电站名称] = N'长沙飞狐四方坪桥下三期充电站' AND ${terminalExclude})`);
                    
                    // 条件2：长沙特来电飞狐四方坪西区充电站
                    westConditions.push(`[电站名称] = N'长沙特来电飞狐四方坪西区充电站'`);
                    
                    // 条件3：长沙特来电飞狐西区充电站 且 终端名称不包含指定列表
                    westConditions.push(`([电站名称] = N'长沙特来电飞狐西区充电站' AND ${terminalExclude})`);
                    
                    stationConditions.push('(' + westConditions.join(' OR ') + ')');
                } else if (group === 'south') {
                    // 长沙飞狐四方坪南区站：
                    // 1. "长沙飞狐四方坪桥下三期充电站" 且 "终端名称"包含指定列表
                    // 2. "长沙特来电飞狐南区充电站"
                    // 3. "长沙特来电飞狐四方坪南区充电站"
                    // 4. "长沙特来电飞狐西区充电站" 且 "终端名称"包含指定列表
                    const southConditions = [];
                    
                    // 条件1：长沙飞狐四方坪桥下三期充电站 且 终端名称包含指定列表（至少包含一个）
                    let terminalInclude = terminalExcludeList.map(t => `[终端名称] LIKE N'%${t.replace(/'/g, "''")}%'`).join(' OR ');
                    southConditions.push(`([电站名称] = N'长沙飞狐四方坪桥下三期充电站' AND (${terminalInclude}))`);
                    
                    // 条件2：长沙特来电飞狐南区充电站
                    southConditions.push(`[电站名称] = N'长沙特来电飞狐南区充电站'`);
                    
                    // 条件3：长沙特来电飞狐四方坪南区充电站
                    southConditions.push(`[电站名称] = N'长沙特来电飞狐四方坪南区充电站'`);
                    
                    // 条件4：长沙特来电飞狐西区充电站 且 终端名称包含指定列表（至少包含一个）
                    southConditions.push(`([电站名称] = N'长沙特来电飞狐西区充电站' AND (${terminalInclude}))`);
                    
                    stationConditions.push('(' + southConditions.join(' OR ') + ')');
                } else if (group === 'gaoling') {
                    // 长沙飞狐四方坪高岭站：包含以下电站名称的所有数据
                    const gaolingStations = [
                        '长沙市开福区高岭香江国际城充电站建设项目',
                        '华为飞狐特来电高岭超充站'
                    ];
                    const esc = gaolingStations.map(n => `N'${n.replace(/'/g, "''")}'`).join(', ');
                    stationConditions.push(`[电站名称] IN (${esc})`);
                }
            });
            
            if (stationConditions.length > 0) {
                return '(' + stationConditions.join(' OR ') + ')';
            }
            return '';
        }

        // 构建特来电查询的WHERE条件（根据选中的站点组）
        function buildTeldWhereCondition(checkedGroups, timeField, start, end) {
            const whereParts = [];
            const stationCondition = buildTeldStationCondition(checkedGroups);
            
            if (stationCondition) {
                whereParts.push(stationCondition);
            }
            
            whereParts.push(`[${timeField}] BETWEEN '${start}' AND '${end}'`);
            
            return whereParts;
        }

        // 构建查询配置（支持多设备）
        function buildStationQuery() {
            const devices = getSelectedDevices();
            const timeUi = (document.getElementById('time-field-select') || {}).value || '充电结束时间';
            const start = toSqlDateTime((document.getElementById('start-datetime') || {}).value, false);
            const end = toSqlDateTime((document.getElementById('end-datetime') || {}).value, true);
            const stations = getSelectedStationNames();
            const allBox = document.getElementById('station-all');
            const isAllStations = !!(allBox && allBox.checked);

            // 检查是否包含"长沙飞狐四方坪东区站"
            const checkedGroups = allBox && allBox.checked
                ? ['east', 'west', 'south', 'gaoling']
                : Array.from(document.querySelectorAll('#station-menu .station-group'))
                    .filter(i => i.checked)
                    .map(i => i.getAttribute('data-group'));
            const hasEast = checkedGroups.includes('east');

            if (devices.length === 0) {
                return { ok: false, error: '请选择充电平台' };
            }
            if (!start || !end) {
                return { ok: false, error: '请选择开始与结束时间' };
            }
            if (!isAllStations && stations.length === 0) {
                return { ok: false, error: '请选择电站' };
            }

            const queries = [];

            // 为每个选中的设备构建查询
            devices.forEach(device => {
                let tableName, timeField, whereParts = [];

            if (device === '能科') {
                    // 能科：只能查询"长沙飞狐四方坪东区站"
                    if (!hasEast) {
                        // 如果不包含"长沙飞狐四方坪东区站"，跳过能科查询
                        return;
                    }
                tableName = '[能科]';
                timeField = (timeUi === '充电开始时间') ? '开始日期时间' : '结束日期时间';
            whereParts.push(`[${timeField}] BETWEEN '${start}' AND '${end}'`);
            } else if (device === '滴滴') {
                    // 滴滴：只能查询"长沙飞狐四方坪东区站"、"长沙飞狐四方坪西区站"和"长沙飞狐四方坪南区站"
                    const hasSouth = checkedGroups.includes('south');
                    const hasWest = checkedGroups.includes('west');

                    if (!hasEast && !hasWest && !hasSouth) {
                        // 如果不包含这三个站点，跳过滴滴查询
                        return;
                    }

                    tableName = '[滴滴]';
                    timeField = (timeUi === '充电开始时间') ? '开始充电时间' : '充电完成时间';

                    // 构建场站名称条件
                    const stationMappings = [];
                    if (hasEast) stationMappings.push("N'飞狐四方坪东区充电站'");
                    if (hasWest) stationMappings.push("N'飞狐四方坪西区充电站'");
                    if (hasSouth) stationMappings.push("N'飞狐四方坪南区充电站'");

                    whereParts.push(`[场站名称] IN (${stationMappings.join(', ')})`);
                    whereParts.push(`[${timeField}] BETWEEN '${start}' AND '${end}'`);
            } else {
                    // 特来电：根据选中的站点组构建复杂的WHERE条件
                    tableName = '[特来电]';
                    timeField = timeUi;

                    // 使用新的函数构建特来电的WHERE条件
                    whereParts = buildTeldWhereCondition(checkedGroups, timeField, start, end);
            }

            const whereClause = whereParts.length ? ('WHERE ' + whereParts.join(' AND ')) : '';
            // 优化SQL查询：只查询需要的字段，添加索引提示，限制记录数量
            let sql;
            if (device === '滴滴') {
                // 滴滴表查询13列，注意充电量需要类型转换
                sql = `SELECT TOP 10000 [订单ID], [用户类型], [场站名称], [充电桩ID], [充电枪ID], [开始充电时间], [充电完成时间], [充电时长（分钟）], CAST([充电量（度）] AS DECIMAL(18,2)) AS [充电量（度）], [订单总额（元）], [充电电费（元）], [充电服务费（元）], [车牌号] FROM ${tableName} ${whereClause} ORDER BY [${timeField}] ASC`;
            } else {
                sql = `SELECT TOP 10000 [充电订单号], [电站名称], [终端名称], [${timeField}], [充电电量], [充电电费], [充电服务费], [充电费用], [充电时长] FROM ${tableName} WITH (INDEX(idx_${timeField.replace(/[\[\]]/g, '')})) ${whereClause} ORDER BY [${timeField}] ASC`;
            }

                queries.push({
                    device,
                    tableName,
                    timeField,
                    whereClause,
                    sql,
                    isAllStations
                });
            });
            
            if (queries.length === 0) {
                return { ok: false, error: '能科设备只能查询"长沙飞狐四方坪东区站"；滴滴平台只能查询"长沙飞狐四方坪东区站"、"长沙飞狐四方坪西区站"和"长沙飞狐四方坪南区站"，请选择正确的电站' };
            }
            
            return { ok: true, queries, devices, timeField: timeUi, isAllStations };
        }
        let __lastQueryResults = null;

        // 缓存合并查询的所有数据（避免每次翻页都重新查询）
        let __mergedAllData = {
            nkData: [],    // 能科数据
            teldData: [],  // 特来电数据
            didiData: []   // 滴滴数据
        };

        // 多设备查询的统计结果（按站点分组）
        let __multiDeviceStats = {
            byStation: {}, // { stationName: { teld: {...}, nk: {...}, didi: {...} } }
            total: null
        };
        
        // 简化的多设备查询：只显示统计结果，不显示表格数据
        async function runMultiDeviceQuery(build) {
            const resultContent = document.getElementById('query-result-content');
            setExportEnabled(false);
            __pagination.enabled = false;
            renderPagination();
            
            // 强制清空表格内容（同步方式，立即生效，使用最彻底的方式）
            if (resultContent) {
                
                // 也清空 stats-container 之后可能插入的表格元素
                const statsContainer = document.getElementById('stats-container');
                if (statsContainer && statsContainer.nextElementSibling && statsContainer.nextElementSibling !== resultContent) {
                    const tableElement = statsContainer.nextElementSibling;
                    if (tableElement && tableElement.tagName === 'DIV' && tableElement.querySelector('table')) {
                        tableElement.remove();
                    }
                }
                
                // 使用最彻底的方式清空（先移除所有子节点，再清空innerHTML）
                // 1. 使用 replaceChildren() 清除所有子节点（这是最彻底的方式）
                resultContent.replaceChildren();
                // 2. 清空innerHTML
                resultContent.innerHTML = '';
                // 3. 清空textContent
                resultContent.textContent = '';
                // 4. 强制浏览器立即重新渲染
                void resultContent.offsetHeight;
                // 5. 再次检查并清除所有子元素（双重保险）
                while (resultContent.firstChild) {
                    resultContent.removeChild(resultContent.firstChild);
                }
                // 6. 再次确认清空
                if (resultContent.innerHTML) {
                    resultContent.innerHTML = '';
                }
                // 7. 设置加载提示（等待统计数据加载完成后加载表格数据）
                // 注意：这里不设置提示信息，因为统计加载完成后会立即加载表格数据
            }
            
            // 确保统计容器显示正确（runStationQuery已经设置，这里不再重复设置，避免样式冲突）
            
            // 清空缓存和统计
            __mergedAllData = { nkData: [], teldData: [], didiData: [] };
            __multiDeviceStats = { byStation: {}, total: null };
            __statsTotals = null;

            // 分别查询每个设备
            const nkQuery = build.queries.find(q => q.device === '能科');
            const teldQuery = build.queries.find(q => q.device === '特来电');
            const didiQuery = build.queries.find(q => q.device === '滴滴');

            if (!nkQuery && !teldQuery && !didiQuery) {
                resultContent.innerHTML = '<div style="color:#c00;">查询配置错误</div>';
                return;
            }

            // 查询总数并设置分页
            let nkTotal = 0, teldTotal = 0, didiTotal = 0;

            try {
                // 查询能科总数
                if (nkQuery) {
                    const nkCountSql = `SELECT COUNT(1) AS total FROM ${nkQuery.tableName} ${nkQuery.whereClause}`;
                    const nkCountRes = await callSqlWithRetry(nkCountSql, 3, 600).catch(() => ({ results: [{ total: 0 }] }));
                    nkTotal = Number((nkCountRes && nkCountRes.results && nkCountRes.results[0] && nkCountRes.results[0].total) || 0);
                }

                // 查询特来电总数
                if (teldQuery) {
                    const teldCountSql = `SELECT COUNT(1) AS total FROM ${teldQuery.tableName} ${teldQuery.whereClause}`;
                    const teldCountRes = await callSqlWithRetry(teldCountSql, 3, 600).catch(() => ({ results: [{ total: 0 }] }));
                    teldTotal = Number((teldCountRes && teldCountRes.results && teldCountRes.results[0] && teldCountRes.results[0].total) || 0);
                }

                // 查询滴滴总数
                if (didiQuery) {
                    const didiCountSql = `SELECT COUNT(1) AS total FROM ${didiQuery.tableName} ${didiQuery.whereClause}`;
                    const didiCountRes = await callSqlWithRetry(didiCountSql, 3, 600).catch(() => ({ results: [{ total: 0 }] }));
                    didiTotal = Number((didiCountRes && didiCountRes.results && didiCountRes.results[0] && didiCountRes.results[0].total) || 0);
                }

                // 多设备查询：显示统计结果和表格数据（能科、特来电、滴滴）
                // 设置分页参数
                __pagination.enabled = true;
                __pagination.pageSize = 20;
                __pagination.total = nkTotal + teldTotal + didiTotal;
                __pagination.currentPage = 1;
                __pagination.queries = build.queries;
                __pagination.devices = build.devices;
                __pagination.timeField = build.timeField;
                __pagination.isAllStations = build.isAllStations;
                __pagination.nkTotal = nkTotal;
                __pagination.teldTotal = teldTotal;
                __pagination.didiTotal = didiTotal;
                __pagination.tableName = '[合并]'; // 标记为多设备查询
                __currentDevice = '合并';
                __currentDisplayColumns = DISPLAY_COLUMNS.slice();
                
                // 渲染分页控件
                renderPagination();
                
                // 清空表格内容，显示加载提示（使用强化的清空机制）
                if (resultContent) {
                    // 使用最彻底的方式清空
                    resultContent.replaceChildren();
                    resultContent.innerHTML = '';
                    resultContent.textContent = '';
                    void resultContent.offsetHeight;
                    // 设置加载提示
                    resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> 正在加载数据，请稍候...</div>';
                    void resultContent.offsetHeight;
                }
                
                // 异步加载统计数据（按站点分组），统计完成后再加载表格数据
                loadMultiDeviceStatsByStation(nkQuery, teldQuery, didiQuery, build.isAllStations).then(() => {
                    // 统计完成后，确保表格已清空，然后加载第一页数据
                    if (resultContent) {
                        // 再次确认清空（使用同步方式）
                        resultContent.replaceChildren();
                        resultContent.innerHTML = '';
                        void resultContent.offsetHeight;
                        // 设置加载提示
                        resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> 正在加载数据，请稍候...</div>';
                        void resultContent.offsetHeight;
                    }
                    // 确保分页已启用
                    __pagination.enabled = true;
                    // 加载第一页数据（能科、特来电、滴滴）
                    loadSimpleMergedPage(1).then(() => {
                        // 数据加载完成后，启用导出按钮
                        if (__pagination.total > 0) {
                            setExportEnabled(true);
                        }
                    }).catch(err => {
                        if (resultContent) {
                            resultContent.innerHTML = '<div style="color:#c00; padding:12px;">加载表格数据失败：' + (err.message || '未知错误') + '</div>';
                        }
                    });
                }).catch(err => {
                    if (resultContent) {
                        resultContent.innerHTML = '<div style="color:#c00; padding:12px;">统计加载失败：' + err.message + '</div>';
                    }
                    setExportEnabled(false);
                });
                
            } catch (err) {
                resultContent.innerHTML = '<div style="color:#c00; padding:12px;">查询失败：' + err.message + '</div>';
            }
        }

        // 简化的分页加载（能科、滴滴、特来电按顺序显示）
        async function loadSimpleMergedPage(page) {
            const resultContent = document.getElementById('query-result-content');
            if (!resultContent) {
                return Promise.resolve();
            }

            if (!__pagination.queries || __pagination.queries.length === 0) {
                resultContent.innerHTML = '<div style="color:#c00;">查询配置错误</div>';
                return Promise.resolve();
            }

            // 每次加载前都强制清空表格内容（使用多种方式确保彻底清空）
            resultContent.innerHTML = '';
            resultContent.textContent = '';
            while (resultContent.firstChild) {
                resultContent.removeChild(resultContent.firstChild);
            }
            void resultContent.offsetHeight; // 强制浏览器重新渲染

            // 使用requestAnimationFrame确保清空操作完成
            await new Promise(resolve => requestAnimationFrame(resolve));

            // 第一页时显示"正在加载数据"，后续页面显示"正在加载第X页"
            if (page === 1) {
                resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> 正在加载数据，请稍候...</div>';
            } else {
                resultContent.innerHTML = '<p style="padding:20px; text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> 正在加载第 ' + page + ' 页数据...</p>';
            }

            // 再次确保内容已更新
            void resultContent.offsetHeight;

            const pageSize = __pagination.pageSize;
            const offset = (page - 1) * pageSize;
            const nkTotal = __pagination.nkTotal || 0;
            const didiTotal = __pagination.didiTotal || 0;
            const teldTotal = __pagination.teldTotal || 0;
            const nkQuery = __pagination.queries.find(q => q.device === '能科');
            const didiQuery = __pagination.queries.find(q => q.device === '滴滴');
            const teldQuery = __pagination.queries.find(q => q.device === '特来电');

            try {
                let pageData = [];

                // 判断当前页应该显示哪个设备的数据
                // 顺序：先能科 → 滴滴 → 特来电
                if (nkTotal > 0 && offset < nkTotal) {
                    // 当前页显示能科数据
                    const nkPage = Math.floor(offset / pageSize) + 1;
                    const nkOffset = (nkPage - 1) * pageSize;
                    const nkStartRn = nkOffset + 1;
                    const nkEndRn = Math.min(nkOffset + pageSize, nkTotal);

                    if (nkQuery) {
                        const nkPageSql = `SELECT * FROM (SELECT ROW_NUMBER() OVER (ORDER BY [${nkQuery.timeField}] ASC) AS rn, * FROM ${nkQuery.tableName} ${nkQuery.whereClause}) t WHERE t.rn BETWEEN ${nkStartRn} AND ${nkEndRn}`;
                        const nkResult = await callSqlWithRetry(nkPageSql, 3, 600);

                        // 腾讯云函数返回格式：{results: [...]}
                        if (nkResult && nkResult.results) {
                            let nkRows = nkResult.results.map(row => {
                                const { rn, ...rest } = row;
                                return mapNkRowToTeld(rest);
                            });
                            pageData = nkRows.map(row => ({ ...row, __device: '能科' }));
                        }
                    }
                } else if (didiTotal > 0 && offset < (nkTotal + didiTotal)) {
                    // 当前页显示滴滴数据
                    const didiOffset = offset - nkTotal;
                    const didiPage = Math.floor(didiOffset / pageSize) + 1;
                    const didiPageOffset = (didiPage - 1) * pageSize;
                    const didiStartRn = didiPageOffset + 1;
                    const didiEndRn = Math.min(didiPageOffset + pageSize, didiTotal);

                    if (didiQuery) {
                        const didiPageSql = `SELECT [订单ID], [用户类型], [场站名称], [充电桩ID], [充电枪ID], [开始充电时间], [充电完成时间], [充电时长（分钟）], CAST([充电量（度）] AS DECIMAL(18,2)) AS [充电量（度）], [订单总额（元）], [充电电费（元）], [充电服务费（元）], [车牌号] FROM (SELECT ROW_NUMBER() OVER (ORDER BY [${didiQuery.timeField}] ASC) AS rn, * FROM ${didiQuery.tableName} ${didiQuery.whereClause}) t WHERE t.rn BETWEEN ${didiStartRn} AND ${didiEndRn}`;
                        const didiResult = await callSqlWithRetry(didiPageSql, 3, 600);

                        // 腾讯云函数返回格式：{results: [...]}
                        if (didiResult && didiResult.results) {
                            let didiRows = didiResult.results.map(row => {
                                const { rn, ...rest } = row;
                                return rest;
                            });
                            pageData = didiRows.map(row => ({ ...row, __device: '滴滴' }));
                        }
                    }
                } else if (teldTotal > 0) {
                    // 当前页显示特来电数据
                    const teldOffset = offset - nkTotal - didiTotal;
                    const teldPage = Math.floor(teldOffset / pageSize) + 1;
                    const teldPageOffset = (teldPage - 1) * pageSize;
                    const teldStartRn = teldPageOffset + 1;
                    const teldEndRn = Math.min(teldPageOffset + pageSize, teldTotal);

                    if (teldQuery) {
                        const teldPageSql = `SELECT [电站名称], [终端名称], [充电开始时间], [充电结束时间], [充电电量(度)], [充电电费(元)], [充电服务费(元)], [充电费用(元)], [充电时长(分钟)], [充电前soc], [充电后soc], [判定车牌号], [车辆所属客户] FROM (SELECT ROW_NUMBER() OVER (ORDER BY [${teldQuery.timeField}] ASC) AS rn, * FROM ${teldQuery.tableName} ${teldQuery.whereClause}) t WHERE t.rn BETWEEN ${teldStartRn} AND ${teldEndRn}`;
                        const teldResult = await callSqlWithRetry(teldPageSql, 3, 600);

                        // 腾讯云函数返回格式：{results: [...]}
                        if (teldResult && teldResult.results) {
                            let teldRows = teldResult.results.map(row => {
                                const { rn, ...rest } = row;
                                return rest;
                            });
                            pageData = teldRows.map(row => ({ ...row, __device: '特来电' }));
                        }
                    }
                }

                // 显示结果（不在这里显示统计，统计由updateMultiDeviceStatsDisplay独立显示）
                if (pageData.length === 0) {
                    resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">当前页暂无数据</div>';
                } else {
                    displaySimpleMergedResult(pageData, page);
                }
                // 注意：导出按钮的启用由统计完成后统一控制，这里不启用
                __pagination.currentPage = page;
                __pagination.enabled = true; // 确保分页已启用，以便翻页正常工作
                renderPagination();

                // 返回Promise，以便调用者可以等待完成
                return Promise.resolve();

            } catch (err) {
                resultContent.innerHTML = '<div style="color:#c00; padding:12px;">加载数据失败：' + err.message + '</div>';
                return Promise.reject(err);
            }
        }

        // 加载合并后的分页数据（分开显示：先能科，后特来电）
        async function loadMergedPage(page) {
            const resultContent = document.getElementById('query-result-content');
            if (!resultContent) return;
            
            if (!__pagination.queries || __pagination.queries.length === 0) {
                resultContent.innerHTML = '<div style="color:#c00;">查询配置错误</div>';
                return;
            }
            
            resultContent.innerHTML = '<p>正在加载第 ' + page + ' 页数据...</p>';
            
            const pageSize = __pagination.pageSize;
            const offset = (page - 1) * pageSize;
            
            try {
                // 如果缓存为空，先加载所有数据
                if (__mergedAllData.nkData.length === 0 && __mergedAllData.teldData.length === 0) {
                    
                    // 并行执行所有查询（分批查询以避免超时）
                    const queryResults = await Promise.all(__pagination.queries.map(async query => {
                        try {
                            // 先查询总数
                            const countSql = `SELECT COUNT(1) AS total FROM ${query.tableName} ${query.whereClause}`;
                            const countResult = await callSqlWithRetry(countSql, 3, 600);
                            const total = (countResult && countResult.results && countResult.results[0] && countResult.results[0].total) || 0;
                            
                            
                            if (total === 0) {
                                return { device: query.device, rows: [] };
                            }
                            
                            // 分批查询数据（每批5000条，避免超时）
                            const batchSize = 5000;
                            const batches = Math.ceil(total / batchSize);
                            let allRows = [];
                            let hasError = false;
                            
                            for (let i = 0; i < batches; i++) {
                                try {
                                    const offset = i * batchSize;
                                    // 使用ROW_NUMBER分页（兼容性更好）
                                    const sql = `SELECT * FROM (
                                        SELECT ROW_NUMBER() OVER (ORDER BY [${query.timeField}] ASC) AS rn, * 
                                        FROM ${query.tableName} ${query.whereClause}
                                    ) t WHERE t.rn > ${offset} AND t.rn <= ${offset + batchSize}`;
                                    
                                    const result = await callSqlWithRetry(sql, 3, 600);
                                    
                                    if (!result || !result.success) {
                                        hasError = true;
                                        // 继续查询下一批
                                        continue;
                                    }
                                    
                                    let rows = (result && result.results) ? result.results : [];
                                    // 移除rn列
                                    rows = rows.map(row => {
                                        const { rn, ...rest } = row;
                                        return rest;
                                    });
                                    
                                    allRows = allRows.concat(rows);
                                    
                                    // 如果返回的数据少于批次大小，说明已经是最后一批了
                                    if (rows.length < batchSize) {
                                        break;
                                    }
                                } catch (err) {
                                    hasError = true;
                                    // 继续查询下一批
                                    continue;
                                }
                            }
                            
                            
                            return {
                                device: query.device,
                                rows: allRows,
                                hasError: hasError
                            };
                        } catch (err) {
                            return { device: query.device, rows: [], error: err.message || '查询失败' };
                        }
                    }));
                    
                    // 检查是否有查询错误
                    const errors = queryResults.filter(r => r.error);
                    const hasPartialErrors = queryResults.some(r => r.hasError);
                    
                    if (errors.length > 0) {
                        const errorMsg = errors.map(e => `${e.device}: ${e.error}`).join('; ');
                        resultContent.innerHTML = `<div style="color:#c00; padding:12px;">查询数据失败：${errorMsg}</div>`;
                        return;
                    }
                    
                    if (hasPartialErrors) {
                    }
                    
                    // 分别存储能科和特来电数据
                    queryResults.forEach(result => {
                        if (result.device === '能科') {
                            // 能科数据需要映射字段名
                            __mergedAllData.nkData = result.rows.map(row => mapNkRowToTeld(row));
                        } else {
                            // 特来电数据直接使用
                            __mergedAllData.teldData = result.rows;
                        }
                    });
                    
                    // 分别按时间排序（降序）
                    __mergedAllData.nkData.sort((a, b) => {
                        const timeA = a['充电结束时间'] || '';
                        const timeB = b['充电结束时间'] || '';
                        return timeB.localeCompare(timeA);
                    });
                    __mergedAllData.teldData.sort((a, b) => {
                        const timeA = a['充电结束时间'] || '';
                        const timeB = b['充电结束时间'] || '';
                        return timeB.localeCompare(timeA);
                    });
                    
                    // 保存完整结果供导出使用（合并后的数据）
                    const allMergedData = [...__mergedAllData.nkData, ...__mergedAllData.teldData];
                    __lastQueryResults = {
                        success: true,
                        results: allMergedData,
                        rowCount: allMergedData.length,
                        query: '合并查询'
                    };
                    
                }
                
                // 计算分页显示的数据（简化逻辑：先显示完能科，再显示特来电）
                const nkCount = __mergedAllData.nkData.length;
                const teldCount = __mergedAllData.teldData.length;
                const pageData = [];
                
                
                // 计算能科需要多少完整页面
                const nkFullPages = Math.floor(nkCount / pageSize);
                const nkLastPageCount = nkCount % pageSize;
                const nkTotalPages = nkLastPageCount > 0 ? nkFullPages + 1 : nkFullPages;
                
                // 计算当前页在全局中的位置
                const currentPageInNk = Math.floor(offset / pageSize);
                
                if (offset < nkCount) {
                    // 当前页包含能科数据
                    const nkStartIdx = offset;
                    const nkEndIdx = Math.min(offset + pageSize, nkCount);
                    const nkPageData = __mergedAllData.nkData.slice(nkStartIdx, nkEndIdx);
                    pageData.push(...nkPageData.map(row => ({ ...row, __device: '能科' })));
                    
                    // 如果当前页是能科的最后一页且不足20条，用特来电数据填充
                    if (nkPageData.length < pageSize && currentPageInNk === nkTotalPages - 1) {
                        const remaining = pageSize - nkPageData.length;
                        const teldPageData = __mergedAllData.teldData.slice(0, remaining);
                        pageData.push(...teldPageData.map(row => ({ ...row, __device: '特来电' })));
                    }
                } else {
                    // 当前页只包含特来电数据
                    // 计算特来电的起始索引（考虑能科最后一页可能已经显示了部分特来电数据）
                    let teldStartIdx = 0;
                    if (nkLastPageCount > 0) {
                        // 能科最后一页不足20条，已经显示了部分特来电数据
                        const teldAlreadyShown = pageSize - nkLastPageCount;
                        teldStartIdx = teldAlreadyShown + (offset - nkCount);
                    } else {
                        // 能科数据刚好是完整页面
                        teldStartIdx = offset - nkCount;
                    }
                    
                    const teldEndIdx = Math.min(teldStartIdx + pageSize, teldCount);
                    const teldPageData = __mergedAllData.teldData.slice(teldStartIdx, teldEndIdx);
                    pageData.push(...teldPageData.map(row => ({ ...row, __device: '特来电' })));
                }
                
                // 更新当前设备（用于显示判断）
                __currentDevice = '合并';
                
                
                // 显示结果（自定义显示函数，支持分开显示）
                if (pageData.length === 0) {
                    resultContent.innerHTML = '<div style="color:#c00; padding:12px;">当前页没有数据。能科数据：' + nkCount + '条，特来电数据：' + teldCount + '条</div>';
                } else {
                    displayMergedQueryResult(pageData, page);
                }
                setExportEnabled((__mergedAllData.nkData.length + __mergedAllData.teldData.length) > 0);
                __pagination.currentPage = page;
                renderPagination();
                
            } catch (err) {
                resultContent.innerHTML = '<div style="color:#c00; padding:12px;">加载数据失败：' + err.message + '<br>错误详情请查看控制台</div>';
            }
        }

        // 显示合并查询结果（分开显示能科和特来电）
        function displayMergedQueryResult(data, page) {
            const resultContent = document.getElementById('query-result-content');
            if (!resultContent || !data || data.length === 0) {
                resultContent.innerHTML = '<p>暂无数据</p>';
                return;
            }
            
            // 分离能科和特来电数据
            const nkRows = data.filter(row => row.__device === '能科');
            const teldRows = data.filter(row => row.__device === '特来电');
            
            // 统计显示（如果有多设备统计，使用按站点分组的显示，否则使用简单汇总）
            const statsContainer = document.getElementById('stats-container');
            let statsHTML = '';
            if (statsContainer && statsContainer.innerHTML && statsContainer.innerHTML.includes('按站点分组')) {
                // 已经有按站点分组的统计显示，不需要重复显示
                statsHTML = '';
            } else if (__multiDeviceStats && __multiDeviceStats.byStation && Object.keys(__multiDeviceStats.byStation).length > 0) {
                // 使用按站点分组的统计显示
                updateMultiDeviceStatsDisplay();
                statsHTML = '';
            } else if (__statsTotals) {
                // 使用简单的汇总显示
                statsHTML = `<div id="stats-container" style="margin-bottom: 16px; padding: 12px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #495057;">统计汇总</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 14px;">
                        <div>总记录数：<span style="color: #007bff; font-weight: 600;">${(__statsTotals.total || 0).toLocaleString()}</span></div>
                        <div>充电电费：<span style="color: #28a745; font-weight: 600;">${(__statsTotals.electricityFee || 0).toFixed(2)}</span> 元</div>
                        <div>充电服务费：<span style="color: #28a745; font-weight: 600;">${(__statsTotals.serviceFee || 0).toFixed(2)}</span> 元</div>
                        <div>充电费用：<span style="color: #28a745; font-weight: 600;">${(__statsTotals.chargingFee || 0).toFixed(2)}</span> 元</div>
                        <div>充电电量：<span style="color: #17a2b8; font-weight: 600;">${(__statsTotals.electricity || 0).toFixed(2)}</span> 度</div>
                        <div>充电时长：<span style="color: #6c757d; font-weight: 600;">${(__statsTotals.duration || 0).toFixed(2)}</span> 分钟</div>
                    </div>
                </div>`;
            }
            
            // 构建表格HTML
            let tableHTML = statsHTML;
            tableHTML += '<div style="overflow-x: auto; height: 100%;">';
            
            // 能科数据表格
            if (nkRows.length > 0) {
                tableHTML += '<div style="margin-bottom: 20px;">';
                tableHTML += '<div style="font-weight: 600; margin-bottom: 8px; color: #495057; font-size: 16px; padding: 8px; background-color: #e9ecef; border-radius: 4px;">能科数据</div>';
                tableHTML += buildMergedTable(nkRows, DISPLAY_COLUMNS);
                tableHTML += '</div>';
            }
            
            // 特来电数据表格
            if (teldRows.length > 0) {
                tableHTML += '<div>';
                tableHTML += '<div style="font-weight: 600; margin-bottom: 8px; color: #495057; font-size: 16px; padding: 8px; background-color: #e9ecef; border-radius: 4px;">特来电数据</div>';
                tableHTML += buildMergedTable(teldRows, DISPLAY_COLUMNS);
                tableHTML += '</div>';
            }
            
            tableHTML += '</div>';
            resultContent.innerHTML = tableHTML;
        }

        // 构建合并查询的表格HTML
        function buildMergedTable(data, columns) {
            let html = '<table style="width: 100%; border-collapse: collapse; margin: 0; min-width: 1200px;">';
            html += '<thead><tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">';
            columns.forEach(col => {
                html += `<th style="border: 1px solid #dee2e6; padding: 12px 8px; text-align: left; font-weight: 600; color: #495057; white-space: nowrap; min-width: 120px;">${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.forEach((row, index) => {
                const rowClass = index % 2 === 0 ? 'background-color: #fff;' : 'background-color: #f8f9fa;';
                html += `<tr style="${rowClass}">`;
                columns.forEach(col => {
                    let value = row[col];
                    if (value === null || value === undefined || value === 'NULL') {
                        value = '';
                    }
                    // 处理充电时长格式化
                    if (col === '充电时长(分钟)' && value) {
                        value = formatDuration(value);
                    }
                    html += `<td style="border: 1px solid #dee2e6; padding: 12px 8px; color: #495057; white-space: nowrap; min-width: 120px;">${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        // 显示简化的合并结果（不包含统计，统计独立显示）
        function displaySimpleMergedResult(data, page) {
            const resultContent = document.getElementById('query-result-content');
            if (!resultContent || !data || data.length === 0) {
                resultContent.innerHTML = '<p>暂无数据</p>';
                return;
            }

            // 分离能科、滴滴和特来电数据
            const nkRows = data.filter(row => row.__device === '能科');
            const didiRows = data.filter(row => row.__device === '滴滴');
            const teldRows = data.filter(row => row.__device === '特来电');

            // 构建表格HTML（不包含统计，统计由updateMultiDeviceStatsDisplay独立显示）
            let tableHTML = '<div style="overflow-x: auto; height: 100%;">';

            // 能科数据表格
            if (nkRows.length > 0) {
                tableHTML += '<div style="margin-bottom: 20px;">';
                tableHTML += '<div style="font-weight: 600; margin-bottom: 8px; color: #495057; font-size: 16px; padding: 8px; background-color: #e9ecef; border-radius: 4px;">能科数据</div>';
                tableHTML += buildMergedTable(nkRows, DISPLAY_COLUMNS);
                tableHTML += '</div>';
            }

            // 滴滴数据表格
            if (didiRows.length > 0) {
                tableHTML += '<div style="margin-bottom: 20px;">';
                tableHTML += '<div style="font-weight: 600; margin-bottom: 8px; color: #495057; font-size: 16px; padding: 8px; background-color: #e9ecef; border-radius: 4px;">滴滴数据</div>';
                tableHTML += buildMergedTable(didiRows, DIDI_DISPLAY_COLUMNS);
                tableHTML += '</div>';
            }

            // 特来电数据表格
            if (teldRows.length > 0) {
                tableHTML += '<div>';
                tableHTML += '<div style="font-weight: 600; margin-bottom: 8px; color: #495057; font-size: 16px; padding: 8px; background-color: #e9ecef; border-radius: 4px;">特来电数据</div>';
                tableHTML += buildMergedTable(teldRows, DISPLAY_COLUMNS);
                tableHTML += '</div>';
            }

            tableHTML += '</div>';
            resultContent.innerHTML = tableHTML;
        }

        // 按站点分组加载多设备统计数据
        async function loadMultiDeviceStatsByStation(nkQuery, teldQuery, didiQuery, isAllStations) {
            try {
                const start = toSqlDateTime((document.getElementById('start-datetime') || {}).value, false);
                const end = toSqlDateTime((document.getElementById('end-datetime') || {}).value, true);
                const timeField = (document.getElementById('time-field-select') || {}).value || '充电结束时间';

                // 获取站点信息
                const allBox = document.getElementById('station-all');
                const items = Array.from(document.querySelectorAll('#station-menu .station-group'));
                const checkedGroups = allBox && allBox.checked
                    ? ['east', 'west', 'south', 'gaoling']
                    : items.filter(i => i.checked).map(i => i.getAttribute('data-group'));

                const stationMapToLabel = {
                    east: '长沙飞狐四方坪东区站',
                    west: '长沙飞狐四方坪西区站',
                    south: '长沙飞狐四方坪南区站',
                    gaoling: '长沙飞狐高岭站'
                };

                // 按站点分组统计
                const stationStats = {};

                for (const group of checkedGroups) {
                    const stationName = stationMapToLabel[group];
                    if (!stationName) continue;

                    stationStats[stationName] = { teld: null, nk: null, didi: null };

                    // 统计特来电（所有站点都可以有特来电）
                    if (teldQuery) {
                        // 构建该站点组的WHERE条件（使用新的逻辑）
                        const stationCondition = buildTeldStationCondition([group]);
                        if (stationCondition) {
                            const whereClause = `WHERE ${stationCondition} AND [${timeField}] BETWEEN '${start}' AND '${end}'`;
                            const statsSql = `SELECT
                                COUNT(1) AS total,
                                SUM(CAST([充电电费(元)] AS DECIMAL(18,4))) AS fee_elec,
                                SUM(CAST([充电服务费(元)] AS DECIMAL(18,4))) AS fee_service,
                                SUM(CAST([充电费用(元)] AS DECIMAL(18,4))) AS fee_total,
                                SUM(CAST([充电电量(度)] AS DECIMAL(18,4))) AS kwh_total,
                                SUM(CAST([充电时长(分钟)] AS DECIMAL(18,4))) AS minutes_total
                                FROM [特来电] ${whereClause}`;

                            try {
                                const result = await callSqlWithRetry(statsSql, 3, 600);
                                console.log('特来电统计查询返回:', result);
                                console.log('特来电统计查询返回类型:', typeof result);
                                console.log('特来电统计查询返回的keys:', result ? Object.keys(result) : 'null');
                                console.log('特来电统计查询result.success:', result ? result.success : 'undefined');
                                console.log('特来电统计查询result.results:', result ? result.results : 'undefined');
                                console.log('特来电统计查询result.result:', result ? result.result : 'undefined');

                                // 处理腾讯云函数返回的数据格式
                                let parsedResult = result;

                                // 如果返回的是字符串，尝试解析
                                if (typeof result === 'string') {
                                    try {
                                        parsedResult = JSON.parse(result);
                                    } catch (e) {
                                        console.error('解析特来电统计结果失败:', e);
                                    }
                                }

                                // 如果有 result.result 嵌套，提取出来
                                if (parsedResult && parsedResult.result) {
                                    if (typeof parsedResult.result === 'string') {
                                        try {
                                            parsedResult = JSON.parse(parsedResult.result);
                                        } catch (e) {
                                            console.error('解析嵌套的特来电统计结果失败:', e);
                                        }
                                    } else {
                                        parsedResult = parsedResult.result;
                                    }
                                }

                                // 检查数据格式并提取结果
                                // 腾讯云函数返回格式：{results: [...]} 或 {success: true, results: [...]}
                                if (parsedResult && parsedResult.results && parsedResult.results[0]) {
                                    const row = parsedResult.results[0];
                                    stationStats[stationName].teld = {
                                        total: Number(row.total) || 0,
                                        electricityFee: Number(row.fee_elec) || 0,
                                        serviceFee: Number(row.fee_service) || 0,
                                        chargingFee: Number(row.fee_total) || 0,
                                        electricity: Number(row.kwh_total) || 0,
                                        duration: Number(row.minutes_total) || 0
                                    };
                                    console.log('特来电统计数据已保存:', stationStats[stationName].teld);
                                } else {
                                    console.warn('特来电统计数据格式不正确:', parsedResult);
                                }
                            } catch (err) {
                                console.error('特来电统计查询失败:', err);
                            }
                        }
                    }

                    // 统计能科（只有东区站）
                    if (nkQuery && group === 'east') {
                        const whereClause = `WHERE [${nkQuery.timeField}] BETWEEN '${start}' AND '${end}'`;
                        const statsSql = `SELECT
                            COUNT(1) AS total,
                            SUM(CAST([电费] AS DECIMAL(18,4))) AS fee_elec,
                            SUM(CAST([服务费] AS DECIMAL(18,4))) AS fee_service,
                            SUM(CAST([消费金额] AS DECIMAL(18,4))) AS fee_total,
                            SUM(CAST([充电量] AS DECIMAL(18,4))) AS kwh_total
                            FROM [能科] ${whereClause}`;

                        try {
                            const result = await callSqlWithRetry(statsSql, 3, 600);
                            console.log('能科统计查询返回:', result);

                            // 处理腾讯云函数返回的数据格式
                            let parsedResult = result;

                            // 如果返回的是字符串，尝试解析
                            if (typeof result === 'string') {
                                try {
                                    parsedResult = JSON.parse(result);
                                } catch (e) {
                                    console.error('解析能科统计结果失败:', e);
                                }
                            }

                            // 如果有 result.result 嵌套，提取出来
                            if (parsedResult && parsedResult.result) {
                                if (typeof parsedResult.result === 'string') {
                                    try {
                                        parsedResult = JSON.parse(parsedResult.result);
                                    } catch (e) {
                                        console.error('解析嵌套的能科统计结果失败:', e);
                                    }
                                } else {
                                    parsedResult = parsedResult.result;
                                }
                            }

                            // 检查数据格式并提取结果
                            // 腾讯云函数返回格式：{results: [...]} 或 {success: true, results: [...]}
                            if (parsedResult && parsedResult.results && parsedResult.results[0]) {
                                const row = parsedResult.results[0];
                                stationStats[stationName].nk = {
                                    total: Number(row.total) || 0,
                                    electricityFee: Number(row.fee_elec) || 0,
                                    serviceFee: Number(row.fee_service) || 0,
                                    chargingFee: Number(row.fee_total) || 0,
                                    electricity: Number(row.kwh_total) || 0,
                                    duration: 0 // 能科时长需要单独计算，统一在最后处理
                                };
                                console.log('能科统计数据已保存:', stationStats[stationName].nk);
                            } else {
                                console.warn('能科统计数据格式不正确:', parsedResult);
                            }
                        } catch (err) {
                            console.error('能科统计查询失败:', err);
                        }
                    }

                    // 统计滴滴（东区、西区、南区站）
                    if (didiQuery && (group === 'east' || group === 'west' || group === 'south')) {
                        // 映射站点组到滴滴表中的场站名称
                        const didiStationMap = {
                            'east': '飞狐四方坪东区充电站',
                            'west': '飞狐四方坪西区充电站',
                            'south': '飞狐四方坪南区充电站'
                        };
                        const didiStationName = didiStationMap[group];
                        const didiTimeField = (timeField === '充电开始时间') ? '开始充电时间' : '充电完成时间';
                        const whereClause = `WHERE [场站名称] = N'${didiStationName}' AND [${didiTimeField}] BETWEEN '${start}' AND '${end}'`;
                        const statsSql = `SELECT
                            COUNT(1) AS total,
                            SUM(CASE WHEN ISNUMERIC([充电电费（元）]) = 1 AND [充电电费（元）] IS NOT NULL AND [充电电费（元）] != '' THEN CAST([充电电费（元）] AS DECIMAL(18,4)) ELSE 0 END) AS fee_elec,
                            SUM(CASE WHEN ISNUMERIC([充电服务费（元）]) = 1 AND [充电服务费（元）] IS NOT NULL AND [充电服务费（元）] != '' THEN CAST([充电服务费（元）] AS DECIMAL(18,4)) ELSE 0 END) AS fee_service,
                            SUM(CASE WHEN ISNUMERIC([订单总额（元）]) = 1 AND [订单总额（元）] IS NOT NULL AND [订单总额（元）] != '' THEN CAST([订单总额（元）] AS DECIMAL(18,4)) ELSE 0 END) AS fee_total,
                            SUM(CASE WHEN ISNUMERIC([充电量（度）]) = 1 AND [充电量（度）] IS NOT NULL AND [充电量（度）] != '' THEN CAST([充电量（度）] AS DECIMAL(18,4)) ELSE 0 END) AS kwh_total,
                            SUM(CASE WHEN ISNUMERIC([充电时长（分钟）]) = 1 AND [充电时长（分钟）] IS NOT NULL AND [充电时长（分钟）] != '' THEN CAST([充电时长（分钟）] AS DECIMAL(18,4)) ELSE 0 END) AS minutes_total
                            FROM [滴滴] ${whereClause}`;

                        try {
                            const result = await callSqlWithRetry(statsSql, 3, 600);
                            console.log('滴滴统计查询返回:', result);

                            // 处理腾讯云函数返回的数据格式
                            let parsedResult = result;

                            // 如果返回的是字符串，尝试解析
                            if (typeof result === 'string') {
                                try {
                                    parsedResult = JSON.parse(result);
                                } catch (e) {
                                    console.error('解析滴滴统计结果失败:', e);
                                }
                            }

                            // 如果有 result.result 嵌套，提取出来
                            if (parsedResult && parsedResult.result) {
                                if (typeof parsedResult.result === 'string') {
                                    try {
                                        parsedResult = JSON.parse(parsedResult.result);
                                    } catch (e) {
                                        console.error('解析嵌套的滴滴统计结果失败:', e);
                                    }
                                } else {
                                    parsedResult = parsedResult.result;
                                }
                            }

                            // 检查数据格式并提取结果
                            // 腾讯云函数返回格式：{results: [...]} 或 {success: true, results: [...]}
                            if (parsedResult && parsedResult.results && parsedResult.results[0]) {
                                const row = parsedResult.results[0];
                                stationStats[stationName].didi = {
                                    total: Number(row.total) || 0,
                                    electricityFee: Number(row.fee_elec) || 0,
                                    serviceFee: Number(row.fee_service) || 0,
                                    chargingFee: Number(row.fee_total) || 0,
                                    electricity: Number(row.kwh_total) || 0,
                                    duration: Number(row.minutes_total) || 0
                                };
                                console.log('滴滴统计数据已保存:', stationStats[stationName].didi);
                            } else {
                                console.warn('滴滴统计数据格式不正确:', parsedResult);
                            }
                        } catch (err) {
                            console.error('滴滴统计查询失败:', err);
                        }
                    }
                }
                
                // 等待所有能科时长计算完成（如果有的话）
                const nkDurationPromises = [];
                for (const group of checkedGroups) {
                    if (group === 'east' && nkQuery) {
                        const stationName = stationMapToLabel[group];
                        if (stationStats[stationName] && stationStats[stationName].nk && stationStats[stationName].nk.total > 0) {
                            const whereClause = `WHERE [${nkQuery.timeField}] BETWEEN '${start}' AND '${end}'`;
                            nkDurationPromises.push(
                                calculateNkDuration(whereClause, '[能科]', nkQuery.timeField).then(duration => {
                                    if (stationStats[stationName] && stationStats[stationName].nk) {
                                        stationStats[stationName].nk.duration = duration || 0;
                                    }
                                })
                            );
                        }
                    }
                }
                
                // 等待所有能科时长计算完成
                if (nkDurationPromises.length > 0) {
                    await Promise.all(nkDurationPromises);
                }
                
                // 计算总计
                let total = { total: 0, electricityFee: 0, serviceFee: 0, chargingFee: 0, electricity: 0, duration: 0 };
                Object.values(stationStats).forEach(station => {
                    if (station.teld) {
                        total.total += station.teld.total || 0;
                        total.electricityFee += station.teld.electricityFee || 0;
                        total.serviceFee += station.teld.serviceFee || 0;
                        total.chargingFee += station.teld.chargingFee || 0;
                        total.electricity += station.teld.electricity || 0;
                        total.duration += station.teld.duration || 0;
                    }
                    if (station.nk) {
                        total.total += station.nk.total || 0;
                        total.electricityFee += station.nk.electricityFee || 0;
                        total.serviceFee += station.nk.serviceFee || 0;
                        total.chargingFee += station.nk.chargingFee || 0;
                        total.electricity += station.nk.electricity || 0;
                        total.duration += station.nk.duration || 0;
                    }
                    if (station.didi) {
                        total.total += station.didi.total || 0;
                        total.electricityFee += station.didi.electricityFee || 0;
                        total.serviceFee += station.didi.serviceFee || 0;
                        total.chargingFee += station.didi.chargingFee || 0;
                        total.electricity += station.didi.electricity || 0;
                        total.duration += station.didi.duration || 0;
                    }
                });
                
                __multiDeviceStats.byStation = stationStats;
                __multiDeviceStats.total = total;
                __statsTotals = total; // 兼容原有统计显示

                updateMultiDeviceStatsDisplay();

            } catch (err) {
                // 即使失败也要确保后续流程继续
            }
        }

        // 更新多设备统计显示（按站点分组）
        function updateMultiDeviceStatsDisplay() {
            const statsContainer = document.getElementById('stats-container');
            if (!statsContainer) return;
            
            const stats = __multiDeviceStats;
            
            // 如果统计数据未准备好，显示加载中
            if (!stats || !stats.total || stats.total === null) {
                statsContainer.innerHTML = '<div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 6px; margin-bottom: 15px;"><div style="padding:12px; color:#ff9800; text-align:center;"><i class="fas fa-spinner fa-spin"></i> 统计计算中，请稍候...</div></div>';
                return;
            }
            
            let html = '<div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 6px; margin-bottom: 15px;">';
            html += '<h4 style="margin: 0 0 12px 0; color: #495057;">查询统计</h4>';
            
            // 只显示总计（去掉方框，增大字体）
            html += '<div style="margin-top: 8px;">';
            html += '<div style="font-weight: 600; margin-bottom: 10px; color: #495057; font-size: 18px;">查询总数据</div>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 16px;">';
            html += `<div>总记录数：<span style="color: #007bff; font-weight: 600; font-size: 18px;">${(stats.total.total || 0).toLocaleString()}</span></div>`;
            html += `<div>充电电费：<span style="color: #28a745; font-weight: 600; font-size: 18px;">¥${(stats.total.electricityFee || 0).toFixed(2)}</span></div>`;
            html += `<div>充电服务费：<span style="color: #17a2b8; font-weight: 600; font-size: 18px;">¥${(stats.total.serviceFee || 0).toFixed(2)}</span></div>`;
            html += `<div>充电费用：<span style="color: #dc3545; font-weight: 600; font-size: 18px;">¥${(stats.total.chargingFee || 0).toFixed(2)}</span></div>`;
            html += `<div>充电电量：<span style="color: #6f42c1; font-weight: 600; font-size: 18px;">${(stats.total.electricity || 0).toFixed(2)} 度</span></div>`;
            html += `<div>充电时长：<span style="color: #fd7e14; font-weight: 600; font-size: 18px;">${(stats.total.duration || 0).toFixed(0)} 分钟</span></div>`;
            html += '</div></div>';
            
            html += '</div>';
            statsContainer.innerHTML = html;
        }

        // 加载合并后的统计数据
        async function loadMergedStats(queries) {
            try {
                const statsPromises = queries.map(async query => {
                    if (query.device === '能科') {
                        // 能科统计
                        const statsSql = `SELECT 
                            COUNT(1) AS total,
                            SUM(CAST([电费] AS DECIMAL(18,4))) AS fee_elec,
                            SUM(CAST([服务费] AS DECIMAL(18,4))) AS fee_service,
                            SUM(CAST([消费金额] AS DECIMAL(18,4))) AS fee_total,
                            SUM(CAST([充电量] AS DECIMAL(18,4))) AS kwh_total
                            FROM ${query.tableName} ${query.whereClause}`;
                        
                        const statsRes = await callSqlWithRetry(statsSql, 3, 800).catch(() => ({ results: [{}] }));
                        const row = (statsRes && statsRes.results && statsRes.results[0]) || {};
                        
                        return {
                            total: Number(row.total) || 0,
                            electricityFee: Number(row.fee_elec) || 0,
                            serviceFee: Number(row.fee_service) || 0,
                            chargingFee: Number(row.fee_total) || 0,
                            electricity: Number(row.kwh_total) || 0,
                            duration: 0 // 能科时长需要单独计算
                        };
                    } else {
                        // 特来电统计
                        const statsSql = `SELECT 
                            COUNT(1) AS total,
                            SUM(CAST([充电电费(元)] AS DECIMAL(18,4))) AS fee_elec,
                            SUM(CAST([充电服务费(元)] AS DECIMAL(18,4))) AS fee_service,
                            SUM(CAST([充电费用(元)] AS DECIMAL(18,4))) AS fee_total,
                            SUM(CAST([充电电量(度)] AS DECIMAL(18,4))) AS kwh_total,
                            SUM(CAST([充电时长(分钟)] AS DECIMAL(18,4))) AS minutes_total
                            FROM ${query.tableName} ${query.whereClause}`;
                        
                        const statsRes = await callSqlWithRetry(statsSql, 3, 800).catch(() => ({ results: [{}] }));
                        const row = (statsRes && statsRes.results && statsRes.results[0]) || {};
                        
                        return {
                            total: Number(row.total) || 0,
                            electricityFee: Number(row.fee_elec) || 0,
                            serviceFee: Number(row.fee_service) || 0,
                            chargingFee: Number(row.fee_total) || 0,
                            electricity: Number(row.kwh_total) || 0,
                            duration: Number(row.minutes_total) || 0
                        };
                    }
                });
                
                const allStats = await Promise.all(statsPromises);
                
                // 合并所有统计数据
                __statsTotals = allStats.reduce((acc, stats) => ({
                    total: acc.total + stats.total,
                    electricityFee: acc.electricityFee + stats.electricityFee,
                    serviceFee: acc.serviceFee + stats.serviceFee,
                    chargingFee: acc.chargingFee + stats.chargingFee,
                    electricity: acc.electricity + stats.electricity,
                    duration: acc.duration + stats.duration
                }), {
                    total: 0,
                    electricityFee: 0,
                    serviceFee: 0,
                    chargingFee: 0,
                    electricity: 0,
                    duration: 0
                });
                
                updateStatsOnly();
                
                // 如果能科存在，异步计算能科充电时长
                const nkQuery = queries.find(q => q.device === '能科');
                if (nkQuery && __statsTotals.total > 0) {
                    // 保存特来电已有的duration
                    const teldDuration = __statsTotals.duration;
                    // 计算能科充电时长
                    calculateNkDuration(nkQuery.whereClause, nkQuery.tableName, nkQuery.timeField).then(nkDuration => {
                        // 将能科的时长加到总时长中
                        if (__statsTotals) {
                            __statsTotals.duration = teldDuration + (nkDuration || 0);
                            updateStatsOnly();
                        }
                    }).catch(err => {
                    });
                }
                
            } catch (err) {
            }
        }

        function runStationQuery() {
            // 清空统计容器显示
            const statsContainer = document.getElementById('stats-container');
            if (statsContainer) {
                statsContainer.innerHTML = '<div style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 6px; margin-bottom: 15px;"><div style="padding:12px; color:#ff9800; text-align:center;"><i class="fas fa-spinner fa-spin"></i> 统计计算中，请稍候...</div></div>';
            }

            // 清空表格内容
            const resultContent = document.getElementById('query-result-content');
            clearElementContent(resultContent);

            // 清空上一次查询的统计数据
            __statsTotals = null;
            __multiDeviceStats = { byStation: {}, total: null };
            
            // 验证时间：结束时间不能小于开始时间
            const startEl = document.getElementById('start-datetime');
            const endEl = document.getElementById('end-datetime');
            if (startEl && endEl && startEl.value && endEl.value) {
                const startStr = startEl.value.trim();
                const endStr = endEl.value.trim();
                if (startStr && endStr) {
                    const startDate = new Date(startStr);
                    const endDate = new Date(endStr);
                    if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime()) && endDate < startDate) {
                        if (resultContent) {
                            resultContent.innerHTML = '<div style="color:#c00; padding:12px; background:#f8d7da; border:1px solid #f5c6cb; border-radius:6px;">充电结束时间不能小于充电开始时间</div>';
                        }
                        setExportEnabled(false);
                        __pagination.enabled = false;
                        renderPagination();
                        return;
                    }
                }
            }
            
            const build = buildStationQuery();
            if (!build.ok) {
                if (resultContent) {
                    resultContent.innerHTML = '<div style="color:#c00;">' + build.error + '</div>';
                }
                setExportEnabled(false);
                __pagination.enabled = false;
                renderPagination();
                return;
            }
            
            // 更新当前条件显示
            updateCurrentConditions();

            function singleQueryFallback() {
                resultContent.innerHTML = '<p>正在执行查询...</p>';
                setExportEnabled(false);
                return fetch('https://1257663610-833b483ie5.ap-guangzhou.tencentscf.com', {
                    method: 'POST',
                    headers: {
                        'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                        'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ query: build.sql })
                })
                .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status + ': ' + r.statusText); return r.json(); })
                .then(result => {
                    const payload = (result && result.result) ? result.result : result;
                    if (payload && payload.success) {
                        __lastQueryResults = payload;
                        displayQueryResult(payload);
                        setExportEnabled(!!(payload && payload.results && payload.results.length));
                        __pagination.enabled = false;
                        renderPagination();
                    } else {
                        resultContent.innerHTML = `
                            <div style=\"background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;\">\n                                <h4 style=\"margin:0 0 6px 0;\">查询失败</h4>\n                                <div>${(payload && payload.message) || '未知错误'}</div>\n                            </div>`;
                        setExportEnabled(false);
                        __pagination.enabled = false;
                        renderPagination();
                    }
                })
                .catch(err => {
                    resultContent.innerHTML = `
                        <div style=\"background:#f8d7da; border:1px solid #f5c6cb; padding:12px; border-radius:6px; color:#721c24;\">\n                            <h4 style=\"margin:0 0 6px 0;\">查询失败</h4>\n                            <div>${err.message || '未知错误'}</div>\n                        </div>`;
                    setExportEnabled(false);
                    __pagination.enabled = false;
                    renderPagination();
                });
            }

            // 判断是否需要合并查询：当选择多个设备时需要合并（特来电、能科、滴滴的任意组合）
            const needMerge = build.devices && build.devices.length >= 2;
            
            if (needMerge && build.queries && build.queries.length > 1) {
                // 简化的多设备查询：只显示统计结果，不显示表格数据
                // 立即强制清空表格（同步方式，立即生效，避免异步操作导致旧数据残留）
                if (resultContent) {
                    
                    // 也清空 stats-container 之后可能插入的表格元素（updateTableOnly 可能在那里插入了表格）
                    const statsContainer = document.getElementById('stats-container');
                    if (statsContainer && statsContainer.nextElementSibling && statsContainer.nextElementSibling !== resultContent) {
                        const tableElement = statsContainer.nextElementSibling;
                        if (tableElement && tableElement.tagName === 'DIV' && tableElement.querySelector('table')) {
                            tableElement.remove();
                        }
                    }
                    
                    // 使用多种方式确保彻底清空（包括清除所有子节点）
                    // 1. 先移除所有子元素（包括可能的表格）
                    while (resultContent.firstChild) {
                        resultContent.removeChild(resultContent.firstChild);
                    }
                    // 2. 使用 replaceChildren 清除所有子节点（最彻底）
                    resultContent.replaceChildren();
                    // 3. 清空innerHTML
                    resultContent.innerHTML = '';
                    // 4. 清空textContent
                    resultContent.textContent = '';
                    // 5. 强制浏览器立即重新渲染
                    void resultContent.offsetHeight;
                    // 6. 检查并清除可能的子元素（防止有隐藏的节点）
                    if (resultContent.children.length > 0) {
                        Array.from(resultContent.children).forEach(child => child.remove());
                    }
                    // 7. 再次确认清空
                    if (resultContent.innerHTML) {
                        resultContent.innerHTML = '';
                    }
                    // 8. 设置加载提示（等待统计数据加载完成后加载表格数据）
                    resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> 正在加载数据，请稍候...</div>';
                    // 9. 再次强制浏览器重新渲染
                    void resultContent.offsetHeight;
                }
                // 调用多设备查询（异步，但不等待，避免阻塞）
                runMultiDeviceQuery(build).catch(err => {
                    if (resultContent) {
                        resultContent.innerHTML = '<div style="color:#c00; padding:12px;">多设备查询失败：' + (err.message || '未知错误') + '</div>';
                    }
                });
                // 多设备查询时，直接返回，不执行单设备查询逻辑
                return;
            } else {
                // 单设备查询：使用原来的查询逻辑
                const query = build.queries && build.queries.length > 0 ? build.queries[0] : null;
                if (!query) {
                    resultContent.innerHTML = '<div style="color:#c00;">查询配置错误</div>';
                    return;
                }
                
                const device = query.device;
                const tableName = query.tableName;
                const timeField = query.timeField;
                const whereClause = query.whereClause;
                
                // 使用原来的单设备查询逻辑
            setExportEnabled(false);
            // 单设备查询时，确保表格已清空（runStationQuery开始时已清空，这里再次确认）
            // 不再显示"准备加载第 1 页..."，而是等待统计查询结果来决定显示什么内容
            if (resultContent) {
                resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> 正在查询数据，请稍候...</div>';
            }

                const timeFieldSel = timeField;
                const sqlNoOrder = query.sql.replace(/ORDER\s+BY[\s\S]*$/i, '').trim();
            const orderByFinal = `ORDER BY [${timeFieldSel}] ASC`;

                    __pagination.enabled = true;
                    __pagination.sqlNoOrder = sqlNoOrder;
                    __pagination.orderByFinal = orderByFinal;
                    __pagination.pageSize = 20;
            __pagination.total = 0;
                    __pagination.currentPage = 1;
                __pagination.whereClause = whereClause;
                __pagination.timeField = timeFieldSel;
                __pagination.tableName = tableName;
                __currentDevice = device;
                __pagination.queries = null; // 单设备查询不需要queries
                
                if (device === '能科') {
                    __pagination.selectCols = '*';
                    __currentDisplayColumns = ['卡号','充电桩名称','开始日期时间','结束日期时间','充电量','电费','服务费','消费金额','充电时长','开始SOC','结束SOC','车牌号','持卡人'];
                } else if (device === '滴滴') {
                    __pagination.selectCols = '[订单ID], [用户类型], [场站名称], [充电桩ID], [充电枪ID], [开始充电时间], [充电完成时间], [充电时长（分钟）], CAST([充电量（度）] AS DECIMAL(18,2)) AS [充电量（度）], [订单总额（元）], [充电电费（元）], [充电服务费（元）], [车牌号]';
                    __currentDisplayColumns = DIDI_DISPLAY_COLUMNS.slice();
                } else {
                    __pagination.selectCols = '[电站名称], [终端名称], [充电开始时间], [充电结束时间], [充电电量(度)], [充电电费(元)], [充电服务费(元)], [充电费用(元)], [充电时长(分钟)], [充电前soc], [充电后soc], [判定车牌号], [车辆所属客户]';
                    __currentDisplayColumns = DISPLAY_COLUMNS.slice();
                }

            // 先渲染第一页
            renderPagination();
            goToPage(1);

                // 异步统计查询
                if (device === '能科') {
                    const statsSql = `SELECT
                        COUNT(1) AS total,
                        SUM(CAST([电费] AS DECIMAL(18,4))) AS fee_elec,
                        SUM(CAST([服务费] AS DECIMAL(18,4))) AS fee_service,
                        SUM(CAST([消费金额] AS DECIMAL(18,4))) AS fee_total,
                        SUM(CAST([充电量] AS DECIMAL(18,4))) AS kwh_total
                        FROM ${tableName} ${whereClause}`;

                    callSqlWithRetry(statsSql, 3, 800).then(statsRes => {
                        const row = (statsRes && statsRes.results && statsRes.results[0]) || {};
                        const total = Number(row.total) || 0;
                        const sumFee = Number(row.fee_elec) || 0;
                        const sumService = Number(row.fee_service) || 0;
                        const sumAmount = Number(row.fee_total) || 0;
                        const sumKwh = Number(row.kwh_total) || 0;

                        __pagination.total = total;
                renderPagination();

                        __statsTotals = {
                            total: total,
                            electricityFee: sumFee,
                            serviceFee: sumService,
                            chargingFee: sumAmount,
                            electricity: sumKwh,
                            duration: 0
                        };
                        updateStatsOnly();

                        // 如果没有数据，显示提示信息
                        if (total === 0) {
                            if (resultContent) {
                                resultContent.innerHTML = `
                                    <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 4px; color: #0c5460; text-align: center;">
                                        <h4>查询完成</h4>
                                        <p>未找到符合条件的数据</p>
                                    </div>`;
                            }
                        } else if (total > 0) {
                            calculateNkDuration(whereClause, tableName, timeFieldSel).then(duration => {
                                if (__statsTotals) {
                                    __statsTotals.duration = duration || 0;
                                    updateStatsOnly();
                                }
                            });
                        }
            }).catch(err => {
                    });
                } else if (device === '滴滴') {
                    const statsSql = `SELECT
                        COUNT(1) AS total,
                        SUM(CASE WHEN ISNUMERIC([充电电费（元）]) = 1 AND [充电电费（元）] IS NOT NULL AND [充电电费（元）] != '' THEN CAST([充电电费（元）] AS DECIMAL(18,4)) ELSE 0 END) AS fee_elec,
                        SUM(CASE WHEN ISNUMERIC([充电服务费（元）]) = 1 AND [充电服务费（元）] IS NOT NULL AND [充电服务费（元）] != '' THEN CAST([充电服务费（元）] AS DECIMAL(18,4)) ELSE 0 END) AS fee_service,
                        SUM(CASE WHEN ISNUMERIC([订单总额（元）]) = 1 AND [订单总额（元）] IS NOT NULL AND [订单总额（元）] != '' THEN CAST([订单总额（元）] AS DECIMAL(18,4)) ELSE 0 END) AS fee_total,
                        SUM(CASE WHEN ISNUMERIC([充电量（度）]) = 1 AND [充电量（度）] IS NOT NULL AND [充电量（度）] != '' THEN CAST([充电量（度）] AS DECIMAL(18,4)) ELSE 0 END) AS kwh_total,
                        SUM(CASE WHEN ISNUMERIC([充电时长（分钟）]) = 1 AND [充电时长（分钟）] IS NOT NULL AND [充电时长（分钟）] != '' THEN CAST([充电时长（分钟）] AS DECIMAL(18,4)) ELSE 0 END) AS minutes_total
                        FROM ${tableName} ${whereClause}`;

                    callSqlWithRetry(statsSql, 3, 800).then(statsRes => {
                        const row = (statsRes && statsRes.results && statsRes.results[0]) || {};
                        const total = Number(row.total) || 0;

                        __pagination.total = total;
                        renderPagination();

                        __statsTotals = {
                            total: total,
                            electricityFee: Number(row.fee_elec) || 0,
                            serviceFee: Number(row.fee_service) || 0,
                            chargingFee: Number(row.fee_total) || 0,
                            electricity: Number(row.kwh_total) || 0,
                            duration: Number(row.minutes_total) || 0
                        };
                        updateStatsOnly();

                        // 如果没有数据，显示提示信息
                        if (total === 0) {
                            if (resultContent) {
                                resultContent.innerHTML = `
                                    <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 4px; color: #0c5460; text-align: center;">
                                        <h4>查询完成</h4>
                                        <p>未找到符合条件的数据</p>
                                    </div>`;
                            }
                        }
                    }).catch(err => {
                    });
                } else {
                    const statsSql = `SELECT
                        COUNT(1) AS total,
                        SUM(CAST([充电电费(元)] AS DECIMAL(18,4))) AS fee_elec,
                        SUM(CAST([充电服务费(元)] AS DECIMAL(18,4))) AS fee_service,
                        SUM(CAST([充电费用(元)] AS DECIMAL(18,4))) AS fee_total,
                        SUM(CAST([充电电量(度)] AS DECIMAL(18,4))) AS kwh_total,
                        SUM(CAST([充电时长(分钟)] AS DECIMAL(18,4))) AS minutes_total
                        FROM ${tableName} ${whereClause}`;

                    callSqlWithRetry(statsSql, 3, 800).then(statsRes => {
                        const row = (statsRes && statsRes.results && statsRes.results[0]) || {};
                        const total = Number(row.total) || 0;

                        __pagination.total = total;
                        renderPagination();

                        __statsTotals = {
                            total: total,
                            electricityFee: Number(row.fee_elec) || 0,
                            serviceFee: Number(row.fee_service) || 0,
                            chargingFee: Number(row.fee_total) || 0,
                            electricity: Number(row.kwh_total) || 0,
                            duration: Number(row.minutes_total) || 0
                        };
                        updateStatsOnly();

                        // 如果没有数据，显示提示信息
                        if (total === 0) {
                            if (resultContent) {
                                resultContent.innerHTML = `
                                    <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; border-radius: 4px; color: #0c5460; text-align: center;">
                                        <h4>查询完成</h4>
                                        <p>未找到符合条件的数据</p>
                                    </div>`;
                            }
                        }
                    }).catch(err => {
                    });
                }
            }

        }

        // 判断是否为单选（电站和充电平台都是单选）
        function isSingleSelection() {
            // 检查电站选择
            const stationAllBox = document.getElementById('station-all');
            const stationItems = Array.from(document.querySelectorAll('#station-menu .station-group'));
            const checkedStations = stationItems.filter(i => i.checked);
            const isStationSingle = !(stationAllBox && stationAllBox.checked) && checkedStations.length === 1;
            
            // 检查充电平台选择
            const deviceItems = Array.from(document.querySelectorAll('#device-menu .device-option'));
            const checkedDevices = deviceItems.filter(i => i.checked);
            const isDeviceSingle = checkedDevices.length === 1;
            
            return isStationSingle && isDeviceSingle;
        }

        // 显示导出选项对话框
        function showExportOptions(pageType) {
            const exportBtn = pageType === 'charging' ? document.getElementById('export-btn') : document.getElementById('zh-export-btn');
            if (exportBtn && exportBtn.disabled) {
                return;
            }
            
            const total = pageType === 'charging' ? (__pagination ? __pagination.total : 0) : (__zhPagination ? __zhPagination.total : 0);
            
            if (total === 0) {
                alert('没有可导出的数据');
                return;
            }
            
            // 判断是否为单选
            const isSingle = pageType === 'charging' ? isSingleSelection() : true; // 综合数据页面暂时保持原逻辑
            
            const dialog = document.createElement('div');
            dialog.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;';
            
            let buttonsHTML = '';
            if (isSingle) {
                // 单选：显示两个按钮
                buttonsHTML = `
                    <button id="export-current-btn" style="flex:1; padding:10px 16px; background:#007bff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px;">导出当前页（${pageType === 'charging' ? (__pagination ? __pagination.pageSize : 20) : (__zhPagination ? __zhPagination.pageSize : 20)}条）</button>
                    <button id="export-all-btn" style="flex:1; padding:10px 16px; background:#28a745; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px;">导出全部数据（${total.toLocaleString()}条）</button>
                `;
            } else {
                // 多选/全选：只显示导出当前页按钮
                buttonsHTML = `
                    <button id="export-current-btn" style="width:100%; padding:10px 16px; background:#007bff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px;">导出当前页（${pageType === 'charging' ? (__pagination ? __pagination.pageSize : 20) : (__zhPagination ? __zhPagination.pageSize : 20)}条）</button>
                `;
            }
            
            dialog.innerHTML = `
                <div style="background:#fff; padding:24px; border-radius:8px; min-width:400px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                    <h3 style="margin:0 0 16px 0; font-size:18px; color:#333;">导出选项</h3>
                    <p style="margin:0 0 20px 0; color:#666; font-size:14px;">共 ${total.toLocaleString()} 条记录</p>
                    <div style="display:flex; gap:12px;">
                        ${buttonsHTML}
                    </div>
                    <button id="cancel-export-btn" style="margin-top:12px; width:100%; padding:8px 16px; background:#6c757d; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px;">取消</button>
                </div>
            `;
            document.body.appendChild(dialog);
            
            document.getElementById('export-current-btn').onclick = () => {
                document.body.removeChild(dialog);
                if (pageType === 'charging') {
                    exportQueryToExcel(false);
                } else {
                    exportZhToExcel(false);
                }
            };
            
            const exportAllBtn = document.getElementById('export-all-btn');
            if (exportAllBtn) {
                exportAllBtn.onclick = () => {
                    document.body.removeChild(dialog);
                    if (pageType === 'charging') {
                        exportQueryToExcel(true);
                    } else {
                        exportZhToExcel(true);
                    }
                };
            }
            
            document.getElementById('cancel-export-btn').onclick = () => {
                document.body.removeChild(dialog);
            };
        }

        // 充电数据导出Excel（导出原表所有列）
        function exportQueryToExcel(exportAll = false) {
            if (!exportAll) {
                // 导出当前页
                const isSingle = isSingleSelection();
                const isMultiDevice = (__currentDevice === '合并' || (__pagination && __pagination.queries && __pagination.queries.length > 1));
                
                if (!isSingle || isMultiDevice) {
                    // 多选/全选或多设备查询：导出当前页显示的20行数据
                    const resultContent = document.getElementById('query-result-content');
                    if (!resultContent) {
                        alert('没有可导出的数据');
                        return;
                    }
                    
                    // 从表格中提取数据
                    const table = resultContent.querySelector('table');
                    if (!table) {
                        alert('没有找到表格数据');
                        return;
                    }
                    
                    // 提取表头
                    const headers = [];
                    const headerRow = table.querySelector('thead tr');
                    if (headerRow) {
                        headerRow.querySelectorAll('th').forEach(th => {
                            headers.push(th.textContent.trim());
                        });
                    }
                    
                    // 提取数据行
                    const rows = [];
                    const tbody = table.querySelector('tbody');
                    if (tbody) {
                        tbody.querySelectorAll('tr').forEach(tr => {
                            const row = {};
                            tr.querySelectorAll('td').forEach((td, index) => {
                                if (headers[index]) {
                                    row[headers[index]] = td.textContent.trim();
                                }
                            });
                            rows.push(row);
                        });
                    }
                    
                    if (rows.length === 0) {
                        alert('当前页没有数据可导出');
                        return;
                    }
                    
                    const ws = XLSX.utils.json_to_sheet(rows);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, '充电数据查询');
                    const currentPage = __pagination ? __pagination.currentPage : 1;
                    XLSX.writeFile(wb, `充电数据查询_第${currentPage}页.xlsx`);
                    alert(`导出成功！共导出 ${rows.length} 条数据。`);
                    return;
                }
                
                // 单选：从数据库查询当前页的所有列
                const tableName = __pagination.tableName || '';
                const whereClause = __pagination.whereClause || '';
                const timeField = __pagination.timeField || '充电结束时间';
                
                if (!tableName || !whereClause) {
                    alert('没有可导出的数据，请先执行查询');
                    return;
                }
                
                // 查询当前页的所有列（使用*而不是过滤后的列）
                const orderByFinal = __pagination.orderByFinal || `ORDER BY [${timeField}] DESC`;
                const currentPage = __pagination.currentPage || 1;
                const pageSize = __pagination.pageSize || 20;
                const offset = (currentPage - 1) * pageSize;
                const startRn = offset + 1;
                const endRn = offset + pageSize;
                
                const innerFrom = `FROM ${tableName} ${whereClause}`;
                const overOrder = orderByFinal;
                const dataSql = `SELECT * FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                
                // 显示加载提示
                alert('正在查询原表数据，请稍候...');
                
                callSqlWithRetry(dataSql).then(dataResult => {
                    if (dataResult && dataResult.results) {
                        // 移除rn列
                        const rows = dataResult.results.map(row => {
                            const filtered = {};
                            Object.keys(row).forEach(key => {
                                if (key !== 'rn') {
                                    filtered[key] = row[key];
                                }
                            });
                            return filtered;
                        });
                        
                        const ws = XLSX.utils.json_to_sheet(rows);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, '充电数据查询');
                        XLSX.writeFile(wb, `充电数据查询_第${currentPage}页.xlsx`);
                    } else {
                        alert('导出失败：查询结果为空');
                    }
                }).catch(err => {
                    alert('导出失败：' + (err.message || '未知错误'));
                });
                return;
            }
            
            // 批量导出全部数据：使用原表所有列
            const total = __pagination ? __pagination.total : 0;
            if (total === 0) {
                alert('没有可导出的数据');
                return;
            }
            
            const tableName = __pagination.tableName || '';
            const whereClause = __pagination.whereClause || '';
            const timeField = __pagination.timeField || '充电结束时间';
            
            // 显示进度对话框
            const progressDialog = document.createElement('div');
            progressDialog.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;';
            progressDialog.innerHTML = `
                <div style="background:#fff; padding:24px; border-radius:8px; min-width:400px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                    <h3 style="margin:0 0 16px 0; font-size:18px; color:#333;">正在导出全部数据</h3>
                    <div style="margin-bottom:8px;">
                        <div id="export-progress-text" style="font-size:14px; color:#666; margin-bottom:8px;">准备中...</div>
                        <div style="background:#e9ecef; border-radius:4px; height:24px; overflow:hidden;">
                            <div id="export-progress-bar" style="background:#28a745; height:100%; width:0%; transition:width 0.3s; display:flex; align-items:center; justify-content:center; color:#fff; font-size:12px; font-weight:bold;">0%</div>
                        </div>
                    </div>
                    <button id="cancel-export-progress-btn" style="margin-top:12px; width:100%; padding:8px 16px; background:#dc3545; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px;">取消导出</button>
                </div>
            `;
            document.body.appendChild(progressDialog);
            
            let cancelled = false;
            document.getElementById('cancel-export-progress-btn').onclick = () => {
                cancelled = true;
                document.body.removeChild(progressDialog);
            };
            
            // 批量查询并导出
            (async () => {
                try {
                    const batchSize = 5000; // 每批5000条
                    const totalBatches = Math.ceil(total / batchSize);
                    let allRows = [];
                    
                    const innerFrom = `FROM ${tableName} ${whereClause}`;
                    const overOrder = `ORDER BY [${timeField}] DESC`;
                    
                    for (let batch = 0; batch < totalBatches && !cancelled; batch++) {
                        const offset = batch * batchSize;
                        const startRn = offset + 1;
                        const endRn = Math.min(total, offset + batchSize);
                        
                        // 更新进度
                        const progress = Math.round(((batch + 1) / totalBatches) * 100);
                        document.getElementById('export-progress-text').textContent = `正在查询第 ${batch + 1}/${totalBatches} 批数据（已获取 ${allRows.length.toLocaleString()} 条）...`;
                        document.getElementById('export-progress-bar').style.width = progress + '%';
                        document.getElementById('export-progress-bar').textContent = progress + '%';
                        
                        // 构建分页SQL（使用*查询所有列）
                        const pageSql = `SELECT * FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                        
                        const result = await callSqlWithRetry(pageSql, 3, 800);
                        if (result && result.results) {
                            // 移除rn列
                            const cleanedResults = result.results.map(row => {
                                const filtered = {};
                                Object.keys(row).forEach(key => {
                                    if (key !== 'rn') {
                                        filtered[key] = row[key];
                                    }
                                });
                                return filtered;
                            });
                            allRows = allRows.concat(cleanedResults);
                        }
                    }
                    
                    if (cancelled) {
                        return;
                    }
                    
                    // 生成Excel
                    document.getElementById('export-progress-text').textContent = '正在生成Excel文件...';
                    document.getElementById('export-progress-bar').style.width = '95%';
                    document.getElementById('export-progress-bar').textContent = '95%';
                    
                    const ws = XLSX.utils.json_to_sheet(allRows);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, '充电数据查询');
                    XLSX.writeFile(wb, `充电数据查询_全部_${total.toLocaleString()}条.xlsx`);
                    
                    document.getElementById('export-progress-text').textContent = '导出完成！';
                    document.getElementById('export-progress-bar').style.width = '100%';
                    document.getElementById('export-progress-bar').textContent = '100%';
                    
                    setTimeout(() => {
                        document.body.removeChild(progressDialog);
                        alert(`导出成功！共导出 ${allRows.length.toLocaleString()} 条数据。`);
                    }, 500);
                    
                } catch (e) {
                    document.body.removeChild(progressDialog);
                    alert('导出失败：' + (e.message || '未知错误'));
                }
            })();
        }

        // ========= 电费账单页面相关函数 =========
        
        // 客户号选择相关函数
        function toggleCustomerMenu() {
            const menu = document.getElementById('customer-menu');
            if (!menu) return;
            menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
        }

        function onToggleAllCustomers() {
            const allBox = document.getElementById('customer-all');
            const items = document.querySelectorAll('#customer-menu .customer-group');
            const checked = allBox ? allBox.checked : false;
            items.forEach(item => { item.checked = checked; });
            updateCustomerDisplay();
        }

        function updateCustomerDisplay() {
            const allBox = document.getElementById('customer-all');
            const items = Array.from(document.querySelectorAll('#customer-menu .customer-group'));
            const checked = items.filter(i => i.checked);
            
            // 更新全选状态
            if (allBox) {
                allBox.checked = (checked.length === items.length);
            }

            // 更新显示文字
            const display = document.getElementById('customer-display');
            if (!display) return;
            
            if (checked.length === 0) {
                display.textContent = '客户号';
                display.style.color = '#999';
            } else if (checked.length === items.length) {
                display.textContent = '全部客户号';
                display.style.color = '#333';
            } else if (checked.length === 1) {
                display.textContent = checked[0].getAttribute('data-customer');
                display.style.color = '#333';
            } else {
                display.textContent = `已选${checked.length}个客户号`;
                display.style.color = '#333';
            }
        }

        function applyCustomerSelection() {
            updateCustomerDisplay();
            toggleCustomerMenu();
        }

        function getSelectedCustomers() {
            const items = Array.from(document.querySelectorAll('#customer-menu .customer-group'));
            return items.filter(i => i.checked).map(i => i.getAttribute('data-customer'));
        }

        // 初始化客户号选择功能
        (function initCustomerSelection() {
            try {
                const items = document.querySelectorAll('#customer-menu .customer-group');
                items.forEach(item => {
                    item.addEventListener('change', updateCustomerDisplay);
                });
                
                // 点击页面其他地方时关闭菜单
                document.addEventListener('click', function(e) {
                    const menu = document.getElementById('customer-menu');
                    const btn = document.getElementById('customer-menu-btn');
                    const box = document.getElementById('customer-box');
                    if (menu && btn && box && !box.contains(e.target)) {
                        menu.style.display = 'none';
                    }
                });
            } catch(e) {
            }
        })();

        // 年月格式的日期选择器 - 电费账单
        (function initMonthPickers() {
            try {
                const pad = n => (n < 10 ? '0' + n : '' + n);
                const now = new Date();
                const y = now.getFullYear();
                const m = pad(now.getMonth() + 1);
                const defaultMonth = `${y}-${m}`;

                const startEl = document.getElementById('bill-start-month');
                const endEl = document.getElementById('bill-end-month');
                if (startEl) startEl.value = defaultMonth;
                if (endEl) endEl.value = defaultMonth;
            } catch (e) {
            }
        })();

        // 电费账单月份选择器相关变量
        let currentBillPickerTarget = null;
        let currentBillPickerYear = new Date().getFullYear();

        // 显示电费账单月份选择器
        function showBillMonthPicker(targetId, inputElement) {
            document.getElementById('bill-start-month-picker').style.display = 'none';
            document.getElementById('bill-end-month-picker').style.display = 'none';

            currentBillPickerTarget = targetId;
            const targetInput = inputElement || document.getElementById(targetId);
            const currentValue = targetInput.value;

            if (currentValue && currentValue.match(/^\d{4}-\d{2}$/)) {
                currentBillPickerYear = parseInt(currentValue.split('-')[0]);
            } else {
                currentBillPickerYear = new Date().getFullYear();
            }

            const pickerId = targetId === 'bill-start-month' ? 'bill-start-month-picker' : 'bill-end-month-picker';
            const pickerContainer = document.getElementById(pickerId);

            const inputWidth = targetInput.offsetWidth;
            pickerContainer.style.width = inputWidth + 'px';

            let pickerHTML = `
                <div style="padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <button onclick="changeBillYear(-1)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="bill-picker-year-${targetId}" style="font-size:16px; font-weight:bold;">${currentBillPickerYear}年</span>
                        <button onclick="changeBillYear(1)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:12px;">
                        <button onclick="selectBillMonth(1, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">1月</button>
                        <button onclick="selectBillMonth(2, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">2月</button>
                        <button onclick="selectBillMonth(3, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">3月</button>
                        <button onclick="selectBillMonth(4, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">4月</button>
                        <button onclick="selectBillMonth(5, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">5月</button>
                        <button onclick="selectBillMonth(6, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">6月</button>
                        <button onclick="selectBillMonth(7, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">7月</button>
                        <button onclick="selectBillMonth(8, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">8月</button>
                        <button onclick="selectBillMonth(9, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">9月</button>
                        <button onclick="selectBillMonth(10, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">10月</button>
                        <button onclick="selectBillMonth(11, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">11月</button>
                        <button onclick="selectBillMonth(12, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">12月</button>
                    </div>
                    <button onclick="closeBillMonthPicker('${targetId}')" style="width:100%; padding:6px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:13px;">取消</button>
                </div>
            `;

            pickerContainer.innerHTML = pickerHTML;
            pickerContainer.style.display = 'block';

            setTimeout(() => {
                const closeOnClickOutside = (e) => {
                    if (!pickerContainer.contains(e.target) && e.target !== targetInput) {
                        pickerContainer.style.display = 'none';
                        document.removeEventListener('click', closeOnClickOutside);
                    }
                };
                document.addEventListener('click', closeOnClickOutside);
            }, 100);
        }

        function changeBillYear(delta) {
            currentBillPickerYear += delta;
            const yearSpan = document.getElementById('bill-picker-year-' + currentBillPickerTarget);
            if (yearSpan) {
                yearSpan.textContent = currentBillPickerYear + '年';
            }
        }

        function selectBillMonth(month, targetId) {
            const yearMonth = `${currentBillPickerYear}-${String(month).padStart(2, '0')}`;
            document.getElementById(targetId).value = yearMonth;
            closeBillMonthPicker(targetId);
        }

        function closeBillMonthPicker(targetId) {
            const pickerId = targetId === 'bill-start-month' ? 'bill-start-month-picker' : 'bill-end-month-picker';
            document.getElementById(pickerId).style.display = 'none';
            currentBillPickerTarget = null;
        }

        // 电费账单查询相关变量
        let __lastBillQueryResults = null;

        function setBillExportEnabled(enabled) {
            const btn = document.getElementById('bill-export-btn');
            if (!btn) return;
            btn.disabled = !enabled;
            if (enabled) {
                btn.style.background = '#28a745';
                btn.style.cursor = 'pointer';
            } else {
                btn.style.background = '#adb5bd';
                btn.style.cursor = 'not-allowed';
            }
        }

        // 构建电费账单查询SQL
        function buildBillQuery() {
            const startMonth = (document.getElementById('bill-start-month') || {}).value || '';
            const endMonth = (document.getElementById('bill-end-month') || {}).value || '';
            const customers = getSelectedCustomers();
            const allBox = document.getElementById('customer-all');
            const isAllCustomers = !!(allBox && allBox.checked);

            if (!startMonth || !endMonth) {
                return { ok: false, error: '请选择开始与结束年月' };
            }

            // 验证年月格式
            if (!/^\d{4}-\d{2}$/.test(startMonth) || !/^\d{4}-\d{2}$/.test(endMonth)) {
                return { ok: false, error: '年月格式错误，请使用YYYY-MM格式' };
            }

            // 解析年月
            const [startYear, startMonthNum] = startMonth.split('-').map(Number);
            const [endYear, endMonthNum] = endMonth.split('-').map(Number);

            if (customers.length === 0) {
                return { ok: false, error: '请选择客户号' };
            }

            // 验证结束时间不能小于开始时间
            if (endYear < startYear || (endYear === startYear && endMonthNum < startMonthNum)) {
                return { ok: false, error: '结束年月不能小于开始年月' };
            }

            const tableName = '[电力局]';
            let whereParts = [];

            // 构建年月条件
            // 如果是同一年，则使用月份范围
            if (startYear === endYear) {
                whereParts.push(`[年] = ${startYear}`);
                whereParts.push(`[月] BETWEEN ${startMonthNum} AND ${endMonthNum}`);
            } else {
                // 跨年查询：年份在范围内，或者是开始年且月份>=开始月，或者是结束年且月份<=结束月
                whereParts.push(`(
                    ([年] > ${startYear} AND [年] < ${endYear})
                    OR ([年] = ${startYear} AND [月] >= ${startMonthNum})
                    OR ([年] = ${endYear} AND [月] <= ${endMonthNum})
                )`);
            }

            // 添加客户号条件
            if (!isAllCustomers && customers.length > 0) {
                const esc = customers.map(n => `N'${n.replace(/'/g, "''")}'`).join(', ');
                whereParts.push(`[变压器编号] IN (${esc})`);
            }

            const whereClause = whereParts.length ? ('WHERE ' + whereParts.join(' AND ')) : '';
            const sql = `SELECT * FROM ${tableName} ${whereClause} ORDER BY [年] ASC, [月] ASC`;
            return { ok: true, sql, tableName };
        }

        // 更新电费账单当前条件显示
        function updateBillCurrentConditions() {
            const conditionsText = document.getElementById('bill-current-conditions-text');
            if (!conditionsText) return;
            
            try {
                // 获取客户号信息
                const allBox = document.getElementById('customer-all');
                const items = Array.from(document.querySelectorAll('#customer-menu .customer-group'));
                let customerText = '';
                
                if (allBox && allBox.checked) {
                    // 全选：显示所有客户号
                    customerText = '3111439077、3118481453、4350001671599';
                } else {
                    // 显示选中的客户号
                    const checked = items.filter(i => i.checked).map(i => i.getAttribute('data-customer'));
                    if (checked.length === 0) {
                        customerText = '未选择';
                    } else {
                        customerText = checked.join('、');
                    }
                }
                
                // 获取年月范围
                const startMonth = (document.getElementById('bill-start-month') || {}).value || '';
                const endMonth = (document.getElementById('bill-end-month') || {}).value || '';
                
                // 构建条件文本
                const conditions = [
                    `客户号：${customerText}`,
                    startMonth ? `开始年月：${startMonth}` : '',
                    endMonth ? `结束年月：${endMonth}` : ''
                ].filter(c => c).join('；');
                
                conditionsText.textContent = conditions || '请选择查询条件后点击查询';
            } catch (err) {
                conditionsText.textContent = '获取查询条件失败';
            }
        }

        // 将年月转换为日期范围（用于查询特来电、滴滴、能科表）
        function getDateRangeFromMonths(startMonth, endMonth) {
            const [startYear, startMonthNum] = startMonth.split('-').map(Number);
            const [endYear, endMonthNum] = endMonth.split('-').map(Number);
            
            // 开始日期：该月1日 00:00:00
            const startDate = `${startYear}-${String(startMonthNum).padStart(2, '0')}-01 00:00:00`;
            
            // 结束日期：下月1日 00:00:00（或该月最后一天 23:59:59）
            let endYearNum = endYear;
            let endMonthNumNext = endMonthNum + 1;
            if (endMonthNumNext > 12) {
                endMonthNumNext = 1;
                endYearNum += 1;
            }
            const endDate = `${endYearNum}-${String(endMonthNumNext).padStart(2, '0')}-01 00:00:00`;
            
            return { startDate, endDate, startYear, startMonthNum, endYear, endMonthNum };
        }

        // 将年月转换为特殊日期范围（用于2022年6月之前的查询：上月10号到本月9号）
        function getDateRangeFromMonthsBefore202206(startMonth, endMonth) {
            const [startYear, startMonthNum] = startMonth.split('-').map(Number);
            const [endYear, endMonthNum] = endMonth.split('-').map(Number);
            
            // 开始日期：开始时间的上月的10号 00:00:00
            let startYearNum = startYear;
            let startMonthNumPrev = startMonthNum - 1;
            if (startMonthNumPrev < 1) {
                startMonthNumPrev = 12;
                startYearNum -= 1;
            }
            const startDate = `${startYearNum}-${String(startMonthNumPrev).padStart(2, '0')}-10 00:00:00`;
            
            // 结束日期：结束时间的本月的10号 00:00:00（使用 < 条件，所以实际包含到9号 23:59:59）
            const endDate = `${endYear}-${String(endMonthNum).padStart(2, '0')}-10 00:00:00`;
            
            return { startDate, endDate, startYear, startMonthNum, endYear, endMonthNum };
        }

        // 查询额外的充电数据（特来电、滴滴、能科）
        function queryExtraChargingData(startMonth, endMonth, customers) {
            // 判断是否为2022年6月之前（包含2022年6月）的查询
            const [endYear, endMonthNum] = endMonth.split('-').map(Number);
            const isBefore202207 = endYear < 2022 || (endYear === 2022 && endMonthNum <= 6);
            
            // 根据时间范围选择不同的日期计算方式
            let startDate, endDate;
            if (isBefore202207) {
                // 2022年6月之前（包含）：上月10号到本月9号
                const dateRange = getDateRangeFromMonthsBefore202206(startMonth, endMonth);
                startDate = dateRange.startDate;
                endDate = dateRange.endDate;
            } else {
                // 2022年6月之后：原有逻辑（本月1日到下月1日）
                const dateRange = getDateRangeFromMonths(startMonth, endMonth);
                startDate = dateRange.startDate;
                endDate = dateRange.endDate;
            }
            
            const isOnly4350001671599 = customers.length === 1 && customers[0] === '4350001671599';
            const isBoth3111439077And3118481453 = customers.length === 2 && 
                customers.includes('3111439077') && customers.includes('3118481453');
            
            if (!isOnly4350001671599 && !isBoth3111439077And3118481453) {
                return Promise.resolve(null);
            }

            const promises = [];

            if (isOnly4350001671599) {
                // 高岭站：查询特来电表，包含'华为飞狐特来电高岭超充站'和'长沙市开福区高岭香江国际城充电站建设项目'
                const teldaiSql = `SELECT 
                    SUM([充电电量(度)]) AS totalPower,
                    SUM([充电电费(元)]) AS totalFee
                FROM [特来电]
                WHERE [充电结束时间] >= '${startDate}' AND [充电结束时间] < '${endDate}'
                AND ([电站名称] LIKE N'%华为飞狐特来电高岭超充站%' OR [电站名称] LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%')`;
                
                promises.push(
                    fetch('https://1257663610-833b483ie5.ap-guangzhou.tencentscf.com', {
                        method: 'POST',
                        headers: {
                            'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                            'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ query: teldaiSql })
                    })
                    .then(r => r.json())
                    .then(result => {
                        const payload = (result && result.result) ? result.result : result;
                        if (payload && payload.success && payload.results && payload.results.length > 0) {
                            return {
                                type: 'gaoling',
                                power: parseFloat(payload.results[0].totalPower || 0),
                                fee: parseFloat(payload.results[0].totalFee || 0)
                            };
                        }
                        return { type: 'gaoling', power: 0, fee: 0 };
                    })
                    .catch(() => ({ type: 'gaoling', power: 0, fee: 0 }))
                );
            } else if (isBoth3111439077And3118481453) {
                // 四方坪站：查询特来电（不包含高岭站）、滴滴、能科
                // 注意：2022年6月之前（包含）不查询滴滴表
                const teldaiSql = `SELECT 
                    SUM([充电电量(度)]) AS totalPower,
                    SUM([充电电费(元)]) AS totalFee
                FROM [特来电]
                WHERE [充电结束时间] >= '${startDate}' AND [充电结束时间] < '${endDate}'
                AND [电站名称] NOT LIKE N'%华为飞狐特来电高岭超充站%'
                AND [电站名称] NOT LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%'`;
                
                const nengkeSql = `SELECT 
                    SUM(CAST([充电量] AS FLOAT)) AS totalPower,
                    SUM(CAST([电费] AS FLOAT)) AS totalFee
                FROM [能科]
                WHERE [结束日期时间] >= '${startDate}' AND [结束日期时间] < '${endDate}'`;
                
                promises.push(
                    fetch('https://1257663610-833b483ie5.ap-guangzhou.tencentscf.com', {
                        method: 'POST',
                        headers: {
                            'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                            'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ query: teldaiSql })
                    })
                    .then(r => r.json())
                    .then(result => {
                        const payload = (result && result.result) ? result.result : result;
                        if (payload && payload.success && payload.results && payload.results.length > 0) {
                            return {
                                type: 'teldai',
                                power: parseFloat(payload.results[0].totalPower || 0),
                                fee: parseFloat(payload.results[0].totalFee || 0)
                            };
                        }
                        return { type: 'teldai', power: 0, fee: 0 };
                    })
                    .catch(() => ({ type: 'teldai', power: 0, fee: 0 }))
                );
                
                // 只在2022年7月之后才查询滴滴表
                if (!isBefore202207) {
                    const didiSql = `SELECT 
                        SUM(CASE WHEN ISNUMERIC([充电量（度）]) = 1 AND [充电量（度）] IS NOT NULL AND [充电量（度）] != '' THEN CAST([充电量（度）] AS FLOAT) ELSE 0 END) AS totalPower,
                        SUM(CASE WHEN ISNUMERIC([充电电费（元）]) = 1 AND [充电电费（元）] IS NOT NULL AND [充电电费（元）] != '' THEN CAST([充电电费（元）] AS FLOAT) ELSE 0 END) AS totalFee
                    FROM [滴滴]
                    WHERE [充电完成时间] >= '${startDate}' AND [充电完成时间] < '${endDate}'`;
                    
                    promises.push(
                        fetch('https://1257663610-833b483ie5.ap-guangzhou.tencentscf.com', {
                            method: 'POST',
                            headers: {
                                'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                                'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({ query: didiSql })
                        })
                        .then(r => r.json())
                        .then(result => {
                            const payload = (result && result.result) ? result.result : result;
                            if (payload && payload.success && payload.results && payload.results.length > 0) {
                                return {
                                    type: 'didi',
                                    power: parseFloat(payload.results[0].totalPower || 0),
                                    fee: parseFloat(payload.results[0].totalFee || 0)
                                };
                            }
                            return { type: 'didi', power: 0, fee: 0 };
                        })
                        .catch(() => ({ type: 'didi', power: 0, fee: 0 }))
                    );
                }
                
                promises.push(
                    fetch('https://1257663610-833b483ie5.ap-guangzhou.tencentscf.com', {
                        method: 'POST',
                        headers: {
                            'X-LC-Id': '0RRQT8VRdc9scK3XWD3ZrfWu-gzGzoHsz',
                            'X-LC-Key': 'w5k7ze9JvM7JGUY7O5DVeLVA',
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ query: nengkeSql })
                    })
                    .then(r => r.json())
                    .then(result => {
                        const payload = (result && result.result) ? result.result : result;
                        if (payload && payload.success && payload.results && payload.results.length > 0) {
                            return {
                                type: 'nengke',
                                power: parseFloat(payload.results[0].totalPower || 0),
                                fee: parseFloat(payload.results[0].totalFee || 0)
                            };
                        }
                        return { type: 'nengke', power: 0, fee: 0 };
                    })
                    .catch(() => ({ type: 'nengke', power: 0, fee: 0 }))
                );
            }

            return Promise.all(promises).then(results => {
                if (isOnly4350001671599) {
                    return results[0];
                } else if (isBoth3111439077And3118481453) {
                    const teldai = results.find(r => r.type === 'teldai') || { power: 0, fee: 0 };
                    const didi = results.find(r => r.type === 'didi') || { power: 0, fee: 0 };
                    const nengke = results.find(r => r.type === 'nengke') || { power: 0, fee: 0 };
                    return {
                        type: 'sifangping',
                        power: teldai.power + didi.power + nengke.power,
                        fee: teldai.fee + didi.fee + nengke.fee
                    };
                }
                return null;
            });
        }

        // 执行电费账单查询
        function runBillQuery() {
            const build = buildBillQuery();
            const resultContent = document.getElementById('bill-query-result-content');
            if (!build.ok) {
                resultContent.innerHTML = '<div style="color:#c00; padding:12px;">' + build.error + '</div>';
                setBillExportEnabled(false);
                return;
            }
            
            // 更新当前条件显示
            updateBillCurrentConditions();

            resultContent.innerHTML = '<p style="padding:12px;">正在执行查询...</p>';
            setBillExportEnabled(false);

            const startMonth = (document.getElementById('bill-start-month') || {}).value || '';
            const endMonth = (document.getElementById('bill-end-month') || {}).value || '';
            const customers = getSelectedCustomers();

            return fetch('https://1257663610-833b483ie5.ap-guangzhou.tencentscf.com', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ query: build.sql })
            })
            .then(r => { 
                if (!r.ok) throw new Error('HTTP ' + r.status + ': ' + r.statusText); 
                return r.json(); 
            })
            .then(result => {
                console.log('[电费账单] 收到响应:', result);

                // 腾讯云函数返回格式: { result: { results: [...] } }
                let payload;
                if (result && result.result && result.result.results) {
                    // 腾讯云函数格式
                    payload = { success: true, results: result.result.results };
                } else if (result && result.results) {
                    // 直接包含 results
                    payload = { success: true, results: result.results };
                } else if (Array.isArray(result)) {
                    // 直接是数组
                    payload = { success: true, results: result };
                } else {
                    // 其他格式
                    payload = result;
                }

                console.log('[电费账单] 解析后的数据:', payload);

                if (payload && (payload.success || payload.results)) {
                    __lastBillQueryResults = payload;
                    // 查询额外的充电数据
                    return queryExtraChargingData(startMonth, endMonth, customers).then(extraData => {
                        displayBillQueryResult(payload, extraData, startMonth, endMonth);
                        // 只有当有数据时才启用导出按钮
                        const rows = payload.results || [];
                        if (rows.length > 0) {
                            setBillExportEnabled(true);
                        } else {
                            setBillExportEnabled(false);
                        }
                    });
                } else {
                    const msg = payload.message || payload.error || '未知错误';
                    console.error('[电费账单] 查询失败:', msg, payload);
                    resultContent.innerHTML = '<div style="color:#c00; padding:12px;">查询失败: ' + msg + '</div>';
                    setBillExportEnabled(false);
                }
            })
            .catch(err => {
                resultContent.innerHTML = '<div style="color:#c00; padding:12px;">网络错误或查询失败: ' + err.message + '</div>';
                setBillExportEnabled(false);
            });
        }

        // 计算两个日期之间的天数
        function calculateDaysBetween(startMonth, endMonth) {
            const [startYear, startMonthNum] = startMonth.split('-').map(Number);
            const [endYear, endMonthNum] = endMonth.split('-').map(Number);
            
            // 开始日期：该月1日
            const startDate = new Date(startYear, startMonthNum - 1, 1);
            // 结束日期：该月最后一天
            const endDate = new Date(endYear, endMonthNum, 0);
            
            // 计算天数差（包含首尾两天）
            const diffTime = endDate.getTime() - startDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            return diffDays > 0 ? diffDays : 1; // 至少返回1天
        }

        // 显示电费账单查询结果
        function displayBillQueryResult(payload, extraData, startMonth, endMonth) {
            const resultContent = document.getElementById('bill-query-result-content');
            if (!resultContent) return;

            const rows = payload.results || [];
            if (rows.length === 0) {
                resultContent.innerHTML = '<div style="padding:12px; color:#666;">未查询到数据</div>';
                return;
            }

            // 计算统计数据
            let totalPurchaseFee = 0;  // 购电费
            let totalTransmissionFee = 0;  // 输配电量电费
            let totalPowerAdjustmentFee = 0;  // 力调电费
            let totalFundFee = 0;  // 基金及附加
            let totalLineLossFee = 0;  // 上网线损费用
            let totalSystemFee = 0;  // 系统运行费用
            let totalEnvironmentFee = 0;  // 环境价值费用
            let totalElectricity = 0;  // 电量

            rows.forEach(row => {
                totalPurchaseFee += parseFloat(row['购电费'] || 0);
                totalTransmissionFee += parseFloat(row['输配电量电费'] || 0);
                totalPowerAdjustmentFee += parseFloat(row['力调电费'] || 0);
                totalFundFee += parseFloat(row['基金及附加'] || 0);
                totalLineLossFee += parseFloat(row['上网线损费用'] || 0);
                totalSystemFee += parseFloat(row['系统运行费用'] || 0);
                totalEnvironmentFee += parseFloat(row['环境价值费用'] || 0);
                totalElectricity += parseFloat(row['电量'] || 0);
            });

            const totalFee = totalPurchaseFee + totalTransmissionFee + totalPowerAdjustmentFee + 
                           totalFundFee + totalLineLossFee + totalSystemFee + totalEnvironmentFee;

            // 构建汇总信息HTML
            let summaryHtml = `
                <div style="padding:16px; background:#f8f9fa; border-bottom:2px solid #007bff; margin-bottom:16px;">
                    <h5 style="margin:0 0 12px 0; color:#333;">费用汇总统计</h5>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; font-size:14px;">
                        <div><strong>购电费：</strong>¥${totalPurchaseFee.toFixed(2)}</div>
                        <div><strong>输配电量电费：</strong>¥${totalTransmissionFee.toFixed(2)}</div>
                        <div><strong>力调电费：</strong>¥${totalPowerAdjustmentFee.toFixed(2)}</div>
                        <div><strong>基金及附加：</strong>¥${totalFundFee.toFixed(2)}</div>
                        <div><strong>上网线损费用：</strong>¥${totalLineLossFee.toFixed(2)}</div>
                        <div><strong>系统运行费用：</strong>¥${totalSystemFee.toFixed(2)}</div>
                        <div><strong>环境价值费用：</strong>¥${totalEnvironmentFee.toFixed(2)}</div>
                        <div style="color:#007bff; font-weight:bold; font-size:16px;"><strong>总费用：</strong>¥${totalFee.toFixed(2)}</div>
                    </div>
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #dee2e6; font-size:14px;">
                        <strong>电量：</strong><span style="color:#28a745; font-weight:bold;">${totalElectricity.toFixed(2)} 度</span>
                        <span style="margin-left:20px;"><strong>平均电价：</strong><span style="color:red; font-weight:bold;">${totalElectricity > 0 ? (totalFee / totalElectricity).toFixed(4) : '0.0000'} 元/度</span></span>
                    </div>`;

            // 添加额外的统计信息
            if (extraData) {
                const days = calculateDaysBetween(startMonth, endMonth);
                
                if (extraData.type === 'gaoling') {
                    // 高岭站统计
                    const chargingPower = extraData.power || 0;
                    const powerLoss = totalElectricity - chargingPower;
                    const powerLossRate = totalElectricity > 0 ? (powerLoss / totalElectricity * 100) : 0;
                    const avgDailyPowerLoss = days > 0 ? (powerLoss / days) : 0;
                    
                    const chargingFee = extraData.fee || 0;
                    const feeLoss = totalFee - chargingFee;
                    const feeLossRate = totalFee > 0 ? (feeLoss / totalFee * 100) : 0;
                    const avgDailyFeeLoss = days > 0 ? (feeLoss / days) : 0;
                    
                    summaryHtml += `
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #dee2e6; font-size:14px;">
                        <div style="margin-bottom:8px;"><strong>高岭站本期充电电量：</strong>${chargingPower.toFixed(2)}度&nbsp;&nbsp;<strong>本期电量损耗：</strong>${powerLoss.toFixed(2)}度&nbsp;&nbsp;<strong>本期电损率：</strong>${powerLossRate.toFixed(2)}%&nbsp;&nbsp;<strong>本期日平均损耗电量：</strong>${avgDailyPowerLoss.toFixed(2)}度</div>
                        <div><strong>高岭站本期充电电费：</strong>${chargingFee.toFixed(2)}元&nbsp;&nbsp;<strong>本期电费损耗：</strong>${feeLoss.toFixed(2)}元&nbsp;&nbsp;<strong>本期电费损耗率：</strong>${feeLossRate.toFixed(2)}%&nbsp;&nbsp;<strong>本期日平均损耗电费：</strong>${avgDailyFeeLoss.toFixed(2)}元</div>
                    </div>`;
                } else if (extraData.type === 'sifangping') {
                    // 四方坪站统计
                    const chargingPower = extraData.power || 0;
                    const powerLoss = totalElectricity - chargingPower;
                    const powerLossRate = totalElectricity > 0 ? (powerLoss / totalElectricity * 100) : 0;
                    const avgDailyPowerLoss = days > 0 ? (powerLoss / days) : 0;
                    
                    const chargingFee = extraData.fee || 0;
                    const feeLoss = totalFee - chargingFee;
                    const feeLossRate = totalFee > 0 ? (feeLoss / totalFee * 100) : 0;
                    const avgDailyFeeLoss = days > 0 ? (feeLoss / days) : 0;
                    
                    summaryHtml += `
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #dee2e6; font-size:14px;">
                        <div style="margin-bottom:8px;"><strong>四方坪站本期充电电量：</strong>${chargingPower.toFixed(2)}度&nbsp;&nbsp;<strong>本期电量损耗：</strong>${powerLoss.toFixed(2)}度&nbsp;&nbsp;<strong>本期电损率：</strong>${powerLossRate.toFixed(2)}%&nbsp;&nbsp;<strong>本期日平均损耗电量：</strong>${avgDailyPowerLoss.toFixed(2)}度</div>
                        <div><strong>四方坪站本期充电电费：</strong>${chargingFee.toFixed(2)}元&nbsp;&nbsp;<strong>本期电费损耗：</strong>${feeLoss.toFixed(2)}元&nbsp;&nbsp;<strong>本期电费损耗率：</strong>${feeLossRate.toFixed(2)}%&nbsp;&nbsp;<strong>本期日平均损耗电费：</strong>${avgDailyFeeLoss.toFixed(2)}元</div>
                    </div>`;
                }
            }

            summaryHtml += `</div>`;

            // 构建表格HTML
            const cols = Object.keys(rows[0]);
            let tableHtml = '<table style="width:100%; border-collapse:collapse; font-size:14px;">';
            tableHtml += '<thead><tr>';
            cols.forEach(col => {
                tableHtml += `<th style="padding:10px; background:#007bff; color:#fff; border:1px solid #ddd; text-align:center; white-space:nowrap;">${col}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            // 需要格式化为两位小数的费用字段
            const feeFields = [
                '购电费',
                '输配电量电费',
                '力调电费',
                '基金及附加',
                '上网线损费用',
                '系统运行费用',
                '环境价值费用'
            ];

            // 格式化数字为两位小数的辅助函数（仅对指定字段）
            const formatFeeNumber = (val) => {
                if (val === null || val === undefined || val === '') return '';
                // 尝试转换为数字
                const num = parseFloat(val);
                // 如果是有效数字，格式化为两位小数
                if (!isNaN(num)) {
                    return num.toFixed(2);
                }
                // 如果不是数字，返回原值
                return val;
            };

            rows.forEach((row, idx) => {
                const bg = idx % 2 === 0 ? '#fff' : '#f8f9fa';
                tableHtml += '<tr>';
                cols.forEach(col => {
                    let val = row[col] !== null && row[col] !== undefined ? row[col] : '';
                    // 只对指定的费用字段格式化为两位小数，其他字段保持原格式
                    if (feeFields.includes(col)) {
                        val = formatFeeNumber(val);
                    }
                    tableHtml += `<td style="padding:8px; border:1px solid #ddd; text-align:center; background:${bg};">${val}</td>`;
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            tableHtml += `<div style="padding:12px; color:#666; font-size:13px;">共查询到 ${rows.length} 条数据</div>`;

            resultContent.innerHTML = summaryHtml + tableHtml;
        }

        // 导出电费账单到Excel
        function exportBillToExcel() {
            const exportBtn = document.getElementById('bill-export-btn');
            if (exportBtn && exportBtn.disabled) {
                return;
            }

            try {
                const rows = (__lastBillQueryResults && __lastBillQueryResults.results) ? __lastBillQueryResults.results : [];
                if (!rows || rows.length === 0) {
                    alert('没有可导出的数据');
                    return;
                }
                
                const ws = XLSX.utils.json_to_sheet(rows);
                    const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '电费账单');
                XLSX.writeFile(wb, `电费账单查询.xlsx`);
            } catch (e) {
                alert('导出失败：' + (e.message || '未知错误'));
            }
        }

        // 初始化电费账单导出按钮为禁用状态
        setTimeout(() => {
            setBillExportEnabled(false);
        }, 0);

        // ==================== 综合数据查询相关函数 ====================
        
        // 综合数据分页和查询状态
        let __zhPagination = {
            currentPage: 1,
            pageSize: 20,
            total: 0,
            tableName: '',
            timeField: '',
            whereClause: '',
            orderByFinal: '',
            results: []
        };
        let __zhStatsTotals = null;
        let __lastZhQueryResults = null;

        // 项目字段映射配置表（替代大量的 if (project === '...') 判断）
        const PROJECT_CONFIG_MAP = new Map([
            ['红门缴费', {
                timeField: '缴费时间',
                tableName: '[红门缴费]',
                selectColumns: '*',
                whereClauseType: 'datetime', // datetime | date | ltrim
                orderByType: 'normal' // normal | ltrim
            }],
            ['月租车充值', {
                timeField: '交款时间',
                tableName: '[月租车充值]',
                selectColumns: '*',
                whereClauseType: 'datetime',
                orderByType: 'normal'
            }],
            ['兴元售货机', {
                timeField: '支付时间',
                tableName: '[兴元售货机]',
                selectColumns: '[商户名称], [销售额], [货道编号], [商品名称], [支付账号], [支付方式], [支付金额], [出货状态], [退款金额], [支付时间]',
                whereClauseType: 'datetime',
                orderByType: 'normal'
            }],
            ['赛菲姆道闸', {
                timeField: '支付时间',
                tableName: '[赛菲姆道闸]',
                selectColumns: '[车牌号码], [订单类型], [支付金额], [支付时间], [支付方式], [开始时间], [结束时间]',
                whereClauseType: 'datetime',
                orderByType: 'normal'
            }],
            ['快易洁洗车', {
                timeField: '日期',
                tableName: '[快易洁洗车]',
                selectColumns: '*',
                whereClauseType: 'date',
                orderByType: 'normal'
            }],
            ['收钱吧', {
                timeField: '交易日期',
                tableName: '[收钱吧]',
                selectColumns: '[交易日期], [收款通道/支付方式], [交易状态], [收款金额]',
                whereClauseType: 'date',
                orderByType: 'normal'
            }],
            ['智小盟', {
                timeField: '支付时间',
                tableName: '[智小盟]',
                selectColumns: '[设备名称], [实收金额 ], [支付方式], [支付时间]',
                whereClauseType: 'ltrim',
                orderByType: 'ltrim'
            }],
            ['车颜知己洗车', {
                timeField: '启动时间',
                tableName: '[车颜知己洗车]',
                selectColumns: '[场所], [启动时间], [停止时间], [订单金额], [使用会员卡], [订单状态]',
                whereClauseType: 'datetime',
                orderByType: 'normal'
            }],
            ['车海洋洗车', {
                timeField: '时间',
                tableName: '[车海洋洗车消费]',
                selectColumns: '*',
                whereClauseType: 'datetime',
                orderByType: 'normal'
            }],
            ['微信', {
                timeField: '交易时间',
                tableName: '[微信收款商业版]',
                selectColumns: '[交易时间], [商户号], [微信订单号], [订单金额], [退款金额]',
                whereClauseType: 'datetime',
                orderByType: 'normal'
            }],
            ['超时占位费', {
                timeField: '支付时间',
                tableName: '[超时占位费]',
                selectColumns: '[订单编号], [电站名称], [终端名称], CASE WHEN ISNUMERIC([应收金额]) = 1 AND [应收金额] IS NOT NULL AND [应收金额] != \'\' THEN CAST([应收金额] AS FLOAT) ELSE 0 END AS [应收金额], [支付时间], [插枪时间], [拔枪时间], [客户类型], [总占用时长], [充电时长], [限时免费时长], [超时占用时长], [客户手机号]',
                whereClauseType: 'datetime',
                orderByType: 'normal'
            }]
        ]);

        // 通用SQL查询构建函数
        function buildSqlQuery(timeField, start, end, whereClauseType = 'datetime', additionalConditions = []) {
            let whereClause = '';
            const whereParts = [];

            // 构建时间条件
            if (whereClauseType === 'date') {
                // 日期字段：只使用日期部分
                const startDate = start.split(' ')[0];
                const endDate = end.split(' ')[0];
                whereParts.push(`[${timeField}] >= '${startDate}'`);
                whereParts.push(`[${timeField}] <= '${endDate}'`);
            } else if (whereClauseType === 'ltrim') {
                // 需要清理空格的时间字段（如智小盟）
                whereParts.push(`LTRIM(RTRIM([${timeField}])) >= '${start}'`);
                whereParts.push(`LTRIM(RTRIM([${timeField}])) <= '${end}'`);
            } else {
                // 日期时间字段：使用完整日期时间
                whereParts.push(`[${timeField}] >= '${start}'`);
                whereParts.push(`[${timeField}] <= '${end}'`);
            }

            // 添加额外的WHERE条件
            whereParts.push(...additionalConditions);

            if (whereParts.length > 0) {
                whereClause = 'WHERE ' + whereParts.join(' AND ');
            }

            return whereClause;
        }

        // 构建ORDER BY子句
        function buildOrderByClause(timeField, orderByType = 'normal', direction = 'DESC') {
            if (orderByType === 'ltrim') {
                return `ORDER BY LTRIM(RTRIM([${timeField}])) ${direction}`;
            } else {
                return `ORDER BY [${timeField}] ${direction}`;
            }
        }

        // 项目类别变化处理
        function onZhProjectChange() {
            const project = (document.getElementById('zh-project-select') || {}).value || '';
            if (!project) return;
            
            // 从配置映射表获取项目配置
            const config = PROJECT_CONFIG_MAP.get(project);
            if (config) {
                __zhPagination.tableName = config.tableName;
                __zhPagination.timeField = config.timeField;
            } else {
                // 默认值（向后兼容）
                __zhPagination.tableName = `[${project}]`;
                __zhPagination.timeField = '缴费时间';
            }
            
            // 初始化日期选择器
            initZhDatetimePickers();
        }

        // 初始化综合数据页面日期选择器（与充电数据页面保持一致）
        function initZhDatetimePickers() {
            try {
                const pad = n => (n < 10 ? '0' + n : '' + n);
                const now = new Date();
                const y = now.getFullYear();
                const m = pad(now.getMonth() + 1);
                const d = pad(now.getDate());
                const startTime = `${y}-${m}-${d} 00:00:00`;
                const endTime = `${y}-${m}-${d} 23:59:59`;
                const startInput = document.getElementById('zh-start-datetime');
                const endInput = document.getElementById('zh-end-datetime');
                if (!startInput || !endInput) return;
                
                if (startInput.value === '') startInput.value = startTime;
                if (endInput.value === '') endInput.value = endTime;

                function attachZhDateBehavior(input, isEnd) {
                    if (!input) return;
                    // 保持文本输入框始终显示 yyyy-mm-dd hh:mm:ss
                    // 使用隐藏的原生日期选择器进行选择
                    const hiddenPicker = document.createElement('input');
                    hiddenPicker.type = 'date';
                    hiddenPicker.style.position = 'fixed';
                    hiddenPicker.style.opacity = '0';
                    hiddenPicker.style.pointerEvents = 'none';
                    hiddenPicker.style.width = '0';
                    hiddenPicker.style.height = '0';
                    document.body.appendChild(hiddenPicker);

                    function openPicker() {
                        const rect = input.getBoundingClientRect();
                        hiddenPicker.style.left = `${Math.max(0, rect.left)}px`;
                        hiddenPicker.style.top = `${Math.max(0, rect.bottom)}px`;
                        const current = input.value && input.value.slice(0, 10);
                        if (/^\d{4}-\d{2}-\d{2}$/.test(current)) {
                            hiddenPicker.value = current;
                        }
                        // 先聚焦再打开，确保首次定位正确
                        hiddenPicker.focus();
                        try { hiddenPicker.showPicker && hiddenPicker.showPicker(); } catch (e) { /* ignore */ }
                        hiddenPicker.click();
                    }

                    // 允许手动输入；点击旁边📅按钮时弹出日期选择器
                    const triggerBtn = document.getElementById(isEnd ? 'zh-end-date-btn' : 'zh-start-date-btn');
                    if (triggerBtn) {
                        triggerBtn.addEventListener('click', function(ev){ ev.preventDefault(); openPicker(); });
                    }

                    hiddenPicker.addEventListener('change', function() {
                        const v = hiddenPicker.value;
                        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
                            input.value = isEnd ? `${v} 23:59:59` : `${v} 00:00:00`;
                        }
                        // 选择后把焦点回到可见输入
                        input.focus();
                    });
                }

                attachZhDateBehavior(startInput, false);
                attachZhDateBehavior(endInput, true);
            } catch (e) { 
            }
        }

        // 构建综合数据查询SQL
        function buildZhQuery() {
            const project = (document.getElementById('zh-project-select') || {}).value || '';
            if (!project) {
                throw new Error('请选择项目类别');
            }

            const start = toSqlDateTime((document.getElementById('zh-start-datetime') || {}).value, false);
            const end = toSqlDateTime((document.getElementById('zh-end-datetime') || {}).value, true);

            if (!start || !end) {
                throw new Error('请选择开始时间和结束时间');
            }

            // 从配置映射表获取项目配置
            const config = PROJECT_CONFIG_MAP.get(project);
            if (!config) {
                // 向后兼容：如果配置不存在，使用默认值
                return {
                    tableName: `[${project}]`,
                    whereClause: buildSqlQuery('缴费时间', start, end, 'datetime'),
                    timeField: '缴费时间',
                    project: project,
                    selectColumns: '*'
                };
            }

            // 使用配置构建SQL查询
            const timeField = config.timeField;
            const whereClause = buildSqlQuery(timeField, start, end, config.whereClauseType);
            
            return {
                tableName: config.tableName,
                whereClause: whereClause,
                timeField: timeField,
                project: project,
                selectColumns: config.selectColumns
            };
        }

        // 更新综合数据当前条件显示
        function updateZhCurrentConditions() {
            const conditionsText = document.getElementById('zh-current-conditions-text');
            if (!conditionsText) return;
            
            try {
                // 获取项目类别
                const project = (document.getElementById('zh-project-select') || {}).value || '';
                if (!project) {
                    conditionsText.textContent = '请选择项目类别';
                    return;
                }
                
                // 获取时间范围
                const startEl = document.getElementById('zh-start-datetime');
                const endEl = document.getElementById('zh-end-datetime');
                const startTime = (startEl && startEl.value) ? startEl.value.trim() : '';
                const endTime = (endEl && endEl.value) ? endEl.value.trim() : '';
                
                // 构建条件文本
                const conditions = [
                    `项目类别：${project}`,
                    startTime ? `开始时间：${startTime}` : '',
                    endTime ? `结束时间：${endTime}` : ''
                ].filter(c => c).join('；');
                
                conditionsText.textContent = conditions || '请选择查询条件后点击查询';
            } catch (err) {
                conditionsText.textContent = '获取查询条件失败';
            }
        }

        // 执行综合数据查询
        function runZhQuery() {
            // 清空上一次查询的统计数据
            __zhStatsTotals = null;

            // 立即清空结果内容（包括统计数据）
            const resultContent = document.getElementById('zh-query-result-content');
            if (resultContent) {
                resultContent.innerHTML = '';
            }

            try {
                const query = buildZhQuery();
                __zhPagination.tableName = query.tableName;
                __zhPagination.timeField = query.timeField;
                __zhPagination.whereClause = query.whereClause;

                if (!resultContent) return;

                resultContent.innerHTML = '<div style="padding:12px;"><i class="fas fa-spinner fa-spin"></i> 查询中...</div>';
                setZhExportEnabled(false);
                
                // 更新当前条件显示
                updateZhCurrentConditions();

                // 先获取总数
                const countSql = `SELECT COUNT(*) as total FROM ${query.tableName} ${query.whereClause}`;
                
                // 对于"智小盟"，先检查表中是否有任何数据，以及时间字段的格式
                if (query.project === '智小盟') {
                    const testSql = `SELECT TOP 5 [支付时间] FROM ${query.tableName} ORDER BY [支付时间] DESC`;
                    callSqlWithRetry(testSql).then(testResult => {
                        if (testResult && testResult.results && testResult.results.length > 0) {
                            testResult.results.forEach((row, idx) => {

                            });
                        } else {
                        }
                    }).catch(err => {
                    });
                    
                    // 检查表中的总记录数
                    const totalCountSql = `SELECT COUNT(*) as total FROM ${query.tableName}`;
                    callSqlWithRetry(totalCountSql).then(totalResult => {
                        if (totalResult && totalResult.results && totalResult.results[0]) {
                            const totalInTable = totalResult.results[0].total || totalResult.results[0].TOTAL || 0;
                        }
                    }).catch(err => {
                    });
                }
                
                callSqlWithRetry(countSql)
                    .then(countResult => {

                        if (countResult && countResult.results) {
                            if (countResult.results.length > 0) {
                            }
                        }
                        const total = countResult.results && countResult.results[0] ? (countResult.results[0].total || countResult.results[0].TOTAL || 0) : 0;
                        __zhPagination.total = total;
                        __zhPagination.currentPage = 1;

                        // 获取第一页数据
                        // 使用配置映射表获取ORDER BY类型
                        const config = PROJECT_CONFIG_MAP.get(query.project);
                        const orderByType = config ? config.orderByType : 'normal';
                        const orderByFinal = buildOrderByClause(query.timeField, orderByType, 'DESC');
                        __zhPagination.orderByFinal = orderByFinal;
                        // 兴元售货机使用指定的列，其他使用*
                        const selectCols = query.selectColumns || '*';
                        const dataSql = `SELECT TOP 20 ${selectCols} FROM ${query.tableName} ${query.whereClause} ${orderByFinal}`;

                        return callSqlWithRetry(dataSql);
                    })
                    .then(dataResult => {

                        if (dataResult && dataResult.results) {
                            // 根据项目类别过滤列
                            let cleanedResults = dataResult.results;
                            if (query.project === '兴元售货机') {
                                const allowedCols = ['商户名称', '销售额', '货道编号', '商品名称', '支付账号', '支付方式', '支付金额', '出货状态', '退款金额', '支付时间'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            } else if (query.project === '赛菲姆道闸') {
                                const allowedCols = ['车牌号码', '订单类型', '支付金额', '支付时间', '支付方式', '开始时间', '结束时间'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            } else if (query.project === '收钱吧') {
                                const allowedCols = ['交易日期', '收款通道/支付方式', '交易状态', '收款金额'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            } else if (query.project === '智小盟') {
                                const allowedCols = ['设备名称', '实收金额 ', '支付方式', '支付时间'];
                                cleanedResults = dataResult.results.map((row, idx) => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            } else if (query.project === '车海洋洗车') {
                                // 车海洋洗车：输出车海洋洗车消费表的所有列，不需要过滤
                                cleanedResults = dataResult.results;
                            } else if (query.project === '微信') {
                                const allowedCols = ['交易时间', '商户号', '微信订单号', '订单金额', '退款金额'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            } else if (query.project === '车颜知己洗车') {
                                const allowedCols = ['场所', '启动时间', '停止时间', '订单金额', '使用会员卡', '订单状态'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            } else if (query.project === '超时占位费') {
                                const allowedCols = ['订单编号', '电站名称', '终端名称', '应收金额', '支付时间', '插枪时间', '拔枪时间', '客户类型', '总占用时长', '充电时长', '限时免费时长', '超时占用时长', '客户手机号'];
                                cleanedResults = dataResult.results.map(row => {
                                    const filtered = {};
                                    allowedCols.forEach(col => {
                                        if (row.hasOwnProperty(col)) {
                                            filtered[col] = row[col];
                                        }
                                    });
                                    return filtered;
                                });
                            }
                            
                            __lastZhQueryResults = { ...dataResult, results: cleanedResults };
                            __zhPagination.results = cleanedResults;
                            
                            // 根据项目类别计算统计
                            calculateZhStats(query.project, cleanedResults);
                            
                            displayZhQueryResult({ ...dataResult, results: cleanedResults });
                            
                            // 只有当有数据时才启用导出按钮
                            if (cleanedResults.length > 0) {
                                setZhExportEnabled(true);
                            } else {
                                setZhExportEnabled(false);
                            }
                        } else {
                            throw new Error('查询结果格式错误');
                        }
                    })
                    .catch(err => {
                        resultContent.innerHTML = '<div style="color:#c00; padding:12px;">查询失败: ' + (err.message || '未知错误') + '<br>表名: ' + query.tableName + '<br>时间字段: ' + query.timeField + '<br>请检查表名和字段名是否正确</div>';
                        setZhExportEnabled(false);
                    });
            } catch (err) {
                alert(err.message || '查询参数错误');
            }
        }

        // 计算综合数据统计（根据项目类别）
        async function calculateZhStats(project, rows) {
            __zhStatsTotals = null;
            
            try {
                if (project === '红门缴费') {
                    await calculateHongmenStats();
                } else if (project === '月租车充值') {
                    await calculateYuezucheStats();
                } else if (project === '兴元售货机') {
                    await calculateXingyuanStats();
                } else if (project === '赛菲姆道闸') {
                    await calculateSaifeimuStats();
                } else if (project === '收钱吧') {
                    await calculateShouqianbaStats();
                } else if (project === '智小盟') {
                    await calculateZhixiaomengStats();
                } else if (project === '快易洁洗车') {
                    await calculateKuaijijieStats();
                } else if (project === '车海洋洗车') {
                    await calculateChehaiyangStats();
                } else if (project === '微信') {
                    await calculateWeixinStats();
                } else if (project === '车颜知己洗车') {
                    await calculateCheyanzhijiStats();
                } else if (project === '超时占位费') {
                    await calculateChaoshiStats();
                }
            } catch (err) {
            }
        }

        // 红门缴费统计：按收费场区+支付方式统计交易金额
        async function calculateHongmenStats() {
            const query = buildZhQuery();
            const sql = `SELECT [收费场区], [支付方式], SUM([交易金额]) as 交易金额合计 
                        FROM ${query.tableName} ${query.whereClause} 
                        GROUP BY [收费场区], [支付方式] 
                        ORDER BY [收费场区], [支付方式]`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    const stats = {};
                    let totalAmount = 0;
                    
                    result.results.forEach(row => {
                        const field = row['收费场区'] || '未知';
                        const payMethod = row['支付方式'] || '未知';
                        const amount = parseFloat(row['交易金额合计'] || 0);
                        
                        if (!stats[field]) {
                            stats[field] = {};
                        }
                        stats[field][payMethod] = amount;
                        totalAmount += amount;
                    });
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
            }
        }

        // 月租车充值统计：按车牌类型（东区、西区、南区）+支付方式统计交款金额
        async function calculateYuezucheStats() {
            const query = buildZhQuery();
            // 先获取所有数据，然后在客户端分组
            const sql = `SELECT [车牌类型], [支付方式], [交款金额] 
                        FROM ${query.tableName} ${query.whereClause}`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    const stats = {
                        '东区': {},
                        '西区': {},
                        '南区': {}
                    };
                    let totalAmount = 0;
                    
                    result.results.forEach(row => {
                        const plateType = row['车牌类型'] || '';
                        const payMethod = row['支付方式'] || '未知';
                        const amount = parseFloat(row['交款金额'] || 0);
                        
                        // 根据车牌类型分类
                        let category = '';
                        if (plateType.includes('东区')) {
                            category = '东区';
                        } else if (plateType.includes('西区')) {
                            category = '西区';
                        } else if (plateType.includes('南区')) {
                            category = '南区';
                        }
                        
                        if (category) {
                            if (!stats[category][payMethod]) {
                                stats[category][payMethod] = 0;
                            }
                            stats[category][payMethod] += amount;
                            totalAmount += amount;
                        }
                    });
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
            }
        }

        // 兴元售货机：机器名称自定义分组函数
        function getMachineCategory(machineName) {
            if (!machineName) return machineName || '未知';
            const name = String(machineName);
            // 将"东区"、"东区刷脸机"、"四方坪桥下东区"等包含"东区"的合并为"东区"
            if (name.includes('东区')) {
                return '东区';
            } else if (name.includes('西区')) {
                return '西区';
            } else if (name.includes('南区')) {
                return '南区';
            }
            return name; // 其他保持原名称
        }

        // 兴元售货机统计：按机器名称自定义分组+支付方式统计支付金额和退款金额
        async function calculateXingyuanStats() {
            const query = buildZhQuery();
            const sql = `SELECT [机器名称], [支付方式], 
                        SUM([支付金额]) as 支付金额合计, 
                        SUM([退款金额]) as 退款金额合计
                        FROM ${query.tableName} ${query.whereClause} 
                        GROUP BY [机器名称], [支付方式] 
                        ORDER BY [机器名称], [支付方式]`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    // 使用自定义分组后的结构：category -> machine -> payMethod -> data
                    const stats = {};
                    let totalPayAmount = 0;
                    let totalRefundAmount = 0;
                    let totalActualAmount = 0;
                    
                    result.results.forEach(row => {
                        const machineName = row['机器名称'] || '未知';
                        const category = getMachineCategory(machineName); // 自定义分组（包含"东区"的都归为"东区"）
                        const payMethod = row['支付方式'] || '未知';
                        const payAmount = parseFloat(row['支付金额合计'] || 0);
                        const refundAmount = parseFloat(row['退款金额合计'] || 0);
                        const actualAmount = payAmount - refundAmount;
                        
                        // 结构：stats[category][payMethod] - 同一category下的所有机器数据合并
                        if (!stats[category]) {
                            stats[category] = {};
                        }
                        if (!stats[category][payMethod]) {
                            stats[category][payMethod] = {
                                payAmount: 0,
                                refundAmount: 0,
                                actualAmount: 0
                            };
                        }
                        // 合并同一category下所有机器的数据
                        stats[category][payMethod].payAmount += payAmount;
                        stats[category][payMethod].refundAmount += refundAmount;
                        stats[category][payMethod].actualAmount += actualAmount;
                        
                        totalPayAmount += payAmount;
                        totalRefundAmount += refundAmount;
                        totalActualAmount += actualAmount;
                    });
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalPayAmount: totalPayAmount,
                        totalRefundAmount: totalRefundAmount,
                        totalActualAmount: totalActualAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
            }
        }

        // 赛菲姆道闸统计：按支付方式统计支付金额（排除线下现金）
        async function calculateSaifeimuStats() {
            const query = buildZhQuery();
            const sql = `SELECT [支付方式], SUM([支付金额]) as 支付金额合计 
                        FROM ${query.tableName} ${query.whereClause} AND [支付方式] != '线下现金'
                        GROUP BY [支付方式] 
                        ORDER BY [支付方式]`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    const stats = {};
                    let totalAmount = 0;
                    
                    result.results.forEach(row => {
                        const payMethod = row['支付方式'] || '未知';
                        const amount = parseFloat(row['支付金额合计'] || 0);
                        stats[payMethod] = amount;
                        totalAmount += amount;
                    });
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
            }
        }

        // 收钱吧统计：按收款通道/支付方式统计收款金额
        async function calculateShouqianbaStats() {
            const query = buildZhQuery();
            const sql = `SELECT [收款通道/支付方式], SUM([收款金额]) as 收款金额合计 
                        FROM ${query.tableName} ${query.whereClause} 
                        GROUP BY [收款通道/支付方式] 
                        ORDER BY [收款通道/支付方式]`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    const stats = {};
                    let totalAmount = 0;
                    
                    result.results.forEach(row => {
                        const channel = row['收款通道/支付方式'] || '未知';
                        const amount = parseFloat(row['收款金额合计'] || 0);
                        stats[channel] = amount;
                        totalAmount += amount;
                    });
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
            }
        }

        // 智小盟统计：统计实收金额汇总
        async function calculateZhixiaomengStats() {
            const startInput = document.getElementById('zh-start-datetime');
            const endInput = document.getElementById('zh-end-datetime');
            const start = toSqlDateTime(startInput ? startInput.value : '', false);
            const end = toSqlDateTime(endInput ? endInput.value : '', true);
            
            if (!start || !end) {
                __zhStatsTotals = null;
                updateZhStatsDisplay();
                return;
            }
            
            // 智小盟的时间字段前面可能有制表符，清理后使用字符串比较
            const sql = `SELECT ISNULL(SUM([实收金额 ]), 0) as 实收金额合计 
                        FROM [智小盟] WHERE LTRIM(RTRIM([支付时间])) >= '${start}' AND LTRIM(RTRIM([支付时间])) <= '${end}'`;
            
            try {
                const result = await callSqlWithRetry(sql);
                
                if (result && result.results && result.results.length > 0) {
                    const totalAmount = parseFloat(result.results[0]['实收金额合计'] || 0);
                    
                    __zhStatsTotals = {
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                } else {
                    __zhStatsTotals = {
                        totalAmount: 0
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
                __zhStatsTotals = null;
                updateZhStatsDisplay();
            }
        }

        // 车海洋洗车统计：统计消费金额、返还金额、充值金额
        async function calculateChehaiyangStats() {
            const startInput = document.getElementById('zh-start-datetime');
            const endInput = document.getElementById('zh-end-datetime');
            const start = startInput.value || startInput.getAttribute('data-value') || '';
            const end = endInput.value || endInput.getAttribute('data-value') || '';
            
            if (!start || !end) {
                return;
            }
            
            // 从"车海洋洗车消费"表统计
            const consumeSql = `SELECT SUM([消费金额]) as 消费金额合计, SUM([返还金额]) as 消费返还金额合计 
                               FROM [车海洋洗车消费] WHERE [时间] >= '${start}' AND [时间] <= '${end}'`;
            
            // 从"车海洋洗车充值"表统计
            const rechargeSql = `SELECT SUM([充值金额]) as 充值金额合计, SUM([返还金额]) as 充值返还金额合计 
                                FROM [车海洋洗车充值] WHERE [时间] >= '${start}' AND [时间] <= '${end}'`;
            
            try {
                const [consumeResult, rechargeResult] = await Promise.all([
                    callSqlWithRetry(consumeSql),
                    callSqlWithRetry(rechargeSql)
                ]);
                
                const consumeAmount = parseFloat(consumeResult.results && consumeResult.results[0] ? (consumeResult.results[0]['消费金额合计'] || 0) : 0);
                const consumeRefund = parseFloat(consumeResult.results && consumeResult.results[0] ? (consumeResult.results[0]['消费返还金额合计'] || 0) : 0);
                const rechargeAmount = parseFloat(rechargeResult.results && rechargeResult.results[0] ? (rechargeResult.results[0]['充值金额合计'] || 0) : 0);
                const rechargeRefund = parseFloat(rechargeResult.results && rechargeResult.results[0] ? (rechargeResult.results[0]['充值返还金额合计'] || 0) : 0);
                const totalRefund = consumeRefund + rechargeRefund;
                
                __zhStatsTotals = {
                    consumeAmount: consumeAmount,
                    consumeRefund: consumeRefund,
                    rechargeAmount: rechargeAmount,
                    rechargeRefund: rechargeRefund,
                    totalRefund: totalRefund
                };
                
                updateZhStatsDisplay();
            } catch (err) {
            }
        }

        // 微信统计：统计微信扫码收入和微信商户下单收入
        async function calculateWeixinStats() {
            const startInput = document.getElementById('zh-start-datetime');
            const endInput = document.getElementById('zh-end-datetime');
            const start = toSqlDateTime(startInput ? startInput.value : '', false);
            const end = toSqlDateTime(endInput ? endInput.value : '', true);
            
            if (!start || !end) {
                __zhStatsTotals = null;
                updateZhStatsDisplay();
                return;
            }
            
            // 从"微信收款商业版"表统计
            // 检查时间参数是否有效
            if (!start || !end || start === 'Invalid Date' || end === 'Invalid Date') {
                throw new Error('时间参数无效');
            }
            
            const shangyebanSql = `SELECT ISNULL(SUM(CAST([订单金额] AS FLOAT)), 0) as 订单金额合计, ISNULL(SUM(CAST([退款金额] AS FLOAT)), 0) as 退款金额合计 
                                  FROM [微信收款商业版] WHERE [交易时间] >= '${start}' AND [交易时间] <= '${end}'`;
            
            // 从"微信商户下单"表统计
            const xiadanSql = `SELECT ISNULL(SUM(CAST([订单金额] AS FLOAT)), 0) as 订单金额合计, ISNULL(SUM(CAST([退款金额] AS FLOAT)), 0) as 退款金额合计 
                              FROM [微信商户下单] WHERE [交易时间] >= '${start}' AND [交易时间] <= '${end}'`;
            
            try {
                
                // 分别执行查询以便单独处理错误
                let shangyebanResult, xiadanResult;
                let shangyebanError = null;
                let xiadanError = null;
                
                try {
                    shangyebanResult = await callSqlWithRetry(shangyebanSql);
                } catch (err) {
                    shangyebanError = err;
                    // 设置为空结果
                    shangyebanResult = { results: [{ '订单金额合计': 0, '退款金额合计': 0 }] };
                }
                
                try {
                    xiadanResult = await callSqlWithRetry(xiadanSql);
                } catch (err) {
                    xiadanError = err;
                    // 设置为空结果
                    xiadanResult = { results: [{ '订单金额合计': 0, '退款金额合计': 0 }] };
                }
                
                // 如果有错误，记录警告但继续处理
                if (shangyebanError) {
                }
                if (xiadanError) {
                }
                
                if (!shangyebanResult || !shangyebanResult.results) {
                    shangyebanResult = { results: [{ '订单金额合计': 0, '退款金额合计': 0 }] };
                }
                
                if (!xiadanResult || !xiadanResult.results) {
                    xiadanResult = { results: [{ '订单金额合计': 0, '退款金额合计': 0 }] };
                }
                
                const shangyebanRow = shangyebanResult.results[0] || {};
                const shangyebanOrderAmount = parseFloat(shangyebanRow['订单金额合计'] || 0);
                const shangyebanRefundAmount = parseFloat(shangyebanRow['退款金额合计'] || 0);
                const shangyebanIncome = shangyebanOrderAmount - shangyebanRefundAmount;
                
                const xiadanRow = xiadanResult.results[0] || {};
                const xiadanOrderAmount = parseFloat(xiadanRow['订单金额合计'] || 0);
                const xiadanRefundAmount = parseFloat(xiadanRow['退款金额合计'] || 0);
                const xiadanIncome = xiadanOrderAmount - xiadanRefundAmount;
                
                // 计算微信总收入
                const totalIncome = shangyebanIncome + xiadanIncome;
                
                                __zhStatsTotals = {
                    shangyebanOrderAmount: shangyebanOrderAmount,
                    shangyebanRefundAmount: shangyebanRefundAmount,
                    shangyebanIncome: shangyebanIncome,
                    xiadanOrderAmount: xiadanOrderAmount,
                    xiadanRefundAmount: xiadanRefundAmount,
                    xiadanIncome: xiadanIncome,
                    totalIncome: totalIncome
                };
                
                updateZhStatsDisplay();
            } catch (err) {
                __zhStatsTotals = null;
                updateZhStatsDisplay();
            }
        }

        // 车颜知己洗车统计：按场所统计会员和非会员订单金额
        async function calculateCheyanzhijiStats() {
            const startInput = document.getElementById('zh-start-datetime');
            const endInput = document.getElementById('zh-end-datetime');
            const start = toSqlDateTime(startInput ? startInput.value : '', false);
            const end = toSqlDateTime(endInput ? endInput.value : '', true);

            if (!start || !end) {
                __zhStatsTotals = null;
                updateZhStatsDisplay();
                return;
            }

            // 使用聚合查询优化性能，避免查询大量数据
            const sql = `SELECT
                [场所],
                [使用会员卡],
                COUNT(*) AS orderCount,
                SUM(CAST([订单金额] AS FLOAT)) AS totalAmount
            FROM [车颜知己洗车]
            WHERE [启动时间] >= '${start}' AND [启动时间] <= '${end}' AND [订单状态] = '已完成'
            GROUP BY [场所], [使用会员卡]`;

            try {
                const result = await callSqlWithRetry(sql, 3, 1000);
                if (!result || !result.results) {
                    __zhStatsTotals = { error: '查询返回空结果，请检查数据或缩小时间范围' };
                    updateZhStatsDisplay();
                    return;
                }

                // 按场所统计
                const statsByPlace = {};
                let totalMemberAmount = 0;
                let totalNonMemberAmount = 0;

                result.results.forEach(row => {
                    const place = row['场所'] || '未知';
                    const useMemberCard = String(row['使用会员卡'] || '').trim();
                    const orderCount = parseInt(row['orderCount'] || 0);
                    const totalAmount = parseFloat(row['totalAmount'] || 0);

                    if (!statsByPlace[place]) {
                        statsByPlace[place] = {
                            memberCount: 0,
                            nonMemberAmount: 0
                        };
                    }

                    if (useMemberCard === '是') {
                        statsByPlace[place].memberCount += orderCount;
                    } else if (useMemberCard === '否') {
                        statsByPlace[place].nonMemberAmount += totalAmount;
                    }
                });

                // 计算每个场所的会员订单金额（订单数 × 7）
                const stats = {};
                Object.keys(statsByPlace).forEach(place => {
                    const memberAmount = statsByPlace[place].memberCount * 7;
                    const nonMemberAmount = statsByPlace[place].nonMemberAmount;
                    stats[place] = {
                        memberAmount: memberAmount,
                        nonMemberAmount: nonMemberAmount
                    };
                    totalMemberAmount += memberAmount;
                    totalNonMemberAmount += nonMemberAmount;
                });

                __zhStatsTotals = {
                    stats: stats,
                    totalMemberAmount: totalMemberAmount,
                    totalNonMemberAmount: totalNonMemberAmount
                };

                updateZhStatsDisplay();
            } catch (err) {
                console.error('车颜知己洗车统计查询失败:', err);
                let errorMsg = '统计查询失败';
                if (err.message) {
                    if (err.message.includes('406') || err.message.includes('Not Acceptable')) {
                        errorMsg = '数据量过大，请缩小时间范围后重试';
                    } else if (err.message.includes('CORS') || err.message.includes('Failed to fetch')) {
                        errorMsg = '网络请求失败，请通过HTTP服务器访问页面（不要直接打开HTML文件）';
                    } else {
                        errorMsg = '查询失败: ' + err.message.substring(0, 100);
                    }
                }
                __zhStatsTotals = { error: errorMsg };
                updateZhStatsDisplay();
            }
        }

        // 超时占位费统计：统计应收金额汇总
        async function calculateChaoshiStats() {
            const query = buildZhQuery();
            const sql = `SELECT SUM(CAST([应收金额] AS FLOAT)) as 应收金额合计 
                        FROM ${query.tableName} ${query.whereClause}`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results && result.results.length > 0) {
                    const totalAmount = parseFloat(result.results[0]['应收金额合计'] || 0);
                    
                    __zhStatsTotals = {
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                } else {
                    __zhStatsTotals = {
                        totalAmount: 0
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
                __zhStatsTotals = {
                    totalAmount: 0
                };
                updateZhStatsDisplay();
            }
        }

        // 快易洁洗车统计：按日期统计所有字段汇总
        async function calculateKuaijijieStats() {
            const query = buildZhQuery();
            // 获取所有数值列并统计
            const sql = `SELECT * FROM ${query.tableName} ${query.whereClause}`;
            
            try {
                const result = await callSqlWithRetry(sql);
                if (result && result.results) {
                    // 统计所有数值字段的总和
                    const stats = {};
                    let totalAmount = 0;
                    
                    // 获取第一行来确定字段
                    if (result.results.length > 0) {
                        const firstRow = result.results[0];
                        const numericFields = Object.keys(firstRow).filter(key => {
                            // 排除"日期"列
                            if (key === '日期') return false;
                            const val = firstRow[key];
                            return val !== null && val !== undefined && !isNaN(parseFloat(val));
                        });
                        
                        // 初始化统计
                        numericFields.forEach(field => {
                            stats[field] = 0;
                        });
                        
                        // 累加所有行
                        result.results.forEach(row => {
                            numericFields.forEach(field => {
                                const val = parseFloat(row[field] || 0);
                                stats[field] += val;
                                if (field.includes('金额') || field.includes('金额') || field.includes('费用') || field.includes('收入')) {
                                    totalAmount += val;
                                }
                            });
                        });
                    }
                    
                    __zhStatsTotals = {
                        stats: stats,
                        totalAmount: totalAmount
                    };
                    updateZhStatsDisplay();
                }
            } catch (err) {
            }
        }

        // 更新统计显示
        function updateZhStatsDisplay() {
            const resultContent = document.getElementById('zh-query-result-content');
            if (!resultContent) return;
            
            // 重新显示结果（包含统计）
            if (__lastZhQueryResults) {
                displayZhQueryResult(__lastZhQueryResults);
            }
        }

        // 显示综合数据查询结果
        function displayZhQueryResult(dataResult) {
            const resultContent = document.getElementById('zh-query-result-content');
            if (!resultContent) return;

            const rows = dataResult.results || [];
            const project = (document.getElementById('zh-project-select') || {}).value || '';
            
            let html = '';
            
            // 统计区域
            html += '<div id="zh-stats-container" style="margin-bottom:16px; padding:12px; background:#f8f9fa; border-radius:6px;">';
            if (__zhStatsTotals === null) {
                html += '<div style="color:#666;"><i class="fas fa-spinner fa-spin"></i> 统计计算中...</div>';
            } else {
                html += renderZhStats(project);
            }
            html += '</div>';

            // 数据表格
            if (rows.length === 0) {
                html += '<div style="padding:12px; color:#666;">未查询到数据</div>';
                resultContent.innerHTML = html;
                return;
            }

            // 分页信息
            const currentPage = __zhPagination.currentPage;
            const pageSize = __zhPagination.pageSize;
            const total = __zhPagination.total;
            const totalPages = Math.ceil(total / pageSize);
            
            html += `<div style="margin-bottom:12px; padding:8px; background:#e9ecef; border-radius:4px;">
                <span>共 ${total} 条记录，第 ${currentPage}/${totalPages} 页</span>
                <div style="display:inline-block; margin-left:16px;">
                    <button onclick="zhGoToPage(${currentPage - 1})" ${currentPage <= 1 ? 'disabled' : ''} 
                            style="padding:4px 8px; margin:0 4px; border:1px solid #ddd; border-radius:4px; background:#fff; cursor:pointer;">上一页</button>
                    <button onclick="zhGoToPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''} 
                            style="padding:4px 8px; margin:0 4px; border:1px solid #ddd; border-radius:4px; background:#fff; cursor:pointer;">下一页</button>
                </div>
            </div>`;

            // 表格
            if (rows.length > 0) {
                const cols = Object.keys(rows[0]);
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px;">';
                html += '<thead><tr style="background:#e9ecef;">';
                cols.forEach(col => {
                    html += `<th style="padding:8px; border:1px solid #ddd; text-align:center; font-weight:600;">${col}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                rows.forEach((row, idx) => {
                    const bg = idx % 2 === 0 ? '#fff' : '#f8f9fa';
                    html += '<tr>';
                    cols.forEach(col => {
                        let val = row[col] !== null && row[col] !== undefined ? row[col] : '';
                        html += `<td style="padding:8px; border:1px solid #ddd; text-align:center; background:${bg};">${val}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }

            resultContent.innerHTML = html;
        }

        // 渲染统计信息
        function renderZhStats(project) {
            if (!__zhStatsTotals) return '<div style="color:#666;">统计计算中...</div>';

            // 如果有错误信息，显示错误
            if (__zhStatsTotals.error) {
                return '<div style="color:#dc3545; padding:8px; background:#fff3cd; border:1px solid #ffc107; border-radius:4px;"><i class="fas fa-exclamation-triangle"></i> ' + __zhStatsTotals.error + '</div>';
            }

            let html = '<div style="font-weight:600; margin-bottom:8px; color:#333;">统计汇总</div>';
            
            if (project === '红门缴费') {
                const stats = __zhStatsTotals.stats;
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">';
                html += '<thead><tr style="background:#dee2e6;"><th style="padding:6px; border:1px solid #ddd;">收费场区</th><th style="padding:6px; border:1px solid #ddd;">支付方式</th><th style="padding:6px; border:1px solid #ddd;">交易金额</th></tr></thead><tbody>';
                
                // 计算所有支付方式的总金额（用于占比计算）
                const payMethodTotals = {};
                let grandTotal = 0;
                
                // 先遍历一次，计算每个支付方式的总金额
                Object.keys(stats).forEach(field => {
                    const payMethods = stats[field];
                    Object.keys(payMethods).forEach(payMethod => {
                        const amount = payMethods[payMethod];
                        if (!payMethodTotals[payMethod]) {
                            payMethodTotals[payMethod] = 0;
                        }
                        payMethodTotals[payMethod] += amount;
                        grandTotal += amount;
                    });
                });
                
                // 按指定顺序显示车场
                const fieldOrder = ['东区车场', '南区车场', '西区车场'];
                const otherFields = Object.keys(stats).filter(f => !fieldOrder.includes(f)).sort();
                const allFields = fieldOrder.concat(otherFields);
                
                allFields.forEach(field => {
                    if (!stats[field]) return;
                    
                    const payMethods = stats[field];
                    const payMethodKeys = Object.keys(payMethods).sort();
                    const rowCount = payMethodKeys.length;
                    let fieldSubtotal = 0;
                    
                    // 计算该车场的小计
                    payMethodKeys.forEach(payMethod => {
                        fieldSubtotal += payMethods[payMethod];
                    });
                    
                    // 显示该车场的所有支付方式
                    payMethodKeys.forEach((payMethod, idx) => {
                        const amount = payMethods[payMethod];
                        const bg = idx % 2 === 0 ? '#fff' : '#f8f9fa';
                        html += `<tr style="background:${bg};">
                            ${idx === 0 ? `<td rowspan="${rowCount}" style="padding:6px; border:1px solid #ddd; text-align:center; vertical-align:middle; font-weight:600;">${field}</td>` : ''}
                            <td style="padding:6px; border:1px solid #ddd; text-align:center;">${payMethod}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${amount.toFixed(2)}</td>
                        </tr>`;
                    });
                    
                    // 显示该车场的小计
                    if (rowCount > 0) {
                        html += `<tr style="background:#fff3cd;">
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600;"></td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600;">${field}小计</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; font-weight:600;">${fieldSubtotal.toFixed(2)}</td>
                        </tr>`;
                    }
                });
                
                html += '</tbody></table>';
                
                // 显示合计和支付方式汇总及占比（文本格式）
                html += `<div style="margin-top:12px;">`;
                
                // 构建支付方式汇总文本
                const payMethodSummary = Object.keys(payMethodTotals).sort().map(payMethod => {
                    const amount = payMethodTotals[payMethod];
                    const percentage = grandTotal > 0 ? ((amount / grandTotal) * 100).toFixed(2) : '0.00';
                    return `${payMethod} ${amount.toFixed(2)}(${percentage}%)`;
                }).join('   |   ');
                
                html += `<div style="display:flex; justify-content:space-between; align-items:center; font-weight:600;">
                    <span style="color:#007bff; font-size:50%;">${payMethodSummary}</span>
                    <span style="margin-left:auto; padding-left:20px; color:#28a745;">合计: ${__zhStatsTotals.totalAmount.toFixed(2)}</span>
                </div>`;
                html += `</div>`;
                
            } else if (project === '月租车充值') {
                const stats = __zhStatsTotals.stats;
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">';
                html += '<thead><tr style="background:#dee2e6;"><th style="padding:6px; border:1px solid #ddd;">车牌类型</th><th style="padding:6px; border:1px solid #ddd;">支付方式</th><th style="padding:6px; border:1px solid #ddd;">交款金额</th></tr></thead><tbody>';
                
                // 计算所有支付方式的总金额（用于占比计算）
                const payMethodTotals = {};
                let grandTotal = 0;
                
                // 先遍历一次，计算每个支付方式的总金额
                Object.keys(stats).forEach(category => {
                    const payMethods = stats[category] || {};
                    Object.keys(payMethods).forEach(payMethod => {
                        const amount = payMethods[payMethod];
                        if (!payMethodTotals[payMethod]) {
                            payMethodTotals[payMethod] = 0;
                        }
                        payMethodTotals[payMethod] += amount;
                        grandTotal += amount;
                    });
                });
                
                // 按指定顺序显示车牌类型
                const categoryOrder = ['东区', '西区', '南区'];
                
                categoryOrder.forEach(category => {
                    if (!stats[category]) return;
                    
                    const payMethods = stats[category] || {};
                    const payMethodKeys = Object.keys(payMethods).filter(pm => payMethods[pm] > 0).sort();
                    const rowCount = payMethodKeys.length;
                    let categorySubtotal = 0;
                    
                    // 计算该车牌类型的小计
                    payMethodKeys.forEach(payMethod => {
                        categorySubtotal += payMethods[payMethod];
                    });
                    
                    // 显示该车牌类型的所有支付方式
                    payMethodKeys.forEach((payMethod, idx) => {
                        const amount = payMethods[payMethod];
                        const bg = idx % 2 === 0 ? '#fff' : '#f8f9fa';
                        html += `<tr style="background:${bg};">
                            ${idx === 0 ? `<td rowspan="${rowCount}" style="padding:6px; border:1px solid #ddd; text-align:center; vertical-align:middle; font-weight:600;">${category}</td>` : ''}
                            <td style="padding:6px; border:1px solid #ddd; text-align:center;">${payMethod}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right;">${amount.toFixed(2)}</td>
                        </tr>`;
                    });
                    
                    // 显示该车牌类型的小计
                    if (rowCount > 0) {
                        html += `<tr style="background:#fff3cd;">
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600;"></td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600;">${category}小计</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; font-weight:600;">${categorySubtotal.toFixed(2)}</td>
                        </tr>`;
                    }
                });
                
                html += '</tbody></table>';
                
                // 显示合计和支付方式汇总及占比（文本格式）
                const payMethodSummary = Object.keys(payMethodTotals).sort().map(payMethod => {
                    const amount = payMethodTotals[payMethod];
                    const percentage = grandTotal > 0 ? ((amount / grandTotal) * 100).toFixed(2) : '0.00';
                    return `${payMethod} ${amount.toFixed(2)}(${percentage}%)`;
                }).join('   |   ');
                
                html += `<div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center; font-weight:600;">
                    <span style="color:#007bff; font-size:50%;">${payMethodSummary}</span>
                    <span style="margin-left:auto; padding-left:20px; color:#28a745;">合计: ${__zhStatsTotals.totalAmount.toFixed(2)}</span>
                </div>`;
                
            } else if (project === '兴元售货机') {
                const stats = __zhStatsTotals.stats;
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px; table-layout:fixed;">';
                html += '<thead><tr style="background:#dee2e6;">';
                html += '<th style="padding:6px; border:1px solid #ddd; width:25%;">机器名称</th>';
                html += '<th style="padding:6px; border:1px solid #ddd; width:18%;">支付方式</th>';
                html += '<th style="padding:6px; border:1px solid #ddd; width:19%;">支付金额</th>';
                html += '<th style="padding:6px; border:1px solid #ddd; width:19%;">退款金额</th>';
                html += '<th style="padding:6px; border:1px solid #ddd; width:19%;">实际金额</th>';
                html += '</tr></thead><tbody>';
                
                // 先处理自定义分组（东区、西区、南区），然后处理其他
                const categories = ['东区', '西区', '南区'];
                const otherCategories = Object.keys(stats).filter(cat => !categories.includes(cat)).sort();
                const allCategories = categories.concat(otherCategories);
                
                allCategories.forEach(category => {
                    if (!stats[category]) return;
                    
                    const payMethods = stats[category];
                    const payMethodKeys = Object.keys(payMethods).sort();
                    const rowCount = payMethodKeys.length;
                    let categoryPayAmount = 0;
                    let categoryRefundAmount = 0;
                    let categoryActualAmount = 0;
                    
                    // 计算该分组的小计
                    payMethodKeys.forEach(payMethod => {
                        const data = payMethods[payMethod];
                        categoryPayAmount += data.payAmount;
                        categoryRefundAmount += data.refundAmount;
                        categoryActualAmount += data.actualAmount;
                    });
                    
                    // 显示该分组的所有支付方式（只显示category名称，不显示具体机器名称）
                    payMethodKeys.forEach((payMethod, idx) => {
                        const data = payMethods[payMethod];
                        const bg = idx % 2 === 0 ? '#fff' : '#f8f9fa';
                        html += `<tr style="background:${bg};">
                            ${idx === 0 ? `<td rowspan="${rowCount}" style="padding:6px; border:1px solid #ddd; text-align:center; vertical-align:middle; font-weight:600; width:25%;">${category}</td>` : ''}
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; width:18%;">${payMethod}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; width:19%;">${data.payAmount.toFixed(2)}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; width:19%;">${data.refundAmount.toFixed(2)}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; width:19%;">${data.actualAmount.toFixed(2)}</td>
                        </tr>`;
                    });
                    
                    // 显示该分组的小计
                    if (rowCount > 0) {
                        html += `<tr style="background:#fff3cd;">
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600; width:25%;"></td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:center; font-weight:600; width:18%;">${category}小计</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; font-weight:600; width:19%;">${categoryPayAmount.toFixed(2)}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; font-weight:600; width:19%;">${categoryRefundAmount.toFixed(2)}</td>
                            <td style="padding:6px; border:1px solid #ddd; text-align:right; font-weight:600; width:19%;">${categoryActualAmount.toFixed(2)}</td>
                        </tr>`;
                    }
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top:8px; font-weight:600;">
                    <span style="color:#007bff;">支付金额合计: ${__zhStatsTotals.totalPayAmount.toFixed(2)}</span> | 
                    <span style="color:#dc3545;">退款金额合计: ${__zhStatsTotals.totalRefundAmount.toFixed(2)}</span> | 
                    <span style="color:#28a745;">实际金额合计: ${__zhStatsTotals.totalActualAmount.toFixed(2)}</span>
                </div>`;
            } else if (project === '赛菲姆道闸') {
                // 赛菲姆道闸：按支付方式统计
                const stats = __zhStatsTotals.stats || {};
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">';
                html += '<thead><tr style="background:#dee2e6;"><th style="padding:6px; border:1px solid #ddd;">支付方式</th><th style="padding:6px; border:1px solid #ddd;">支付金额</th></tr></thead><tbody>';
                
                Object.keys(stats).sort().forEach(payMethod => {
                    const amount = stats[payMethod];
                    html += `<tr style="background:#fff;">
                        <td style="padding:6px; border:1px solid #ddd; text-align:center;">${payMethod}</td>
                        <td style="padding:6px; border:1px solid #ddd; text-align:right;">${amount.toFixed(2)}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top:8px; font-weight:600; color:#28a745;">合计: ${__zhStatsTotals.totalAmount.toFixed(2)}</div>`;
            } else if (project === '收钱吧') {
                // 收钱吧：按收款通道/支付方式统计
                const stats = __zhStatsTotals.stats || {};
                html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">';
                html += '<thead><tr style="background:#dee2e6;"><th style="padding:6px; border:1px solid #ddd;">收款通道/支付方式</th><th style="padding:6px; border:1px solid #ddd;">收款金额</th></tr></thead><tbody>';
                
                Object.keys(stats).sort().forEach(channel => {
                    const amount = stats[channel];
                    html += `<tr style="background:#fff;">
                        <td style="padding:6px; border:1px solid #ddd; text-align:center;">${channel}</td>
                        <td style="padding:6px; border:1px solid #ddd; text-align:right;">${amount.toFixed(2)}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top:8px; font-weight:600; color:#28a745;">合计: ${__zhStatsTotals.totalAmount.toFixed(2)}</div>`;
            } else if (project === '智小盟') {
                // 智小盟：显示实收金额合计
                html += `<div style="margin-top:8px; font-weight:600; color:#28a745;">实收金额合计: ${(__zhStatsTotals.totalAmount || 0).toFixed(2)}</div>`;
            } else if (project === '快易洁洗车') {
                // 快易洁洗车：显示所有字段汇总
                const stats = __zhStatsTotals.stats || {};
                if (Object.keys(stats).length > 0) {
                    html += '<table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">';
                    html += '<thead><tr style="background:#dee2e6;"><th style="padding:6px; border:1px solid #ddd;">字段</th><th style="padding:6px; border:1px solid #ddd;">汇总</th></tr></thead><tbody>';
                    
                    Object.keys(stats).sort().forEach(field => {
                        const value = stats[field];
                        // 如果是"返还总额"字段，使用特殊样式
                        if (field === '返还总额') {
                            html += `<tr style="background:#fff;">
                                <td style="padding:6px; border:1px solid #ddd; text-align:center; color:#dc3545; font-size:16px; font-weight:bold;">${field}</td>
                                <td style="padding:6px; border:1px solid #ddd; text-align:right; color:#dc3545; font-size:16px; font-weight:bold;">${parseFloat(value).toFixed(2)}</td>
                            </tr>`;
                        } else {
                            html += `<tr style="background:#fff;">
                                <td style="padding:6px; border:1px solid #ddd; text-align:center;">${field}</td>
                                <td style="padding:6px; border:1px solid #ddd; text-align:right;">${parseFloat(value).toFixed(2)}</td>
                            </tr>`;
                        }
                    });
                    
                    html += '</tbody></table>';
                    if (__zhStatsTotals.totalAmount > 0) {
                        html += `<div style="margin-top:8px; font-weight:600; color:#28a745;">金额合计: ${__zhStatsTotals.totalAmount.toFixed(2)}</div>`;
                    }
                }
            } else if (project === '车海洋洗车') {
                // 车海洋洗车：显示消费金额、消费返还金额、充值金额、充值返还金额、返还总额
                const stats = __zhStatsTotals || {};
                html += `<div style="margin-top:8px; font-size:14px; line-height:1.8;">
                    <div>消费金额：<span style="color:#28a745; font-weight:bold;">${(stats.consumeAmount || 0).toFixed(2)}</span>元</div>
                    <div>消费返还金额：<span style="color:#28a745; font-weight:bold;">${(stats.consumeRefund || 0).toFixed(2)}</span>元</div>
                    <div>充值金额：<span style="color:#28a745; font-weight:bold;">${(stats.rechargeAmount || 0).toFixed(2)}</span>元</div>
                    <div>充值返还金额：<span style="color:#28a745; font-weight:bold;">${(stats.rechargeRefund || 0).toFixed(2)}</span>元</div>
                    <div style="margin-top:6px; padding-top:6px; border-top:1px solid #dee2e6; font-weight:600;">返还总额：<span style="color:#dc3545; font-weight:bold;">${(stats.totalRefund || 0).toFixed(2)}</span>元</div>
                </div>`;
            } else if (project === '微信') {
                // 微信：显示微信扫码收入和微信商户下单收入
                const stats = __zhStatsTotals || {};
                html += `<div style="margin-top:8px; font-size:14px; line-height:1.8;">
                    <div>微信扫码收入：<span style="color:#28a745; font-weight:bold;">${(stats.shangyebanIncome || 0).toFixed(2)}</span>元：订单金额<span style="color:#28a745;">${(stats.shangyebanOrderAmount || 0).toFixed(2)}</span>元   退款金额<span style="color:#dc3545;">${(stats.shangyebanRefundAmount || 0).toFixed(2)}</span>元</div>
                    <div style="margin-top:8px;">微信商户下单收入：<span style="color:#28a745; font-weight:bold;">${(stats.xiadanIncome || 0).toFixed(2)}</span>元：订单金额<span style="color:#28a745;">${(stats.xiadanOrderAmount || 0).toFixed(2)}</span>元   退款金额<span style="color:#dc3545;">${(stats.xiadanRefundAmount || 0).toFixed(2)}</span>元</div>
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #dee2e6; font-weight:600;">微信总收入：<span style="color:#007bff; font-weight:bold;">${(stats.totalIncome || 0).toFixed(2)}</span>元</div>
                </div>`;
            } else if (project === '车颜知己洗车') {
                // 车颜知己洗车：按场所显示会员和非会员订单金额
                const stats = __zhStatsTotals.stats || {};
                html += '<div style="margin-top:8px; font-size:14px; line-height:1.8;">';
                
                // 按场所显示
                Object.keys(stats).sort().forEach(place => {
                    const memberAmount = stats[place].memberAmount || 0;
                    const nonMemberAmount = stats[place].nonMemberAmount || 0;
                    html += `<div>${place}   会员订单金额 <span style="color:#28a745; font-weight:bold;">${memberAmount.toFixed(2)}</span>元   非会员订单金额 <span style="color:#28a745; font-weight:bold;">${nonMemberAmount.toFixed(2)}</span>元</div>`;
                });
                
                // 汇总
                const totalMemberAmount = __zhStatsTotals.totalMemberAmount || 0;
                const totalNonMemberAmount = __zhStatsTotals.totalNonMemberAmount || 0;
                const totalOrderAmount = totalMemberAmount + totalNonMemberAmount;
                html += `<div style="margin-top:12px; padding-top:12px; border-top:1px solid #dee2e6; font-weight:600; display:flex; justify-content:space-between; align-items:center;">
                    <span>会员订单金额小计 <span style="color:#007bff; font-weight:bold;">${totalMemberAmount.toFixed(2)}</span>元    非会员订单金额小计 <span style="color:#007bff; font-weight:bold;">${totalNonMemberAmount.toFixed(2)}</span>元</span>
                    <span style="margin-left:auto; padding-left:20px;">订单金额总计：<span style="color:#28a745; font-weight:bold;">${totalOrderAmount.toFixed(2)}</span>元</span>
                </div>`;
                html += '</div>';
            } else if (project === '超时占位费') {
                // 超时占位费：显示超时占位费收入
                const stats = __zhStatsTotals || {};
                html += `<div style="margin-top:8px; font-size:14px; line-height:1.8;">
                    <div>超时占位费收入：<span style="color:#28a745; font-weight:bold;">${(stats.totalAmount || 0).toFixed(2)}</span>元</div>
                </div>`;
            } else if (!__zhStatsTotals) {
                // 其他项目：暂无统计
                html += '<div style="color:#666;">暂无统计数据</div>';
            }
            
            return html;
        }

        // 综合数据分页
        function zhGoToPage(page) {
            const totalPages = Math.max(1, Math.ceil(__zhPagination.total / __zhPagination.pageSize));
            if (page < 1 || page > totalPages) return;
            
            __zhPagination.currentPage = page;
            const offset = (page - 1) * __zhPagination.pageSize;
            const startRn = offset + 1;
            const endRn = offset + __zhPagination.pageSize;
            
            const tableName = __zhPagination.tableName || '';
            const whereClause = __zhPagination.whereClause || '';
            const timeField = __zhPagination.timeField || '缴费时间';
            
            if (!tableName) {
                return;
            }
            
            // 使用 ROW_NUMBER 分页（兼容后端）
            // 根据项目类别设置查询列
            const project = (document.getElementById('zh-project-select') || {}).value || '';
            const config = PROJECT_CONFIG_MAP.get(project);
            
            const selectCols = config ? config.selectColumns : '*';
            const orderByType = config ? config.orderByType : 'normal';
            
            const innerFrom = `FROM ${tableName} ${whereClause}`;
            // 使用通用函数构建ORDER BY子句
            const overOrder = buildOrderByClause(timeField, orderByType, 'DESC');
            
            // 构建分页SQL：如果配置了selectColumns且不是'*'，则使用指定列
            let pageSql;
            if (config && config.selectColumns !== '*') {
                // 指定列的项目：外层选择指定列
                pageSql = `SELECT ${selectCols} FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
            } else {
                // 其他：外层选择所有列（排除rn）
                pageSql = `SELECT * FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
            }
            
            const resultContent = document.getElementById('zh-query-result-content');
            if (resultContent) {
                resultContent.innerHTML = '<div style="padding:12px;"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
            }
            
            callSqlWithRetry(pageSql)
                .then(dataResult => {
                    if (dataResult && dataResult.results) {
                        // 移除ROW_NUMBER列（如果存在）
                        const cleanedResults = dataResult.results.map(row => {
                            const cleaned = { ...row };
                            delete cleaned.rn;
                            // 根据项目类别过滤列
                            if (project === '兴元售货机') {
                                const allowedCols = ['商户名称', '销售额', '货道编号', '商品名称', '支付账号', '支付方式', '支付金额', '出货状态', '退款金额', '支付时间'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            } else if (project === '赛菲姆道闸') {
                                const allowedCols = ['车牌号码', '订单类型', '支付金额', '支付时间', '支付方式', '开始时间', '结束时间'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            } else if (project === '收钱吧') {
                                const allowedCols = ['交易日期', '收款通道/支付方式', '交易状态', '收款金额'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            } else if (project === '智小盟') {
                                const allowedCols = ['设备名称', '实收金额 ', '支付方式', '支付时间'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            } else if (project === '车海洋洗车') {
                                // 车海洋洗车：输出所有列，不需要过滤
                                return cleaned;
                            } else if (project === '微信') {
                                const allowedCols = ['交易时间', '商户号', '微信订单号', '订单金额', '退款金额'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            } else if (project === '车颜知己洗车') {
                                const allowedCols = ['场所', '启动时间', '停止时间', '订单金额', '使用会员卡', '订单状态'];
                                const filtered = {};
                                allowedCols.forEach(col => {
                                    if (cleaned.hasOwnProperty(col)) {
                                        filtered[col] = cleaned[col];
                                    }
                                });
                                return filtered;
                            }
                            return cleaned;
                        });
                        __zhPagination.results = cleanedResults;
                        const payload = { success: true, results: cleanedResults, rowCount: cleanedResults.length };
                        displayZhQueryResult(payload);
                    } else {
                        throw new Error('查询结果格式错误');
                    }
                })
                .catch(err => {
                    if (resultContent) {
                        resultContent.innerHTML = '<div style="color:#c00; padding:12px;">加载失败: ' + (err.message || '未知错误') + '</div>';
                    }
                });
        }

        // 综合数据导出Excel（导出原表所有列）
        function exportZhToExcel(exportAll = false) {
            if (!exportAll) {
                // 导出当前页：使用原表所有列
                const project = (document.getElementById('zh-project-select') || {}).value || '综合数据';
                const tableName = __zhPagination.tableName || '';
                const whereClause = __zhPagination.whereClause || '';
                const timeField = __zhPagination.timeField || '缴费时间';
                
                if (!tableName || !whereClause) {
                    alert('没有可导出的数据，请先执行查询');
                    return;
                }
                
                // 查询当前页的所有列（使用*而不是过滤后的列）
                const orderByFinal = __zhPagination.orderByFinal || `ORDER BY [${timeField}] DESC`;
                const currentPage = __zhPagination.currentPage || 1;
                const pageSize = __zhPagination.pageSize || 20;
                const offset = (currentPage - 1) * pageSize;
                const startRn = offset + 1;
                const endRn = offset + pageSize;
                
                const innerFrom = `FROM ${tableName} ${whereClause}`;
                let overOrder = orderByFinal;
                // 如果orderByFinal包含LTRIM，需要保持
                if (project === '智小盟' && !overOrder.includes('LTRIM')) {
                    overOrder = `ORDER BY LTRIM(RTRIM([${timeField}])) DESC`;
                }
                
                const dataSql = `SELECT * FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                
                // 显示加载提示
                const loadingMsg = alert('正在查询原表数据，请稍候...');
                
                callSqlWithRetry(dataSql).then(dataResult => {
                    if (dataResult && dataResult.results) {
                        // 移除rn列
                        const rows = dataResult.results.map(row => {
                            const filtered = {};
                            Object.keys(row).forEach(key => {
                                if (key !== 'rn') {
                                    filtered[key] = row[key];
                                }
                            });
                            return filtered;
                        });
                        
                        const ws = XLSX.utils.json_to_sheet(rows);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, project);
                        XLSX.writeFile(wb, `${project}查询_第${currentPage}页.xlsx`);
                    } else {
                        alert('导出失败：查询结果为空');
                    }
                }).catch(err => {
                    alert('导出失败：' + (err.message || '未知错误'));
                });
                return;
            }
            
            // 批量导出全部数据：使用原表所有列
            const total = __zhPagination ? __zhPagination.total : 0;
            if (total === 0) {
                alert('没有可导出的数据');
                return;
            }
            
            const project = (document.getElementById('zh-project-select') || {}).value || '综合数据';
            const tableName = __zhPagination.tableName || '';
            const whereClause = __zhPagination.whereClause || '';
            const timeField = __zhPagination.timeField || '缴费时间';
            
            // 显示进度对话框
            const progressDialog = document.createElement('div');
            progressDialog.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;';
            progressDialog.innerHTML = `
                <div style="background:#fff; padding:24px; border-radius:8px; min-width:400px; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                    <h3 style="margin:0 0 16px 0; font-size:18px; color:#333;">正在导出全部数据</h3>
                    <div style="margin-bottom:8px;">
                        <div id="zh-export-progress-text" style="font-size:14px; color:#666; margin-bottom:8px;">准备中...</div>
                        <div style="background:#e9ecef; border-radius:4px; height:24px; overflow:hidden;">
                            <div id="zh-export-progress-bar" style="background:#28a745; height:100%; width:0%; transition:width 0.3s; display:flex; align-items:center; justify-content:center; color:#fff; font-size:12px; font-weight:bold;">0%</div>
                        </div>
                    </div>
                    <button id="zh-cancel-export-progress-btn" style="margin-top:12px; width:100%; padding:8px 16px; background:#dc3545; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px;">取消导出</button>
                </div>
            `;
            document.body.appendChild(progressDialog);
            
            let cancelled = false;
            document.getElementById('zh-cancel-export-progress-btn').onclick = () => {
                cancelled = true;
                document.body.removeChild(progressDialog);
            };
            
            // 批量查询并导出
            (async () => {
                try {
                    const batchSize = 5000; // 每批5000条
                    const totalBatches = Math.ceil(total / batchSize);
                    let allRows = [];
                    
                    const innerFrom = `FROM ${tableName} ${whereClause}`;
                    let overOrder = `ORDER BY [${timeField}] DESC`;
                    if (project === '智小盟') {
                        overOrder = `ORDER BY LTRIM(RTRIM([${timeField}])) DESC`;
                    }
                    
                    for (let batch = 0; batch < totalBatches && !cancelled; batch++) {
                        const offset = batch * batchSize;
                        const startRn = offset + 1;
                        const endRn = Math.min(total, offset + batchSize);
                        
                        // 更新进度
                        const progress = Math.round(((batch + 1) / totalBatches) * 100);
                        document.getElementById('zh-export-progress-text').textContent = `正在查询第 ${batch + 1}/${totalBatches} 批数据（已获取 ${allRows.length.toLocaleString()} 条）...`;
                        document.getElementById('zh-export-progress-bar').style.width = progress + '%';
                        document.getElementById('zh-export-progress-bar').textContent = progress + '%';
                        
                        // 构建分页SQL（使用*查询所有列）
                        const pageSql = `SELECT * FROM (SELECT ROW_NUMBER() OVER (${overOrder}) AS rn, * ${innerFrom}) t WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                        
                        const result = await callSqlWithRetry(pageSql, 3, 800);
                        if (result && result.results) {
                            // 移除rn列
                            const cleanedResults = result.results.map(row => {
                                const filtered = {};
                                Object.keys(row).forEach(key => {
                                    if (key !== 'rn') {
                                        filtered[key] = row[key];
                                    }
                                });
                                return filtered;
                            });
                            allRows = allRows.concat(cleanedResults);
                        }
                    }
                    
                    if (cancelled) {
                        return;
                    }
                    
                    // 生成Excel
                    document.getElementById('zh-export-progress-text').textContent = '正在生成Excel文件...';
                    document.getElementById('zh-export-progress-bar').style.width = '95%';
                    document.getElementById('zh-export-progress-bar').textContent = '95%';
                    
                    const ws = XLSX.utils.json_to_sheet(allRows);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, project);
                    XLSX.writeFile(wb, `${project}查询_全部_${total.toLocaleString()}条.xlsx`);
                    
                    document.getElementById('zh-export-progress-text').textContent = '导出完成！';
                    document.getElementById('zh-export-progress-bar').style.width = '100%';
                    document.getElementById('zh-export-progress-bar').textContent = '100%';
                    
                    setTimeout(() => {
                        document.body.removeChild(progressDialog);
                        alert(`导出成功！共导出 ${allRows.length.toLocaleString()} 条数据。`);
                    }, 500);
                    
                } catch (e) {
                    document.body.removeChild(progressDialog);
                    alert('导出失败：' + (e.message || '未知错误'));
                }
            })();
        }

        // 设置综合数据导出按钮状态
        function setZhExportEnabled(enabled) {
            const btn = document.getElementById('zh-export-btn');
            if (!btn) return;
            if (enabled) {
                btn.disabled = false;
                btn.style.background = '#007bff';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.background = '#adb5bd';
                btn.style.cursor = 'not-allowed';
            }
        }

        // 初始化综合数据页面
        setTimeout(() => {
            initZhDatetimePickers();
            setZhExportEnabled(false);
            
            // 更新导航函数，确保综合数据页面显示时更新面包屑
            const originalShowZh = window.showZh;
            if (typeof originalShowZh !== 'function') {
                // 如果setupDataQueryPages还没执行，稍后再设置
                setTimeout(() => {
                    const btnZh = document.getElementById('menu-zh-data');
                    if (btnZh) {
                        btnZh.addEventListener('click', function(e) {
                            const breadcrumbLeaf = document.getElementById('breadcrumb-leaf-zh');
                            if (breadcrumbLeaf) breadcrumbLeaf.textContent = '综合数据';
                        });
                    }
                }, 100);
            }
        }, 0);

        // ========= 用户数据查询相关函数 =========

        // 存储最后一次查询结果
        let __lastUserQueryResults = null;

        // 用户数据分页状态（前端分页，每页20条）
        let __userPagination = {
            enabled: false,
            pageSize: 20,
            currentPage: 1,
            total: 0,
            rows: [],
            deviceType: '',
            columns: []
        };

        function ensureUserPaginationBar() {
            const container = document.getElementById('user-query-result');
            if (!container) return null;
            let bar = document.getElementById('user-pagination-top');
            if (!bar) {
                bar = document.createElement('div');
                bar.id = 'user-pagination-top';
                bar.style.margin = '8px 0';
                const contentEl = document.getElementById('user-query-result-content');
                if (contentEl) {
                    container.insertBefore(bar, contentEl);
                } else {
                    container.appendChild(bar);
                }
            }
            return bar;
        }

        function renderUserPagination() {
            const bar = ensureUserPaginationBar();
            if (!bar) return;
            if (!__userPagination.enabled || __userPagination.total === 0) {
                bar.innerHTML = '';
                return;
            }
            const totalPages = Math.max(1, Math.ceil(__userPagination.total / __userPagination.pageSize));
            bar.innerHTML = `
                <div style="padding:6px 8px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px; display:flex; align-items:center; gap:8px;">
                    <button id="user-pg-first" style="padding:4px 8px;">首页</button>
                    <button id="user-pg-prev" style="padding:4px 8px;">上一页</button>
                    <span>第 <strong>${__userPagination.currentPage}</strong> / ${totalPages} 页</span>
                    <span>共 <strong>${__userPagination.total}</strong> 条</span>
                    <button id="user-pg-next" style="padding:4px 8px;">下一页</button>
                    <button id="user-pg-last" style="padding:4px 8px;">末页</button>
                </div>`;
            const lastPage = totalPages;
            const firstBtn = document.getElementById('user-pg-first');
            const prevBtn = document.getElementById('user-pg-prev');
            const nextBtn = document.getElementById('user-pg-next');
            const lastBtn = document.getElementById('user-pg-last');
            if (firstBtn) firstBtn.onclick = () => goToUserPage(1);
            if (prevBtn) prevBtn.onclick = () => goToUserPage(Math.max(1, __userPagination.currentPage - 1));
            if (nextBtn) nextBtn.onclick = () => goToUserPage(Math.min(lastPage, __userPagination.currentPage + 1));
            if (lastBtn) lastBtn.onclick = () => goToUserPage(lastPage);
        }

        function goToUserPage(page) {
            if (!__userPagination.enabled) return;
            const totalPages = Math.max(1, Math.ceil(__userPagination.total / __userPagination.pageSize));
            const targetPage = Math.min(Math.max(page, 1), totalPages);
            if (targetPage === __userPagination.currentPage) return;
            __userPagination.currentPage = targetPage;
            renderUserTablePage();
            renderUserPagination();
        }

        function renderUserTablePage() {
            const resultContent = document.getElementById('user-query-result-content');
            if (!resultContent) return;
            if (!__userPagination.enabled || !Array.isArray(__userPagination.rows) || __userPagination.rows.length === 0) {
                resultContent.innerHTML = '';
                return;
            }

            const rows = __userPagination.rows;
            const columns = Array.isArray(__userPagination.columns) ? __userPagination.columns : [];
            const pageSize = __userPagination.pageSize || 20;
            const currentPage = __userPagination.currentPage || 1;
            const total = __userPagination.total || rows.length;
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, total);
            const pageRows = rows.slice(startIndex, endIndex);

            if (columns.length === 0) {
                resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">暂无可显示的列</div>';
                return;
            }

            let tableHtml = '<table style="width:100%; border-collapse:collapse; font-size:14px;">';
            tableHtml += '<thead><tr style="background:#f8f9fa; font-weight:bold;">';
            columns.forEach(col => {
                tableHtml += `<th style="padding:10px; border:1px solid #ddd; text-align:left;">${col}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            pageRows.forEach((row, index) => {
                const rowClass = index % 2 === 0 ? 'background:#ffffff;' : 'background:#f9f9f9;';
                tableHtml += `<tr style="${rowClass}">`;
                if (__userPagination.deviceType === '车牌号') {
                    columns.forEach(col => {
                        let value = row[col];
                        if (value === undefined || value === null) {
                            const fallbackKey = col.replace(/\(.*?\)/g, '');
                            value = row[fallbackKey];
                        }
                        if (value === undefined || value === null) value = '';
                        tableHtml += `<td style="padding:8px; border:1px solid #ddd;">${value}</td>`;
                    });
                } else {
                    columns.forEach(col => {
                        let value = row[col];
                        if (value === undefined || value === null) value = '';
                        tableHtml += `<td style="padding:8px; border:1px solid #ddd;">${value}</td>`;
                    });
                }
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            resultContent.innerHTML = tableHtml;
        }

        // 设置导出按钮状态
        function setUserExportEnabled(enabled) {
            const btn = document.getElementById('user-export-btn');
            if (!btn) return;
            btn.disabled = !enabled;
            if (enabled) {
                btn.style.background = '#28a745';
                btn.style.cursor = 'pointer';
            } else {
                btn.style.background = '#adb5bd';
                btn.style.cursor = 'not-allowed';
            }
        }

        // 初始化用户数据页面的日期选择器
        function initUserDatetimePickers() {
            try {
                // 设置默认值：开始为当天 00:00:00，结束为当天 23:59:59
                const now = new Date();
                const defaultValues = {
                    start: now.toISOString().slice(0, 10) + ' 00:00:00',
                    end: now.toISOString().slice(0, 10) + ' 23:59:59'
                };

                // 使用统一的日期选择器初始化函数
                initDatetimePickers('user-start-datetime', 'user-end-datetime', 'user-start-date-btn', 'user-end-date-btn', defaultValues);
                        } catch (e) {
                console.error('初始化用户数据页面日期选择器失败:', e);
            }
        }

        // 判断是否为11位手机号
        function isPhoneNumber(input) {
            return /^\d{11}$/.test(input.trim());
        }

        // 当以手机号查询时，将数值字段统一保留两位小数，并格式化充电时长
        function formatUserPhoneRow(row) {
            if (!row || typeof row !== 'object') return row;
            const formatted = { ...row };
            const numericFields = ['充电量', '电费', '服务费', '消费金额'];
            
            numericFields.forEach(field => {
                if (formatted[field] !== undefined && formatted[field] !== null && formatted[field] !== '') {
                    const normalized = String(formatted[field]).trim().replace(/[¥￥,，\s]/g, '');
                    const num = parseFloat(normalized);
                    if (!isNaN(num)) {
                        formatted[field] = num.toFixed(2);
                    }
                }
            });
            
            if (formatted['充电时长']) {
                formatted['充电时长'] = formatDuration(formatted['充电时长']);
            }
            
            return formatted;
        }

        // 构建用户数据查询SQL
        function buildUserQuery() {
            const userInput = (document.getElementById('user-input') || {}).value || '';
            const timeField = (document.getElementById('user-time-field-select') || {}).value || '充电结束时间';
            const startTime = (document.getElementById('user-start-datetime') || {}).value || '';
            const endTime = (document.getElementById('user-end-datetime') || {}).value || '';

            if (!userInput) {
                return { ok: false, error: '请输入车牌号或手机号' };
            }

            if (!startTime || !endTime) {
                return { ok: false, error: '请选择时间范围' };
            }

            const start = toSqlDateTime(startTime, false);
            const end = toSqlDateTime(endTime, true);

            let sql = '';
            let tableName = '';
            let deviceType = '';
            let sqlTeld = '';  // 特来电SQL
            let sqlDidi = '';  // 滴滴SQL

            if (isPhoneNumber(userInput)) {
                // 手机号查询：查询能科表，卡号字段前面补5个0
                deviceType = '手机号';
                tableName = '[能科]';
                const phoneWithZeros = '00000' + userInput.trim();
                const esc = phoneWithZeros.replace(/'/g, "''");
                sql = `SELECT TOP 10000 * FROM [能科] WHERE [卡号] = N'${esc}' AND [结束日期时间] BETWEEN '${start}' AND '${end}' ORDER BY [结束日期时间] DESC`;
            } else {
                // 车牌号查询：同时查询特来电表和滴滴表
                deviceType = '车牌号';
                tableName = '[特来电]';
                const plateNumber = userInput.trim().replace(/ /g, '');
                
                // 处理车牌号格式：将星号(*)转换为SQL通配符(%)
                // 例如：湘A***053 -> 湘A%053，用于匹配特来电表中所有符合该模式的车牌号
                // 滴滴表中车牌号格式为"湘A***053"（星号是实际字符），在特来电表中需要匹配所有"湘A***053"模式的数据
                // 如果输入包含星号，将星号转换为通配符；如果不包含星号，也尝试匹配（在字母和数字之间插入通配符）
                let teldPattern = plateNumber.replace(/\*/g, '%');
                // 如果输入不包含星号，但格式类似"省份+字母+数字结尾"（如"湘A053"），
                // 则在字母和数字之间插入通配符，以匹配所有"湘A***053"格式的数据
                if (!plateNumber.includes('*')) {
                    // 匹配格式：省份+字母+数字结尾，例如"湘A053"、"京B123"等
                    const match = plateNumber.match(/^([\u4e00-\u9fa5]+[A-Za-z]+)(\d+)$/);
                    if (match) {
                        const prefix = match[1]; // 例如："湘A"
                        const suffix = match[2]; // 例如："053"
                        teldPattern = prefix + '%' + suffix; // 例如："湘A%053"
                    }
                }
                const escTeld = teldPattern.replace(/'/g, "''");
                
                // 滴滴表查询：直接使用原始输入（可能包含星号，星号是实际字符）
                const escDidi = plateNumber.replace(/'/g, "''");
                
                // 特来电表查询：使用转换后的模式匹配所有符合该格式的车牌号
                // 例如：输入"湘A***053"或"湘A053"会匹配"湘A123053"、"湘A456053"等所有符合"湘A***053"模式的车牌号
                const teldTimeField = timeField;
                sqlTeld = `SELECT TOP 10000 * FROM [特来电] WHERE REPLACE([判定车牌号], ' ', '') COLLATE Chinese_PRC_CI_AS LIKE N'%${escTeld}%' AND [${teldTimeField}] BETWEEN '${start}' AND '${end}' ORDER BY [${teldTimeField}] DESC`;
                
                // 滴滴表查询：根据时间字段选择对应的滴滴表字段
                // 滴滴表中车牌号格式为"湘A***053"（星号是实际字符），直接匹配
                const didiTimeField = (timeField === '充电开始时间') ? '开始充电时间' : '充电完成时间';
                sqlDidi = `SELECT TOP 10000 [订单ID], [用户类型], [场站名称], [充电桩ID], [充电枪ID], [开始充电时间], [充电完成时间], [充电时长（分钟）], CAST([充电量（度）] AS DECIMAL(18,2)) AS [充电量（度）], [订单总额（元）], [充电电费（元）], [充电服务费（元）], [车牌号] FROM [滴滴] WHERE REPLACE([车牌号], ' ', '') COLLATE Chinese_PRC_CI_AS LIKE N'%${escDidi}%' AND [${didiTimeField}] BETWEEN '${start}' AND '${end}' ORDER BY [${didiTimeField}] DESC`;
                
                // 保留原有的sql字段用于兼容
                sql = sqlTeld;
            }

            return { ok: true, sql, sqlTeld, sqlDidi, tableName, deviceType, userInput: userInput.trim(), timeField, start, end };
        }

        // 更新当前查询条件显示
        function updateUserCurrentConditions() {
            const conditionsText = document.getElementById('user-current-conditions-text');
            if (!conditionsText) return;

            const userInput = (document.getElementById('user-input') || {}).value || '';
            const timeField = (document.getElementById('user-time-field-select') || {}).value || '充电结束时间';
            const startTime = (document.getElementById('user-start-datetime') || {}).value || '';
            const endTime = (document.getElementById('user-end-datetime') || {}).value || '';

            if (!userInput) {
                conditionsText.textContent = '请输入车牌号或手机号后点击查询';
                return;
            }

            const inputType = isPhoneNumber(userInput) ? '手机号' : '车牌号';
            let text = `${inputType}: ${userInput}`;

            if (startTime && endTime) {
                text += ` | ${timeField}: ${startTime} ~ ${endTime}`;
            }

            conditionsText.textContent = text;
        }

        // 执行用户数据查询
        async function runUserDataQuery() {
            const build = buildUserQuery();
            const resultContent = document.getElementById('user-query-result-content');
            const statsContainer = document.getElementById('user-stats-container');

            if (!build.ok) {
                alert(build.error);
                return;
            }

            // 更新当前条件显示
            updateUserCurrentConditions();

            // 禁用导出按钮
            setUserExportEnabled(false);

            // 重置用户数据分页状态
            __userPagination.enabled = false;
            __userPagination.rows = [];
            __userPagination.total = 0;
            __userPagination.currentPage = 1;
            renderUserPagination();

            // 显示加载提示
            if (resultContent) {
                resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> 正在查询，请稍候...</div>';
            }
            if (statsContainer) {
                statsContainer.innerHTML = '';
            }

            try {
                let allResults = [];
                
                if (build.deviceType === '车牌号') {
                    // 车牌号查询：同时查询特来电表和滴滴表
                    const [teldResult, didiResult] = await Promise.all([
                        callSqlWithRetry(build.sqlTeld, 3, 600),
                        callSqlWithRetry(build.sqlDidi, 3, 600)
                    ]);

                    // 处理特来电结果
                    // 腾讯云函数返回格式: { result: { results: [...] } } 或直接 { results: [...] }
                    let teldResults = [];
                    if (teldResult) {
                        if (teldResult.result && teldResult.result.results) {
                            teldResults = teldResult.result.results;
                        } else if (teldResult.results) {
                            teldResults = teldResult.results;
                        } else if (Array.isArray(teldResult)) {
                            teldResults = teldResult;
                        }
                    }
                    if (teldResults.length > 0) {
                        allResults = allResults.concat(teldResults);
                        console.log('[特来电查询] 找到', teldResults.length, '条记录');
                    }

                    // 处理滴滴结果：将滴滴表字段映射为特来电表字段格式
                    let didiResults = [];
                    if (didiResult) {
                        if (didiResult.result && didiResult.result.results) {
                            didiResults = didiResult.result.results;
                        } else if (didiResult.results) {
                            didiResults = didiResult.results;
                        } else if (Array.isArray(didiResult)) {
                            didiResults = didiResult;
                        }
                    }
                    if (didiResults.length > 0) {
                        console.log('[滴滴查询] 找到', didiResults.length, '条记录');
                        const mappedDidiResults = didiResults.map(row => {
                            return {
                                '电站名称': row['场站名称'] || '',
                                '终端名称': row['充电枪ID'] || '',
                                '充电开始时间': row['开始充电时间'] || '',
                                '充电结束时间': row['充电完成时间'] || '',
                                '充电电量(度)': row['充电量（度）'] || '',
                                '充电电费(元)': row['充电电费（元）'] || '',
                                '充电服务费(元)': row['充电服务费（元）'] || '',
                                '充电费用(元)': row['订单总额（元）'] || '',
                                '充电时长(分钟)': row['充电时长（分钟）'] || '',
                                '判定车牌号': row['车牌号'] || '',
                                // 保留原始字段用于统计
                                '__source': '滴滴',
                                '__订单ID': row['订单ID'] || '',
                                '__充电量（度）': row['充电量（度）'] || '',
                                '__充电电费（元）': row['充电电费（元）'] || '',
                                '__充电服务费（元）': row['充电服务费（元）'] || '',
                                '__订单总额（元）': row['订单总额（元）'] || ''
                            };
                        });
                        allResults = allResults.concat(mappedDidiResults);
                    }

                    // 按时间字段排序（降序）
                    const timeField = build.timeField;
                    allResults.sort((a, b) => {
                        const timeA = a[timeField] || '';
                        const timeB = b[timeField] || '';
                        return timeB.localeCompare(timeA);
                    });

                    // 构建合并后的结果对象
                    const result = {
                        success: true,
                        results: allResults
                    };

                    // 保存查询结果供导出使用
                    __lastUserQueryResults = {
                        success: true,
                        results: allResults,
                        tableName: build.tableName,
                        deviceType: build.deviceType,
                        userInput: build.userInput
                    };

                    // 显示查询结果
                    displayUserQueryResult(result, build);

                    // 启用导出按钮(如果有数据)
                    if (allResults.length > 0) {
                        setUserExportEnabled(true);
                    }
                } else {
                    // 手机号查询：保持原有逻辑
                    const result = await callSqlWithRetry(build.sql, 3, 600);

                    if (!result || !result.success) {
                        throw new Error(result && result.error ? result.error : '查询失败');
                    }

                    // 保存查询结果供导出使用
                    __lastUserQueryResults = {
                        success: true,
                        results: result.results || [],
                        tableName: build.tableName,
                        deviceType: build.deviceType,
                        userInput: build.userInput
                    };

                    // 显示查询结果
                    displayUserQueryResult(result, build);

                    // 启用导出按钮(如果有数据)
                    if (result.results && result.results.length > 0) {
                        setUserExportEnabled(true);
                    }
                }

            } catch (err) {
                if (resultContent) {
                    resultContent.innerHTML = '<div style="color:#c00; padding:12px;">查询失败：' + (err.message || '未知错误') + '</div>';
                }
                setUserExportEnabled(false);
            }
        }

        // 显示用户数据查询结果
        function displayUserQueryResult(payload, build) {
            const resultContent = document.getElementById('user-query-result-content');
            const statsContainer = document.getElementById('user-stats-container');
            if (!resultContent) return;

            const rows = (payload && payload.results) ? payload.results : [];

            // 调试日志：查看实际返回的数据结构
            console.log('[用户查询] 总记录数:', rows.length);
            if (rows.length > 0) {
                console.log('[用户查询] 第一条记录的字段:', Object.keys(rows[0]));
                console.log('[用户查询] 第一条记录的数据:', rows[0]);
            }

            if (rows.length === 0) {
                __userPagination.enabled = false;
                __userPagination.rows = [];
                __userPagination.total = 0;
                renderUserPagination();
                resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">未找到符合条件的数据</div>';
                if (statsContainer) statsContainer.innerHTML = '';
                return;
            }

            // 计算统计数据
            let totalElectricity = 0;
            let totalElectricityFee = 0;
            let totalServiceFee = 0;
            let totalChargingFee = 0;
            let totalOrders = rows.length;

            if (build.deviceType === '车牌号') {
                // 车牌号查询：包含特来电数据和滴滴数据
                rows.forEach(row => {
                    const clean = (v) => {
                        if (v === null || v === undefined) return 0;
                        let s = String(v).trim();
                        if (/^\(.*\)$/.test(s)) { s = s.slice(1, -1); }
                        s = s.replace(/[¥￥,，\s]/g, '');
                        s = s.replace(/(度|kWh|KWh|kW·h|kW·H|元)/gi, '');
                        s = s.replace(/．/g, '.');
                        const num = parseFloat(s);
                        return isNaN(num) ? 0 : num;
                    };

                    // 判断数据来源：滴滴表数据有__source标记
                    if (row.__source === '滴滴') {
                        // 滴滴表数据：使用保留的原始字段
                        // 订单数：使用订单ID计数（已在totalOrders中统计）
                        // 总充电量：充电量（度）字段求和（已转换为数值类型）
                        totalElectricity += clean(row['__充电量（度）'] || row['充电电量(度)']);
                        // 总电费：充电电费（元）字段求和
                        totalElectricityFee += clean(row['__充电电费（元）'] || row['充电电费(元)']);
                        // 总服务费：充电服务费（元）字段求和
                        totalServiceFee += clean(row['__充电服务费（元）'] || row['充电服务费(元)']);
                        // 总费用：订单总额（元）字段求和
                        totalChargingFee += clean(row['__订单总额（元）'] || row['充电费用(元)']);
                    } else {
                        // 特来电表数据：使用原有字段
                        totalElectricity += clean(row['充电电量(度)'] || row['充电电量']);
                        totalElectricityFee += clean(row['充电电费(元)'] || row['充电电费']);
                        totalServiceFee += clean(row['充电服务费(元)'] || row['充电服务费']);
                        totalChargingFee += clean(row['充电费用(元)'] || row['充电费用']);
                    }
                });
            } else {
                // 能科数据
                rows.forEach(row => {
                    const clean = (v) => {
                        if (v === null || v === undefined) return 0;
                        let s = String(v).trim();
                        if (/^\(.*\)$/.test(s)) { s = s.slice(1, -1); }
                        s = s.replace(/[¥￥,，\s]/g, '');
                        s = s.replace(/(度|kWh|KWh|kW·h|kW·H|元)/gi, '');
                        s = s.replace(/．/g, '.');
                        const num = parseFloat(s);
                        return isNaN(num) ? 0 : num;
                    };

                    totalElectricity += clean(row['充电量']);
                    totalElectricityFee += clean(row['电费']);
                    totalServiceFee += clean(row['服务费']);
                    totalChargingFee += clean(row['消费金额']);
                });
            }

            // 显示统计信息
            let statsHtml = `
                <div style="display:flex; gap:15px; flex-wrap:wrap; padding:12px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:6px;">
                    <div style="flex:1; min-width:120px;">
                        <div style="font-size:12px; color:#666;">订单数</div>
                        <div style="font-size:20px; font-weight:bold; color:#007bff;">${totalOrders}</div>
                    </div>
                    <div style="flex:1; min-width:120px;">
                        <div style="font-size:12px; color:#666;">总充电量</div>
                        <div style="font-size:20px; font-weight:bold; color:#28a745;">${totalElectricity.toFixed(2)} 度</div>
                    </div>
                    <div style="flex:1; min-width:120px;">
                        <div style="font-size:12px; color:#666;">总电费</div>
                        <div style="font-size:20px; font-weight:bold; color:#ffc107;">￥${totalElectricityFee.toFixed(2)}</div>
                    </div>
                    <div style="flex:1; min-width:120px;">
                        <div style="font-size:12px; color:#666;">总服务费</div>
                        <div style="font-size:20px; font-weight:bold; color:#17a2b8;">￥${totalServiceFee.toFixed(2)}</div>
                    </div>
                    <div style="flex:1; min-width:120px;">
                        <div style="font-size:12px; color:#666;">总费用</div>
                        <div style="font-size:20px; font-weight:bold; color:#dc3545;">￥${totalChargingFee.toFixed(2)}</div>
                    </div>
                </div>
            `;

            if (statsContainer) {
                statsContainer.innerHTML = statsHtml;
            }

            const userColumns = build.deviceType === '车牌号'
                ? ['电站名称', '终端名称', '充电开始时间', '充电结束时间', '充电电量(度)', '充电电费(元)', '充电服务费(元)', '充电费用(元)', '充电时长(分钟)', '判定车牌号']
                : ['充电桩名称', '开始日期时间', '结束日期时间', '充电量', '电费', '服务费', '消费金额', '充电时长', '卡号', '持卡人'];

            __userPagination.enabled = true;
            const displayRows = build.deviceType === '手机号'
                ? rows.map(formatUserPhoneRow)
                : rows;
            __userPagination.rows = displayRows;
            __userPagination.total = rows.length;
            __userPagination.pageSize = 20;
            __userPagination.currentPage = 1;
            __userPagination.deviceType = build.deviceType;
            __userPagination.columns = userColumns;

            renderUserTablePage();
            renderUserPagination();
        }

        // 导出用户数据到Excel
        function exportUserDataToExcel() {
            const exportBtn = document.getElementById('user-export-btn');
            if (exportBtn && exportBtn.disabled) {
                alert('没有可导出的数据');
                return;
            }

            if (!__lastUserQueryResults || !__lastUserQueryResults.results || __lastUserQueryResults.results.length === 0) {
                alert('没有可导出的数据');
                return;
            }

            try {
                const rows = __lastUserQueryResults.results;
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                const sheetName = __lastUserQueryResults.deviceType === '车牌号' ? '特来电数据' : '能科数据';
                XLSX.utils.book_append_sheet(wb, ws, sheetName);

                const fileName = `用户数据_${__lastUserQueryResults.userInput}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
            } catch (e) {
                alert('导出失败：' + (e.message || '未知错误'));
            }
        }

        // 初始化用户数据导出按钮为禁用状态
        setTimeout(() => {
            setUserExportEnabled(false);
        }, 0);

        // ==================== 充电数据报表功能 ====================

        // 全局变量
        let currentPickerTarget = null;
        let currentPickerYear = new Date().getFullYear();
        
        // 报表数据保存变量
        let chargingReportData = null;
        let compReportData = null;

        // 初始化日期为当前年月
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const currentYearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const reportStartInput = document.getElementById('report-start-date');
            const reportEndInput = document.getElementById('report-end-date');
            if (reportStartInput) reportStartInput.value = currentYearMonth;
            if (reportEndInput) reportEndInput.value = currentYearMonth;
            const effStartInput = document.getElementById('eff-start-date');
            const effEndInput = document.getElementById('eff-end-date');
            if (effStartInput) effStartInput.value = currentYearMonth;
            if (effEndInput) effEndInput.value = currentYearMonth;
        });

        // 站点选择相关功能
        document.addEventListener('click', function(e) {
            const stationSelector = document.getElementById('station-selector');
            const stationDropdown = document.getElementById('station-dropdown');

            if (stationSelector && stationSelector.contains(e.target)) {
                stationDropdown.style.display = stationDropdown.style.display === 'none' ? 'block' : 'none';
            } else if (!stationDropdown.contains(e.target)) {
                stationDropdown.style.display = 'none';
            }
        });

        function toggleStationAll() {
            // 只在page-report-charging页面中查找元素
            const pageReportCharging = document.getElementById('page-report-charging');
            if (!pageReportCharging || pageReportCharging.style.display === 'none') {
                return; // 如果页面未显示，不执行更新
            }
            
            const allCheckbox = pageReportCharging.querySelector('#station-all');
            const options = pageReportCharging.querySelectorAll('.station-option');
            
            if (allCheckbox) {
                options.forEach(option => {
                    option.checked = allCheckbox.checked;
                });
                updateStationSelection();
            }
        }

        function updateStationSelection() {
            // 只在page-report-charging页面中查找元素
            const pageReportCharging = document.getElementById('page-report-charging');
            if (!pageReportCharging || pageReportCharging.style.display === 'none') {
                return; // 如果页面未显示，不执行更新
            }
            
            const options = pageReportCharging.querySelectorAll('.station-option');
            const allCheckbox = pageReportCharging.querySelector('#station-all');
            const display = pageReportCharging.querySelector('#station-display');

            if (!display) return;

            const selected = Array.from(options).filter(opt => opt.checked);

            if (selected.length === 0) {
                display.textContent = '请选择站点';
                if (allCheckbox) allCheckbox.checked = false;
            } else if (selected.length === options.length) {
                display.textContent = '全选';
                if (allCheckbox) allCheckbox.checked = true;
            } else {
                display.textContent = selected.map(opt => opt.value).join(', ');
                if (allCheckbox) allCheckbox.checked = false;
            }
        }

        // 月份选择器相关功能
        function showMonthPicker(targetId, inputElement) {
            // 关闭其他选择器
            const reportStartPicker = document.getElementById('report-start-date-picker');
            const reportEndPicker = document.getElementById('report-end-date-picker');
            const defaultStartPicker = document.getElementById('start-date-picker');
            const defaultEndPicker = document.getElementById('end-date-picker');
            const effStartPicker = document.getElementById('eff-start-date-picker');
            const effEndPicker = document.getElementById('eff-end-date-picker');
            if (reportStartPicker) reportStartPicker.style.display = 'none';
            if (reportEndPicker) reportEndPicker.style.display = 'none';
            if (defaultStartPicker) defaultStartPicker.style.display = 'none';
            if (defaultEndPicker) defaultEndPicker.style.display = 'none';
            if (effStartPicker) effStartPicker.style.display = 'none';
            if (effEndPicker) effEndPicker.style.display = 'none';
            document.getElementById('month-picker-modal').style.display = 'none';
            
            currentPickerTarget = targetId;
            const targetInput = inputElement || document.getElementById(targetId);
            const currentValue = targetInput.value;

            if (currentValue && currentValue.match(/^\d{4}-\d{2}$/)) {
                currentPickerYear = parseInt(currentValue.split('-')[0]);
            } else {
                currentPickerYear = new Date().getFullYear();
            }

            // 确定使用哪个选择器容器（支持报表和充电效率页面）
            let pickerId = '';
            if (targetId === 'report-start-date') pickerId = 'report-start-date-picker';
            else if (targetId === 'report-end-date') pickerId = 'report-end-date-picker';
            else if (targetId === 'eff-start-date') pickerId = 'eff-start-date-picker';
            else if (targetId === 'eff-end-date') pickerId = 'eff-end-date-picker';
            else pickerId = 'report-start-date-picker';

            const pickerContainer = document.getElementById(pickerId);
            if (!pickerContainer) return;
            
            // 设置选择器宽度与输入框一致
            const inputWidth = targetInput.offsetWidth;
            pickerContainer.style.width = inputWidth + 'px';
            
            // 生成选择器内容
            let pickerHTML = `
                <div style="padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <button onclick="changeYear(-1, event)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="picker-year-${targetId}" style="font-size:16px; font-weight:bold;">${currentPickerYear}年</span>
                        <button onclick="changeYear(1, event)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:12px;">
                        <button onclick="selectMonthForPicker(1, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">1月</button>
                        <button onclick="selectMonthForPicker(2, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">2月</button>
                        <button onclick="selectMonthForPicker(3, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">3月</button>
                        <button onclick="selectMonthForPicker(4, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">4月</button>
                        <button onclick="selectMonthForPicker(5, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">5月</button>
                        <button onclick="selectMonthForPicker(6, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">6月</button>
                        <button onclick="selectMonthForPicker(7, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">7月</button>
                        <button onclick="selectMonthForPicker(8, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">8月</button>
                        <button onclick="selectMonthForPicker(9, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">9月</button>
                        <button onclick="selectMonthForPicker(10, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">10月</button>
                        <button onclick="selectMonthForPicker(11, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">11月</button>
                        <button onclick="selectMonthForPicker(12, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">12月</button>
                    </div>
                    <button onclick="closeMonthPickerForInput('${targetId}')" style="width:100%; padding:6px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:13px;">取消</button>
                </div>
            `;
            
            pickerContainer.innerHTML = pickerHTML;
            pickerContainer.style.display = 'block';
            
            // 点击外部区域关闭选择器
            setTimeout(() => {
                const startDateBtn = document.getElementById('report-start-date-btn');
                const endDateBtn = document.getElementById('report-end-date-btn');
                const effStartBtn = document.getElementById('eff-start-date-btn');
                const effEndBtn = document.getElementById('eff-end-date-btn');
                const closeOnClickOutside = (e) => {
                    const isStartDateBtn = e.target === startDateBtn || (startDateBtn && startDateBtn.contains(e.target));
                    const isEndDateBtn = e.target === endDateBtn || (endDateBtn && endDateBtn.contains(e.target));
                    const isEffStartBtn = e.target === effStartBtn || (effStartBtn && effStartBtn.contains(e.target));
                    const isEffEndBtn = e.target === effEndBtn || (effEndBtn && effEndBtn.contains(e.target));
                    if (!pickerContainer.contains(e.target) && e.target !== targetInput && !isStartDateBtn && !isEndDateBtn && !isEffStartBtn && !isEffEndBtn) {
                        pickerContainer.style.display = 'none';
                        document.removeEventListener('click', closeOnClickOutside);
                    }
                };
                document.addEventListener('click', closeOnClickOutside);
            }, 100);
        }
        
        function changeYear(delta, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            currentPickerYear += delta;
            const yearSpan = document.getElementById('picker-year-' + currentPickerTarget);
            if (yearSpan) {
                yearSpan.textContent = currentPickerYear + '年';
            }
            // 同时更新旧的picker-year（兼容性）
            const oldYearSpan = document.getElementById('picker-year');
            if (oldYearSpan) {
                oldYearSpan.textContent = currentPickerYear + '年';
            }
        }
        
        function selectMonthForPicker(month, targetId) {
            const yearMonth = `${currentPickerYear}-${String(month).padStart(2, '0')}`;
            document.getElementById(targetId).value = yearMonth;
            closeMonthPickerForInput(targetId);
        }
        
        function closeMonthPickerForInput(targetId) {
            let pickerId = '';
            if (targetId === 'report-start-date') pickerId = 'report-start-date-picker';
            else if (targetId === 'report-end-date') pickerId = 'report-end-date-picker';
            else if (targetId === 'eff-start-date') pickerId = 'eff-start-date-picker';
            else if (targetId === 'eff-end-date') pickerId = 'eff-end-date-picker';
            else pickerId = 'report-start-date-picker';
            const picker = document.getElementById(pickerId);
            if (picker) {
                picker.style.display = 'none';
            }
            currentPickerTarget = null;
        }

        // 旧的selectMonth函数（保留用于兼容）
        function selectMonth(month) {
            if (currentPickerTarget) {
                const yearMonth = `${currentPickerYear}-${String(month).padStart(2, '0')}`;
                document.getElementById(currentPickerTarget).value = yearMonth;
            }
            closeMonthPicker();
        }

        function closeMonthPicker() {
            const modal = document.getElementById('month-picker-modal');
            if (modal) modal.style.display = 'none';

            ['start-date-picker', 'end-date-picker', 'report-start-date-picker', 'report-end-date-picker', 'eff-start-date-picker', 'eff-end-date-picker'].forEach(id => {
                const picker = document.getElementById(id);
                if (picker) picker.style.display = 'none';
            });
            currentPickerTarget = null;
        }

        // 查询充电数据报表
        async function queryChargingReport() {
            const options = document.querySelectorAll('.station-option');
            const selected = Array.from(options).filter(opt => opt.checked).map(opt => opt.value);
            const startDate = (document.getElementById('report-start-date') || {}).value || '';
            const endDate = (document.getElementById('report-end-date') || {}).value || '';

            if (selected.length === 0) {
                alert('请选择至少一个站点');
                return;
            }

            if (!startDate || !endDate) {
                alert('请选择开始日期和结束日期');
                return;
            }

            if (startDate > endDate) {
                alert('开始日期不能大于结束日期');
                return;
            }

            // 显示加载状态（使用ElementCache和CSS类）
            const reportResult = ElementCache.get('report-result');
            if (reportResult) {
                reportResult.style.display = 'block';
                reportResult.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><br><br>正在查询数据，请稍候...</div>';
            }

            // 禁用导出按钮（使用ElementCache）
            const exportBtn = ElementCache.get('charging-report-export-btn');
            if (exportBtn) {
                exportBtn.disabled = true;
                exportBtn.style.background = '#adb5bd';
                exportBtn.style.cursor = 'not-allowed';
            }

            try {
                // 查询所有站点的数据
                const result = {};

                for (const station of selected) {
                    const stationData = await queryStationData(station, startDate, endDate);
                    result[station] = stationData;
                }

                // 生成报表
                generateReport(result, selected, startDate, endDate);

            } catch (error) {
                reportResult.innerHTML = `<div style="text-align:center; padding:40px; color:#dc3545;"><i class="fas fa-exclamation-circle" style="font-size:32px;"></i><br><br>${error.message}</div>`;
                // 保持导出按钮禁用状态
                const exportBtn = document.getElementById('charging-report-export-btn');
                if (exportBtn) {
                    exportBtn.disabled = true;
                    exportBtn.style.background = '#adb5bd';
                    exportBtn.style.cursor = 'not-allowed';
                }
            }
        }

        // 计算平台服务费（带时间分界逻辑）
        async function calculatePlatformServiceFee(station, startDate, endDate, totalChargingServiceFee) {
            if (station !== '四方坪站') {
                return 0;
            }

            const cutoffDate = new Date('2026-01-01');
            const queryStartDate = new Date(startDate);
            const queryEndDate = new Date(endDate);

            // 情况1：查询时间完全在2026年1月之前
            if (queryEndDate < cutoffDate) {
                console.log('   查询时间段完全在2026年1月之前，使用旧逻辑：4%总服务费');
                return totalChargingServiceFee * 0.04;
            }

            // 情况2：查询时间完全在2026年1月及之后
            if (queryStartDate >= cutoffDate) {
                console.log('   查询时间段完全在2026年1月之后，使用新逻辑：查询滴滴账单表中的支出-合同技术服务费');
                // 格式化时间（转换为 yyyy-mm-dd hh:mm:ss 格式）
                const formattedStartTime = toSqlDateTime(startDate, false);
                const formattedEndTime = toSqlDateTime(endDate, true);
                
                // 查询滴滴账单表中的"支出-合同技术服务费"
                // 滴滴账单表中的"充电完成时间"字段格式为：yyyy/mm/dd hh:mm
                // 需要将格式转换为标准格式进行比较
                const didiBillQuery = `SELECT 
                    SUM(CAST(CASE WHEN ISNUMERIC(ISNULL([支出-合同技术服务费], '0')) = 1 THEN ISNULL([支出-合同技术服务费], '0') ELSE '0' END AS FLOAT)) AS total
                FROM [滴滴账单]
                WHERE [充电完成时间] IS NOT NULL
                AND LEN([充电完成时间]) > 0
                AND CASE WHEN ISDATE(REPLACE([充电完成时间], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([充电完成时间], '/', '-') + ':00', 120) ELSE NULL END IS NOT NULL
                AND CASE WHEN ISDATE(REPLACE([充电完成时间], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([充电完成时间], '/', '-') + ':00', 120) ELSE NULL END >= '${formattedStartTime}'
                AND CASE WHEN ISDATE(REPLACE([充电完成时间], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([充电完成时间], '/', '-') + ':00', 120) ELSE NULL END <= '${formattedEndTime}'`;

                const didiBillResults = await executeSQL(didiBillQuery, {
                    useCache: true,
                    cacheTTL: 5 * 60 * 1000,
                    params: { station, startDate, endDate, type: 'platformServiceFee', table: 'didiBill' }
                });
                const contractServiceFee = didiBillResults.length > 0 && didiBillResults[0].total ? parseFloat(didiBillResults[0].total) : 0;
                return contractServiceFee;
            }

            // 情况3：查询时间跨越2026年1月
            console.log('   查询时间段跨越2026年1月，需要分段计算');

            // 计算2026年1月之前的部分（使用旧逻辑）
            const beforeCutoffEnd = '2025-12-31';

            // 查询2026年1月之前的特来电和能科服务费
            const teldQueryBefore = `SELECT SUM(CAST([充电服务费(元)] AS FLOAT)) AS total
                          FROM [特来电]
                          WHERE [充电结束时间] >= '${startDate}'
                          AND [充电结束时间] < DATEADD(day, 1, '${beforeCutoffEnd}')
                          AND [电站名称] NOT LIKE N'%华为飞狐特来电高岭超充站%'
                          AND [电站名称] NOT LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%'`;

            const nkQueryBefore = `SELECT SUM(CAST([服务费] AS FLOAT)) AS total
                          FROM [能科]
                          WHERE [结束日期时间] >= '${startDate}'
                          AND [结束日期时间] < DATEADD(day, 1, '${beforeCutoffEnd}')`;

            const [teldResultsBefore, nkResultsBefore] = await Promise.all([
                executeSQL(teldQueryBefore, {
                    useCache: true,
                    cacheTTL: 5 * 60 * 1000,
                    params: { station, startDate, endDate: beforeCutoffEnd, type: 'platformServiceFeeBefore', table: 'teld' }
                }),
                executeSQL(nkQueryBefore, {
                    useCache: true,
                    cacheTTL: 5 * 60 * 1000,
                    params: { station, startDate, endDate: beforeCutoffEnd, type: 'platformServiceFeeBefore', table: 'nk' }
                })
            ]);

            const teldServiceFeeBefore = teldResultsBefore.length > 0 && teldResultsBefore[0].total ? parseFloat(teldResultsBefore[0].total) : 0;
            const nkServiceFeeBefore = nkResultsBefore.length > 0 && nkResultsBefore[0].total ? parseFloat(nkResultsBefore[0].total) : 0;
            const totalServiceFeeBefore = teldServiceFeeBefore + nkServiceFeeBefore;
            const platformFeeBefore = totalServiceFeeBefore * 0.04;

            console.log(`   2026年1月之前服务费: ${totalServiceFeeBefore}, 平台服务费(4%): ${platformFeeBefore}`);

            // 计算2026年1月之后的部分（使用新逻辑：查询滴滴账单表中的支出-合同技术服务费）
            const afterCutoffStart = '2026-01-01';
            // 格式化时间（转换为 yyyy-mm-dd hh:mm:ss 格式）
            const formattedAfterStartTime = toSqlDateTime(afterCutoffStart, false);
            const formattedEndTime = toSqlDateTime(endDate, true);

            // 查询滴滴账单表中的"支出-合同技术服务费"
            // 滴滴账单表中的"充电完成时间"字段格式为：yyyy/mm/dd hh:mm
            // 需要将格式转换为标准格式进行比较
            const didiBillQueryAfter = `SELECT 
                SUM(CAST(CASE WHEN ISNUMERIC(ISNULL([支出-合同技术服务费], '0')) = 1 THEN ISNULL([支出-合同技术服务费], '0') ELSE '0' END AS FLOAT)) AS total
            FROM [滴滴账单]
            WHERE [充电完成时间] IS NOT NULL
            AND LEN([充电完成时间]) > 0
            AND CASE WHEN ISDATE(REPLACE([充电完成时间], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([充电完成时间], '/', '-') + ':00', 120) ELSE NULL END IS NOT NULL
            AND CASE WHEN ISDATE(REPLACE([充电完成时间], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([充电完成时间], '/', '-') + ':00', 120) ELSE NULL END >= '${formattedAfterStartTime}'
            AND CASE WHEN ISDATE(REPLACE([充电完成时间], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([充电完成时间], '/', '-') + ':00', 120) ELSE NULL END <= '${formattedEndTime}'`;

            const didiBillResultsAfter = await executeSQL(didiBillQueryAfter, {
                useCache: true,
                cacheTTL: 5 * 60 * 1000,
                params: { station, startDate: afterCutoffStart, endDate, type: 'platformServiceFeeAfter', table: 'didiBill' }
            });

            const contractServiceFeeAfter = didiBillResultsAfter.length > 0 && didiBillResultsAfter[0].total ? parseFloat(didiBillResultsAfter[0].total) : 0;

            console.log(`   2026年1月之后支出-合同技术服务费: ${contractServiceFeeAfter}`);

            return platformFeeBefore + contractServiceFeeAfter;
        }

        // 查询滴滴账单表中的商家承担营销费用（用于2026年1月之后的活动优惠券）
        async function queryDidiBillMarketingCost(startDate, endDate) {
            // 格式化日期为 yyyy-mm-dd hh:mm:ss 格式（SQL Server标准格式）
            // startDate和endDate格式为 'YYYY-MM-DD'
            const startDateStr = startDate + ' 00:00:00';
            const endDateStr = endDate + ' 23:59:59';
            
            // 滴滴账单表中的"充电开始时间"字段格式为：yyyy/mm/dd hh:mm
            // 需要转换为标准DATETIME格式进行比较
            // 使用SQL Server 2008 R2兼容的语法
            const query = `SELECT 
                SUM(CAST(CASE 
                    WHEN ISNUMERIC(ISNULL([商家承担营销费用], '0')) = 1 
                    THEN ISNULL([商家承担营销费用], '0') 
                    ELSE '0' 
                END AS FLOAT)) AS total
            FROM [滴滴账单]
            WHERE [充电开始时间] IS NOT NULL
            AND LEN([充电开始时间]) > 0
            AND CASE 
                WHEN ISDATE(REPLACE([充电开始时间], '/', '-') + ':00') = 1 
                THEN CONVERT(DATETIME, REPLACE([充电开始时间], '/', '-') + ':00', 120) 
                ELSE NULL 
            END IS NOT NULL
            AND CASE 
                WHEN ISDATE(REPLACE([充电开始时间], '/', '-') + ':00') = 1 
                THEN CONVERT(DATETIME, REPLACE([充电开始时间], '/', '-') + ':00', 120) 
                ELSE NULL 
            END >= '${startDateStr}'
            AND CASE 
                WHEN ISDATE(REPLACE([充电开始时间], '/', '-') + ':00') = 1 
                THEN CONVERT(DATETIME, REPLACE([充电开始时间], '/', '-') + ':00', 120) 
                ELSE NULL 
            END <= '${endDateStr}'`;

            console.log(`  滴滴账单商家承担营销费用查询SQL生成完成，日期范围: ${startDateStr} 到 ${endDateStr}`);

            try {
                const result = await callSqlWithRetry(query, 3, 600);
                const rows = (result && result.results)
                    ? result.results
                    : Array.isArray(result)
                        ? result
                        : (result && result.data)
                            ? result.data
                            : (result && result.rows)
                                ? result.rows
                                : [];

                if (rows && rows.length > 0) {
                    const total = rows[0].total ? parseFloat(rows[0].total) : 0;
                    const finalTotal = Number.isFinite(total) ? Number(total.toFixed(2)) : 0;
                    console.log(`  滴滴账单商家承担营销费用查询成功，总金额: ${finalTotal}`);
                    return finalTotal;
                } else {
                    console.log('  滴滴账单商家承担营销费用查询返回空结果');
                    return 0;
                }
            } catch (e) {
                console.error('  滴滴账单商家承担营销费用查询失败:', e);
                return 0;
            }
        }

        // 查询活动优惠券成本（带日期检查）
        async function queryCouponCostWithDateCheck(station, startDate, endDate) {
            const cutoffDate = new Date('2026-01-01');
            const queryStartDate = new Date(startDate);
            const queryEndDate = new Date(endDate);

            // 如果是四方坪站，需要特殊处理2026年1月之后的逻辑
            if (station === '四方坪站') {
                // 情况1：查询时间完全在2026年1月及之后，从滴滴账单表查询
                if (queryStartDate >= cutoffDate) {
                    console.log('   四方坪站：查询时间段完全在2026年1月之后，从滴滴账单表查询商家承担营销费用');
                    return await queryDidiBillMarketingCost(startDate, endDate);
                }

                // 情况2：查询时间完全在2026年1月之前，正常计算（使用活动优惠券表）
                if (queryEndDate < cutoffDate) {
                    console.log('   四方坪站：查询时间段完全在2026年1月之前，正常计算活动优惠券');
                    return await queryCouponCost(station, startDate, endDate);
                }

                // 情况3：查询时间跨越2026年1月，需要分别计算两部分
                console.log('   四方坪站：查询时间段跨越2026年1月，分别计算两部分');
                const beforeCutoffEnd = '2025-12-31';
                const afterCutoffStart = '2026-01-01';
                
                // 计算2026年1月之前的部分（使用活动优惠券表）
                const beforeTotal = await queryCouponCost(station, startDate, beforeCutoffEnd);
                // 计算2026年1月及之后的部分（使用滴滴账单表）
                const afterTotal = await queryDidiBillMarketingCost(afterCutoffStart, endDate);
                
                return beforeTotal + afterTotal;
            } else {
                // 非四方坪站（高岭站），不区分时间，统一使用活动优惠券表查询
                console.log('   高岭站：统一使用活动优惠券表查询，不区分时间');
                return await queryCouponCost(station, startDate, endDate);
            }
        }

        // 计算交易手续费（带日期检查）
        // startDate和endDate格式为 YYYY-MM
        // 如果查询跨越2026年1月，需要查询2026年1月之前的充电收入来计算
        async function calculateTransactionFee(chargingTotalIncome, startDate, endDate, station) {
            const cutoffDate = '2026-01';
            const queryStartDate = startDate; // YYYY-MM格式
            const queryEndDate = endDate; // YYYY-MM格式

            // 如果是高岭站，不区分时间，统一按0.6%计算
            if (station === '高岭站') {
                console.log('   高岭站：统一按0.6%计算交易手续费，不区分时间');
                return parseFloat(chargingTotalIncome || 0) * 0.006;
            }

            // 四方坪站的逻辑保持不变
            // 情况1：查询时间完全在2026年1月及之后，不计算交易手续费
            if (queryStartDate >= cutoffDate) {
                console.log('   查询时间段完全在2026年1月及之后，不计算交易手续费');
                return 0;
            }

            // 情况2：查询时间完全在2026年1月之前，正常计算（0.6%）
            if (queryEndDate < cutoffDate) {
                console.log('   查询时间段完全在2026年1月之前，正常计算交易手续费（0.6%）');
                return parseFloat(chargingTotalIncome || 0) * 0.006;
            }

            // 情况3：查询时间跨越2026年1月，需要查询2026年1月之前的充电收入
            console.log('   查询时间段跨越2026年1月，查询2026年1月之前的充电收入来计算交易手续费');
            
            if (!station) {
                // 如果没有站点信息，采用保守策略：不计算交易手续费
                console.log('   缺少站点信息，不计算交易手续费');
                return 0;
            }

            // 查询2026年1月之前的充电收入
            const beforeCutoffEnd = '2025-12';
            const beforeCutoffEndFormatted = '2025-12-31';
            const startDateFormatted = startDate + '-01';
            
            try {
                const beforeElectricityFee = await queryChargingElectricityFee(station, startDateFormatted, beforeCutoffEndFormatted);
                const beforeServiceFee = await queryChargingServiceFee(station, startDateFormatted, beforeCutoffEndFormatted);
                const beforeChargingTotalIncome = beforeElectricityFee + beforeServiceFee;
                
                console.log(`   2026年1月之前充电收入: ${beforeChargingTotalIncome}, 交易手续费(0.6%): ${beforeChargingTotalIncome * 0.006}`);
                return beforeChargingTotalIncome * 0.006;
            } catch (error) {
                console.error('   查询2026年1月之前的充电收入失败:', error);
                // 查询失败时，采用保守策略：不计算交易手续费
                return 0;
            }
        }

        // 查询转售折扣（仅当站点为"四方坪站"且时间>=2026年时计算）
        async function queryResaleDiscount(station, startDate, endDate) {
            // 只有当站点选择"四方坪站"，时间选择大于或等于2026年时，才计算
            if (station !== '四方坪站') {
                return 0;
            }

            // 检查时间是否大于或等于2026年
            const [startYear] = startDate.split('-');
            if (parseInt(startYear) < 2026) {
                return 0;
            }

            console.log('   查询转售折扣...');
            
            // 格式化日期
            const startDateFormatted = startDate + '-01';
            const endDateParts = endDate.split('-');
            const lastDay = new Date(parseInt(endDateParts[0]), parseInt(endDateParts[1]), 0).getDate();
            const endDateFormatted = endDate + '-' + lastDay;
            
            // 格式化时间（转换为 yyyy-mm-dd hh:mm:ss 格式）
            const formattedStartTime = toSqlDateTime(startDateFormatted, false);
            const formattedEndTime = toSqlDateTime(endDateFormatted, true);

            try {
                // 查询滴滴账单表中的"转售折扣"字段
                // 滴滴账单表中的"充电完成时间"字段格式为：yyyy/mm/dd hh:mm
                // 需要将格式转换为标准格式进行比较
                // "转售折扣"字段是nvarchar类型，需要先转换为数值类型
                const didiBillQuery = `SELECT 
                    SUM(CAST(CASE WHEN ISNUMERIC(ISNULL([转售折扣], '0')) = 1 THEN ISNULL([转售折扣], '0') ELSE '0' END AS FLOAT)) AS total
                FROM [滴滴账单]
                WHERE [充电完成时间] IS NOT NULL
                AND LEN([充电完成时间]) > 0
                AND CASE WHEN ISDATE(REPLACE([充电完成时间], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([充电完成时间], '/', '-') + ':00', 120) ELSE NULL END IS NOT NULL
                AND CASE WHEN ISDATE(REPLACE([充电完成时间], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([充电完成时间], '/', '-') + ':00', 120) ELSE NULL END >= '${formattedStartTime}'
                AND CASE WHEN ISDATE(REPLACE([充电完成时间], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([充电完成时间], '/', '-') + ':00', 120) ELSE NULL END <= '${formattedEndTime}'`;

                const didiBillResults = await executeSQL(didiBillQuery, {
                    useCache: true,
                    cacheTTL: 5 * 60 * 1000,
                    params: { station, startDate: startDateFormatted, endDate: endDateFormatted, type: 'resaleDiscount', table: 'didiBill' }
                });
                const resaleDiscount = didiBillResults.length > 0 && didiBillResults[0].total ? parseFloat(didiBillResults[0].total) : 0;
                console.log(`   转售折扣: ${resaleDiscount}`);
                return resaleDiscount;
            } catch (error) {
                console.error('   查询转售折扣失败:', error);
                return 0;
            }
        }

        // 查询单个站点的数据
        async function queryStationData(station, startDate, endDate) {
            console.log(`\n========== 开始查询 ${station} 数据 ==========`);
            const stationData = {
                chargingElectricityFee: 0,
                chargingServiceFee: 0,
                chargingTotalIncome: 0,
                parkingFee: 0,
                monthlyCard: 0,
                occupancyFee: 0,
                otherIncome: 0,
                electricityCost: 0,
                platformServiceFee: 0,
                couponCost: 0,
                resaleDiscount: 0,
                otherCost: 0
            };

            // 格式化日期
            const startDateFormatted = startDate + '-01';
            const endDateParts = endDate.split('-');
            const lastDay = new Date(parseInt(endDateParts[0]), parseInt(endDateParts[1]), 0).getDate();
            const endDateFormatted = endDate + '-' + lastDay;
            console.log(`日期范围: ${startDateFormatted} 到 ${endDateFormatted}`);

            try {
                // 1. 查询充电电费收入
                console.log('1. 查询充电电费收入...');
                stationData.chargingElectricityFee = await queryChargingElectricityFee(station, startDateFormatted, endDateFormatted);
                console.log(`   结果: ${stationData.chargingElectricityFee}`);

                // 2. 查询充电服务费收入
                console.log('2. 查询充电服务费收入...');
                stationData.chargingServiceFee = await queryChargingServiceFee(station, startDateFormatted, endDateFormatted);
                console.log(`   结果: ${stationData.chargingServiceFee}`);

                // 3. 计算充电收入总和
                stationData.chargingTotalIncome = stationData.chargingElectricityFee + stationData.chargingServiceFee;
                console.log(`   充电收入总和: ${stationData.chargingTotalIncome}`);

                // 4. 查询其他收入
                console.log('3. 查询其他收入...');
                if (station === '四方坪站') {
                    // 四方坪无占位费，强制为 0
                    stationData.parkingFee = 0;
                    stationData.monthlyCard = 0;
                    stationData.occupancyFee = 0;
                    console.log('   四方坪站无占位费，跳过查询');
                } else if (station === '高岭站') {
                    stationData.parkingFee = 0;
                    stationData.monthlyCard = 0;

                    console.log('   查询占位费...');
                    stationData.occupancyFee = await queryOccupancyFee(startDateFormatted, endDateFormatted);
                    console.log(`   占位费: ${stationData.occupancyFee}`);
                }

                stationData.otherIncome = stationData.parkingFee + stationData.monthlyCard + stationData.occupancyFee;
                console.log(`   其他收入总和: ${stationData.otherIncome}`);

                // 5. 查询电费成本
                console.log('4. 查询电费成本...');
                const [startYear, startMonth] = startDate.split('-');
                const [endYear, endMonth] = endDate.split('-');
                stationData.electricityCost = await queryElectricityCost(station, startYear, startMonth, endYear, endMonth);
                console.log(`   结果: ${stationData.electricityCost}`);

                // 6. 计算平台服务费
                console.log('5. 计算平台服务费...');
                if (station === '四方坪站') {
                    // 需要区分2026年1月前后的计算逻辑
                    stationData.platformServiceFee = await calculatePlatformServiceFee(station, startDateFormatted, endDateFormatted, stationData.chargingServiceFee);
                } else {
                    stationData.platformServiceFee = 0;
                }
                console.log(`   结果: ${stationData.platformServiceFee}`);

                // 7. 查询活动优惠券成本
                console.log('6. 查询活动优惠券成本...');
                // 2026年1月之后（含2026年1月）不再计算活动优惠券
                stationData.couponCost = await queryCouponCostWithDateCheck(station, startDateFormatted, endDateFormatted);
                console.log(`   结果: ${stationData.couponCost}`);

                // 8. 查询转售折扣
                stationData.resaleDiscount = await queryResaleDiscount(station, startDate, endDate);
                console.log(`   结果: ${stationData.resaleDiscount}`);

                // 9. 其他成本
                console.log('8. 其他成本（暂无）');
                stationData.otherCost = 0;

                console.log(`========== ${station} 查询完成 ==========\n`);
                return stationData;

            } catch (error) {
                console.error(`查询 ${station} 数据时出错:`, error);
                throw error;
            }
        }

        // executeLeanCloudSQL 已由统一的 executeSQL 函数替代（见上方）

        // 查询充电电费收入
        async function queryChargingElectricityFee(station, startDate, endDate) {
            let stationCondition = '';
            if (station === '四方坪站') {
                stationCondition = "AND [电站名称] NOT LIKE N'%华为飞狐特来电高岭超充站%' AND [电站名称] NOT LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%'";
            } else {
                stationCondition = "AND ([电站名称] LIKE N'%华为飞狐特来电高岭超充站%' OR [电站名称] LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%')";
            }

            // 查询特来电表
            const teldQuery = `SELECT SUM(CAST([充电电费(元)] AS FLOAT)) AS total
                          FROM [特来电]
                          WHERE [充电结束时间] >= '${startDate}'
                          AND [充电结束时间] < DATEADD(day, 1, '${endDate}')
                          ${stationCondition}`;

            // 使用统一的executeSQL函数，启用缓存（5分钟）
            const teldResults = await executeSQL(teldQuery, {
                useCache: true,
                cacheTTL: 5 * 60 * 1000,
                params: { station, startDate, endDate, type: 'electricityFee', table: 'teld' }
            });
            const teldTotal = teldResults.length > 0 && teldResults[0].total ? parseFloat(teldResults[0].total) : 0;

            // 如果是四方坪站，还需要查询能科表
            let nkTotal = 0;
            if (station === '四方坪站') {
                const nkQuery = `SELECT SUM(CAST([电费] AS FLOAT)) AS total
                              FROM [能科]
                              WHERE [结束日期时间] >= '${startDate}'
                              AND [结束日期时间] < DATEADD(day, 1, '${endDate}')`;

                const nkResults = await executeSQL(nkQuery, {
                    useCache: true,
                    cacheTTL: 5 * 60 * 1000,
                    params: { station, startDate, endDate, type: 'electricityFee', table: 'nk' }
                });
                nkTotal = nkResults.length > 0 && nkResults[0].total ? parseFloat(nkResults[0].total) : 0;
            }

            // 如果是四方坪站，还需要查询滴滴表
            let didiTotal = 0;
            if (station === '四方坪站') {
                const didiQuery = `SELECT SUM(CASE WHEN ISNUMERIC([充电电费（元）]) = 1 AND [充电电费（元）] IS NOT NULL AND [充电电费（元）] != '' THEN CAST([充电电费（元）] AS DECIMAL(18,4)) ELSE 0 END) AS total
                              FROM [滴滴]
                              WHERE [充电完成时间] >= '${startDate}'
                              AND [充电完成时间] < DATEADD(day, 1, '${endDate}')`;

                const didiResults = await executeSQL(didiQuery, {
                    useCache: true,
                    cacheTTL: 5 * 60 * 1000,
                    params: { station, startDate, endDate, type: 'electricityFee', table: 'didi' }
                });
                didiTotal = didiResults.length > 0 && didiResults[0].total ? parseFloat(didiResults[0].total) : 0;
            }

            return teldTotal + nkTotal + didiTotal;
        }

        // 查询充电服务费收入
        async function queryChargingServiceFee(station, startDate, endDate) {
            let stationCondition = '';
            if (station === '四方坪站') {
                stationCondition = "AND [电站名称] NOT LIKE N'%华为飞狐特来电高岭超充站%' AND [电站名称] NOT LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%'";
            } else {
                stationCondition = "AND ([电站名称] LIKE N'%华为飞狐特来电高岭超充站%' OR [电站名称] LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%')";
            }

            // 查询特来电表
            const teldQuery = `SELECT SUM(CAST([充电服务费(元)] AS FLOAT)) AS total
                          FROM [特来电]
                          WHERE [充电结束时间] >= '${startDate}'
                          AND [充电结束时间] < DATEADD(day, 1, '${endDate}')
                          ${stationCondition}`;

            // 使用统一的executeSQL函数，启用缓存（5分钟）
            const teldResults = await executeSQL(teldQuery, {
                useCache: true,
                cacheTTL: 5 * 60 * 1000,
                params: { station, startDate, endDate, type: 'serviceFee', table: 'teld' }
            });
            const teldTotal = teldResults.length > 0 && teldResults[0].total ? parseFloat(teldResults[0].total) : 0;

            // 如果是四方坪站，还需要查询能科表
            let nkTotal = 0;
            if (station === '四方坪站') {
                const nkQuery = `SELECT SUM(CAST([服务费] AS FLOAT)) AS total
                              FROM [能科]
                              WHERE [结束日期时间] >= '${startDate}'
                              AND [结束日期时间] < DATEADD(day, 1, '${endDate}')`;

                const nkResults = await executeSQL(nkQuery, {
                    useCache: true,
                    cacheTTL: 5 * 60 * 1000,
                    params: { station, startDate, endDate, type: 'serviceFee', table: 'nk' }
                });
                nkTotal = nkResults.length > 0 && nkResults[0].total ? parseFloat(nkResults[0].total) : 0;
            }

            // 如果是四方坪站，还需要查询滴滴表
            let didiTotal = 0;
            if (station === '四方坪站') {
                const didiQuery = `SELECT SUM(CASE WHEN ISNUMERIC([充电服务费（元）]) = 1 AND [充电服务费（元）] IS NOT NULL AND [充电服务费（元）] != '' THEN CAST([充电服务费（元）] AS DECIMAL(18,4)) ELSE 0 END) AS total
                              FROM [滴滴]
                              WHERE [充电完成时间] >= '${startDate}'
                              AND [充电完成时间] < DATEADD(day, 1, '${endDate}')`;

                const didiResults = await executeSQL(didiQuery, {
                    useCache: true,
                    cacheTTL: 5 * 60 * 1000,
                    params: { station, startDate, endDate, type: 'serviceFee', table: 'didi' }
                });
                didiTotal = didiResults.length > 0 && didiResults[0].total ? parseFloat(didiResults[0].total) : 0;
            }

            return teldTotal + nkTotal + didiTotal;
        }

        // 查询停车收费系统收入
        async function queryParkingFee(startDate, endDate) {
            const query = `SELECT SUM(CAST([交易金额] AS FLOAT)) AS total
                          FROM [红门缴费]
                          WHERE [缴费时间] >= '${startDate}'
                          AND [缴费时间] < DATEADD(day, 1, '${endDate}')`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询月卡收入
        async function queryMonthlyCard(startDate, endDate) {
            const query = `SELECT SUM(CAST([交款金额] AS FLOAT)) AS total
                          FROM [月租车充值]
                          WHERE [交款时间] >= '${startDate}'
                          AND [交款时间] < DATEADD(day, 1, '${endDate}')`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询占位费收入
        async function queryOccupancyFee(startDate, endDate) {
            const query = `SELECT SUM(CAST([应收金额] AS FLOAT)) AS total
                          FROM [超时占位费]
                          WHERE [支付时间] >= '${startDate}'
                          AND [支付时间] < DATEADD(day, 1, '${endDate}')`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询电费成本
        async function queryElectricityCost(station, startYear, startMonth, endYear, endMonth) {
            let transformers = '';
            if (station === '四方坪站') {
                transformers = "'3118481453', '3111439077'";
            } else {
                transformers = "'4350001671599'";
            }

            const query = `SELECT SUM(
                              ISNULL(CAST([购电费] AS FLOAT), 0) +
                              ISNULL(CAST([输配电量电费] AS FLOAT), 0) +
                              ISNULL(CAST([力调电费] AS FLOAT), 0) +
                              ISNULL(CAST([基金及附加] AS FLOAT), 0) +
                              ISNULL(CAST([上网线损费用] AS FLOAT), 0) +
                              ISNULL(CAST([系统运行费用] AS FLOAT), 0) +
                              ISNULL(CAST([环境价值费用] AS FLOAT), 0)
                          ) AS total
                          FROM [电力局]
                          WHERE [变压器编号] IN (${transformers})
                          AND ((CAST([年] AS INT) > ${startYear} OR (CAST([年] AS INT) = ${startYear} AND CAST([月] AS INT) >= ${startMonth}))
                          AND (CAST([年] AS INT) < ${endYear} OR (CAST([年] AS INT) = ${endYear} AND CAST([月] AS INT) <= ${endMonth})))`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询活动优惠券成本
        async function queryCouponCost(station, startDate, endDate) {
            let stationCondition = '';
            if (station === '四方坪站') {
                stationCondition = "[电站名称] NOT IN ('华为飞狐特来电高岭超充站','长沙市开福区高岭香江国际城充电站建设项目')";
            } else if (station === '高岭站') {
                stationCondition = "([电站名称] = '华为飞狐特来电高岭超充站' OR [电站名称] = '长沙市开福区高岭香江国际城充电站建设项目')";
            } else {
                console.warn('  未识别的站点，跳过活动优惠券查询:', station);
                return 0;
            }

            const startParts = startDate.split('-');
            const endParts = endDate.split('-');
            if (startParts.length < 3 || endParts.length < 3) {
                console.warn('  活动优惠券查询日期格式无效:', startDate, endDate);
                return 0;
            }

            const startDateStr = `${startParts[0]}/${startParts[1]}/${startParts[2]} 00:00:00`;
            const endDateStr = `${endParts[0]}/${endParts[1]}/${endParts[2]} 23:59:59`;
            const dateCondition = `[收款时间] >= '${startDateStr}' AND [收款时间] <= '${endDateStr}'`;
            const settlementCondition = "[卡券是否结算] NOT IN ('是')";

            const combinedQuery = `
                SELECT
                    ROUND(SUM(CASE
                        WHEN [费用类型] = '电费' AND [支付方式] = '代金券' AND [卡券类型] = '赠券'
                        THEN [收款金额(元)]
                        ELSE 0
                    END), 2) AS condition1,
                    ROUND(SUM(CASE
                        WHEN [费用类型] = '服务费' AND [支付方式] = '代金券' AND [卡券类型] = '赠券'
                        THEN [收款金额(元)]
                        ELSE 0
                    END), 2) AS condition2,
                    ROUND(SUM(CASE
                        WHEN [费用类型] = '电费' AND [支付方式] = '代金券' AND [卡券类型] = '卖券'
                        THEN [卖券赠送金额(元)]
                        ELSE 0
                    END), 2) AS condition3,
                    ROUND(SUM(CASE
                        WHEN [费用类型] = '服务费' AND [支付方式] = '优惠券'
                        THEN [收款金额(元)]
                        ELSE 0
                    END), 2) AS condition4,
                    ROUND(SUM(CASE
                        WHEN [费用类型] = '服务费' AND [支付方式] = '代金券' AND [卡券类型] = '卖券'
                        THEN [卖券赠送金额(元)]
                        ELSE 0
                    END), 2) AS condition5,
                    ROUND(SUM(CASE
                        WHEN [费用类型] = '电费' AND [支付方式] = '优惠券'
                        THEN [收款金额(元)]
                        ELSE 0
                    END), 2) AS condition6
                FROM [活动优惠券]
                WHERE ${dateCondition}
                AND ${stationCondition}
                AND ${settlementCondition}
            `;

            let total = 0;
            console.log(`  活动优惠券查询SQL生成完成，日期范围: ${startDateStr} 到 ${endDateStr}`);

            try {
                const result = await callSqlWithRetry(combinedQuery, 3, 600);
                const rows = (result && result.results)
                    ? result.results
                    : Array.isArray(result)
                        ? result
                        : (result && result.data)
                            ? result.data
                            : (result && result.rows)
                                ? result.rows
                                : [];

                if (rows && rows.length > 0) {
                    const row = rows[0] || {};
                    const keys = ['condition1', 'condition2', 'condition3', 'condition4', 'condition5', 'condition6'];
                    total = keys.reduce((sum, key) => {
                        const value = parseFloat(row[key]);
                        return sum + (Number.isFinite(value) ? value : 0);
                    }, 0);
                    total = Number.isFinite(total) ? Number(total.toFixed(2)) : 0;
                    console.log(`  活动优惠券查询成功，各类合计: ${JSON.stringify(row)}, 总成本: ${total}`);
                } else {
                    console.log('  活动优惠券查询返回空结果');
                }
            } catch (e) {
                console.error('  活动优惠券查询失败:', e);
                total = 0;
            }

            return total;
        }

        // 生成报表
        async function generateReport(data, stations, startDate, endDate) {
            const reportResult = document.getElementById('report-result');
            let html = '';

            // 保存报表数据
            chargingReportData = {
                data: data,
                stations: stations,
                startDate: startDate,
                endDate: endDate
            };

            // 判断是单站还是双站查询
            if (stations.length === 1) {
                // 单站报表
                html = await generateSingleStationReport(data, stations[0], startDate, endDate);
            } else if (stations.length === 2) {
                // 双站对比报表
                html = await generateDualStationReport(data, stations, startDate, endDate);
            }

            reportResult.innerHTML = html;
            
            // 启用导出按钮
            const exportBtn = document.getElementById('charging-report-export-btn');
            if (exportBtn) {
                exportBtn.disabled = false;
                exportBtn.style.background = '#28a745';
                exportBtn.style.cursor = 'pointer';
                exportBtn.onmouseover = function() { this.style.background = '#218838'; };
                exportBtn.onmouseout = function() { this.style.background = '#28a745'; };
            }
        }

        // 生成单站报表
        async function generateSingleStationReport(data, station, startDate, endDate) {
            const stationData = data[station] || {};

            // 格式化日期显示
            let periodDisplay = startDate;
            if (startDate !== endDate) {
                periodDisplay = `${startDate}至${endDate}`;
            }

            let html = `
                <div style="background:#fff; padding:30px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <h2 style="text-align:center; margin-bottom:20px; color:#333; font-size:24px;">充电数据报表</h2>
                    <div style="width:100%; color:#666; font-size:14px; display:flex; box-sizing:border-box;">
                        <div style="width:30%; padding:12px; text-align:left; box-sizing:border-box;">单位：长沙飞狐电动汽车充电服务有限公司</div>
                        <div style="width:25%; padding:12px; text-align:left; box-sizing:border-box;">站点：${station}</div>
                        <div style="width:25%; padding:12px; text-align:left; box-sizing:border-box;">报表周期：${periodDisplay}</div>
                        <div style="flex:1; padding:12px; text-align:right; box-sizing:border-box;">金额：元</div>
                    </div>

                    <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
                        <thead>
                            <tr style="background:#f8f9fa;">
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600; width:60%;">项目</th>
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600; width:25%;">金额</th>
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600; width:15%;">备注</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" style="padding:10px 12px; border:1px solid #dee2e6; background:#f1f3f5; font-weight:600;">一、营业收入</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">1、充电收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.chargingTotalIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 50px; border:1px solid #dee2e6;">1.1 充电电费收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.chargingElectricityFee)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 50px; border:1px solid #dee2e6;">1.2 充电服务费收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.chargingServiceFee)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">2、其他收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.otherIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>`;

            // 其他收入明细
            if (station === '四方坪站') {
                html += `
                            <tr>
                                <td style="padding:8px 12px 8px 50px; border:1px solid #dee2e6;">2.1 占位费</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.occupancyFee)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 50px; border:1px solid #dee2e6;">2.2 其他</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">0.00</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>`;
            } else if (station === '高岭站') {
                html += `
                            <tr>
                                <td style="padding:8px 12px 8px 50px; border:1px solid #dee2e6;">2.1 占位费</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.occupancyFee)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 50px; border:1px solid #dee2e6;">2.2 其他</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">0.00</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>`;
            }

            const totalRevenue = parseFloat(stationData.chargingTotalIncome || 0) + parseFloat(stationData.otherIncome || 0);
            // 计算交易手续费（带日期检查）：2026年1月之前按0.6%计算，2026年1月及之后不计算
            const transactionFee = await calculateTransactionFee(stationData.chargingTotalIncome, startDate, endDate, station);
            const totalCost = parseFloat(stationData.electricityCost || 0) + parseFloat(stationData.platformServiceFee || 0) +
                            parseFloat(stationData.couponCost || 0) + transactionFee + parseFloat(stationData.resaleDiscount || 0) + parseFloat(stationData.otherCost || 0);
            const grossProfit = totalRevenue - totalCost;
            const grossMargin = totalRevenue > 0 ? ((grossProfit / totalRevenue) * 100).toFixed(2) : '0.00';

            html += `
                            <tr style="background:#f8f9fa; font-weight:600;">
                                <td style="padding:10px 12px; border:1px solid #dee2e6;">营业收入合计</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(totalRevenue)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="padding:10px 12px; border:1px solid #dee2e6; background:#f1f3f5; font-weight:600;">二、营业成本</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">1、电费成本</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.electricityCost)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">2、平台服务费</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.platformServiceFee)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">3、活动优惠券</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.couponCost)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">4、交易手续费</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(transactionFee)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">5、转售折扣</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.resaleDiscount)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">6、其他成本</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.otherCost)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr style="background:#f8f9fa; font-weight:600;">
                                <td style="padding:10px 12px; border:1px solid #dee2e6;">营业成本合计</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(totalCost)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="padding:10px 12px; border:1px solid #dee2e6; background:#f1f3f5; font-weight:600;">三、毛利润</td>
                            </tr>
                            <tr style="background:#e7f5ff;">
                                <td style="padding:10px 12px 10px 30px; border:1px solid #dee2e6; font-weight:600;">毛利润</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; font-weight:600; color:${grossProfit >= 0 ? '#28a745' : '#dc3545'};">${formatMoney(grossProfit)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr style="background:#e7f5ff;">
                                <td style="padding:10px 12px 10px 30px; border:1px solid #dee2e6; font-weight:600;">毛利率</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; font-weight:600; color:${grossProfit >= 0 ? '#28a745' : '#dc3545'};">${grossMargin}%</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }

        // 导出充电数据报表
        function exportChargingReport() {
            if (!chargingReportData) {
                alert('没有可导出的数据，请先查询报表');
                return;
            }

            const { data, stations, startDate, endDate } = chargingReportData;
            const reportResult = document.getElementById('report-result');
            const table = reportResult.querySelector('table');
            
            if (!table) {
                alert('没有找到报表数据');
                return;
            }

            // 从表格中提取数据
            const headers = [];
            const rows = [];

            // 获取表头
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                headerRow.querySelectorAll('th').forEach(th => {
                    headers.push(th.textContent.trim());
                });
            }

            // 获取数据行
            const dataRows = table.querySelectorAll('tbody tr');
            dataRows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    let cellText = cell.textContent.trim();
                    // 移除颜色样式标记（如果有）
                    cellText = cellText.replace(/\s+/g, ' ');
                    rowData.push(cellText);
                });
                if (rowData.length > 0) {
                    rows.push(rowData);
                }
            });

            // 创建Excel数据
            const excelData = [headers];
            rows.forEach(row => excelData.push(row));

            // 生成文件名
            let periodDisplay = startDate;
            if (startDate !== endDate) {
                periodDisplay = `${startDate}至${endDate}`;
            }
            const stationName = stations.length === 1 ? stations[0] : stations.join('和');
            const fileName = `充电数据报表_${stationName}_${periodDisplay}.xlsx`;

            // 创建工作簿和工作表
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // 设置列宽
            const colWidths = headers.map(() => ({ wch: 20 }));
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, '充电数据报表');
            XLSX.writeFile(wb, fileName);
        }

        // ========== 充电效率分析 ==========
        let efficiencyReportData = null;

        function toggleEffStationDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('eff-station-dropdown');
            if (!dropdown) return;
            dropdown.style.display = (dropdown.style.display === 'none' || dropdown.style.display === '') ? 'block' : 'none';
        }

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('eff-station-dropdown');
            const selector = document.getElementById('eff-station-selector');
            if (!dropdown || !selector) return;
            if (dropdown.style.display === 'none' || dropdown.style.display === '') return;
            if (!selector.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        function toggleEffStationAll() {
            const all = document.getElementById('eff-station-all');
            const items = document.querySelectorAll('.eff-station-option');
            items.forEach(i => { i.checked = all.checked; });
            updateEffStationSelection();
        }

        function updateEffStationSelection() {
            const all = document.getElementById('eff-station-all');
            const items = Array.from(document.querySelectorAll('.eff-station-option'));
            const checked = items.filter(i => i.checked).map(i => i.value);
            const display = document.getElementById('eff-station-display');

            if (checked.length === items.length) {
                if (all) all.checked = true;
                if (display) display.textContent = '全选';
            } else {
                if (all) all.checked = false;
                if (display) display.textContent = checked.length > 0 ? checked.join('、') : '未选择';
            }
        }

        function getEffSelectedStations() {
            const all = document.getElementById('eff-station-all');
            const items = Array.from(document.querySelectorAll('.eff-station-option'));
            if (all && all.checked) return ['四方坪站', '高岭站'];
            return items.filter(i => i.checked).map(i => i.value);
        }

        async function queryEfficiencyReport() {
            const resultDiv = document.getElementById('efficiency-report-result');
            const exportBtn = document.getElementById('efficiency-report-export-btn');
            const selected = getEffSelectedStations();
            const startDate = (document.getElementById('eff-start-date') || {}).value || '';
            const endDate = (document.getElementById('eff-end-date') || {}).value || '';

            if (exportBtn) {
                exportBtn.disabled = true;
                exportBtn.style.background = '#adb5bd';
                exportBtn.style.cursor = 'not-allowed';
            }

            if (resultDiv) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<div style="text-align:center; padding:40px;"><i class="fas fa-spinner fa-spin" style="font-size:32px; color:#007bff;"></i><br><br>正在查询数据，请稍候...</div>';
            }

            if (selected.length === 0) {
                if (resultDiv) resultDiv.innerHTML = '<div style="color:#c00; padding:12px;">请至少选择一个站点</div>';
                return;
            }
            if (!startDate || !endDate) {
                if (resultDiv) resultDiv.innerHTML = '<div style="color:#c00; padding:12px;">请选择开始日期和结束日期</div>';
                return;
            }
            if (startDate > endDate) {
                if (resultDiv) resultDiv.innerHTML = '<div style="color:#c00; padding:12px;">开始日期不能大于结束日期</div>';
                return;
            }

            try {
                const result = {};
                for (const st of selected) {
                    result[st] = await queryEfficiencyMetrics(st, startDate, endDate);
                }
                efficiencyReportData = { data: result, stations: selected, startDate, endDate };
                generateEfficiencyReport(result, selected, startDate, endDate);

                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.style.background = '#28a745';
                    exportBtn.style.cursor = 'pointer';
                    exportBtn.onmouseover = function() { this.style.background = '#218838'; };
                    exportBtn.onmouseout = function() { this.style.background = '#28a745'; };
                }
            } catch (err) {
                console.error('充电效率分析失败', err);
                if (resultDiv) resultDiv.innerHTML = `<div style="color:#c00; padding:12px;">查询失败：${err.message || '未知错误'}</div>`;
            }
        }

        function calcDayCount(startDateStr, endDateStr) {
            const start = new Date(startDateStr);
            const end = new Date(endDateStr);
            const diff = end.getTime() - start.getTime();
            return diff >= 0 ? Math.floor(diff / (24 * 3600 * 1000)) + 1 : 0;
        }

        function buildStationCondition(station) {
            if (station === '四方坪站') {
                return "AND [电站名称] NOT LIKE N'%华为飞狐特来电高岭超充站%' AND [电站名称] NOT LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%'";
            }
            if (station === '高岭站') {
                return "AND ([电站名称] LIKE N'%华为飞狐特来电高岭超充站%' OR [电站名称] LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%')";
            }
            return '';
        }

        async function queryEfficiencyMetrics(station, startDate, endDate) {
            const startDateFormatted = `${startDate}-01`;
            const endParts = endDate.split('-');
            const lastDay = new Date(parseInt(endParts[0]), parseInt(endParts[1]), 0).getDate();
            const endDateFormatted = `${endDate}-${lastDay}`;

            const cutoffDate = new Date('2026-01-01');
            const queryStartDate = new Date(startDateFormatted);
            const queryEndDate = new Date(endDateFormatted);

            // 场景判断
            let queryScenario = '';
            if (queryEndDate < cutoffDate) {
                queryScenario = 'before'; // 完全在2026年1月之前
            } else if (queryStartDate >= cutoffDate) {
                queryScenario = 'after'; // 完全在2026年1月及之后
            } else {
                queryScenario = 'across'; // 跨越2026年1月
            }

            console.log(`[充电效率分析] ${station} 查询时间段: ${startDateFormatted} 至 ${endDateFormatted}, 场景: ${queryScenario}`);

            let terminals = 0;
            let totalDuration = 0;
            let totalKwh = 0;
            let totalServiceFee = 0;
            let totalSessions = 0;
            let minDate = null;
            let maxDate = null;

            // 四方坪站终端数量固定值判断（2024年5月为分界点）
            const sifangTerminalCutoffDate = new Date('2024-05-01');
            const isSifangping = station === '四方坪站';

            // 四方坪站终端数量计算函数
            function getSifangTerminals(dataMinDate, dataMaxDate, queryStart, queryEnd) {
                // 优先根据实际数据日期范围判断
                if (dataMaxDate && new Date(dataMaxDate) < sifangTerminalCutoffDate) {
                    return 172; // 数据全部在2024年5月以前
                }
                if (dataMinDate && new Date(dataMinDate) >= sifangTerminalCutoffDate) {
                    return 142; // 数据全部在2024年5月及以后
                }
                // 如果没有数据日期或跨越2024年5月，根据查询范围判断
                if (queryEnd < sifangTerminalCutoffDate) {
                    return 172; // 查询结束日期在2024年5月以前
                }
                if (queryStart >= sifangTerminalCutoffDate) {
                    return 142; // 查询开始日期在2024年5月及以后
                }
                // 跨越2024年5月，使用142（取较新的值）
                return 142;
            }

            if (queryScenario === 'before') {
                // 场景1：完全在2026年1月之前，使用特来电表
                const result = await queryEfficiencyFromTeld(station, startDateFormatted, endDateFormatted);
                // 四方坪站：根据实际数据日期范围或查询范围判断终端数量
                if (isSifangping) {
                    terminals = getSifangTerminals(result.minDate, result.maxDate, queryStartDate, queryEndDate);
                } else {
                    terminals = result.terminals;
                }
                totalDuration = result.totalDuration;
                totalKwh = result.totalKwh;
                totalServiceFee = result.totalServiceFee;
                totalSessions = result.totalSessions;
                minDate = result.minDate;
                maxDate = result.maxDate;
            } else if (queryScenario === 'after') {
                // 场景2：完全在2026年1月及之后，使用滴滴表
                const result = await queryEfficiencyFromDidi(station, startDateFormatted, endDateFormatted);
                // 四方坪站：2026年1月及之后的数据都在2024年5月之后，固定为142
                if (isSifangping) {
                    terminals = 142;
                } else {
                    terminals = result.terminals;
                }
                totalDuration = result.totalDuration;
                totalKwh = result.totalKwh;
                totalServiceFee = result.totalServiceFee;
                totalSessions = result.totalSessions;
                minDate = result.minDate;
                maxDate = result.maxDate;
            } else {
                // 场景3：跨越2026年1月，需要合并两个表的数据
                const beforeCutoffEnd = '2025-12-31';
                const afterCutoffStart = '2026-01-01';

                const [teldResult, didiResult] = await Promise.all([
                    queryEfficiencyFromTeld(station, startDateFormatted, beforeCutoffEnd),
                    queryEfficiencyFromDidi(station, afterCutoffStart, endDateFormatted)
                ]);

                // 四方坪站：根据实际数据日期范围判断终端数量
                if (isSifangping) {
                    // 判断特来电表数据的时间范围
                    const teldStartDate = new Date(startDateFormatted);
                    const teldEndDate = new Date(beforeCutoffEnd);
                    const teldTerminals = getSifangTerminals(teldResult.minDate, teldResult.maxDate, teldStartDate, teldEndDate);
                    // 滴滴表数据都在2024年5月之后，固定为142
                    const didiTerminals = 142;
                    // 合并终端数（取最大值）
                    terminals = Math.max(teldTerminals, didiTerminals);
                } else {
                    // 合并终端数（取并集，使用集合去重）
                    terminals = Math.max(teldResult.terminals, didiResult.terminals);
                }

                // 合并其他指标（求和）
                totalDuration = teldResult.totalDuration + didiResult.totalDuration;
                totalKwh = teldResult.totalKwh + didiResult.totalKwh;
                totalServiceFee = teldResult.totalServiceFee + didiResult.totalServiceFee;
                totalSessions = teldResult.totalSessions + didiResult.totalSessions;

                // 合并日期范围
                const dates = [teldResult.minDate, teldResult.maxDate, didiResult.minDate, didiResult.maxDate].filter(d => d);
                if (dates.length > 0) {
                    dates.sort();
                    minDate = dates[0];
                    maxDate = dates[dates.length - 1];
                }
            }

            // 计算天数
            let dayCount = 0;
            if (minDate && maxDate) {
                dayCount = calcDayCount(minDate, maxDate);
            } else {
                dayCount = calcDayCount(startDateFormatted, endDateFormatted);
            }
            if (dayCount <= 0) throw new Error('日期范围无效或无数据');

            // 查询抄表电量
            const [startYear, startMonth] = startDate.split('-');
            const [endYear, endMonth] = endDate.split('-');
            const meterKwh = await queryMeterKwhForEfficiency(station, startYear, startMonth, endYear, endMonth);

            // 计算效率指标
            const safeTerminals = terminals > 0 ? terminals : 1;
            const terminalDailyMinutes = (totalDuration / dayCount) / safeTerminals;
            const terminalUtilization = terminalDailyMinutes / 1440 * 100;
            const terminalDailyKwh = (totalKwh / dayCount) / safeTerminals;
            const terminalDailyRevenue = (totalServiceFee / dayCount) / safeTerminals;
            const dailyDurationHours = (totalDuration / dayCount) / 60;
            const dailyKwh = totalKwh / dayCount;
            const avgPower = dailyDurationHours > 0 ? dailyKwh / dailyDurationHours : 0;
            const sessionsPerGun = (totalSessions / dayCount) / safeTerminals;
            const lossKwh = meterKwh - totalKwh;
            const lossRate = meterKwh > 0 ? (lossKwh / meterKwh) * 100 : 0;

            return {
                terminalDailyMinutes,
                terminalUtilization,
                terminalDailyKwh,
                terminalDailyRevenue,
                avgPower,
                sessionsPerGun,
                meterKwh,
                chargeKwh: totalKwh,
                lossKwh,
                lossRate
            };
        }

        // 从特来电表查询效率数据
        async function queryEfficiencyFromTeld(station, startDateFormatted, endDateFormatted) {
            const stationCondition = buildStationCondition(station);

            const terminalSql = `
                SELECT COUNT(DISTINCT [电站名称] + N'&' + [终端名称]) AS terminals
                FROM [特来电]
                WHERE [充电结束时间] >= '${startDateFormatted}'
                AND [充电结束时间] < DATEADD(day, 1, '${endDateFormatted}')
                ${stationCondition}
            `;
            const terminalsRes = await executeLeanCloudSQL(terminalSql);
            const terminals = terminalsRes && terminalsRes[0] && terminalsRes[0].terminals ? parseInt(terminalsRes[0].terminals) : 0;

            const sumSql = `
                SELECT
                    SUM(CAST([充电时长(分钟)] AS FLOAT)) AS totalDuration,
                    SUM(CAST([充电电量(度)] AS FLOAT)) AS totalKwh,
                    SUM(CAST([充电服务费(元)] AS FLOAT)) AS totalServiceFee,
                    COUNT(1) AS totalSessions
                FROM [特来电]
                WHERE [充电结束时间] >= '${startDateFormatted}'
                AND [充电结束时间] < DATEADD(day, 1, '${endDateFormatted}')
                ${stationCondition}
            `;
            const sumRes = await executeLeanCloudSQL(sumSql);
            const totalDuration = sumRes && sumRes[0] && sumRes[0].totalDuration ? parseFloat(sumRes[0].totalDuration) : 0;
            const totalKwh = sumRes && sumRes[0] && sumRes[0].totalKwh ? parseFloat(sumRes[0].totalKwh) : 0;
            const totalServiceFee = sumRes && sumRes[0] && sumRes[0].totalServiceFee ? parseFloat(sumRes[0].totalServiceFee) : 0;
            const totalSessions = sumRes && sumRes[0] && sumRes[0].totalSessions ? parseInt(sumRes[0].totalSessions) : 0;

            const dateRangeSql = `
                SELECT
                    MIN(CAST([充电结束时间] AS DATE)) AS minDate,
                    MAX(CAST([充电结束时间] AS DATE)) AS maxDate
                FROM [特来电]
                WHERE [充电结束时间] >= '${startDateFormatted}'
                AND [充电结束时间] < DATEADD(day, 1, '${endDateFormatted}')
                ${stationCondition}
            `;
            const dateRangeRes = await executeLeanCloudSQL(dateRangeSql);
            const minDate = dateRangeRes && dateRangeRes[0] && dateRangeRes[0].minDate ? dateRangeRes[0].minDate : null;
            const maxDate = dateRangeRes && dateRangeRes[0] && dateRangeRes[0].maxDate ? dateRangeRes[0].maxDate : null;

            return { terminals, totalDuration, totalKwh, totalServiceFee, totalSessions, minDate, maxDate };
        }

        // 从滴滴表查询效率数据
        async function queryEfficiencyFromDidi(station, startDateFormatted, endDateFormatted) {
            // 滴滴表只有四方坪站的数据
            if (station !== '四方坪站') {
                return { terminals: 0, totalDuration: 0, totalKwh: 0, totalServiceFee: 0, totalSessions: 0, minDate: null, maxDate: null };
            }

            // 滴滴表使用"场站名称"字段，不需要stationCondition，直接查询所有四方坪相关站点
            const terminalSql = `
                SELECT COUNT(DISTINCT [场站名称] + N'&' + [充电枪ID]) AS terminals
                FROM [滴滴]
                WHERE [充电完成时间] >= '${startDateFormatted}'
                AND [充电完成时间] < DATEADD(day, 1, '${endDateFormatted}')
            `;
            const terminalsRes = await executeLeanCloudSQL(terminalSql);
            const terminals = terminalsRes && terminalsRes[0] && terminalsRes[0].terminals ? parseInt(terminalsRes[0].terminals) : 0;

            const sumSql = `
                SELECT
                    SUM(CASE WHEN ISNUMERIC([充电时长（分钟）]) = 1 AND [充电时长（分钟）] IS NOT NULL AND [充电时长（分钟）] != '' THEN CAST([充电时长（分钟）] AS DECIMAL(18,4)) ELSE 0 END) AS totalDuration,
                    SUM(CASE WHEN ISNUMERIC([充电量（度）]) = 1 AND [充电量（度）] IS NOT NULL AND [充电量（度）] != '' THEN CAST([充电量（度）] AS DECIMAL(18,4)) ELSE 0 END) AS totalKwh,
                    SUM(CASE WHEN ISNUMERIC([充电服务费（元）]) = 1 AND [充电服务费（元）] IS NOT NULL AND [充电服务费（元）] != '' THEN CAST([充电服务费（元）] AS DECIMAL(18,4)) ELSE 0 END) AS totalServiceFee,
                    COUNT(1) AS totalSessions
                FROM [滴滴]
                WHERE [充电完成时间] >= '${startDateFormatted}'
                AND [充电完成时间] < DATEADD(day, 1, '${endDateFormatted}')
            `;
            const sumRes = await executeLeanCloudSQL(sumSql);
            const totalDuration = sumRes && sumRes[0] && sumRes[0].totalDuration ? parseFloat(sumRes[0].totalDuration) : 0;
            const totalKwh = sumRes && sumRes[0] && sumRes[0].totalKwh ? parseFloat(sumRes[0].totalKwh) : 0;
            const totalServiceFee = sumRes && sumRes[0] && sumRes[0].totalServiceFee ? parseFloat(sumRes[0].totalServiceFee) : 0;
            const totalSessions = sumRes && sumRes[0] && sumRes[0].totalSessions ? parseInt(sumRes[0].totalSessions) : 0;

            const dateRangeSql = `
                SELECT
                    MIN(CAST([充电完成时间] AS DATE)) AS minDate,
                    MAX(CAST([充电完成时间] AS DATE)) AS maxDate
                FROM [滴滴]
                WHERE [充电完成时间] >= '${startDateFormatted}'
                AND [充电完成时间] < DATEADD(day, 1, '${endDateFormatted}')
            `;
            const dateRangeRes = await executeLeanCloudSQL(dateRangeSql);
            const minDate = dateRangeRes && dateRangeRes[0] && dateRangeRes[0].minDate ? dateRangeRes[0].minDate : null;
            const maxDate = dateRangeRes && dateRangeRes[0] && dateRangeRes[0].maxDate ? dateRangeRes[0].maxDate : null;

            return { terminals, totalDuration, totalKwh, totalServiceFee, totalSessions, minDate, maxDate };
        }

        async function queryMeterKwhForEfficiency(station, startYear, startMonth, endYear, endMonth) {
            let transformers = '';
            if (station === '四方坪站') {
                transformers = "'3118481453', '3111439077'";
            } else {
                transformers = "'4350001671599'";
            }
            const query = `
                SELECT SUM(CAST([电量] AS FLOAT)) AS total
                FROM [电力局]
                WHERE [变压器编号] IN (${transformers})
                AND ((CAST([年] AS INT) > ${startYear} OR (CAST([年] AS INT) = ${startYear} AND CAST([月] AS INT) >= ${startMonth}))
                AND (CAST([年] AS INT) < ${endYear} OR (CAST([年] AS INT) = ${endYear} AND CAST([月] AS INT) <= ${endMonth})))
            `;
            const res = await executeLeanCloudSQL(query);
            return res && res[0] && res[0].total ? parseFloat(res[0].total) : 0;
        }

        function formatNumber(val, decimals = 2) {
            const num = typeof val === 'number' ? val : parseFloat(val || 0);
            return isNaN(num) ? '0.00' : num.toFixed(decimals);
        }

        function generateEfficiencyReport(data, stations, startDate, endDate) {
            const resultDiv = document.getElementById('efficiency-report-result');
            if (!resultDiv) return;

            const columns = [];
            if (stations.length === 2) {
                columns.push('四方坪站', '高岭站');
            } else {
                columns.push(stations[0]);
            }

            const rowsDef = [
                { key: 'terminalDailyMinutes', label: '终端日均充电时长(分钟)', isPercent: false },
                { key: 'terminalUtilization', label: '终端日均利用率', isPercent: true },
                { key: 'terminalDailyKwh', label: '终端日均充电电量(kwh)', isPercent: false },
                { key: 'terminalDailyRevenue', label: '终端日均充电收益(元)', isPercent: false },
                { key: 'avgPower', label: '平均每小时充电功率(kw)', isPercent: false },
                { key: 'sessionsPerGun', label: '单枪日均充电次数', isPercent: false },
                { key: 'meterKwh', label: '本期抄表电量(度)', isPercent: false },
                { key: 'chargeKwh', label: '本期充电电量(度)', isPercent: false },
                { key: 'lossKwh', label: '本期电量损耗(度)', isPercent: false },
                { key: 'lossRate', label: '本期电损率', isPercent: true }
            ];

            let html = `<div style="background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                <h2 style="text-align:center; margin-bottom:20px; color:#333; font-size:22px;">充电效率分析</h2>
                <div style="width:100%; color:#666; font-size:14px; display:flex; box-sizing:border-box; margin-bottom:12px; align-items:center;">
                    <div style="flex:1; padding:8px; text-align:left; box-sizing:border-box;">单位：长沙飞狐电动汽车充电服务有限公司</div>
                    <div style="padding:8px; text-align:right; box-sizing:border-box; min-width:200px;">报表周期：${startDate === endDate ? startDate : `${startDate}至${endDate}`}</div>
                </div>
                <table style="width:100%; border-collapse:collapse; font-size:14px;">
                    <thead>
                        <tr style="background:#f8f9fa;">
                            <th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600; width:30%;">指标</th>`;
            columns.forEach(col => {
                html += `<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">${col}</th>`;
            });
            html += `</tr>
                    </thead>
                    <tbody>`;

            rowsDef.forEach(row => {
                html += `<tr>`;
                html += `<td style="padding:10px; border:1px solid #dee2e6;">${row.label}</td>`;
                columns.forEach(col => {
                    const metrics = data[col] || {};
                    let val = metrics[row.key] || 0;
                    if (row.isPercent) {
                        val = `${formatNumber(val, 2)}%`;
                    } else {
                        val = formatNumber(val, 2);
                    }
                    html += `<td style="padding:10px; border:1px solid #dee2e6; text-align:right;">${val}</td>`;
                });
                html += `</tr>`;
            });

            html += `</tbody></table></div>`;

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = html;
        }

        function exportEfficiencyReport() {
            if (!efficiencyReportData) {
                alert('没有可导出的数据，请先查询报表');
                return;
            }
            const resultDiv = document.getElementById('efficiency-report-result');
            const table = resultDiv ? resultDiv.querySelector('table') : null;
            if (!table) {
                alert('没有找到报表数据');
                return;
            }

            const headers = [];
            const rows = [];
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                headerRow.querySelectorAll('th').forEach(th => headers.push(th.textContent.trim()));
            }
            const dataRows = table.querySelectorAll('tbody tr');
            dataRows.forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => row.push(td.textContent.trim()));
                if (row.length) rows.push(row);
            });

            const { startDate, endDate } = efficiencyReportData;
            const fileName = `充电效率分析_${startDate === endDate ? startDate : startDate + '至' + endDate}.xlsx`;

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            ws['!cols'] = headers.map((h, idx) => {
                if (idx === 0) return { wch: 30 };
                return { wch: 18 };
            });
            XLSX.utils.book_append_sheet(wb, ws, '充电效率分析');
            XLSX.writeFile(wb, fileName);
        }

        // 生成双站对比报表
        async function generateDualStationReport(data, stations, startDate, endDate) {
            const sfpData = data['四方坪站'] || {};
            const glData = data['高岭站'] || {};

            // 格式化日期显示
            let periodDisplay = startDate;
            if (startDate !== endDate) {
                periodDisplay = `${startDate}至${endDate}`;
            }

            // 动态生成站点显示名称
            const stationDisplay = stations.join('和');

            // 计算各项数据
            const sfpRevenue = parseFloat(sfpData.chargingTotalIncome || 0) + parseFloat(sfpData.otherIncome || 0);
            const glRevenue = parseFloat(glData.chargingTotalIncome || 0) + parseFloat(glData.otherIncome || 0);
            const totalRevenue = sfpRevenue + glRevenue;

            const sfpElectricity = parseFloat(sfpData.electricityCost || 0);
            const glElectricity = parseFloat(glData.electricityCost || 0);
            const totalElectricity = sfpElectricity + glElectricity;

            // 计算交易手续费（带日期检查）：2026年1月之前按0.6%计算，2026年1月及之后不计算
            const sfpTransactionFee = await calculateTransactionFee(sfpData.chargingTotalIncome, startDate, endDate, '四方坪站');
            const glTransactionFee = await calculateTransactionFee(glData.chargingTotalIncome, startDate, endDate, '高岭站');
            const totalTransactionFee = sfpTransactionFee + glTransactionFee;

            const sfpOtherCost = parseFloat(sfpData.platformServiceFee || 0) + parseFloat(sfpData.couponCost || 0) + sfpTransactionFee + parseFloat(sfpData.otherCost || 0);
            const glOtherCost = parseFloat(glData.platformServiceFee || 0) + parseFloat(glData.couponCost || 0) + glTransactionFee + parseFloat(glData.otherCost || 0);
            const totalOtherCost = sfpOtherCost + glOtherCost;

            const sfpGrossProfit = sfpRevenue - sfpElectricity - sfpOtherCost;
            const glGrossProfit = glRevenue - glElectricity - glOtherCost;
            const totalGrossProfit = sfpGrossProfit + glGrossProfit;

            const sfpGrossMargin = sfpRevenue > 0 ? ((sfpGrossProfit / sfpRevenue) * 100).toFixed(2) : '0.00';
            const glGrossMargin = glRevenue > 0 ? ((glGrossProfit / glRevenue) * 100).toFixed(2) : '0.00';
            const totalGrossMargin = totalRevenue > 0 ? ((totalGrossProfit / totalRevenue) * 100).toFixed(2) : '0.00';

            let html = `
                <div style="background:#fff; padding:30px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <h2 style="text-align:center; margin-bottom:20px; color:#333; font-size:24px;">充电数据报表</h2>
                    <div style="width:100%; color:#666; font-size:14px; display:flex; box-sizing:border-box;">
                        <div style="width:40%; padding:12px; text-align:left; box-sizing:border-box;">单位：长沙飞狐电动汽车充电服务有限公司</div>
                        <div style="width:20%; padding:12px; text-align:right; box-sizing:border-box;">站点：${stationDisplay}</div>
                        <div style="width:20%; padding:12px; text-align:right; box-sizing:border-box;">报表周期：${periodDisplay}</div>
                        <div style="flex:1; padding:12px; text-align:right; box-sizing:border-box;">金额：元</div>
                    </div>

                    <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
                        <thead>
                            <tr style="background:#f8f9fa;">
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600; width:40%;">指标</th>
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600; width:20%;">四方坪站</th>
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600; width:20%;">高岭站</th>
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600; width:20%;">两站合计</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; font-weight:600;">营业收入</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(sfpRevenue)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(glRevenue)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; background:#f8f9fa; font-weight:600;">${formatMoney(totalRevenue)}</td>
                            </tr>
                            <tr>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; font-weight:600;">电费成本</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(sfpElectricity)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(glElectricity)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; background:#f8f9fa; font-weight:600;">${formatMoney(totalElectricity)}</td>
                            </tr>
                            <tr>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; font-weight:600;">其他成本</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(sfpOtherCost)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(glOtherCost)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; background:#f8f9fa; font-weight:600;">${formatMoney(totalOtherCost)}</td>
                            </tr>
                            <tr style="background:#e7f5ff;">
                                <td style="padding:10px 12px; border:1px solid #dee2e6; font-weight:600;">毛利润</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; color:${sfpGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${formatMoney(sfpGrossProfit)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; color:${glGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${formatMoney(glGrossProfit)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; background:#d0ebff; color:${totalGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${formatMoney(totalGrossProfit)}</td>
                            </tr>
                            <tr style="background:#e7f5ff;">
                                <td style="padding:10px 12px; border:1px solid #dee2e6; font-weight:600;">毛利率</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; color:${sfpGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${sfpGrossMargin}%</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; color:${glGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${glGrossMargin}%</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; background:#d0ebff; color:${totalGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${totalGrossMargin}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }

        // 格式化金额
        function formatMoney(value) {
            const num = parseFloat(value || 0);
            return num.toFixed(2);
        }

        // ==================== 综合数据报表功能 ====================

        // 全局变量
        let currentCompPickerTarget = null;
        let currentCompPickerYear = new Date().getFullYear();

        // 初始化综合报表日期为当前年月
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const currentYearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const compStartDate = document.getElementById('comp-start-date');
            const compEndDate = document.getElementById('comp-end-date');
            if (compStartDate) compStartDate.value = currentYearMonth;
            if (compEndDate) compEndDate.value = currentYearMonth;
        });

        // 综合报表站点选择相关功能
        document.addEventListener('click', function(e) {
            const compStationSelector = document.getElementById('comp-station-selector');
            const compStationDropdown = document.getElementById('comp-station-dropdown');

            if (compStationSelector && compStationSelector.contains(e.target)) {
                compStationDropdown.style.display = compStationDropdown.style.display === 'none' ? 'block' : 'none';
            } else if (compStationDropdown && !compStationDropdown.contains(e.target)) {
                compStationDropdown.style.display = 'none';
            }
        });

        function toggleCompStationAll() {
            const pageReportComp = document.getElementById('page-report-comprehensive');
            if (!pageReportComp || pageReportComp.style.display === 'none') {
                return;
            }

            const allCheckbox = pageReportComp.querySelector('#comp-station-all');
            const options = pageReportComp.querySelectorAll('.comp-station-option');

            if (allCheckbox) {
                options.forEach(option => {
                    option.checked = allCheckbox.checked;
                });
                updateCompStationSelection();
            }
        }

        function updateCompStationSelection() {
            const pageReportComp = document.getElementById('page-report-comprehensive');
            if (!pageReportComp || pageReportComp.style.display === 'none') {
                return;
            }

            const options = pageReportComp.querySelectorAll('.comp-station-option');
            const allCheckbox = pageReportComp.querySelector('#comp-station-all');
            const display = pageReportComp.querySelector('#comp-station-display');

            if (!display) return;

            const selected = Array.from(options).filter(opt => opt.checked);

            if (selected.length === 0) {
                display.textContent = '请选择站点';
                if (allCheckbox) allCheckbox.checked = false;
            } else if (selected.length === options.length) {
                display.textContent = '全选';
                if (allCheckbox) allCheckbox.checked = true;
            } else {
                display.textContent = selected.map(opt => opt.value).join(', ');
                if (allCheckbox) allCheckbox.checked = false;
            }
        }

        // 综合报表月份选择器相关功能
        function showCompMonthPicker(targetId, inputElement) {
            document.getElementById('comp-start-date-picker').style.display = 'none';
            document.getElementById('comp-end-date-picker').style.display = 'none';

            currentCompPickerTarget = targetId;
            const targetInput = inputElement || document.getElementById(targetId);
            const currentValue = targetInput.value;

            if (currentValue && currentValue.match(/^\d{4}-\d{2}$/)) {
                currentCompPickerYear = parseInt(currentValue.split('-')[0]);
            } else {
                currentCompPickerYear = new Date().getFullYear();
            }

            const pickerId = targetId === 'comp-start-date' ? 'comp-start-date-picker' : 'comp-end-date-picker';
            const pickerContainer = document.getElementById(pickerId);

            const inputWidth = targetInput.offsetWidth;
            pickerContainer.style.width = inputWidth + 'px';

            let pickerHTML = `
                <div style="padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <button onclick="changeCompYear(-1)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="comp-picker-year-${targetId}" style="font-size:16px; font-weight:bold;">${currentCompPickerYear}年</span>
                        <button onclick="changeCompYear(1)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:12px;">
                        <button onclick="selectCompMonth(1, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">1月</button>
                        <button onclick="selectCompMonth(2, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">2月</button>
                        <button onclick="selectCompMonth(3, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">3月</button>
                        <button onclick="selectCompMonth(4, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">4月</button>
                        <button onclick="selectCompMonth(5, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">5月</button>
                        <button onclick="selectCompMonth(6, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">6月</button>
                        <button onclick="selectCompMonth(7, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">7月</button>
                        <button onclick="selectCompMonth(8, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">8月</button>
                        <button onclick="selectCompMonth(9, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">9月</button>
                        <button onclick="selectCompMonth(10, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">10月</button>
                        <button onclick="selectCompMonth(11, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">11月</button>
                        <button onclick="selectCompMonth(12, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">12月</button>
                    </div>
                    <button onclick="closeCompMonthPicker('${targetId}')" style="width:100%; padding:6px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:13px;">取消</button>
                </div>
            `;

            pickerContainer.innerHTML = pickerHTML;
            pickerContainer.style.display = 'block';

            setTimeout(() => {
                const closeOnClickOutside = (e) => {
                    if (!pickerContainer.contains(e.target) && e.target !== targetInput) {
                        pickerContainer.style.display = 'none';
                        document.removeEventListener('click', closeOnClickOutside);
                    }
                };
                document.addEventListener('click', closeOnClickOutside);
            }, 100);
        }

        function changeCompYear(delta) {
            currentCompPickerYear += delta;
            const yearSpan = document.getElementById('comp-picker-year-' + currentCompPickerTarget);
            if (yearSpan) {
                yearSpan.textContent = currentCompPickerYear + '年';
            }
        }

        function selectCompMonth(month, targetId) {
            const yearMonth = `${currentCompPickerYear}-${String(month).padStart(2, '0')}`;
            document.getElementById(targetId).value = yearMonth;
            closeCompMonthPicker(targetId);
        }

        function closeCompMonthPicker(targetId) {
            const pickerId = targetId === 'comp-start-date' ? 'comp-start-date-picker' : 'comp-end-date-picker';
            document.getElementById(pickerId).style.display = 'none';
            currentCompPickerTarget = null;
        }

        // ==================== BI数据看板功能 ====================
        
        // BI数据看板站点选择器功能
        document.addEventListener('click', function(e) {
            const biStationSelector = document.getElementById('bi-station-selector');
            const biStationDropdown = document.getElementById('bi-station-dropdown');

            if (biStationSelector && biStationSelector.contains(e.target)) {
                biStationDropdown.style.display = biStationDropdown.style.display === 'none' ? 'block' : 'none';
            } else if (biStationDropdown && !biStationDropdown.contains(e.target)) {
                biStationDropdown.style.display = 'none';
            }
        });

        function toggleBIStationAll() {
            const pageReportBI = document.getElementById('page-report-bi');
            if (!pageReportBI || pageReportBI.style.display === 'none') {
                return;
            }

            const allCheckbox = pageReportBI.querySelector('#bi-station-all');
            const options = pageReportBI.querySelectorAll('.bi-station-option');

            if (allCheckbox) {
                options.forEach(option => {
                    option.checked = allCheckbox.checked;
                });
                updateBIStationSelection();
            }
        }

        function updateBIStationSelection() {
            const pageReportBI = document.getElementById('page-report-bi');
            if (!pageReportBI || pageReportBI.style.display === 'none') {
                return;
            }

            const options = pageReportBI.querySelectorAll('.bi-station-option');
            const allCheckbox = pageReportBI.querySelector('#bi-station-all');
            const display = pageReportBI.querySelector('#bi-station-display');

            if (!display) return;

            const selected = Array.from(options).filter(opt => opt.checked);

            if (selected.length === 0) {
                display.textContent = '请选择站点';
                if (allCheckbox) allCheckbox.checked = false;
            } else if (selected.length === options.length) {
                display.textContent = '全选';
                if (allCheckbox) allCheckbox.checked = true;
            } else {
                display.textContent = selected.map(opt => opt.value).join(', ');
                if (allCheckbox) allCheckbox.checked = false;
            }
        }

        // BI数据看板月份选择器相关变量
        let currentBIPickerTarget = null;
        let currentBIPickerYear = new Date().getFullYear();

        // 显示BI数据看板月份选择器
        function showBIMonthPicker(targetId, inputElement) {
            document.getElementById('bi-start-datetime-picker').style.display = 'none';
            document.getElementById('bi-end-datetime-picker').style.display = 'none';

            currentBIPickerTarget = targetId;
            const targetInput = inputElement || document.getElementById(targetId);
            const currentValue = targetInput.value;

            if (currentValue && currentValue.match(/^\d{4}-\d{2}$/)) {
                currentBIPickerYear = parseInt(currentValue.split('-')[0]);
            } else {
                currentBIPickerYear = new Date().getFullYear();
            }

            const pickerId = targetId === 'bi-start-datetime' ? 'bi-start-datetime-picker' : 'bi-end-datetime-picker';
            const pickerContainer = document.getElementById(pickerId);

            const inputWidth = targetInput.offsetWidth;
            pickerContainer.style.width = inputWidth + 'px';

            let pickerHTML = `
                <div style="padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <button onclick="changeBIYear(-1)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="bi-picker-year-${targetId}" style="font-size:16px; font-weight:bold;">${currentBIPickerYear}年</span>
                        <button onclick="changeBIYear(1)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:12px;">
                        <button onclick="selectBIMonth(1, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">1月</button>
                        <button onclick="selectBIMonth(2, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">2月</button>
                        <button onclick="selectBIMonth(3, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">3月</button>
                        <button onclick="selectBIMonth(4, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">4月</button>
                        <button onclick="selectBIMonth(5, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">5月</button>
                        <button onclick="selectBIMonth(6, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">6月</button>
                        <button onclick="selectBIMonth(7, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">7月</button>
                        <button onclick="selectBIMonth(8, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">8月</button>
                        <button onclick="selectBIMonth(9, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">9月</button>
                        <button onclick="selectBIMonth(10, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">10月</button>
                        <button onclick="selectBIMonth(11, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">11月</button>
                        <button onclick="selectBIMonth(12, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">12月</button>
                    </div>
                    <button onclick="closeBIMonthPicker('${targetId}')" style="width:100%; padding:6px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:13px;">取消</button>
                </div>
            `;

            pickerContainer.innerHTML = pickerHTML;
            pickerContainer.style.display = 'block';

            setTimeout(() => {
                const closeOnClickOutside = (e) => {
                    if (!pickerContainer.contains(e.target) && e.target !== targetInput) {
                        pickerContainer.style.display = 'none';
                        document.removeEventListener('click', closeOnClickOutside);
                    }
                };
                document.addEventListener('click', closeOnClickOutside);
            }, 100);
        }

        function changeBIYear(delta) {
            currentBIPickerYear += delta;
            const yearSpan = document.getElementById('bi-picker-year-' + currentBIPickerTarget);
            if (yearSpan) {
                yearSpan.textContent = currentBIPickerYear + '年';
            }
        }

        function selectBIMonth(month, targetId) {
            const yearMonth = `${currentBIPickerYear}-${String(month).padStart(2, '0')}`;
            document.getElementById(targetId).value = yearMonth;
            closeBIMonthPicker(targetId);
        }

        function closeBIMonthPicker(targetId) {
            const pickerId = targetId === 'bi-start-datetime' ? 'bi-start-datetime-picker' : 'bi-end-datetime-picker';
            document.getElementById(pickerId).style.display = 'none';
            currentBIPickerTarget = null;
        }

        // 充电数据报表月份选择器相关变量
        let currentZhPickerTarget = null;
        let currentZhPickerYear = new Date().getFullYear();

        // 显示充电数据报表月份选择器
        function showZhMonthPicker(targetId, inputElement) {
            document.getElementById('zh-start-datetime-picker').style.display = 'none';
            document.getElementById('zh-end-datetime-picker').style.display = 'none';

            currentZhPickerTarget = targetId;
            const targetInput = inputElement || document.getElementById(targetId);
            const currentValue = targetInput.value;

            // 从日期时间格式中提取年月，格式可能是 YYYY-MM-DD HH:mm:ss 或 YYYY-MM
            let year, month;
            if (currentValue && currentValue.match(/^\d{4}-\d{2}/)) {
                const parts = currentValue.split('-');
                year = parseInt(parts[0]);
                month = parseInt(parts[1]);
            } else if (currentValue && currentValue.match(/^\d{4}-\d{2}$/)) {
                const parts = currentValue.split('-');
                year = parseInt(parts[0]);
                month = parseInt(parts[1]);
            } else {
                const now = new Date();
                year = now.getFullYear();
                month = now.getMonth() + 1;
            }
            currentZhPickerYear = year;

            const pickerId = targetId === 'zh-start-datetime' ? 'zh-start-datetime-picker' : 'zh-end-datetime-picker';
            const pickerContainer = document.getElementById(pickerId);

            const inputWidth = targetInput.offsetWidth;
            pickerContainer.style.width = inputWidth + 'px';

            let pickerHTML = `
                <div style="padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <button onclick="changeZhYear(-1)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="zh-picker-year-${targetId}" style="font-size:16px; font-weight:bold;">${currentZhPickerYear}年</span>
                        <button onclick="changeZhYear(1)" style="padding:5px 10px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:14px;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:12px;">
                        <button onclick="selectZhMonth(1, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">1月</button>
                        <button onclick="selectZhMonth(2, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">2月</button>
                        <button onclick="selectZhMonth(3, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">3月</button>
                        <button onclick="selectZhMonth(4, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">4月</button>
                        <button onclick="selectZhMonth(5, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">5月</button>
                        <button onclick="selectZhMonth(6, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">6月</button>
                        <button onclick="selectZhMonth(7, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">7月</button>
                        <button onclick="selectZhMonth(8, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">8月</button>
                        <button onclick="selectZhMonth(9, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">9月</button>
                        <button onclick="selectZhMonth(10, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">10月</button>
                        <button onclick="selectZhMonth(11, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">11月</button>
                        <button onclick="selectZhMonth(12, '${targetId}')" style="padding:8px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-size:13px; transition:all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#fff'">12月</button>
                    </div>
                    <button onclick="closeZhMonthPicker('${targetId}')" style="width:100%; padding:6px; background:#6c757d; color:#fff; border:none; border-radius:4px; cursor:pointer; font-size:13px;">取消</button>
                </div>
            `;

            pickerContainer.innerHTML = pickerHTML;
            pickerContainer.style.display = 'block';

            setTimeout(() => {
                const closeOnClickOutside = (e) => {
                    if (!pickerContainer.contains(e.target) && e.target !== targetInput) {
                        pickerContainer.style.display = 'none';
                        document.removeEventListener('click', closeOnClickOutside);
                    }
                };
                document.addEventListener('click', closeOnClickOutside);
            }, 100);
        }

        function changeZhYear(delta) {
            currentZhPickerYear += delta;
            const yearSpan = document.getElementById('zh-picker-year-' + currentZhPickerTarget);
            if (yearSpan) {
                yearSpan.textContent = currentZhPickerYear + '年';
            }
        }

        function selectZhMonth(month, targetId) {
            const pad = n => (n < 10 ? '0' + n : '' + n);
            const isEnd = targetId === 'zh-end-datetime';
            // 获取该月的第一天和最后一天
            const year = currentZhPickerYear;
            const monthNum = month;
            const firstDay = `${year}-${pad(monthNum)}-01`;
            const lastDay = new Date(year, monthNum, 0).getDate();
            const lastDayStr = `${year}-${pad(monthNum)}-${pad(lastDay)}`;
            
            // 根据是开始还是结束时间设置不同的时间
            const dateTime = isEnd ? `${lastDayStr} 23:59:59` : `${firstDay} 00:00:00`;
            document.getElementById(targetId).value = dateTime;
            closeZhMonthPicker(targetId);
        }

        function closeZhMonthPicker(targetId) {
            const pickerId = targetId === 'zh-start-datetime' ? 'zh-start-datetime-picker' : 'zh-end-datetime-picker';
            document.getElementById(pickerId).style.display = 'none';
            currentZhPickerTarget = null;
        }

        // 查询综合数据报表
        async function queryComprehensiveReport() {
            const options = document.querySelectorAll('.comp-station-option');
            const selected = Array.from(options).filter(opt => opt.checked).map(opt => opt.value);
            const startDate = document.getElementById('comp-start-date').value;
            const endDate = document.getElementById('comp-end-date').value;

            if (selected.length === 0) {
                alert('请选择至少一个站点');
                return;
            }

            if (!startDate || !endDate) {
                alert('请选择开始日期和结束日期');
                return;
            }

            if (startDate > endDate) {
                alert('开始日期不能大于结束日期');
                return;
            }

            const reportResult = document.getElementById('comp-report-result');
            reportResult.style.display = 'block';
            reportResult.innerHTML = '<div style="text-align:center; padding:40px;"><i class="fas fa-spinner fa-spin" style="font-size:32px; color:#007bff;"></i><br><br>正在查询数据，请稍候...</div>';

            // 禁用导出按钮
            const exportBtn = document.getElementById('comp-report-export-btn');
            if (exportBtn) {
                exportBtn.disabled = true;
                exportBtn.style.background = '#adb5bd';
                exportBtn.style.cursor = 'not-allowed';
            }

            try {
                const result = {};

                for (const station of selected) {
                    const stationData = await queryCompStationData(station, startDate, endDate);
                    result[station] = stationData;
                }

                generateCompReport(result, selected, startDate, endDate);

            } catch (error) {
                reportResult.innerHTML = `<div style="text-align:center; padding:40px; color:#dc3545;"><i class="fas fa-exclamation-circle" style="font-size:32px;"></i><br><br>${error.message}</div>`;
                // 保持导出按钮禁用状态
                const exportBtn = document.getElementById('comp-report-export-btn');
                if (exportBtn) {
                    exportBtn.disabled = true;
                    exportBtn.style.background = '#adb5bd';
                    exportBtn.style.cursor = 'not-allowed';
                }
            }
        }

        // 查询综合报表单个站点的数据
        async function queryCompStationData(station, startDate, endDate) {
            console.log(`\n========== 开始查询 ${station} 综合数据 ==========`);
            const stationData = {
                cheYanZhiJiIncome: 0,
                cheHaiYangIncome: 0,
                weixinIncome: 0,
                shouQianBaIncome: 0,
                xingYuanIncome: 0,
                kuaiYiJieIncome: 0,
                monthlyCardIncome: 0,
                occupancyFee: 0,
                saiFeiMuIncome: 0,
                hongMenIncome: 0,
                venueCost: 0,
                couponCost: 0,
                otherCost: 0
            };

            const startDateFormatted = startDate + '-01';
            const endDateParts = endDate.split('-');
            const lastDay = new Date(parseInt(endDateParts[0]), parseInt(endDateParts[1]), 0).getDate();
            const endDateFormatted = endDate + '-' + lastDay;
            console.log(`日期范围: ${startDateFormatted} 到 ${endDateFormatted}`);

            try {
                // 1. 车颜知己洗车收入（高岭站）
                if (station === '高岭站') {
                    console.log('1. 查询车颜知己洗车收入...');
                    stationData.cheYanZhiJiIncome = await queryCheYanZhiJiIncome(startDateFormatted, endDateFormatted);
                    console.log(`   结果: ${stationData.cheYanZhiJiIncome}`);
                }

                // 2. 车海洋洗车收入（四方坪站）
                if (station === '四方坪站') {
                    console.log('2. 查询车海洋洗车收入...');
                    stationData.cheHaiYangIncome = await queryCheHaiYangIncome(startDateFormatted, endDateFormatted);
                    console.log(`   结果: ${stationData.cheHaiYangIncome}`);
                }

                // 3. 微信收入（四方坪站）
                if (station === '四方坪站') {
                    console.log('3. 查询微信收入...');
                    stationData.weixinIncome = await queryWeixinIncome(startDateFormatted, endDateFormatted);
                    console.log(`   结果: ${stationData.weixinIncome}`);
                }

                // 4. 收钱吧收入（四方坪站）
                if (station === '四方坪站') {
                    console.log('4. 查询收钱吧收入...');
                    stationData.shouQianBaIncome = await queryShouQianBaIncome(startDateFormatted, endDateFormatted);
                    console.log(`   结果: ${stationData.shouQianBaIncome}`);
                }

                // 5. 兴元售货机收入（按机器名称区分站点）
                console.log('5. 查询兴元售货机收入...');
                stationData.xingYuanIncome = await queryXingYuanIncome(station, startDateFormatted, endDateFormatted);
                console.log(`   结果: ${stationData.xingYuanIncome}`);

                // 6. 快易洁洗车收入（高岭站）
                if (station === '高岭站') {
                    console.log('6. 查询快易洁洗车收入...');
                    stationData.kuaiYiJieIncome = await queryKuaiYiJieIncome(startDateFormatted, endDateFormatted);
                    console.log(`   结果: ${stationData.kuaiYiJieIncome}`);
                }

                // 7. 月卡收入（四方坪站）
                if (station === '四方坪站') {
                    console.log('7. 查询月卡收入...');
                    stationData.monthlyCardIncome = await queryMonthlyCard(startDateFormatted, endDateFormatted);
                    console.log(`   结果: ${stationData.monthlyCardIncome}`);
                }

                // 8. 超时占位费（高岭站）
                if (station === '高岭站') {
                    console.log('8. 查询超时占位费...');
                    stationData.occupancyFee = await queryOccupancyFee(startDateFormatted, endDateFormatted);
                    console.log(`   结果: ${stationData.occupancyFee}`);
                }

                // 9. 道闸收入
                if (station === '四方坪站') {
                    console.log('8.1 查询赛菲姆道闸收入...');
                    stationData.saiFeiMuIncome = await querySaiFeiMuIncome(startDateFormatted, endDateFormatted);
                    console.log(`   结果: ${stationData.saiFeiMuIncome}`);

                    console.log('8.2 查询红门道闸收入...');
                    stationData.hongMenIncome = await queryHongMenIncome(startDateFormatted, endDateFormatted);
                    console.log(`   结果: ${stationData.hongMenIncome}`);
                }

                console.log(`========== ${station} 综合数据查询完成 ==========\n`);
                return stationData;

            } catch (error) {
                console.error(`查询 ${station} 综合数据时出错:`, error);
                throw error;
            }
        }

        // 查询车颜知己洗车收入
        async function queryCheYanZhiJiIncome(startDate, endDate) {
            // 第一种情况：使用会员卡为"否"，订单状态为"已完成"
            const query1 = `SELECT SUM(CAST([订单金额] AS FLOAT)) AS total
                           FROM [车颜知己洗车]
                           WHERE [启动时间] >= '${startDate}'
                           AND [启动时间] < DATEADD(day, 1, '${endDate}')
                           AND [使用会员卡] = N'否'
                           AND [订单状态] = N'已完成'`;

            const results1 = await executeLeanCloudSQL(query1);
            const total1 = results1.length > 0 && results1[0].total ? parseFloat(results1[0].total) : 0;

            // 第二种情况：使用会员卡为"是"，订单状态为"已完成"，统计记录数乘以7
            const query2 = `SELECT COUNT(*) AS count
                           FROM [车颜知己洗车]
                           WHERE [启动时间] >= '${startDate}'
                           AND [启动时间] < DATEADD(day, 1, '${endDate}')
                           AND [使用会员卡] = N'是'
                           AND [订单状态] = N'已完成'`;

            const results2 = await executeLeanCloudSQL(query2);
            const count = results2.length > 0 && results2[0].count ? parseInt(results2[0].count) : 0;
            const total2 = count * 7;

            return total1 + total2;
        }

        // 查询车海洋洗车收入
        async function queryCheHaiYangIncome(startDate, endDate) {
            // 车海洋洗车消费表的返还金额
            const query1 = `SELECT SUM(CAST([返还金额] AS FLOAT)) AS total
                           FROM [车海洋洗车消费]
                           WHERE [时间] >= '${startDate}'
                           AND [时间] < DATEADD(day, 1, '${endDate}')`;

            const results1 = await executeLeanCloudSQL(query1);
            const total1 = results1.length > 0 && results1[0].total ? parseFloat(results1[0].total) : 0;

            // 车海洋洗车充值表的返还金额
            const query2 = `SELECT SUM(CAST([返还金额] AS FLOAT)) AS total
                           FROM [车海洋洗车充值]
                           WHERE [时间] >= '${startDate}'
                           AND [时间] < DATEADD(day, 1, '${endDate}')`;

            const results2 = await executeLeanCloudSQL(query2);
            const total2 = results2.length > 0 && results2[0].total ? parseFloat(results2[0].total) : 0;

            return total1 + total2;
        }

        // 查询赛菲姆道闸收入（排除线下现金支付方式）
        async function querySaiFeiMuIncome(startDate, endDate) {
            const query = `SELECT SUM(CAST([支付金额] AS FLOAT)) AS total
                          FROM [赛菲姆道闸]
                          WHERE [支付时间] >= '${startDate}'
                          AND [支付时间] < DATEADD(day, 1, '${endDate}')
                          AND [支付方式] != N'线下现金'`;
            
            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询微信收入
        async function queryWeixinIncome(startDate, endDate) {
            const query = `SELECT SUM(CAST([应结订单金额] AS FLOAT)) AS total
                          FROM [微信收款商业版]
                          WHERE [交易时间] >= '${startDate}'
                          AND [交易时间] < DATEADD(day, 1, '${endDate}')`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询收钱吧收入
        async function queryShouQianBaIncome(startDate, endDate) {
            const query = `SELECT SUM(CAST([收款金额] AS FLOAT)) AS total
                          FROM [收钱吧]
                          WHERE [交易日期] >= '${startDate}'
                          AND [交易日期] < DATEADD(day, 1, '${endDate}')`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询兴元售货机收入
        async function queryXingYuanIncome(station, startDate, endDate) {
            let condition = '';
            if (station === '高岭站') {
                condition = "AND [机器名称] = N'高岭'";
            } else {
                condition = "AND ([机器名称] IS NULL OR [机器名称] <> N'高岭')";
            }

            const query = `SELECT SUM(CAST([支付金额] AS FLOAT)) AS total
                          FROM [兴元售货机]
                          WHERE [支付时间] >= '${startDate}'
                          AND [支付时间] < DATEADD(day, 1, '${endDate}')
                          ${condition}`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询快易洁洗车收入
        async function queryKuaiYiJieIncome(startDate, endDate) {
            const query = `SELECT
                              SUM(ISNULL(CAST([充值返还] AS FLOAT), 0) + ISNULL(CAST([消费返还] AS FLOAT), 0)) AS total
                          FROM [快易洁洗车]
                          WHERE [日期] >= '${startDate}'
                          AND [日期] < DATEADD(day, 1, '${endDate}')`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询赛菲姆道闸收入（排除线下现金支付方式）
        async function querySaiFeiMuIncome(startDate, endDate) {
            const query = `SELECT SUM(CAST([支付金额] AS FLOAT)) AS total
                          FROM [赛菲姆道闸]
                          WHERE [支付时间] >= '${startDate}'
                          AND [支付时间] < DATEADD(day, 1, '${endDate}')
                          AND [支付方式] != N'线下现金'`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询红门道闸收入
        async function queryHongMenIncome(startDate, endDate) {
            const query = `SELECT SUM(CAST([交易金额] AS FLOAT)) AS total
                          FROM [红门缴费]
                          WHERE [缴费时间] >= '${startDate}'
                          AND [缴费时间] < DATEADD(day, 1, '${endDate}')`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 查询月卡收入
        async function queryMonthlyCard(startDate, endDate) {
            const query = `SELECT SUM(CAST([交款金额] AS FLOAT)) AS total
                          FROM [月租车充值]
                          WHERE [交款时间] >= '${startDate}'
                          AND [交款时间] < DATEADD(day, 1, '${endDate}')`;

            const results = await executeLeanCloudSQL(query);
            return results.length > 0 && results[0].total ? parseFloat(results[0].total) : 0;
        }

        // 生成综合报表
        function generateCompReport(data, stations, startDate, endDate) {
            const reportResult = document.getElementById('comp-report-result');
            let html = '';

            // 保存报表数据
            compReportData = {
                data: data,
                stations: stations,
                startDate: startDate,
                endDate: endDate
            };

            if (stations.length === 1) {
                html = generateSingleStationCompReport(data, stations[0], startDate, endDate);
            } else if (stations.length === 2) {
                html = generateDualStationCompReport(data, stations, startDate, endDate);
            }

            reportResult.innerHTML = html;
            
            // 启用导出按钮
            const exportBtn = document.getElementById('comp-report-export-btn');
            if (exportBtn) {
                exportBtn.disabled = false;
                exportBtn.style.background = '#28a745';
                exportBtn.style.cursor = 'pointer';
                exportBtn.onmouseover = function() { this.style.background = '#218838'; };
                exportBtn.onmouseout = function() { this.style.background = '#28a745'; };
            }
        }

        // 生成单站综合报表
        function generateSingleStationCompReport(data, station, startDate, endDate) {
            const stationData = data[station] || {};

            // 格式化日期显示
            let periodDisplay = startDate;
            if (startDate !== endDate) {
                periodDisplay = `${startDate}至${endDate}`;
            }

            // 计算营业收入合计
            const totalRevenue = parseFloat(stationData.cheYanZhiJiIncome || 0) +
                                parseFloat(stationData.cheHaiYangIncome || 0) +
                                parseFloat(stationData.weixinIncome || 0) +
                                parseFloat(stationData.shouQianBaIncome || 0) +
                                parseFloat(stationData.xingYuanIncome || 0) +
                                parseFloat(stationData.kuaiYiJieIncome || 0) +
                                parseFloat(stationData.monthlyCardIncome || 0) +
                                parseFloat(stationData.occupancyFee || 0) +
                                parseFloat(stationData.saiFeiMuIncome || 0) +
                                parseFloat(stationData.hongMenIncome || 0);

            // 道闸收入合计
            const daozhaIncome = parseFloat(stationData.saiFeiMuIncome || 0) + parseFloat(stationData.hongMenIncome || 0);

            // 营业成本合计
            const totalCost = parseFloat(stationData.venueCost || 0) +
                            parseFloat(stationData.couponCost || 0) +
                            parseFloat(stationData.otherCost || 0);

            // 毛利润和毛利率
            const grossProfit = totalRevenue - totalCost;
            const grossMargin = totalRevenue > 0 ? ((grossProfit / totalRevenue) * 100).toFixed(2) : '0.00';

            let html = `
                <div style="background:#fff; padding:30px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <h2 style="text-align:center; margin-bottom:20px; color:#333; font-size:24px;">综合数据报表</h2>
                    <div style="width:100%; color:#666; font-size:14px; display:flex; box-sizing:border-box;">
                        <div style="width:30%; padding:12px; text-align:left; box-sizing:border-box;">单位：长沙飞狐电动汽车充电服务有限公司</div>
                        <div style="width:25%; padding:12px; text-align:left; box-sizing:border-box;">站点：${station}</div>
                        <div style="width:25%; padding:12px; text-align:left; box-sizing:border-box;">报表周期：${periodDisplay}</div>
                        <div style="flex:1; padding:12px; text-align:right; box-sizing:border-box;">金额：元</div>
                    </div>

                    <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
                        <thead>
                            <tr style="background:#f8f9fa;">
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600; width:60%;">项目</th>
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600; width:25%;">金额</th>
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600; width:15%;">备注</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" style="padding:10px 12px; border:1px solid #dee2e6; background:#f1f3f5; font-weight:600;">一、营业收入</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">1、车海洋洗车收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.cheHaiYangIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">2、微信收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.weixinIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">3、收钱吧收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.shouQianBaIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">4、兴元售货机收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.xingYuanIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">5、道闸收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(daozhaIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 50px; border:1px solid #dee2e6;">5.1 赛菲姆道闸</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.saiFeiMuIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 50px; border:1px solid #dee2e6;">5.2 红门道闸</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.hongMenIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">6、车颜知己洗车收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.cheYanZhiJiIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">7、快易洁洗车收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.kuaiYiJieIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">8、月卡收入</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.monthlyCardIncome)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">9、超时占位费</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.occupancyFee)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr style="background:#f8f9fa; font-weight:600;">
                                <td style="padding:10px 12px; border:1px solid #dee2e6;">营业收入合计</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(totalRevenue)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="padding:10px 12px; border:1px solid #dee2e6; background:#f1f3f5; font-weight:600;">二、营业成本</td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">1、场地成本</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.venueCost)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">2、活动优惠券</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.couponCost)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td style="padding:8px 12px 8px 30px; border:1px solid #dee2e6;">3、其他成本</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(stationData.otherCost)}</td>
                                <td style="padding:8px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr style="background:#f8f9fa; font-weight:600;">
                                <td style="padding:10px 12px; border:1px solid #dee2e6;">营业成本合计</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(totalCost)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="padding:10px 12px; border:1px solid #dee2e6; background:#f1f3f5; font-weight:600;">三、毛利润</td>
                            </tr>
                            <tr style="background:#e7f5ff;">
                                <td style="padding:10px 12px 10px 30px; border:1px solid #dee2e6; font-weight:600;">毛利润</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; font-weight:600; color:${grossProfit >= 0 ? '#28a745' : '#dc3545'};">${formatMoney(grossProfit)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                            <tr style="background:#e7f5ff;">
                                <td style="padding:10px 12px 10px 30px; border:1px solid #dee2e6; font-weight:600;">毛利率</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; font-weight:600; color:${grossProfit >= 0 ? '#28a745' : '#dc3545'};">${grossMargin}%</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6;"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }

        // 生成双站综合对比报表
        function generateDualStationCompReport(data, stations, startDate, endDate) {
            const sfpData = data['四方坪站'] || {};
            const glData = data['高岭站'] || {};

            // 格式化日期显示
            let periodDisplay = startDate;
            if (startDate !== endDate) {
                periodDisplay = `${startDate}至${endDate}`;
            }

            // 动态生成站点显示名称
            const stationDisplay = stations.join('和');

            // 计算四方坪站营业收入
            const sfpRevenue = parseFloat(sfpData.cheHaiYangIncome || 0) +
                              parseFloat(sfpData.weixinIncome || 0) +
                              parseFloat(sfpData.shouQianBaIncome || 0) +
                              parseFloat(sfpData.xingYuanIncome || 0) +
                              parseFloat(sfpData.monthlyCardIncome || 0) +
                              parseFloat(sfpData.saiFeiMuIncome || 0) +
                              parseFloat(sfpData.hongMenIncome || 0);

            // 计算高岭站营业收入
            const glRevenue = parseFloat(glData.cheYanZhiJiIncome || 0) +
                             parseFloat(glData.xingYuanIncome || 0) +
                             parseFloat(glData.kuaiYiJieIncome || 0) +
                             parseFloat(glData.occupancyFee || 0);

            const totalRevenue = sfpRevenue + glRevenue;

            // 营业成本
            const sfpCost = parseFloat(sfpData.venueCost || 0) + parseFloat(sfpData.couponCost || 0) + parseFloat(sfpData.otherCost || 0);
            const glCost = parseFloat(glData.venueCost || 0) + parseFloat(glData.couponCost || 0) + parseFloat(glData.otherCost || 0);
            const totalCost = sfpCost + glCost;

            // 其他成本（此处暂时为0）
            const sfpOtherCost = 0;
            const glOtherCost = 0;
            const totalOtherCost = 0;

            // 毛利润
            const sfpGrossProfit = sfpRevenue - sfpCost;
            const glGrossProfit = glRevenue - glCost;
            const totalGrossProfit = totalRevenue - totalCost;

            // 毛利率
            const sfpGrossMargin = sfpRevenue > 0 ? ((sfpGrossProfit / sfpRevenue) * 100).toFixed(2) : '0.00';
            const glGrossMargin = glRevenue > 0 ? ((glGrossProfit / glRevenue) * 100).toFixed(2) : '0.00';
            const totalGrossMargin = totalRevenue > 0 ? ((totalGrossProfit / totalRevenue) * 100).toFixed(2) : '0.00';

            let html = `
                <div style="background:#fff; padding:30px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <h2 style="text-align:center; margin-bottom:20px; color:#333; font-size:24px;">综合数据报表</h2>
                    <div style="width:100%; color:#666; font-size:14px; display:flex; box-sizing:border-box;">
                        <div style="width:40%; padding:12px; text-align:left; box-sizing:border-box;">单位：长沙飞狐电动汽车充电服务有限公司</div>
                        <div style="width:20%; padding:12px; text-align:right; box-sizing:border-box;">站点：${stationDisplay}</div>
                        <div style="width:20%; padding:12px; text-align:right; box-sizing:border-box;">报表周期：${periodDisplay}</div>
                        <div style="flex:1; padding:12px; text-align:right; box-sizing:border-box;">金额：元</div>
                    </div>

                    <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
                        <thead>
                            <tr style="background:#f8f9fa;">
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600; width:40%;">指标</th>
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600; width:20%;">四方坪站</th>
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600; width:20%;">高岭站</th>
                                <th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600; width:20%;">两站合计</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; font-weight:600;">营业收入</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(sfpRevenue)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(glRevenue)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; background:#f8f9fa; font-weight:600;">${formatMoney(totalRevenue)}</td>
                            </tr>
                            <tr>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; font-weight:600;">营业成本</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(sfpCost)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(glCost)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; background:#f8f9fa; font-weight:600;">${formatMoney(totalCost)}</td>
                            </tr>
                            <tr>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; font-weight:600;">其他成本</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(sfpOtherCost)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right;">${formatMoney(glOtherCost)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; background:#f8f9fa; font-weight:600;">${formatMoney(totalOtherCost)}</td>
                            </tr>
                            <tr style="background:#e7f5ff;">
                                <td style="padding:10px 12px; border:1px solid #dee2e6; font-weight:600;">毛利润</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; color:${sfpGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${formatMoney(sfpGrossProfit)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; color:${glGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${formatMoney(glGrossProfit)}</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; background:#d0ebff; color:${totalGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${formatMoney(totalGrossProfit)}</td>
                            </tr>
                            <tr style="background:#e7f5ff;">
                                <td style="padding:10px 12px; border:1px solid #dee2e6; font-weight:600;">毛利率</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; color:${sfpGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${sfpGrossMargin}%</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; color:${glGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${glGrossMargin}%</td>
                                <td style="padding:10px 12px; border:1px solid #dee2e6; text-align:right; background:#d0ebff; color:${totalGrossProfit >= 0 ? '#28a745' : '#dc3545'}; font-weight:600;">${totalGrossMargin}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }

        // 导出综合数据报表
        function exportComprehensiveReport() {
            if (!compReportData) {
                alert('没有可导出的数据，请先查询报表');
                return;
            }

            const { data, stations, startDate, endDate } = compReportData;
            const reportResult = document.getElementById('comp-report-result');
            const table = reportResult.querySelector('table');
            
            if (!table) {
                alert('没有找到报表数据');
                return;
            }

            // 从表格中提取数据
            const headers = [];
            const rows = [];

            // 获取表头
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                headerRow.querySelectorAll('th').forEach(th => {
                    headers.push(th.textContent.trim());
                });
            }

            // 获取数据行
            const dataRows = table.querySelectorAll('tbody tr');
            dataRows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    let cellText = cell.textContent.trim();
                    // 移除颜色样式标记（如果有）
                    cellText = cellText.replace(/\s+/g, ' ');
                    rowData.push(cellText);
                });
                if (rowData.length > 0) {
                    rows.push(rowData);
                }
            });

            // 创建Excel数据
            const excelData = [headers];
            rows.forEach(row => excelData.push(row));

            // 生成文件名
            let periodDisplay = startDate;
            if (startDate !== endDate) {
                periodDisplay = `${startDate}至${endDate}`;
            }
            const stationName = stations.length === 1 ? stations[0] : stations.join('和');
            const fileName = `综合数据报表_${stationName}_${periodDisplay}.xlsx`;

            // 创建工作簿和工作表
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // 设置列宽
            const colWidths = headers.map(() => ({ wch: 20 }));
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, '综合数据报表');
            XLSX.writeFile(wb, fileName);
        }

        // ========== 其它数据页面相关函数 ==========
        
        // 其它数据页面电站选择菜单切换
        function toggleOtherStationMenu() {
            const menu = document.getElementById('other-station-menu');
            if (!menu) return;
            menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
        }

        // 点击页面空白处隐藏其它数据电站下拉
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('other-station-menu');
            const box = document.getElementById('other-station-box');
            if (!menu || !box) return;
            if (menu.style.display === 'none' || menu.style.display === '') return;
            const target = e.target;
            if (!box.contains(target) && !menu.contains(target)) {
                menu.style.display = 'none';
            }
        });

        // 其它数据页面全选/取消全选电站
        function onToggleAllOtherStations() {
            const all = document.getElementById('other-station-all');
            const items = document.querySelectorAll('#other-station-menu .other-station-option');
            items.forEach(i => { i.checked = all.checked; });
            onOtherStationChange();
        }

        // 其它数据页面应用电站选择
        function applyOtherStationSelection() {
            const all = document.getElementById('other-station-all');
            const items = Array.from(document.querySelectorAll('#other-station-menu .other-station-option'));
            const checked = items.filter(i => i.checked).map(i => i.value);
            if (checked.length === items.length) {
                all.checked = true;
            } else {
                all.checked = false;
            }
            // 显示已选择的电站名称
            const display = document.getElementById('other-station-display');
            if (display) {
                if (all.checked) {
                    display.textContent = '电站：全选';
                } else if (checked.length > 0) {
                    display.textContent = '电站：' + checked.join('、');
                } else {
                    display.textContent = '电站：未选择';
                }
            }
            onOtherStationChange();
            toggleOtherStationMenu();
        }

        // 其它数据页面电站选择变化
        function onOtherStationChange() {
            const all = document.getElementById('other-station-all');
            const items = Array.from(document.querySelectorAll('#other-station-menu .other-station-option'));
            const checked = items.filter(i => i.checked).map(i => i.value);
            if (checked.length === items.length) {
                if (all) all.checked = true;
            } else {
                if (all) all.checked = false;
            }
            // 更新显示文本
            const display = document.getElementById('other-station-display');
            if (display) {
                if (all && all.checked) {
                    display.textContent = '电站：全选';
                } else if (checked.length > 0) {
                    display.textContent = '电站：' + checked.join('、');
                } else {
                    display.textContent = '电站：未选择';
                }
            }

            // 更新数据类别选项的可见性
            updateOtherDataCategoryOptions();
        }

        // 更新数据类别选项的可见性（只有选择四方坪站时才显示滴滴专用选项）
        function updateOtherDataCategoryOptions() {
            const all = document.getElementById('other-station-all');
            const items = Array.from(document.querySelectorAll('#other-station-menu .other-station-option'));
            const checked = items.filter(i => i.checked).map(i => i.value);
            const categorySelect = document.getElementById('other-data-category');

            if (!categorySelect) return;

            // 获取滴滴专用选项
            const didiOptions = categorySelect.querySelectorAll('.didi-only');

            // 判断是否只选择了四方坪站（不包括高岭站）
            const isSifangpingOnly = checked.includes('四方坪站') && !checked.includes('高岭站');

            // 显示或隐藏滴滴专用选项
            didiOptions.forEach(option => {
                if (isSifangpingOnly) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                    // 如果当前选中的是滴滴专用选项，则重置选择
                    if (categorySelect.value === option.value) {
                        categorySelect.value = '';
                    }
                }
            });
        }

        // 数据类别变化时的处理（可选，用于未来扩展）
        function onOtherDataCategoryChange() {
            // 暂时不需要特殊处理
        }

        // 初始化其它数据页面日期选择器
        function initOtherDatetimePickers() {
            try {
                // 设置默认值(当前时间)
                const now = new Date();
                const defaultValues = {
                    start: now.toISOString().slice(0, 10) + ' 00:00:00',
                    end: now.toISOString().slice(0, 10) + ' 23:59:59'
                };

                // 使用统一的日期选择器初始化函数
                initDatetimePickers('other-start-datetime', 'other-end-datetime', 'other-start-datetime-btn', 'other-end-datetime-btn', defaultValues);
            } catch (e) {
                console.error('初始化其它数据页面日期选择器失败:', e);
            }
        }

        // BI数据看板初始化（设置默认值为当前年月）
        function initBIDatetimePickers() {
            try {
                // 获取当前年月，格式为 yyyy-mm
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
                const currentYearMonth = `${currentYear}-${currentMonth}`;
                
                // 设置开始日期和结束日期默认值为当前年月
                const startTimeEl = document.getElementById('bi-start-datetime');
                const endTimeEl = document.getElementById('bi-end-datetime');
                
                if (startTimeEl) {
                    startTimeEl.value = currentYearMonth;
                }
                if (endTimeEl) {
                    endTimeEl.value = currentYearMonth;
                }
                
                // 站点选择器已经通过HTML和事件监听器初始化
            } catch (e) {
                console.error('初始化BI数据看板失败:', e);
            }
        }

        // 将能科的充电时长从hh:mm:ss格式转换为分钟
        function convertDurationToMinutes(durationStr) {
            if (!durationStr) return 0;
            const str = String(durationStr).trim();
            const parts = str.split(':');
            if (parts.length === 3) {
                const hours = parseInt(parts[0]) || 0;
                const minutes = parseInt(parts[1]) || 0;
                const seconds = parseInt(parts[2]) || 0;
                return hours * 60 + minutes + Math.round(seconds / 60);
            }
            return parseFloat(str) || 0;
        }

        // BI数据查询主函数
        async function runBIQuery() {
            const pageReportBI = document.getElementById('page-report-bi');
            if (!pageReportBI) {
                alert('页面元素未找到');
                return;
            }
            
            // 获取站点选择（从checkbox获取）
            const allCheckbox = pageReportBI.querySelector('#bi-station-all');
            const stationOptions = pageReportBI.querySelectorAll('.bi-station-option');
            const selectedOptions = Array.from(stationOptions).filter(opt => opt.checked);
            const isAllSelected = allCheckbox && allCheckbox.checked;
            
            const startTimeEl = document.getElementById('bi-start-datetime');
            const endTimeEl = document.getElementById('bi-end-datetime');
            const conditionsDiv = document.getElementById('bi-query-conditions');
            const conditionsText = document.getElementById('bi-conditions-text');
            const chartsContainer = document.getElementById('bi-charts-container');
            const initialTip = document.getElementById('bi-initial-tip');

            if (!startTimeEl || !endTimeEl) {
                alert('页面元素未找到');
                return;
            }

            const startTime = startTimeEl.value.trim();
            const endTime = endTimeEl.value.trim();

            if (!isAllSelected && selectedOptions.length === 0) {
                alert('请选择站点');
                return;
            }

            if (!startTime || !endTime) {
                alert('请选择时间范围');
                return;
            }

            // 获取选中的站点值（用于查询）
            let selectedStations = [];
            if (isAllSelected) {
                selectedStations = ['all'];
            } else {
                selectedStations = selectedOptions.map(opt => {
                    if (opt.value === '四方坪站') return 'sifangping';
                    if (opt.value === '高岭站') return 'gaoling';
                    return opt.value;
                });
            }

            // 显示查询条件
            let stationText = '';
            if (isAllSelected) {
                stationText = '全选';
            } else {
                stationText = selectedOptions.map(opt => opt.value).join('、');
            }
            conditionsText.textContent = `站点：${stationText}，开始时间：${startTime}，结束时间：${endTime}`;
            conditionsDiv.style.display = 'block';
            if (initialTip) initialTip.style.display = 'none';
            chartsContainer.style.display = 'block';

            // 显示加载提示
            chartsContainer.innerHTML = '<div style="text-align:center; padding:40px;"><p>正在查询数据...</p></div>';

            try {
                // 处理月份格式（YYYY-MM）转换为日期时间
                let startDateTime = startTime;
                let endDateTime = endTime;
                
                // 如果输入是月份格式（YYYY-MM），转换为该月的开始和结束日期时间
                if (/^\d{4}-\d{2}$/.test(startTime)) {
                    startDateTime = startTime + '-01 00:00:00';
                }
                if (/^\d{4}-\d{2}$/.test(endTime)) {
                    const [year, month] = endTime.split('-');
                    const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();
                    endDateTime = `${endTime}-${String(lastDay).padStart(2, '0')} 23:59:59`;
                }
                
                const start = toSqlDateTime(startDateTime, false);
                const end = toSqlDateTime(endDateTime, true);

                // 构建查询SQL
                let sqlQueries = [];
                
                // 判断需要查询哪些数据
                const queryAll = selectedStations.includes('all');
                const querySifangping = queryAll || selectedStations.includes('sifangping');
                const queryGaoling = queryAll || selectedStations.includes('gaoling');

                // 查询特来电表数据
                if (queryAll || querySifangping || queryGaoling) {
                    let teldaiConditions = [];
                    if (queryAll) {
                        // 全选：查询所有数据
                        teldaiConditions.push('1=1');
                    } else {
                        if (querySifangping && queryGaoling) {
                            // 两个站点都选
                            teldaiConditions.push('1=1');
                        } else if (querySifangping) {
                            // 只选四方坪站：不包含高岭站的数据
                            teldaiConditions.push(`([电站名称] NOT LIKE '%华为飞狐特来电高岭超充站%' AND [电站名称] NOT LIKE '%长沙市开福区高岭香江国际城充电站建设项目%')`);
                        } else if (queryGaoling) {
                            // 只选高岭站：包含高岭站的数据
                            teldaiConditions.push(`([电站名称] LIKE '%华为飞狐特来电高岭超充站%' OR [电站名称] LIKE '%长沙市开福区高岭香江国际城充电站建设项目%')`);
                        }
                    }
                    
                    const teldaiSql = `SELECT 
                        CAST([充电结束时间] AS DATE) AS [日期],
                        SUM(CAST([充电电量(度)] AS FLOAT)) AS [充电电量],
                        SUM(CAST([充电服务费(元)] AS FLOAT)) AS [充电服务费],
                        SUM(CAST([充电费用(元)] AS FLOAT)) AS [充电费用],
                        SUM(CAST([充电时长(分钟)] AS FLOAT)) AS [充电时长],
                        COUNT(*) AS [订单数]
                    FROM [特来电]
                    WHERE ${teldaiConditions.join(' OR ')} 
                        AND [充电结束时间] BETWEEN '${start}' AND '${end}'
                    GROUP BY CAST([充电结束时间] AS DATE)
                    ORDER BY CAST([充电结束时间] AS DATE)`;
                    
                    sqlQueries.push({ sql: teldaiSql, type: 'teldai' });
                }

                // 查询能科表数据（四方坪站或全选时查询）
                if (queryAll || querySifangping) {
                    const nengkeSql = `SELECT 
                        CAST([结束日期时间] AS DATE) AS [日期],
                        SUM(CAST([充电量] AS FLOAT)) AS [充电电量],
                        SUM(CAST(REPLACE([服务费], '￥', '') AS FLOAT)) AS [充电服务费],
                        SUM(CAST(REPLACE([消费金额], '￥', '') AS FLOAT)) AS [充电费用],
                        SUM(CASE 
                            WHEN [充电时长] IS NOT NULL THEN 
                                CASE 
                                    WHEN LEN(CAST([充电时长] AS VARCHAR(50))) >= 8 
                                         AND SUBSTRING(CAST([充电时长] AS VARCHAR(50)), 3, 1) = ':' 
                                         AND SUBSTRING(CAST([充电时长] AS VARCHAR(50)), 6, 1) = ':'
                                         AND ISNUMERIC(SUBSTRING(CAST([充电时长] AS VARCHAR(50)), 1, 2)) = 1
                                         AND ISNUMERIC(SUBSTRING(CAST([充电时长] AS VARCHAR(50)), 4, 2)) = 1
                                         AND ISNUMERIC(SUBSTRING(CAST([充电时长] AS VARCHAR(50)), 7, 2)) = 1 THEN
                                        (CAST(SUBSTRING(CAST([充电时长] AS VARCHAR(50)), 1, 2) AS INT) * 60 + 
                                         CAST(SUBSTRING(CAST([充电时长] AS VARCHAR(50)), 4, 2) AS INT) + 
                                         CAST(SUBSTRING(CAST([充电时长] AS VARCHAR(50)), 7, 2) AS FLOAT) / 60.0)
                                    WHEN ISNUMERIC(CAST([充电时长] AS VARCHAR(50))) = 1 THEN 
                                CAST([充电时长] AS FLOAT)
                                    ELSE 0 
                                END
                            ELSE 0 
                        END) AS [充电时长],
                        COUNT(*) AS [订单数]
                    FROM [能科]
                    WHERE [结束日期时间] BETWEEN '${start}' AND '${end}'
                    GROUP BY CAST([结束日期时间] AS DATE)
                    ORDER BY CAST([结束日期时间] AS DATE)`;
                    
                    sqlQueries.push({ sql: nengkeSql, type: 'nengke' });
                }

                // 查询滴滴表数据（四方坪站或全选时查询）
                if (queryAll || querySifangping) {
                    const didiSql = `SELECT 
                        CAST([充电完成时间] AS DATE) AS [日期],
                        SUM(CASE 
                            WHEN [充电量（度）] IS NOT NULL AND [充电量（度）] <> '' AND ISNUMERIC([充电量（度）]) = 1 THEN CAST([充电量（度）] AS FLOAT)
                            ELSE 0 
                        END) AS [充电电量],
                        SUM(CASE 
                            WHEN [充电服务费（元）] IS NOT NULL AND [充电服务费（元）] <> '' AND ISNUMERIC([充电服务费（元）]) = 1 THEN CAST([充电服务费（元）] AS FLOAT)
                            ELSE 0 
                        END) AS [充电服务费],
                        SUM(CASE 
                            WHEN [订单总额（元）] IS NOT NULL AND [订单总额（元）] <> '' AND ISNUMERIC([订单总额（元）]) = 1 THEN CAST([订单总额（元）] AS FLOAT)
                            ELSE 0 
                        END) AS [充电费用],
                        SUM(CASE 
                            WHEN [充电时长（分钟）] IS NOT NULL AND [充电时长（分钟）] <> '' AND ISNUMERIC([充电时长（分钟）]) = 1 THEN CAST([充电时长（分钟）] AS FLOAT)
                            ELSE 0 
                        END) AS [充电时长],
                        COUNT([订单ID]) AS [订单数]
                    FROM [滴滴]
                    WHERE [充电完成时间] BETWEEN '${start}' AND '${end}'
                    GROUP BY CAST([充电完成时间] AS DATE)
                    ORDER BY CAST([充电完成时间] AS DATE)`;
                    
                    sqlQueries.push({ sql: didiSql, type: 'didi' });
                }

                // 执行查询
                const teldaiData = [];
                const nengkeData = [];
                const didiData = [];
                for (const queryInfo of sqlQueries) {
                    try {
                        const result = await callSqlWithRetry(queryInfo.sql);
                        let data = result;
                        if (result && result.result) {
                            data = typeof result.result === 'string' ? JSON.parse(result.result) : result.result;
                        }
                        if (data && data.results) {
                            data = data.results;
                        }
                        if (Array.isArray(data)) {
                            if (queryInfo.type === 'teldai') {
                                teldaiData.push(...data);
                            } else if (queryInfo.type === 'nengke') {
                                nengkeData.push(...data);
                            } else if (queryInfo.type === 'didi') {
                                didiData.push(...data);
                            }
                        }
                    } catch (error) {
                        console.error(`查询${queryInfo.type}数据失败:`, error);
                    }
                }

                // 合并数据（按日期分组，分别保存特来电和能科数据）
                const dailyData = {};
                const hasNengkeData = nengkeData.length > 0;
                
                // 处理特来电数据
                teldaiData.forEach(row => {
                    let date = row['日期'];
                    if (!date) return;
                    
                    let dateStr = '';
                    if (typeof date === 'string') {
                        dateStr = date.split('T')[0].split(' ')[0];
                    } else if (date instanceof Date) {
                        dateStr = date.toISOString().split('T')[0];
                    } else {
                        dateStr = String(date).split('T')[0].split(' ')[0];
                    }
                    
                    if (!dateStr || dateStr.length < 10) return;
                    
                    if (!dailyData[dateStr]) {
                        dailyData[dateStr] = {
                            date: dateStr,
                            charge: 0,
                            service: 0,
                            cost: 0,
                            duration: 0,
                            orders: 0,
                            teldaiCharge: 0,
                            teldaiService: 0,
                            teldaiCost: 0,
                            teldaiDuration: 0,
                            teldaiOrders: 0,
                            nengkeCharge: 0,
                            nengkeService: 0,
                            nengkeCost: 0,
                            nengkeDuration: 0,
                            nengkeOrders: 0,
                            didiCharge: 0,
                            didiService: 0,
                            didiCost: 0,
                            didiDuration: 0,
                            didiOrders: 0
                        };
                    }
                    
                    const charge = parseFloat(row['充电电量'] || 0) || 0;
                    const service = parseFloat(row['充电服务费'] || 0) || 0;
                    const cost = parseFloat(row['充电费用'] || 0) || 0;
                    const duration = parseFloat(row['充电时长'] || 0) || 0;
                    const orders = parseInt(row['订单数'] || 0) || 0;
                    
                    dailyData[dateStr].charge += charge;
                    dailyData[dateStr].service += service;
                    dailyData[dateStr].cost += cost;
                    dailyData[dateStr].duration += duration;
                    dailyData[dateStr].orders += orders;
                    dailyData[dateStr].teldaiCharge += charge;
                    dailyData[dateStr].teldaiService += service;
                    dailyData[dateStr].teldaiCost += cost;
                    dailyData[dateStr].teldaiDuration += duration;
                    dailyData[dateStr].teldaiOrders += orders;
                });
                
                // 处理能科数据
                nengkeData.forEach(row => {
                    let date = row['日期'];
                    if (!date) return;
                    
                    let dateStr = '';
                    if (typeof date === 'string') {
                        dateStr = date.split('T')[0].split(' ')[0];
                    } else if (date instanceof Date) {
                        dateStr = date.toISOString().split('T')[0];
                    } else {
                        dateStr = String(date).split('T')[0].split(' ')[0];
                    }
                    
                    if (!dateStr || dateStr.length < 10) return;
                    
                    if (!dailyData[dateStr]) {
                        dailyData[dateStr] = {
                            date: dateStr,
                            charge: 0,
                            service: 0,
                            cost: 0,
                            duration: 0,
                            orders: 0,
                            teldaiCharge: 0,
                            teldaiService: 0,
                            teldaiCost: 0,
                            teldaiDuration: 0,
                            teldaiOrders: 0,
                            nengkeCharge: 0,
                            nengkeService: 0,
                            nengkeCost: 0,
                            nengkeDuration: 0,
                            nengkeOrders: 0,
                            didiCharge: 0,
                            didiService: 0,
                            didiCost: 0,
                            didiDuration: 0,
                            didiOrders: 0
                        };
                    }
                    
                    const charge = parseFloat(row['充电电量'] || 0) || 0;
                    const service = parseFloat(row['充电服务费'] || 0) || 0;
                    const cost = parseFloat(row['充电费用'] || 0) || 0;
                    const duration = parseFloat(row['充电时长'] || 0) || 0;
                    const orders = parseInt(row['订单数'] || 0) || 0;
                    
                    dailyData[dateStr].charge += charge;
                    dailyData[dateStr].service += service;
                    dailyData[dateStr].cost += cost;
                    dailyData[dateStr].duration += duration;
                    dailyData[dateStr].orders += orders;
                    dailyData[dateStr].nengkeCharge += charge;
                    dailyData[dateStr].nengkeService += service;
                    dailyData[dateStr].nengkeCost += cost;
                    dailyData[dateStr].nengkeDuration += duration;
                    dailyData[dateStr].nengkeOrders += orders;
                });
                
                // 处理滴滴数据
                didiData.forEach(row => {
                    let date = row['日期'];
                    if (!date) return;
                    
                    let dateStr = '';
                    if (typeof date === 'string') {
                        dateStr = date.split('T')[0].split(' ')[0];
                    } else if (date instanceof Date) {
                        dateStr = date.toISOString().split('T')[0];
                    } else {
                        dateStr = String(date).split('T')[0].split(' ')[0];
                    }
                    
                    if (!dateStr || dateStr.length < 10) return;
                    
                    if (!dailyData[dateStr]) {
                        dailyData[dateStr] = {
                            date: dateStr,
                            charge: 0,
                            service: 0,
                            cost: 0,
                            duration: 0,
                            orders: 0,
                            teldaiCharge: 0,
                            teldaiService: 0,
                            teldaiCost: 0,
                            teldaiDuration: 0,
                            teldaiOrders: 0,
                            nengkeCharge: 0,
                            nengkeService: 0,
                            nengkeCost: 0,
                            nengkeDuration: 0,
                            nengkeOrders: 0,
                            didiCharge: 0,
                            didiService: 0,
                            didiCost: 0,
                            didiDuration: 0,
                            didiOrders: 0
                        };
                    }
                    
                    const charge = parseFloat(row['充电电量'] || 0) || 0;
                    const service = parseFloat(row['充电服务费'] || 0) || 0;
                    const cost = parseFloat(row['充电费用'] || 0) || 0;
                    const duration = parseFloat(row['充电时长'] || 0) || 0;
                    const orders = parseInt(row['订单数'] || 0) || 0;
                    
                    dailyData[dateStr].charge += charge;
                    dailyData[dateStr].service += service;
                    dailyData[dateStr].cost += cost;
                    dailyData[dateStr].duration += duration;
                    dailyData[dateStr].orders += orders;
                    dailyData[dateStr].didiCharge += charge;
                    dailyData[dateStr].didiService += service;
                    dailyData[dateStr].didiCost += cost;
                    dailyData[dateStr].didiDuration += duration;
                    dailyData[dateStr].didiOrders += orders;
                });

                // 转换为数组并排序
                const dataArray = Object.values(dailyData).sort((a, b) => 
                    new Date(a.date) - new Date(b.date)
                );

                if (dataArray.length === 0) {
                    chartsContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#999;"><p>未查询到数据</p></div>';
                    return;
                }

                // 检查是否跨月或跨年（基于实际数据日期范围）
                const actualStartDate = new Date(dataArray[0].date);
                const actualEndDate = new Date(dataArray[dataArray.length - 1].date);
                const hasCrossMonth = actualStartDate.getMonth() !== actualEndDate.getMonth() || 
                                     actualStartDate.getFullYear() !== actualEndDate.getFullYear();
                const hasCrossYear = actualStartDate.getFullYear() !== actualEndDate.getFullYear();

                // 生成统计描述文字
                const statsText = generateBIStatsText(dataArray, hasNengkeData, hasCrossMonth, hasCrossYear);

                // 生成图表
                renderBICharts(dataArray, hasCrossMonth, hasCrossYear, statsText);

            } catch (error) {
                console.error('BI数据查询失败:', error);
                chartsContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#dc3545;"><p>查询失败：' + error.message + '</p></div>';
            }
        }

        // 生成BI统计描述文字
        function generateBIStatsText(dataArray, hasNengkeData, hasCrossMonth, hasCrossYear) {
            if (!dataArray || dataArray.length === 0) return '';
            
            // 计算实际数据日期范围
            const dates = dataArray.map(d => new Date(d.date));
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            // 计算实际有数据的日期、月份、年份数量
            const daysDiff = dataArray.length; // 实际有数据的日期数
            const uniqueMonths = new Set(dataArray.map(d => d.date.substring(0, 7))); // 实际有数据的月份
            const monthsDiff = uniqueMonths.size;
            const uniqueYears = new Set(dataArray.map(d => d.date.substring(0, 4))); // 实际有数据的年份
            const yearsDiff = uniqueYears.size;
            
            // 按日期统计
            const maxChargeDay = dataArray.reduce((max, d) => d.charge > max.charge ? d : max, dataArray[0]);
            const minChargeDay = dataArray.reduce((min, d) => d.charge < min.charge ? d : min, dataArray[0]);
            const maxServiceDay = dataArray.reduce((max, d) => d.service > max.service ? d : max, dataArray[0]);
            const minServiceDay = dataArray.reduce((min, d) => d.service < min.service ? d : min, dataArray[0]);
            const maxCostDay = dataArray.reduce((max, d) => d.cost > max.cost ? d : max, dataArray[0]);
            const minCostDay = dataArray.reduce((min, d) => d.cost < min.cost ? d : min, dataArray[0]);
            const maxDurationDay = dataArray.reduce((max, d) => d.duration > max.duration ? d : max, dataArray[0]);
            const minDurationDay = dataArray.reduce((min, d) => d.duration < min.duration ? d : min, dataArray[0]);
            const maxOrdersDay = dataArray.reduce((max, d) => d.orders > max.orders ? d : max, dataArray[0]);
            const minOrdersDay = dataArray.reduce((min, d) => d.orders < min.orders ? d : min, dataArray[0]);
            
            // 计算日平均值（使用实际有数据的日期数）
            const avgCharge = dataArray.reduce((sum, d) => sum + d.charge, 0) / daysDiff;
            const avgService = dataArray.reduce((sum, d) => sum + d.service, 0) / daysDiff;
            const avgCost = dataArray.reduce((sum, d) => sum + d.cost, 0) / daysDiff;
            const avgDuration = dataArray.reduce((sum, d) => sum + d.duration, 0) / daysDiff;
            const avgOrders = dataArray.reduce((sum, d) => sum + d.orders, 0) / daysDiff;
            
            // 声明月度平均值变量（在函数作用域内，以便后续使用）
            let avgChargeMonth = 0;
            let avgServiceMonth = 0;
            let avgCostMonth = 0;
            let avgDurationMonth = 0;
            let avgOrdersMonth = 0;
            
            // 声明年度平均值变量（在函数作用域内，以便后续使用）
            let avgChargeYear = 0;
            let avgServiceYear = 0;
            let avgCostYear = 0;
            let avgDurationYear = 0;
            let avgOrdersYear = 0;
            
            let text = '';
            
            // 按日期统计
            text += `1、本期充电电量最大的时间在${maxChargeDay.date}，充电电量为${maxChargeDay.charge.toFixed(2)}度；最小的时间在${minChargeDay.date}，充电电量为${minChargeDay.charge.toFixed(2)}度；<br>`;
            text += `2、本期充电服务费最多的时间在${maxServiceDay.date}，充电服务费为${maxServiceDay.service.toFixed(2)}元；最少的时间在${minServiceDay.date}，充电服务费为${minServiceDay.service.toFixed(2)}元；<br>`;
            text += `3、本期充电费用最多的时间在${maxCostDay.date}，充电费用为${maxCostDay.cost.toFixed(2)}元；最少的时间在${minCostDay.date}，充电费用为${minCostDay.cost.toFixed(2)}元；<br>`;
            text += `4、本期充电时长最多的时间在${maxDurationDay.date}，充电时长为${maxDurationDay.duration.toFixed(2)}分钟；最少的时间在${minDurationDay.date}，充电时长为${minDurationDay.duration.toFixed(2)}分钟；<br>`;
            text += `5、本期充电订单数量最多的时间在${maxOrdersDay.date}，充电订单数量为${maxOrdersDay.orders}笔；最少的时间在${minOrdersDay.date}，充电订单数量为${minOrdersDay.orders}笔；<br>`;
            
            // 如果跨月，添加月度统计
            if (hasCrossMonth) {
                // 按月份分组统计
                const monthlyData = {};
                dataArray.forEach(d => {
                    const monthKey = d.date.substring(0, 7); // yyyy-mm
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            month: monthKey,
                            charge: 0,
                            service: 0,
                            cost: 0,
                            duration: 0,
                            orders: 0,
                            teldaiCharge: 0,
                            teldaiService: 0,
                            teldaiCost: 0,
                            teldaiDuration: 0,
                            teldaiOrders: 0,
                            nengkeCharge: 0,
                            nengkeService: 0,
                            nengkeCost: 0,
                            nengkeDuration: 0,
                            nengkeOrders: 0,
                            didiCharge: 0,
                            didiService: 0,
                            didiCost: 0,
                            didiDuration: 0,
                            didiOrders: 0
                        };
                    }
                    monthlyData[monthKey].charge += d.charge;
                    monthlyData[monthKey].service += d.service;
                    monthlyData[monthKey].cost += d.cost;
                    monthlyData[monthKey].duration += d.duration;
                    monthlyData[monthKey].orders += d.orders;
                    monthlyData[monthKey].teldaiCharge += d.teldaiCharge;
                    monthlyData[monthKey].teldaiService += d.teldaiService;
                    monthlyData[monthKey].teldaiCost += d.teldaiCost;
                    monthlyData[monthKey].teldaiDuration += d.teldaiDuration;
                    monthlyData[monthKey].teldaiOrders += d.teldaiOrders;
                    monthlyData[monthKey].nengkeCharge += d.nengkeCharge;
                    monthlyData[monthKey].nengkeService += d.nengkeService;
                    monthlyData[monthKey].nengkeCost += d.nengkeCost;
                    monthlyData[monthKey].nengkeDuration += d.nengkeDuration;
                    monthlyData[monthKey].nengkeOrders += d.nengkeOrders;
                    monthlyData[monthKey].didiCharge += d.didiCharge;
                    monthlyData[monthKey].didiService += d.didiService;
                    monthlyData[monthKey].didiCost += d.didiCost;
                    monthlyData[monthKey].didiDuration += d.didiDuration;
                    monthlyData[monthKey].didiOrders += d.didiOrders;
                });
                
                const monthlyArray = Object.values(monthlyData);
                const maxChargeMonth = monthlyArray.reduce((max, m) => m.charge > max.charge ? m : max, monthlyArray[0]);
                const minChargeMonth = monthlyArray.reduce((min, m) => m.charge < min.charge ? m : min, monthlyArray[0]);
                const maxServiceMonth = monthlyArray.reduce((max, m) => m.service > max.service ? m : max, monthlyArray[0]);
                const minServiceMonth = monthlyArray.reduce((min, m) => m.service < min.service ? m : min, monthlyArray[0]);
                const maxCostMonth = monthlyArray.reduce((max, m) => m.cost > max.cost ? m : max, monthlyArray[0]);
                const minCostMonth = monthlyArray.reduce((min, m) => m.cost < min.cost ? m : min, monthlyArray[0]);
                const maxDurationMonth = monthlyArray.reduce((max, m) => m.duration > max.duration ? m : max, monthlyArray[0]);
                const minDurationMonth = monthlyArray.reduce((min, m) => m.duration < min.duration ? m : min, monthlyArray[0]);
                const maxOrdersMonth = monthlyArray.reduce((max, m) => m.orders > max.orders ? m : max, monthlyArray[0]);
                const minOrdersMonth = monthlyArray.reduce((min, m) => m.orders < min.orders ? m : min, monthlyArray[0]);
                
                avgChargeMonth = monthlyArray.reduce((sum, m) => sum + m.charge, 0) / monthsDiff;
                avgServiceMonth = monthlyArray.reduce((sum, m) => sum + m.service, 0) / monthsDiff;
                avgCostMonth = monthlyArray.reduce((sum, m) => sum + m.cost, 0) / monthsDiff;
                avgDurationMonth = monthlyArray.reduce((sum, m) => sum + m.duration, 0) / monthsDiff;
                avgOrdersMonth = monthlyArray.reduce((sum, m) => sum + m.orders, 0) / monthsDiff;
                
                text += `6、本期充电电量最大的月份在${maxChargeMonth.month}，充电电量为${maxChargeMonth.charge.toFixed(2)}度；最小的月份在${minChargeMonth.month}，充电电量为${minChargeMonth.charge.toFixed(2)}度；<br>`;
                text += `7、本期充电服务费最多的月份在${maxServiceMonth.month}，充电服务费为${maxServiceMonth.service.toFixed(2)}元；最少的月份在${minServiceMonth.month}，充电服务费为${minServiceMonth.service.toFixed(2)}元；<br>`;
                text += `8、本期充电费用最多的月份在${maxCostMonth.month}，充电费用为${maxCostMonth.cost.toFixed(2)}元；最少的月份在${minCostMonth.month}，充电费用为${minCostMonth.cost.toFixed(2)}元；<br>`;
                text += `9、本期充电时长最多的月份在${maxDurationMonth.month}，充电时长为${maxDurationMonth.duration.toFixed(2)}分钟；最少的月份在${minDurationMonth.month}，充电时长为${minDurationMonth.duration.toFixed(2)}分钟；<br>`;
                text += `10、本期充电订单数量最多的月份在${maxOrdersMonth.month}，充电订单数量为${maxOrdersMonth.orders}笔；最少的月份在${minOrdersMonth.month}，充电订单数量为${minOrdersMonth.orders}笔；<br>`;
            }
            
            // 如果跨年，添加年度统计
            if (hasCrossYear) {
                // 按年份分组统计
                const yearlyData = {};
                dataArray.forEach(d => {
                    const yearKey = d.date.substring(0, 4); // yyyy
                    if (!yearlyData[yearKey]) {
                        yearlyData[yearKey] = {
                            year: yearKey,
                            charge: 0,
                            service: 0,
                            cost: 0,
                            duration: 0,
                            orders: 0,
                            teldaiCharge: 0,
                            teldaiService: 0,
                            teldaiCost: 0,
                            teldaiDuration: 0,
                            teldaiOrders: 0,
                            nengkeCharge: 0,
                            nengkeService: 0,
                            nengkeCost: 0,
                            nengkeDuration: 0,
                            nengkeOrders: 0,
                            didiCharge: 0,
                            didiService: 0,
                            didiCost: 0,
                            didiDuration: 0,
                            didiOrders: 0
                        };
                    }
                    yearlyData[yearKey].charge += d.charge;
                    yearlyData[yearKey].service += d.service;
                    yearlyData[yearKey].cost += d.cost;
                    yearlyData[yearKey].duration += d.duration;
                    yearlyData[yearKey].orders += d.orders;
                    yearlyData[yearKey].teldaiCharge += d.teldaiCharge;
                    yearlyData[yearKey].teldaiService += d.teldaiService;
                    yearlyData[yearKey].teldaiCost += d.teldaiCost;
                    yearlyData[yearKey].teldaiDuration += d.teldaiDuration;
                    yearlyData[yearKey].teldaiOrders += d.teldaiOrders;
                    yearlyData[yearKey].nengkeCharge += d.nengkeCharge;
                    yearlyData[yearKey].nengkeService += d.nengkeService;
                    yearlyData[yearKey].nengkeCost += d.nengkeCost;
                    yearlyData[yearKey].nengkeDuration += d.nengkeDuration;
                    yearlyData[yearKey].nengkeOrders += d.nengkeOrders;
                    yearlyData[yearKey].didiCharge += d.didiCharge;
                    yearlyData[yearKey].didiService += d.didiService;
                    yearlyData[yearKey].didiCost += d.didiCost;
                    yearlyData[yearKey].didiDuration += d.didiDuration;
                    yearlyData[yearKey].didiOrders += d.didiOrders;
                });
                
                const yearlyArray = Object.values(yearlyData);
                const maxChargeYear = yearlyArray.reduce((max, y) => y.charge > max.charge ? y : max, yearlyArray[0]);
                const minChargeYear = yearlyArray.reduce((min, y) => y.charge < min.charge ? y : min, yearlyArray[0]);
                const maxServiceYear = yearlyArray.reduce((max, y) => y.service > max.service ? y : max, yearlyArray[0]);
                const minServiceYear = yearlyArray.reduce((min, y) => y.service < min.service ? y : min, yearlyArray[0]);
                const maxCostYear = yearlyArray.reduce((max, y) => y.cost > max.cost ? y : max, yearlyArray[0]);
                const minCostYear = yearlyArray.reduce((min, y) => y.cost < min.cost ? y : min, yearlyArray[0]);
                const maxDurationYear = yearlyArray.reduce((max, y) => y.duration > max.duration ? y : max, yearlyArray[0]);
                const minDurationYear = yearlyArray.reduce((min, y) => y.duration < min.duration ? y : min, yearlyArray[0]);
                const maxOrdersYear = yearlyArray.reduce((max, y) => y.orders > max.orders ? y : max, yearlyArray[0]);
                const minOrdersYear = yearlyArray.reduce((min, y) => y.orders < min.orders ? y : min, yearlyArray[0]);
                
                avgChargeYear = yearlyArray.reduce((sum, y) => sum + y.charge, 0) / yearsDiff;
                avgServiceYear = yearlyArray.reduce((sum, y) => sum + y.service, 0) / yearsDiff;
                avgCostYear = yearlyArray.reduce((sum, y) => sum + y.cost, 0) / yearsDiff;
                avgDurationYear = yearlyArray.reduce((sum, y) => sum + y.duration, 0) / yearsDiff;
                avgOrdersYear = yearlyArray.reduce((sum, y) => sum + y.orders, 0) / yearsDiff;
                
                text += `11、本期充电电量最大的年份在${maxChargeYear.year}，充电电量为${maxChargeYear.charge.toFixed(2)}度；最小的年份在${minChargeYear.year}，充电电量为${minChargeYear.charge.toFixed(2)}度；<br>`;
                text += `12、本期充电服务费最多的年份在${maxServiceYear.year}，充电服务费为${maxServiceYear.service.toFixed(2)}元；最少的年份在${minServiceYear.year}，充电服务费为${minServiceYear.service.toFixed(2)}元；<br>`;
                text += `13、本期充电费用最多的年份在${maxCostYear.year}，充电费用为${maxCostYear.cost.toFixed(2)}元；最少的年份在${minCostYear.year}，充电费用为${minCostYear.cost.toFixed(2)}元；<br>`;
                text += `14、本期充电时长最多的年份在${maxDurationYear.year}，充电时长为${maxDurationYear.duration.toFixed(2)}分钟；最少的年份在${minDurationYear.year}，充电时长为${minDurationYear.duration.toFixed(2)}分钟；<br>`;
                text += `15、本期充电订单数量最多的年份在${maxOrdersYear.year}，充电订单数量为${maxOrdersYear.orders}笔；最少的年份在${minOrdersYear.year}，充电订单数量为${minOrdersYear.orders}笔；<br>`;
            }
            
            // 计算总计数据
            const totalCharge = dataArray.reduce((sum, d) => sum + d.charge, 0);
            const totalService = dataArray.reduce((sum, d) => sum + d.service, 0);
            const totalCost = dataArray.reduce((sum, d) => sum + d.cost, 0);
            const totalDuration = dataArray.reduce((sum, d) => sum + d.duration, 0);
            const totalOrders = dataArray.reduce((sum, d) => sum + d.orders, 0);
            
            // 添加总计数据
            text += `本期充电电量共${totalCharge.toFixed(2)}度，充电服务费共${totalService.toFixed(2)}元，充电费用共${totalCost.toFixed(2)}元，充电时长共${totalDuration.toFixed(2)}分钟，充电订单数量共${totalOrders}笔。<br>`;
            
            // 添加平均值
            text += `本期日均充电电量为${avgCharge.toFixed(2)}度，日均充电服务费${avgService.toFixed(2)}元，日均充电费用${avgCost.toFixed(2)}元，日均充电时长${avgDuration.toFixed(2)}分钟，日均充电订单数量${avgOrders.toFixed(2)}笔。<br>`;
            
            if (hasCrossMonth) {
                text += `本期月均充电电量为${avgChargeMonth.toFixed(2)}度，月均充电服务费${avgServiceMonth.toFixed(2)}元，月均充电费用${avgCostMonth.toFixed(2)}元，月均充电时长${avgDurationMonth.toFixed(2)}分钟，月均充电订单数量${avgOrdersMonth.toFixed(2)}笔。<br>`;
            }
            
            if (hasCrossYear) {
                text += `本期年均充电电量为${avgChargeYear.toFixed(2)}度，年均充电服务费${avgServiceYear.toFixed(2)}元，年均充电费用${avgCostYear.toFixed(2)}元，年均充电时长${avgDurationYear.toFixed(2)}分钟，年均充电订单数量${avgOrdersYear.toFixed(2)}笔。`;
            }
            
            return text;
        }

        // 渲染BI图表
        function renderBICharts(dataArray, hasCrossMonth, hasCrossYear, statsText) {
            // 计算最大最小10天数据
            const top10Charge = [...dataArray].sort((a, b) => b.charge - a.charge).slice(0, 10);
            const bottom10Charge = [...dataArray].sort((a, b) => a.charge - b.charge).slice(0, 10);
            const top10Service = [...dataArray].sort((a, b) => b.service - a.service).slice(0, 10);
            const bottom10Service = [...dataArray].sort((a, b) => a.service - b.service).slice(0, 10);
            const top10Cost = [...dataArray].sort((a, b) => b.cost - a.cost).slice(0, 10);
            const bottom10Cost = [...dataArray].sort((a, b) => a.cost - b.cost).slice(0, 10);
            const top10Duration = [...dataArray].sort((a, b) => b.duration - a.duration).slice(0, 10);
            const bottom10Duration = [...dataArray].sort((a, b) => a.duration - b.duration).slice(0, 10);
            const top10Orders = [...dataArray].sort((a, b) => b.orders - a.orders).slice(0, 10);
            const bottom10Orders = [...dataArray].sort((a, b) => a.orders - b.orders).slice(0, 10);

            // 恢复图表容器HTML
            const chartsContainer = document.getElementById('bi-charts-container');
            chartsContainer.innerHTML = `
                <!-- 统计描述文字 -->
                <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                    <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                        <i class="fas fa-chart-line"></i> 数据统计描述
                    </h3>
                    <div style="line-height:2; color:#555; font-size:14px;">
                        ${statsText || '暂无统计数据'}
                    </div>
                </div>
                
                <!-- 充电电量图表 -->
                <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                    <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                        <i class="fas fa-bolt"></i> 充电电量分析
                    </h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div>
                            <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最大10天数据</h4>
                            <canvas id="bi-charge-max-chart"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最小10天数据</h4>
                            <canvas id="bi-charge-min-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 充电服务费图表 -->
                <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                    <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                        <i class="fas fa-coins"></i> 充电服务费分析
                    </h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div>
                            <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最大10天数据</h4>
                            <canvas id="bi-service-max-chart"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最小10天数据</h4>
                            <canvas id="bi-service-min-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 充电费用图表 -->
                <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                    <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                        <i class="fas fa-money-bill-wave"></i> 充电费用分析
                    </h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div>
                            <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最大10天数据</h4>
                            <canvas id="bi-cost-max-chart"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最小10天数据</h4>
                            <canvas id="bi-cost-min-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 充电时长图表 -->
                <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                    <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                        <i class="fas fa-clock"></i> 充电时长分析
                    </h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div>
                            <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最大10天数据</h4>
                            <canvas id="bi-duration-max-chart"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最小10天数据</h4>
                            <canvas id="bi-duration-min-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 充电订单数图表 -->
                <div style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                    <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                        <i class="fas fa-list-alt"></i> 充电订单数分析
                    </h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div>
                            <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最大10天数据</h4>
                            <canvas id="bi-orders-max-chart"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom:10px; color:#666; font-size:14px;">最小10天数据</h4>
                            <canvas id="bi-orders-min-chart"></canvas>
                        </div>
                    </div>
                </div>

                ${hasCrossMonth || hasCrossYear ? `
                <!-- 月数据和年数据展示区域 -->
                <div id="bi-month-year-data">
                    ${hasCrossMonth ? `
                    <!-- 月数据图表 -->
                    <div id="bi-month-charts" style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                        <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                            <i class="fas fa-calendar-alt"></i> 月度数据分析
                        </h3>
                        <div>
                            <h4 style="margin-bottom:15px; color:#666; font-size:14px;">月度数据对比</h4>
                            <canvas id="bi-monthly-comparison-chart" style="max-height:500px;"></canvas>
                        </div>
                    </div>
                    ` : ''}
                    ${hasCrossYear ? `
                    <!-- 年数据图表 -->
                    <div id="bi-year-charts" style="margin-bottom:30px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px;">
                        <h3 style="margin-bottom:15px; color:#333; font-size:18px;">
                            <i class="fas fa-calendar-check"></i> 年度数据分析
                        </h3>
                        <div>
                            <canvas id="bi-yearly-combined-chart" style="max-height:500px;"></canvas>
                        </div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            `;

            // 渲染10天数据图表
            renderChart('bi-charge-max-chart', top10Charge, 'charge', '充电电量(度)', 'bar', '#4CAF50');
            renderChart('bi-charge-min-chart', bottom10Charge, 'charge', '充电电量(度)', 'bar', '#FF9800');
            renderChart('bi-service-max-chart', top10Service, 'service', '充电服务费(元)', 'bar', '#2196F3');
            renderChart('bi-service-min-chart', bottom10Service, 'service', '充电服务费(元)', 'bar', '#FF5722');
            renderChart('bi-cost-max-chart', top10Cost, 'cost', '充电费用(元)', 'bar', '#9C27B0');
            renderChart('bi-cost-min-chart', bottom10Cost, 'cost', '充电费用(元)', 'bar', '#F44336');
            renderChart('bi-duration-max-chart', top10Duration, 'duration', '充电时长(分钟)', 'bar', '#00BCD4');
            renderChart('bi-duration-min-chart', bottom10Duration, 'duration', '充电时长(分钟)', 'bar', '#FFC107');
            renderChart('bi-orders-max-chart', top10Orders, 'orders', '充电订单数', 'bar', '#795548');
            renderChart('bi-orders-min-chart', bottom10Orders, 'orders', '充电订单数', 'bar', '#607D8B');

            // 如果跨月或跨年，计算并渲染月数据和年数据
            if (hasCrossMonth || hasCrossYear) {
                // 计算月数据
                const monthlyData = {};
                dataArray.forEach(item => {
                    const date = new Date(item.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            month: monthKey,
                            charge: 0,
                            service: 0,
                            cost: 0,
                            duration: 0,
                            orders: 0
                        };
                    }
                    monthlyData[monthKey].charge += item.charge;
                    monthlyData[monthKey].service += item.service;
                    monthlyData[monthKey].cost += item.cost;
                    monthlyData[monthKey].duration += item.duration;
                    monthlyData[monthKey].orders += item.orders;
                });
                const monthlyArray = Object.values(monthlyData).sort((a, b) => a.month.localeCompare(b.month));

                // 计算年数据
                const yearlyData = {};
                dataArray.forEach(item => {
                    const date = new Date(item.date);
                    const yearKey = String(date.getFullYear());
                    if (!yearlyData[yearKey]) {
                        yearlyData[yearKey] = {
                            year: yearKey,
                            charge: 0,
                            service: 0,
                            cost: 0,
                            duration: 0,
                            orders: 0
                        };
                    }
                    yearlyData[yearKey].charge += item.charge;
                    yearlyData[yearKey].service += item.service;
                    yearlyData[yearKey].cost += item.cost;
                    yearlyData[yearKey].duration += item.duration;
                    yearlyData[yearKey].orders += item.orders;
                });
                const yearlyArray = Object.values(yearlyData).sort((a, b) => a.year.localeCompare(b.year));

                if (hasCrossMonth) {
                    renderMonthlyComparisonChart(monthlyArray);
                }

                if (hasCrossYear) {
                    renderYearlyCombinedChart(yearlyArray);
                }
            }
        }

        // 渲染单个图表
        function renderChart(canvasId, data, field, label, type, color) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            // 销毁已存在的图表实例
            if (canvas.chartInstance) {
                canvas.chartInstance.destroy();
            }

            const labels = data.map(item => {
                if (item.date) return item.date;
                if (item.month) return item.month;
                if (item.year) return item.year;
                return '';
            });
            const values = data.map(item => item[field] || 0);

            const chartConfig = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: values,
                        backgroundColor: type === 'bar' ? color : 'transparent',
                        borderColor: color,
                        borderWidth: 2,
                        fill: type === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: type === 'bar' ? {
                        y: {
                            beginAtZero: true
                        }
                    } : {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };

            canvas.chartInstance = new Chart(ctx, chartConfig);
        }

        // 渲染月度数据对比折线图
        function renderMonthlyComparisonChart(monthlyArray) {
            const canvas = document.getElementById('bi-monthly-comparison-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            // 销毁已存在的图表实例
            if (canvas.chartInstance) {
                canvas.chartInstance.destroy();
            }

            const labels = monthlyArray.map(item => item.month || '');
            
            // 获取四个数据系列
            const chargeData = monthlyArray.map(item => item.charge || 0);
            const serviceData = monthlyArray.map(item => item.service || 0);
            const costData = monthlyArray.map(item => item.cost || 0);
            const ordersData = monthlyArray.map(item => item.orders || 0);

            // 自定义插件：在数据点上方显示数值
            const dataLabelPlugin = {
                id: 'dataLabelPlugin',
                afterDraw: (chart) => {
                    const ctx = chart.ctx;
                    ctx.save();
                    chart.data.datasets.forEach((dataset, datasetIndex) => {
                        const meta = chart.getDatasetMeta(datasetIndex);
                        meta.data.forEach((point, index) => {
                            const value = dataset.data[index];
                            const x = point.x;
                            const y = point.y;
                            ctx.fillStyle = dataset.borderColor;
                            ctx.font = 'bold 10px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            ctx.fillText(value.toFixed(0), x, y - 8);
                        });
                    });
                    ctx.restore();
                }
            };

            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '充电电量(度)',
                            data: chargeData,
                            borderColor: '#00BCD4', // 青色
                            backgroundColor: 'rgba(0, 188, 212, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5], // 虚线
                            pointRadius: 5,
                            pointBackgroundColor: '#00BCD4',
                            pointBorderColor: '#00BCD4',
                            pointBorderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: '充电服务费(元)',
                            data: serviceData,
                            borderColor: '#1976D2', // 深蓝色
                            backgroundColor: 'rgba(25, 118, 210, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5], // 虚线
                            pointRadius: 5,
                            pointBackgroundColor: '#1976D2',
                            pointBorderColor: '#1976D2',
                            pointBorderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: '充电费用(元)',
                            data: costData,
                            borderColor: '#7B1FA2', // 深紫色
                            backgroundColor: 'rgba(123, 31, 162, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5], // 虚线
                            pointRadius: 5,
                            pointBackgroundColor: '#7B1FA2',
                            pointBorderColor: '#7B1FA2',
                            pointBorderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: '充电订单数',
                            data: ordersData,
                            borderColor: '#5D4037', // 深棕色
                            backgroundColor: 'rgba(93, 64, 55, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5], // 虚线
                            pointRadius: 5,
                            pointBackgroundColor: '#5D4037',
                            pointBorderColor: '#5D4037',
                            pointBorderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                plugins: [dataLabelPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 5,
                            hoverRadius: 7
                        }
                    }
                }
            };

            canvas.chartInstance = new Chart(ctx, chartConfig);
        }

        // 渲染年度数据多Y轴混合图
        function renderYearlyCombinedChart(yearlyArray) {
            const canvas = document.getElementById('bi-yearly-combined-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            // 销毁已存在的图表实例
            if (canvas.chartInstance) {
                canvas.chartInstance.destroy();
            }

            const labels = yearlyArray.map(item => item.year || '');
            
            // 获取四个数据系列
            const chargeData = yearlyArray.map(item => item.charge || 0);
            const serviceData = yearlyArray.map(item => item.service || 0);
            const costData = yearlyArray.map(item => item.cost || 0);
            const ordersData = yearlyArray.map(item => item.orders || 0);

            // 自定义插件：在数据点上方显示数值
            const dataLabelPlugin = {
                id: 'dataLabelPlugin',
                afterDraw: (chart) => {
                    const ctx = chart.ctx;
                    ctx.save();
                    chart.data.datasets.forEach((dataset, datasetIndex) => {
                        const meta = chart.getDatasetMeta(datasetIndex);
                        meta.data.forEach((point, index) => {
                            const value = dataset.data[index];
                            const x = point.x;
                            const y = point.y;
                            ctx.fillStyle = dataset.borderColor || dataset.backgroundColor;
                            ctx.font = 'bold 10px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            // 格式化数值显示
                            let displayValue = value;
                            if (value >= 10000) {
                                displayValue = (value / 10000).toFixed(1) + '万';
                            } else {
                                displayValue = value.toFixed(0);
                            }
                            ctx.fillText(displayValue, x, y - 8);
                        });
                    });
                    ctx.restore();
                }
            };

            // 自定义插件：调整Y轴位置避免重叠
            const yAxisPositionPlugin = {
                id: 'yAxisPositionPlugin',
                afterLayout: (chart) => {
                    const scales = chart.scales;
                    if (scales.y1 && scales.y2) {
                        // 调整y2轴的位置，使其在y1轴右侧
                        // 在 Chart.js 4.x 中，直接使用 scale 的宽度属性
                        const y1Width = scales.y1.width || 60;
                        const spacing = 20; // y1 和 y2 之间的间距
                        scales.y2.left = scales.y1.right + spacing;
                        scales.y2.right = scales.y2.left + y1Width;
                    }
                }
            };

            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '充电电量(度)',
                            data: chargeData,
                            type: 'bar',
                            backgroundColor: 'rgba(76, 175, 80, 0.7)',
                            borderColor: '#4CAF50',
                            borderWidth: 2,
                            yAxisID: 'y',
                            order: 1
                        },
                        {
                            label: '充电服务费(元)',
                            data: serviceData,
                            type: 'line',
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#2196F3',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1',
                            order: 0
                        },
                        {
                            label: '充电费用(元)',
                            data: costData,
                            type: 'line',
                            borderColor: '#9C27B0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#9C27B0',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1',
                            order: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: '充电订单数',
                            data: ordersData,
                            type: 'line',
                            borderColor: '#795548',
                            backgroundColor: 'rgba(121, 85, 72, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#795548',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y2',
                            order: 0
                        }
                    ]
                },
                plugins: [dataLabelPlugin, yAxisPositionPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y;
                                    if (value >= 10000) {
                                        label += (value / 10000).toFixed(2) + '万';
                                    } else {
                                        label += value.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            title: {
                                display: true,
                                text: '年份'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '充电电量(度)',
                                color: '#4CAF50',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#4CAF50',
                                callback: function(value) {
                                    if (value >= 10000) {
                                        return (value / 10000).toFixed(1) + '万';
                                    }
                                    return value;
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(76, 175, 80, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '金额(元)',
                                color: '#2196F3',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#2196F3',
                                callback: function(value) {
                                    if (value >= 10000) {
                                        return (value / 10000).toFixed(1) + '万';
                                    }
                                    return value;
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(33, 150, 243, 0.1)'
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '充电订单数',
                                color: '#795548',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#795548',
                                callback: function(value) {
                                    if (value >= 10000) {
                                        return (value / 10000).toFixed(1) + '万';
                                    }
                                    return value;
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                                color: 'rgba(121, 85, 72, 0.1)'
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 6,
                            hoverRadius: 8
                        }
                    }
                }
            };

            canvas.chartInstance = new Chart(ctx, chartConfig);
        }

        // 其它数据页面分页相关变量
        let __otherPagination = {
            enabled: false,
            currentPage: 1,
            pageSize: 20,
            total: 0,
            totalPages: 0,
            data: [],
            categoryLabel: '数据类别',
            selectedOrderType: '未结算订单' // 当前选择的订单类型
        };

        // 其它数据页面查询函数
        async function runOtherDataQuery() {
            const resultContent = document.getElementById('other-query-result-content');
            const conditionsText = document.getElementById('other-current-conditions-text');
            const paginationControls = document.getElementById('other-pagination-controls');
            
            // 隐藏分页控件
            if (paginationControls) {
                paginationControls.style.display = 'none';
            }
            
            // 清空结果
            if (resultContent) {
                resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> 正在查询数据，请稍候...</div>';
            }
            
            // 隐藏汇总统计区域
            const summaryDiv = document.getElementById('other-summary-stats');
            if (summaryDiv) {
                summaryDiv.style.display = 'none';
            }
            
            // 获取查询条件
            const allCheckbox = document.getElementById('other-station-all');
            const stationOptions = Array.from(document.querySelectorAll('#other-station-menu .other-station-option'));
            const selectedStations = allCheckbox && allCheckbox.checked 
                ? ['四方坪站', '高岭站'] 
                : stationOptions.filter(opt => opt.checked).map(opt => opt.value);
            
            const dataCategory = document.getElementById('other-data-category')?.value;
            const sortOrder = document.getElementById('other-sort-order')?.value || '升序';
            const timeField = document.getElementById('other-time-field-select')?.value || '充电结束时间';
            const startTime = document.getElementById('other-start-datetime')?.value;
            const endTime = document.getElementById('other-end-datetime')?.value;
            
            // 验证条件
            if (selectedStations.length === 0) {
                if (resultContent) {
                    resultContent.innerHTML = '<div style="color:#c00; padding:12px;">请至少选择一个电站</div>';
                }
                if (conditionsText) {
                    conditionsText.textContent = '请至少选择一个电站';
                }
                return;
            }
            
            if (!dataCategory) {
                if (resultContent) {
                    resultContent.innerHTML = '<div style="color:#c00; padding:12px;">请选择数据类别</div>';
                }
                if (conditionsText) {
                    conditionsText.textContent = '请选择数据类别';
                }
                return;
            }
            
            if (!startTime || !endTime) {
                if (resultContent) {
                    resultContent.innerHTML = '<div style="color:#c00; padding:12px;">请选择时间范围</div>';
                }
                if (conditionsText) {
                    conditionsText.textContent = '请选择时间范围';
                }
                return;
            }
            
            // 验证时间
            const startDate = new Date(startTime);
            const endDate = new Date(endTime);
            if (endDate < startDate) {
                if (resultContent) {
                    resultContent.innerHTML = '<div style="color:#c00; padding:12px;">结束时间不能小于开始时间</div>';
                }
                if (conditionsText) {
                    conditionsText.textContent = '结束时间不能小于开始时间';
                }
                return;
            }
            
            // 更新当前条件显示
            const stationText = selectedStations.length === 2 ? '全选' : selectedStations.join('、');
            const timeText = `${startTime} 至 ${endTime}`;
            if (conditionsText) {
                conditionsText.textContent = `电站：${stationText} | 数据类别：${dataCategory} | ${timeField}：${timeText} | 排序：${sortOrder}`;
            }
            
            try {
                // 判断是否查询滴滴表：新增的类别只在四方坪站且使用滴滴表
                const didiCategories = ['充电枪ID', '停充原因', '用户类型', '手机号', '车牌号', '滴滴营销费用', '滴滴未结算订单'];
                const isDidiCategory = didiCategories.includes(dataCategory);
                const isDidiBillCategory = dataCategory === '滴滴营销费用';
                const isDidiUnsettledCategory = dataCategory === '滴滴未结算订单';

                // 如果是滴滴类别但不是只选四方坪站，则提示错误
                if (isDidiCategory && !(selectedStations.includes('四方坪站') && !selectedStations.includes('高岭站'))) {
                    if (resultContent) {
                        resultContent.innerHTML = '<div style="color:#c00; padding:12px;">该数据类别仅在选择"四方坪站"时可用</div>';
                    }
                    __otherPagination.enabled = false;
                    renderOtherPagination();
                    return;
                }

                // 格式化时间
                const formattedStartTime = toSqlDateTime(startTime, false);
                const formattedEndTime = toSqlDateTime(endTime, true);

                let sql, dateRangeSql, tableName, timeFieldName, kwhField, elecFeeField, serviceFeeField, totalFeeField;

                // 处理滴滴营销费用查询
                if (isDidiBillCategory) {
                    // 查询滴滴账单表
                    tableName = '[滴滴账单]';
                    timeFieldName = '充电完成时间';

                    // 滴滴账单表中的"充电开始时间"字段格式为：yyyy/mm/dd hh:mm
                    // 需要将格式转换为标准格式进行比较
                    // 使用CASE WHEN ISDATE安全转换，兼容旧版SQL Server
                    // 先查询汇总统计
                    const summarySql = `SELECT
                        SUM(CAST(CASE WHEN ISNUMERIC(ISNULL([总营销费用], '0')) = 1 THEN ISNULL([总营销费用], '0') ELSE '0' END AS FLOAT)) AS [总营销费用],
                        SUM(CAST(CASE WHEN ISNUMERIC(ISNULL([商家承担营销费用], '0')) = 1 THEN ISNULL([商家承担营销费用], '0') ELSE '0' END AS FLOAT)) AS [商家承担营销费用],
                        SUM(CAST(CASE WHEN ISNUMERIC(ISNULL([平台营销补贴], '0')) = 1 THEN ISNULL([平台营销补贴], '0') ELSE '0' END AS FLOAT)) AS [平台营销补贴],
                        SUM(CAST(CASE WHEN ISNUMERIC(ISNULL([支出-合同技术服务费], '0')) = 1 THEN ISNULL([支出-合同技术服务费], '0') ELSE '0' END AS FLOAT)) AS [支出合同技术服务费],
                        SUM(CAST(CASE WHEN ISNUMERIC(ISNULL([平台给司机的营销补贴], '0')) = 1 THEN ISNULL([平台给司机的营销补贴], '0') ELSE '0' END AS FLOAT)) AS [平台给司机的营销补贴],
                        SUM(CAST(CASE WHEN ISNUMERIC(ISNULL([平台给商户的营销补贴], '0')) = 1 THEN ISNULL([平台给商户的营销补贴], '0') ELSE '0' END AS FLOAT)) AS [平台给商户的营销补贴]
                    FROM ${tableName}
                    WHERE [${timeFieldName}] IS NOT NULL
                    AND LEN([${timeFieldName}]) > 0
                    AND CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END IS NOT NULL
                    AND CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END >= '${formattedStartTime}'
                    AND CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END <= '${formattedEndTime}'`;

                    // 查询详细数据 - 添加TOP限制避免数据量过大
                    sql = `SELECT TOP 5000
                        [订单id],
                        [站点名称],
                        [充电开始时间],
                        [充电完成时间],
                        [订单充电量],
                        [实收总金额],
                        [商家承担营销费用],
                        [平台营销补贴],
                        [支出-合同技术服务费],
                        [平台给商户的营销补贴]
                    FROM ${tableName}
                    WHERE [${timeFieldName}] IS NOT NULL
                    AND LEN([${timeFieldName}]) > 0
                    AND CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END IS NOT NULL
                    AND CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END >= '${formattedStartTime}'
                    AND CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END <= '${formattedEndTime}'
                    ORDER BY CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END ${sortOrder === '升序' ? 'ASC' : 'DESC'}`;

                    // 执行汇总查询
                    const summaryResults = await executeLeanCloudSQL(summarySql);
                    const summaryData = summaryResults && summaryResults.length > 0 ? summaryResults[0] : {};
                    
                    // 显示汇总统计
                    const summaryDiv = document.getElementById('other-summary-stats');
                    const summaryContent = document.getElementById('other-summary-stats-content');
                    if (summaryDiv && summaryContent) {
                        summaryDiv.style.display = 'block';
                        summaryContent.innerHTML = `
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div><strong>本期总营销费用：</strong><span style="color: #007bff; font-weight: 600;">${(parseFloat(summaryData['总营销费用'] || 0)).toFixed(2)}</span>元</div>
                                <div style="padding-left: 20px;">
                                    <strong>其中：</strong>
                                    <span>商家承担营销费用：<span style="color: #007bff; font-weight: 600;">${(parseFloat(summaryData['商家承担营销费用'] || 0)).toFixed(2)}</span>元；</span>
                                    <span>平台营销补贴：<span style="color: #007bff; font-weight: 600;">${(parseFloat(summaryData['平台营销补贴'] || 0)).toFixed(2)}</span>元</span>
                                    <span>（平台给司机的营销补贴：<span style="color: #007bff; font-weight: 600;">${(parseFloat(summaryData['平台给司机的营销补贴'] || 0)).toFixed(2)}</span>元；</span>
                                    <span>平台给商户的营销补贴：<span style="color: #007bff; font-weight: 600;">${(parseFloat(summaryData['平台给商户的营销补贴'] || 0)).toFixed(2)}</span>元）</span>
                                </div>
                                <div><strong>本期支出-合同技术服务费：</strong><span style="color: #007bff; font-weight: 600;">${(parseFloat(summaryData['支出合同技术服务费'] || 0)).toFixed(2)}</span>元</div>
                            </div>
                        `;
                    }

                    dateRangeSql = `SELECT
                        MIN(CAST(CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END AS DATE)) AS [最小日期],
                        MAX(CAST(CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END AS DATE)) AS [最大日期]
                    FROM ${tableName}
                    WHERE [${timeFieldName}] IS NOT NULL
                    AND LEN([${timeFieldName}]) > 0
                    AND CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END IS NOT NULL
                    AND CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END >= '${formattedStartTime}'
                    AND CASE WHEN ISDATE(REPLACE([${timeFieldName}], '/', '-') + ':00') = 1 THEN CONVERT(DATETIME, REPLACE([${timeFieldName}], '/', '-') + ':00', 120) ELSE NULL END <= '${formattedEndTime}'`;

                } else if (isDidiUnsettledCategory) {
                    // 查询滴滴未结算订单
                    tableName = '[滴滴]';
                    timeFieldName = '充电完成时间';

                    // 先查询统计信息
                    const statsSql = `SELECT
                        (SELECT COUNT(DISTINCT [订单ID]) FROM [滴滴] WHERE [${timeFieldName}] >= '${formattedStartTime}' AND [${timeFieldName}] <= '${formattedEndTime}') AS [总订单数],
                        (SELECT COUNT(DISTINCT d.[订单ID])
                         FROM [滴滴] d
                         LEFT JOIN [滴滴账单] db ON d.[订单ID] = db.[订单id]
                         WHERE d.[${timeFieldName}] >= '${formattedStartTime}'
                         AND d.[${timeFieldName}] <= '${formattedEndTime}'
                         AND db.[订单id] IS NULL
                         AND CAST(d.[充电量（度）] AS FLOAT) != 0
                         AND CAST(d.[订单总额（元）] AS FLOAT) != 0) AS [未结算订单数],
                        (SELECT CASE
                          WHEN ISNULL(
                            (SELECT COUNT(DISTINCT d.[订单ID])
                             FROM [滴滴] d
                             INNER JOIN [滴滴账单] db ON d.[订单ID] = db.[订单id]
                             WHERE d.[${timeFieldName}] >= '${formattedStartTime}'
                             AND d.[${timeFieldName}] <= '${formattedEndTime}'), 0)
                            >=
                            ISNULL(
                             (SELECT COUNT(DISTINCT db.[订单id])
                              FROM [滴滴账单] db
                              INNER JOIN [滴滴] d ON db.[订单id] = d.[订单ID]
                              WHERE d.[${timeFieldName}] >= '${formattedStartTime}'
                              AND d.[${timeFieldName}] <= '${formattedEndTime}'
                              AND ISNUMERIC(ISNULL(db.[订单充电量], '0')) = 1
                              AND CAST(CASE WHEN ISNUMERIC(ISNULL(db.[订单充电量], '0')) = 1 THEN ISNULL(db.[订单充电量], '0') ELSE '0' END AS FLOAT) = 0
                              AND ISNUMERIC(ISNULL(db.[订单总额], '0')) = 1
                              AND CAST(CASE WHEN ISNUMERIC(ISNULL(db.[订单总额], '0')) = 1 THEN ISNULL(db.[订单总额], '0') ELSE '0' END AS FLOAT) = 0), 0)
                          THEN ISNULL(
                            (SELECT COUNT(DISTINCT d.[订单ID])
                             FROM [滴滴] d
                             INNER JOIN [滴滴账单] db ON d.[订单ID] = db.[订单id]
                             WHERE d.[${timeFieldName}] >= '${formattedStartTime}'
                             AND d.[${timeFieldName}] <= '${formattedEndTime}'), 0)
                            -
                            ISNULL(
                             (SELECT COUNT(DISTINCT db.[订单id])
                              FROM [滴滴账单] db
                              INNER JOIN [滴滴] d ON db.[订单id] = d.[订单ID]
                              WHERE d.[${timeFieldName}] >= '${formattedStartTime}'
                              AND d.[${timeFieldName}] <= '${formattedEndTime}'
                              AND ISNUMERIC(ISNULL(db.[订单充电量], '0')) = 1
                              AND CAST(CASE WHEN ISNUMERIC(ISNULL(db.[订单充电量], '0')) = 1 THEN ISNULL(db.[订单充电量], '0') ELSE '0' END AS FLOAT) = 0
                              AND ISNUMERIC(ISNULL(db.[订单总额], '0')) = 1
                              AND CAST(CASE WHEN ISNUMERIC(ISNULL(db.[订单总额], '0')) = 1 THEN ISNULL(db.[订单总额], '0') ELSE '0' END AS FLOAT) = 0), 0)
                          ELSE 0
                         END) AS [已结算订单数],
                        (SELECT COUNT(DISTINCT [订单ID])
                         FROM [滴滴]
                         WHERE [${timeFieldName}] >= '${formattedStartTime}'
                         AND [${timeFieldName}] <= '${formattedEndTime}'
                         AND CAST([充电量（度）] AS FLOAT) = 0
                         AND CAST([订单总额（元）] AS FLOAT) = 0) AS [异常订单数],
                        (SELECT COUNT(DISTINCT [订单ID])
                         FROM [滴滴]
                         WHERE [${timeFieldName}] >= '${formattedStartTime}'
                         AND [${timeFieldName}] <= '${formattedEndTime}'
                         AND (CAST([充电电费（元）] AS FLOAT) = 0 OR [充电电费（元）] IS NULL OR [充电电费（元）] = '')
                         AND CAST([订单总额（元）] AS FLOAT) != 0) AS [异常订单电费为0数]`;

                    // 使用 UNION ALL 查询所有订单数据（与 l.html 相同的方式）
                    sql = `SELECT
                        d.[订单ID] AS [订单ID],
                        '未结算订单' AS [订单类型],
                        d.[场站名称],
                        d.[开始充电时间],
                        d.[充电完成时间],
                        d.[充电量（度）],
                        d.[订单总额（元）],
                        d.[充电电费（元）],
                        d.[手机号],
                        d.[车牌号]
                    FROM [滴滴] d
                    LEFT JOIN [滴滴账单] db ON d.[订单ID] = db.[订单id]
                    WHERE d.[${timeFieldName}] >= '${formattedStartTime}'
                    AND d.[${timeFieldName}] <= '${formattedEndTime}'
                    AND db.[订单id] IS NULL
                    AND CAST(d.[充电量（度）] AS FLOAT) != 0
                    AND CAST(d.[订单总额（元）] AS FLOAT) != 0

                    UNION ALL

                    SELECT
                        d.[订单ID] AS [订单ID],
                        '已结算订单' AS [订单类型],
                        d.[场站名称],
                        d.[开始充电时间],
                        d.[充电完成时间],
                        d.[充电量（度）],
                        d.[订单总额（元）],
                        d.[充电电费（元）],
                        d.[手机号],
                        d.[车牌号]
                    FROM [滴滴] d
                    INNER JOIN [滴滴账单] db ON d.[订单ID] = db.[订单id]
                    WHERE d.[${timeFieldName}] >= '${formattedStartTime}'
                    AND d.[${timeFieldName}] <= '${formattedEndTime}'
                    AND NOT (
                        ISNUMERIC(ISNULL(db.[订单充电量], '0')) = 1
                        AND CAST(CASE WHEN ISNUMERIC(ISNULL(db.[订单充电量], '0')) = 1 THEN ISNULL(db.[订单充电量], '0') ELSE '0' END AS FLOAT) = 0
                        AND ISNUMERIC(ISNULL(db.[订单总额], '0')) = 1
                        AND CAST(CASE WHEN ISNUMERIC(ISNULL(db.[订单总额], '0')) = 1 THEN ISNULL(db.[订单总额], '0') ELSE '0' END AS FLOAT) = 0
                    )

                    UNION ALL

                    SELECT
                        d.[订单ID] AS [订单ID],
                        '异常订单(不结算）' AS [订单类型],
                        d.[场站名称],
                        d.[开始充电时间],
                        d.[充电完成时间],
                        d.[充电量（度）],
                        d.[订单总额（元）],
                        d.[充电电费（元）],
                        d.[手机号],
                        d.[车牌号]
                    FROM [滴滴] d
                    WHERE d.[${timeFieldName}] >= '${formattedStartTime}'
                    AND d.[${timeFieldName}] <= '${formattedEndTime}'
                    AND CAST(d.[充电量（度）] AS FLOAT) = 0
                    AND CAST(d.[订单总额（元）] AS FLOAT) = 0

                    UNION ALL

                    SELECT
                        d.[订单ID] AS [订单ID],
                        '异常订单(电费为0)' AS [订单类型],
                        d.[场站名称],
                        d.[开始充电时间],
                        d.[充电完成时间],
                        d.[充电量（度）],
                        d.[订单总额（元）],
                        d.[充电电费（元）],
                        d.[手机号],
                        d.[车牌号]
                    FROM [滴滴] d
                    WHERE d.[${timeFieldName}] >= '${formattedStartTime}'
                    AND d.[${timeFieldName}] <= '${formattedEndTime}'
                    AND (CAST(d.[充电电费（元）] AS FLOAT) = 0 OR d.[充电电费（元）] IS NULL OR d.[充电电费（元）] = '')
                    AND CAST(d.[订单总额（元）] AS FLOAT) != 0`;

                    // 执行统计查询
                    const statsResults = await executeLeanCloudSQL(statsSql);
                    const statsData = statsResults && statsResults.length > 0 ? statsResults[0] : {};

                    // 显示汇总统计
                    const summaryDiv = document.getElementById('other-summary-stats');
                    const summaryContent = document.getElementById('other-summary-stats-content');
                    if (summaryDiv && summaryContent) {
                        summaryDiv.style.display = 'block';
                        summaryContent.innerHTML = `
                            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                                <div><strong>本期总订单：</strong><span style="color: #007bff; font-weight: 600;">${parseInt(statsData['总订单数'] || 0)}</span>笔</div>
                                <div><strong>本期未结算订单：</strong><span style="color: #dc3545; font-weight: 600;">${parseInt(statsData['未结算订单数'] || 0)}</span>笔</div>
                                <div><strong>本期已结算订单：</strong><span style="color: #28a745; font-weight: 600;">${parseInt(statsData['已结算订单数'] || 0)}</span>笔</div>
                                <div><strong>本期异常订单(不结算）：</strong><span style="color: #ffc107; font-weight: 600;">${parseInt(statsData['异常订单数'] || 0)}</span>笔</div>
                                <div><strong>本期异常订单(电费为0)：</strong><span style="color: #fd7e14; font-weight: 600;">${parseInt(statsData['异常订单电费为0数'] || 0)}</span>笔</div>
                            </div>
                        `;
                    }

                    dateRangeSql = `SELECT
                        MIN(CAST([${timeFieldName}] AS DATE)) AS [最小日期],
                        MAX(CAST([${timeFieldName}] AS DATE)) AS [最大日期]
                    FROM ${tableName}
                    WHERE [${timeFieldName}] >= '${formattedStartTime}'
                    AND [${timeFieldName}] <= '${formattedEndTime}'`;

                } else if (isDidiCategory) {
                    // 查询滴滴表（原有逻辑）
                    tableName = '[滴滴]';
                    timeFieldName = timeField === '充电开始时间' ? '开始充电时间' : '充电完成时间';

                    // 滴滴表的字段映射
                    kwhField = '[充电量（度）]';
                    elecFeeField = '[充电电费（元）]';
                    serviceFeeField = '[充电服务费（元）]';
                    totalFeeField = '[订单总额（元）]';

                    // 滴滴表的类别字段映射
                    const didiFieldMap = {
                        '充电枪ID': '[充电枪ID]',
                        '停充原因': '[停充原因]',
                        '用户类型': '[用户类型]',
                        '手机号': '[手机号]',
                        '车牌号': '[车牌号]'
                    };

                    const categoryField = didiFieldMap[dataCategory];

                    // 先查询日期范围
                    dateRangeSql = `SELECT
                        MIN(CAST([${timeFieldName}] AS DATE)) AS [最小日期],
                        MAX(CAST([${timeFieldName}] AS DATE)) AS [最大日期]
                    FROM ${tableName}
                    WHERE [${timeFieldName}] >= '${formattedStartTime}'
                    AND [${timeFieldName}] <= '${formattedEndTime}'`;

                    // 构建排序
                    const orderBy = sortOrder === '升序' ? 'ASC' : 'DESC';

                    // 构建查询SQL
                    sql = `SELECT
                        ${categoryField} AS [数据类别],
                        SUM(CAST(${kwhField} AS FLOAT)) AS [充电电量(度)],
                        SUM(CAST(${elecFeeField} AS FLOAT)) AS [充电电费(元)],
                        SUM(CAST(${serviceFeeField} AS FLOAT)) AS [充电服务费(元)],
                        SUM(CAST(${totalFeeField} AS FLOAT)) AS [充电费用(元)]
                    FROM ${tableName}
                    WHERE [${timeFieldName}] >= '${formattedStartTime}'
                    AND [${timeFieldName}] <= '${formattedEndTime}'
                    GROUP BY ${categoryField}
                    ORDER BY SUM(CAST(${kwhField} AS FLOAT)) ${orderBy}`;

                    // 隐藏汇总统计
                    const summaryDiv = document.getElementById('other-summary-stats');
                    if (summaryDiv) {
                        summaryDiv.style.display = 'none';
                    }

                } else {
                    // 查询特来电表（原有逻辑）
                    tableName = '[特来电]';
                    timeFieldName = timeField;
                    kwhField = '[充电电量(度)]';
                    elecFeeField = '[充电电费(元)]';
                    serviceFeeField = '[充电服务费(元)]';
                    totalFeeField = '[充电费用(元)]';

                    // 构建电站条件
                    let stationCondition = '';
                    if (selectedStations.length === 2) {
                        // 全选，不添加条件
                        stationCondition = '';
                    } else if (selectedStations.includes('四方坪站') && !selectedStations.includes('高岭站')) {
                        // 只选四方坪站
                        stationCondition = "AND [电站名称] NOT LIKE N'%华为飞狐特来电高岭超充站%' AND [电站名称] NOT LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%'";
                    } else if (selectedStations.includes('高岭站') && !selectedStations.includes('四方坪站')) {
                        // 只选高岭站
                        stationCondition = "AND ([电站名称] LIKE N'%华为飞狐特来电高岭超充站%' OR [电站名称] LIKE N'%长沙市开福区高岭香江国际城充电站建设项目%')";
                    }

                    // 构建字段名（特殊处理终端名称）
                    let groupByField = `[${dataCategory}]`;
                    let selectField = `[${dataCategory}]`;
                    if (dataCategory === '终端名称') {
                        // 终端名称需要显示电站名称&终端名称
                        selectField = `[电站名称] + N'&' + [终端名称]`;
                        groupByField = `[电站名称], [终端名称]`;
                    }

                    // 构建排序
                    const orderBy = sortOrder === '升序' ? 'ASC' : 'DESC';

                    // 先查询充电结束时间的最大和最小日期，用于计算天数
                    dateRangeSql = `SELECT
                        MIN(CAST([充电结束时间] AS DATE)) AS [最小日期],
                        MAX(CAST([充电结束时间] AS DATE)) AS [最大日期]
                    FROM ${tableName}
                    WHERE [${timeFieldName}] >= '${formattedStartTime}'
                    AND [${timeFieldName}] <= '${formattedEndTime}'
                    ${stationCondition}`;

                    // 构建SQL查询
                    sql = `SELECT
                        ${selectField} AS [数据类别],
                        SUM(CAST(${kwhField} AS FLOAT)) AS [充电电量(度)],
                        SUM(CAST(${elecFeeField} AS FLOAT)) AS [充电电费(元)],
                        SUM(CAST(${serviceFeeField} AS FLOAT)) AS [充电服务费(元)],
                        SUM(CAST(${totalFeeField} AS FLOAT)) AS [充电费用(元)]
                    FROM ${tableName}
                    WHERE [${timeFieldName}] >= '${formattedStartTime}'
                    AND [${timeFieldName}] <= '${formattedEndTime}'
                    ${stationCondition}
                    GROUP BY ${groupByField}
                    ORDER BY SUM(CAST(${kwhField} AS FLOAT)) ${orderBy}`;
                }

                // 查询日期范围以计算天数（仅对需要计算天数的查询）
                let days = 1; // 默认天数为1
                if (!isDidiBillCategory && !isDidiUnsettledCategory && dateRangeSql) {
                    const dateRangeResults = await executeLeanCloudSQL(dateRangeSql);
                if (dateRangeResults && dateRangeResults.length > 0) {
                    const minDate = dateRangeResults[0]['最小日期'];
                    const maxDate = dateRangeResults[0]['最大日期'];
                    if (minDate && maxDate) {
                        const min = new Date(minDate);
                        const max = new Date(maxDate);
                        // 计算天数差（包含首尾两天）
                        days = Math.max(1, Math.ceil((max - min) / (1000 * 60 * 60 * 24)) + 1);
                        }
                    }
                }

                // 执行查询
                let results;

                if (sql) {
                    console.log('开始执行表格数据查询，SQL长度:', sql ? sql.length : 0);
                    console.log('查询类型:', isDidiBillCategory ? '滴滴营销费用' : (isDidiUnsettledCategory ? '滴滴订单汇总' : '其他'));

                    try {
                        results = await executeLeanCloudSQL(sql);
                        console.log('表格数据查询成功，返回记录数:', results ? results.length : 0);

                        // 如果返回了5000条记录，提示用户可能有更多数据
                        if (results && results.length === 5000) {
                            const warningDiv = document.createElement('div');
                            warningDiv.style.cssText = 'margin-bottom:12px; padding:10px; background:#fff3cd; border:1px solid #ffc107; border-radius:6px; color:#856404;';
                            warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 查询结果已达到5000条上限，可能还有更多数据未显示。建议缩小时间范围以查看完整数据。';
                            if (resultContent && resultContent.parentNode) {
                                resultContent.parentNode.insertBefore(warningDiv, resultContent);
                            }
                        }
                    } catch (err) {
                        console.error('表格数据查询失败:', err);
                        let errorMsg = '查询失败';
                        if (err.message) {
                            if (err.message.includes('406') || err.message.includes('Not Acceptable')) {
                                errorMsg = '数据量过大，请缩小时间范围后重试';
                            } else if (err.message.includes('CORS') || err.message.includes('Failed to fetch')) {
                                errorMsg = '网络请求失败。请通过HTTP服务器访问页面（不要直接打开HTML文件），或者缩小时间范围重试';
                            } else if (err.message.includes('timeout')) {
                                errorMsg = '查询超时，请缩小时间范围后重试';
                            } else {
                                errorMsg = '查询失败: ' + err.message;
                            }
                        }
                        if (resultContent) {
                            resultContent.innerHTML = '<div style="color:#dc3545; padding:12px; background:#fff3cd; border:1px solid #ffc107; border-radius:6px;"><i class="fas fa-exclamation-triangle"></i> ' + errorMsg + '</div>';
                        }
                        __otherPagination.enabled = false;
                        __otherPagination.data = [];
                        __otherPagination.total = 0;
                        renderOtherPagination();
                        return;
                    }
                } else {
                    console.error('SQL为空');
                    if (resultContent) {
                        resultContent.innerHTML = '<div style="color:#c00; padding:12px;">查询配置错误</div>';
                    }
                    return;
                }

                if (!results || results.length === 0) {
                    if (resultContent) {
                        resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">未查询到数据</div>';
                    }
                    // 隐藏汇总统计区域
                    const summaryDiv = document.getElementById('other-summary-stats');
                    if (summaryDiv) {
                        summaryDiv.style.display = 'none';
                    }
                    __otherPagination.enabled = false;
                    __otherPagination.data = [];
                    __otherPagination.total = 0;
                    renderOtherPagination();
                    return;
                }
                
                // 处理数据
                let processedData;
                if (isDidiBillCategory) {
                    // 滴滴营销费用：直接使用查询结果
                    processedData = results.map(row => ({
                        '订单id': row['订单id'] || '',
                        '站点名称': row['站点名称'] || '',
                        '充电开始时间': row['充电开始时间'] || '',
                        '充电完成时间': row['充电完成时间'] || '',
                        '订单充电量': row['订单充电量'] || '',
                        '实收总金额': row['实收总金额'] || '',
                        '商家承担营销费用': row['商家承担营销费用'] || '',
                        '平台营销补贴': row['平台营销补贴'] || '',
                        '支出-合同技术服务费': row['支出-合同技术服务费'] || '',
                        '平台给商户的营销补贴': row['平台给商户的营销补贴'] || ''
                    }));
                } else if (isDidiUnsettledCategory) {
                    // 滴滴未结算订单：保留订单类型字段
                    processedData = results.map(row => ({
                        '订单ID': row['订单ID'] || '',
                        '订单类型': row['订单类型'] || '',
                        '场站名称': row['场站名称'] || '',
                        '开始充电时间': row['开始充电时间'] || '',
                        '充电完成时间': row['充电完成时间'] || '',
                        '充电量（度）': row['充电量（度）'] || '',
                        '订单总额（元）': row['订单总额（元）'] || '',
                        '充电电费（元）': row['充电电费（元）'] || '',
                        '手机号': row['手机号'] || '',
                        '车牌号': row['车牌号'] || ''
                    }));
                } else {
                    // 原有逻辑：处理数据（确保数值字段正确，并计算日均值）
                    processedData = results.map(row => {
                    const kwh = parseFloat(row['充电电量(度)'] || 0);
                    const serviceFee = parseFloat(row['充电服务费(元)'] || 0);
                    const dailyKwh = days > 0 ? (kwh / days).toFixed(2) : '0.00';
                    const dailyServiceFee = days > 0 ? (serviceFee / days).toFixed(2) : '0.00';
                    
                    return {
                        '数据类别': row['数据类别'] || '',
                        '充电电量(度)': kwh.toFixed(2),
                        '日均充电电量(度)': dailyKwh,
                        '充电电费(元)': parseFloat(row['充电电费(元)'] || 0).toFixed(2),
                        '充电服务费(元)': serviceFee.toFixed(2),
                        '日均充电服务费(元)': dailyServiceFee,
                        '充电费用(元)': parseFloat(row['充电费用(元)'] || 0).toFixed(2)
                    };
                });
                }
                
                // 设置分页数据
                __otherPagination.enabled = true;
                __otherPagination.data = processedData;
                __otherPagination.total = processedData.length;
                __otherPagination.totalPages = Math.ceil(processedData.length / __otherPagination.pageSize);
                __otherPagination.currentPage = 1;
                __otherPagination.categoryLabel = dataCategory || '数据类别';
                // 如果是滴滴未结算订单，初始化订单类型选择
                if (isDidiUnsettledCategory) {
                    __otherPagination.selectedOrderType = '未结算订单';
                }
                
                // 渲染分页和表格
                renderOtherPagination();
                renderOtherDataTable();
                
            } catch (error) {
                console.error('查询其它数据失败:', error);
                if (resultContent) {
                    resultContent.innerHTML = `<div style="color:#c00; padding:12px;">查询失败：${error.message || '未知错误'}</div>`;
                }
                // 隐藏汇总统计区域
                const summaryDiv = document.getElementById('other-summary-stats');
                if (summaryDiv) {
                    summaryDiv.style.display = 'none';
                }
                __otherPagination.enabled = false;
                renderOtherPagination();
            }
        }

        // 渲染其它数据表格
        function renderOtherDataTable() {
            const resultContent = document.getElementById('other-query-result-content');
            if (!resultContent || !__otherPagination.enabled) return;
            
            const categoryLabel = __otherPagination.categoryLabel || '数据类别';
            
            // 对于滴滴未结算订单，使用特殊的过滤和分页逻辑
            if (categoryLabel === '滴滴未结算订单') {
                const selectedOrderType = __otherPagination.selectedOrderType || '未结算订单';
                
                // 过滤数据：根据选择的订单类型
                const filteredData = __otherPagination.data.filter(row => row['订单类型'] === selectedOrderType);
                
                // 先添加下拉框选择器（始终显示）
                let html = '<div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">';
                html += '<label style="font-weight: 600; color: #333;">订单类型筛选：</label>';
                html += '<select id="didi-order-type-selector" onchange="filterDidiOrderType()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; min-width: 200px;">';
                html += `<option value="未结算订单" ${selectedOrderType === '未结算订单' ? 'selected' : ''}>未结算订单</option>`;
                html += `<option value="已结算订单" ${selectedOrderType === '已结算订单' ? 'selected' : ''}>已结算订单</option>`;
                html += `<option value="异常订单(不结算）" ${selectedOrderType === '异常订单(不结算）' ? 'selected' : ''}>异常订单(不结算）</option>`;
                html += `<option value="异常订单(电费为0)" ${selectedOrderType === '异常订单(电费为0)' ? 'selected' : ''}>异常订单(电费为0)</option>`;
                html += '</select>';
                html += `<span style="color: #666; font-size: 13px;">共 ${filteredData.length} 条记录</span>`;
                html += '</div>';
                
                // 如果没有数据，显示"暂无数据"提示
                if (filteredData.length === 0) {
                    html += '<div style="padding:20px; text-align:center; color:#666;">暂无数据</div>';
                    resultContent.innerHTML = html;
                    // 更新分页信息
                    __otherPagination.total = 0;
                    __otherPagination.totalPages = 0;
                    renderOtherPagination();
                    return;
                }
                
                const filteredStart = (__otherPagination.currentPage - 1) * __otherPagination.pageSize;
                const filteredEnd = filteredStart + __otherPagination.pageSize;
                const filteredPageData = filteredData.slice(filteredStart, filteredEnd);
                
                // 更新分页信息
                __otherPagination.total = filteredData.length;
                __otherPagination.totalPages = Math.ceil(filteredData.length / __otherPagination.pageSize);
                
                // 添加表格
                html += '<table style="width:100%; border-collapse:collapse; font-size:14px;">';
                html += '<thead><tr style="background:#f8f9fa;">';
                html += `<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">${selectedOrderType}</th>`;
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">场站名称</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">开始充电时间</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">充电完成时间</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">充电量（度）</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">订单总额（元）</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">手机号</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">车牌号</th>';
                html += '</tr></thead><tbody>';
                
                filteredPageData.forEach((row, index) => {
                    const bgColor = index % 2 === 0 ? '#fff' : '#f8f9fa';
                    html += `<tr style="background:${bgColor};">`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['订单ID'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['场站名称'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['开始充电时间'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['充电完成时间'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['充电量（度）'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['订单总额（元）'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['手机号'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['车牌号'] || ''}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                resultContent.innerHTML = html;
                renderOtherPagination();
                return;
            }
            
            // 其他类别的原有逻辑
            const start = (__otherPagination.currentPage - 1) * __otherPagination.pageSize;
            const end = start + __otherPagination.pageSize;
            const pageData = __otherPagination.data.slice(start, end);
            
            if (pageData.length === 0) {
                resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">暂无数据</div>';
                return;
            }
            
            let html = '<table style="width:100%; border-collapse:collapse; font-size:14px;">';
            
            // 根据类别显示不同的表格结构
            if (categoryLabel === '滴滴营销费用') {
                // 滴滴营销费用表格
                html += '<thead><tr style="background:#f8f9fa;">';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">订单id</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">站点名称</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">充电开始时间</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">充电完成时间</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">订单充电量</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">实收总金额</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">商家承担营销费用</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">平台营销补贴</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">支出-合同技术服务费</th>';
                html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">平台给商户的营销补贴</th>';
                html += '</tr></thead><tbody>';
                
                pageData.forEach((row, index) => {
                    const bgColor = index % 2 === 0 ? '#fff' : '#f8f9fa';
                    html += `<tr style="background:${bgColor};">`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['订单id'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['站点名称'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['充电开始时间'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['充电完成时间'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['订单充电量'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['实收总金额'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['商家承担营销费用'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['平台营销补贴'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['支出-合同技术服务费'] || ''}</td>`;
                    html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['平台给商户的营销补贴'] || ''}</td>`;
                    html += '</tr>';
                });
                
            } else {
                // 原有逻辑：计算所有数据的总电量（用于计算占比）
            const totalKwh = __otherPagination.data.reduce((sum, row) => {
                const kwh = parseFloat(row['充电电量(度)'] || 0);
                return sum + kwh;
            }, 0);

            html += '<thead><tr style="background:#f8f9fa;">';
            html += `<th style="padding:12px; border:1px solid #dee2e6; text-align:left; font-weight:600;">${categoryLabel}</th>`;
            html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">充电电量(度)</th>';
            html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">占比</th>';
            html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">日均充电电量(度)</th>';
            html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">充电电费(元)</th>';
            html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">充电服务费(元)</th>';
            html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">日均充电服务费(元)</th>';
            html += '<th style="padding:12px; border:1px solid #dee2e6; text-align:right; font-weight:600;">充电费用(元)</th>';
            html += '</tr></thead><tbody>';
            
            pageData.forEach((row, index) => {
                const bgColor = index % 2 === 0 ? '#fff' : '#f8f9fa';
                const kwh = parseFloat(row['充电电量(度)'] || 0);
                // 计算占比（百分比）
                const percentage = totalKwh > 0 ? ((kwh / totalKwh) * 100).toFixed(2) : '0.00';
                
                html += `<tr style="background:${bgColor};">`;
                html += `<td style="padding:12px; border:1px solid #dee2e6;">${row['数据类别'] || ''}</td>`;
                html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['充电电量(度)'] || '0.00'}</td>`;
                html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${percentage}%</td>`;
                html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['日均充电电量(度)'] || '0.00'}</td>`;
                html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['充电电费(元)'] || '0.00'}</td>`;
                html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['充电服务费(元)'] || '0.00'}</td>`;
                html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['日均充电服务费(元)'] || '0.00'}</td>`;
                html += `<td style="padding:12px; border:1px solid #dee2e6; text-align:right;">${row['充电费用(元)'] || '0.00'}</td>`;
                html += '</tr>';
            });
            }
            
            html += '</tbody></table>';
            resultContent.innerHTML = html;
        }

        // 处理滴滴订单类型下拉框切换
        function filterDidiOrderType() {
            const selector = document.getElementById('didi-order-type-selector');
            if (!selector) return;
            
            const selectedType = selector.value;
            __otherPagination.selectedOrderType = selectedType;
            __otherPagination.currentPage = 1; // 重置到第一页
            
            // 重新渲染表格和分页
            renderOtherDataTable();
            renderOtherPagination();
        }

        // 渲染其它数据分页按钮
        function renderOtherPagination() {
            const paginationDiv = document.getElementById('other-pagination-buttons');
            const paginationControls = document.getElementById('other-pagination-controls');
            if (!paginationDiv || !paginationControls) return;
            
            if (!__otherPagination.enabled || __otherPagination.totalPages <= 1) {
                paginationDiv.innerHTML = '';
                paginationControls.style.display = 'none';
                return;
            }
            
            // 显示分页控件
            paginationControls.style.display = 'flex';
            
            const current = __otherPagination.currentPage;
            const total = __otherPagination.totalPages;
            
            let html = '';
            
            // 首页按钮
            if (current > 1) {
                html += `<button onclick="goToOtherPage(1)" style="background:#007bff; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-right:4px;">首页</button>`;
            } else {
                html += `<button disabled style="background:#ccc; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:not-allowed; margin-right:4px;">首页</button>`;
            }
            
            // 上一页按钮
            if (current > 1) {
                html += `<button onclick="goToOtherPage(${current - 1})" style="background:#007bff; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-right:4px;">上一页</button>`;
            } else {
                html += `<button disabled style="background:#ccc; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:not-allowed; margin-right:4px;">上一页</button>`;
            }
            
            // 当前页/共x页显示
            html += `<span style="margin:0 12px; color:#666; font-size:14px;">当前${current}页/共${total}页</span>`;
            
            // 下一页按钮
            if (current < total) {
                html += `<button onclick="goToOtherPage(${current + 1})" style="background:#007bff; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-right:4px;">下一页</button>`;
            } else {
                html += `<button disabled style="background:#ccc; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:not-allowed; margin-right:4px;">下一页</button>`;
            }
            
            // 末页按钮
            if (current < total) {
                html += `<button onclick="goToOtherPage(${total})" style="background:#007bff; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">末页</button>`;
            } else {
                html += `<button disabled style="background:#ccc; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:not-allowed;">末页</button>`;
            }
            
            paginationDiv.innerHTML = html;
        }

        // 跳转到其它数据指定页
        function goToOtherPage(page) {
            if (!__otherPagination.enabled || page < 1 || page > __otherPagination.totalPages) return;
            __otherPagination.currentPage = page;
            renderOtherPagination();
            renderOtherDataTable();
        }

        // 导出其它数据当前页
        function exportOtherDataCurrentPage() {
            if (!__otherPagination.enabled || __otherPagination.data.length === 0) return;
            
            const start = (__otherPagination.currentPage - 1) * __otherPagination.pageSize;
            const end = start + __otherPagination.pageSize;
            const pageData = __otherPagination.data.slice(start, end);
            
            exportOtherDataToExcel(pageData, '当前页');
        }

        // 导出其它数据全部
        function exportOtherDataAll() {
            if (!__otherPagination.enabled || __otherPagination.data.length === 0) return;
            exportOtherDataToExcel(__otherPagination.data, '全部');
        }

        // 导出其它数据到Excel
        function exportOtherDataToExcel(data, type) {
            if (!data || data.length === 0) return;
            
            // 获取查询条件用于文件名
            const allCheckbox = document.getElementById('other-station-all');
            const stationOptions = Array.from(document.querySelectorAll('#other-station-menu .other-station-option'));
            const selectedStations = allCheckbox && allCheckbox.checked 
                ? ['四方坪站', '高岭站'] 
                : stationOptions.filter(opt => opt.checked).map(opt => opt.value);
            const dataCategory = document.getElementById('other-data-category')?.value || '数据类别';
            const startTime = document.getElementById('other-start-datetime')?.value || '';
            const endTime = document.getElementById('other-end-datetime')?.value || '';
            const categoryLabel = __otherPagination.categoryLabel || dataCategory || '数据类别';
            
            // 计算所有数据的总电量（用于计算占比）
            const totalKwh = data.reduce((sum, row) => {
                const kwh = parseFloat(row['充电电量(度)'] || 0);
                return sum + kwh;
            }, 0);
            
            // 准备Excel数据
            const headers = [categoryLabel, '充电电量(度)', '占比', '日均充电电量(度)', '充电电费(元)', '充电服务费(元)', '日均充电服务费(元)', '充电费用(元)'];
            const rows = data.map(row => {
                const kwh = parseFloat(row['充电电量(度)'] || 0);
                const percentage = totalKwh > 0 ? ((kwh / totalKwh) * 100).toFixed(2) : '0.00';
                return [
                    row['数据类别'] || '',
                    row['充电电量(度)'] || '0.00',
                    percentage + '%',
                    row['日均充电电量(度)'] || '0.00',
                    row['充电电费(元)'] || '0.00',
                    row['充电服务费(元)'] || '0.00',
                    row['日均充电服务费(元)'] || '0.00',
                    row['充电费用(元)'] || '0.00'
                ];
            });
            
            const excelData = [headers, ...rows];
            
            // 生成文件名
            const stationName = selectedStations.length === 2 ? '全站' : selectedStations.join('和');
            const timeStr = startTime && endTime ? `${startTime.split(' ')[0]}_${endTime.split(' ')[0]}` : '';
            const fileName = `其它数据_${dataCategory}_${stationName}_${type}_${timeStr || '数据'}.xlsx`;
            
            // 创建工作簿和工作表
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // 设置列宽
            const colWidths = headers.map((header, index) => {
                // 数据类别列需要更宽
                if (index === 0) return { wch: 30 };
                // 占比列可以稍窄
                if (index === 2) return { wch: 12 };
                // 日均列可以稍窄
                if (index === 3 || index === 6) return { wch: 18 };
                return { wch: 18 };
            });
            ws['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(wb, ws, '其它数据');
            XLSX.writeFile(wb, fileName);
        }

        // 滴滴订单汇总分页加载函数（类似充电数据页面的 loadSimpleMergedPage）
        async function loadDidiUnsettledPage(page) {
            const resultContent = document.getElementById('other-query-result-content');
            if (!resultContent) {
                return Promise.resolve();
            }

            if (!__otherPagination.isDidiUnsettled) {
                return Promise.resolve();
            }

            // 显示加载提示
            resultContent.innerHTML = '<div style="padding:20px; text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> 正在加载第 ' + page + ' 页数据...</div>';

            const pageSize = __otherPagination.pageSize;
            const offset = (page - 1) * pageSize;
            const startRn = offset + 1;
            const endRn = offset + pageSize;

            const timeFieldName = __otherPagination.timeFieldName;
            const formattedStartTime = __otherPagination.formattedStartTime;
            const formattedEndTime = __otherPagination.formattedEndTime;
            const sortOrder = __otherPagination.sortOrder;
            const selectedOrderType = __otherPagination.selectedOrderType || '未结算订单';

            try {
                let sql = '';

                // 根据选择的订单类型构建查询
                if (selectedOrderType === '未结算订单') {
                    sql = `SELECT [订单ID], '未结算订单' AS [订单类型], [场站名称], [开始充电时间], [充电完成时间], [充电量（度）], [订单总额（元）], [充电电费（元）], [手机号], [车牌号]
                        FROM (SELECT ROW_NUMBER() OVER (ORDER BY [开始充电时间] ${sortOrder === '升序' ? 'ASC' : 'DESC'}) AS rn, *
                        FROM [滴滴]
                        WHERE [订单ID] NOT IN (SELECT [订单id] FROM [滴滴账单])
                        AND [${timeFieldName}] >= '${formattedStartTime}'
                        AND [${timeFieldName}] <= '${formattedEndTime}'
                        AND CAST([充电量（度）] AS FLOAT) != 0
                        AND CAST([订单总额（元）] AS FLOAT) != 0) t
                        WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                } else if (selectedOrderType === '已结算订单') {
                    sql = `SELECT d.[订单ID], '已结算订单' AS [订单类型], d.[场站名称], d.[开始充电时间], d.[充电完成时间], d.[充电量（度）], d.[订单总额（元）], d.[充电电费（元）], d.[手机号], d.[车牌号]
                        FROM (SELECT ROW_NUMBER() OVER (ORDER BY d.[开始充电时间] ${sortOrder === '升序' ? 'ASC' : 'DESC'}) AS rn, d.*
                        FROM [滴滴] d
                        WHERE d.[订单ID] IN (SELECT [订单id] FROM [滴滴账单])
                        AND d.[${timeFieldName}] >= '${formattedStartTime}'
                        AND d.[${timeFieldName}] <= '${formattedEndTime}') t
                        WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                } else if (selectedOrderType === '异常订单(不结算）') {
                    sql = `SELECT [订单ID], '异常订单(不结算）' AS [订单类型], [场站名称], [开始充电时间], [充电完成时间], [充电量（度）], [订单总额（元）], [充电电费（元）], [手机号], [车牌号]
                        FROM (SELECT ROW_NUMBER() OVER (ORDER BY [开始充电时间] ${sortOrder === '升序' ? 'ASC' : 'DESC'}) AS rn, *
                        FROM [滴滴]
                        WHERE [${timeFieldName}] >= '${formattedStartTime}'
                        AND [${timeFieldName}] <= '${formattedEndTime}'
                        AND CAST([充电量（度）] AS FLOAT) = 0
                        AND CAST([订单总额（元）] AS FLOAT) = 0) t
                        WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                } else if (selectedOrderType === '异常订单(电费为0)') {
                    sql = `SELECT [订单ID], '异常订单(电费为0)' AS [订单类型], [场站名称], [开始充电时间], [充电完成时间], [充电量（度）], [订单总额（元）], [充电电费（元）], [手机号], [车牌号]
                        FROM (SELECT ROW_NUMBER() OVER (ORDER BY [开始充电时间] ${sortOrder === '升序' ? 'ASC' : 'DESC'}) AS rn, *
                        FROM [滴滴]
                        WHERE [${timeFieldName}] >= '${formattedStartTime}'
                        AND [${timeFieldName}] <= '${formattedEndTime}'
                        AND (CAST([充电电费（元）] AS FLOAT) = 0 OR [充电电费（元）] IS NULL OR [充电电费（元）] = '')
                        AND CAST([订单总额（元）] AS FLOAT) != 0) t
                        WHERE t.rn BETWEEN ${startRn} AND ${endRn}`;
                }

                console.log('滴滴订单汇总分页查询 SQL:', sql.substring(0, 200) + '...');

                // 使用 callSqlWithRetry 而不是 executeLeanCloudSQL，因为它更可靠
                const result = await callSqlWithRetry(sql, 3, 600);

                let pageData = [];
                if (result && result.results) {
                    pageData = result.results.map(row => {
                        const { rn, ...rest } = row;
                        return rest;
                    });
                }

                console.log('滴滴订单汇总分页查询返回记录数:', pageData.length);

                // 更新分页数据（只保存当前页）
                __otherPagination.data = pageData;
                __otherPagination.currentPage = page;

                // 渲染表格
                renderOtherDataTable();

                return Promise.resolve();

            } catch (err) {
                console.error('滴滴订单汇总分页查询失败:', err);
                resultContent.innerHTML = '<div style="color:#c00; padding:12px;">加载数据失败：' + err.message + '</div>';
                return Promise.reject(err);
            }
        }

    </script>

    <!-- 版权信息已移除 -->
</body>
</html>