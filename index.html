<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>长沙飞狐智能数据平台</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary: #1a73e8;
            --secondary: #0d47a1;
            --accent: #00c853;
            --dark: #0a1929;
            --light: #f5f9ff;
            --gray: #e0e0e0;
            --card-bg: rgba(255, 255, 255, 0.85);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark), #102a43);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://www.csfhcdz.cn/photo/1.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.3;
            z-index: -1;
        }
        
        /* 添加头部标题样式 */
        .header-title {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .header-logo {
            height: 35px; /* 调整图片大小与文字一致 */
            vertical-align: middle;
             margin-top: 40px; /* 添加与文字相同的上边距 */
        }
        
       .header-text {
    color: white;
    font-size: 35px; /* 增大字体 */
    font-weight: bold; /* 这里修改字体粗细 */
    font-family: "SimSun", serif; /* 宋体 */
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    margin: 0;
    vertical-align: middle;
    letter-spacing: 2px; /* 添加字符间距 */
    margin-top: 40px;   /* 或者: margin-bottom: 10px; 会使文字向上移动 */
}
        
        /* 修改底部版权信息样式 */
        .footer-copyright {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 15px 0;
            color: white;
            font-size: 14px;
            z-index: 1001;
            background: transparent; /* 移除背景 */
        }
        
        /* 调整登录容器的z-index以确保它在标题上方 */
        #login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            z-index: 1000;
        }
        
        .login-container {
            width: 100%;
            max-width: 330px;  /* 调整登录窗体宽度 */
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
            margin-right: 160px; /* 调整这个值来控制向左移动的距离 */
            margin-bottom:180px;  /* 这里控制垂直位置 */
        }
        
        .form-container {
            padding: 30px;
            transition: transform 0.6s ease-in-out;
        }
        
        #login-container .logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        #login-container .logo i {
            font-size: 42px;
            color: #764ba2;
            margin-bottom: 10px;
        }
        
        #login-container .logo h2 {
            color: #333;
            font-size: 28px;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #764ba2;
            z-index: 2;
            font-size: 16px;
            width: 20px;
            text-align: center;
            display: block;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px 12px 45px; /* 保持左侧内边距 */
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
            outline: none;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd5;
        }
        
        .links {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .links a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
            cursor: pointer;
        }
        
        .links a:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        .divider {
            text-align: center;
            margin: 25px 0;
            position: relative;
        }
        
        .divider:before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
            background: #ddd;
        }
        
        .divider span {
            background: rgba(255, 255, 255, 0.9);
            padding: 0 15px;
            color: #777;
            position: relative;
        }
        
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        #registerForm, #resetForm {
            display: none;
        }
        
        .back-to-login {
            text-align: center;
            margin-top: 20px;
        }
        
        .info-text {
            font-size: 13px;
            color: #666;
            text-align: center;
            margin-top: 15px;
        }
        
        @media (max-width: 480px) {
            .login-container {
                border-radius: 12px;
            }
            
            .form-container {
                padding: 20px;
            }
        }
        
        /* 主页面布局 */
        #main-container {
            display: none;
            min-height: 100vh;
            flex: 1;
            flex-direction: column;
            padding-top: 70px; /* 添加这行，为固定的header腾出空间 */
        }
        
        /* 移动端菜单按钮 */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            margin-right: 15px;
        }
        
        header {
            position: fixed; /* 修改为fixed */
            top: 0; 
            left: 0;
            width: 100%; /* 确保宽度为100% */
            z-index: 1000;
            background: linear-gradient(90deg, var(--dark), var(--secondary));
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            height: 70px;
            box-sizing: border-box;
        }
        
        header .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo img {
            height: 40px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .time-display {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            background: var(--glass-bg);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        /* 用户信息区域 */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--glass-bg);
            padding: 5px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .username {
            font-size: 14px;
            font-weight: 500;
        }
        
        .layout {
            display: flex;
            flex: 1;
            min-height: calc(100vh - 70px);
            margin-left: 250px; /* 添加这行，为固定的sidebar腾出空间 */
        }
        
        /* 左侧菜单 */
        .sidebar {
            position: fixed; /* 修改为fixed */
            top: 70px; /* 与header高度一致 */
            left: 0;
            height: calc(100vh - 70px); /* 减去header高度 */
            background: linear-gradient(180deg, var(--dark), #0c1e32);
            padding: 25px 0;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            overflow-y: auto; /* 确保菜单内容可滚动 */
            width: 250px;
            z-index: 999; /* 确保在内容之上，但在header之下 */
        }
        
        .menu-item {
            padding: 15px 30px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            font-size: 16px;
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .menu-item.active {
            background: rgba(26, 115, 232, 0.2);
            color: white;
            border-left: 4px solid var(--primary);
        }
        
        .menu-item i {
            width: 24px;
            text-align: center;
        }
        
        /* 子菜单样式 */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .submenu.expanded {
            max-height: 500px;
        }
        
        .submenu-item {
            padding: 12px 20px 12px 60px;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 14px;
            text-decoration: none; /* 添加这行移除下划线 */
        }
        
        .submenu-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            text-decoration: none; /* 添加这行确保hover时也没有下划线 */
        }
        
        .submenu-item i {
            font-size: 12px;
        }
        
        .submenu .submenu {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .submenu .submenu .submenu-item {
            padding-left: 80px;
        }
        
        .menu-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s;
        }
        
        .menu-item.expanded .menu-toggle {
            transform: translateY(-50%) rotate(90deg);
        }
        
        /* 主内容区 */
        .main-content {
            flex: 1;
            padding: 30px;
            background: #f0f5ff;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 22px;
            margin-bottom: 3px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        /* 数据查询区域 - 修改部分 */
        .query-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 10px 15px; /* 减少内边距 */
            margin-bottom: 20px; /* 减少下边距 */
            box-shadow: var(--shadow);
            width: 100%; /* 宽度铺满 */
            height: auto; /* 高度自适应 */
        }
        
        .query-form {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            align-items: center;
        }

        #data-query-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .form-group {
    width: 100%; /* 确保宽度100% */
    margin-bottom: 20px;
    position: relative;
}
        
        .form-group label {
            font-weight: 500;
            color: #555;
            font-size: 14px; /* 减小字体 */
        }
        
        #data-query-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        #data-query-container .form-group {
            flex: 0 0 22%; /* 固定宽度约为原来的1/3 */
            margin: 0;
        }

        #data-query-container .form-group input,
        #data-query-container .form-group select {
            width: 100%;
            padding: 8px 10px;
            height: 36px;
            box-sizing: border-box;
        }

        #data-query-container .btn-group {
            flex: 0 0 auto;
            display: flex;
            gap: 8px;
            align-items: center;
            height: 36px;
        }

        .form-group input, .form-group select {
            padding: 8px 10px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.3s;
            height: 36px;
            width: 100%;
        }
        
        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            outline: none;
        }
        
        #data-query-container .btn-group {
            display: flex;
            gap: 8px;
            margin-left: 0;
            padding-bottom: 0;
        }
        
        .query-btn, .export-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px; /* 减小内边距 */
            border-radius: 8px;
            font-size: 14px; /* 减小字体 */
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px; /* 减小间距 */
            height: 36px; /* 固定高度 */
            white-space: nowrap; /* 防止文本换行 */
        }
        
        .export-btn {
            background: var(--success);
        }
        
        .query-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }
        
        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .query-btn:disabled, .export-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .query-btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .query-btn.loading .spinner {
            display: inline-block;
        }
        
        .query-btn.loading span {
            vertical-align: middle;
        }
        
        .query-info {
            margin-top: 10px; /* 减小上边距 */
            color: #666;
            font-size: 13px; /* 减小字体 */
            padding: 6px; /* 减小内边距 */
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.03);
            border-left: 4px solid var(--accent);
        }
        
        .query-info.error {
            background-color: rgba(220, 53, 69, 0.1);
            border-left-color: var(--danger);
            color: var(--danger);
        }
        
        .query-info.error i {
            color: var(--danger);
        }
        
        .query-info.success {
            background-color: rgba(40, 167, 69, 0.1);
            border-left-color: var(--success);
            color: var(--success);
        }
        
        .query-info.success i {
            color: var(--success);
        }
        
        /* Excel 表格区域 */
        .excel-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .excel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table-container {
            /* 报表在桌面和移动端均支持双向滚动 */
            overflow: auto;
            max-height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px; /* 确保表格不会过窄 */
            /* 移除固定布局，让列宽自适应 */
            table-layout: auto; 
        }
        
        .table-container th {
            background-color: var(--primary);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            padding: 12px 15px;
        }
        
        .table-container th, .table-container td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
            /* 移除最小宽度限制 */
            min-width: 0;
            /* 确保内容完整显示 */
            white-space: normal;
            word-break: break-word;
            line-height: 1.5;
            vertical-align: middle;
            /* 添加最大宽度限制防止内容过长 */
            max-width: 300px;
        }
        
        /* 确保数字列也居中对齐 */
        .table-container .num-cell,
        .table-container .num-col {
            text-align: center !important;
        }
        
        /* 综合数据报表数字列居中对齐 */
        #comprehensive-table-container .num-cell,
        #comprehensive-table-container .num-col {
            text-align: center !important;
        }
        
        /* 充电数据看板表格数字列居中对齐 */
        #charging-board-table-container .num-cell,
        #charging-board-table-container .num-col {
            text-align: center !important;
        }
        
        /* 实时数据表格数字列居中对齐 */
        #realtime-table .num-cell,
        #realtime-table .num-col {
            text-align: center !important;
        }
        
        /* 未充电时长统计表格数字列居中对齐 */
        #uncharged-table .num-cell,
        #uncharged-table .num-col {
            text-align: center !important;
        }
        
        .table-container tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .table-container tr:hover {
            background-color: #f1f7ff;
        }
        
        .table-container td:first-child {
            font-weight: bold;
            background-color: #f0f5ff;
        }
        
        .data-info {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            display: flex;
            justify-content: space-between;
        }
        
        /* 综合数据报表样式 */
        .comprehensive-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .comprehensive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        /* 页脚 */
        footer {
            background: linear-gradient(90deg, var(--dark), var(--secondary));
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 14px;
            margin-top: auto;
            width: 100%;
        }
        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .income-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .layout {
                margin-left: 0;
                flex-direction: column;
            }
            
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                top: 0;
                order: 2;
                display: none; /* 默认隐藏 */
            }
            
            .sidebar.mobile-open {
                display: block;
            }
            
            .main-content {
                order: 1;
                width: 100%;
            }
            
            #main-container {
                padding-top: 60px;
            }
            
            header {
                height: 60px;
                padding: 10px 15px;
                position: relative;
            }
            
            .logo h1 {
                font-size: 18px;
            }
            
            .mobile-menu-toggle {
                display: block;
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                padding: 5px;
            }
            
            .query-form {
                flex-direction: column;
                gap: 15px;
            }
            
            #data-query-container {
                flex-direction: column;
                gap: 15px;
            }
            
            #data-query-container .form-group {
                flex: 1;
                width: 100%;
            }
            
            #data-query-container .btn-group {
                flex: none;
                width: 100%;
                justify-content: center;
            }
            
            .form-group {
                width: 100% !important;
                min-width: unset !important;
            }
            
            .btn-group {
                width: 100% !important;
                justify-content: center !important;
                flex-wrap: wrap;
            }
            
            .query-btn, .export-btn {
                min-width: 120px;
                flex: 1;
            }
        }
        
        @media (max-width: 768px) {
            .metric-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .income-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .metric-card {
                min-width: unset;
                width: 100%;
            }
            
            .user-info .username {
                display: none;
            }
            
            .time-display {
                font-size: 12px;
                padding: 5px 8px;
            }
            
            .logo h1 {
                font-size: 16px;
            }
            
            .chart-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .chart-title > div {
                display: flex;
                gap: 10px;
                align-items: center;
                width: 100%;
                justify-content: flex-start;
            }
            
            .table-container {
                font-size: 12px;
            }
            
            .table-container th, .table-container td {
                padding: 8px 5px;
                min-width: 80px;
            }
            
            .metric-value {
                font-size: 18px;
            }
            
            .metric-label {
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .login-container {
                width: 95%;
                margin: 10px;
            }
            
            .form-container {
                padding: 20px 15px;
            }
            
            header {
                padding: 8px 10px;
                height: 50px;
            }
            
            #main-container {
                padding-top: 50px;
            }
            
            .main-content {
                padding: 10px;
            }
            
            .query-section {
                padding: 10px;
            }
            
            .metric-card {
                padding: 15px;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .logo h1 {
                font-size: 14px;
            }
            
            .time-display {
                font-size: 10px;
                padding: 4px 6px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .metric-value {
                font-size: 16px;
            }
            
            .metric-label {
                font-size: 11px;
            }
            
            .query-btn, .export-btn {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .table-container th, .table-container td {
                padding: 6px 4px;
                font-size: 11px;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
        
        /* 移动端日期选择器优化 */
        @media (max-width: 768px) {
            .custom-picker {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 300px;
                z-index: 2000;
            }
            
            .date-picker-container {
                position: relative;
            }
            
            .table-container {
                border-radius: 4px;
            }
            
            .realtime-table-container {
                height: 300px;
            }
            
            .uncharged-table-container {
                max-height: 300px;
            }
            
            /* 表格左右滚动提示 */
            .table-container::before {
                content: "← 左右滚动查看更多";
                position: absolute;
                top: 5px;
                right: 10px;
                font-size: 10px;
                color: #999;
                z-index: 5;
                background: rgba(255, 255, 255, 0.9);
                padding: 2px 5px;
                border-radius: 3px;
            }
        }

        /* 登录表单图标显示样式 */
#login-container .form-group i {
    display: block;
}
#login-container .form-control {
    padding: 12px 15px 12px 45px !important; /* 保持左侧内边距 */
}

/* 其他表单隐藏图标样式 */
.main-content .form-group i {
    display: none;
}
.main-content .form-control {
    padding: 12px 15px !important; /* 移除左侧内边距 */
}
        
        /* 图表加载指示器 */
        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }
        
        .chart-loading i {
            font-size: 36px;
            margin-bottom: 10px;
            color: var(--primary);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.5; transform: scale(0.9); }
        }
        
        /* 数据加载指示器 */
        .data-loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--primary);
            font-size: 16px;
        }
        
        .data-loading i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        .data-type-select {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* 日期选择器改进 */
        .form-group input[type="month"] {
            cursor: pointer;
            position: relative;
        }
        
        .form-group input[type="month"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
        }
        
        /* 自定义日期选择器容器 */
        .custom-date-picker {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        .year-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .year-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 0 8px;
            color: #555;
        }
        
        .year-btn:hover {
            color: var(--primary);
        }
        
        .year-display {
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .month-btn {
            padding: 8px 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .month-btn:hover {
            background: #f0f5ff;
            border-color: var(--primary);
        }
        
        .month-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* 日期选择器容器 */
        .date-picker-container {
            position: relative;
        }
        
        .custom-picker {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            min-width: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }
        
        /* 功能提示弹窗 */
        .feature-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            text-align: center;
            max-width: 90%;
            width: 400px;
            display: none;
        }
        
        .feature-popup h3 {
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .feature-popup .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: #777;
            background: none;
            border: none;
        }
        
        .feature-popup .popup-content {
            margin-bottom: 20px;
            font-size: 18px;
            color: #555;
        }
        
        .feature-popup .confirm-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .feature-popup .confirm-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }

        #metrics-container {
            padding: 30px;
            background: #f0f5ff;
        }

        .metrics-section {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .metrics-section > .metrics-row {
    width: 100%;
    margin-bottom: 15px;
}

/* 调整指标卡片宽度 */
.metrics-section > .metrics-row:nth-child(1) .metric-item {
    background: linear-gradient(135deg, rgba(26, 115, 232, 0.15), rgba(26, 115, 232, 0.05));
    border-left: 4px solid var(--primary);
}

.metrics-section > .metrics-row:nth-child(2) .metric-item {
    background: linear-gradient(135deg, rgba(0, 200, 83, 0.15), rgba(0, 200, 83, 0.05));
    border-left: 4px solid var(--accent);
}

.metrics-section > .metrics-row:nth-child(3) .metric-item {
    background: linear-gradient(135deg, rgba(156, 39, 176, 0.15), rgba(156, 39, 176, 0.05));
    border-left: 4px solid #9c27b0;
}

.metrics-section > .metrics-row:nth-child(4) .metric-item {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 193, 7, 0.05));
    border-left: 4px solid #ffc107;
}
/* 悬停效果增强 */
.metric-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

/* 调整指标值的颜色与卡片主题匹配 */
.metrics-section > .metrics-row:nth-child(1) .metric-value {
    color: var(--primary) !important;
}

.metrics-section > .metrics-row:nth-child(2) .metric-value {
    color: var(--accent) !important;
}

.metrics-section > .metrics-row:nth-child(3) .metric-value {
    color: #9c27b0 !important;
}

.metrics-section > .metrics-row:nth-child(4) .metric-value {
    color: #ff9800 !important;
}


        .metrics-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .metric-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            flex: 1;
            min-width: 300px;
        }

        .metric-card-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            /* 移除了下面的横线 */
    /* border-bottom: 2px solid var(--primary); */
        }

        .metric-card-title i {
            color: var(--primary);
        }

       /* 修改网格布局为一行的四个项目 */
.metric-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* 改为4列 */
    gap: 15px; /* 可以根据需要调整间距 */
}

/* 修改指标项背景为透明 */
.metric-item {
    padding: 15px;
    border-radius: 8px;
    background: transparent; /* 改为透明背景 */
    text-align: center;
    transition: all 0.3s;
}

        
        /* 综合收入数据显示在一行 */
        .income-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .metric-item {
            padding: 15px;
            border-radius: 8px;
            background: rgba(26, 115, 232, 0.05);
            text-align: center;
            transition: all 0.3s;
        }

        .metric-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
            white-space: nowrap;
        }
/* 在这里添加您的自定义颜色代码 */
/* 本月充电数据数字颜色 */
#month-charge, #month-electricity, #month-service, #month-orders {
    color: #000000; /* 红色系 */
}

/* 本年度充电数据数字颜色 */
#year-charge, #year-electricity, #year-service, #year-orders {
    color: #0c0c0c; /* 青色系 */
}

/* 累计充电数据数字颜色 */
#total-charge, #total-electricity, #total-service, #total-orders {
    color: #0c0c0c; /* 蓝色系 */
}
/* 累计综合业务收入数字颜色 */
#month-income, #year-income, #total-income {
    color: #0c0c0c; /* 蓝色系 */
}
        .metric-label {
            font-size: 14px;
            color: #666;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-top: 15px;
        }

        .chart-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title i {
            color: var(--primary);
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        .chart-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .chart-action-btn {
            padding: 8px 15px;
            background: #f0f5ff;
            border: 1px solid var(--primary);
            border-radius: 6px;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        /* 综合收入看板特定样式 */
        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
        }

        .form-select {
            padding: 8px 12px;
            border: 1px solid var(--gray);
            border-radius: 6px;
            background: white;
            min-width: 100px;
        }

        .table-wrapper {
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .chart-action-btn:hover {
            background: var(--primary);
            color: white;
        }

        #report-section {
            padding-top: 50px;
        }
        
        /* 数据加载动画 */
        .data-loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            color: var(--primary);
        }
        
        .data-loading-indicator i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

/* 实时数据表格样式 */
.realtime-table-container {
    height: 400px; /* 将max-height改为固定高度 */
    overflow: auto; /* 改为auto以便内容超出时可以滚动 */
    position: relative;
    border: 1px solid #ddd;
    border-radius: 8px;
}

#realtime-loading {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    padding: 20px;
    color: var(--primary);
    font-size: 16px;
    width: 100%;
    z-index: 5;
}

#realtime-loading i {
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

#realtime-table {
    width: 100%;
    border-collapse: collapse;
}

#realtime-table th {
    background-color: var(--primary);
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    padding: 12px 15px;
    text-align: center;
}

#realtime-table td {
    padding: 10px 15px;
    text-align: center;
    border-bottom: 1px solid #eee;
}

#realtime-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

#realtime-table tr.highlight {
    background-color:   #e0d0ff!important;
    transition: background-color 0.5s ease;
}

#realtime-table tr:hover {
    background-color: #f1f7ff;
    cursor: pointer;
}

 /* 未充电时长统计表格表头样式 */
        #uncharged-table th {
            background-color: #1a73e8 !important; /* 深蓝色背景 */
            color: #ffffff !important; /* 白色文字 */
            border: 1px solid #0d47a1 !important; /* 深蓝色边框 */
            font-weight: 600;
            padding: 12px 8px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* 表格行样式 */
        #uncharged-table tr:nth-child(even) {
            background-color: #f8fbff;
        }
        
        #uncharged-table tr:hover {
            background-color: #e8f0fe;
        }

        /* 桌面端：报表容器显示底部横向滚动条并禁止单元格换行 */
        @media (min-width: 901px) {
            #table-container,
            #comprehensive-table-container,
            .table-wrapper {
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }

            #table-container th, #table-container td,
            #comprehensive-table-container th, #comprehensive-table-container td {
                white-space: nowrap;
                word-break: keep-all;
                max-width: none;
            }

            /* 让表格在内容较多时能触发横向滚动 */
            #table-container table,
            #comprehensive-table-container table {
                table-layout: auto;
                min-width: 1000px;
            }
        }

    </style>
</head>
<body>
    <!-- 在body开始处添加头部标题区域 -->
    <div class="header-title" id="login-header-title">
        <img src="https://jiangnanwaw.github.io/my-page/photo/fhlogo.png" alt="Logo" class="header-logo">
        <h1 class="header-text">长沙飞狐数据管理平台</h1>
    </div>
    
    <!-- LeanCloud 登录系统 -->
    <div id="login-container">
        <div class="login-container">
            <div class="form-container">
                <div class="logo">
                    <i class="fas fa-user-lock"></i>
                    <h2 id="form-title">用户登录</h2>
                </div>
                
                <div id="loginMessage" class="message"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="loginUsername" class="form-control" placeholder="用户名" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="loginPassword" class="form-control" placeholder="密码" required>
                    </div>
                    
                    <button type="submit" class="btn">登录</button>
                    
                    <div class="links">
                        <a href="#" id="showReset">忘记密码?</a>
                        <a href="#" id="showRegister">注册新账号</a>
                    </div>
                </form>
                
                <form id="registerForm">
                    <div class="form-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="registerUsername" class="form-control" placeholder="设置用户名" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="registerPassword" class="form-control" placeholder="设置密码" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="registerEmail" class="form-control" placeholder="电子邮箱" required>
                    </div>
                    

                    
                    <button type="submit" class="btn">注册</button>
                    
                    <p class="info-text">只有管理员授权的用户名才能注册和登录</p>
                    
                                      
                    <div class="back-to-login">
                        <a href="#" id="backToLoginFromRegister">返回登录</a>
                    </div>
                </form>
                
                <form id="resetForm">
                    <div class="form-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="resetEmail" class="form-control" placeholder="输入注册邮箱" required>
                    </div>
                    
                    <button type="submit" class="btn">发送重置邮件</button>
                    
                    <div class="back-to-login">
                        <a href="#" id="backToLoginFromReset">返回登录</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    
    <!-- 功能提示弹窗 -->
    <div class="feature-popup" id="feature-popup">
        <button class="close-btn" id="close-popup"><i class="fas fa-times"></i></button>
        <h3><i class="fas fa-exclamation-triangle"></i> 功能提示</h3>
        <div class="popup-content" id="popup-content">
            此功能暂未开放
        </div>
        <button class="confirm-btn" id="confirm-popup">确定</button>
    </div>

    <!-- 主页面容器 -->
    <div id="main-container">
        <header>
            <button class="mobile-menu-toggle" id="mobile-menu-toggle" style="display: none;">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <i class="fas fa-bolt"></i>
                <h1>长沙飞狐智能数据平台</h1>
            </div>
            <div class="user-info">
                <img src="https://jiangnanwaw.github.io/my-page/photo/fhlogo.png" alt="用户头像" class="user-avatar">
                <span class="username" id="user-display">admin</span>
            </div>
            <div class="time-display" id="time-display">
                2025年08月05日 星期二 10:30:45
            </div>
        </header>
        
        <div class="layout">
            <!-- 左侧菜单 -->
            <div class="sidebar">
                <div class="menu-item active">
                    <i class="fas fa-home"></i>
                    <span>平台首页</span>
                </div>
                
                <!-- BI数据分析（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    <span>BI数据分析</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="https://www.csfhcdz.cn/bi/cdbi.html" target="_blank" class="submenu-item">
                        <i class="fas fa-bolt"></i>
                        <span>充电数据可视化</span>
                    </a>
                    <a href="https://www.csfhcdz.cn/bi/zhbi.html" target="_blank" class="submenu-item">
                        <i class="fas fa-chart-bar"></i>
                        <span>综合数据可视化</span>
                    </a>
                </div>
                
                <!-- 场站基本情况（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>场站基本情况</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <!-- 四方坪站（带子菜单） -->
                    <div class="menu-item">
                        <i class="fas fa-building"></i>
                        <span>四方坪站</span>
                        <i class="fas fa-chevron-right menu-toggle"></i>
                    </div>
                    <div class="submenu">
                        <!-- 监控（带子菜单） -->
                        <div class="menu-item">
                            <i class="fas fa-video"></i>
                            <span>监控</span>
                            <i class="fas fa-chevron-right menu-toggle"></i>
                        </div>
                        <div class="submenu">
                            <a href="http://wawtf.eicp.net:50000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>东区</span>
                            </a>
                            <a href="http://wawtf.eicp.net:7000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>南区</span>
                            </a>
                            <a href="http://wawtf.eicp.net:9000" target="_blank" class="submenu-item">
                                <i class="fas fa-arrow-right"></i>
                                <span>西区</span>
                            </a>
                        </div>
                        <a href="https://cloud.wlyk.com/" target="_blank" class="submenu-item">
                            <i class="fas fa-road"></i>
                            <span>道闸</span>
                        </a>
                    </div>
                    
                    <!-- 高岭站（带子菜单） -->
                    <div class="menu-item">
                        <i class="fas fa-building"></i>
                        <span>高岭站</span>
                        <i class="fas fa-chevron-right menu-toggle"></i>
                    </div>
                    <div class="submenu">
                        <a href="http://wawwt.eicp.net:1428" target="_blank" class="submenu-item">
                            <i class="fas fa-video"></i>
                            <span>监控</span>
                        </a>
                        <a href="https://psp.hikparking.com/#/login" target="_blank" class="submenu-item">
                            <i class="fas fa-road"></i>
                            <span>道闸</span>
                        </a>
                    </div>
                </div>
                
                <!-- 充电桩管理（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-car-battery"></i>
                    <span>充电桩管理</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="https://cloud.teld.cn/web/login?locale=zh-CN" target="_blank" class="submenu-item">
                        <i class="fas fa-plug"></i>
                        <span>特来电</span>
                    </a>
                    <a href="https://auth.digipowercloud.huawei.com/dpcloud/index.html#/login" target="_blank" class="submenu-item">
                        <i class="fas fa-plug"></i>
                        <span>华为</span>
                    </a>
                </div>
                
                <!--  资料文件（带子菜单） -->
                <div class="menu-item">
                    <i class="fas fa-building"></i>
                    <span>资料文件</span>
                    <i class="fas fa-chevron-right menu-toggle"></i>
                </div>
                <div class="submenu">
                    <a href="ftp://wawtf.eicp.net/" target="_blank" class="submenu-item">
                        <i class="fas fa-building"></i>
                        <span>相关合同</span>
                    </a>
                   <a href="https://www.csfhcdz.cn/bi/qt.html" target="_blank" class="submenu-item">
                        <i class="fas fa-building"></i>
                        <span>其它资料</span>
                    </a>
                </div>

                <!-- 其他菜单项 -->
                
                <div class="menu-item" id="finance-management">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>财务管理</span>
                </div>

                <div class="menu-item" id="system-settings">
                    <i class="fas fa-cogs"></i>
                    <span>系统设置</span>
                </div>
                <div class="menu-item" id="history-menu">
                    <i class="fas fa-history"></i>
                    <span>历史记录</span>
                </div>
            </div>
            
            <!-- 主内容区 -->
            <div class="main-content">
                <!-- 查询板块 -->
                <div class="query-section">
                    <h2 class="section-title"><i class="fas fa-search"></i> 数据查询</h2>
                    <div class="query-form" id="data-query-form">
                        <div class="form-group date-picker-container" style="flex: 0 0 18%;">
                           <label for="start-date">开始日期</label>
        <input type="text" id="start-date" placeholder="选择开始日期" readonly style="width: 100%; height: 36px; box-sizing: border-box; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
        <div class="custom-picker" id="start-date-picker" style="width: 100%;">
                                <div class="custom-date-picker">
                                    <div class="date-header">
                                        <div class="year-control">
                                            <button class="year-btn prev-year"><i class="fas fa-chevron-left"></i></button>
                                            <div class="year-display" id="start-year-display">2025</div>
                                            <button class="year-btn next-year"><i class="fas fa-chevron-right"></i></button>
                                        </div>
                                    </div>
                                    <div class="month-grid" id="start-month-grid">
                                        <!-- 月份按钮由JS生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group date-picker-container" style="flex: 0 0 18%;">
                             <label for="end-date">结束日期</label>
        <input type="text" id="end-date" placeholder="选择结束日期" readonly style="width: 100%; height: 36px; box-sizing: border-box; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
        <div class="custom-picker" id="end-date-picker" style="width: 100%;">
                                <div class="custom-date-picker">
                                    <div class="date-header">
                                        <div class="year-control">
                                            <button class="year-btn prev-year"><i class="fas fa-chevron-left"></i></button>
                                            <div class="year-display" id="end-year-display">2025</div>
                                            <button class="year-btn next-year"><i class="fas fa-chevron-right"></i></button>
                                        </div>
                                    </div>
                                    <div class="month-grid" id="end-month-grid">
                                        <!-- 月份按钮由JS生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="flex: 0 0 18%;">
                            <label for="data-type">数据类型</label>
        <select id="data-type" style="width: 100%; height: 36px; box-sizing: border-box; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white;">
            <option value="charging">充电数据</option>
            <option value="comprehensive">综合数据</option>
        </select>
    </div>
                        
                        <div class="btn-group" style="flex: 0 0 auto; display: flex; gap: 8px; align-items: center;">
                           <button class="query-btn" id="query-btn" style="margin-bottom: 0;">
            <span class="spinner"></span>
            <i class="fas fa-search"></i>
            <span>查询数据</span>
        </button>
        <button class="export-btn" id="export-btn" disabled style="margin-bottom: 0;">
            <i class="fas fa-file-excel"></i>
            <span>导出Excel</span>
        </button>
    </div>
</div>
                    <div class="query-info" id="query-info" style="margin-top: 2px; padding: 4px;">
                        <i class="fas fa-info-circle"></i> 
                        请选择日期和数据类型来查询数据
                    </div>
                </div>

<!-- 本月实时数据板块 -->
<h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-chart-line"></i> 本月实时数据</h2>
<div class="metrics-section">
    <!-- 实时数据轮播表格 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-table"></i>
            本月日充电数据
        </div>
        <div class="realtime-table-container" id="realtime-table-container">
            <div class="data-loading" id="realtime-loading">
                <i class="fas fa-spinner fa-spin"></i> 正在加载实时数据，请稍候...
            </div>
            <table id="realtime-table">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>站点</th>
                        <th>充电量(kwh)</th>
                        <th>充电总收入(元)</th>   <!-- 新增这一列 -->
                        <th>充电服务费收入(元)</th>
                        <th>总订单数量</th>
                    </tr>
                </thead>
                <tbody id="realtime-table-body">
                    <!-- 数据将由JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 实时数据图表 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-line"></i>
            本月充电数据趋势
        </div>
        <div class="chart-wrapper">
            <canvas id="realtime-chart"></canvas>
        </div>
    </div>

    <!-- 未充电时长统计 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-clock"></i>
            未充电时长统计
            <div style="display: flex; align-items: center; margin-left: auto; gap: 10px;">
                <select id="uncharged-duration-filter" style="padding: 5px;">
                    <option value="all">全部时长</option>
                    <option value="lt30">&lt;30小时</option>
                    <option value="ge30lt60">&gt;=30&lt;60小时</option>
                    <option value="ge60lt90">&gt;=60&lt;90小时</option>
                    <option value="ge90">&gt;=90小时</option>
                    <option value="stillUncharged">截止一直未充电</option>
                </select>
            </div>
        </div>
        <div class="uncharged-table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
            <table id="uncharged-table" class="data-table" style="width: 100%; border-collapse: collapse; border: 1px solid #e0e0e0;">
                <thead>
                    <tr>
                        <th style="text-align: center; padding: 12px 8px; background-color: #f5f5f5; border: 1px solid #e0e0e0;">电站名称</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: #f5f5f5; border: 1px solid #e0e0e0;">终端名称</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: #f5f5f5; border: 1px solid #e0e0e0;">上一次充电结束时间</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: #f5f5f5; border: 1px solid #e0e0e0;">下一次充电开始时间</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: #f5f5f5; border: 1px solid #e0e0e0;">截止一直未充电时间</th>
                        <th style="text-align: center; padding: 12px 8px; background-color: #f5f5f5; border: 1px solid #e0e0e0;">未充电时长(小时)</th>
                    </tr>
                </thead>
                <tbody id="uncharged-table-body">
                    <!-- 数据将由JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
        <div class="data-info" style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0 10px;">
            <div id="uncharged-data-info">共加载 0 条数据</div>
            <div id="uncharged-pagination">
                当前第 <span id="current-page">1</span> 页，共 <span id="total-pages">1</span> 页
                <select id="page-select" style="margin-left: 10px;">
                    <option value="1">1</option>
                </select>
            </div>
        </div>
    </div>
</div>
 

                <h2 class="section-title" style="margin-top: 15px;"><i class="fas fa-charging-station"></i> 充电数据</h2>
                <!-- 充电数据指标板块 -->
                <div class="metrics-section" style="gap: 8px;">
    <!-- 本月充电数据 - 单独一行 -->
    <div class="metrics-row" style="margin-bottom: 5px;">
        <div class="metric-card" style="width: 100%; margin-bottom: 0;">
            <div class="metric-card-title">
                <i class="fas fa-calendar-check"></i>
                本月充电数据
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value" id="month-charge">205,673.95 kwh</div>
                    <div class="metric-label">总充电量</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="month-electricity">¥177,408.03</div>
                    <div class="metric-label">总充电收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="month-service">¥64,784.97</div>
                    <div class="metric-label">总服务费收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="month-orders">8,222</div>
                    <div class="metric-label">总订单数量</div>
                </div>
            </div>
        </div>
    </div>
                        
                       
                               <!-- 本年度充电数据 - 单独一行 -->
    <div class="metrics-row" style="margin-bottom: 5px;">
        <div class="metric-card" style="width: 100%; margin-bottom: 0;">
            <div class="metric-card-title">
                <i class="fas fa-calendar-alt"></i>
                本年度充电数据
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value" id="year-charge">3,395,628.58 kwh</div>
                    <div class="metric-label">总充电量</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="year-electricity">¥2,878,714.66</div>
                    <div class="metric-label">总充电收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="year-service">¥963,642.56</div>
                    <div class="metric-label">总服务费收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="year-orders">130,688</div>
                    <div class="metric-label">总订单数量</div>
                </div>
            </div>
        </div>
    </div>
                        
                                                      <!-- 累计充电数据 - 单独一行 -->
    <div class="metrics-row" style="margin-bottom: 5px;">
        <div class="metric-card" style="width: 100%; margin-bottom: 0;">
            <div class="metric-card-title">
                <i class="fas fa-chart-line"></i>
                累计充电数据
            </div>
            <div class="metric-grid">
                <div class="metric-item">
                    <div class="metric-value" id="total-charge">32,051,447.86 kwh</div>
                    <div class="metric-label">总充电量</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="total-electricity">¥30,318,139.69</div>
                    <div class="metric-label">总充电收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="total-service">¥11,305,282.54</div>
                    <div class="metric-label">总服务费收入</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="total-orders">1,235,906</div>
                    <div class="metric-label">总订单数量</div>
                </div>
            </div>
        </div>
    </div>
                    
               <!-- 充电数据看板 -->
<h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-charging-station"></i> 充电数据看板</h2>
<div class="metrics-section">
    <!-- 第一部分：数据表格 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-table"></i>
            充电数据表格
            <div style="display: flex; align-items: center; margin-left: auto; gap: 10px;">
                <select id="year-select" style="padding: 5px;">
                    <!-- 年份选项将由JavaScript动态生成 -->
                </select>
                <button class="export-btn" id="export-board-btn">
                    <i class="fas fa-file-excel"></i>
                    <span>导出数据</span>
                </button>
            </div>
        </div>
        <div class="table-container" id="charging-board-table-container">
            <table id="charging-board-table">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>充电量(kwh)</th>
                        <th>充电电费(元)</th>
                        <th>充电服务费(元)</th>
                        <th>充电总收入(元)</th>
                        <th>总订单数量</th>
                    </tr>
                </thead>
                <tbody id="charging-board-table-body">
                    <!-- 数据将由JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 第二部分：可视化图表 -->
    <div class="chart-container">
        <div class="chart-title">
            <i class="fas fa-chart-line"></i>
            充电数据趋势
        </div>
        <div class="chart-wrapper">
            <canvas id="charging-board-chart"></canvas>
        </div>
    </div>
</div>
                    
                    <!-- 充电数据总趋势图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            充电数据总趋势 (2018-2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="charging-trend-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                </div>
                <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-chart-line"></i> 综合业务数据</h2>
                <!-- 综合数据板块 -->
                <div class="metrics-section">
                    <div class="metrics-row">
                        <div class="metric-card">
                            <div class="metric-card-title">
                                <i class="fas fa-money-bill-wave"></i>
                                综合收入数据
                            </div>
                            <!-- 修改为三列布局 -->
                            <div class="income-grid">
                                <div class="metric-item">
                                    <div class="metric-value" id="month-income">¥43,435.85</div>
                                    <div class="metric-label">本月总收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="year-income">¥375,153.84</div>
                                    <div class="metric-label">本年度总收入</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value" id="total-income">¥2,564,822.21</div>
                                    <div class="metric-label">累计总收入</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                  <!-- 综合收入看板 -->
<div class="chart-container">
    <div class="chart-title">
        <i class="fas fa-chart-bar"></i>
        综合收入看板
        <div style="display: flex; align-items: center; margin-left: auto; gap: 10px;">
            <select id="income-year-select" class="form-select">
                <!-- 年份选项将由JavaScript动态生成 -->
            </select>
            <button id="income-export-btn" class="chart-action-btn">
                <i class="fas fa-download"></i> 导出数据
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table id="income-table" class="data-table">
            <thead>
                <tr>
                    <!-- 表头将由JavaScript动态生成 -->
                </tr>
            </thead>
            <tbody>
                <!-- 表格数据将通过JavaScript动态加载 -->
            </tbody>
        </table>
    </div>
    <div class="chart-wrapper" style="margin-top: 20px;">
        <canvas id="income-dashboard-chart"></canvas>
    </div>
</div>  
                                     
                    <!-- 各版块收入汇总图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            各版块收入汇总 (2023-2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="revenue-by-sector-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                    
                    <!-- 年度总收入趋势图表 -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            年度总收入趋势 (2018-2025年)
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="annual-revenue-trend-chart"></canvas>
                        </div>
                        <div class="chart-actions">
                            <button class="chart-action-btn"><i class="fas fa-download"></i> 导出图表</button>
                            <button class="chart-action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                        </div>
                    </div>
                </div>
                <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-table"></i> 数据报表</h2>
                <!-- Excel 表格区域 -->
                <div class="excel-section" id="report-section">
                    <div class="excel-header">
                        <h3 class="metric-section-title"><i class="fas fa-table"></i> 充电数据报表</h3>
                        <div id="file-info">当前显示: 2025年07月数据</div>
                    </div>
                    
                    <div class="data-loading" id="data-loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载数据，请稍候...
                    </div>
                    
                    <div class="table-container" id="table-container">
                        <!-- Excel表格将在这里渲染 -->
                        <table>
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>场站名称</th>
                                    <th>充电量(kwh)</th>
                                    <th>服务车辆(辆)</th>
                                    <th>收入(元)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2025-07-01</td>
                                    <td>四方坪站</td>
                                    <td>1,250</td>
                                    <td>85</td>
                                    <td>2,345.50</td>
                                </tr>
                                <tr>
                                    <td>2025-07-01</td>
                                    <td>高岭站</td>
                                    <td>980</td>
                                    <td>62</td>
                                    <td>1,845.20</td>
                                </tr>
                                <tr>
                                    <td>2025-07-02</td>
                                    <td>四方坪站</td>
                                    <td>1,340</td>
                                    <td>92</td>
                                    <td>2,520.80</td>
                                </tr>
                                <tr>
                                    <td>2025-07-02</td>
                                    <td>高岭站</td>
                                    <td>1,120</td>
                                    <td>75</td>
                                    <td>2,112.40</td>
                                </tr>
                                <tr>
                                    <td>2025-07-03</td>
                                    <td>四方坪站</td>
                                    <td>1,450</td>
                                    <td>98</td>
                                    <td>2,730.60</td>
                                </tr>
                                <tr>
                                    <td>2025-07-03</td>
                                    <td>高岭站</td>
                                    <td>1,050</td>
                                    <td>70</td>
                                    <td>1,980.20</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="data-info">
                        <div id="row-count">共加载 6 行数据</div>
                        <div id="last-update">最后更新时间: 2025-08-10 14:30:25</div>
                    </div>
                </div>
                
                <!-- 综合数据报表 -->
                <div class="comprehensive-section">
                    <div class="comprehensive-header">
                        <h3 class="metric-section-title"><i class="fas fa-chart-pie"></i> 综合数据报表</h3>
                        <div id="comprehensive-info">当前显示: 2025年07月数据</div>
                    </div>
                    
                    <div class="data-loading" id="comprehensive-loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载综合数据，请稍候...
                    </div>
                    
                    <div class="table-container" id="comprehensive-table-container">
                        <!-- 综合数据报表将在这里渲染 -->
                        <table>
                            <thead>
                                <tr>
                                    <th>指标</th>
                                    <th>四方坪站</th>
                                    <th>高岭站</th>
                                    <th>合计</th>
                                    <th>同比增长</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>充电量(kwh)</td>
                                    <td>42,580</td>
                                    <td>32,150</td>
                                    <td>74,730</td>
                                    <td>+12.5%</td>
                                </tr>
                                <tr>
                                    <td>服务车辆(辆)</td>
                                    <td>2,850</td>
                                    <td>2,150</td>
                                    <td>5,000</td>
                                    <td>+8.3%</td>
                                </tr>
                                <tr>
                                    <td>总收入(元)</td>
                                    <td>80,240.50</td>
                                    <td>60,520.80</td>
                                    <td>140,761.30</td>
                                    <td>+15.2%</td>
                                </tr>
                                <tr>
                                    <td>设备利用率</td>
                                    <td>78.4%</td>
                                    <td>65.2%</td>
                                    <td>71.8%</td>
                                    <td>+5.3%</td>
                                </tr>
                                <tr>
                                    <td>平均充电时长</td>
                                    <td>45分钟</td>
                                    <td>52分钟</td>
                                    <td>48.5分钟</td>
                                    <td>-2.1%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="data-info">
                        <div id="comprehensive-row-count">共加载 5 行数据</div>
                        <div id="comprehensive-last-update">最后更新时间: 2025-08-10 14:30:25</div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- 页脚 -->
        <footer>
            © 2025 长沙飞狐电动汽车充电服务有限公司 | 新能源充电站数据管理平台
        </footer>
    </div>

    <!-- 在body结束前添加版权信息 -->
    <div class="footer-copyright" id="login-footer-copyright">
        <p>© 2018-2025 长沙飞狐电动汽车充电服务有限公司</p>
    </div>

    <script>
        // LeanCloud 配置
        const APP_ID = 'N4KUUvF2eY8wOG0sF5oddkdC-gzGzoHsz';
        const APP_KEY = 'xtsTJ4R0uMAJCjCJJvNcwsHt';
        const SERVER_URL = 'https://api.leancloud.cn';
        
        // 删除旧的LEANCLOUD_APP_URL配置
        
        // 初始化 LeanCloud
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY,
            serverURL: SERVER_URL
        });
        
        console.log('LeanCloud 初始化完成:', {
            appId: APP_ID,
            serverURL: SERVER_URL
        });
        
        // 登录记录相关函数
        // 记录用户登录
        async function recordUserLogin(username, additionalData = {}) {
            try {
                console.log('开始记录登录:', username);
                
                // 获取真实IP地址
                console.log('正在获取IP地址...');
                const clientIP = await getClientIP();
                console.log('获取到IP地址:', clientIP);
                
                // 直接使用LeanCloud数据存储
                const LoginRecord = AV.Object.extend('LoginRecord');
                const loginRecord = new LoginRecord();
                
                // 设置ACL权限，允许公开读写
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                loginRecord.setACL(acl);
                
                loginRecord.set('user_name', username);  // 改用user_name避免与系统字段冲突
                loginRecord.set('username', username);  // 保留原字段作为备份
                loginRecord.set('loginTime', new Date());
                loginRecord.set('userAgent', navigator.userAgent);
                loginRecord.set('deviceInfo', getDeviceInfo());
                loginRecord.set('page', window.location.href);
                loginRecord.set('ipAddress', clientIP); // 使用真实IP地址
                loginRecord.set('sessionId', 'web_session_' + Date.now());
                
                // 添加额外数据
                Object.keys(additionalData).forEach(key => {
                    loginRecord.set(key, additionalData[key]);
                });
                
                console.log('准备保存登录记录到LeanCloud...');
                console.log('用户名参数:', username);
                console.log('登录记录对象详情:', {
                    username: loginRecord.get('username'),
                    loginTime: loginRecord.get('loginTime'),
                    ipAddress: loginRecord.get('ipAddress'),
                    userAgent: loginRecord.get('userAgent'),
                    deviceInfo: loginRecord.get('deviceInfo')
                });
				const savedRecord = await loginRecord.save();
                console.log('✅ 登录记录成功保存到LeanCloud！记录ID:', savedRecord.id);
				// 记录最近一次登录记录ID，便于快速更新logoutTime
				try {
					window.__lastLoginRecordId = savedRecord.id;
					localStorage.setItem('lastLoginRecordId', savedRecord.id);
				} catch (e) {
					console.warn('无法保存lastLoginRecordId到本地存储:', e);
				}
                
                // 验证数据是否真的保存了
                try {
                    const verifyQuery = new AV.Query('LoginRecord');
                    const verifyRecord = await verifyQuery.get(savedRecord.id);
                    console.log('📋 验证保存成功，记录详情:', {
                        id: verifyRecord.id,
                        username: verifyRecord.get('username'),
                        loginTime: verifyRecord.get('loginTime'),
                        ipAddress: verifyRecord.get('ipAddress')
                    });
                } catch (verifyError) {
                    console.error('❌ 验证保存失败:', verifyError);
                }
                
                return {
                    success: true,
                    recordId: savedRecord.id,
                    loginTime: savedRecord.get('loginTime'),
                    ipAddress: clientIP,
                    message: '登录记录已保存'
                };
                
            } catch (error) {
                console.error('❌ 记录登录失败:', error);
                console.error('错误详情:', error.message, error.code);
                // 不抛出错误，避免影响正常登录流程
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // 获取用户登录历史
        async function getUserLoginHistory(username, limit = 10) {
            try {
                console.log('获取登录历史:', username);
                
                const query = new AV.Query('LoginRecord');
                query.equalTo('username', username);
                query.descending('loginTime');
                query.limit(limit);
                
                const records = await query.find();
                
                const loginHistory = records.map(record => ({
                    id: record.id,
                    username: record.get('username'),
                    loginTime: record.get('loginTime'),
                    userAgent: record.get('userAgent'),
                    ipAddress: record.get('ipAddress'),
                    deviceInfo: record.get('deviceInfo'),
                    page: record.get('page')
                }));
                
                console.log('获取登录历史成功:', loginHistory.length, '条记录');
                
                return {
                    success: true,
                    records: loginHistory,
                    total: loginHistory.length
                };
                
            } catch (error) {
                console.error('获取登录历史失败:', error);
                return {
                    success: false,
                    error: error.message,
                    records: []
                };
            }
        }
        
        // 获取客户端IP地址
        async function getClientIP() {
            try {
                // 方法1: 使用免费的IP查询服务
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.warn('获取IP地址失败，使用备用方法:', error);
                try {
                    // 方法2: 使用备用服务
                    const response = await fetch('https://httpbin.org/ip');
                    const data = await response.json();
                    return data.origin.split(',')[0].trim();
                } catch (error2) {
                    console.warn('备用IP服务也失败:', error2);
                    // 方法3: 使用WebRTC获取本地IP（可能被阻止）
                    return await getLocalIP();
                }
            }
        }

		// 添加记录用户登出信息的函数
		async function recordUserLogout(username) {
            try {
                console.log('开始记录登出信息:', username);

				// 优先使用本地缓存的最近一次登录记录ID，避免查询耗时导致未能及时保存
				let cachedRecordId = null;
				try {
					cachedRecordId = window.__lastLoginRecordId || localStorage.getItem('lastLoginRecordId');
				} catch (e) {
					console.warn('读取本地lastLoginRecordId失败:', e);
				}

				if (cachedRecordId) {
					try {
						const loginRecord = AV.Object.createWithoutData('LoginRecord', cachedRecordId);
						loginRecord.set('logoutTime', new Date());
						await loginRecord.save();
						console.log('✅ 通过缓存ID快速更新登出时间成功，记录ID:', cachedRecordId);
						return {
							success: true,
							recordId: cachedRecordId,
							message: '登出信息已记录'
						};
					} catch (fastUpdateError) {
						console.warn('通过缓存ID更新登出时间失败，回退到查询方式:', fastUpdateError);
					}
				}
                
                // 查询当前用户的最新登录记录
                const query = new AV.Query('LoginRecord');
                query.equalTo('username', username);
                query.descending('loginTime');
                query.limit(1);
                
                const records = await query.find();
                
                if (records.length > 0) {
                    const loginRecord = records[0];
                    
					// 更新登出时间
					loginRecord.set('logoutTime', new Date());
                    
                    // 保存更新
                    await loginRecord.save();
                    console.log('✅ 登出信息记录成功，记录ID:', loginRecord.id);
					// 清除本地缓存的记录ID，避免重复更新
					try {
						if (window.__lastLoginRecordId === loginRecord.id) {
							window.__lastLoginRecordId = null;
						}
						localStorage.removeItem('lastLoginRecordId');
					} catch (e) {
						console.warn('清理lastLoginRecordId失败:', e);
					}
                    
                    return {
                        success: true,
                        recordId: loginRecord.id,
                        message: '登出信息已记录'
                    };
                } else {
                    console.warn('未找到用户的登录记录');
                    return {
                        success: false,
                        error: '未找到登录记录'
                    };
                }
            } catch (error) {
                console.error('❌ 记录登出信息失败:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // 通过WebRTC获取本地IP地址
        async function getLocalIP() {
            return new Promise((resolve) => {
                try {
                    const pc = new RTCPeerConnection({
                        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                    });
                    
                    pc.createDataChannel('');
                    pc.createOffer().then(offer => pc.setLocalDescription(offer));
                    
                    pc.onicecandidate = (event) => {
                        if (event.candidate) {
                            const candidate = event.candidate.candidate;
                            const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/);
                            if (ipMatch) {
                                pc.close();
                                resolve(ipMatch[1]);
                            }
                        }
                    };
                    
                    // 超时处理
                    setTimeout(() => {
                        pc.close();
                        resolve('未知IP');
                    }, 3000);
                } catch (error) {
                    console.warn('WebRTC获取IP失败:', error);
                    resolve('未知IP');
                }
            });
        }
        
        // 检查用户是否被授权的函数
        async function checkUserAuthorization(username) {
            try {
                const query = new AV.Query('AuthorizedUsers');
                query.equalTo('username', username);
                const results = await query.find();
                return results.length > 0;
            } catch (error) {
                console.error('检查用户授权失败:', error);
                // 临时返回true以便测试，等AuthorizedUsers表创建后再改为false
                return true;
            }
        }
        
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            
            let device = 'Desktop';
            if (/Mobile|Android|iPhone|iPod|BlackBerry|IEMobile/.test(ua)) {
                device = 'Mobile';
            } else if (/Tablet|iPad/.test(ua)) {
                device = 'Tablet';
            }
        
            let browser = 'Unknown';
            if (ua.includes('Chrome')) browser = 'Chrome';
            else if (ua.includes('Firefox')) browser = 'Firefox';
            else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
            else if (ua.includes('Edge')) browser = 'Edge';
        
            return `${device} - ${browser}`;
        }

        
        // 获取DOM元素
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const resetForm = document.getElementById('resetForm');
        const loginMessage = document.getElementById('loginMessage');
        
        const showReset = document.getElementById('showReset');
        const showRegister = document.getElementById('showRegister');
        const backToLoginFromRegister = document.getElementById('backToLoginFromRegister');
        const backToLoginFromReset = document.getElementById('backToLoginFromReset');
        
        // 表单切换
        showReset.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            resetForm.style.display = 'block';
            registerForm.style.display = 'none';
            hideMessage();
            // 修改标题为"密码重置"
            document.getElementById('form-title').textContent = '密码重置';
        });
        
        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            resetForm.style.display = 'none';
            registerForm.style.display = 'block';
            hideMessage();
            // 修改标题为"新用户注册"
            document.getElementById('form-title').textContent = '新用户注册';
        });
        
        backToLoginFromRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'block';
            resetForm.style.display = 'none';
            registerForm.style.display = 'none';
            hideMessage();
            // 修改标题为"用户登录"
            document.getElementById('form-title').textContent = '用户登录';
        });
        
        backToLoginFromReset.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'block';
            resetForm.style.display = 'none';
            registerForm.style.display = 'none';
            hideMessage();
            // 修改标题为"用户登录"
            document.getElementById('form-title').textContent = '用户登录';
        });
        
        // 显示消息
        function showMessage(message, type) {
            loginMessage.textContent = message;
            loginMessage.className = 'message ' + type;
            loginMessage.style.display = 'block';
        }
        
        // 隐藏消息
        function hideMessage() {
            loginMessage.style.display = 'none';
        }
        
        // 登录处理
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                // 首先检查用户是否被授权
                const isAuthorized = await checkUserAuthorization(username);
                if (!isAuthorized) {
                    showMessage('登录失败: 该用户未获得访问授权，请联系管理员', 'error');
                    return;
                }
                
                // 如果用户被授权，尝试登录
                const user = await AV.User.logIn(username, password);
                showMessage(`登录成功！欢迎回来，${user.getUsername()}`, 'success');
                
                console.log('登录成功，开始记录登录信息...');
                console.log('获取到的用户名:', user.getUsername());
                console.log('用户对象详情:', user.toJSON());
                
                // 立即隐藏登录框并显示主页面
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
                
                // 隐藏登录页面的标题和版权信息
                document.getElementById('login-header-title').style.display = 'none';
                document.getElementById('login-footer-copyright').style.display = 'none';
                
                // 显示用户名
                document.getElementById('user-display').textContent = user.getUsername();
                
                // 初始化主页面系统
                initMainSystem();
                
                // 在后台记录登录信息，不影响用户界面响应
                try {
                    const loginResult = await recordUserLogin(user.getUsername(), {
                        loginMethod: 'web_form',
                        timestamp: new Date().toISOString()
                    });
                    if (loginResult && loginResult.success) {
                        console.log('✅ 登录记录成功！记录ID:', loginResult.recordId);
                    } else {
                        console.warn('⚠️ 登录记录失败:', loginResult ? loginResult.error : '未知错误');
                    }
                } catch (recordError) {
                    console.error('❌ 登录记录出错:', recordError);
                }
                
            } catch (error) {
                console.error('登录错误:', error);
                // 根据错误类型提供更友好的提示
                if (error.code === 211) {
                    showMessage('登录失败: 用户名或密码错误', 'error');
                } else if (error.code === 210) {
                    showMessage('登录失败: 用户名或密码错误', 'error');
                } else if (error.code === 219) {
                    showMessage('登录失败: 登录信息无效', 'error');
                } else {
                    showMessage(`登录失败: ${error.message}`, 'error');
                }
            }
        });
        
        // 注册处理
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const email = document.getElementById('registerEmail').value;
            
            try {
                // 首先检查用户是否被授权
                const isAuthorized = await checkUserAuthorization(username);
                if (!isAuthorized) {
                    showMessage('注册失败: 该用户未获得授权，请联系管理员将您的用户名添加到授权列表', 'error');
                    return;
                }
                
                // 如果用户被授权，则尝试创建账户
                const user = new AV.User();
                user.setUsername(username);
                user.setPassword(password);
                user.setEmail(email);
                
                await user.signUp();
                showMessage('账户创建成功！请使用新账户登录。', 'success');
                
                // 自动切换回登录表单
                setTimeout(() => {
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';
                    document.getElementById('loginUsername').value = username;
                    document.getElementById('loginPassword').value = '';
                }, 2000);
                
            } catch (error) {
                console.error('注册错误:', error);
                if (error.code === 202) {
                    showMessage('注册失败: 该用户名已经存在，请直接使用登录功能', 'error');
                } else if (error.code === 203) {
                    showMessage('注册失败: 该邮箱已经被使用', 'error');
                } else if (error.code === 137) {
                    showMessage('注册失败: 用户名格式不正确', 'error');
                } else {
                    showMessage(`注册失败: ${error.message}`, 'error');
                }
            }
        });
        
        // 重置密码处理
        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            
            try {
                await AV.User.requestPasswordReset(email);
                showMessage('密码重置邮件已发送，请检查您的邮箱。', 'success');
                
                // 自动切换回登录表单
                setTimeout(() => {
                    loginForm.style.display = 'block';
                    resetForm.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('密码重置错误:', error);
                showMessage(`密码重置失败: ${error.message}`, 'error');
            }
        });
        
        // 初始化主页面系统函数
        function initMainSystem() {
            // 初始化移动端菜单
            initMobileMenu();
            
            // 初始化菜单点击事件
            initMenuEvents();
            
            // 初始化日期选择器
            initDatePickers();
            
            // 初始化自定义日期选择器
            initCustomDatePickers();
            
            // 加载默认数据
            loadDefaultData();

            // 初始化图表
            initCharts();
            
            // 启动顶部时间刷新
            startClock();
            
            // 加载指标数据
            loadMetricsData();

            // 加载综合收入看板数据
            loadIncomeDashboardData();

            // 加载充电数据看板
            loadChargingBoardData();
            initChargingBoardExport();
            
            // 加载实时数据
            loadRealtimeData();
            
            // 加载未充电时长统计数据
            loadUnchargedData();
            
			// 添加页面关闭相关事件监听器，尽量在卸载前完成登出记录
			window.addEventListener('beforeunload', handlePageUnload);
			// 当页面变为隐藏状态时（切到后台或关闭前），优先尝试记录登出
			document.addEventListener('visibilitychange', async () => {
				try {
					const currentUser = AV.User.current();
					if (document.hidden && currentUser && !window.__logoutRecordingInProgress) {
						window.__logoutRecordingInProgress = true;
						await recordUserLogout(currentUser.getUsername());
					}
				} finally {
					window.__logoutRecordingInProgress = false;
				}
			});
			// Safari等浏览器更可靠的卸载事件
			window.addEventListener('pagehide', async () => {
				try {
					const currentUser = AV.User.current();
					if (currentUser && !window.__logoutRecordingInProgress) {
						window.__logoutRecordingInProgress = true;
						await recordUserLogout(currentUser.getUsername());
					}
				} finally {
					window.__logoutRecordingInProgress = false;
				}
			});
        }
        
        // 处理页面关闭事件
        async function handlePageUnload(event) {
            // 获取当前登录用户
            const currentUser = AV.User.current();
            if (currentUser) {
                console.log('页面即将关闭，记录用户登出信息...');
                
                // 记录登出信息
                try {
                    const logoutResult = await recordUserLogout(currentUser.getUsername());
                    if (logoutResult.success) {
                        console.log('✅ 用户登出信息记录成功');
                    } else {
                        console.warn('⚠️ 用户登出信息记录失败:', logoutResult.error);
                    }
                } catch (error) {
                    console.error('❌ 记录登出信息时出错:', error);
                }
            }
        }
        
        // 初始化菜单事件
        function initMenuEvents() {
            // 可以在这里添加其他菜单事件
            console.log('菜单事件已初始化');
        }


        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (mobileMenuToggle && sidebar) {
                mobileMenuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('mobile-open');
                });
                
                // 点击主内容区域时关闭菜单
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.addEventListener('click', function() {
                        sidebar.classList.remove('mobile-open');
                    });
                }
                
                // 监听窗口尺寸变化，自动显示/隐藏移动端菜单按钮
                function checkMobileView() {
                    if (window.innerWidth <= 900) {
                        mobileMenuToggle.style.display = 'block';
                    } else {
                        mobileMenuToggle.style.display = 'none';
                        sidebar.classList.remove('mobile-open');
                    }
                }
                
                // 初始检查
                checkMobileView();
                
                // 监听窗口尺寸变化
                window.addEventListener('resize', checkMobileView);
            }
        }
        
        // 主页面相关变量
        const mainContainer = document.getElementById('main-container');
        const userDisplay = document.getElementById('user-display');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const dataTypeSelect = document.getElementById('data-type');
        const queryBtn = document.getElementById('query-btn');
        const exportBtn = document.getElementById('export-btn');
        const queryInfo = document.getElementById('query-info');
        const tableContainer = document.getElementById('table-container');
        const dataLoading = document.getElementById('data-loading');
        const fileInfo = document.getElementById('file-info');
        const rowCount = document.getElementById('row-count');
        const lastUpdate = document.getElementById('last-update');
        
        // 综合数据报表元素
        const comprehensiveTableContainer = document.getElementById('comprehensive-table-container');
        const comprehensiveLoading = document.getElementById('comprehensive-loading');
        const comprehensiveInfo = document.getElementById('comprehensive-info');
        const comprehensiveRowCount = document.getElementById('comprehensive-row-count');
        const comprehensiveLastUpdate = document.getElementById('comprehensive-last-update');
        
        // 功能提示弹窗元素
        const featurePopup = document.getElementById('feature-popup');
        const closePopup = document.getElementById('close-popup');
        const confirmPopup = document.getElementById('confirm-popup');
        const popupContent = document.getElementById('popup-content');
        
        // 当前加载的Excel数据
        let currentExcelData = null;
        let currentFileName = '';
        let currentDataType = 'charging';
        let defaultChargingData = null;
        let defaultComprehensiveData = null;
        let defaultChargingFileName = '';
        let defaultComprehensiveFileName = '';
        
        // 导出相关变量
        let currentExportData = null;
        let currentExportFileName = '';
        let currentExportDataType = '';
        
        // 自定义日期选择器变量
        let startYear = 2025;
        let startMonth = null;
        let endYear = 2025;
        let endMonth = null;

        
        // 图表实例
        let chargingChart = null;
        let incomeChart = null;
        let chargingTrendChart = null;
        let revenueBySectorChart = null;
        let annualRevenueTrendChart = null;
        
        // GitHub数据文件URL
        const metricsDataUrl = 'https://www.csfhcdz.cn/data/homepage.xlsx';
        
        // 显示功能提示弹窗
        function showFeaturePopup(message) {
            popupContent.textContent = message;
            featurePopup.style.display = 'block';
        }
        
        // 关闭功能提示弹窗
        function closeFeaturePopup() {
            featurePopup.style.display = 'none';
        }
        
        // 调整工作表范围以仅包含有数据的部分
        function adjustSheetRange(worksheet) {
            if (!worksheet['!ref']) return;
            
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            let minRow = range.s.r;
            let maxRow = range.e.r;
            let minCol = range.s.c;
            let maxCol = range.e.c;
            
            let firstRow = maxRow;
            let lastRow = minRow;
            let firstCol = maxCol;
            let lastCol = minCol;
            
            // 遍历工作表中所有的单元格地址
            Object.keys(worksheet).forEach(address => {
                if (address[0] !== '!') { // 跳过特殊属性
                    const cellAddress = XLSX.utils.decode_cell(address);
                    // 更新实际有数据的行和列范围
                    if (cellAddress.r < firstRow) firstRow = cellAddress.r;
                    if (cellAddress.r > lastRow) lastRow = cellAddress.r;
                    if (cellAddress.c < firstCol) firstCol = cellAddress.c;
                    if (cellAddress.c > lastCol) lastCol = cellAddress.c;
                }
            });
            
            // 如果找到了有效的数据范围，则更新worksheet的!ref
            if (firstRow <= lastRow && firstCol <= lastCol) {
                const newRange = { s: { r: firstRow, c: firstCol }, e: { r: lastRow, c: lastCol } };
                worksheet['!ref'] = XLSX.utils.encode_range(newRange);
            }
        }
        
        // 初始化自定义日期选择器
        function initCustomDatePickers() {
            const now = new Date();
            startYear = now.getFullYear();
            endYear = now.getFullYear();
            
            // 生成月份网格
            const months = ['一月', '二月', '三月', '四月', '五月', '六月', 
                            '七月', '八月', '九月', '十月', '十一月', '十二月'];
            
            const startMonthGrid = document.getElementById('start-month-grid');
            const endMonthGrid = document.getElementById('end-month-grid');
            
            months.forEach((month, index) => {
                const startBtn = document.createElement('button');
                startBtn.className = 'month-btn';
                startBtn.textContent = month;
                startBtn.dataset.month = index + 1;
                startBtn.addEventListener('click', function() {
                    selectMonth('start', index + 1);
                });
                startMonthGrid.appendChild(startBtn);
                
                const endBtn = document.createElement('button');
                endBtn.className = 'month-btn';
                endBtn.textContent = month;
                endBtn.dataset.month = index + 1;
                endBtn.addEventListener('click', function() {
                    selectMonth('end', index + 1);
                });
                endMonthGrid.appendChild(endBtn);
            });
            
            // 设置年份显示
            document.getElementById('start-year-display').textContent = startYear;
            document.getElementById('end-year-display').textContent = endYear;
            
            // 年份控制按钮事件
            document.querySelectorAll('#start-date-picker .prev-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    startYear--;
                    document.getElementById('start-year-display').textContent = startYear;
                });
            });
            
            document.querySelectorAll('#start-date-picker .next-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    startYear++;
                    document.getElementById('start-year-display').textContent = startYear;
                });
            });
            
            document.querySelectorAll('#end-date-picker .prev-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    endYear--;
                    document.getElementById('end-year-display').textContent = endYear;
                });
            });
            
            document.querySelectorAll('#end-date-picker .next-year').forEach(btn => {
                btn.addEventListener('click', function() {
                    endYear++;
                    document.getElementById('end-year-display').textContent = endYear;
                });
            });
            
            // 点击外部关闭日期选择器
            document.addEventListener('click', function(e) {
                const startPicker = document.getElementById('start-date-picker');
                const endPicker = document.getElementById('end-date-picker');
                
                if (!e.target.closest('.date-picker-container')) {
                    startPicker.style.display = 'none';
                    endPicker.style.display = 'none';
                }
            });
            
            // 日期输入框点击事件
            startDateInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const picker = document.getElementById('start-date-picker');
                picker.style.display = 'block';
                document.getElementById('end-date-picker').style.display = 'none';
            });
            
            endDateInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const picker = document.getElementById('end-date-picker');
                picker.style.display = 'block';
                document.getElementById('start-date-picker').style.display = 'none';
            });
        }
        
        // 选择月份
        function selectMonth(type, month) {
            const year = type === 'start' ? startYear : endYear;
            const formattedMonth = month.toString().padStart(2, '0');
            const dateString = `${year}-${formattedMonth}`;
            
            if (type === 'start') {
                startMonth = month;
                startDateInput.value = dateString;
                document.getElementById('start-date-picker').style.display = 'none';
                
                // 清除结束日期选择状态
                document.querySelectorAll('#end-date-picker .month-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            } else {
                endMonth = month;
                endDateInput.value = dateString;
                document.getElementById('end-date-picker').style.display = 'none';
                
                // 清除开始日期选择状态
                document.querySelectorAll('#start-date-picker .month-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            }
            
            // 设置选中状态
            document.querySelectorAll(`#${type}-month-grid .month-btn`).forEach(btn => {
                btn.classList.remove('selected');
                if (parseInt(btn.dataset.month) === month) {
                    btn.classList.add('selected');
                }
            });
        }
        
        // 初始化日期选择器
        function initDatePickers() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); // 0-11
            
            // 设置默认值为上个月
            if (month === 0) {
                year--;
                month = 11;
            } else {
                month--;
            }
            
            const defaultDate = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            
            startDateInput.value = defaultDate;
            endDateInput.value = defaultDate;
            
            // 设置自定义选择器状态
            startYear = year;
            endYear = year;
            startMonth = month + 1;
            endMonth = month + 1;
            
            document.getElementById('start-year-display').textContent = startYear;
            document.getElementById('end-year-display').textContent = endYear;
            
            document.querySelectorAll(`#start-month-grid .month-btn`).forEach(btn => {
                if (parseInt(btn.dataset.month) === startMonth) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            document.querySelectorAll(`#end-month-grid .month-btn`).forEach(btn => {
                if (parseInt(btn.dataset.month) === endMonth) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            defaultChargingFileName = generateFileName(defaultDate, defaultDate);
            defaultComprehensiveFileName = generateFileName(defaultDate, defaultDate);
        }
        
        // 格式化月份显示
        function formatMonthDisplay(dateStr) {
            const [year, month] = dateStr.split('-');
            return `${year}年${parseInt(month)}月`;
        }
        
        // 生成文件名
        function generateFileName(startDate, endDate) {
            const start = startDate.replace('-', '');
            const end = endDate.replace('-', '');
            return `${start}-${end}.xlsx`;
        }
        
        // 生成文件路径
        function generateFilePath(fileName, dataType) {
            const basePath = dataType === 'charging' 
                ? 'https://www.csfhcdz.cn/chargingdata/' 
                : 'https://www.csfhcdz.cn/comprehensivedata/';
            return `${basePath}${fileName}`;
        }
        
        // 加载并显示Excel数据
        function loadExcelData(filePath, fileName, dataType, isUserQuery = false) {
            const isCharging = dataType === 'charging';
            const loadingElement = isCharging ? dataLoading : comprehensiveLoading;
            const tableElement = isCharging ? tableContainer : comprehensiveTableContainer;
            const infoElement = isCharging ? fileInfo : comprehensiveInfo;
            const rowCountElement = isCharging ? rowCount : comprehensiveRowCount;
            const lastUpdateElement = isCharging ? lastUpdate : comprehensiveLastUpdate;
            
            loadingElement.style.display = 'block';
            
            fetch(filePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('文件未找到');
                    }
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 调整工作表范围以仅包含有数据的部分
                    adjustSheetRange(worksheet);
                    
                    const tableId = isCharging ? 'excel-table-charging' : 'excel-table-comprehensive';
                    const html = XLSX.utils.sheet_to_html(worksheet, {
                        id: tableId,
                        header: '',
                        footer: ''
                    });
                    
                    tableElement.innerHTML = html;
                    
                    // 添加表格样式
                    const tableEl = tableElement.querySelector('table');
                    if (tableEl) {
                        tableEl.classList.add('excel-table');
                        // 确保表格宽度适应内容
                        tableEl.style.width = 'auto';
                        // 修复列宽问题
                        tableEl.style.tableLayout = 'auto';
                        
                        // 确保单元格内容正确显示
                        const cells = tableEl.querySelectorAll('td, th');
                        cells.forEach(cell => {
                            cell.style.lineHeight = '1.5';
                            cell.style.verticalAlign = 'middle';
                        });
                        // 标记数字为不换行
                        markNumericCells(tableEl);
                    }
                    
                    // 如果是用户查询，设置导出数据
                    if (isUserQuery) {
                        currentExportData = data;
                        currentExportFileName = fileName;
                        currentExportDataType = dataType;
                        exportBtn.disabled = false;
                    }
                    
                    // 更新文件信息
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    infoElement.textContent = `当前显示: ${formatMonthDisplay(startDate)}至${formatMonthDisplay(endDate)}数据`;
                    
                    // 更新行数
                    const table = tableElement.querySelector('table');
                    const rowCountValue = table.rows.length - 1; // 减去表头
                    rowCountElement.textContent = `共加载 ${rowCountValue} 行数据`;
                    
                    // 更新最后更新时间
                    const now = new Date();
                    lastUpdateElement.textContent = `最后更新时间: ${now.toLocaleString()}`;
                    
                    // 显示成功信息
                    queryInfo.innerHTML = `<i class="fas fa-check-circle"></i> 成功加载 ${fileName} 数据(暂不支持跨月查询数据)`;
                    queryInfo.className = 'query-info success';
                    
                    // 保存为默认数据
                    if (isCharging) {
                        defaultChargingData = data;
                    } else {
                        defaultComprehensiveData = data;
                    }

                    // 只有在用户查询时才滚动到报表区域
                    if (isUserQuery) {
                        document.getElementById('report-section').scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                })
                .catch(error => {
                    console.error('加载Excel文件失败:', error);
                    
                    // 显示具体日期范围的错误信息
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 没有找到${startDate}至${endDate}之间的数据`;
                    queryInfo.className = 'query-info error';
                    
                    // 15秒后恢复默认提示
                    setTimeout(() => {
                        queryInfo.innerHTML = '<i class="fas fa-info-circle"></i> 请选择日期和数据类型来查询数据';
                        queryInfo.className = 'query-info';
                    }, 15000);
                    
                    // 如果是用户查询，重置导出数据
                    if (isUserQuery) {
                        currentExportData = null;
                        exportBtn.disabled = true;
                    }
                    
                    // 恢复默认数据
                    if (isCharging && defaultChargingData) {
                        renderExcelFromData(defaultChargingData, tableContainer);
                        fileInfo.textContent = `当前显示: ${defaultChargingFileName.replace('.xlsx', '')}数据`;
                        const table = tableContainer.querySelector('table');
                        const rowCountValue = table.rows.length - 1;
                        rowCount.textContent = `共加载 ${rowCountValue} 行数据`;
                        lastUpdate.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
                    } else if (!isCharging && defaultComprehensiveData) {
                        renderExcelFromData(defaultComprehensiveData, comprehensiveTableContainer);
                        comprehensiveInfo.textContent = `当前显示: ${defaultComprehensiveFileName.replace('.xlsx', '')}数据`;
                        const table = comprehensiveTableContainer.querySelector('table');
                        const rowCountValue = table.rows.length - 1;
                        comprehensiveRowCount.textContent = `共加载 ${rowCountValue} 行数据`;
                        comprehensiveLastUpdate.textContent = `最后更新时间: ${new Date().toLocaleString()}`;
                    }
                })
                .finally(() => {
                    loadingElement.style.display = 'none';
                    queryBtn.classList.remove('loading');
                });
        }
        
        // 从数据渲染Excel表格
        function renderExcelFromData(data, container) {
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 调整工作表范围以仅包含有数据的部分
            adjustSheetRange(worksheet);
            
            const containerId = container === tableContainer ? 'excel-table-charging' : 'excel-table-comprehensive';
            const html = XLSX.utils.sheet_to_html(worksheet, {
                id: containerId,
                header: '',
                footer: ''
            });
            
            container.innerHTML = html;
            
            const tableEl = container.querySelector('table');
            if (tableEl) {
                tableEl.classList.add('excel-table');
                tableEl.style.width = 'auto';
                tableEl.style.tableLayout = 'auto';
                
                // 确保单元格内容正确显示
                const cells = tableEl.querySelectorAll('td, th');
                cells.forEach(cell => {
                    cell.style.lineHeight = '1.5';
                    cell.style.verticalAlign = 'middle';
                });
                // 标记数字为不换行
                markNumericCells(tableEl);
            }
        }
        
        // 加载默认数据
        function loadDefaultData() {
            const now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); // 0-11
            
            // 设置默认值为上个月
            if (month === 0) {
                year--;
                month = 11;
            } else {
                month--;
            }
            
            const defaultDate = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            const chargingFileName = generateFileName(defaultDate, defaultDate);
            const chargingFilePath = generateFilePath(chargingFileName, 'charging');
            
            // 加载默认充电数据
            loadExcelData(chargingFilePath, chargingFileName, 'charging');
            
            // 加载默认综合数据
            const comprehensiveFileName = generateFileName(defaultDate, defaultDate);
            const comprehensiveFilePath = generateFilePath(comprehensiveFileName, 'comprehensive');
            loadExcelData(comprehensiveFilePath, comprehensiveFileName, 'comprehensive');
        }
        
        // 导出Excel文件
        function exportExcel() {
            if (!currentExportData) {
                alert('没有查询数据导出');
                return;
            }
            
            const blob = new Blob([currentExportData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = currentExportFileName;
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // 查询按钮点击事件
        queryBtn.addEventListener('click', function() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const dataType = dataTypeSelect.value;
            
            if (!startDate || !endDate) {
                queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 请选择开始日期和结束日期`;
                queryInfo.className = 'query-info error';
                return;
            }
            
            // 检查结束日期是否小于开始日期
            if (endDate < startDate) {
                queryInfo.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 结束日期不能早于开始日期`;
                queryInfo.className = 'query-info error';
                return;
            }
            
            // 显示加载状态
            this.classList.add('loading');
            
            const fileName = generateFileName(startDate, endDate);
            const filePath = generateFilePath(fileName, dataType);
            
            // 设置当前数据类型
            currentDataType = dataType;
            
            // 加载Excel数据 (标记为用户查询)
            loadExcelData(filePath, fileName, dataType, true);
        });
        
        // 导出按钮点击事件
        exportBtn.addEventListener('click', exportExcel);
        
        // 菜单项点击事件
        document.querySelectorAll('.menu-item').forEach(item => {
            const submenu = item.nextElementSibling;
            if (!submenu || !submenu.classList.contains('submenu')) {
                item.addEventListener('click', function() {
                    if (this !== document.querySelector('.menu-item.active')) {
                        document.querySelector('.menu-item.active').classList.remove('active');
                        this.classList.add('active');
                    }
                });
            }
            
            const toggle = item.querySelector('.menu-toggle');
            if (toggle) {
                item.addEventListener('click', function(e) {
                    if (e.target !== toggle && !toggle.contains(e.target)) {
                        const submenu = this.nextElementSibling;
                        if (submenu && submenu.classList.contains('submenu')) {
                            this.classList.toggle('expanded');
                            submenu.classList.toggle('expanded');
                        }
                    }
                });
            }
        });
        
        // 为特定菜单项添加点击事件
       
        document.getElementById('finance-management').addEventListener('click', function(e) {
            e.stopPropagation();
            showFeaturePopup('财务管理功能暂未开放');
        });
        
        document.getElementById('system-settings').addEventListener('click', function(e) {
            e.stopPropagation();
            showFeaturePopup('系统设置功能暂未开放');
        });
        
        document.getElementById('history-menu').addEventListener('click', function(e) {
            e.stopPropagation();
            showFeaturePopup('历史记录功能暂未开放');
        });
        
        // 关闭弹窗事件
        closePopup.addEventListener('click', closeFeaturePopup);
        confirmPopup.addEventListener('click', closeFeaturePopup);




        
        // 初始化系统
        window.addEventListener('DOMContentLoaded', function() {
            // 显示登录界面
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
        });
        
        // 时间显示更新
        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekday = weekdays[now.getDay()];
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            document.getElementById('time-display').textContent = 
                `${year}年${month}月${day}日 ${weekday} ${hours}:${minutes}:${seconds}`;
        }
        
        setInterval(updateTime, 1000);
        updateTime();

        // 格式化数字显示（解决科学计数法问题）
        // 修改后的格式化函数
function formatNumber(value) {
    // 检查是否为整数（包括浮点数表示的整数）
    if (Number.isInteger(value) || Math.abs(value - Math.round(value)) < 1e-6) {
        // 整数：直接格式化为整数
        return Math.round(value).toLocaleString();
    } else {
        // 非整数：使用原来的处理方式
        if (typeof value === 'number' && (Math.abs(value) > 1e6 || Math.abs(value) < 1e-6)) {
            return value.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        return value.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
}

        // 初始化图表
        function initCharts() {
           


            // 充电数据总趋势图表
            const chargingTrendCtx = document.getElementById('charging-trend-chart').getContext('2d');
           chargingTrendChart = new Chart(chargingTrendCtx, {
    type: 'line',
    data: {
        labels: [], // 改为空数组
        datasets: [
            {
                label: '充电量 (kwh)',
                data: [], // 改为空数组
                            borderColor: 'rgba(26, 115, 232, 1)',
                            backgroundColor: 'rgba(26, 115, 232, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: '充电服务费收入 (元)',
                data: [], // 改为空数组
                            borderColor: 'rgba(0, 200, 83, 1)',
                            backgroundColor: 'rgba(0, 200, 83, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '充电量 (kwh)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '服务费收入 (元)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            // 强制同步刻度范围
                            min: 0,
                            max: 7000000,
                            ticks: {
                                // 设置固定的刻度步长
                                stepSize: 1000000,
                                // 格式化刻度值
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // 各版块收入汇总图表
            const revenueBySectorCtx = document.getElementById('revenue-by-sector-chart').getContext('2d');
revenueBySectorChart = new Chart(revenueBySectorCtx, {
    type: 'bar',
    data: {
        labels: [], // 清空硬编码的标签
        datasets: [
            {
                label: '2023年收入 (元)',
                data: [], // 清空硬编码数据
                backgroundColor: 'rgba(26, 115, 232, 0.7)',
                borderColor: 'rgba(26, 115, 232, 1)',
                borderWidth: 1
            },
            {
                label: '2024年收入 (元)',
                data: [], // 清空硬编码数据
                backgroundColor: 'rgba(0, 200, 83, 0.7)',
                borderColor: 'rgba(0, 200, 83, 1)',
                borderWidth: 1
            },
            {
                label: '2025年收入 (元)',
                data: [], // 清空硬编码数据
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 1
            }
        ]
    },
              options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: '收入 (元)'
                }
            }
        }
    }
});

            // 年度总收入趋势图表
            const annualRevenueTrendCtx = document.getElementById('annual-revenue-trend-chart').getContext('2d');
            annualRevenueTrendChart = new Chart(annualRevenueTrendCtx, {
    type: 'line',
    data: {
        labels: [], // 改为空数组
        datasets: [
            {
                label: '年度总收入 (元)',
                data: [], // 改为空数组
                            borderColor: 'rgba(156, 39, 176, 1)',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '总收入 (元)'
                            }
                        }
                    }
                }
            });

               
            // 图表按钮事件
            document.querySelectorAll('.chart-action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.textContent.includes('导出')) {
                        const canvas = this.closest('.chart-container').querySelector('canvas');
                        const link = document.createElement('a');
                        link.download = '图表导出.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    } else {
                        // 刷新数据
                        loadMetricsData();
                        alert('数据已刷新！');
                    }
                });
            });
        }

        // 充电数据看板相关函数
let chargingBoardData = [];

// 加载充电数据看板数据
function loadChargingBoardData() {
    fetch('https://www.csfhcdz.cn/data/homepage.xlsx')
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // 获取Chargingdata工作表
            const chargingSheet = workbook.Sheets['Chargingdata'];
            const jsonData = XLSX.utils.sheet_to_json(chargingSheet, { header: 1 });
            
            // 保存表头和数据
            const headers = jsonData[0];
            chargingBoardData = jsonData.slice(1).map(row => {
                let obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index];
                });
                return obj;
            });
            
            // 初始化年份下拉框
            initYearSelect();
            
            // 默认显示当前年度的数据
            const currentYear = new Date().getFullYear();
            renderChargingBoardTable(currentYear);
        })
        .catch(error => {
            console.error('加载充电数据看板数据失败:', error);
        });
}

// 初始化年份下拉框
function initYearSelect() {
    const yearSelect = document.getElementById('year-select');
    // 获取数据中存在的年份
    const years = new Set();
    chargingBoardData.forEach(item => {
        if (item['时间']) {
            const dateStr = item['时间'];
            let year;
            if (dateStr instanceof Date) {
                year = dateStr.getFullYear();
            } else if (typeof dateStr === 'string') {
                const match = dateStr.match(/(\d{4})/);
                if (match) {
                    year = parseInt(match[1]);
                }
            }
            if (year) {
                years.add(year);
            }
        }
    });
    
    // 排序年份
    const sortedYears = Array.from(years).sort();
    
    // 清空下拉框
    yearSelect.innerHTML = '';
    
    // 添加年份选项
    sortedYears.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        yearSelect.appendChild(option);
    });
    
    // 设置默认选中当前年份(2025年)
    const currentYear = 2025;
    if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
        yearSelect.value = currentYear;
    }
    
    // 添加事件监听
    yearSelect.addEventListener('change', function() {
        const selectedYear = parseInt(this.value);
        renderChargingBoardTable(selectedYear);
    });
}

// 渲染充电数据看板表格
function renderChargingBoardTable(year) {
    const tableBody = document.getElementById('charging-board-table-body');
    tableBody.innerHTML = '';
    
    // 过滤出指定年份的数据
    const yearData = chargingBoardData.filter(item => {
        if (item['时间']) {
            const dateStr = item['时间'];
            let itemYear;
            if (dateStr instanceof Date) {
                itemYear = dateStr.getFullYear();
            } else if (typeof dateStr === 'string') {
                const match = dateStr.match(/(\d{4})/);
                if (match) {
                    itemYear = parseInt(match[1]);
                }
            }
            return itemYear === year;
        }
        return false;
    });
    
    // 按时间排序
    yearData.sort((a, b) => {
        const dateA = new Date(a['时间']);
        const dateB = new Date(b['时间']);
        return dateA - dateB;
    });
    
    // 填充数据
    let totalCharge = 0;
    let totalElectricity = 0;
    let totalService = 0;
    let totalIncome = 0;
    let totalOrders = 0;
    
    yearData.forEach(item => {
        const row = document.createElement('tr');
        
        // 格式化时间显示为yyyy-mm
        let timeDisplay = '';
        if (item['时间'] instanceof Date) {
            const date = item['时间'];
            timeDisplay = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        } else if (typeof item['时间'] === 'string') {
            const date = new Date(item['时间']);
            if (!isNaN(date)) {
                timeDisplay = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            } else {
                timeDisplay = item['时间'];
            }
        }
        
        row.innerHTML = `
            <td>${timeDisplay}</td>
            <td>${formatNumber(item['充电量(kwh)'])}</td>
            <td>${formatNumber(item['充电电费(元)'])}</td>
            <td>${formatNumber(item['充电服务费(元)'])}</td>
            <td>${formatNumber(item['充电总收入(元)'])}</td>
            <td>${formatNumber(item['总订单数量'])}</td>
        `;
        
        tableBody.appendChild(row);
        
        // 计算合计
        totalCharge += Number(item['充电量(kwh)']) || 0;
        totalElectricity += Number(item['充电电费(元)']) || 0;
        totalService += Number(item['充电服务费(元)']) || 0;
        totalIncome += Number(item['充电总收入(元)']) || 0;
        totalOrders += Number(item['总订单数量']) || 0;
    });
    
    // 添加合计行
    const totalRow = document.createElement('tr');
    // 为合计行添加样式：背景色和加粗字体
    totalRow.style.backgroundColor = '#f0f8ff'; // 浅蓝色背景
    totalRow.style.fontWeight = 'bold'; // 加粗字体
    totalRow.style.color = '#0066cc'; // 蓝色文字
    
    totalRow.innerHTML = `
        <td>合计</td>
        <td>${formatNumber(totalCharge)}</td>
        <td>${formatNumber(totalElectricity)}</td>
        <td>${formatNumber(totalService)}</td>
        <td>${formatNumber(totalIncome)}</td>
        <td>${formatNumber(totalOrders)}</td>
    `;
    tableBody.appendChild(totalRow);
    
    // 渲染图表
    renderChargingBoardChart(yearData);
}

// 渲染充电数据看板图表
function renderChargingBoardChart(data) {
    const ctx = document.getElementById('charging-board-chart').getContext('2d');
    
    // 如果已存在图表实例，先销毁它
    if (window.chargingBoardChartInstance) {
        window.chargingBoardChartInstance.destroy();
    }
    
    // 按时间排序
    data.sort((a, b) => {
        const dateA = new Date(a['时间']);
        const dateB = new Date(b['时间']);
        return dateA - dateB;
    });
    
    // 准备图表数据
    const labels = data.map(item => {
        if (item['时间'] instanceof Date) {
            const date = item['时间'];
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        } else if (typeof item['时间'] === 'string') {
            const date = new Date(item['时间']);
            if (!isNaN(date)) {
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            } else {
                return item['时间'];
            }
        }
        return '';
    });
    
    const chargeData = data.map(item => Number(item['充电量(kwh)']) || 0);
    const serviceData = data.map(item => Number(item['充电服务费(元)']) || 0);
    
    // 创建图表
    window.chargingBoardChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '充电量 (kwh)',
                    data: chargeData,
                    backgroundColor: 'rgba(26, 115, 232, 0.7)',
                    borderColor: 'rgba(26, 115, 232, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    label: '充电服务费 (元)',
                    data: serviceData,
                    type: 'line',
                    borderColor: 'rgba(0, 200, 83, 1)',
                    backgroundColor: 'rgba(0, 200, 83, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '充电量 (kwh)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '充电服务费 (元)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

// 导出充电数据看板数据
function exportChargingBoardData() {
    // 获取当前显示的年份
    const year = parseInt(document.getElementById('year-select').value);
    
    // 过滤出指定年份的数据
    const yearData = chargingBoardData.filter(item => {
        if (item['时间']) {
            const dateStr = item['时间'];
            let itemYear;
            if (dateStr instanceof Date) {
                itemYear = dateStr.getFullYear();
            } else if (typeof dateStr === 'string') {
                const match = dateStr.match(/(\d{4})/);
                if (match) {
                    itemYear = parseInt(match[1]);
                }
            }
            return itemYear === year;
        }
        return false;
    });
    
    // 创建一个新的工作簿
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(yearData);
    XLSX.utils.book_append_sheet(wb, ws, '充电数据');
    
    // 导出文件
    XLSX.writeFile(wb, `充电数据_${year}年.xlsx`);
}

// 初始化充电数据看板导出按钮事件
function initChargingBoardExport() {
    document.getElementById('export-board-btn').addEventListener('click', exportChargingBoardData);
}
        
        // 从GitHub加载指标数据
        function loadMetricsData() {
            // 显示加载状态
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'data-loading-indicator';
            loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载指标数据...';
            document.querySelector('.metrics-section').prepend(loadingIndicator);
            
            fetch(metricsDataUrl)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 处理指标数据（Metrics工作表）
                    const metricsSheet = workbook.Sheets['Metrics'];
                    const metricsJson = XLSX.utils.sheet_to_json(metricsSheet, { header: 1 });
                    
                    // 更新指标数据 - 修正索引位置
                    document.getElementById('month-charge').textContent = formatNumber(metricsJson[1][1]) + ' kwh';
                    document.getElementById('month-electricity').textContent = '¥' + formatNumber(metricsJson[2][1]);
                    document.getElementById('month-service').textContent = '¥' + formatNumber(metricsJson[3][1]);
                    document.getElementById('month-orders').textContent = formatNumber(metricsJson[4][1]);
                    
                    document.getElementById('year-charge').textContent = formatNumber(metricsJson[5][1]) + ' kwh';
                    document.getElementById('year-electricity').textContent = '¥' + formatNumber(metricsJson[6][1]);
                    document.getElementById('year-service').textContent = '¥' + formatNumber(metricsJson[7][1]);
                    document.getElementById('year-orders').textContent = formatNumber(metricsJson[8][1]);
                    
                    document.getElementById('total-charge').textContent = formatNumber(metricsJson[9][1]) + ' kwh';
                    document.getElementById('total-electricity').textContent = '¥' + formatNumber(metricsJson[10][1]);
                    document.getElementById('total-service').textContent = '¥' + formatNumber(metricsJson[11][1]);
                    document.getElementById('total-orders').textContent = formatNumber(metricsJson[12][1]);
                    
                    document.getElementById('month-income').textContent = '¥' + formatNumber(metricsJson[13][1]);
                    document.getElementById('year-income').textContent = '¥' + formatNumber(metricsJson[14][1]);
                    document.getElementById('total-income').textContent = '¥' + formatNumber(metricsJson[15][1]);
                    
                    // 处理充电图表数据（ChargingChart工作表）
                    const chargingChartSheet = workbook.Sheets['ChargingChart'];
                    const chargingChartJson = XLSX.utils.sheet_to_json(chargingChartSheet, { header: 1 });
                    
                    // 提取数据
                    const labels = [];
                    const chargingData = [];
                    const serviceIncomeData = [];
                    
                    for (let i = 1; i < chargingChartJson.length; i++) {
                        const row = chargingChartJson[i];
                        if (row && row.length >= 3) {
                            labels.push(row[0]);
                            chargingData.push(row[1]);
                            serviceIncomeData.push(row[2]);
                        }
                    }
                    
                    // 更新充电图表
                    if (chargingChart) {
                        chargingChart.data.labels = labels;
                        chargingChart.data.datasets[0].data = chargingData;
                        chargingChart.data.datasets[1].data = serviceIncomeData;
                        chargingChart.update();
                    }
                    
                    // 处理综合收入图表数据（IncomeChart工作表）
                    const incomeChartSheet = workbook.Sheets['IncomeChart'];
                    const incomeChartJson = XLSX.utils.sheet_to_json(incomeChartSheet, { header: 1 });
                    
                    // 提取数据
                    const incomeLabels = [];
                    const incomeDataArray = [];
                    
                    for (let i = 1; i < incomeChartJson.length; i++) {
                        const row = incomeChartJson[i];
                        if (row && row.length >= 2) {
                            incomeLabels.push(row[0]);
                            incomeDataArray.push(row[1]);
                        }
                    }
                    
                    // 更新收入图表
                    if (incomeChart) {
                        incomeChart.data.labels = incomeLabels;
                        incomeChart.data.datasets[0].data = incomeDataArray;
                        incomeChart.update();
                    }
                    
                    // 处理充电数据总趋势图表数据（csdjzqs工作表）
if (workbook.SheetNames.includes('csdjzqs')) {
    const csdjzqsSheet = workbook.Sheets['csdjzqs'];
    const csdjzqsJson = XLSX.utils.sheet_to_json(csdjzqsSheet, { header: 1 });
    
    // 提取数据
    const labels = [];
    const chargingData = [];
    const serviceIncomeData = [];
    
    for (let i = 1; i < csdjzqsJson.length; i++) {
        const row = csdjzqsJson[i];
        if (row && row.length >= 3) {
            labels.push(row[0]); // 年份
            chargingData.push(row[1]); // 充电量
            serviceIncomeData.push(row[2]); // 服务费收入
        }
    }
    
    // 更新充电数据总趋势图表
    if (chargingTrendChart) {
        chargingTrendChart.data.labels = labels;
        chargingTrendChart.data.datasets[0].data = chargingData;
        chargingTrendChart.data.datasets[1].data = serviceIncomeData;
        chargingTrendChart.update();
    }
}

                // 处理年度总收入趋势图表数据（ndzsrqs工作表）
if (workbook.SheetNames.includes('ndzsrqs')) {
    const ndzsrqsSheet = workbook.Sheets['ndzsrqs'];
    const ndzsrqsJson = XLSX.utils.sheet_to_json(ndzsrqsSheet, { header: 1 });
    
    // 提取数据
    const labels = [];
    const incomeData = [];
    
    for (let i = 1; i < ndzsrqsJson.length; i++) {
        const row = ndzsrqsJson[i];
        if (row && row.length >= 2) {
            labels.push(row[0]); // 年份
            incomeData.push(row[1]); // 收入
        }
    }
    
    // 更新年度总收入趋势图表
    if (annualRevenueTrendChart) {
        annualRevenueTrendChart.data.labels = labels;
        annualRevenueTrendChart.data.datasets[0].data = incomeData;
        annualRevenueTrendChart.update();
    }
}

// 处理各版块收入汇总数据（bksr工作表）
if (workbook.SheetNames.includes('bksr')) {
    const bksrSheet = workbook.Sheets['bksr'];
    const bksrJson = XLSX.utils.sheet_to_json(bksrSheet, { header: 1 });
    
    // 提取表头
    const headers = bksrJson[0];
    
    // 构建一个对象，按年份存储各版块收入
    const sectorDataByYear = {};
    
    // 遍历数据行（从第二行开始）
    for (let i = 1; i < bksrJson.length; i++) {
        const row = bksrJson[i];
        if (row && row.length >= 3) {
            const sectorName = row[0];
            const year = row[1];
            const income = row[2];
            
            if (!sectorDataByYear[year]) {
                sectorDataByYear[year] = {};
            }
            sectorDataByYear[year][sectorName] = income;
        }
    }

// 更新各版块收入汇总图表
    if (revenueBySectorChart) {
        // 获取所有唯一的版块名称
        const sectors = [...new Set(bksrJson.slice(1).map(row => row[0]))];
        
        // 为每个年份创建数据数组
        const year2023Data = sectors.map(sector => sectorDataByYear[2023]?.[sector] || 0);
        const year2024Data = sectors.map(sector => sectorDataByYear[2024]?.[sector] || 0);
        const year2025Data = sectors.map(sector => sectorDataByYear[2025]?.[sector] || 0);
        
        // 更新图表数据
        revenueBySectorChart.data.labels = sectors;
        revenueBySectorChart.data.datasets[0].data = year2023Data;
        revenueBySectorChart.data.datasets[1].data = year2024Data;
        revenueBySectorChart.data.datasets[2].data = year2025Data;
        revenueBySectorChart.update();
    }
}

                    // 移除加载状态
                    loadingIndicator.remove();
                })
                .catch(error => {
                    console.error('加载指标数据失败:', error);
                    loadingIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 加载指标数据失败';
                    
                    // 5秒后移除提示
                    setTimeout(() => {
                        loadingIndicator.remove();
                    }, 5000);
                });
        }

        // 实时数据轮播变量
let realtimeData = [];
let currentRealtimeIndex = 0;
let realtimeInterval = null;
let isRealtimePaused = false;
let realtimeChart = null;

// 加载实时数据
function loadRealtimeData() {
    const loadingElement = document.getElementById('realtime-loading');
    loadingElement.style.display = 'block';
    
     fetch('https://www.csfhcdz.cn/data/daydata.xlsx?t=' + new Date().getTime())
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // 获取第一个工作表
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 转换为JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // 处理表头
            const headers = jsonData[0];

            // 处理数据行
            realtimeData = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                // 只要有数据就显示，不检查特定列
if (row && row.some(cell => cell !== null && cell !== undefined && cell !== '')) {
                    // 处理日期格式
                    let dateStr = row[0];
                    let formattedDate = '';
                    // 更健壮的日期处理
if (dateStr instanceof Date) {
    const month = (dateStr.getMonth() + 1).toString().padStart(2, '0');
    const day = dateStr.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else if (typeof dateStr === 'string' && dateStr.includes('-')) {
    // 处理字符串日期格式
    const datePart = dateStr.split(' ')[0];
    const parts = datePart.split('-');
    if (parts.length >= 3) {
        const month = parts[1].padStart(2, '0');
        const day = parts[2].padStart(2, '0');
        formattedDate = `${month}-${day}`;
    } else {
        formattedDate = datePart;
    }
} else if (typeof dateStr === 'number') {
    // 处理Excel日期序列号
    const jsDate = excelDateToJSDate(dateStr);
    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
    const day = jsDate.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else {
    // 其他情况直接显示原始值
    formattedDate = String(dateStr || '');
}

                    // Excel日期序列号转换函数
                    function excelDateToJSDate(serial) {
                        const utc_days = Math.floor(serial - 25569);
                        const utc_value = utc_days * 86400;
                        const date_info = new Date(utc_value * 1000);
                        return date_info;
                    }

                    if (typeof dateStr === 'number') {
                        // 处理Excel日期序列号
                        const jsDate = excelDateToJSDate(dateStr);
                        const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
                        const day = jsDate.getDate().toString().padStart(2, '0');
                        formattedDate = `${month}-${day}`;
                    } else if (typeof dateStr === 'string') {
                        // 提取日期部分（可能包含时间）
                        const datePart = dateStr.split(' ')[0];
                        const parts = datePart.split('-');
                        if (parts.length >= 3) {
                            // 直接从字符串中提取月份和日期
                            const month = parts[1].padStart(2, '0');
                            const day = parts[2].padStart(2, '0');
                            formattedDate = `${month}-${day}`;
                        } else {
                            formattedDate = datePart;
                        }
                    } else if (dateStr instanceof Date) {
                        // 如果是Date对象，直接格式化
                        formattedDate = `${(dateStr.getMonth() + 1).toString().padStart(2, '0')}-${dateStr.getDate().toString().padStart(2, '0')}`;
                    } else {
                        // 其他情况，转换为字符串
                        formattedDate = String(dateStr);
                    }
                    
// 获取当前年月
const currentDate = new Date();
const currentYear = currentDate.getFullYear();
const currentMonth = currentDate.getMonth() + 1; // 月份从0开始，所以+1

// 处理日期格式
if (dateStr instanceof Date) {
    jsDate = dateStr;
    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
    const day = jsDate.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else if (typeof dateStr === 'string' && dateStr.includes('-')) {
    // 处理字符串日期格式
    const datePart = dateStr.split(' ')[0];
    const parts = datePart.split('-');
    if (parts.length >= 3) {
        // 直接从字符串中提取月份和日期
        const month = parts[1].padStart(2, '0');
        const day = parts[2].padStart(2, '0');
        formattedDate = `${month}-${day}`;
        
        // 创建Date对象用于比较
        const year = parseInt(parts[0]);
        jsDate = new Date(year, parseInt(month) - 1, parseInt(day));
    } else {
        formattedDate = datePart;
    }
} else if (typeof dateStr === 'number') {
    // 处理Excel日期序列号
    jsDate = excelDateToJSDate(dateStr);
    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
    const day = jsDate.getDate().toString().padStart(2, '0');
    formattedDate = `${month}-${day}`;
} else {
    // 其他情况，转换为字符串
    formattedDate = String(dateStr);
}

// 检查日期是否在当前年月
if (jsDate && jsDate.getFullYear() === currentYear && (jsDate.getMonth() + 1) === currentMonth) {
    // 确保所有字段都有值
    realtimeData.push({
        date: formattedDate,
        station: row[1] || '',
        charge: row[2] !== undefined && row[2] !== null && row[2] !== '' ? row[2] : 0,
        totalIncome: row[3] !== undefined && row[3] !== null && row[3] !== '' ? row[3] : 0,
        income: row[4] !== undefined && row[4] !== null && row[4] !== '' ? row[4] : 0,
        orders: row[5] !== undefined && row[5] !== null && row[5] !== '' ? row[5] : 0
    });
}
                }
            }
                    
            // 更新表格
            updateRealtimeTable();
            
            // 绘制图表
            drawRealtimeChart();

            // 只有当数据超过表格显示范围时才开始轮播
            if (realtimeData.length > 8) {
    startRealtimeCarousel();
}
        })
        .catch(error => {
            console.error('加载实时数据失败:', error);
            loadingElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 加载实时数据失败';
        })
        .finally(() => {
            loadingElement.style.display = 'none';
        });
}

// 更新实时数据表格
function updateRealtimeTable() {
    const tableBody = document.getElementById('realtime-table-body');
    tableBody.innerHTML = '';
    
    // 显示当前页的数据
    const startIndex = currentRealtimeIndex;
    // 修改这里，确保能显示到最后一行
    const endIndex = Math.min(startIndex + 10, realtimeData.length);;
    
    for (let i = startIndex; i < endIndex; i++) {
        const item = realtimeData[i];
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>${item.date}</td>
            <td>${item.station}</td>
            <td>${formatNumber(item.charge)}</td>
            <td>${formatNumber(item.totalIncome)}</td>   <!-- 新增列 -->
            <td>${formatNumber(item.income)}</td>
            <td>${formatNumber(item.orders)}</td>
        `;
        
        // 添加鼠标事件
        row.addEventListener('mouseenter', () => {
            isRealtimePaused = true;
            clearInterval(realtimeInterval);
        });
        
        row.addEventListener('mouseleave', () => {
            isRealtimePaused = false;
            // 只有当数据超过表格显示范围时才重新开始轮播
            if (realtimeData.length > 10) {
                startRealtimeCarousel();
            }
        });
        
        tableBody.appendChild(row);
    }

    // 高亮当前行
    if (tableBody.children.length > 0) {
        const firstRow = tableBody.children[0];
        firstRow.classList.add('highlight');
        
        // 移除之前的高亮
        setTimeout(() => {
            firstRow.classList.remove('highlight');
        }, 1000);
    }
}

// 开始实时数据轮播
function startRealtimeCarousel() {
    clearInterval(realtimeInterval);
    
    realtimeInterval = setInterval(() => {
        if (isRealtimePaused) return;
        
        currentRealtimeIndex++;
        // 修改重置条件
        if (currentRealtimeIndex >= realtimeData.length) {
            currentRealtimeIndex = 0;
        }
          
        updateRealtimeTable();
    }, 1000); // 每2秒轮播一次
}
// 绘制实时数据图表
function drawRealtimeChart() {
    const ctx = document.getElementById('realtime-chart').getContext('2d');
    
    // 如果已存在图表实例，先销毁它
    if (realtimeChart) {
        realtimeChart.destroy();
    }
    
    // 按站点和日期分组数据
    const stations = {};
    const dates = [...new Set(realtimeData.map(item => item.date))].sort();
    
    realtimeData.forEach(item => {
        if (!stations[item.station]) {
            stations[item.station] = {
                chargeData: new Array(dates.length).fill(0),
                incomeData: new Array(dates.length).fill(0)
            };
        }
        
        const dateIndex = dates.indexOf(item.date);
        if (dateIndex !== -1) {
            stations[item.station].chargeData[dateIndex] = item.charge;
            stations[item.station].incomeData[dateIndex] = item.income;
        }
    });

    // 创建数据集
    const datasets = [];
    const colors = [
        'rgba(26, 115, 232, 0.7)',      // 蓝色 - 充电量
        'rgba(26, 115, 232, 0.3)',      // 浅蓝色 - 充电量(辅助)
        'rgba(0, 200, 83, 0.7)',        // 绿色 - 服务费收入
        'rgba(0, 200, 83, 0.3)',        // 浅绿色 - 服务费收入(辅助)
        'rgba(220, 53, 69, 0.7)',       // 红色
        'rgba(156, 39, 176, 0.7)',      // 紫色
        'rgba(255, 152, 0, 0.7)'        // 橙色
    ];
    
    let colorIndex = 0;
    for (const station in stations) {
    
        // 为四方坪站特别设置样式
        const isSifangping = station.includes('四方坪');
        
        datasets.push({
            label: `${station} - 充电量`,
            data: stations[station].chargeData,
            borderColor: isSifangping ? colors[0] : colors[colorIndex % colors.length],
            backgroundColor: 'transparent',
            yAxisID: 'y',
            tension: 0.4,
            borderWidth: isSifangping ? 3 : 2,
            pointRadius: isSifangping ? 4 : 3,
            pointHoverRadius: isSifangping ? 6 : 4
        });
        
        datasets.push({
            label: `${station} - 服务费收入`,
            data: stations[station].incomeData,
            borderColor: isSifangping ? colors[2] : colors[(colorIndex + 2) % colors.length],
            backgroundColor: 'transparent',
            yAxisID: 'y1',
            tension: 0.4,
            borderWidth: isSifangping ? 3 : 2,
            borderDash: isSifangping ? [0] : [5, 5], // 四方坪站用实线，其他用虚线
            pointRadius: isSifangping ? 4 : 3,
            pointHoverRadius: isSifangping ? 6 : 4
        });

        colorIndex++;
    }
    
    // 创建图表
    realtimeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '充电量 (kwh)'
                    },
                    // 移除任何固定的min/max设置，让图表自动调整
                    beginAtZero: true // 从0开始，但会自动扩展
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '服务费收入 (元)'
                    },
                    grid: {
                        drawOnChartArea: false
                    },
                    // 移除任何固定的min/max设置，让图表自动调整
                    beginAtZero: true // 从0开始，但会自动扩展
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                const value = context.parsed.y;
                                if (context.dataset.yAxisID === 'y1') {
                                    label += '¥' + formatNumber(value);
                                } else {
                                    label += formatNumber(value) + ' kwh';
                                }
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}
setTimeout(loadRealtimeData, 5 * 60 * 1000); // 每5分钟刷新一次
// 在页面加载完成后调用


// 综合收入看板功能
let incomeDashboardData = [];
let incomeDashboardChart = null;

// 加载综合收入数据
async function loadIncomeDashboardData() {
    try {
        const response = await fetch('https://www.csfhcdz.cn/data/homepage.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        
        // 查找zgmysj工作表
        const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('zgmysj'));
        if (!sheetName) {
            throw new Error('未找到zgmysj工作表');
        }
        
        const worksheet = workbook.Sheets[sheetName];
        
        // 转换Excel数据为JSON
        const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        if (data.length < 2) {
            throw new Error('工作表数据为空');
        }
        
        // 处理表头和数据
        const headers = data[0];
        incomeDashboardData = data.slice(1).map(row => {
            const obj = {};
            headers.forEach((header, index) => {
                if (header === '时间') {
                    // 处理日期字段
                    if (row[index] instanceof Date) {
                        obj[header] = row[index];
                    } else if (typeof row[index] === 'number') {
                        // Excel日期序列号转换为Date对象
                        const date = new Date((row[index] - 25569) * 86400 * 1000);
                        obj[header] = date;
                    } else if (typeof row[index] === 'string') {
                        // 尝试解析字符串日期
                        const date = new Date(row[index]);
                        if (!isNaN(date.getTime())) {
                            obj[header] = date;
                        } else {
                            obj[header] = row[index];
                        }
                    } else {
                        obj[header] = row[index];
                    }
                } else {
                    obj[header] = row[index];
                }
            });
            return obj;
        }).filter(item => item['时间'] && !isNaN(new Date(item['时间']).getTime())); // 过滤掉无效日期数据
        
        // 更新年份选择器
        updateYearSelector();
        
        // 加载当前年份数据
        const currentYear = new Date().getFullYear();
        loadYearData(currentYear.toString());
        
    } catch (error) {
        console.error('加载综合收入数据失败:', error);
        alert('加载综合收入数据失败，请检查网络连接或数据文件');
    }
}

// 更新年份选择器
function updateYearSelector() {
    const yearSelect = document.getElementById('income-year-select');
    const years = [...new Set(incomeDashboardData
        .filter(item => item['时间'])
        .map(item => {
            const date = new Date(item['时间']);
            return date.getFullYear();
        })
        .filter(year => !isNaN(year))
    )].sort((a, b) => b - a);
    
    yearSelect.innerHTML = '';
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === new Date().getFullYear()) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    });
    
    // 添加年份选择事件监听
    yearSelect.addEventListener('change', (e) => {
        loadYearData(e.target.value);
    });
    
    // 添加导出按钮事件监听
document.getElementById('income-export-btn').addEventListener('click', exportIncomeData);
}

// 加载指定年份数据
function loadYearData(year) {
    const yearData = incomeDashboardData.filter(item => {
        if (!item['时间']) return false;
        const date = new Date(item['时间']);
        return date.getFullYear() === parseInt(year);
    });
    
    // 更新表格
    updateIncomeTable(yearData, year);
    
    // 更新图表
    updateIncomeChart(yearData);
}

// 更新收入表格
function updateIncomeTable(data, year) {
    const tableBody = document.querySelector('#income-table tbody');
    const tableHead = document.querySelector('#income-table thead tr');
    
    // 清空表格
    tableBody.innerHTML = '';
    tableHead.innerHTML = '';
    
    // 如果没有数据，显示提示
    if (data.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="12" style="text-align: center;">没有找到${year}年的数据</td>`;
        tableBody.appendChild(row);
        return;
    }
    
    // 获取所有表头（排除时间列）
    const allHeaders = Object.keys(data[0]).filter(key => key !== '时间');
    
    // 检查每个字段是否在所有数据中都为0
    const nonZeroHeaders = allHeaders.filter(header => {
        // 检查该字段是否至少有一个非零值
        return data.some(item => {
            const value = item[header];
            return typeof value === 'number' && value !== 0;
        });
    });
    
    // 使用非零字段作为表头
    const headers = nonZeroHeaders;
    
    // 添加表头
    const timeHeader = document.createElement('th');
    timeHeader.textContent = '时间';
    tableHead.appendChild(timeHeader);
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        tableHead.appendChild(th);
    });
    
    // 添加小计列
    const totalHeader = document.createElement('th');
    totalHeader.textContent = '小计';
    tableHead.appendChild(totalHeader);
    
    // 初始化列总计数组
    const columnTotals = new Array(headers.length).fill(0);
    let grandTotal = 0;
    
    // 添加数据行
    data.forEach(item => {
        const row = document.createElement('tr');
        
        // 时间列
        const timeCell = document.createElement('td');
        const date = new Date(item['时间']);
        timeCell.textContent = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        row.appendChild(timeCell);
        
        // 数据列
        let rowTotal = 0;
        headers.forEach((header, index) => {
            const cell = document.createElement('td');
            const value = item[header] || 0;
            cell.textContent = typeof value === 'number' ? value.toFixed(2) : value;
            rowTotal += typeof value === 'number' ? value : 0;
            
            // 累加列总计
            if (typeof value === 'number') {
                columnTotals[index] += value;
            }
            
            row.appendChild(cell);
        });
        
        // 小计列
        const totalCell = document.createElement('td');
        totalCell.textContent = rowTotal.toFixed(2);
        totalCell.style.fontWeight = 'bold';
        row.appendChild(totalCell);
        
        // 累加总计
        grandTotal += rowTotal;
        
        tableBody.appendChild(row);
    });
    
    // 添加"共计"行
    if (data.length > 0) {
        const totalRow = document.createElement('tr');
        totalRow.style.fontWeight = 'bold';
        totalRow.style.backgroundColor = '#f5f5f5';
        
        // 时间列
        const timeCell = document.createElement('td');
        timeCell.textContent = '共计';
        totalRow.appendChild(timeCell);
        
        // 各列总计
        columnTotals.forEach(total => {
            const cell = document.createElement('td');
            cell.textContent = total.toFixed(2);
            totalRow.appendChild(cell);
        });
        
        // 总计列
        const grandTotalCell = document.createElement('td');
        grandTotalCell.textContent = grandTotal.toFixed(2);
        grandTotalCell.style.backgroundColor = '#e8f5e9';
        totalRow.appendChild(grandTotalCell);
        
        tableBody.appendChild(totalRow);
    }
}

// 更新收入图表
function updateIncomeChart(data) {
    const ctx = document.getElementById('income-dashboard-chart').getContext('2d');
    
    // 销毁现有图表
    if (incomeDashboardChart) {
        incomeDashboardChart.destroy();
    }
    
    // 获取所有非零字段（排除时间列）
    const allHeaders = Object.keys(data[0] || {}).filter(key => key !== '时间');
    const nonZeroHeaders = allHeaders.filter(header => {
        return data.some(item => {
            const value = item[header];
            return typeof value === 'number' && value !== 0;
        });
    });
    
    // 按月分组数据
    const monthlyData = {};
    data.forEach(item => {
        if (!item['时间']) return;
        const date = new Date(item['时间']);
        const month = date.getMonth() + 1;
        if (!monthlyData[month]) {
            monthlyData[month] = [];
        }
        monthlyData[month].push(item);
    });
    
    // 准备图表数据
    const labels = [];
    const monthlyTotals = [];
    
    // 计算每月小计
    for (let month = 1; month <= 12; month++) {
        if (monthlyData[month]) {
            labels.push(`${month}月`);
            
            let monthTotal = 0;
            monthlyData[month].forEach(item => {
                // 只计算非零字段的小计
                nonZeroHeaders.forEach(key => {
                    if (typeof item[key] === 'number') {
                        monthTotal += item[key];
                    }
                });
            });
            
            monthlyTotals.push(monthTotal);
        } else {
            labels.push(`${month}月`);
            monthlyTotals.push(0);
        }
    }
    
    // 创建图表
    incomeDashboardChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '月收入趋势',
                data: monthlyTotals,
                borderColor: 'rgba(220, 53, 69, 1)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '收入 (元)'
                    }
                }
            }
        }
    });
}

// 导出数据功能
function exportIncomeData() {
    // 获取当前选择的年份
    const year = document.getElementById('income-year-select').value;
    
    // 获取当前显示的表格数据（已经过滤掉全为0的字段）
    const table = document.getElementById('income-table');
    const headers = [];
    const data = [];
    
    // 获取表头
    const headerRow = table.querySelector('thead tr');
    headerRow.querySelectorAll('th').forEach(th => {
        headers.push(th.textContent);
    });
    
    // 获取数据行（排除总计行）
    const dataRows = table.querySelectorAll('tbody tr:not(:last-child)');
    dataRows.forEach(row => {
        const rowData = [];
        row.querySelectorAll('td').forEach(cell => {
            rowData.push(cell.textContent);
        });
        data.push(rowData);
    });
    
    // 创建工作簿
    const wb = XLSX.utils.book_new();
    
    // 准备Excel数据
    const excelData = [headers];
    data.forEach(row => excelData.push(row));
    
    // 创建工作表
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // 将工作表添加到工作簿
    XLSX.utils.book_append_sheet(wb, ws, `${year}年收入数据`);
    
    // 导出文件
    XLSX.writeFile(wb, `综合收入数据_${year}年.xlsx`);
}



// 未充电时长统计相关变量
let unchargedData = [];
let currentUnchargedPage = 1;
const rowsPerPage = 10;
let filteredUnchargedData = [];
let currentDurationFilter = 'all';

// 加载未充电时长统计数据
function loadUnchargedData() {
    const loadingElement = document.createElement('div');
    loadingElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载未充电时长统计数据，请稍候...';
    loadingElement.style.textAlign = 'center';
    loadingElement.style.padding = '20px';
    
    const tableContainer = document.querySelector('.uncharged-table-container');
    tableContainer.prepend(loadingElement);
    
    fetch('https://www.csfhcdz.cn/data/wcdsc.xlsx?t=' + new Date().getTime())
        .then(response => response.arrayBuffer())
        .then(arrayBuffer => {
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // 获取第一个工作表
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // 转换为JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // 处理表头
            const headers = jsonData[0];
            
            // 处理数据行
            unchargedData = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row.length >= 6) {
                    // 确保日期格式正确
                    const lastEndTime = formatDateString(row[2]);
                    const nextStartTime = formatDateString(row[3]);
                    const stillUnchargedTime = formatDateString(row[4]);
                    
                    unchargedData.push({
                        stationName: row[0] || '',
                        terminalName: row[1] || '',
                        lastEndTime: lastEndTime,
                        nextStartTime: nextStartTime,
                        stillUnchargedTime: stillUnchargedTime,
                        duration: row[5] || 0
                    });
                }
            }
            
            // 初始化筛选器
            initDurationFilter();
            
            // 更新表格
            updateUnchargedTable();
        })
        .catch(error => {
            console.error('加载未充电时长统计数据失败:', error);
            const tableContainer = document.querySelector('.uncharged-table-container');
            tableContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-exclamation-triangle"></i> 加载未充电时长统计数据失败</div>';
        })
        .finally(() => {
            loadingElement.remove();
        });
}

// 格式化日期字符串，确保正确显示
function formatDateString(dateStr) {
    if (!dateStr) return '';
    
    // 如果已经是字符串格式，直接返回
    if (typeof dateStr === 'string') {
        return dateStr;
    }
    
    // 如果是日期对象
    if (dateStr instanceof Date) {
        const year = dateStr.getFullYear();
        const month = (dateStr.getMonth() + 1).toString().padStart(2, '0');
        const day = dateStr.getDate().toString().padStart(2, '0');
        const hours = dateStr.getHours().toString().padStart(2, '0');
        const minutes = dateStr.getMinutes().toString().padStart(2, '0');
        const seconds = dateStr.getSeconds().toString().padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
    
    // 如果是Excel日期序列号
    if (typeof dateStr === 'number') {
        const jsDate = excelDateToJSDate(dateStr);
        const year = jsDate.getFullYear();
        const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
        const day = jsDate.getDate().toString().padStart(2, '0');
        const hours = jsDate.getHours().toString().padStart(2, '0');
        const minutes = jsDate.getMinutes().toString().padStart(2, '0');
        const seconds = jsDate.getSeconds().toString().padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
    
    return '';
}

// Excel日期序列号转换为JS日期对象
function excelDateToJSDate(serial) {
    const utc_days = Math.floor(serial - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    
    const fractional_day = serial - Math.floor(serial) + 0.0000001;
    let total_seconds = Math.floor(86400 * fractional_day);
    
    const seconds = total_seconds % 60;
    total_seconds -= seconds;
    
    const hours = Math.floor(total_seconds / (60 * 60));
    const minutes = Math.floor(total_seconds / 60) % 60;
    
    return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate(), hours, minutes, seconds);
}

// 初始化时长筛选器
function initDurationFilter() {
    const durationFilter = document.getElementById('uncharged-duration-filter');
    durationFilter.addEventListener('change', function() {
        currentDurationFilter = this.value;
        currentUnchargedPage = 1; // 重置到第一页
        filterUnchargedData();
        updateUnchargedTable();
    });
    
    // 初始化页面选择器
    document.getElementById('page-select').addEventListener('change', function() {
        currentUnchargedPage = parseInt(this.value);
        // 立即更新当前页码显示
        document.getElementById('current-page').textContent = currentUnchargedPage;
        updateUnchargedTable();
    });
}

// 根据时长筛选数据
function filterUnchargedData() {
    if (currentDurationFilter === 'all') {
        filteredUnchargedData = [...unchargedData];
    } else if (currentDurationFilter === 'stillUncharged') {
        // 筛选"截止一直未充电"的数据，即stillUnchargedTime字段有值的记录
        filteredUnchargedData = unchargedData.filter(item => {
            return item.stillUnchargedTime && item.stillUnchargedTime.trim() !== '';
        });
    } else {
        filteredUnchargedData = unchargedData.filter(item => {
            const duration = parseFloat(item.duration);
            switch (currentDurationFilter) {
                case 'lt30':
                    return duration < 30;
                case 'ge30lt60':
                    return duration >= 30 && duration < 60;
                case 'ge60lt90':
                    return duration >= 60 && duration < 90;
                case 'ge90':
                    return duration >= 90;
                default:
                    return true;
            }
        });
    }
    
    // 更新分页信息
    updatePagination();
}

// 更新分页信息
function updatePagination() {
    const totalPages = Math.ceil(filteredUnchargedData.length / rowsPerPage) || 1;
    document.getElementById('total-pages').textContent = totalPages;
    document.getElementById('current-page').textContent = Math.min(currentUnchargedPage, totalPages);
    
    // 更新页面选择器
    const pageSelect = document.getElementById('page-select');
    pageSelect.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        if (i === currentUnchargedPage) {
            option.selected = true;
        }
        pageSelect.appendChild(option);
    }
    
    // 如果当前页超出范围，重置为最后一页
    if (currentUnchargedPage > totalPages) {
        currentUnchargedPage = totalPages;
    }
}

// 更新未充电时长统计表格
function updateUnchargedTable() {
    // 先筛选数据
    if (filteredUnchargedData.length === 0) {
        filterUnchargedData();
    }
    
    const tableBody = document.getElementById('uncharged-table-body');
    tableBody.innerHTML = '';
    
    // 计算当前页的数据范围
    const startIndex = (currentUnchargedPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, filteredUnchargedData.length);
    
    // 显示当前页的数据
    for (let i = startIndex; i < endIndex; i++) {
        const item = filteredUnchargedData[i];
        const row = document.createElement('tr');
        
        // 如果有"截止一直未充电时间"数据，标红显示
        if (item.stillUnchargedTime) {
            row.style.backgroundColor = '#ffebee'; // 浅红色背景
            row.style.color = '#d32f2f'; // 红色文字
            // 确保单元格样式保持一致
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                cell.style.border = '1px solid #e0e0e0';
                cell.style.textAlign = 'center';
                cell.style.padding = '10px 8px';
            });
        }
        
        row.innerHTML = `
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0;">${item.stationName}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0;">${item.terminalName}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0;">${item.lastEndTime}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0;">${item.nextStartTime}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0;">${item.stillUnchargedTime}</td>
            <td style="text-align: center; padding: 10px 8px; border: 1px solid #e0e0e0;">${item.duration}</td>
        `;
        
        tableBody.appendChild(row);
    }
    
    // 更新数据信息
    document.getElementById('uncharged-data-info').textContent = `共加载 ${filteredUnchargedData.length} 条数据`;
}

        function startClock() {
            const el = document.getElementById('time-display');
            if (!el) return;
            function pad(n){return n.toString().padStart(2,'0');}
            function format(dt){
                const y = dt.getFullYear();
                const m = pad(dt.getMonth()+1);
                const d = pad(dt.getDate());
                const week = ['日','一','二','三','四','五','六'][dt.getDay()];
                const hh = pad(dt.getHours());
                const mm = pad(dt.getMinutes());
                const ss = pad(dt.getSeconds());
                return `${y}年${m}月${d}日 星期${week} ${hh}:${mm}:${ss}`;
            }
            el.textContent = format(new Date());
            setInterval(()=>{ el.textContent = format(new Date()); }, 1000);
        }

        // 将数字单元格打上不换行标记，避免金额/数值换行
        function isNumericString(text) {
            const s = String(text).trim();
            // 支持：货币符号、千分位、小数、单位(kwh/元)、百分比
            return /^¥?-?\d{1,3}(,\d{3})*(\.\d+)?(\s*(kwh|元))?$/.test(s)
                || /^-?\d+(\.\d+)?%$/.test(s);
        }

        function markNumericCells(tableEl) {
            const cells = tableEl.querySelectorAll('td, th');
            cells.forEach(cell => {
                const txt = (cell.textContent || '').trim();
                if (isNumericString(txt)) {
                    cell.classList.add('num-cell');
                    // 以内联样式加一道保险，确保不换行
                    cell.style.whiteSpace = 'nowrap';
                    cell.style.wordBreak = 'normal';
                    cell.style.overflowWrap = 'normal';
                    cell.style.textAlign = 'center';
                }
            });
        }

        // 按列识别数字列并整体加不换行样式，适配多种格式
        function markNumericColumns(tableEl) {
          const rows = tableEl.rows;
          if (!rows.length) return;
          const cols = rows[0].cells.length;
          const headerTexts = Array.from(rows[0].cells).map(c => (c.textContent || '').trim());
          const numericHeaderKeywords = /(kwh|电费|服务费|收入|金额|元|订单|数量|合计|同比|环比|率|百分比|%|数|量|次|时长|小时|利用率|金额)/i;

          const isNumericCol = new Array(cols).fill(false);

          // 规则1：表头关键字判定
          for (let c = 0; c < cols; c++) {
            if (numericHeaderKeywords.test(headerTexts[c])) isNumericCol[c] = true;
          }

          // 规则2：采样内容判定（忽略表头，>=60% 数字即视为数字列）
          for (let c = 0; c < cols; c++) {
            let numericCount = 0, total = 0;
            for (let r = 1; r < rows.length; r++) {
              const cell = rows[r].cells[c];
              if (!cell) continue;
              const txt = (cell.textContent || '').trim();
              if (txt) {
                total++;
                if (isNumericString(txt)) numericCount++;
              }
            }
            if (total > 0 && numericCount / total >= 0.6) isNumericCol[c] = true;
          }

          // 应用列样式
          for (let c = 0; c < cols; c++) {
            if (isNumericCol[c]) {
              for (let r = 0; r < rows.length; r++) {
                const cell = rows[r].cells[c];
                if (cell) cell.classList.add('num-col');
              }
            }
          }
        }
    </script>
    
    <!-- 版权信息已移除 -->
</body>
</html>